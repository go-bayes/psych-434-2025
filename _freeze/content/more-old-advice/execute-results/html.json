{
  "hash": "622811c3a425f65278f12fc29e311aea",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Measurement Matters\"\ndate: \"2023-MAY-23\"\nformat: \n  html:\n    html-math-method: katex\n    warnings: false\n    error: false\n    messages: false\n    eval: false\n    highlight-style: dracula\n    code-tools:\n      source: true\n      toggle: false\n      caption: none\n\n---\n\n## Overview\n\nToday, we consider deep into data analysis for causal inference as it applies to observational cultural psychology. By the end, you will:\n\n-   Better understand how to integrate measurement theory with causal inference\n-   Enhance your proficiency in causal analysis using doubly robust methods\n-   Gain insights into the application of sensitivity analysis using E-Values\n\n## Set up your workspace .\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# Before running this source code, make sure to update to the current version of R, and to update all existing packages.\n\n\n# WARNING:  COMMENT THIS OUT. JB DOES THIS FOR WORKING WITHOUT WIFI\nsource(\"/Users/joseph/GIT/templates/functions/libs2.R\")\n\n# WARNING:  COMMENT THIS OUT. JB DOES THIS FOR WORKING WITHOUT WIFI\nsource(\"/Users/joseph/GIT/templates/functions/funs.R\")\n\n\nsource(\"/Users/joseph/GIT/templates/functions/experimental_funs.R\")\n\n\n# ALERT: UNCOMMENT THIS AND DOWNLOAD THE FUNCTIONS FROM JB's GITHUB\n# source(\n#   \"https://raw.githubusercontent.com/go-bayes/templates/main/functions/experimental_funs.R\"\n# )\n\n\n#  If you haven't already, you should have created a folder called \"data\", in your Rstudio project. If not, download this file, add it to your the folder called \"data\" in your Rstudio project. # \"https://www.dropbox.com/s/vwqijg4ha17hbs1/nzavs_dat_synth_t10_t12?dl=0\"\n\n# A function we will use for our tables.\ntab_ate_subgroup_rd <- function(x,\n                                new_name,\n                                delta = 1,\n                                sd = 1) {\n  # Check if required packages are installed\n  required_packages <- c(\"EValue\", \"dplyr\")\n  new_packages <-\n    required_packages[!(required_packages %in% installed.packages()[, \"Package\"])]\n  if (length(new_packages))\n    stop(\"Missing packages: \", paste(new_packages, collapse = \", \"))\n  \n  require(EValue)\n  require(dplyr)\n  \n  # check if input data is a dataframe\n  if (!is.data.frame(x))\n    stop(\"Input x must be a dataframe\")\n  \n  # Check if required columns are in the dataframe\n  required_cols <- c(\"estimate\", \"lower_ci\", \"upper_ci\")\n  missing_cols <- required_cols[!(required_cols %in% colnames(x))]\n  if (length(missing_cols) > 0)\n    stop(\"Missing columns in dataframe: \",\n         paste(missing_cols, collapse = \", \"))\n  \n  # Check if lower_ci and upper_ci do not contain NA values\n  if (any(is.na(x$lower_ci), is.na(x$upper_ci)))\n    stop(\"Columns 'lower_ci' and 'upper_ci' should not contain NA values\")\n  \n  x <- x %>%\n    dplyr::mutate(across(where(is.numeric), round, digits = 3)) %>%\n    dplyr::rename(\"E[Y(1)]-E[Y(0)]\" = estimate)\n  \n  x$standard_error <- abs(x$lower_ci - x$upper_ci) / 3.92\n  \n  evalues_list <- lapply(seq_len(nrow(x)), function(i) {\n    row_evalue <- EValue::evalues.OLS(\n      x[i, \"E[Y(1)]-E[Y(0)]\"],\n      se = x[i, \"standard_error\"],\n      sd = sd,\n      delta = delta,\n      true = 0\n    )\n    # If E_value is NA, set it to 1\n    if (is.na(row_evalue[2, \"lower\"])) {\n      row_evalue[2, \"lower\"] <- 1\n    }\n    if (is.na(row_evalue[2, \"upper\"])) {\n      row_evalue[2, \"upper\"] <- 1\n    }\n    data.frame(round(as.data.frame(row_evalue)[2, ], 3)) # exclude the NA column\n  })\n  \n  evalues_df <- do.call(rbind, evalues_list)\n  colnames(evalues_df) <- c(\"E_Value\", \"E_Val_bound\")\n  \n  tab_p <- cbind(x, evalues_df)\n  \n  tab <-\n    tab_p |> select(c(\n      \"E[Y(1)]-E[Y(0)]\",\n      \"lower_ci\",\n      \"upper_ci\",\n      \"E_Value\",\n      \"E_Val_bound\"\n    ))\n  \n  return(tab)\n}\n\n# extra packages we need\n# for efa/cfa\nif (!require(psych)) {\n  install.packages(\"psych\")\n  library(\"psych\")\n}\n\n# for reporting\nif (!require(parameters)) {\n  install.packages(\"parameters\")\n  library(\"parameters\")\n}\n\n# for graphing\nif (!require(see)) {\n  install.packages(\"see\")\n  library(\"see\")\n}\n\n# for graphing\nif (!require(lavaan)) {\n  install.packages(\"lavaan\")\n  library(\"lavaan\")\n}\n\n\n# for graphing\nif (!require(datawizard)) {\n  install.packages(\"datawizard\")\n  library(\"datawizard\")\n}\n```\n:::\n\n### Import the data\n\n::: {.cell}\n\n```{.r .cell-code}\n# This will read the synthetic data into Rstudio.  Note that the arrow package allows us to have lower memory demands in the storage and retrieval of data.\n\nnzavs_synth <- arrow::read_parquet(here::here(\"data\", \"nzavs_dat_synth_t10_t12\"))\n```\n:::\n\nNext, we will inspect column names.\n\nMake sure to familiarise your self with the variable names [here](https://github.com/go-bayes/psych-434-2023/blob/main/data/readme.qmd)\n\nIt is alwasy a good idea to plot the data (do on your own time.)\n\n::: {.cell}\n\n:::\n\n## Revisit the checklist\n\nIt is essential to remember our checklist:\n\n1.  Clearly state your question.\n2.  Explain its relevance.\n3.  Ensure your question is causal.\n4.  Develop a subgroup analysis question if applicable.\n\nOur discussion today revolves around two main questions:\n\n1.  Does exercise influence anxiety/depression?\n2.  Do these effects differ among NZ Europeans and Māori?\n\nWhile these questions offer a starting point, they lack specificity. We need to clarify:\n\n-   The amount, regularity, and duration of exercise\n-   The measures of depression to be used\n-   The expected timeline for observing the effects\n\nRemember, we can clarify these by emulating a hypothetical experiment, a concept we call the **Target Trial**.\n\nOur initial responses will be guided by the NZAVS measure of exercise, focusing on the hours of activity per week, the 1-year effect on Kessler-6 depression after initiating a change in exercise, and a particular emphasis on effect-modification by NZ European and Māori ethnic identification.\n\nThis analysis has practical motivation, as the effects of exercise on mental health and possible differences between cultural groups remain largely uncharted territory.\n\nOur initial responses will be guided by the NZAVS measure of exercise, focusing on the hours of activity per week, the 1-year effect on Kessler-6 depression after initiating a change in exercise, and a particular emphasis on effect-modification by NZ European and Māori ethnic identification. This analysis has practical motivation, as the effects of exercise on mental health and possible differences between cultural groups remain largely uncharted territory.\n\n### Sculpting the Data: A Hands-On Approach\n\nAs we venture further, we'll perform a series of transformations to shape our data according to our needs. Our process will involve:\n\n1.  Constructing a Kessler 6 average score\n2.  Building a Kessler 6 sum score\n3.  Coarsening the Exercise score\n\nConsider the ambiguity in the NZAVS exercise question: \"During the past week, list 'Hours spent exercising/physical activity'.\" Different people interpret physical activity differently; John may consider any wakeful time as physical activity, while Jane counts only aerobic exercise. Such variation underlines the importance of the consistency assumption in causal inference. But we'll delve deeper into that later.\n\nFor now, let's transform our indicators.\n\n::: {.cell}\n\n```{.r .cell-code}\n# create sum score of kessler 6\ndt_start <- nzavs_synth %>%\n  arrange(id, wave) %>%\n  rowwise() %>%\n  mutate(lifesat_composite  = mean(\n    c(lifesat_satlife,                         \n    lifesat_ideal) ))|> \n  mutate(kessler_6  = mean(\n    # Specify the Kessler scale items\n    c(\n      kessler_depressed,\n      # During the last 30 days, how often did you feel so depressed that nothing could cheer you up?\n      kessler_hopeless,\n      # During the last 30 days, how often did you feel hopeless?\n      kessler_nervous,\n      # During the last 30 days, how often did you feel nervous?\n      kessler_effort,\n      # During the last 30 days, how often did you feel that everything was an effort?\n      kessler_restless,\n      # During the last 30 days, how often did you feel restless or fidgety ?\n      kessler_worthless  # During the last 30 days, how often did you feel worthless?\n    )\n  )) |>\n  mutate(kessler_6_sum = round(sum(\n    c (\n      kessler_depressed,\n      kessler_hopeless,\n      kessler_nervous,\n      kessler_effort,\n      kessler_restless,\n      kessler_worthless\n    )\n  ),\n  digits = 0)) |>  ungroup() |>\n  # Coarsen 'hours_exercise' into categories\n  mutate(\n    hours_exercise_coarsen = cut(\n      hours_exercise,\n      # Hours spent exercising/ physical activity\n      breaks = c(-1, 3, 8, 200),\n      labels = c(\"inactive\",\n                 \"active\",\n                 \"very_active\"),\n      # Define thresholds for categories\n      levels = c(\"(-1,3]\", \"(3,8]\", \"(8,200]\"),\n      ordered = TRUE\n    ))|>\n  # Create a binary 'urban' variable based on the 'rural_gch2018' variable\n  mutate(urban = factor(\n    ifelse(\n      rural_gch2018 == \"medium_urban_accessibility\" |\n        # Define urban condition\n        rural_gch2018 == \"high_urban_accessibility\",\n      \"urban\",\n      # Label 'urban' if condition is met\n      \"rural\"  # Label 'rural' if condition is not met\n    )\n  ))\n```\n:::\n\nWhy do we coarsen the exposure? Recall the consistency assumption of causal inference:\n\n**Consistency:** Can I interpret what it means to intervene on the exposure? I should be able to.\n\n**What is th hypothetical experiment here for change in exercise?**\n\nThrough data wrangling, we can answer our research questions more effectively by manipulating variables into more meaningful and digestible forms. We imagine an experiment in which people were within one band of the coarsened exercise band and we\n\nThese data checks will ensure the accuracy and reliability of our transformations, setting the foundation for solid data analysis.\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# do some checks\nlevels(dt_start$hours_exercise_coarsen)\ntable(dt_start$hours_exercise_coarsen)\nmax(dt_start$hours_exercise)\nmin(dt_start$hours_exercise)\n# checks\n\n\n# justification for transforming exercise\" has a very long tail\nhist(dt_start$hours_exercise, breaks = 1000)\n# consider only those cases below < or = to 20\nhist(subset(dt_start, hours_exercise <= 20)$hours_exercise)\nhist(as.numeric(dt_start$hours_exercise_coarsen))\n```\n:::\n\n### Create variables for the latent factors\n\nLet's next get the data into shape for analysis. Here we create a variable for the two factors (see Appendix)\n\n::: {.cell}\n\n```{.r .cell-code}\n# get two factors from data\ndt_start2 <- dt_start |>\n  arrange(id, wave) |>\n  rowwise() |>\n  mutate(\n    kessler_latent_depression = mean(c(kessler_depressed, kessler_hopeless, kessler_effort), na.rm = TRUE),\n    kessler_latent_anxiety  = mean(c(kessler_effort, kessler_nervous, kessler_restless), na.rm = TRUE)\n  ) |>\n  ungroup()\n```\n:::\n\nInspect the data: anxiety\n\n::: {.cell}\n\n```{.r .cell-code}\n#hist(dt_start2$kessler_latent_anxiety, by = dt_start2$eth_cat)\n\ncreate_histograms_anxiety <- function(df) {\n  # require patchwork\n  library(patchwork)\n  \n  # separate the data by eth_cat\n  df1 <- df %>% filter(eth_cat == \"euro\") # replace \"level_1\" with actual level\n  df2 <- df %>% filter(eth_cat == \"māori\") # replace \"level_2\" with actual level\n  \n  # create the histograms\n  p1 <- ggplot(df1, aes(x=kessler_latent_anxiety)) +\n    geom_histogram(binwidth = 1, fill = \"dodgerblue\", color = \"black\") +\n    ggtitle(\"Kessler Latent Anxiety: NZ Euro\") +\n    xlab(\"kessler_latent_anxiety\") +\n    ylab(\"Count\")\n  \n  p2 <- ggplot(df2, aes(x=kessler_latent_anxiety)) +\n    geom_histogram(binwidth = 1, fill = \"brown\", color = \"black\") +\n    ggtitle(\"Kessler Latent Anxiety: Māori\") +\n    xlab(\"kessler_latent_anxiety\") +\n    ylab(\"Count\")\n  \n  # plot the histograms\n p1 + p2 + plot_annotation(tag_levels = \"a\", title = \"comparison of anxiety histograms\")\n}\n\ncreate_histograms_anxiety(dt_start2)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncreate_histograms_depression <- function(df) {\n  # require patchwork\n  library(patchwork)\n  \n  # separate the data by eth_cat\n  df11 <- df %>% filter(eth_cat == \"euro\") # replace \"level_1\" with actual level\n  df22 <- df %>% filter(eth_cat == \"māori\") # replace \"level_2\" with actual level\n  \n  # create the histograms\n  p11 <- ggplot(df11, aes(x=kessler_latent_depression)) +\n    geom_histogram(binwidth = 1, fill = \"dodgerblue\", color = \"black\") +\n    ggtitle(\"Kessler Latent Depression: NZ Euro\") +\n    xlab(\"kessler_latent_depression\") +\n    ylab(\"Count\") + theme_classic()\n  \n  p22 <- ggplot(df22, aes(x=kessler_latent_depression)) +\n    geom_histogram(binwidth = 1, fill = \"brown\", color = \"black\") +\n    ggtitle(\"Kessler Latent Depression: Māori\") +\n    xlab(\"kessler_latent_depression\") +\n    ylab(\"Count\") + theme_classic()\n  \n  # plot the histograms\n p11 + p22 + plot_annotation(tag_levels = \"a\", title = \"comparison of depression histograms\")\n}\n\ncreate_histograms_depression(dt_start2)\n```\n:::\n\nWhat do you make of these histograms?\n\n## Investigate assumption of positivity:\n\nRecall the positive assumption:\n\n**Positivity:** Can we intervene on the exposure at all levels of the covariates? We should be able to.\n\nNot this is just a description of the the summary scores. We do not assess change within indivuals\n\n::: {.cell}\n\n```{.r .cell-code}\n#  select only the baseline year and the exposure year.  That will give us change in the exposure. ()\ndt_exposure <- dt_start2 |>\n\n  # select baseline year and exposure year\n  filter(wave == \"2018\" | wave == \"2019\") |>\n\n  # select variables of interest\n  select(id, wave, hours_exercise_coarsen,  eth_cat) |>\n\n  # the categorical variable needs to be numeric for us to use msm package to investigate change\n  mutate(hours_exercise_coarsen_n = as.numeric(hours_exercise_coarsen)) |>\n  droplevels()\n\n\n# check\ndt_exposure |>\n  tabyl(hours_exercise_coarsen_n, eth_cat,  wave )\n```\n:::\n\nI've written a function called `transition_table` that will help us assess change in the exposure at the individual level.\n\n::: {.cell}\n\n```{.r .cell-code}\n#   consider people going from active to vary active\nout <- msm::statetable.msm(round(hours_exercise_coarsen_n, 0), id, data = dt_exposure)\n\n\n# for a function I wrote to create state tables\nstate_names <- c(\"Inactive\", \"Somewhat Active\", \"Active\", \"Extremely Active\")\n```\n:::\n\nNext consider Māori only\n\n::: {.cell}\n\n```{.r .cell-code}\n# Maori only\n\ndt_exposure_maori <- dt_exposure |>\n  filter(eth_cat == \"māori\")\n\nout_m <- msm::statetable.msm(round(hours_exercise_coarsen_n, 0), id, data = dt_exposure_maori)\n\n# with this little support we might consider parametric models\n#t_tab_m<- transition_table_2( out_m, state_names)\n\n#interpretation\n# cat(t_tab_m$explanation)\n# print(t_tab_m$table)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# filter euro\ndt_exposure_euro <- dt_exposure |>\n  filter(eth_cat == \"euro\")\n\n# model change\nout_e <- msm::statetable.msm(round(hours_exercise_coarsen_n, 0), id, data = dt_exposure_euro)\n\n\n# creat transition table.\n# t_tab_e <- transition_table_2( out_e, state_names)\n\n#interpretation\n# cat(t_tab_e$explanation)\n# \n# # table\n# print(t_tab_e$table)\n```\n:::\n\nOverall we find evidence for change in the exposure variable. This suggest that we are ready to proceed with the next step of causal estimation.\n\n### Create wide data frame for analysis\n\nRecall, I wrote a function for you that will put the data into temporal order such that measurement of the exposure and outcome appear at baseline, along with a rich set of baseline confounders, the exposure appears in the following wave, and the outcome appears in the wave following the exposure.\n\n::: {.cell}\n\n:::\n\nThe graph encodes our assumptions about the world. It is a qualitative instrument to help us understand how to move from our assumptions to decisions about our analysis, in the first instance, the decision about whether to proceed with an analysis.\n\nIt is perhaps useful here to stop and consider what does this graph implies.\n\nQuestion: 1. Does the graph imply unmeasured confounding?\n\nQuestion 2. If there is unmeasured confounding, should we proceed?\n\n### E-value\n\n> The minimum strength of association on the risk ratio scale that an unmeasured confounder would need to have with both the exposure and the outcome, conditional on the measured covariates, to fully explain away a specific exposure-outcome association\n\nSee: [@vanderweele2020][@mathur2018a]\n\nFor example, suppose that the lower bound of the the E-value was 1.3 with the lower bound of the confidence interval = 1.12, we might then write:\n\n> With an observed risk ratio of RR=1.3, an unmeasured confounder that was associated with both the outcome and the exposure by a risk ratio of 1.3-fold each (or 30%), above and beyond the measured confounders, could explain away the estimate, but weaker joint confounder associations could not; to move the confidence interval to include the null, an unmeasured confounder that was associated with the outcome and the exposure by a risk ratio of 1.12-fold (or 12%) each could do so, but weaker joint confounder associations could not.\n\nThe equations are as follows (for risk ratios)\n\n$$\nE-value_{RR} = RR + \\sqrt{RR \\times (RR - 1)}\n$$ $$\nE-value_{LCL} = LCL + \\sqrt{LCL \\times (LCL - 1)}\n$$\n\nHere is an R function that will calculate E-values\n\n::: {.cell}\n\n```{.r .cell-code}\ncalculate_e_value <- function(rr, lcl) {\n  e_value_rr = rr + sqrt(rr*(rr - 1))\n  e_value_lcl = lcl + sqrt(lcl*(lcl - 1))\n  \n  list(e_value_rr = e_value_rr, e_value_lcl = e_value_lcl)\n}\n\n# e.g. smoking causes cancer\n\n# finding \tRR = 10.73 (95% CI: 8.02, 14.36)\n\ncalculate_e_value(10.73, 8.02)\n```\n:::\n\nWe write:\n\n> With an observed risk ratio of RR=10.7, an unmeasured confounder that was associated with both the outcome and the exposure by a risk ratio of 20.9-fold each, above and beyond the measured confounders, could explain away the estimate, but weaker joint confounder associations could not; to move the confidence interval to include the null, an unmeasured confounder that was associated with the outcome and the exposure by a risk ratio of 15.5-fold each could do so, but weaker joint confounder associations could not.\n\nNote that in this class, most of the outcomes will be (standardised) continuous outcomes. Here's a function and LaTeX code to describe the approximation.\n\nThis function takes a linear regression coefficient estimate (`est`), its standard error (`se`), the standard deviation of the outcome (`sd`), a contrast of interest in the exposure (`delta`, which defaults to 1), and a \"true\" standardized mean difference (true, which defaults to 0). It calculates the odds ratio using the formula from Chinn (2000) and VanderWeele (2017), and then uses this to calculate the E-value.\n\n::: {.cell}\n\n```{.r .cell-code}\n#| label: evalue_ols\n\ncompute_evalue_ols <- function(est, se, delta = 1, true = 0) {\n  # Rescale estimate and SE to reflect a contrast of size delta\n  est <- est / delta\n  se <- se / delta\n\n  # Compute transformed odds ratio and confidence intervals\n  odds_ratio <- exp(0.91 * est)\n  lo <- exp(0.91 * est - 1.78 * se)\n  hi <- exp(0.91 * est + 1.78 * se)\n\n  # Compute E-Values based on the RR values\n  evalue_point_estimate <- odds_ratio * sqrt(odds_ratio + 1)\n  evalue_lower_ci <- lo * sqrt(lo + 1)\n\n  # Return the E-values\n  return(list(EValue_PointEstimate = evalue_point_estimate,\n              EValue_LowerCI = evalue_lower_ci))\n}\n\n\n\n\n# exampl:\n# suppose we have an estimate of 0.5, a standard error of 0.1, and a standard deviation of 1.\n# This would correspond to a half a standard deviation increase in the outcome per unit increase in the exposure.\nresults <- compute_evalue_ols(est = 0.5, se = 0.1, delta = 1)\nprint(results)\n```\n:::\n\nWe write:\n\n> With an observed risk ratio of RR=2.92, an unmeasured confounder that was associated with both the outcome and the exposure by a risk ratio of 2.92-fold each, above and beyond the measured confounders, could explain away the estimate, but weaker joint confounder associations could not; to move the confidence interval to include the null, an unmeasured confounder that was associated with the outcome and the exposure by a risk ratio of 2.23-fold each could do so, but weaker joint confounder associations could not.\n\nNote the E-values package will do the computational work for us (note we get slightly different estimates)\n\nNote:\n\nFirst, the fucntion converts the estimate to an odds ratio:\n\n1.  **Odds Ratio Conversion**:\n\n    (OddsRatio = e\\^{\\frac{Estimate}{SD} \\cdot \\sqrt{\\frac{3}{\\pi}}})\n\nThen, it calculates the confidence intervals for the odds ratio:\n\n2.  **Confidence Intervals**:\n\n    (LowerConfidenceInterval = e\\^{log(OddsRatio) - 1.78 \\cdot SE})\n\n    (UpperConfidenceInterval = e\\^{log(OddsRatio) + 1.78 \\cdot SE})\n\nFinally, it calculates the E-value for the point estimate and the lower confidence interval:\n\n3.  **E-Values Calculation**:\n\n    (EValue\\_{PointEstimate} = OddsRatio + \\sqrt{OddsRatio^2 - 1})\n\n    (EValue\\_{LowerCI} = LowerConfidenceInterval + \\sqrt{LowerConfidenceInterval^2 - 1})\n\n\\[\\[JB: NEED TO CHECK\\]\\]\n\nGenerally, best to use the EValue function.\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(EValue)\n\nEValue::evalues.OLS(est = 0.5, se = 0.1, sd = 1, delta = 1, true = 0)\n```\n:::\n\n::: {.cell table='wide_data'}\n\n```{.r .cell-code}\n############## ############## ############## ############## ############## ############## ############## ########\n####  ####  ####  CREATE DATA FRAME FOR ANALYSIS ####  ####  ################## ############## ######## #########\n############## ############## ############## ############## ############## ############## ############# #########\n\n\n# I have created a function that will put the data into the correct shape. Here are the steps.\n\n# Step 1: choose baseline variables (confounders).  here we select standard demographic variablees plus personality variables.\n\n# Note again that the function will automatically include the baseline exposure and basline outcome in the baseline variable confounder set so you don't need to include these. \n\n\n# here are some plausible baseline confounders\nbaseline_vars = c(\n  \"edu\",\n  \"male\",\n  \"eth_cat\",\n  \"employed\",\n  \"gen_cohort\",\n  \"nz_dep2018\", # nz dep\n  \"nzsei13\", # occupational prestige\n  \"partner\",\n  \"parent\",\n  \"pol_orient\",\n # \"rural_gch2018\",\n   \"urban\", # use the two level urban varaible. \n  \"agreeableness\",\n  \"conscientiousness\",\n  \"extraversion\",\n  \"honesty_humility\",\n  \"openness\",\n  \"neuroticism\",\n  \"modesty\",\n  \"religion_identification_level\"\n)\n\n\n## Step 2, select the exposure variable.  This is the \"cause\"\nexposure_var = c(\"hours_exercise_coarsen\")\n\n\n## step 3. select the outcome variable.  These are the outcomes.\noutcome_vars_reflective = c(\"kessler_latent_anxiety\",\n                            \"kessler_latent_depression\")\n\n\n\n# the function \"create_wide_data\" should be in your environment.\n# If not, make sure to run the first line of code in this script once more.  You may ignore the warnings. or uncomment and run the code below\n# source(\"https://raw.githubusercontent.com/go-bayes/templates/main/functions/funs.R\")\ndt_prepare <-\n  create_wide_data(\n    dat_long = dt_start2,\n    baseline_vars = baseline_vars,\n    exposure_var = exposure_var,\n    outcome_vars = outcome_vars_reflective\n  )\n```\n:::\n\n## Descriptive table\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\n# I have created a function that will allow you to take a data frame and\n# create a table\nbaseline_table(dt_prepare, output_format = \"markdown\")\n\n# but it is not very nice. Next up, is a better table\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# get data into shape\ndt_new <- dt_prepare %>%\n  select(starts_with(\"t0\")) %>%\n  rename_all( ~ stringr::str_replace(., \"^t0_\", \"\")) %>%\n  mutate(wave = factor(rep(\"baseline\", nrow(dt_prepare)))) |>\n  janitor::clean_names(case = \"screaming_snake\")\n\n\n# create a formula string\nbaseline_vars_names <- dt_new %>%\n  select(-WAVE) %>%\n  colnames()\n\ntable_baseline_vars <-\n  paste(baseline_vars_names, collapse = \"+\")\n\nformula_string_table_baseline <-\n  paste(\"~\", table_baseline_vars, \"|WAVE\")\n\ntable1::table1(as.formula(formula_string_table_baseline),\n               data = dt_new,\n               overall = FALSE)\n\n\n# another method for making a table\n# x <- table1::table1(as.formula(formula_string_table_baseline),\n#                     data = dt_new,\n#                     overall = FALSE)\n\n# # some options, see: https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html\n# table1::t1kable(x, format = \"html\", booktabs = TRUE) |>\n#   kable_material(c(\"striped\", \"hover\"))\n```\n:::\n\nWe need to do some more data wrangling, alas! Data wrangling is the majority of data analysis. The good news is that R makes wrangling relatively straightforward.\n\n1.  `mutate(id = factor(1:nrow(dt_prepare)))`: This creates a new column called `id` that has unique identification factors for each row in the dataset. It ranges from 1 to the number of rows in the dataset.\n\n2.  The next `mutate` operation is used to convert the `t0_eth_cat`, `t0_urban`, and `t0_gen_cohort` variables to factor type, if they are not already.\n\n3.  The `filter` command is used to subset the dataset to only include rows where the `t0_eth_cat` is either \"euro\" or \"māori\". The original dataset includes data with four different ethnic categories. This command filters out any row not related to these two groups.\n\n4.  `ungroup()` ensures that there's no grouping in the dataframe.\n\n5.  The `mutate(across(where(is.numeric), ~ scale(.x), .names = \"{col}_z\"))` step standardizes all numeric columns in the dataset by subtracting the mean and dividing by the standard deviation (a z-score transformation). The resulting columns are renamed to include \"\\_z\" at the end of their original names.\n\n6.  The `select` function is used to keep only specific columns: the `id` column, any columns that are factors, and any columns that end in \"\\_z\".\n\n7.  The `relocate` functions re-order columns. The first `relocate` places the `id` column at the beginning. The next three `relocate` functions order the rest of the columns based on their names: those starting with \"t0\\_\" are placed before \"t1\\_\" columns, and those starting with \"t2\\_\" are placed after \"t1\\_\" columns.\n\n8.  `droplevels()` removes unused factor levels in the dataframe.\n\n9.  Finally, `skimr::skim(dt)` will print out a summary of the data in the `dt` object using the skimr package. This provides a useful overview of the data, including data types and summary statistics.\n\nThis function seems to be part of a data preparation pipeline in a longitudinal or panel analysis, where observations are ordered over time (indicated by t0\\_, t1\\_, t2\\_, etc.).\n\n::: {.cell}\n\n```{.r .cell-code}\n### ### ### ### ### ### SUBGROUP DATA ANALYSIS: DATA WRANGLING  ### ### ### ###\n\ndt <- dt_prepare|>\n  mutate(id = factor(1:nrow(dt_prepare))) |>\n  mutate(\n  t0_eth_cat = as.factor(t0_eth_cat),\n  t0_urban = as.factor(t0_urban),\n  t0_gen_cohort = as.factor(t0_gen_cohort)\n) |>\n  dplyr::filter(t0_eth_cat == \"euro\" |\n                t0_eth_cat == \"māori\") |> # Too few asian and pacific\n  ungroup() |>\n  # transform numeric variables into z scores (improves estimation)\n  dplyr::mutate(across(where(is.numeric), ~ scale(.x), .names = \"{col}_z\")) %>%\n  # select only factors and numeric values that are z-scores\n  select(id, # category is too sparse\n         where(is.factor),\n         ends_with(\"_z\"), ) |>\n  # tidy data frame so that the columns are ordered by time (useful for more complex models)\n  relocate(id, .before = starts_with(\"t1_\"))   |>\n  relocate(starts_with(\"t0_\"), .before = starts_with(\"t1_\"))  |>\n  relocate(starts_with(\"t2_\"), .after = starts_with(\"t1_\")) |>\n  droplevels()\n\n# view object\nskimr::skim(dt)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# quick cross table\n#table( dt$t1_hours_exercise_coarsen, dt$t0_eth_cat )\n\n# checks\nhist(dt$t2_kessler_latent_depression_z)\nhist(dt$t2_kessler_latent_anxiety_z)\n\ndt |>\n  tabyl(t0_eth_cat, t1_hours_exercise_coarsen ) |>\n  kbl(format = \"markdown\")\n\n# Visualise missingness\nnaniar::vis_miss(dt)\n\n# save your dataframe for future use\n\n# make dataframe\ndt = as.data.frame(dt)\n\n# save data\nsaveRDS(dt, here::here(\"data\", \"dt\"))\n```\n:::\n\n## Propensity scores\n\nNext we generate propensity scores. Instead of modelling the outcome (t2_y) we will model the exposure (t1_x) as predicted by baseline indicators (t0_c) that we assume may be associated with the outcome and the exposure.\n\nThe first step is to obtain the baseline variables. note that we must remove \"t0_eth_cat\" because we are performing separate weighting for each stratum within this variable.\n\n::: {.cell}\n\n```{.r .cell-code}\n# read  data -- you may start here if you need to repeat the analysis\ndt <- readRDS(here::here(\"data\", \"dt\"))\n\n# get column names\nbaseline_vars_reflective_propensity <- dt|>\n  dplyr::select(starts_with(\"t0\"), -t0_eth_cat) |> colnames()\n\n# define our exposure\nX <- \"t1_hours_exercise_coarsen\"\n\n# define subclasses\nS <- \"t0_eth_cat\"\n\n# Make sure data is in a data frame format\ndt <- data.frame(dt)\n\n\n# next we use our trick for creating a formula string, which will reduce our work\nformula_str_prop <-\n  paste(X,\n        \"~\",\n        paste(baseline_vars_reflective_propensity, collapse = \"+\"))\n\n# this shows the exposure variable as predicted by the baseline confounders.\n```\n:::\n\nFor propensity score analysis, we will try several different approaches. We will want to select the method that produces the best balance.\n\nI typically use `ps` (classical propensity scores), `ebal` and `energy`. The latter two in my experience yeild good balance. Also `energy` will work with *continuous* exposures.\n\nFor more information, see <https://ngreifer.github.io/WeightIt/>\n\n::: {.cell}\n\n```{.r .cell-code}\n# traditional propensity scores-- note we select the ATT and we have a subgroup \ndt_match_ps <- match_mi_general(\n  data = dt,\n  X = X,\n  baseline_vars = baseline_vars_reflective_propensity,\n  subgroup = \"t0_eth_cat\",\n  estimand = \"ATE\",\n  method = \"ps\"\n)\n\nsaveRDS(dt_match_ps, here::here(\"data\", \"dt_match_ps\"))\n\n\n# ebalance\ndt_match_ebal <- match_mi_general(\n  data = dt,\n  X = X,\n  baseline_vars = baseline_vars_reflective_propensity,\n  subgroup = \"t0_eth_cat\",\n  estimand = \"ATE\",\n  method = \"ebal\"\n)\n\n# save output\nsaveRDS(dt_match_ebal, here::here(\"data\", \"dt_match_ebal\"))\n\n\n\n## energy balance method\ndt_match_energy <- match_mi_general(\n  data = dt,\n  X = X,\n  baseline_vars = baseline_vars_reflective_propensity,\n  subgroup = \"t0_eth_cat\",\n  estimand = \"ATE\",\n  #focal = \"high\", # for use with ATT\n  method = \"energy\"\n)\nsaveRDS(dt_match_energy, here::here(\"data\", \"dt_match_energy\"))\n```\n:::\n\nResults, first for Europeans\n\n::: {.cell}\n\n```{.r .cell-code}\n#dt_match_energy <- readRDS(here::here(\"data\", \"dt_match_energy\"))\ndt_match_ebal <- readRDS(here::here(\"data\", \"dt_match_ebal\"))\n#dt_match_ps <- readRDS(here::here(\"data\", \"dt_match_ps\"))\n\n# next we inspect balance. \"Max.Diff.Adj\" should ideally be less than .05, but less than .1 is ok. This is the standardised mean difference. The variance ratio should be less than 2. \n# note that if the variables are unlikely to influence the outcome we can be less strict. \n\n#See: Hainmueller, J. 2012. “Entropy Balancing for Causal Effects: A Multivariate Reweighting Method to Produce Balanced Samples in Observational Studies.” Political Analysis 20 (1): 25–46. https://doi.org/10.1093/pan/mpr025.\n\n# Cole SR, Hernan MA. Constructing inverse probability weights for marginal structural models. American Journal of\n# Epidemiology 2008; 168(6):656–664.\n\n# Moving towards best practice when using inverse probability of treatment weighting (IPTW) using the propensity score to estimate causal treatment effects in observational studies\n# Peter C. Austin, Elizabeth A. Stuart\n# https://onlinelibrary.wiley.com/doi/10.1002/sim.6607\n\n#bal.tab(dt_match_energy$euro)   #  good\nbal.tab(dt_match_ebal$euro)   #  best\n#bal.tab(dt_match_ps$euro)   #  not as good\n\n# here we show only the best tab, but you should put all information into an appendix\n```\n:::\n\nResults for Maori\n\n::: {.cell}\n\n```{.r .cell-code}\n# who only Ebal\n#bal.tab(dt_match_energy$māori)   #  good\nbal.tab(dt_match_ebal$māori)   #  best\n#bal.tab(dt_match_ps$māori)   #  not good\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# code for summar\nsum_e <- summary(dt_match_ebal$euro)\nsum_m <- summary(dt_match_ebal$māori)\n\n# summary euro\nsum_e\n\n# summary maori\nsum_m\n```\n:::\n\n::: {.cell .column-page-right}\n\n```{.r .cell-code}\nlove_plot_e <- love.plot(dt_match_ebal$euro,\n          binary = \"std\",\n          thresholds = c(m = .1))+ labs(title = \"NZ Euro Weighting: method e-balance\")\n\n# plot\nlove_plot_e \n```\n:::\n\n::: {.cell .column-page-right}\n\n```{.r .cell-code}\nlove_plot_m <- love.plot(dt_match_ebal$māori,\n          binary = \"std\",\n          thresholds = c(m = .1)) + labs(title = \"Māori Weighting: method e-balance\")\n# plot\nlove_plot_m\n```\n:::\n\n### Example Summary NZ Euro Propensity scores.\n\n*We estimated propensity score analysis using entropy balancing, energy balancing and traditional propensity scores. Of these approaches, entropy balancing provided the best balance. The results indicate an excellent balance across all variables, with Max.Diff.Adj values significantly below the target threshold of 0.05 across a range of binary and continuous baseline confounders, including gender, generation cohort, urban_location, exercise hours (coarsened, baseline), education, employment status, depression, anxiety, and various personality traits. The Max.Diff.Adj values for all variables were well below the target threshold of 0.05, with most variables achieving a Max.Diff.Adj of 0.0001 or lower. This indicates a high level of balance across all treatment pairs.*\n\n*The effective sample sizes were also adjusted using entropy balancing. The unadjusted sample sizes for the inactive, active, and very active groups were 2880, 3927, and 1834, respectively. After adjustment, the effective sample sizes were reduced to 1855.89, 3659.59, and 1052.01, respectively.*\n\n*The weight ranges for the inactive, active, and very active groups varied, with the inactive group showing the widest range (0.2310 to 7.0511) and the active group showing the narrowest range (0.5769 to 1.9603). Despite these variations, the coefficient of variation, mean absolute deviation (MAD), and entropy were all within acceptable limits for each group, indicating a good balance of weights.*\n\n*We also identified the units with the five most extreme weights by group. These units exhibited higher weights compared to the rest of the units in their respective groups, but they did not significantly affect the overall balance of weights.*\n\n*We plotted these results using love plots, visually confirming both the balance in the propensity score model using entropy balanced weights, and the imbalance in the model that does not adjust for baseline confounders.*\n\n*Overall, these findings support the use of entropy balancing in propensity score analysis to ensure a balanced distribution of covariates across treatment groups, conditional on the measured covariates included in the model.*\n\n### Example Summary Maori Propensity scores.\n\nResults:\n\n*The entropy balancing method was also the best performing method that was applied to a subgroup analysis of the Māori population. Similar to the NZ European subgroup analysis, the method achieved a high level of balance across all treatment pairs for the Māori subgroup. The Max.Diff.Adj values for all variables were well below the target threshold of 0.05, with most variables achieving a Max.Diff.Adj of 0.0001 or lower. This indicates a high level of balance across all treatment pairs for the Māori subgroup.*\n\n*The effective sample sizes for the Māori subgroup were also adjusted using entropy balancing. The unadjusted sample sizes for the inactive, active, and very active groups were 307, 354, and 160, respectively. After adjustment, the effective sample sizes were reduced to 220.54, 321.09, and 76.39, respectively*\n\n*The weight ranges for the inactive, active, and very active groups in the Māori subgroup varied, with the inactive group showing the widest range (0.2213 to 3.8101) and the active group showing the narrowest range (0.3995 to 1.9800). Despite these variations, the coefficient of variation, mean absolute deviation (MAD), and entropy were all within acceptable limits for each group, indicating a good balance of weights.*\n\n*The study also identified the units with the five most extreme weights by group for the Māori subgroup. These units exhibited higher weights compared to the rest of the units in their respective groups, but they did not significantly affect the overall balance of weights.*\n\n*In conclusion, the results of the Māori subgroup analysis are consistent with the overall analysis. The entropy balancing method achieved a high level of balance across all treatment pairs, with Max.Diff.Adj values significantly below the target threshold. These findings support the use of entropy balancing in propensity score analysis to ensure a balanced distribution of covariates across treatment groups, even in subgroup analyses.*\n\n### More data wrangling\n\nNote that we need to attach the `weights` from the propensity score model back to the data.\n\nHowever, because our weighting analysis estimates a model for the *exposure*, we only need to do this analysis once, no matter how many outcomes we investigate. So there's a little good news.\n\n::: {.cell}\n\n```{.r .cell-code}\n# prepare nz_euro data\ndt_ref_e <- subset(dt, t0_eth_cat == \"euro\") # original data subset only nz europeans\n\n# add weights\ndt_ref_e$weights <- dt_match_ebal$euro$weights # get weights from the ps matching model,add to data\n\n# prepare maori data\ndt_ref_m <- subset(dt, t0_eth_cat == \"māori\")# original data subset only maori\n\n# add weights\ndt_ref_m$weights <- dt_match_ebal$māori$weights # get weights from the ps matching model, add to data\n\n# combine data into one data frame\ndt_ref_all <- rbind(dt_ref_e, dt_ref_m) # combine the data into one dataframe. \n```\n:::\n\n# Table of Subgroup Results plus Evalues\n\n\n\n<!-- > E[Y(1)]-E[Y(0)] presents the causal contrast between the expected value of the exposure were all within the target population {Group Var Here} to receive the exposure E[Y(1)] in comparison to the expected value of the exposure were to recieve the baseline treatment  E[Y(0)].  -->\n\n<!-- > The Confidence interval for these estimates is between {2.5% column here} at the lower bound and {97.5% value here at the uppoer bound}.  -->\n\n\n<!-- > E-values represent the minimum strength or magnitude of association that an unmeasured confounder would need to have with both treatment and outcome in order to explain the observed effect estimates conditional on measured covariates [@vanderweele2017]. -->\n\n<!-- > With an observed risk ratio of RR = {E_Value Here}, an unmeasured confounder that was associated with both the outcome and the exposure by a risk ratio of {E_VAL_bound}-fold each, above and beyond the measured confounders, could explain away the estimate, but weaker joint confounder associations could not; to move the confidence interval to include the null, an unmeasured confounder that was associated with the outcome and the exposure by a risk ratio of {EVALUE HERE} - fold each could do so, but weaker joint confounder associations could not..[@vanderweele2017] -->\n\n\nI've created functions for reporting results so you can use this code, changing it to suit your analysis.\n\n::: {.cell}\n\n```{.r .cell-code}\n# return stored estimates \nsim_estimand_all_e <- readRDS(here::here(\"data\",\"sim_estimand_all_e\"))\nsim_estimand_all_m<- readRDS(here::here(\"data\",\"sim_estimand_all_m\"))\n\n# create individual summaries \nsum_e <- summary(sim_estimand_all_e)\nsum_m <- summary(sim_estimand_all_m)\n\n\n# create individual tables\ntab_e <- sub_tab_ate(sum_e, new_name = \"NZ Euro Anxiety\")\ntab_m <- sub_tab_ate(sum_m, new_name = \"Māori Anxiety\")\n\n\n# expand tables \nplot_e <- sub_group_tab(tab_e, type= \"RD\")\nplot_m <- sub_group_tab(tab_m, type= \"RD\")\n\nbig_tab <- rbind(plot_e,plot_m)\n\n\n# table for anxiety outcome --format as \"markdown\" if you are using quarto documents\nbig_tab |> \n  kbl(format=\"markdown\")\n```\n:::\n\n\n\n## Graph of the result\n\nI've create a function you can use to graph your results. Here is the code, adjust to suit.\n\n::: {.cell}\n\n```{.r .cell-code}\n# group tables\nsub_group_plot_ate(big_tab, title = \"Effect of Exercise on Anxiety\", subtitle = \"Subgroup Analysis: NZ Euro and Māori\", xlab = \"Groups\", ylab = \"Effects\",\n                 x_offset = -1,\n                           x_lim_lo = -1,\n                           x_lim_hi = 1.5)\n```\n:::\n\n### Report the anxiety result.\n\n\n> For the New Zealand European group, our results suggest that exercise potentially reduces anxiety, with an estimated causal contrast value (E[Y(1)]-E[Y(0)]) of -0.077. The associated confidence interval, ranging from -0.131 to -0.022, does not cross zero, providing more certainty in our estimate.\n\n> E-values quantify the minimum strength of association that an unmeasured confounding variable would need to have with both the treatment and outcome, to fully explain away our observed effect. In this case, any unmeasured confounder would need to be associated with both exercise and anxiety reduction, with a risk ratio of at least 1.352 to explain away the observed effect, and at least 1.167 to shift the confidence interval to include a null effect.\n\n> Turning to the Māori group, the data suggest a possible reducing effect of exercise on anxiety, with a causal contrast value of 0.027. Yet, the confidence interval for this estimate (-0.114 to 0.188) also crosses zero, indicating similar uncertainties. An unmeasured confounder would need to have a risk ratio of at least 1.183 with both exercise and anxiety to account for our observed effect, and a risk ratio of at least 1 to render the confidence interval inclusive of a null effect.\n\n> Thus, while our analysis suggests that exercise could potentially reduce anxiety in both New Zealand Europeans and Māori, we advise caution in interpretation. The confidence intervals crossing zero reflect substantial uncertainties, and the possible impact of unmeasured confounding factors further complicates the picture.\n\n\nHere's a function that will do much of this work for you. However, you'll need to adjust it, and supply your own interpretation.\n\n::: {.cell}\n\n```{.r .cell-code}\n#|label: interpretation function\n#| eval: false\ninterpret_results_subgroup <- function(df, outcome, exposure) {\n  df <- df %>%\n    mutate(\n      report = case_when(\n        E_Val_bound > 1.2 & E_Val_bound < 2 ~ paste0(\n          \"For the \", group, \", our results suggest that \", exposure, \" may potentially influence \", outcome, \", with an estimated causal contrast value (E[Y(1)]-E[Y(0)]) of \", `E[Y(1)]-E[Y(0)]`, \".\\n\",\n          \"The associated confidence interval, ranging from \", `2.5 %`, \" to \", `97.5 %`, \", does not cross zero, providing more certainty in our estimate. \",\n          \"The E-values indicate that any unmeasured confounder would need to have a minimum risk ratio of \", E_Value, \" with both the treatment and outcome to explain away the observed effect, and a minimum risk ratio of \", E_Val_bound, \" to shift the confidence interval to include the null effect. This suggests stronger confidence in our findings.\"\n        ),\n        E_Val_bound >= 2 ~ paste0(\n          \"For the \", group, \", our results suggest that \", exposure, \" may potentially influence \", outcome, \", with an estimated causal contrast value (E[Y(1)]-E[Y(0)]) of \", `E[Y(1)]-E[Y(0)]`, \".\\n\",\n          \"The associated confidence interval, ranging from \", `2.5 %`, \" to \", `97.5 %`, \", does not cross zero, providing more certainty in our estimate. \",\n          \"With an observed risk ratio of RR = \", E_Value, \", an unmeasured confounder that was associated with both the outcome and the exposure by a risk ratio of \", E_Val_bound, \"-fold each, above and beyond the measured confounders, could explain away the estimate, but weaker joint confounder associations could not; to move the confidence interval to include the null, an unmeasured confounder that was associated with the outcome and the exposure by a risk ratio of \", E_Val_bound, \"-fold each could do so, but weaker joint confounder associations could not. Here we find stronger evidence that the result is robust to unmeasured confounding.\"\n        ),\n        E_Val_bound < 1.2 & E_Val_bound > 1 ~ paste0(\n          \"For the \", group, \", our results suggest that \", exposure, \" may potentially influence \", outcome, \", with an estimated causal contrast value (E[Y(1)]-E[Y(0)]) of \", `E[Y(1)]-E[Y(0)]`, \".\\n\",\n          \"The associated confidence interval, ranging from \", `2.5 %`, \" to \", `97.5 %`, \", does not cross zero, providing more certainty in our estimate. \",\n          \"The E-values indicate that any unmeasured confounder would need to have a minimum risk ratio of \", E_Value, \" with both the treatment and outcome to explain away the observed effect, and a minimum risk ratio of \", E_Val_bound, \" to shift the confidence interval to include the null effect. This suggests we should interpret these findings with caution given uncertainty in the model.\"\n        ),\n        E_Val_bound == 1 ~ paste0(\n          \"For the \", group, \", the data suggests a potential effect of \", exposure, \" on \", outcome, \", with a causal contrast value of \", `E[Y(1)]-E[Y(0)]`, \".\\n\",\n          \"However, the confidence interval for this estimate, ranging from \", `2.5 %`,\" to \", `97.5 %`, \", crosses zero, indicating considerable uncertainties. The E-values indicate that an unmeasured confounder that is associated with both the \", outcome, \" and the \", exposure, \" by a risk ratio of \", E_Value, \" could explain away the observed associations, even after accounting for the measured confounders. \",\n          \"This finding further reduces confidence in a true causal effect. Hence, while the estimates suggest a potential effect of \", exposure, \" on \", outcome, \" for the \", group, \", the substantial uncertainty and possible influence of unmeasured confounders mean these findings should be interpreted with caution.\"\n        )\n      )\n    )\n  return(df$report)\n}\n```\n:::\n\n\nYou run the function like this: \n\n\n::: {.cell}\n\n```{.r .cell-code}\ninterpret_results_subgroup(big_tab, outcome = \"Anxiety\", exposure = \"Excercise\")\n```\n:::\n\n\nEasy!\n\n\n\n### Estimate the subgroup contrast\n\n::: {.cell}\n\n```{.r .cell-code}\n# calculated above\nest_all_anxiety <- readRDS( here::here(\"data\",\"est_all_anxiety\"))\n\n# make the sumamry into a dataframe so we can make a table\ndf <- as.data.frame(summary(est_all_anxiety))\n\n# get rownames for selecting the correct row\ndf$RowName <- row.names(df)\n\n# select the correct row -- the group contrast\nfiltered_df <- df |> \n  dplyr::filter(RowName == \"RD_m - RD_e\") \n\n\n# pring the filtered data frame\nlibrary(kableExtra)\nfiltered_df  |> \n  select(-RowName) |> \n  kbl(digits = 3) |> \n  kable_material(c(\"striped\", \"hover\")) \n```\n:::\n\nAnother option for making the table using markdown. This would be useful if you were writing your article using qaurto. \n\n::: {.cell}\n\n```{.r .cell-code}\nfiltered_df  |> \n  select(-RowName) |> \n  kbl(digits = 3, format = \"markdown\")\n```\n:::\n\nReport result along the following lines:\n\n> The estimated reduction of anxiety from exercise is higher overall for New Zealand Europeans (RD_e) compared to Māori (RD_m). This is indicated by the estimated risk difference (RD_m - RD_e) of 0.104. However, there is uncertainty in this estimate, as the confidence interval (-0.042 to 0.279) crosses zero. This indicates that we cannot be confident that the difference in anxiety reduction between New Zealand Europeans and Māori is reliable. It's possible that the true difference could be zero or even negative, suggesting higher anxiety reduction for Māori. Thus, while there's an indication of higher anxiety reduction for New Zealand Europeans, the uncertainty in the estimate means we should interpret this difference with caution.\n\n\n\n\n\n## Depression Analysis and Results\n\n::: {.cell}\n\n```{.r .cell-code}\n### SUBGROUP analysis\ndt_ref_all <- readRDS(here::here(\"data\", \"dt_ref_all\"))\n# get column names\nbaseline_vars_reflective_propensity <- dt|>\n  dplyr::select(starts_with(\"t0\"), -t0_eth_cat) |> colnames()\ndf <-  dt_ref_all\nY <-  \"t2_kessler_latent_depression_z\"\nX <- \"t1_hours_exercise_coarsen\" # already defined above\nbaseline_vars = baseline_vars_reflective_propensity\ntreat_0 = \"inactive\"\ntreat_1 = \"very_active\"\nestimand = \"ATE\"\nscale = \"RD\"\nnsims = 1000\nfamily = \"gaussian\"\ncontinuous_X = FALSE\nsplines = FALSE\ncores = parallel::detectCores()\nS = \"t0_eth_cat\"\n\n# not we interact the subclass X treatment X covariates\n\nformula_str <-\n  paste(\n    Y,\n    \"~\",\n    S,\n    \"*\",\n    \"(\",\n    X ,\n    \"*\",\n    \"(\",\n    paste(baseline_vars_reflective_propensity, collapse = \"+\"),\n    \")\",\n    \")\"\n  )\n\n# fit model\nfit_all_dep  <- glm(\n  as.formula(formula_str),\n  weights = weights,\n  # weights = if (!is.null(weight_var)) weight_var else NULL,\n  family = family,\n  data = df\n)\n\n\n# coefs <- coef(fit_all_dep)\n# table(is.na(coefs))#   \n# insight::get_varcov(fit_all_all)\n\n# simulate coefficients\nconflicts_prefer(clarify::sim)\nsim_model_all <- sim(fit_all_dep, n = nsims, vcov = \"HC1\")\n\n\n# simulate effect as modified in europeans\nsim_estimand_all_e_d <- sim_ame(\n  sim_model_all,\n  var = X,\n  cl = cores,\n  subset = t0_eth_cat == \"euro\",\n  verbose = TRUE)\n\n\n# note contrast of interest\nsim_estimand_all_e_d <-\n  transform(sim_estimand_all_e_d, RD = `E[Y(very_active)]` - `E[Y(inactive)]`)\n\n\n# simulate effect as modified in māori\nsim_estimand_all_m_d <- sim_ame(\n  sim_model_all,\n  var = X,\n  cl = cores,\n  subset = t0_eth_cat == \"māori\",\n  verbose = TRUE\n)\n\n# combine\nsim_estimand_all_m_d <-\n  transform(sim_estimand_all_m_d, RD = `E[Y(very_active)]` - `E[Y(inactive)]`)\n\n\n# summary\n#summary(sim_estimand_all_e_d)\n#summary(sim_estimand_all_m_d)\n\n# rearrange\nnames(sim_estimand_all_e_d) <-\n  paste(names(sim_estimand_all_e_d), \"e\", sep = \"_\")\n\nnames(sim_estimand_all_m_d) <-\n  paste(names(sim_estimand_all_m_d), \"m\", sep = \"_\")\n\n\nest_all_d <- cbind(sim_estimand_all_m_d, sim_estimand_all_e_d)\nest_all_d <- transform(est_all_d, `RD_m - RD_e` = RD_m - RD_e)\nsaveRDS(sim_estimand_all_m_d, here::here(\"data\", \"sim_estimand_all_m_d\"))\nsaveRDS(sim_estimand_all_e_d, here::here(\"data\", \"sim_estimand_all_e_d\"))\n```\n:::\n\n### Report anxiety results\n::: {.cell}\n\n```{.r .cell-code}\n# return stored estimates \nsim_estimand_all_e_d <- readRDS(here::here(\"data\",\"sim_estimand_all_e_d\"))\nsim_estimand_all_m_d<- readRDS(here::here(\"data\",\"sim_estimand_all_m_d\"))\n\n# create individual summaries \nsum_e_d <- summary(sim_estimand_all_e_d)\nsum_m_d <- summary(sim_estimand_all_m_d)\n\n\n# create individual tables\ntab_ed <- sub_tab_ate(sum_e_d, new_name = \"NZ Euro Depression\")\ntab_md <- sub_tab_ate(sum_m_d, new_name = \"Māori Depression\")\n\n\n# expand tables \nplot_ed <- sub_group_tab(tab_ed, type= \"RD\")\nplot_md <- sub_group_tab(tab_md, type= \"RD\")\n\nbig_tab_d <- rbind(plot_ed,plot_md)\n\n\n# table for anxiety outcome --format as \"markdown\" if you are using quarto documents\nbig_tab_d |> \n  kbl(format=\"markdown\")\n```\n:::\n\n\n### Graph Anxiety result\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# group tables\nsub_group_plot_ate(big_tab_d, title = \"Effect of Exercise on Depression\", subtitle = \"Subgroup Analysis: NZ Euro and Māori\", xlab = \"Groups\", ylab = \"Effects\",\n                 x_offset = -1,\n                           x_lim_lo = -1,\n                           x_lim_hi = 1.5)\n```\n:::\n\n###  Interpretation\n\nUse the function, again, modify the outputs to fit with your study and results and provide your own interpretation. \n\n\n::: {.cell}\n\n```{.r .cell-code}\ninterpret_results_subgroup(big_tab_d, exposure = \"Exercise\", outcome = \"Depression\")\n```\n:::\n\n### Estimate the subgroup contrast\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# calculated above\nest_all_d <- readRDS( here::here(\"data\",\"est_all_d\"))\n\n# make the sumamry into a dataframe so we can make a table\ndfd <- as.data.frame(summary(est_all_d))\n\n# get rownames for selecting the correct row\ndfd$RowName <- row.names(dfd)\n\n# select the correct row -- the group contrast\nfiltered_dfd <- dfd |> \n  dplyr::filter(RowName == \"RD_m - RD_e\") \n\n\n# Print the filtered data frame\nlibrary(kableExtra)\nfiltered_dfd  |> \n  select(-RowName) |> \n  kbl(digits = 3) |> \n  kable_material(c(\"striped\", \"hover\")) \n```\n:::\n\n\n\nReporting might be: \n\n> The estimated reduction of depression from exercise is higher overall for New Zealand Europeans (RD_e) compared to Māori (RD_m). This is suggested by the estimated risk difference (RD_m - RD_e) of 0.068. However, there is a degree of uncertainty in this estimate, as the confidence interval (-0.09 to 0.229) crosses zero. This suggests that we cannot be confident that the difference in depression reduction between New Zealand Europeans and Māori is statistically significant. It's possible that the true difference could be zero or even negative, implying a greater depression reduction for Māori than New Zealand Europeans. Thus, while the results hint at a larger depression reduction for New Zealand Europeans, the uncertainty in this estimate urges us to interpret this difference with caution.\n\n\n\n### Discusion \n\nYou'll need to do this yourself. Here's a start: \n\n\n> In our study, we employed a robust statistical method that helps us estimate the impact of exercise on reducing anxiety among different population groups – New Zealand Europeans and Māori. This method has the advantage of providing reliable results even if our underlying assumptions aren't entirely accurate – a likely scenario given the complexity of real-world data.  However, this robustness comes with a trade-off: it gives us wider ranges of uncertainty in our estimates. This doesn't mean the analysis is flawed; rather, it accurately represents our level of certainty given the data we have.\n\n#### **Exercise and Anxiety**\n\n> Our analysis suggests that exercise may have a greater effect in reducing anxiety among New Zealand Europeans compared to Māori. This conclusion comes from our primary causal estimate, the risk difference, which is 0.104. However, it's crucial to consider our uncertainty in this value. We represent this uncertainty as a range, also known as a confidence interval. In this case, the interval ranges from -0.042 to 0.279. What this means is, given our current data and method, the true effect could plausibly be anywhere within this range. While our best estimate shows a higher reduction in anxiety for New Zealand Europeans, the range of plausible values includes zero and even negative values. This implies that the true effect could be no difference between the two groups or even a higher reduction in Māori. Hence, while there's an indication of a difference, we should interpret it cautiously given the wide range of uncertainty.\n\n> Thus, although our analysis points towards a potential difference in how exercise reduces anxiety among these groups, the level of uncertainty means we should be careful about drawing firm conclusions. More research is needed to further explore these patterns.\n\n#### **Exercise and Depression**\n\n\n> In addition to anxiety, we also examined the effect of exercise on depression. We do not find evidence for reduction of depression from exercise in either group. We do not find evidence for the effect of weekly exercise -- as self-reported -- on depression. \n\n#### **Proviso**\n\n> It is important to bear in mind that statistical results are only one piece of a larger scientific puzzle about the relationship between excercise and well-being. Other pieces include understanding the context, incorporating subject matter knowledge, and considering the implications of the findings. In the present study, wide confidence intervals suggest the possibility of considerable individual differences.$\\dots$ nevertheless, $\\dots$\n\n\n## Exercises\n\n1.  Generate a Kessler 6 binary score (Not Depressed vs. Moderately or Severely Depressed)\n\nand also:\n\n2.  Create a variable for the log of exercise hour\n\n3.  Take Home: estimate whether exercise causally affects nervousness, using the single item of the kessler 6 score. Briefly write up your results.\n\n## Appendix: MG-CFA\n\n### CFA for Kessler 6\n\nWe have learned how to do confirmatory factor analysis. Let's put this knowledge to use but clarifying the underlying factor structure of Kessler-6\n\nThe code below will:\n\n-   Load required packages.\n-   Select the Kessler 6 items\n-   Check whether there is sufficient correlation among the variables to support factor analysis.\n\n::: {.cell}\n\n```{.r .cell-code}\n# select the columns we need. \ndt_only_k6 <- dt_start |> select(kessler_depressed, kessler_effort,kessler_hopeless,\n                                 kessler_worthless, kessler_nervous,\n                                 kessler_restless)\n\n\n# check factor structure\nperformance::check_factorstructure(dt_only_k6)\n```\n:::\n\nThe code below will allow us to explore the factor structure, on the assumption of n = 3 factors.\n\n::: {.cell}\n\n```{.r .cell-code}\n# exploratory factor analysis\n# explore a factor structure made of 3 latent variables\nefa <- psych::fa(dt_only_k6, nfactors = 3) %>%\n  model_parameters(sort = TRUE, threshold = \"max\")\n\nefa\n```\n:::\n\nThis output describes an exploratory factor analysis (EFA) with 3 factors conducted on the Kessler 6 (K6) scale data. The K6 scale is used to measure psychological distress.\n\nThe analysis identifies three latent factors, labeled MR1, MR2, and MR3, which collectively account for 66.05% of the variance in the K6 data. The factors MR1, MR2, and MR3 explain 35.14%, 17.17%, and 13.73% of the variance respectively.\n\nFactor loadings, indicating the strength and direction of the relationship between the K6 items and the latent factors, are as follows:\n\n1.  Factor MR1 is strongly associated with 'kessler_depressed', 'kessler_worthless', and 'kessler_hopeless' with loadings of 0.85, 0.79, and 0.75 respectively.\n2.  Factor MR2 is exclusively linked with 'kessler_nervous' with a loading of 1.00.\n3.  Factor MR3 relates to 'kessler_restless' and 'kessler_effort' with loadings of 0.69 and 0.48 respectively.\n\nThe 'Uniqueness' values show the proportion of each variable's variance that isn't shared with the other variables.\n\nThe 'Complexity' values give a measure of how each item loads on more than one factor. All the items are either loading exclusively on one factor (complexity=1.00) or slightly more than one factor. 'kessler_effort' with complexity of 1.66 shows it's the item most shared between the factors.\n\nThe analysis suggests these K6 items measure may measure three somewhat distinct, yet related, factors of psychological distress.\n\nHowever, the meaning of these factors would need to be interpreted in the context of the variables and the theoretical framework of the study.\n\nNotably, there are many many theoretical frameworks for in measurement theory. Here is a brief description of the different conclusions one might make, depending on one's preferred theory.\n\n::: {.cell .column-page-right}\n\n```{.r .cell-code  code-fold=\"true\"}\nn <- n_factors(dt_only_k6)\n\n# plot\nplot(n) + theme_classic()\n```\n:::\n\n### Confirmatory factor analysis (ignoring groups)\n\n::: {.cell}\n\n```{.r .cell-code}\n# first partition the data \npart_data <- datawizard::data_partition(dt_only_k6, traing_proportion = .7, seed = 123)\n\n\n# set up training data\ntraining <- part_data$p_0.7\ntest <- part_data$test\n\n\n# one factor model\nstructure_k6_one <- psych::fa(training, nfactors = 1) |>\n  efa_to_cfa()\n\n# two factor model model\nstructure_k6_two <- psych::fa(training, nfactors = 2) |>\n  efa_to_cfa()\n\n# three factor model\nstructure_k6_three <- psych::fa(training, nfactors = 3) %>%\n  efa_to_cfa()\n\n# inspect models\nstructure_k6_one\nstructure_k6_two\nstructure_k6_three\n```\n:::\n\nNext we perform the confirmatory factor analysis.\n\n::: {.cell}\n\n```{.r .cell-code}\n# fit and compare models\n\n# one latent model\none_latent <-\n  suppressWarnings(lavaan::cfa(structure_k6_one, data = test))\n\n# two latents model\ntwo_latents <-\n  suppressWarnings(lavaan::cfa(structure_k6_two, data = test))\n\n# three latents model\nthree_latents <-\n  suppressWarnings(lavaan::cfa(structure_k6_three, data = test))\n\n\n# compare models\ncompare <-\n  performance::compare_performance(one_latent, two_latents, three_latents, verbose = FALSE)\n\n# view as html table\nas.data.frame(compare) |>\n  kbl(format = \"markdown\")\n```\n:::\n\nThis table provides the results of three different Confirmatory Factor Analysis (CFA) models: one that specifies a single latent factor, one that specifies two latent factors, and one that specifies three latent factors. The results include a number of goodness-of-fit statistics, which can be used to assess how well each model fits the data.\n\n#### One_latent CFA:\n\nThis model assumes that there is only one underlying latent factor contributing to all variables. This model has a chi-square statistic of 1359.7 with 14 degrees of freedom, which is highly significant (p\\<0.001), indicating a poor fit of the model to the data. Other goodness-of-fit indices like GFI, AGFI, NFI, NNFI, and CFI are all high (above 0.9), generally indicating good fit, but these indices can be misleading in the presence of large sample sizes. RMSEA is above 0.1 which indicates a poor fit. The SRMR is less than 0.08 which suggests a good fit, but given the high Chi-square and RMSEA values, we can't solely rely on this index. The Akaike information criterion (AIC), Bayesian information criterion (BIC) and adjusted BIC are used for comparing models, with lower values indicating better fit.\n\n#### Two_latents CFA\n\nThis model assumes that there are two underlying latent factors. The chi-square statistic is lower than the one-factor model (317.97 with 13 df), suggesting a better fit. The p-value is still less than 0.05, indicating a statistically significant chi-square, which typically suggests a poor fit. However, all other fit indices (GFI, AGFI, NFI, NNFI, and CFI) are above 0.9 and the RMSEA is 0.051, which generally indicate good fit. The SRMR is also less than 0.08 which suggests a good fit. This model has the lowest AIC and BIC values among the three models, indicating the best fit according to these criteria.\n\n#### Three_latents CFA\n\nThis model assumes three underlying latent factors. The chi-square statistic is 747.87 with 12 df, higher than the two-factor model, suggesting a worse fit to the data. Other fit indices such as GFI, AGFI, NFI, NNFI, and CFI are below 0.97 and the RMSEA is 0.083, which generally indicate acceptable but not excellent fit. The SRMR is less than 0.08 which suggests a good fit. The AIC and BIC values are higher than the two-factor model but lower than the one-factor model, indicating a fit that is better than the one-factor model but worse than the two-factor model.\n\nBased on these results, the two-latents model seems to provide the best fit to the data among the three models, according to most of the fit indices and the AIC and BIC. Note, all models have significant chi-square statistics, which suggests some degree of misfit. It's also important to consider the substantive interpretation of the factors, to make sure the model makes sense theoretically.\n\n### Multi-group Confirmatory Factor Analysis\n\nThis script runs multi-group confirmatory factor analysis (MG-CFA)\n\n::: {.cell}\n\n```{.r .cell-code}\n# select needed columns plus 'ethnicity'\n# filter dataset for only 'euro' and 'maori' ethnic categories\ndt_eth_k6_eth <- dt_start |> \n  filter(eth_cat == \"euro\" | eth_cat == \"maori\") |> \n  select(kessler_depressed, kessler_effort,kessler_hopeless,\n         kessler_worthless, kessler_nervous,\n         kessler_restless, eth_cat)\n\n# partition the dataset into training and test subsets\n# stratify by ethnic category to ensure balanced representation\npart_data_eth <- datawizard::data_partition(dt_eth_k6_eth, traing_proportion = .7, seed = 123, group = \"eth_cat\")\n\ntraining_eth <- part_data_eth$p_0.7\ntest_eth <- part_data_eth$test\n\n# run confirmatory factor analysis (CFA) models for configural invariance across ethnic groups\n# models specify one, two, and three latent variables\none_latent_eth_configural <- suppressWarnings(lavaan::cfa(structure_k6_one, group = \"eth_cat\", data = test_eth))\ntwo_latents_eth_configural <- suppressWarnings(lavaan::cfa(structure_k6_two, group = \"eth_cat\", data = test_eth))\nthree_latents_eth_configural <- suppressWarnings(lavaan::cfa(structure_k6_three, group = \"eth_cat\", data = test_eth))\n\n# compare model performances for configural invariance\ncompare_eth_configural <- performance::compare_performance(one_latent_eth_configural, two_latents_eth_configural, three_latents_eth_configural, verbose = FALSE)\n\n# run CFA models for metric invariance, holding factor loadings equal across groups\n# models specify one, two, and three latent variables\none_latent_eth_metric <- suppressWarnings(lavaan::cfa(structure_k6_one, group = \"eth_cat\", group.equal = \"loadings\", data = test_eth))\ntwo_latents_eth_metric  <- suppressWarnings(lavaan::cfa(structure_k6_two, group = \"eth_cat\", group.equal = \"loadings\", data = test_eth))\nthree_latents_eth_metric  <- suppressWarnings(lavaan::cfa(structure_k6_three, group = \"eth_cat\",group.equal = \"loadings\", data = test_eth))\n\n# compare model performances for metric invariance\ncompare_eth_metric  <- performance::compare_performance(one_latent_eth_metric, two_latents_eth_metric, three_latents_eth_metric, verbose = FALSE)\n\n# run CFA models for scalar invariance, holding factor loadings and intercepts equal across groups\n# models specify one, two, and three latent variables\none_latent_eth_scalar <- suppressWarnings(lavaan::cfa(structure_k6_one, group = \"eth_cat\", group.equal = c(\"loadings\",\"intercepts\"), data = test_eth))\ntwo_latents_eth_scalar  <- suppressWarnings(lavaan::cfa(structure_k6_two, group = \"eth_cat\", group.equal =  c(\"loadings\",\"intercepts\"), data = test_eth))\nthree_latents_eth_scalar  <- suppressWarnings(lavaan::cfa(structure_k6_three, group = \"eth_cat\",group.equal =  c(\"loadings\",\"intercepts\"), data = test_eth))\n\n# compare model performances for scalar invariance\ncompare_eth_scalar  <- performance::compare_performance(one_latent_eth_scalar, two_latents_eth_scalar, three_latents_eth_scalar, verbose = FALSE)\n```\n:::\n\nRecall, in the context of measurement and factor analysis, the concepts of *configural*, *metric*, and *scalar invariance* relate to the comparability of a measurement instrument, such as a survey or test, across different groups.\n\nWe saw in part 1 of this course that these invariance concepts are frequently tested in the context of cross-cultural, multi-group, or longitudinal studies.\n\nLet's first define these concepts, and then apply them to the context of the Kessler 6 (K6) Distress Scale used among Maori and New Zealand Europeans.\n\n1.  **Configural invariance** refers to the most basic level of measurement invariance, and it is established when the same pattern of factor loadings and structure is observed across groups. This means that the underlying or \"latent\" constructs (factors) are defined the same way for different groups. This doesn't mean the strength of relationship between items and factors (loadings) or the item means (intercepts) are the same, just that the items relate to the same factors in all groups.\n\nIn the context of the K6 Distress Scale, configural invariance would suggest that the same six items are measuring the construct of psychological distress in the same way for both Māori and New Zealand Europeans, even though the strength of the relationship between the items and the construct (distress), or the average scores, might differ.\n\n2.  **Metric invariance** (also known as \"weak invariance\") refers to the assumption that factor loadings are equivalent across groups, meaning that the relationship or association between the measured items and their underlying factor is the same in all groups. This is important when comparing the strength of relationships with other variables across groups.\n\nIf metric invariance holds for the K6 Distress Scale, this would mean that a unit change in the latent distress factor would correspond to the same change in each item score (e.g., feeling nervous, hopeless, restless, etc.) for both Māori and New Zealand Europeans.\n\n3.  **Scalar invariance** (also known as \"strong invariance\") involves equivalence of both factor loadings and intercepts (item means) across groups. This means that not only are the relationships between the items and the factors the same across groups (as with metric invariance), but also the zero-points or origins of the scales are the same. Scalar invariance is necessary when one wants to compare latent mean scores across groups.\n\nIn the context of the K6 Distress Scale, if scalar invariance holds, it would mean that a specific score on the scale would correspond to the same level of the underlying distress factor for both Māori and New Zealand Europeans. It would mean that the groups do not differ systematically in how they interpret and respond to the items. If this holds, one can make meaningful comparisons of distress level between Maori and New Zealand Europeans based on the scale scores.\n\nNote: each of these levels of invariance is a progressively stricter test of the equivalence of the measurement instrument across groups. Demonstrating scalar invariance, for example, also demonstrates configural and metric invariance. On the other hand, failure to demonstrate metric invariance means that scalar invariance also does not hold. These tests are therefore usually conducted in sequence. The results of these tests should be considered when comparing group means or examining the relationship between a scale and other variables across groups.\n\n### Configural invariance\n\n::: {.cell}\n\n```{.r .cell-code}\nas.data.frame(compare_eth_configural)|>\n  kbl(format = \"markdown\")\n```\n:::\n\nThe table represents the comparison of three multi-group confirmatory factor analysis (CFA) models conducted to test for configural invariance across different ethnic categories (eth_cat). Configural invariance refers to whether the pattern of factor loadings is the same across groups. It's the most basic form of measurement invariance.\n\nLooking at the results, we can draw the following conclusions:\n\n1.  **Chi2 (Chi-square)**: A lower value suggests a better model fit. In this case, the two_latents_eth_configural model exhibits the lowest Chi2 value, suggesting it has the best fit according to this metric.\n\n2.  **GFI (Goodness of Fit Index) and AGFI (Adjusted Goodness of Fit Index)**: These values range from 0 to 1, with values closer to 1 suggesting a better fit. The two_latents_eth_configural model has the highest GFI and AGFI values, indicating it is the best fit according to these indices.\n\n3.  **NFI (Normed Fit Index), NNFI (Non-Normed Fit Index, also called TLI), CFI (Comparative Fit Index)**: These range from 0 to 1, with values closer to 1 suggesting a better fit. The one_latent_eth_configural model has the highest values, suggesting it is the best fit according to these metrics.\n\n4.  **RMSEA (Root Mean Square Error of Approximation)**: Lower values are better, with values below 0.05 considered good and up to 0.08 considered acceptable. In this table, the two_latents_eth_configural model has an RMSEA of 0.05, which falls within the acceptable range.\n\n5.  **RMR (Root Mean Square Residual) and SRMR (Standardized Root Mean Square Residual)**: Lower values are better, typically less than 0.08 is considered a good fit. All models exhibit acceptable RMR and SRMR values, with the two_latents_eth_configural model having the lowest.\n\n6.  **RFI (Relative Fit Index), PNFI (Parsimonious Normed Fit Index), IFI (Incremental Fit Index), RNI (Relative Noncentrality Index)**: These range from 0 to 1, with values closer to 1 suggesting a better fit. The one_latent_eth_configural model has the highest values, suggesting the best fit according to these measures.\n\n7.  **AIC (Akaike Information Criterion) and BIC (Bayesian Information Criterion)**: Lower values indicate a better fit when comparing models. The two_latents_eth_configural model has the lowest AIC and BIC, suggesting it is the best fit according to these criteria.\n\n8.  **p_Chi2 and p_RMSEA**: These are the significance levels for the Chi-square test and the RMSEA, respectively. Non-significant values (p \\> 0.05) suggest a good fit. Only the RMSEA for the two_latents_eth_configural model is non-significant, suggesting a good fit.\n\nOverall, the two_latents_eth_configural model appears to provide the best fit across multiple indices, suggesting configural invariance (i.e., the same general factor structure) across ethnic categories with a two-factor solution. As with the previous assessment, theoretical soundness and other substantive considerations should also be taken into account when deciding on the final model. We will return to these issues next week.\n\n### Metric Equivalence\n\n::: {.cell}\n\n```{.r .cell-code}\nas.data.frame(compare_eth_metric)|>\n  kbl(format = \"markdown\")\n```\n:::\n\nThis table presents the results of a multi-group confirmatory factor analysis (CFA) conducted to test metric equivalence (also known as measurement invariance) across different ethnic categories (eth_cat). The models (one_latent_eth_metric, two_latents_eth_metric, three_latents_eth_metric) were run with a constraint of equal factor loadings across groups, which is a requirement for metric invariance.\n\nHere's the interpretation of the fit indices:\n\n1.  **Chi2 (Chi-square)**: Lower values indicate better model fit. The two_latents_eth_metric model has the lowest Chi2 value, suggesting the best fit according to this measure.\n\n2.  **GFI (Goodness of Fit Index), AGFI (Adjusted Goodness of Fit Index)**: These range from 0 to 1, with values closer to 1 indicating a better fit. The two_latents_eth_metric model has the highest GFI and AGFI values, suggesting the best fit according to these indices.\n\n3.  **NFI (Normed Fit Index), NNFI (Non-Normed Fit Index, or TLI), CFI (Comparative Fit Index)**: These range from 0 to 1, with values closer to 1 indicating a better fit. For these indices, the one_latent_eth_metric model has the highest values, suggesting the best fit according to these measures.\n\n4.  **RMSEA (Root Mean Square Error of Approximation)**: Lower values are better, with values below 0.05 generally considered good, and values up to 0.08 considered acceptable. Only the two_latents_eth_metric model has an RMSEA within the acceptable range (0.051).\n\n5.  **RMR (Root Mean Square Residual) and SRMR (Standardized Root Mean Square Residual)**: Lower values are better, typically less than 0.08 is considered a good fit. All models have acceptable RMR and SRMR values, with the two_latents_eth_metric model having the lowest, indicating the best fit.\n\n6.  **RFI (Relative Fit Index), PNFI (Parsimonious Normed Fit Index), IFI (Incremental Fit Index), RNI (Relative Noncentrality Index)**: These range from 0 to 1, with values closer to 1 indicating better fit. The one_latent_eth_metric model has the highest values, suggesting the best fit according to these indices.\n\n7.  **AIC (Akaike Information Criterion) and BIC (Bayesian Information Criterion)**: Lower values indicate a better fit when comparing models. The two_latents_eth_metric model has the lowest AIC and BIC, indicating the best fit according to these criteria.\n\n8.  **p_Chi2 and p_RMSEA**: These are the significance levels for the Chi-square test and the RMSEA, respectively. Statistically non-significant values at the traditional threshold (p \\> 0.05) suggest a good fit. Only the RMSEA for the two_latents_eth_metric model is statistically non-significant, suggesting a good fit.\n\nIn summary, the two_latents_eth_metric model appears to provide the best fit overall, indicating that a two-factor solution might be appropriate and that the metric equivalence (equal factor loadings) assumption is supported across ethnic categories. However, one must also take into consideration the theoretical soundness of the model and other substantive considerations when deciding on the final model.\n\n### Scalar Equivalence\n\n::: {.cell}\n\n```{.r .cell-code}\n# view as html table\nas.data.frame(compare_eth_scalar)|>\n  kbl(format = \"markdown\")\n```\n:::\n\nThe table presents the results of a multi-group confirmatory factor analysis (CFA) conducted to test scalar equivalence (also known as measurement invariance) across different ethnic categories (eth_cat). The models (one_latent_eth_scalar, two_latents_eth_scalar, three_latents_eth_scalar) were run with constraints on both factor loadings and intercepts to be equal across groups, a requirement for scalar invariance.\n\nHere's the interpretation of the fit indices:\n\n1.  **Chi2 (Chi-square)**: Lower values indicate better model fit. The two_latents_eth_scalar model has the lowest Chi2 value, suggesting the best fit according to this measure.\n\n2.  **GFI (Goodness of Fit Index), AGFI (Adjusted Goodness of Fit Index)**: These range from 0 to 1, with values closer to 1 indicating a better fit. The two_latents_eth_scalar model has the highest GFI and AGFI values, suggesting the best fit according to these indices.\n\n3.  **NFI (Normed Fit Index), NNFI (Non-Normed Fit Index, or TLI), CFI (Comparative Fit Index)**: These range from 0 to 1, with values closer to 1 indicating a better fit. The one_latent_eth_scalar model has the highest values, suggesting the best fit according to these measures.\n\n4.  **RMSEA (Root Mean Square Error of Approximation)**: Lower values are better, with values below 0.05 generally considered good, and values up to 0.08 considered acceptable. Only the two_latents_eth_scalar model has an RMSEA within the acceptable range (0.05).\n\n5.  **RMR (Root Mean Square Residual) and SRMR (Standardized Root Mean Square Residual)**: Lower values are better, typically less than 0.08 is considered a good fit. All models have acceptable RMR and SRMR values, with the two_latents_eth_scalar model having the lowest, indicating the best fit.\n\n6.  **RFI (Relative Fit Index), PNFI (Parsimonious Normed Fit Index), IFI (Incremental Fit Index), RNI (Relative Noncentrality Index)**: These range from 0 to 1, with values closer to 1 indicating better fit. The one_latent_eth_scalar model has the highest values, suggesting the best fit according to these indices.\n\n7.  **AIC (Akaike Information Criterion) and BIC (Bayesian Information Criterion)**: Lower values indicate a better fit when comparing models. The two_latents_eth_scalar model has the lowest AIC and BIC, indicating the best fit according to these criteria.\n\n8.  **p_Chi2 and p_RMSEA**: These are the significance levels for the Chi-square test and the RMSEA, respectively. Non-significant values (p \\> 0.05) suggest a good fit. Only the RMSEA for the two_latents_eth_scalar model is non-significant, suggesting a good fit.\n\nIn summary, the two_latents_eth_scalar model appears to provide the best fit overall, indicating that a two-factor solution might be appropriate and that the scalar equivalence (equal factor loadings and intercepts) assumption is supported across ethnic categories. However, we must also consider the theoretical soundness of the model and other substantive considerations when deciding on the final model (a matter to which we will return next week.)\n\nOverall it seems that we have good evidence for the two-factor model of Kessler-6.\n\n## Solutions\n\n1.  Generate a Kessler 6 binary score (Not Depressed vs. Moderately or Severely Depressed)\n\nand also:\n\n2.  Create a variable for the log of exercise hour\n\n::: {.cell}\n\n```{.r .cell-code}\n# functions \n#source(\"https://raw.githubusercontent.com/go-bayes/templates/main/functions/funs.R\")\n\n\n# experimental functions (more functions)\n#source(\n # \"https://raw.githubusercontent.com/go-bayes/templates/main/functions/experimental_funs.R\"\n#)\n\n\n\nnzavs_synth <-\n  arrow::read_parquet(here::here(\"data\", \"nzavs_dat_synth_t10_t12\"))\n\n\ndt_new <- nzavs_synth %>%\n  arrange(id, wave) %>%\n  rowwise() %>%\n  mutate(kessler_6  = mean(sum(\n    # Specify the Kessler scale items\n    c(\n      kessler_depressed,\n      # During the last 30 days, how often did you feel so depressed that nothing could cheer you up?\n      kessler_hopeless,\n      # During the last 30 days, how often did you feel hopeless?\n      kessler_nervous,\n      # During the last 30 days, how often did you feel nervous?\n      kessler_effort,\n      # During the last 30 days, how often did you feel that everything was an effort?\n      kessler_restless,\n      # During the last 30 days, how often did you feel restless or fidgety ?\n      kessler_worthless  # During the last 30 days, how often did you feel worthless?\n    )\n  ))) |>\n  mutate(kessler_6_sum = round(sum(\n    c (\n      kessler_depressed,\n      kessler_hopeless,\n      kessler_nervous,\n      kessler_effort,\n      kessler_restless,\n      kessler_worthless\n    )\n  ),\n  digits = 0)) |>  ungroup() |>\n  # Create a categorical variable 'kessler_6_coarsen' based on the sum of Kessler scale items\n  mutate(\n    kessler_6_coarsen = cut(\n      kessler_6_sum,\n      breaks = c(0, 5, 24),\n      labels = c(\"not_depressed\",\n                 \"mildly_to_severely_depressed\"),\n      include.lowest = TRUE,\n      include.highest = TRUE,\n      na.rm = TRUE,\n      right = FALSE\n    )\n  ) |>\n  # Transform 'hours_exercise' by applying the log function to compress its scale\n  mutate(hours_exercise_log = log(hours_exercise + 1)) # Add 1 to avoid undefined log(0). Hours spent exercising/physical activity\n```\n:::\n\n3.  Take Home: estimate whether exercise causally affects nervousness, using the single item of the kessler 6 score. Briefly write up your results.\n\n\n\n## Readings\n\n\n[@he2012]\n\n[@vandevijver2021]\n\n[@berry1989]\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}