<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.20">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Joseph Bulbulia">
<meta name="dcterms.date" content="2025-05-06">

<title>Causal inference: a step by step guide – PSYC 434 Conducting Research Across Cultures: Trimester 1, 2025</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-6b83053bd867e91890e3c09412db0bb7.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-b150b11e25d71d79f94868488eae0a4a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css">

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">PSYC 434 Conducting Research Across Cultures: Trimester 1, 2025</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../content/course-outline.html"> 
<span class="menu-text">Course Outline</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-content" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Content</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-content">    
        <li>
    <a class="dropdown-item" href="../content/glossary.pdf">
 <span class="dropdown-text">Glossary</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/course-outline.html">
 <span class="dropdown-text">Course Outline</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/01-content.html">
 <span class="dropdown-text">Week 1: Course Introduction - R (installing packages)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/02-content.html">
 <span class="dropdown-text">Week 2: Causal Diagrams - Elementary Structures and Rules - R (using the interface)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/03-content.html">
 <span class="dropdown-text">Week 3: Causal Diagrams - Confounding Bias - R (regression/simulation)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/04-content.html">
 <span class="dropdown-text">Week 4: Causal Diagrams - Interaction, Measurement Bias, Selection Bias - R (regression/simulation)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/05-content.html">
 <span class="dropdown-text">Week 5: Causal Inference - Average Treatment Effects - R (regression/simulation: ATE)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/06-content.html">
 <span class="dropdown-text">Week 6: Conditional Average Treatment Effects (CATE) - R (regression/simulation: ATE)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/07-quiz.html">
 <span class="dropdown-text">Week 7: In Class Test</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/08-content.html">
 <span class="dropdown-text">Week 8: Estimation of ATE and CATE using machine learning - R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/09-content.html">
 <span class="dropdown-text">Week 9: Theoretically postulated Subgroups analysis- R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/10-content.html">
 <span class="dropdown-text">Week 10: Hands On: Writing Up Your Analysis: Quarto Documents</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/11-content.html">
 <span class="dropdown-text">Week 11: Measurement: Factor Analysis, CFA, MultiGroup CFA, Partial Invariance/ And How These Approaches Fail</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/12-content.html">
 <span class="dropdown-text">Week 12: Student Presentations</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Causal inference: a step by step guide</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
                      </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-heading">Affiliation</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author">Joseph Bulbulia <a href="mailto:joseph.bulbulia@vuw.ac.nz" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0000-0002-5861-2056" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              Victoria University of Wellington, New Zealand
            </p>
        </div>
    </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">May 6, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#part-1-laboratory" id="toc-part-1-laboratory" class="nav-link active" data-scroll-target="#part-1-laboratory">Part 1: Laboratory</a>
  <ul class="collapse">
  <li><a href="#scripts-for-a-full-analysis" id="toc-scripts-for-a-full-analysis" class="nav-link" data-scroll-target="#scripts-for-a-full-analysis">Scripts for a full analysis</a></li>
  <li><a href="#script-0-synthetic-data-fetch" id="toc-script-0-synthetic-data-fetch" class="nav-link" data-scroll-target="#script-0-synthetic-data-fetch">Script 0: Synthetic Data Fetch</a></li>
  <li><a href="#script-1-initial-data-wrangling-is-here" id="toc-script-1-initial-data-wrangling-is-here" class="nav-link" data-scroll-target="#script-1-initial-data-wrangling-is-here">Script 1: Initial Data Wrangling is HERE</a></li>
  <li><a href="#script-2-make-wide-data-format-with-censoring-weights-is-here" id="toc-script-2-make-wide-data-format-with-censoring-weights-is-here" class="nav-link" data-scroll-target="#script-2-make-wide-data-format-with-censoring-weights-is-here">Script 2: Make Wide Data Format With Censoring Weights is HERE</a></li>
  <li><a href="#script-3-models-graphs-is-here" id="toc-script-3-models-graphs-is-here" class="nav-link" data-scroll-target="#script-3-models-graphs-is-here">Script 3: Models &amp; Graphs is HERE</a></li>
  <li><a href="#code-explanations" id="toc-code-explanations" class="nav-link" data-scroll-target="#code-explanations">Code Explanations</a>
  <ul class="collapse">
  <li><a href="#script-01-initial-data-wrangling" id="toc-script-01-initial-data-wrangling" class="nav-link" data-scroll-target="#script-01-initial-data-wrangling">Script 01 Initial Data Wrangling</a></li>
  <li><a href="#script-2-prepare-final-wide-data" id="toc-script-2-prepare-final-wide-data" class="nav-link" data-scroll-target="#script-2-prepare-final-wide-data">Script 2: Prepare Final Wide Data</a></li>
  <li><a href="#script-3-the-analysis" id="toc-script-3-the-analysis" class="nav-link" data-scroll-target="#script-3-the-analysis">Script 3 The Analysis</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#part-2" id="toc-part-2" class="nav-link" data-scroll-target="#part-2">Part 2:</a>
  <ul class="collapse">
  <li><a href="#sensitivity-analysis-using-e-values" id="toc-sensitivity-analysis-using-e-values" class="nav-link" data-scroll-target="#sensitivity-analysis-using-e-values">Sensitivity Analysis using E-values</a></li>
  <li><a href="#part-2-guide-for-preparing-your-study" id="toc-part-2-guide-for-preparing-your-study" class="nav-link" data-scroll-target="#part-2-guide-for-preparing-your-study">Part 2 Guide For Preparing Your Study</a></li>
  <li><a href="#comprehensive-checklist-for-detailed-reporting-of-a-causal-inferenctial-study." id="toc-comprehensive-checklist-for-detailed-reporting-of-a-causal-inferenctial-study." class="nav-link" data-scroll-target="#comprehensive-checklist-for-detailed-reporting-of-a-causal-inferenctial-study.">Comprehensive Checklist for Detailed Reporting of a Causal Inferenctial Study.</a>
  <ul class="collapse">
  <li><a href="#clarify-unmeasured-pre-treatment-covariates" id="toc-clarify-unmeasured-pre-treatment-covariates" class="nav-link" data-scroll-target="#clarify-unmeasured-pre-treatment-covariates">Clarify unmeasured pre-treatment covariates</a></li>
  <li><a href="#choose-the-scale-for-a-causal-contrast" id="toc-choose-the-scale-for-a-causal-contrast" class="nav-link" data-scroll-target="#choose-the-scale-for-a-causal-contrast">Choose the scale for a causal contrast</a></li>
  <li><a href="#summary-step-1-consider-how-much-we-need-to-do-when-asking-a-causal-question" id="toc-summary-step-1-consider-how-much-we-need-to-do-when-asking-a-causal-question" class="nav-link" data-scroll-target="#summary-step-1-consider-how-much-we-need-to-do-when-asking-a-causal-question">Summary Step 1: Consider how much we need to do when asking a causal question!</a></li>
  </ul></li>
  <li><a href="#step-2-answer-your-question" id="toc-step-2-answer-your-question" class="nav-link" data-scroll-target="#step-2-answer-your-question">STEP 2: Answer Your Question</a>
  <ul class="collapse">
  <li><a href="#include-the-measured-exposure-with-baseline-covariates" id="toc-include-the-measured-exposure-with-baseline-covariates" class="nav-link" data-scroll-target="#include-the-measured-exposure-with-baseline-covariates">Include the measured exposure with baseline covariates</a></li>
  <li><a href="#state-the-eligibility-criteria-for-participation" id="toc-state-the-eligibility-criteria-for-participation" class="nav-link" data-scroll-target="#state-the-eligibility-criteria-for-participation">State the eligibility criteria for participation</a></li>
  <li><a href="#determine-how-missing-data-will-be-handled" id="toc-determine-how-missing-data-will-be-handled" class="nav-link" data-scroll-target="#determine-how-missing-data-will-be-handled">Determine how missing data will be handled</a></li>
  <li><a href="#state-a-statistical-model" id="toc-state-a-statistical-model" class="nav-link" data-scroll-target="#state-a-statistical-model">State a statistical model</a></li>
  <li><a href="#reporting" id="toc-reporting" class="nav-link" data-scroll-target="#reporting">Reporting</a></li>
  <li><a href="#example-of-how-to-report-a-doubly-robust-method-in-your-report" id="toc-example-of-how-to-report-a-doubly-robust-method-in-your-report" class="nav-link" data-scroll-target="#example-of-how-to-report-a-doubly-robust-method-in-your-report">Example of how to report a doubly robust method in your report</a></li>
  <li><a href="#inference" id="toc-inference" class="nav-link" data-scroll-target="#inference">Inference</a></li>
  </ul></li>
  <li><a href="#appendix-a-details-of-estimation-approaches" id="toc-appendix-a-details-of-estimation-approaches" class="nav-link" data-scroll-target="#appendix-a-details-of-estimation-approaches">Appendix A: Details of Estimation Approaches</a>
  <ul class="collapse">
  <li><a href="#g-computation-for-subgroup-analysis-estimator" id="toc-g-computation-for-subgroup-analysis-estimator" class="nav-link" data-scroll-target="#g-computation-for-subgroup-analysis-estimator">G-computation for Subgroup Analysis Estimator</a></li>
  <li><a href="#inverse-probability-of-treatment-weighting-iptw-for-subgroup-analysis-estimator" id="toc-inverse-probability-of-treatment-weighting-iptw-for-subgroup-analysis-estimator" class="nav-link" data-scroll-target="#inverse-probability-of-treatment-weighting-iptw-for-subgroup-analysis-estimator">Inverse Probability of Treatment Weighting (IPTW) for Subgroup Analysis Estimator</a></li>
  <li><a href="#doubly-robust-estimation-for-subgroup-analysis-estimator" id="toc-doubly-robust-estimation-for-subgroup-analysis-estimator" class="nav-link" data-scroll-target="#doubly-robust-estimation-for-subgroup-analysis-estimator">Doubly Robust Estimation for Subgroup Analysis Estimator</a></li>
  <li><a href="#doubly-robust-estimation-for-subgroup-analysis-estimator-1" id="toc-doubly-robust-estimation-for-subgroup-analysis-estimator-1" class="nav-link" data-scroll-target="#doubly-robust-estimation-for-subgroup-analysis-estimator-1">Doubly Robust Estimation for Subgroup Analysis Estimator</a></li>
  </ul></li>
  <li><a href="#appendix-b-g-computation-for-subgroup-analysis-estimator-with-non-additive-effects" id="toc-appendix-b-g-computation-for-subgroup-analysis-estimator-with-non-additive-effects" class="nav-link" data-scroll-target="#appendix-b-g-computation-for-subgroup-analysis-estimator-with-non-additive-effects">Appendix B: G-computation for Subgroup Analysis Estimator with Non-Additive Effects</a></li>
  <li><a href="#appendix-c-doubly-robust-estimation-for-subgroup-analysis-estimator-with-interaction" id="toc-appendix-c-doubly-robust-estimation-for-subgroup-analysis-estimator-with-interaction" class="nav-link" data-scroll-target="#appendix-c-doubly-robust-estimation-for-subgroup-analysis-estimator-with-interaction">Appendix C: Doubly Robust Estimation for Subgroup Analysis Estimator with Interaction</a></li>
  <li><a href="#appendix-d-marginal-structural-models-for-estimating-population-average-treatment-effect-with-interaction-doubly-robust" id="toc-appendix-d-marginal-structural-models-for-estimating-population-average-treatment-effect-with-interaction-doubly-robust" class="nav-link" data-scroll-target="#appendix-d-marginal-structural-models-for-estimating-population-average-treatment-effect-with-interaction-doubly-robust">Appendix D: Marginal Structural Models for Estimating Population Average Treatment Effect with Interaction (Doubly Robust)</a>
  <ul class="collapse">
  <li><a href="#machine-learning" id="toc-machine-learning" class="nav-link" data-scroll-target="#machine-learning">Machine Learning</a></li>
  <li><a href="#packages" id="toc-packages" class="nav-link" data-scroll-target="#packages">Packages</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Required</strong> - grf package readings <a href="https://grf-labs.github.io/grf/">https://grf-labs.github.io/grf/</a> - Do “Homework” form Lecture 8</p>
<p><strong>Optional</strong> - <span class="citation" data-cites="Bulbulia2024PracticalGuide">(<a href="#ref-Bulbulia2024PracticalGuide" role="doc-biblioref">Bulbulia 2024a</a>)</span> <a href="https://osf.io/preprints/psyarxiv/uyg3d">link</a> - <span class="citation" data-cites="hoffman2023">(<a href="#ref-hoffman2023" role="doc-biblioref">Hoffman et al. 2023</a>)</span> <a href="https://arxiv.org/pdf/2304.09460.pdf">link</a> - <span class="citation" data-cites="vanderweele2020">(<a href="#ref-vanderweele2020" role="doc-biblioref">Tyler J. VanderWeele, Mathur, and Chen 2020</a>)</span> <a href="https://www.dropbox.com/scl/fi/srpynr0dvjcndveplcydn/OutcomeWide_StatisticalScience.pdf?rlkey=h4fv32oyjegdfl3jq9u1fifc3&amp;dl=0">link</a></p>
</div>
</div>
<div class="no-row-height column-margin column-container"></div><div class="no-row-height column-margin column-container"></div><div class="no-row-height column-margin column-container"><div id="ref-Bulbulia2024PracticalGuide" class="csl-entry" role="listitem">
Bulbulia, J. A. 2024a. <span>“A Practical Guide to Causal Inference in Three-Wave Panel Studies.”</span> OSF. <a href="https://doi.org/10.31234/osf.io/uyg3d">https://doi.org/10.31234/osf.io/uyg3d</a>.
</div></div><div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Key concepts
</div>
</div>
<div class="callout-body-container callout-body">
<p>Doing a causal analysis</p>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Download the R script</li>
<li>Download the relevant libraries.</li>
<li>Will go through this script step-by-step.</li>
</ul>
</div>
</div>
<section id="part-1-laboratory" class="level1 page-columns page-full">
<h1>Part 1: Laboratory</h1>
<section id="scripts-for-a-full-analysis" class="level3">
<h3 class="anchored" data-anchor-id="scripts-for-a-full-analysis">Scripts for a full analysis</h3>
<div class="callout-note-script-0">
<p><a href="../laboratory/lab-10/00-setup-L10.R">Download full lab scripts 0</a></p>
</div>
<div class="callout-note-script-1">
<p><a href="../laboratory/ ../laboratory/lab-10/01-init-L10.R">Download full lab scripts 1</a></p>
</div>
<div class="callout-note-script-2">
<p><a href="../laboratory/lab-10/02-make-wide-L10.R">Download full lab scripts 2</a></p>
</div>
<div class="callout-note-script-3">
<p><a href="../laboratory/lab-10/03-models-L10.R">Download full lab scripts 3</a></p>
</div>
</section>
<section id="script-0-synthetic-data-fetch" class="level2">
<h2 class="anchored" data-anchor-id="script-0-synthetic-data-fetch">Script 0: Synthetic Data Fetch</h2>
<p><strong>Run in full. No need to change anything.</strong></p>
<p>This script prepares your data. Run it once – running it twice would be like turning the ignition off just to start your car again.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># for students: reproducibility is like following a recipe; each step ensures the same result</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co"># restart fresh session if needed</span></span>
<span id="cb1-3"><a href="#cb1-3"></a></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co"># +--------------------------+</span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="co"># |       DO NOT ALTER       |</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="co"># +--------------------------+</span></span>
<span id="cb1-7"><a href="#cb1-7"></a></span>
<span id="cb1-8"><a href="#cb1-8"></a>rstudioapi<span class="sc">::</span><span class="fu">restartSession</span>()</span>
<span id="cb1-9"><a href="#cb1-9"></a></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="co"># set seed for reproducibility</span></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb1-12"><a href="#cb1-12"></a></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="co"># essential library ---------------------------------------------------------</span></span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="co"># install and load 'margot' from GitHub if missing</span></span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(margot, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb1-16"><a href="#cb1-16"></a>  devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"go-bayes/margot"</span>)</span>
<span id="cb1-17"><a href="#cb1-17"></a>  <span class="fu">library</span>(margot)</span>
<span id="cb1-18"><a href="#cb1-18"></a>}</span>
<span id="cb1-19"><a href="#cb1-19"></a></span>
<span id="cb1-20"><a href="#cb1-20"></a></span>
<span id="cb1-21"><a href="#cb1-21"></a><span class="cf">if</span> (<span class="fu">packageVersion</span>(<span class="st">"margot"</span>) <span class="sc">&lt;</span> <span class="st">"1.0.37"</span>) {</span>
<span id="cb1-22"><a href="#cb1-22"></a>  <span class="fu">stop</span>(<span class="st">"please install margot &gt;= 1.0.37 for this workflow</span><span class="sc">\n</span></span>
<span id="cb1-23"><a href="#cb1-23"></a><span class="st">       run: devtools::install_github(</span><span class="sc">\"</span><span class="st">go-bayes/margot</span><span class="sc">\"</span><span class="st">)</span></span>
<span id="cb1-24"><a href="#cb1-24"></a><span class="st">"</span>)</span>
<span id="cb1-25"><a href="#cb1-25"></a>}</span>
<span id="cb1-26"><a href="#cb1-26"></a></span>
<span id="cb1-27"><a href="#cb1-27"></a><span class="co"># call library</span></span>
<span id="cb1-28"><a href="#cb1-28"></a><span class="fu">library</span>(<span class="st">"margot"</span>)</span>
<span id="cb1-29"><a href="#cb1-29"></a></span>
<span id="cb1-30"><a href="#cb1-30"></a></span>
<span id="cb1-31"><a href="#cb1-31"></a></span>
<span id="cb1-32"><a href="#cb1-32"></a><span class="co"># load packages ----------------------------------------------------------</span></span>
<span id="cb1-33"><a href="#cb1-33"></a><span class="co"># install and load other packages from CRAN if missing</span></span>
<span id="cb1-34"><a href="#cb1-34"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"tidyverse"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb1-35"><a href="#cb1-35"></a>  <span class="fu">install.packages</span>(<span class="st">"tidyverse"</span>)</span>
<span id="cb1-36"><a href="#cb1-36"></a>}</span>
<span id="cb1-37"><a href="#cb1-37"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-38"><a href="#cb1-38"></a></span>
<span id="cb1-39"><a href="#cb1-39"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"qs"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb1-40"><a href="#cb1-40"></a>  <span class="fu">install.packages</span>(<span class="st">"qs"</span>)</span>
<span id="cb1-41"><a href="#cb1-41"></a>}</span>
<span id="cb1-42"><a href="#cb1-42"></a><span class="fu">library</span>(qs)</span>
<span id="cb1-43"><a href="#cb1-43"></a></span>
<span id="cb1-44"><a href="#cb1-44"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"here"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb1-45"><a href="#cb1-45"></a>  <span class="fu">install.packages</span>(<span class="st">"here"</span>)</span>
<span id="cb1-46"><a href="#cb1-46"></a>}</span>
<span id="cb1-47"><a href="#cb1-47"></a><span class="fu">library</span>(here)</span>
<span id="cb1-48"><a href="#cb1-48"></a></span>
<span id="cb1-49"><a href="#cb1-49"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"cli"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb1-50"><a href="#cb1-50"></a>  <span class="fu">install.packages</span>(<span class="st">"cli"</span>)</span>
<span id="cb1-51"><a href="#cb1-51"></a>}</span>
<span id="cb1-52"><a href="#cb1-52"></a><span class="fu">library</span>(<span class="st">"cli"</span>)</span>
<span id="cb1-53"><a href="#cb1-53"></a></span>
<span id="cb1-54"><a href="#cb1-54"></a></span>
<span id="cb1-55"><a href="#cb1-55"></a><span class="co"># create data directory if it doesn't exist -----------------------------</span></span>
<span id="cb1-56"><a href="#cb1-56"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"data"</span>)) {</span>
<span id="cb1-57"><a href="#cb1-57"></a>  <span class="fu">dir.create</span>(<span class="st">"data"</span>)  <span class="co"># first time only: make a folder named 'data'</span></span>
<span id="cb1-58"><a href="#cb1-58"></a>}</span>
<span id="cb1-59"><a href="#cb1-59"></a></span>
<span id="cb1-60"><a href="#cb1-60"></a><span class="co"># define file paths ------------------------------------------------------</span></span>
<span id="cb1-61"><a href="#cb1-61"></a><span class="co"># use here() to build paths relative to your project root</span></span>
<span id="cb1-62"><a href="#cb1-62"></a>data_dir <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>)</span>
<span id="cb1-63"><a href="#cb1-63"></a></span>
<span id="cb1-64"><a href="#cb1-64"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"created data folder ✔"</span>)</span>
<span id="cb1-65"><a href="#cb1-65"></a></span>
<span id="cb1-66"><a href="#cb1-66"></a></span>
<span id="cb1-67"><a href="#cb1-67"></a><span class="co"># download synthetic data ------------------------------------------------</span></span>
<span id="cb1-68"><a href="#cb1-68"></a><span class="co"># specify the url for the data file</span></span>
<span id="cb1-69"><a href="#cb1-69"></a>url <span class="ot">&lt;-</span> <span class="st">"https://www.dropbox.com/scl/fi/ru0ecayju04ja8ky1mhel/df_nz_long.qs?rlkey=prpk9a5v4vcg1ilhkgf357dhd&amp;dl=1"</span></span>
<span id="cb1-70"><a href="#cb1-70"></a></span>
<span id="cb1-71"><a href="#cb1-71"></a><span class="co"># download to a temporary file for safety</span></span>
<span id="cb1-72"><a href="#cb1-72"></a>tmp_file <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".qs"</span>)</span>
<span id="cb1-73"><a href="#cb1-73"></a><span class="fu">download.file</span>(url, tmp_file, <span class="at">mode =</span> <span class="st">"wb"</span>)</span>
<span id="cb1-74"><a href="#cb1-74"></a></span>
<span id="cb1-75"><a href="#cb1-75"></a><span class="co"># read the data into R using qread</span></span>
<span id="cb1-76"><a href="#cb1-76"></a>df_nz_long <span class="ot">&lt;-</span> <span class="fu">qread</span>(tmp_file)</span>
<span id="cb1-77"><a href="#cb1-77"></a></span>
<span id="cb1-78"><a href="#cb1-78"></a><span class="co"># inspect the data -------------------------------------------------------</span></span>
<span id="cb1-79"><a href="#cb1-79"></a><span class="co"># view the first few rows to check it loaded correctly</span></span>
<span id="cb1-80"><a href="#cb1-80"></a><span class="fu">print</span>(<span class="fu">head</span>(df_nz_long))</span>
<span id="cb1-81"><a href="#cb1-81"></a></span>
<span id="cb1-82"><a href="#cb1-82"></a><span class="co"># list column names so you know what variables are available</span></span>
<span id="cb1-83"><a href="#cb1-83"></a><span class="fu">print</span>(<span class="fu">colnames</span>(df_nz_long))</span>
<span id="cb1-84"><a href="#cb1-84"></a></span>
<span id="cb1-85"><a href="#cb1-85"></a><span class="co"># save a copy of the data ------------------------------------------------</span></span>
<span id="cb1-86"><a href="#cb1-86"></a><span class="co"># save the dataset to your data directory for future use</span></span>
<span id="cb1-87"><a href="#cb1-87"></a><span class="fu">here_save_qs</span>(df_nz_long, <span class="st">"df_nz_long"</span>, data_dir)</span>
<span id="cb1-88"><a href="#cb1-88"></a></span>
<span id="cb1-89"><a href="#cb1-89"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"downloaded data to data folder for furture use ✔"</span>)</span>
<span id="cb1-90"><a href="#cb1-90"></a></span>
<span id="cb1-91"><a href="#cb1-91"></a><span class="co"># +--------------------------+</span></span>
<span id="cb1-92"><a href="#cb1-92"></a><span class="co"># |     </span><span class="re">END</span><span class="co"> DO NOT ALTER     |</span></span>
<span id="cb1-93"><a href="#cb1-93"></a><span class="co"># +--------------------------+</span></span>
<span id="cb1-94"><a href="#cb1-94"></a></span>
<span id="cb1-95"><a href="#cb1-95"></a></span>
<span id="cb1-96"><a href="#cb1-96"></a><span class="co"># +--------------------------+</span></span>
<span id="cb1-97"><a href="#cb1-97"></a><span class="co"># |     </span><span class="re">END</span><span class="co">                  |</span></span>
<span id="cb1-98"><a href="#cb1-98"></a><span class="co"># +--------------------------+</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="script-1-initial-data-wrangling-is-here" class="level2">
<h2 class="anchored" data-anchor-id="script-1-initial-data-wrangling-is-here">Script 1: Initial Data Wrangling is HERE</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># script 1 workflow lecture 10</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co"># may 2025</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co"># questions: joseph.bulbulia@vuw.ac.nz</span></span>
<span id="cb2-4"><a href="#cb2-4"></a></span>
<span id="cb2-5"><a href="#cb2-5"></a></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="co"># |       DO NOT ALTER       |</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-9"><a href="#cb2-9"></a></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="co"># restart fresh session for a clean workspace</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>rstudioapi<span class="sc">::</span><span class="fu">restartSession</span>()</span>
<span id="cb2-12"><a href="#cb2-12"></a></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="co"># set seed for reproducibility</span></span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb2-15"><a href="#cb2-15"></a></span>
<span id="cb2-16"><a href="#cb2-16"></a><span class="co"># essential library ---------------------------------------------------------</span></span>
<span id="cb2-17"><a href="#cb2-17"></a><span class="co"># install and load 'margot' from GitHub if missing</span></span>
<span id="cb2-18"><a href="#cb2-18"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(margot, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb2-19"><a href="#cb2-19"></a>  devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"go-bayes/margot"</span>)</span>
<span id="cb2-20"><a href="#cb2-20"></a>  <span class="fu">library</span>(margot)</span>
<span id="cb2-21"><a href="#cb2-21"></a>}</span>
<span id="cb2-22"><a href="#cb2-22"></a></span>
<span id="cb2-23"><a href="#cb2-23"></a></span>
<span id="cb2-24"><a href="#cb2-24"></a><span class="cf">if</span> (<span class="fu">packageVersion</span>(<span class="st">"margot"</span>) <span class="sc">&lt;</span> <span class="st">"1.0.37"</span>) {</span>
<span id="cb2-25"><a href="#cb2-25"></a>  <span class="fu">stop</span>(<span class="st">"please install margot &gt;= 1.0.37 for this workflow</span><span class="sc">\n</span></span>
<span id="cb2-26"><a href="#cb2-26"></a><span class="st">       run: devtools::install_github(</span><span class="sc">\"</span><span class="st">go-bayes/margot</span><span class="sc">\"</span><span class="st">)</span></span>
<span id="cb2-27"><a href="#cb2-27"></a><span class="st">"</span>)</span>
<span id="cb2-28"><a href="#cb2-28"></a>}</span>
<span id="cb2-29"><a href="#cb2-29"></a></span>
<span id="cb2-30"><a href="#cb2-30"></a><span class="co"># call library</span></span>
<span id="cb2-31"><a href="#cb2-31"></a><span class="fu">library</span>(<span class="st">"margot"</span>)</span>
<span id="cb2-32"><a href="#cb2-32"></a></span>
<span id="cb2-33"><a href="#cb2-33"></a><span class="co"># load packages -------------------------------------------------------------</span></span>
<span id="cb2-34"><a href="#cb2-34"></a><span class="co"># pacman will install missing packages automatically</span></span>
<span id="cb2-35"><a href="#cb2-35"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"pacman"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"pacman"</span>)</span>
<span id="cb2-36"><a href="#cb2-36"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb2-37"><a href="#cb2-37"></a>  tidyverse,       <span class="co"># data wrangling + plotting</span></span>
<span id="cb2-38"><a href="#cb2-38"></a>  qs,              <span class="co"># fast data i/o</span></span>
<span id="cb2-39"><a href="#cb2-39"></a>  here,            <span class="co"># project-relative file paths</span></span>
<span id="cb2-40"><a href="#cb2-40"></a>  data.table,      <span class="co"># fast data manipulation</span></span>
<span id="cb2-41"><a href="#cb2-41"></a>  fastDummies,     <span class="co"># dummy variable creation</span></span>
<span id="cb2-42"><a href="#cb2-42"></a>  naniar,          <span class="co"># missing data handling</span></span>
<span id="cb2-43"><a href="#cb2-43"></a>  skimr,           <span class="co"># summary statistics</span></span>
<span id="cb2-44"><a href="#cb2-44"></a>  grf,             <span class="co"># machine learning forests</span></span>
<span id="cb2-45"><a href="#cb2-45"></a>  kableExtra,      <span class="co"># tables</span></span>
<span id="cb2-46"><a href="#cb2-46"></a>  ggplot2,         <span class="co"># graphs</span></span>
<span id="cb2-47"><a href="#cb2-47"></a>  doParallel,       <span class="co"># parallel processing</span></span>
<span id="cb2-48"><a href="#cb2-48"></a>  grf,             <span class="co"># causal forests</span></span>
<span id="cb2-49"><a href="#cb2-49"></a>  janitor,          <span class="co"># variables names</span></span>
<span id="cb2-50"><a href="#cb2-50"></a>  stringr,          <span class="co"># variable names</span></span>
<span id="cb2-51"><a href="#cb2-51"></a>  patchwork,        <span class="co"># graphs</span></span>
<span id="cb2-52"><a href="#cb2-52"></a>  table1,          <span class="co"># tables,</span></span>
<span id="cb2-53"><a href="#cb2-53"></a>  cli</span>
<span id="cb2-54"><a href="#cb2-54"></a>)</span>
<span id="cb2-55"><a href="#cb2-55"></a></span>
<span id="cb2-56"><a href="#cb2-56"></a></span>
<span id="cb2-57"><a href="#cb2-57"></a><span class="co"># create directories --------------------------------------------------------</span></span>
<span id="cb2-58"><a href="#cb2-58"></a><span class="co"># create data directory if it doesn't exist</span></span>
<span id="cb2-59"><a href="#cb2-59"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"data"</span>)) {</span>
<span id="cb2-60"><a href="#cb2-60"></a>  <span class="fu">dir.create</span>(<span class="st">"data"</span>)  <span class="co"># first time only: make a folder named 'data'</span></span>
<span id="cb2-61"><a href="#cb2-61"></a>}</span>
<span id="cb2-62"><a href="#cb2-62"></a></span>
<span id="cb2-63"><a href="#cb2-63"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"save_directory"</span>)) {</span>
<span id="cb2-64"><a href="#cb2-64"></a>  <span class="fu">dir.create</span>(<span class="st">"save_directory"</span>)  <span class="co"># first time only: make a folder named 'data'</span></span>
<span id="cb2-65"><a href="#cb2-65"></a>}</span>
<span id="cb2-66"><a href="#cb2-66"></a></span>
<span id="cb2-67"><a href="#cb2-67"></a><span class="co"># set up data directory structure</span></span>
<span id="cb2-68"><a href="#cb2-68"></a>data_dir    <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>)</span>
<span id="cb2-69"><a href="#cb2-69"></a>push_mods <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"save_directory"</span>) </span>
<span id="cb2-70"><a href="#cb2-70"></a></span>
<span id="cb2-71"><a href="#cb2-71"></a></span>
<span id="cb2-72"><a href="#cb2-72"></a><span class="co"># load data -----------------------------------------------------------------</span></span>
<span id="cb2-73"><a href="#cb2-73"></a>df_nz_long <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read_qs</span>(<span class="st">"df_nz_long"</span>, data_dir)</span>
<span id="cb2-74"><a href="#cb2-74"></a></span>
<span id="cb2-75"><a href="#cb2-75"></a></span>
<span id="cb2-76"><a href="#cb2-76"></a><span class="co"># initial data prep ---------------------------------------------------------</span></span>
<span id="cb2-77"><a href="#cb2-77"></a><span class="co"># prepare intial data</span></span>
<span id="cb2-78"><a href="#cb2-78"></a><span class="co"># define labels for rural classification</span></span>
<span id="cb2-79"><a href="#cb2-79"></a>rural_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb2-80"><a href="#cb2-80"></a>  <span class="st">"High Urban Accessibility"</span>, </span>
<span id="cb2-81"><a href="#cb2-81"></a>  <span class="st">"Medium Urban Accessibility"</span>,</span>
<span id="cb2-82"><a href="#cb2-82"></a>  <span class="st">"Low Urban Accessibility"</span>, </span>
<span id="cb2-83"><a href="#cb2-83"></a>  <span class="st">"Remote"</span>, </span>
<span id="cb2-84"><a href="#cb2-84"></a>  <span class="st">"Very Remote"</span></span>
<span id="cb2-85"><a href="#cb2-85"></a>)</span>
<span id="cb2-86"><a href="#cb2-86"></a></span>
<span id="cb2-87"><a href="#cb2-87"></a>dat_prep <span class="ot">&lt;-</span> df_nz_long <span class="sc">|&gt;</span></span>
<span id="cb2-88"><a href="#cb2-88"></a>  <span class="fu">arrange</span>(id, wave) <span class="sc">|&gt;</span></span>
<span id="cb2-89"><a href="#cb2-89"></a>  margot<span class="sc">::</span><span class="fu">remove_numeric_attributes</span>() <span class="sc">|&gt;</span></span>
<span id="cb2-90"><a href="#cb2-90"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-91"><a href="#cb2-91"></a>    <span class="co"># cap extreme values</span></span>
<span id="cb2-92"><a href="#cb2-92"></a>    <span class="at">alcohol_intensity =</span> <span class="fu">pmin</span>(alcohol_intensity, <span class="dv">15</span>),</span>
<span id="cb2-93"><a href="#cb2-93"></a>    <span class="co"># flag heavy drinkers: freq ≥3 → 1, ≤2 → 0, else NA</span></span>
<span id="cb2-94"><a href="#cb2-94"></a>    <span class="at">heavy_drinker =</span> <span class="fu">case_when</span>(</span>
<span id="cb2-95"><a href="#cb2-95"></a>      alcohol_frequency <span class="sc">&gt;=</span> <span class="dv">3</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb2-96"><a href="#cb2-96"></a>      alcohol_frequency <span class="sc">&lt;=</span> <span class="dv">2</span> <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb2-97"><a href="#cb2-97"></a>      <span class="cn">TRUE</span>                  <span class="sc">~</span> <span class="cn">NA_real_</span></span>
<span id="cb2-98"><a href="#cb2-98"></a>    ),</span>
<span id="cb2-99"><a href="#cb2-99"></a>    <span class="co"># map freq categories to weekly counts</span></span>
<span id="cb2-100"><a href="#cb2-100"></a>    <span class="at">alcohol_frequency_weekly =</span> <span class="fu">recode</span>(</span>
<span id="cb2-101"><a href="#cb2-101"></a>      alcohol_frequency,</span>
<span id="cb2-102"><a href="#cb2-102"></a>      <span class="st">`</span><span class="at">0</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">0</span>, <span class="st">`</span><span class="at">1</span><span class="st">`</span> <span class="ot">=</span> <span class="fl">0.25</span>,</span>
<span id="cb2-103"><a href="#cb2-103"></a>      <span class="st">`</span><span class="at">2</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">`</span><span class="at">3</span><span class="st">`</span> <span class="ot">=</span> <span class="fl">2.5</span>,</span>
<span id="cb2-104"><a href="#cb2-104"></a>      <span class="st">`</span><span class="at">4</span><span class="st">`</span> <span class="ot">=</span> <span class="fl">4.5</span>,</span>
<span id="cb2-105"><a href="#cb2-105"></a>      <span class="at">.default =</span> <span class="cn">NA_real_</span></span>
<span id="cb2-106"><a href="#cb2-106"></a>    ),</span>
<span id="cb2-107"><a href="#cb2-107"></a>    <span class="co"># relabel rural factor</span></span>
<span id="cb2-108"><a href="#cb2-108"></a>    <span class="at">rural_gch_2018_l =</span> <span class="fu">factor</span>(</span>
<span id="cb2-109"><a href="#cb2-109"></a>      rural_gch_2018_l,</span>
<span id="cb2-110"><a href="#cb2-110"></a>      <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,</span>
<span id="cb2-111"><a href="#cb2-111"></a>      <span class="at">labels =</span> rural_labels,</span>
<span id="cb2-112"><a href="#cb2-112"></a>      <span class="at">ordered =</span> <span class="cn">TRUE</span></span>
<span id="cb2-113"><a href="#cb2-113"></a>    )</span>
<span id="cb2-114"><a href="#cb2-114"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb2-115"><a href="#cb2-115"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb2-116"><a href="#cb2-116"></a></span>
<span id="cb2-117"><a href="#cb2-117"></a></span>
<span id="cb2-118"><a href="#cb2-118"></a></span>
<span id="cb2-119"><a href="#cb2-119"></a><span class="co"># view variable names -----------------------------------------------------</span></span>
<span id="cb2-120"><a href="#cb2-120"></a><span class="fu">print</span>(<span class="fu">colnames</span>(df_nz_long)) </span>
<span id="cb2-121"><a href="#cb2-121"></a></span>
<span id="cb2-122"><a href="#cb2-122"></a></span>
<span id="cb2-123"><a href="#cb2-123"></a><span class="co"># get total participants</span></span>
<span id="cb2-124"><a href="#cb2-124"></a>n_total <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_nz_long<span class="sc">$</span>id))</span>
<span id="cb2-125"><a href="#cb2-125"></a></span>
<span id="cb2-126"><a href="#cb2-126"></a><span class="co"># pretty number</span></span>
<span id="cb2-127"><a href="#cb2-127"></a>n_total <span class="ot">=</span> margot<span class="sc">::</span><span class="fu">pretty_number</span>(n_total)</span>
<span id="cb2-128"><a href="#cb2-128"></a></span>
<span id="cb2-129"><a href="#cb2-129"></a><span class="co"># save</span></span>
<span id="cb2-130"><a href="#cb2-130"></a><span class="fu">here_save</span>(n_total, <span class="st">"n_total"</span>)</span>
<span id="cb2-131"><a href="#cb2-131"></a></span>
<span id="cb2-132"><a href="#cb2-132"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-133"><a href="#cb2-133"></a><span class="co"># |     </span><span class="re">END</span><span class="co"> DO NOT ALTER     |</span></span>
<span id="cb2-134"><a href="#cb2-134"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-135"><a href="#cb2-135"></a></span>
<span id="cb2-136"><a href="#cb2-136"></a></span>
<span id="cb2-137"><a href="#cb2-137"></a></span>
<span id="cb2-138"><a href="#cb2-138"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-139"><a href="#cb2-139"></a><span class="co"># |    MODIFY THIS SECTION   |</span></span>
<span id="cb2-140"><a href="#cb2-140"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-141"><a href="#cb2-141"></a></span>
<span id="cb2-142"><a href="#cb2-142"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-143"><a href="#cb2-143"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb2-144"><a href="#cb2-144"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-145"><a href="#cb2-145"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-146"><a href="#cb2-146"></a><span class="co"># | OPTIONALLY MODIFY SECTION|</span></span>
<span id="cb2-147"><a href="#cb2-147"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-148"><a href="#cb2-148"></a></span>
<span id="cb2-149"><a href="#cb2-149"></a><span class="co"># define study variables ----------------------------------------------------</span></span>
<span id="cb2-150"><a href="#cb2-150"></a><span class="co"># ** key decision 1: define your three study waves **</span></span>
<span id="cb2-151"><a href="#cb2-151"></a><span class="co"># **  define your study waves **</span></span>
<span id="cb2-152"><a href="#cb2-152"></a>baseline_wave      <span class="ot">&lt;-</span> <span class="st">"2018"</span>        <span class="co"># baseline measurement</span></span>
<span id="cb2-153"><a href="#cb2-153"></a>exposure_waves     <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"2019"</span>)     <span class="co"># when exposure is measured</span></span>
<span id="cb2-154"><a href="#cb2-154"></a>outcome_wave       <span class="ot">&lt;-</span> <span class="st">"2020"</span>        <span class="co"># when outcomes are measured</span></span>
<span id="cb2-155"><a href="#cb2-155"></a>all_waves          <span class="ot">&lt;-</span> <span class="fu">c</span>(baseline_wave, exposure_waves, outcome_wave)</span>
<span id="cb2-156"><a href="#cb2-156"></a></span>
<span id="cb2-157"><a href="#cb2-157"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"set waves for three-wave study ✔"</span>)</span>
<span id="cb2-158"><a href="#cb2-158"></a></span>
<span id="cb2-159"><a href="#cb2-159"></a></span>
<span id="cb2-160"><a href="#cb2-160"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-161"><a href="#cb2-161"></a><span class="co"># |</span><span class="re">END</span><span class="co"> OPTIONALLY MODIFY SEC.|</span></span>
<span id="cb2-162"><a href="#cb2-162"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-163"><a href="#cb2-163"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-164"><a href="#cb2-164"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb2-165"><a href="#cb2-165"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-166"><a href="#cb2-166"></a></span>
<span id="cb2-167"><a href="#cb2-167"></a></span>
<span id="cb2-168"><a href="#cb2-168"></a></span>
<span id="cb2-169"><a href="#cb2-169"></a><span class="co"># define exposure variable ----------------------------------------------------</span></span>
<span id="cb2-170"><a href="#cb2-170"></a><span class="co"># ** key decision 2: define your exposure variable **</span></span>
<span id="cb2-171"><a href="#cb2-171"></a></span>
<span id="cb2-172"><a href="#cb2-172"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-173"><a href="#cb2-173"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb2-174"><a href="#cb2-174"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-175"><a href="#cb2-175"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-176"><a href="#cb2-176"></a><span class="co"># |    MODIFY THIS SECTION   |</span></span>
<span id="cb2-177"><a href="#cb2-177"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-178"><a href="#cb2-178"></a>name_exposure <span class="ot">&lt;-</span> <span class="st">"extraversion"</span></span>
<span id="cb2-179"><a href="#cb2-179"></a></span>
<span id="cb2-180"><a href="#cb2-180"></a><span class="co"># exposure variable labels</span></span>
<span id="cb2-181"><a href="#cb2-181"></a>var_labels_exposure <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb2-182"><a href="#cb2-182"></a>  <span class="st">"extraversion"</span> <span class="ot">=</span> <span class="st">"Extraversion"</span>,</span>
<span id="cb2-183"><a href="#cb2-183"></a>  <span class="st">"extraversion_binary"</span> <span class="ot">=</span> <span class="st">"Extraversion (binary)"</span></span>
<span id="cb2-184"><a href="#cb2-184"></a>)</span>
<span id="cb2-185"><a href="#cb2-185"></a></span>
<span id="cb2-186"><a href="#cb2-186"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"set variable name for exposure ✔"</span>)</span>
<span id="cb2-187"><a href="#cb2-187"></a></span>
<span id="cb2-188"><a href="#cb2-188"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-189"><a href="#cb2-189"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb2-190"><a href="#cb2-190"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-191"><a href="#cb2-191"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-192"><a href="#cb2-192"></a><span class="co"># |   </span><span class="re">END</span><span class="co"> MODIFY SECTION     |</span></span>
<span id="cb2-193"><a href="#cb2-193"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-194"><a href="#cb2-194"></a></span>
<span id="cb2-195"><a href="#cb2-195"></a></span>
<span id="cb2-196"><a href="#cb2-196"></a></span>
<span id="cb2-197"><a href="#cb2-197"></a></span>
<span id="cb2-198"><a href="#cb2-198"></a></span>
<span id="cb2-199"><a href="#cb2-199"></a></span>
<span id="cb2-200"><a href="#cb2-200"></a><span class="co"># define outcome variables -------------------------------------------</span></span>
<span id="cb2-201"><a href="#cb2-201"></a><span class="co"># ** key decision 3: define your outcome variable **</span></span>
<span id="cb2-202"><a href="#cb2-202"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-203"><a href="#cb2-203"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb2-204"><a href="#cb2-204"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-205"><a href="#cb2-205"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-206"><a href="#cb2-206"></a><span class="co"># |    MODIFY THIS SECTION   |</span></span>
<span id="cb2-207"><a href="#cb2-207"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-208"><a href="#cb2-208"></a><span class="co"># ** key decision 3: define outcome variables **</span></span>
<span id="cb2-209"><a href="#cb2-209"></a><span class="co"># here, we are focussing on a subset of wellbeing outcomes</span></span>
<span id="cb2-210"><a href="#cb2-210"></a><span class="co"># chose outcomes relevant to * your * study. Might be all/some/none/exactly </span></span>
<span id="cb2-211"><a href="#cb2-211"></a><span class="co"># these:</span></span>
<span id="cb2-212"><a href="#cb2-212"></a>outcome_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb2-213"><a href="#cb2-213"></a>  <span class="co"># health outcomes</span></span>
<span id="cb2-214"><a href="#cb2-214"></a>  <span class="co"># "alcohol_frequency_weekly", "alcohol_intensity",</span></span>
<span id="cb2-215"><a href="#cb2-215"></a>  <span class="co"># "hlth_bmi", </span></span>
<span id="cb2-216"><a href="#cb2-216"></a>  <span class="st">"log_hours_exercise"</span>, </span>
<span id="cb2-217"><a href="#cb2-217"></a>  <span class="co"># "hlth_sleep_hours", </span></span>
<span id="cb2-218"><a href="#cb2-218"></a>  <span class="co"># "short_form_health",</span></span>
<span id="cb2-219"><a href="#cb2-219"></a>  </span>
<span id="cb2-220"><a href="#cb2-220"></a>  <span class="co"># psychological outcomes</span></span>
<span id="cb2-221"><a href="#cb2-221"></a>  <span class="co"># "hlth_fatigue", </span></span>
<span id="cb2-222"><a href="#cb2-222"></a>  <span class="st">"kessler_latent_anxiety"</span>, </span>
<span id="cb2-223"><a href="#cb2-223"></a>  <span class="st">"kessler_latent_depression"</span>, </span>
<span id="cb2-224"><a href="#cb2-224"></a>  <span class="st">"rumination"</span>,</span>
<span id="cb2-225"><a href="#cb2-225"></a>  </span>
<span id="cb2-226"><a href="#cb2-226"></a>  <span class="co"># well-being outcomes</span></span>
<span id="cb2-227"><a href="#cb2-227"></a>  <span class="co"># "bodysat", </span></span>
<span id="cb2-228"><a href="#cb2-228"></a>  <span class="co">#"forgiveness", "gratitude", </span></span>
<span id="cb2-229"><a href="#cb2-229"></a>  <span class="st">"lifesat"</span>, <span class="st">"meaning_purpose"</span>, <span class="st">"meaning_sense"</span>, </span>
<span id="cb2-230"><a href="#cb2-230"></a>  <span class="co"># "perfectionism", </span></span>
<span id="cb2-231"><a href="#cb2-231"></a>  <span class="st">"pwi"</span>, </span>
<span id="cb2-232"><a href="#cb2-232"></a>  <span class="co">#"self_control", </span></span>
<span id="cb2-233"><a href="#cb2-233"></a>  <span class="st">"self_esteem"</span>, </span>
<span id="cb2-234"><a href="#cb2-234"></a>  <span class="co">#"sexual_satisfaction",</span></span>
<span id="cb2-235"><a href="#cb2-235"></a>  </span>
<span id="cb2-236"><a href="#cb2-236"></a>  <span class="co"># social outcomes</span></span>
<span id="cb2-237"><a href="#cb2-237"></a>  <span class="st">"belong"</span>, <span class="st">"neighbourhood_community"</span>, <span class="st">"support"</span></span>
<span id="cb2-238"><a href="#cb2-238"></a>)</span>
<span id="cb2-239"><a href="#cb2-239"></a></span>
<span id="cb2-240"><a href="#cb2-240"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"set variable name for outcomes ✔"</span>)</span>
<span id="cb2-241"><a href="#cb2-241"></a></span>
<span id="cb2-242"><a href="#cb2-242"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-243"><a href="#cb2-243"></a><span class="co"># |   </span><span class="re">END</span><span class="co"> MODIFY SECTION     |</span></span>
<span id="cb2-244"><a href="#cb2-244"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-245"><a href="#cb2-245"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-246"><a href="#cb2-246"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb2-247"><a href="#cb2-247"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-248"><a href="#cb2-248"></a></span>
<span id="cb2-249"><a href="#cb2-249"></a></span>
<span id="cb2-250"><a href="#cb2-250"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-251"><a href="#cb2-251"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb2-252"><a href="#cb2-252"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-253"><a href="#cb2-253"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-254"><a href="#cb2-254"></a><span class="co"># | OPTIONALLY MODIFY SECTION|</span></span>
<span id="cb2-255"><a href="#cb2-255"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-256"><a href="#cb2-256"></a><span class="co"># define baseline variables -----------------------------------------------</span></span>
<span id="cb2-257"><a href="#cb2-257"></a><span class="co"># key decision 4 **  define baseline covariates **</span></span>
<span id="cb2-258"><a href="#cb2-258"></a><span class="co"># these are demographics, traits, etc. measured at baseline, that are common</span></span>
<span id="cb2-259"><a href="#cb2-259"></a><span class="co"># causes of the exposure and outcome.  </span></span>
<span id="cb2-260"><a href="#cb2-260"></a><span class="co"># note we will automatically include baseline measures of the exposure and outcome</span></span>
<span id="cb2-261"><a href="#cb2-261"></a><span class="co"># later in the workflow.</span></span>
<span id="cb2-262"><a href="#cb2-262"></a></span>
<span id="cb2-263"><a href="#cb2-263"></a>baseline_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb2-264"><a href="#cb2-264"></a>  <span class="co"># demographics</span></span>
<span id="cb2-265"><a href="#cb2-265"></a>  <span class="st">"age"</span>, <span class="st">"born_nz_binary"</span>, <span class="st">"education_level_coarsen"</span>,</span>
<span id="cb2-266"><a href="#cb2-266"></a>  <span class="st">"employed_binary"</span>, <span class="st">"eth_cat"</span>, <span class="st">"male_binary"</span>,</span>
<span id="cb2-267"><a href="#cb2-267"></a>  <span class="st">"not_heterosexual_binary"</span>, <span class="st">"parent_binary"</span>, <span class="st">"partner_binary"</span>,</span>
<span id="cb2-268"><a href="#cb2-268"></a>  <span class="st">"rural_gch_2018_l"</span>, <span class="st">"sample_frame_opt_in_binary"</span>,</span>
<span id="cb2-269"><a href="#cb2-269"></a>  </span>
<span id="cb2-270"><a href="#cb2-270"></a>  <span class="co"># personality traits (excluding exposure)</span></span>
<span id="cb2-271"><a href="#cb2-271"></a>  <span class="st">"agreeableness"</span>, <span class="st">"conscientiousness"</span>, <span class="st">"neuroticism"</span>, <span class="st">"openness"</span>,</span>
<span id="cb2-272"><a href="#cb2-272"></a>  </span>
<span id="cb2-273"><a href="#cb2-273"></a>  <span class="co"># health and lifestyle</span></span>
<span id="cb2-274"><a href="#cb2-274"></a>  <span class="st">"alcohol_frequency"</span>, <span class="st">"alcohol_intensity"</span>, <span class="st">"hlth_disability_binary"</span>,</span>
<span id="cb2-275"><a href="#cb2-275"></a>  <span class="st">"log_hours_children"</span>, <span class="st">"log_hours_commute"</span>, <span class="st">"log_hours_exercise"</span>,</span>
<span id="cb2-276"><a href="#cb2-276"></a>  <span class="st">"log_hours_housework"</span>, <span class="st">"log_household_inc"</span>,</span>
<span id="cb2-277"><a href="#cb2-277"></a>  <span class="st">"short_form_health"</span>, <span class="st">"smoker_binary"</span>,</span>
<span id="cb2-278"><a href="#cb2-278"></a>  </span>
<span id="cb2-279"><a href="#cb2-279"></a>  <span class="co"># social and psychological</span></span>
<span id="cb2-280"><a href="#cb2-280"></a>  <span class="st">"belong"</span>, <span class="st">"nz_dep2018"</span>, <span class="st">"nzsei_13_l"</span>,</span>
<span id="cb2-281"><a href="#cb2-281"></a>  <span class="st">"political_conservative"</span>, <span class="st">"religion_identification_level"</span></span>
<span id="cb2-282"><a href="#cb2-282"></a>)</span>
<span id="cb2-283"><a href="#cb2-283"></a></span>
<span id="cb2-284"><a href="#cb2-284"></a></span>
<span id="cb2-285"><a href="#cb2-285"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"set baseline covariate names  ✔"</span>)</span>
<span id="cb2-286"><a href="#cb2-286"></a></span>
<span id="cb2-287"><a href="#cb2-287"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-288"><a href="#cb2-288"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb2-289"><a href="#cb2-289"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-290"><a href="#cb2-290"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-291"><a href="#cb2-291"></a><span class="co"># |   </span><span class="re">END</span><span class="co"> MODIFY SECTION     |</span></span>
<span id="cb2-292"><a href="#cb2-292"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-293"><a href="#cb2-293"></a></span>
<span id="cb2-294"><a href="#cb2-294"></a></span>
<span id="cb2-295"><a href="#cb2-295"></a></span>
<span id="cb2-296"><a href="#cb2-296"></a></span>
<span id="cb2-297"><a href="#cb2-297"></a></span>
<span id="cb2-298"><a href="#cb2-298"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-299"><a href="#cb2-299"></a><span class="co"># |       DO NOT ALTER       |</span></span>
<span id="cb2-300"><a href="#cb2-300"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-301"><a href="#cb2-301"></a></span>
<span id="cb2-302"><a href="#cb2-302"></a><span class="co"># after selecting your exposure/ baseline / outcome variables do not modify this</span></span>
<span id="cb2-303"><a href="#cb2-303"></a><span class="co"># code</span></span>
<span id="cb2-304"><a href="#cb2-304"></a></span>
<span id="cb2-305"><a href="#cb2-305"></a><span class="co"># make binary variable (UNLESS YOUR EXPOSURE IS A BINARY VARIABLE)</span></span>
<span id="cb2-306"><a href="#cb2-306"></a>exposure_var_binary <span class="ot">=</span> <span class="fu">paste0</span>(name_exposure, <span class="st">"_binary"</span>)</span>
<span id="cb2-307"><a href="#cb2-307"></a></span>
<span id="cb2-308"><a href="#cb2-308"></a><span class="co"># make exposure variable list (we will keep both the continuous and binary variable)</span></span>
<span id="cb2-309"><a href="#cb2-309"></a>exposure_var  <span class="ot">&lt;-</span> <span class="fu">c</span>(name_exposure, <span class="fu">paste0</span>(name_exposure, <span class="st">"_binary"</span>))</span>
<span id="cb2-310"><a href="#cb2-310"></a></span>
<span id="cb2-311"><a href="#cb2-311"></a><span class="co"># sort for easier reference</span></span>
<span id="cb2-312"><a href="#cb2-312"></a>baseline_vars <span class="ot">&lt;-</span> <span class="fu">sort</span>(baseline_vars)</span>
<span id="cb2-313"><a href="#cb2-313"></a>outcome_vars <span class="ot">&lt;-</span> <span class="fu">sort</span>(outcome_vars)</span>
<span id="cb2-314"><a href="#cb2-314"></a></span>
<span id="cb2-315"><a href="#cb2-315"></a><span class="co"># save key variables --------------------------------------------------------</span></span>
<span id="cb2-316"><a href="#cb2-316"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(name_exposure, <span class="st">"name_exposure"</span>)</span>
<span id="cb2-317"><a href="#cb2-317"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(var_labels_exposure,<span class="st">"var_labels_exposure"</span>)</span>
<span id="cb2-318"><a href="#cb2-318"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(baseline_vars,<span class="st">"baseline_vars"</span>)</span>
<span id="cb2-319"><a href="#cb2-319"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(exposure_var, <span class="st">"exposure_var"</span>)</span>
<span id="cb2-320"><a href="#cb2-320"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(exposure_var_binary, <span class="st">"exposure_var_binary"</span>)</span>
<span id="cb2-321"><a href="#cb2-321"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(outcome_vars, <span class="st">"outcome_vars"</span>)</span>
<span id="cb2-322"><a href="#cb2-322"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(baseline_wave, <span class="st">"baseline_wave"</span>)</span>
<span id="cb2-323"><a href="#cb2-323"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(exposure_waves, <span class="st">"exposure_waves"</span>)</span>
<span id="cb2-324"><a href="#cb2-324"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(outcome_wave, <span class="st">"outcome_wave"</span>)</span>
<span id="cb2-325"><a href="#cb2-325"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(all_waves,<span class="st">"all_waves"</span>)</span>
<span id="cb2-326"><a href="#cb2-326"></a></span>
<span id="cb2-327"><a href="#cb2-327"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"saved names and labels to be used for manuscript  ✔"</span>)</span>
<span id="cb2-328"><a href="#cb2-328"></a></span>
<span id="cb2-329"><a href="#cb2-329"></a></span>
<span id="cb2-330"><a href="#cb2-330"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-331"><a href="#cb2-331"></a><span class="co"># |     </span><span class="re">END</span><span class="co"> DO NOT ALTER     |</span></span>
<span id="cb2-332"><a href="#cb2-332"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-333"><a href="#cb2-333"></a></span>
<span id="cb2-334"><a href="#cb2-334"></a></span>
<span id="cb2-335"><a href="#cb2-335"></a></span>
<span id="cb2-336"><a href="#cb2-336"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-337"><a href="#cb2-337"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb2-338"><a href="#cb2-338"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-339"><a href="#cb2-339"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-340"><a href="#cb2-340"></a><span class="co"># | OPTIONALLY MODIFY SECTION|</span></span>
<span id="cb2-341"><a href="#cb2-341"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-342"><a href="#cb2-342"></a></span>
<span id="cb2-343"><a href="#cb2-343"></a><span class="co"># select eligible participants ----------------------------------------------</span></span>
<span id="cb2-344"><a href="#cb2-344"></a><span class="co"># only include participants who have exposure data at baseline</span></span>
<span id="cb2-345"><a href="#cb2-345"></a></span>
<span id="cb2-346"><a href="#cb2-346"></a><span class="co"># You might require tighter conditions </span></span>
<span id="cb2-347"><a href="#cb2-347"></a><span class="co"># for example, if you are interested in the effects of hours of childcare, </span></span>
<span id="cb2-348"><a href="#cb2-348"></a><span class="co"># you might want to select only those who were parents at baseline. </span></span>
<span id="cb2-349"><a href="#cb2-349"></a><span class="co"># talk to me if you think you might night tighter eligibility criteria.</span></span>
<span id="cb2-350"><a href="#cb2-350"></a></span>
<span id="cb2-351"><a href="#cb2-351"></a>ids_baseline <span class="ot">&lt;-</span> dat_prep <span class="sc">|&gt;</span> </span>
<span id="cb2-352"><a href="#cb2-352"></a>  <span class="co"># allow missing exposure at baseline</span></span>
<span id="cb2-353"><a href="#cb2-353"></a>  <span class="co"># this would give us greater confidence that we generalise to the target population</span></span>
<span id="cb2-354"><a href="#cb2-354"></a>  <span class="co"># filter(wave == baseline_wave) |&gt; </span></span>
<span id="cb2-355"><a href="#cb2-355"></a>  <span class="co"># option: do not allow missing exposure at baseline</span></span>
<span id="cb2-356"><a href="#cb2-356"></a>  <span class="co"># this gives us greater confidence that we recover a incident effect</span></span>
<span id="cb2-357"><a href="#cb2-357"></a>  <span class="fu">filter</span>(wave <span class="sc">==</span> baseline_wave, <span class="sc">!</span><span class="fu">is.na</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_exposure))) <span class="sc">|&gt;</span> </span>
<span id="cb2-358"><a href="#cb2-358"></a>  <span class="fu">pull</span>(id)</span>
<span id="cb2-359"><a href="#cb2-359"></a></span>
<span id="cb2-360"><a href="#cb2-360"></a><span class="co"># n eligible</span></span>
<span id="cb2-361"><a href="#cb2-361"></a>n_participants <span class="ot">&lt;-</span> <span class="fu">length</span>(ids_baseline)</span>
<span id="cb2-362"><a href="#cb2-362"></a></span>
<span id="cb2-363"><a href="#cb2-363"></a><span class="co"># make pretty number</span></span>
<span id="cb2-364"><a href="#cb2-364"></a>n_participants <span class="ot">=</span> margot<span class="sc">::</span><span class="fu">pretty_number</span>(n_participants)</span>
<span id="cb2-365"><a href="#cb2-365"></a></span>
<span id="cb2-366"><a href="#cb2-366"></a><span class="co"># save</span></span>
<span id="cb2-367"><a href="#cb2-367"></a><span class="fu">here_save</span>(n_participants, <span class="st">"n_participants"</span>)</span>
<span id="cb2-368"><a href="#cb2-368"></a></span>
<span id="cb2-369"><a href="#cb2-369"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"set eligibility criteria for baseline cohort ✔"</span>)</span>
<span id="cb2-370"><a href="#cb2-370"></a></span>
<span id="cb2-371"><a href="#cb2-371"></a></span>
<span id="cb2-372"><a href="#cb2-372"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-373"><a href="#cb2-373"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb2-374"><a href="#cb2-374"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-375"><a href="#cb2-375"></a></span>
<span id="cb2-376"><a href="#cb2-376"></a><span class="co"># EXAMPLE count different eligibility conditions ----------------------------------------------</span></span>
<span id="cb2-377"><a href="#cb2-377"></a></span>
<span id="cb2-378"><a href="#cb2-378"></a></span>
<span id="cb2-379"><a href="#cb2-379"></a><span class="co"># define eligibility criteria</span></span>
<span id="cb2-380"><a href="#cb2-380"></a>eligible_ids <span class="ot">&lt;-</span> df_nz_long <span class="sc">|&gt;</span> </span>
<span id="cb2-381"><a href="#cb2-381"></a>  <span class="fu">filter</span>(wave <span class="sc">==</span> <span class="dv">2018</span> <span class="sc">&amp;</span> year_measured <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> age <span class="sc">&lt;</span> <span class="dv">30</span> <span class="sc">&amp;</span> eth_cat <span class="sc">==</span> <span class="st">"pacific"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb2-382"><a href="#cb2-382"></a>  <span class="fu">distinct</span>(id) <span class="sc">|&gt;</span> </span>
<span id="cb2-383"><a href="#cb2-383"></a>  <span class="fu">pull</span>(id)</span>
<span id="cb2-384"><a href="#cb2-384"></a></span>
<span id="cb2-385"><a href="#cb2-385"></a><span class="co"># count eligible ids</span></span>
<span id="cb2-386"><a href="#cb2-386"></a><span class="fu">length</span>(eligible_ids)</span>
<span id="cb2-387"><a href="#cb2-387"></a></span>
<span id="cb2-388"><a href="#cb2-388"></a><span class="co"># filter data to include only eligible participants</span></span>
<span id="cb2-389"><a href="#cb2-389"></a>dat_long_different_eligibility <span class="ot">&lt;-</span> dat_prep <span class="sc">|&gt;</span> </span>
<span id="cb2-390"><a href="#cb2-390"></a>  <span class="fu">filter</span>(id <span class="sc">%in%</span> eligible_ids, wave <span class="sc">%in%</span> all_waves) <span class="sc">|&gt;</span> </span>
<span id="cb2-391"><a href="#cb2-391"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb2-392"><a href="#cb2-392"></a></span>
<span id="cb2-393"><a href="#cb2-393"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-394"><a href="#cb2-394"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb2-395"><a href="#cb2-395"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-396"><a href="#cb2-396"></a></span>
<span id="cb2-397"><a href="#cb2-397"></a><span class="co"># filter using general conditions -----------------------------------------</span></span>
<span id="cb2-398"><a href="#cb2-398"></a></span>
<span id="cb2-399"><a href="#cb2-399"></a></span>
<span id="cb2-400"><a href="#cb2-400"></a><span class="co"># filter data to include only eligible participants and relevant waves</span></span>
<span id="cb2-401"><a href="#cb2-401"></a>dat_long_1 <span class="ot">&lt;-</span> dat_prep <span class="sc">|&gt;</span> </span>
<span id="cb2-402"><a href="#cb2-402"></a>  <span class="fu">filter</span>(id <span class="sc">%in%</span> ids_baseline, wave <span class="sc">%in%</span> all_waves) <span class="sc">|&gt;</span> </span>
<span id="cb2-403"><a href="#cb2-403"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb2-404"><a href="#cb2-404"></a></span>
<span id="cb2-405"><a href="#cb2-405"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-406"><a href="#cb2-406"></a><span class="co"># |</span><span class="re">END</span><span class="co"> OPTIONALLY MODIFY SEC.|</span></span>
<span id="cb2-407"><a href="#cb2-407"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-408"><a href="#cb2-408"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-409"><a href="#cb2-409"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb2-410"><a href="#cb2-410"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-411"><a href="#cb2-411"></a></span>
<span id="cb2-412"><a href="#cb2-412"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-413"><a href="#cb2-413"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb2-414"><a href="#cb2-414"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-415"><a href="#cb2-415"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-416"><a href="#cb2-416"></a><span class="co"># |    MODIFY THIS SECTION   |</span></span>
<span id="cb2-417"><a href="#cb2-417"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-418"><a href="#cb2-418"></a><span class="co"># plot distribution to help with cutpoint decision</span></span>
<span id="cb2-419"><a href="#cb2-419"></a>dat_long_exposure <span class="ot">&lt;-</span> dat_long_1 <span class="sc">|&gt;</span> <span class="fu">filter</span>(wave <span class="sc">%in%</span> exposure_waves)</span>
<span id="cb2-420"><a href="#cb2-420"></a></span>
<span id="cb2-421"><a href="#cb2-421"></a></span>
<span id="cb2-422"><a href="#cb2-422"></a></span>
<span id="cb2-423"><a href="#cb2-423"></a><span class="co"># define cutpoints for graph ----------------------------------------------</span></span>
<span id="cb2-424"><a href="#cb2-424"></a></span>
<span id="cb2-425"><a href="#cb2-425"></a><span class="co"># define cutpoints *-- these can be adjusted --* </span></span>
<span id="cb2-426"><a href="#cb2-426"></a>cut_points <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>)</span>
<span id="cb2-427"><a href="#cb2-427"></a></span>
<span id="cb2-428"><a href="#cb2-428"></a><span class="co"># to use later in positivity graph in manuscript</span></span>
<span id="cb2-429"><a href="#cb2-429"></a>lower_cut <span class="ot">&lt;-</span> cut_points[[<span class="dv">1</span>]]</span>
<span id="cb2-430"><a href="#cb2-430"></a>upper_cut <span class="ot">&lt;-</span> cut_points[[<span class="dv">2</span>]]</span>
<span id="cb2-431"><a href="#cb2-431"></a>threshold <span class="ot">&lt;-</span> <span class="st">'&gt;'</span> <span class="co"># if upper</span></span>
<span id="cb2-432"><a href="#cb2-432"></a>inverse_threshold <span class="ot">&lt;-</span> <span class="st">'&lt;='</span></span>
<span id="cb2-433"><a href="#cb2-433"></a>scale_range <span class="ot">=</span> <span class="st">'scale range 1-7'</span></span>
<span id="cb2-434"><a href="#cb2-434"></a></span>
<span id="cb2-435"><a href="#cb2-435"></a></span>
<span id="cb2-436"><a href="#cb2-436"></a><span class="co"># save for manuscript</span></span>
<span id="cb2-437"><a href="#cb2-437"></a><span class="fu">here_save</span>(lower_cut, <span class="st">"lower_cut"</span>)</span>
<span id="cb2-438"><a href="#cb2-438"></a><span class="fu">here_save</span>(upper_cut, <span class="st">"upper_cut"</span>)</span>
<span id="cb2-439"><a href="#cb2-439"></a><span class="fu">here_save</span>(threshold, <span class="st">"threshold"</span>)</span>
<span id="cb2-440"><a href="#cb2-440"></a><span class="fu">here_save</span>(inverse_threshold, <span class="st">"inverse_threshold"</span>)</span>
<span id="cb2-441"><a href="#cb2-441"></a><span class="fu">here_save</span>(scale_range, <span class="st">"scale_range"</span>)</span>
<span id="cb2-442"><a href="#cb2-442"></a></span>
<span id="cb2-443"><a href="#cb2-443"></a></span>
<span id="cb2-444"><a href="#cb2-444"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"set thresholds for binary variable (if variable is continuous) ✔"</span>)</span>
<span id="cb2-445"><a href="#cb2-445"></a></span>
<span id="cb2-446"><a href="#cb2-446"></a></span>
<span id="cb2-447"><a href="#cb2-447"></a><span class="co"># make graph</span></span>
<span id="cb2-448"><a href="#cb2-448"></a>graph_cut <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_plot_categorical</span>(</span>
<span id="cb2-449"><a href="#cb2-449"></a>  dat_long_exposure,</span>
<span id="cb2-450"><a href="#cb2-450"></a>  <span class="at">col_name         =</span> name_exposure,</span>
<span id="cb2-451"><a href="#cb2-451"></a>  <span class="at">sd_multipliers =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>), <span class="co"># select to suit</span></span>
<span id="cb2-452"><a href="#cb2-452"></a>  <span class="co"># either use n_divisions for equal-sized groups:</span></span>
<span id="cb2-453"><a href="#cb2-453"></a>  <span class="co"># n_divisions      = 2,</span></span>
<span id="cb2-454"><a href="#cb2-454"></a>  <span class="co"># or use custom_breaks for specific values:</span></span>
<span id="cb2-455"><a href="#cb2-455"></a>  <span class="at">custom_breaks    =</span> cut_points,  <span class="co"># ** adjust as needed **</span></span>
<span id="cb2-456"><a href="#cb2-456"></a>  <span class="co"># could be "lower", no difference in this case, as no one == 4</span></span>
<span id="cb2-457"><a href="#cb2-457"></a>  <span class="at">cutpoint_inclusive =</span> <span class="st">"upper"</span>,</span>
<span id="cb2-458"><a href="#cb2-458"></a>  <span class="at">show_mean        =</span> <span class="cn">TRUE</span>,</span>
<span id="cb2-459"><a href="#cb2-459"></a>  <span class="at">show_median      =</span> <span class="cn">FALSE</span>,</span>
<span id="cb2-460"><a href="#cb2-460"></a>  <span class="at">show_sd          =</span> <span class="cn">TRUE</span></span>
<span id="cb2-461"><a href="#cb2-461"></a>)</span>
<span id="cb2-462"><a href="#cb2-462"></a><span class="fu">print</span>(graph_cut)</span>
<span id="cb2-463"><a href="#cb2-463"></a></span>
<span id="cb2-464"><a href="#cb2-464"></a><span class="co"># save your graph</span></span>
<span id="cb2-465"><a href="#cb2-465"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(graph_cut, <span class="st">"graph_cut"</span>, push_mods)</span>
<span id="cb2-466"><a href="#cb2-466"></a></span>
<span id="cb2-467"><a href="#cb2-467"></a><span class="co"># create binary exposure variable based on chosen cutpoint</span></span>
<span id="cb2-468"><a href="#cb2-468"></a>dat_long_2 <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">create_ordered_variable</span>(</span>
<span id="cb2-469"><a href="#cb2-469"></a>  dat_long_1,</span>
<span id="cb2-470"><a href="#cb2-470"></a>  <span class="at">var_name           =</span> name_exposure,</span>
<span id="cb2-471"><a href="#cb2-471"></a>  <span class="at">custom_breaks      =</span> cut_points,  <span class="co"># ** -- adjust based on your decision above -- **</span></span>
<span id="cb2-472"><a href="#cb2-472"></a>  <span class="at">cutpoint_inclusive =</span> <span class="st">"upper"</span></span>
<span id="cb2-473"><a href="#cb2-473"></a>)</span>
<span id="cb2-474"><a href="#cb2-474"></a></span>
<span id="cb2-475"><a href="#cb2-475"></a></span>
<span id="cb2-476"><a href="#cb2-476"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"created binary variable (if variable is continuous) ✔"</span>)</span>
<span id="cb2-477"><a href="#cb2-477"></a></span>
<span id="cb2-478"><a href="#cb2-478"></a></span>
<span id="cb2-479"><a href="#cb2-479"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-480"><a href="#cb2-480"></a><span class="co"># |   </span><span class="re">END</span><span class="co"> MODIFY SECTION     |</span></span>
<span id="cb2-481"><a href="#cb2-481"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-482"><a href="#cb2-482"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-483"><a href="#cb2-483"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb2-484"><a href="#cb2-484"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-485"><a href="#cb2-485"></a></span>
<span id="cb2-486"><a href="#cb2-486"></a></span>
<span id="cb2-487"><a href="#cb2-487"></a></span>
<span id="cb2-488"><a href="#cb2-488"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-489"><a href="#cb2-489"></a><span class="co"># |       DO NOT ALTER       |</span></span>
<span id="cb2-490"><a href="#cb2-490"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-491"><a href="#cb2-491"></a></span>
<span id="cb2-492"><a href="#cb2-492"></a><span class="co"># process binary variables and log-transform --------------------------------</span></span>
<span id="cb2-493"><a href="#cb2-493"></a><span class="co"># convert binary factors to 0/1 format</span></span>
<span id="cb2-494"><a href="#cb2-494"></a>dat_long_3 <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_process_binary_vars</span>(dat_long_2)</span>
<span id="cb2-495"><a href="#cb2-495"></a></span>
<span id="cb2-496"><a href="#cb2-496"></a><span class="co"># log-transform hours and income variables: tables for analysis (only logged versions of vars)</span></span>
<span id="cb2-497"><a href="#cb2-497"></a>dat_long_final <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_log_transform_vars</span>(</span>
<span id="cb2-498"><a href="#cb2-498"></a>  dat_long_3,</span>
<span id="cb2-499"><a href="#cb2-499"></a>  <span class="at">vars            =</span> <span class="fu">c</span>(<span class="fu">starts_with</span>(<span class="st">"hours_"</span>), <span class="st">"household_inc"</span>), <span class="co"># **--- think about this ---***</span></span>
<span id="cb2-500"><a href="#cb2-500"></a>  <span class="at">prefix          =</span> <span class="st">"log_"</span>,</span>
<span id="cb2-501"><a href="#cb2-501"></a>  <span class="at">keep_original   =</span> <span class="cn">FALSE</span>,</span>
<span id="cb2-502"><a href="#cb2-502"></a>  <span class="at">exceptions =</span> exposure_var <span class="co"># omit original variables#  **--- think about this ---***</span></span>
<span id="cb2-503"><a href="#cb2-503"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb2-504"><a href="#cb2-504"></a>  <span class="co"># select only variables needed for analysis</span></span>
<span id="cb2-505"><a href="#cb2-505"></a>  <span class="fu">select</span>(<span class="fu">all_of</span>(<span class="fu">c</span>(baseline_vars, exposure_var, outcome_vars, <span class="st">"id"</span>, <span class="st">"wave"</span>, <span class="st">"year_measured"</span>, <span class="st">"sample_weights"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb2-506"><a href="#cb2-506"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb2-507"><a href="#cb2-507"></a></span>
<span id="cb2-508"><a href="#cb2-508"></a></span>
<span id="cb2-509"><a href="#cb2-509"></a></span>
<span id="cb2-510"><a href="#cb2-510"></a><span class="co"># check missing data --------------------------------------------------------</span></span>
<span id="cb2-511"><a href="#cb2-511"></a><span class="co"># this is crucial to understand potential biases</span></span>
<span id="cb2-512"><a href="#cb2-512"></a>missing_summary <span class="ot">&lt;-</span> naniar<span class="sc">::</span><span class="fu">miss_var_summary</span>(dat_long_final)</span>
<span id="cb2-513"><a href="#cb2-513"></a><span class="fu">print</span>(missing_summary)</span>
<span id="cb2-514"><a href="#cb2-514"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(missing_summary, <span class="st">"missing_summary"</span>, push_mods)</span>
<span id="cb2-515"><a href="#cb2-515"></a></span>
<span id="cb2-516"><a href="#cb2-516"></a></span>
<span id="cb2-517"><a href="#cb2-517"></a></span>
<span id="cb2-518"><a href="#cb2-518"></a><span class="co"># visualise missing data pattern</span></span>
<span id="cb2-519"><a href="#cb2-519"></a><span class="co"># ** -- takes a while to render ** </span></span>
<span id="cb2-520"><a href="#cb2-520"></a>vis_miss <span class="ot">&lt;-</span> naniar<span class="sc">::</span><span class="fu">vis_miss</span>(dat_long_final, <span class="at">warn_large_data =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-521"><a href="#cb2-521"></a><span class="fu">print</span>(vis_miss)</span>
<span id="cb2-522"><a href="#cb2-522"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(vis_miss, <span class="st">"vis_miss"</span>, push_mods)</span>
<span id="cb2-523"><a href="#cb2-523"></a></span>
<span id="cb2-524"><a href="#cb2-524"></a><span class="co"># calculate percentage of missing data at baseline</span></span>
<span id="cb2-525"><a href="#cb2-525"></a>dat_baseline_pct <span class="ot">&lt;-</span> dat_long_final <span class="sc">|&gt;</span> <span class="fu">filter</span>(wave <span class="sc">==</span> baseline_wave)</span>
<span id="cb2-526"><a href="#cb2-526"></a>percent_missing_baseline <span class="ot">&lt;-</span> naniar<span class="sc">::</span><span class="fu">pct_miss</span>(dat_baseline_pct)</span>
<span id="cb2-527"><a href="#cb2-527"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(percent_missing_baseline, <span class="st">"percent_missing_baseline"</span>, push_mods)</span>
<span id="cb2-528"><a href="#cb2-528"></a></span>
<span id="cb2-529"><a href="#cb2-529"></a><span class="co"># save prepared dataset for next stage --------------------------------------</span></span>
<span id="cb2-530"><a href="#cb2-530"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(dat_long_final, <span class="st">"dat_long_final"</span>, push_mods)</span>
<span id="cb2-531"><a href="#cb2-531"></a></span>
<span id="cb2-532"><a href="#cb2-532"></a></span>
<span id="cb2-533"><a href="#cb2-533"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"made and saved final long data set for further processign in script 02 ✔"</span>)</span>
<span id="cb2-534"><a href="#cb2-534"></a></span>
<span id="cb2-535"><a href="#cb2-535"></a></span>
<span id="cb2-536"><a href="#cb2-536"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-537"><a href="#cb2-537"></a><span class="co"># |     </span><span class="re">END</span><span class="co"> DO NOT ALTER     |</span></span>
<span id="cb2-538"><a href="#cb2-538"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-539"><a href="#cb2-539"></a></span>
<span id="cb2-540"><a href="#cb2-540"></a></span>
<span id="cb2-541"><a href="#cb2-541"></a><span class="co"># check positivity --------------------------------------------------------</span></span>
<span id="cb2-542"><a href="#cb2-542"></a></span>
<span id="cb2-543"><a href="#cb2-543"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-544"><a href="#cb2-544"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb2-545"><a href="#cb2-545"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-546"><a href="#cb2-546"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-547"><a href="#cb2-547"></a><span class="co"># |    MODIFY THIS SECTION   |</span></span>
<span id="cb2-548"><a href="#cb2-548"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-549"><a href="#cb2-549"></a></span>
<span id="cb2-550"><a href="#cb2-550"></a></span>
<span id="cb2-551"><a href="#cb2-551"></a><span class="co"># check</span></span>
<span id="cb2-552"><a href="#cb2-552"></a>threshold <span class="co"># defined above</span></span>
<span id="cb2-553"><a href="#cb2-553"></a>upper_cut <span class="co"># defined above</span></span>
<span id="cb2-554"><a href="#cb2-554"></a>name_exposure <span class="co"># defined above</span></span>
<span id="cb2-555"><a href="#cb2-555"></a></span>
<span id="cb2-556"><a href="#cb2-556"></a></span>
<span id="cb2-557"><a href="#cb2-557"></a><span class="co"># create transition matrices to check positivity ----------------------------</span></span>
<span id="cb2-558"><a href="#cb2-558"></a><span class="co"># this helps assess whether there are sufficient observations in all exposure states</span></span>
<span id="cb2-559"><a href="#cb2-559"></a>dt_positivity <span class="ot">&lt;-</span> dat_long_final <span class="sc">|&gt;</span></span>
<span id="cb2-560"><a href="#cb2-560"></a>  <span class="fu">filter</span>(wave <span class="sc">%in%</span> <span class="fu">c</span>(baseline_wave, exposure_waves)) <span class="sc">|&gt;</span></span>
<span id="cb2-561"><a href="#cb2-561"></a>  <span class="fu">select</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_exposure), id, wave) <span class="sc">|&gt;</span></span>
<span id="cb2-562"><a href="#cb2-562"></a>  <span class="fu">mutate</span>(<span class="at">exposure =</span> <span class="fu">round</span>(<span class="fu">as.numeric</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_exposure)), <span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb2-563"><a href="#cb2-563"></a>  <span class="co"># create binary exposure based on cutpoint</span></span>
<span id="cb2-564"><a href="#cb2-564"></a>  <span class="fu">mutate</span>(<span class="at">exposure_binary =</span> <span class="fu">ifelse</span>(exposure <span class="sc">&gt;</span> upper_cut, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">|&gt;</span> <span class="co"># check</span></span>
<span id="cb2-565"><a href="#cb2-565"></a>  <span class="do">## *-- modify this --* </span></span>
<span id="cb2-566"><a href="#cb2-566"></a>  <span class="fu">mutate</span>(<span class="at">wave =</span> <span class="fu">as.numeric</span>(wave) <span class="sc">-</span><span class="dv">1</span> )</span>
<span id="cb2-567"><a href="#cb2-567"></a></span>
<span id="cb2-568"><a href="#cb2-568"></a><span class="co"># create transition tables</span></span>
<span id="cb2-569"><a href="#cb2-569"></a>transition_tables <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_transition_table</span>(</span>
<span id="cb2-570"><a href="#cb2-570"></a>  dt_positivity,</span>
<span id="cb2-571"><a href="#cb2-571"></a>  <span class="at">state_var =</span> <span class="st">"exposure"</span>,</span>
<span id="cb2-572"><a href="#cb2-572"></a>  <span class="at">id_var =</span> <span class="st">"id"</span>,</span>
<span id="cb2-573"><a href="#cb2-573"></a>  <span class="at">waves =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb2-574"><a href="#cb2-574"></a>  <span class="at">wave_var =</span> <span class="st">"wave"</span>,</span>
<span id="cb2-575"><a href="#cb2-575"></a>  <span class="at">table_name =</span> <span class="st">"transition_table"</span></span>
<span id="cb2-576"><a href="#cb2-576"></a>)</span>
<span id="cb2-577"><a href="#cb2-577"></a></span>
<span id="cb2-578"><a href="#cb2-578"></a><span class="co"># check</span></span>
<span id="cb2-579"><a href="#cb2-579"></a><span class="fu">print</span>(transition_tables<span class="sc">$</span>tables[[<span class="dv">1</span>]])</span>
<span id="cb2-580"><a href="#cb2-580"></a></span>
<span id="cb2-581"><a href="#cb2-581"></a><span class="co"># save</span></span>
<span id="cb2-582"><a href="#cb2-582"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(transition_tables, <span class="st">"transition_tables"</span>, push_mods)</span>
<span id="cb2-583"><a href="#cb2-583"></a></span>
<span id="cb2-584"><a href="#cb2-584"></a><span class="co"># create binary transition tables</span></span>
<span id="cb2-585"><a href="#cb2-585"></a>transition_tables_binary <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_transition_table</span>(</span>
<span id="cb2-586"><a href="#cb2-586"></a>  dt_positivity,</span>
<span id="cb2-587"><a href="#cb2-587"></a>  <span class="at">state_var =</span> <span class="st">"exposure_binary"</span>,</span>
<span id="cb2-588"><a href="#cb2-588"></a>  <span class="at">id_var =</span> <span class="st">"id"</span>,</span>
<span id="cb2-589"><a href="#cb2-589"></a>  <span class="at">waves =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb2-590"><a href="#cb2-590"></a>  <span class="at">wave_var =</span> <span class="st">"wave"</span>,</span>
<span id="cb2-591"><a href="#cb2-591"></a>  <span class="at">table_name =</span> <span class="st">"transition_table_binary"</span></span>
<span id="cb2-592"><a href="#cb2-592"></a>)</span>
<span id="cb2-593"><a href="#cb2-593"></a></span>
<span id="cb2-594"><a href="#cb2-594"></a><span class="co"># check</span></span>
<span id="cb2-595"><a href="#cb2-595"></a><span class="fu">print</span>(transition_tables_binary<span class="sc">$</span>tables[[<span class="dv">1</span>]])</span>
<span id="cb2-596"><a href="#cb2-596"></a></span>
<span id="cb2-597"><a href="#cb2-597"></a><span class="co"># save</span></span>
<span id="cb2-598"><a href="#cb2-598"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(transition_tables_binary, <span class="st">"transition_tables_binary"</span>, push_mods)</span>
<span id="cb2-599"><a href="#cb2-599"></a></span>
<span id="cb2-600"><a href="#cb2-600"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-601"><a href="#cb2-601"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb2-602"><a href="#cb2-602"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-603"><a href="#cb2-603"></a></span>
<span id="cb2-604"><a href="#cb2-604"></a><span class="co"># create tables -----------------------------------------------------------</span></span>
<span id="cb2-605"><a href="#cb2-605"></a><span class="co"># baseline variable labels</span></span>
<span id="cb2-606"><a href="#cb2-606"></a>var_labels_baseline <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb2-607"><a href="#cb2-607"></a>  <span class="co"># demographics</span></span>
<span id="cb2-608"><a href="#cb2-608"></a>  <span class="st">"age"</span> <span class="ot">=</span> <span class="st">"Age"</span>,</span>
<span id="cb2-609"><a href="#cb2-609"></a>  <span class="st">"born_nz_binary"</span> <span class="ot">=</span> <span class="st">"Born in NZ"</span>,</span>
<span id="cb2-610"><a href="#cb2-610"></a>  <span class="st">"education_level_coarsen"</span> <span class="ot">=</span> <span class="st">"Education Level"</span>,</span>
<span id="cb2-611"><a href="#cb2-611"></a>  <span class="st">"employed_binary"</span> <span class="ot">=</span> <span class="st">"Employed"</span>,</span>
<span id="cb2-612"><a href="#cb2-612"></a>  <span class="st">"eth_cat"</span> <span class="ot">=</span> <span class="st">"Ethnicity"</span>,</span>
<span id="cb2-613"><a href="#cb2-613"></a>  <span class="st">"male_binary"</span> <span class="ot">=</span> <span class="st">"Male"</span>,</span>
<span id="cb2-614"><a href="#cb2-614"></a>  <span class="st">"not_heterosexual_binary"</span> <span class="ot">=</span> <span class="st">"Non-heterosexual"</span>,</span>
<span id="cb2-615"><a href="#cb2-615"></a>  <span class="st">"parent_binary"</span> <span class="ot">=</span> <span class="st">"Parent"</span>,</span>
<span id="cb2-616"><a href="#cb2-616"></a>  <span class="st">"partner_binary"</span> <span class="ot">=</span> <span class="st">"Has Partner"</span>,</span>
<span id="cb2-617"><a href="#cb2-617"></a>  <span class="st">"rural_gch_2018_l"</span> <span class="ot">=</span> <span class="st">"Rural Classification"</span>,</span>
<span id="cb2-618"><a href="#cb2-618"></a>  <span class="st">"sample_frame_opt_in_binary"</span> <span class="ot">=</span> <span class="st">"Sample Frame Opt-In"</span>,</span>
<span id="cb2-619"><a href="#cb2-619"></a>  </span>
<span id="cb2-620"><a href="#cb2-620"></a>  <span class="co"># economic &amp; social status</span></span>
<span id="cb2-621"><a href="#cb2-621"></a>  <span class="st">"household_inc"</span> <span class="ot">=</span> <span class="st">"Household Income"</span>,</span>
<span id="cb2-622"><a href="#cb2-622"></a>  <span class="st">"log_household_inc"</span> <span class="ot">=</span> <span class="st">"Log Household Income"</span>,</span>
<span id="cb2-623"><a href="#cb2-623"></a>  <span class="st">"nz_dep2018"</span> <span class="ot">=</span> <span class="st">"NZ Deprivation Index"</span>,</span>
<span id="cb2-624"><a href="#cb2-624"></a>  <span class="st">"nzsei_13_l"</span> <span class="ot">=</span> <span class="st">"Occupational Prestige Index"</span>,</span>
<span id="cb2-625"><a href="#cb2-625"></a>  <span class="st">"household_inc"</span> <span class="ot">=</span> <span class="st">"Household Income"</span>,</span>
<span id="cb2-626"><a href="#cb2-626"></a></span>
<span id="cb2-627"><a href="#cb2-627"></a>  </span>
<span id="cb2-628"><a href="#cb2-628"></a>  <span class="co"># personality traits</span></span>
<span id="cb2-629"><a href="#cb2-629"></a>  <span class="st">"agreeableness"</span> <span class="ot">=</span> <span class="st">"Agreeableness"</span>,</span>
<span id="cb2-630"><a href="#cb2-630"></a>  <span class="st">"conscientiousness"</span> <span class="ot">=</span> <span class="st">"Conscientiousness"</span>,</span>
<span id="cb2-631"><a href="#cb2-631"></a>  <span class="st">"neuroticism"</span> <span class="ot">=</span> <span class="st">"Neuroticism"</span>,</span>
<span id="cb2-632"><a href="#cb2-632"></a>  <span class="st">"openness"</span> <span class="ot">=</span> <span class="st">"Openness"</span>,</span>
<span id="cb2-633"><a href="#cb2-633"></a>  </span>
<span id="cb2-634"><a href="#cb2-634"></a>  <span class="co"># beliefs &amp; attitudes</span></span>
<span id="cb2-635"><a href="#cb2-635"></a>  <span class="st">"political_conservative"</span> <span class="ot">=</span> <span class="st">"Political Conservatism"</span>,</span>
<span id="cb2-636"><a href="#cb2-636"></a>  <span class="st">"religion_identification_level"</span> <span class="ot">=</span> <span class="st">"Religious Identification"</span>,</span>
<span id="cb2-637"><a href="#cb2-637"></a>  </span>
<span id="cb2-638"><a href="#cb2-638"></a>  <span class="co"># health behaviors</span></span>
<span id="cb2-639"><a href="#cb2-639"></a>  <span class="st">"alcohol_frequency"</span> <span class="ot">=</span> <span class="st">"Alcohol Frequency"</span>,</span>
<span id="cb2-640"><a href="#cb2-640"></a>  <span class="st">"alcohol_intensity"</span> <span class="ot">=</span> <span class="st">"Alcohol Intensity"</span>,</span>
<span id="cb2-641"><a href="#cb2-641"></a>  <span class="st">"hlth_disability_binary"</span> <span class="ot">=</span> <span class="st">"Disability Status"</span>,</span>
<span id="cb2-642"><a href="#cb2-642"></a>  <span class="st">"smoker_binary"</span> <span class="ot">=</span> <span class="st">"Smoker"</span>,</span>
<span id="cb2-643"><a href="#cb2-643"></a>  <span class="st">"hours_exercise"</span> <span class="ot">=</span> <span class="st">"Hours of Exercise"</span>,</span>
<span id="cb2-644"><a href="#cb2-644"></a>  </span>
<span id="cb2-645"><a href="#cb2-645"></a>  </span>
<span id="cb2-646"><a href="#cb2-646"></a>  <span class="co"># time use</span></span>
<span id="cb2-647"><a href="#cb2-647"></a>  <span class="st">"hours_children"</span> <span class="ot">=</span> <span class="st">"Hours with Children"</span>,</span>
<span id="cb2-648"><a href="#cb2-648"></a>  <span class="st">"hours_commute"</span> <span class="ot">=</span> <span class="st">"Hours Commuting"</span>,</span>
<span id="cb2-649"><a href="#cb2-649"></a>  <span class="st">"hours_exercise"</span> <span class="ot">=</span> <span class="st">"Hours Exercising"</span>,</span>
<span id="cb2-650"><a href="#cb2-650"></a>  <span class="st">"hours_housework"</span> <span class="ot">=</span> <span class="st">"Hours on Housework"</span>,</span>
<span id="cb2-651"><a href="#cb2-651"></a>  <span class="st">"log_hours_children"</span> <span class="ot">=</span> <span class="st">"Log Hours with Children"</span>,</span>
<span id="cb2-652"><a href="#cb2-652"></a>  <span class="st">"log_hours_commute"</span> <span class="ot">=</span> <span class="st">"Log Hours Commuting"</span>,</span>
<span id="cb2-653"><a href="#cb2-653"></a>  <span class="st">"log_hours_exercise"</span> <span class="ot">=</span> <span class="st">"Log Hours Exercising"</span>,</span>
<span id="cb2-654"><a href="#cb2-654"></a>  <span class="st">"log_hours_housework"</span> <span class="ot">=</span> <span class="st">"Log Hours on Housework"</span></span>
<span id="cb2-655"><a href="#cb2-655"></a>)</span>
<span id="cb2-656"><a href="#cb2-656"></a><span class="fu">here_save</span>(var_labels_baseline, <span class="st">"var_labels_baseline"</span>)</span>
<span id="cb2-657"><a href="#cb2-657"></a></span>
<span id="cb2-658"><a href="#cb2-658"></a><span class="co"># outcome variable labels, organized by domain</span></span>
<span id="cb2-659"><a href="#cb2-659"></a><span class="co"># reivew your outcomes make sure they appear on the list below</span></span>
<span id="cb2-660"><a href="#cb2-660"></a><span class="co"># comment out what you do not need</span></span>
<span id="cb2-661"><a href="#cb2-661"></a>outcome_vars</span>
<span id="cb2-662"><a href="#cb2-662"></a></span>
<span id="cb2-663"><a href="#cb2-663"></a><span class="co"># get names</span></span>
<span id="cb2-664"><a href="#cb2-664"></a>var_labels_outcomes <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb2-665"><a href="#cb2-665"></a>  <span class="co"># "alcohol_frequency_weekly" = "Alcohol Frequency (weekly)",</span></span>
<span id="cb2-666"><a href="#cb2-666"></a>  <span class="co"># "alcohol_intensity" = "Alcohol Intensity",</span></span>
<span id="cb2-667"><a href="#cb2-667"></a>  <span class="co"># "hlth_bmi" = "Body Mass Index",</span></span>
<span id="cb2-668"><a href="#cb2-668"></a>  <span class="co"># "hlth_sleep_hours" = "Sleep",</span></span>
<span id="cb2-669"><a href="#cb2-669"></a>  <span class="st">"log_hours_exercise"</span> <span class="ot">=</span> <span class="st">"Hours of Exercise (log)"</span>,</span>
<span id="cb2-670"><a href="#cb2-670"></a> <span class="co"># "short_form_health" = "Short Form Health",</span></span>
<span id="cb2-671"><a href="#cb2-671"></a>  <span class="st">"hlth_fatigue"</span> <span class="ot">=</span> <span class="st">"Fatigue"</span>,</span>
<span id="cb2-672"><a href="#cb2-672"></a>  <span class="st">"kessler_latent_anxiety"</span> <span class="ot">=</span> <span class="st">"Anxiety"</span>,</span>
<span id="cb2-673"><a href="#cb2-673"></a>  <span class="st">"kessler_latent_depression"</span> <span class="ot">=</span> <span class="st">"Depression"</span>,</span>
<span id="cb2-674"><a href="#cb2-674"></a> <span class="co"># "rumination" = "Rumination",</span></span>
<span id="cb2-675"><a href="#cb2-675"></a>  <span class="st">"bodysat"</span> <span class="ot">=</span> <span class="st">"Body Satisfaction"</span>,</span>
<span id="cb2-676"><a href="#cb2-676"></a> <span class="co"># "forgiveness" = "Forgiveness",</span></span>
<span id="cb2-677"><a href="#cb2-677"></a> <span class="co"># "perfectionism" = "Perfectionism",</span></span>
<span id="cb2-678"><a href="#cb2-678"></a> <span class="co"># "self_control" = "Self Control",</span></span>
<span id="cb2-679"><a href="#cb2-679"></a>  <span class="st">"self_esteem"</span> <span class="ot">=</span> <span class="st">"Self Esteem"</span>,</span>
<span id="cb2-680"><a href="#cb2-680"></a>  <span class="st">"sexual_satisfaction"</span> <span class="ot">=</span> <span class="st">"Sexual Satisfaction"</span>,</span>
<span id="cb2-681"><a href="#cb2-681"></a> <span class="co"># "gratitude" = "Gratitude",</span></span>
<span id="cb2-682"><a href="#cb2-682"></a>  <span class="st">"lifesat"</span> <span class="ot">=</span> <span class="st">"Life Satisfaction"</span>,</span>
<span id="cb2-683"><a href="#cb2-683"></a>  <span class="st">"meaning_purpose"</span> <span class="ot">=</span> <span class="st">"Meaning: Purpose"</span>,</span>
<span id="cb2-684"><a href="#cb2-684"></a>  <span class="st">"meaning_sense"</span> <span class="ot">=</span> <span class="st">"Meaning: Sense"</span>,</span>
<span id="cb2-685"><a href="#cb2-685"></a>  <span class="st">"pwi"</span> <span class="ot">=</span> <span class="st">"Personal Well-being Index"</span>,</span>
<span id="cb2-686"><a href="#cb2-686"></a>  <span class="st">"belong"</span> <span class="ot">=</span> <span class="st">"Social Belonging"</span>,</span>
<span id="cb2-687"><a href="#cb2-687"></a>  <span class="st">"neighbourhood_community"</span> <span class="ot">=</span> <span class="st">"Neighbourhood Community"</span>,</span>
<span id="cb2-688"><a href="#cb2-688"></a>  <span class="st">"support"</span> <span class="ot">=</span> <span class="st">"Social Support"</span></span>
<span id="cb2-689"><a href="#cb2-689"></a>)</span>
<span id="cb2-690"><a href="#cb2-690"></a></span>
<span id="cb2-691"><a href="#cb2-691"></a><span class="co"># save for manuscript</span></span>
<span id="cb2-692"><a href="#cb2-692"></a><span class="fu">here_save</span>(var_labels_outcomes, <span class="st">"var_labels_outcomes"</span>)</span>
<span id="cb2-693"><a href="#cb2-693"></a></span>
<span id="cb2-694"><a href="#cb2-694"></a></span>
<span id="cb2-695"><a href="#cb2-695"></a></span>
<span id="cb2-696"><a href="#cb2-696"></a></span>
<span id="cb2-697"><a href="#cb2-697"></a><span class="co"># save all variable translations</span></span>
<span id="cb2-698"><a href="#cb2-698"></a>var_labels_measures <span class="ot">&lt;-</span> <span class="fu">c</span>(var_labels_baseline, var_labels_exposure, var_labels_outcomes)</span>
<span id="cb2-699"><a href="#cb2-699"></a>var_labels_measures</span>
<span id="cb2-700"><a href="#cb2-700"></a></span>
<span id="cb2-701"><a href="#cb2-701"></a><span class="co"># save for manuscript</span></span>
<span id="cb2-702"><a href="#cb2-702"></a><span class="fu">here_save</span>(var_labels_measures, <span class="st">"var_labels_measures"</span>)</span>
<span id="cb2-703"><a href="#cb2-703"></a></span>
<span id="cb2-704"><a href="#cb2-704"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-705"><a href="#cb2-705"></a><span class="co"># |   </span><span class="re">END</span><span class="co"> MODIFY SECTION     |</span></span>
<span id="cb2-706"><a href="#cb2-706"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-707"><a href="#cb2-707"></a></span>
<span id="cb2-708"><a href="#cb2-708"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-709"><a href="#cb2-709"></a><span class="co"># |       DO NOT ALTER       |</span></span>
<span id="cb2-710"><a href="#cb2-710"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-711"><a href="#cb2-711"></a><span class="co"># tables ------------------------------------------------------------------</span></span>
<span id="cb2-712"><a href="#cb2-712"></a><span class="co"># create baseline characteristics table</span></span>
<span id="cb2-713"><a href="#cb2-713"></a>dat_baseline <span class="ot">=</span> dat_long_final <span class="sc">|&gt;</span></span>
<span id="cb2-714"><a href="#cb2-714"></a>  <span class="fu">filter</span>(wave <span class="sc">%in%</span> <span class="fu">c</span>(baseline_wave)) <span class="sc">|&gt;</span></span>
<span id="cb2-715"><a href="#cb2-715"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-716"><a href="#cb2-716"></a>    <span class="at">male_binary =</span> <span class="fu">factor</span>(male_binary),</span>
<span id="cb2-717"><a href="#cb2-717"></a>    <span class="at">parent_binary =</span> <span class="fu">factor</span>(parent_binary),</span>
<span id="cb2-718"><a href="#cb2-718"></a>    <span class="at">smoker_binary =</span> <span class="fu">factor</span>(smoker_binary),</span>
<span id="cb2-719"><a href="#cb2-719"></a>    <span class="at">born_nz_binary =</span> <span class="fu">factor</span>(born_nz_binary),</span>
<span id="cb2-720"><a href="#cb2-720"></a>    <span class="at">employed_binary =</span> <span class="fu">factor</span>(employed_binary),</span>
<span id="cb2-721"><a href="#cb2-721"></a>    <span class="at">not_heterosexual_binary =</span> <span class="fu">factor</span>(not_heterosexual_binary),</span>
<span id="cb2-722"><a href="#cb2-722"></a>    <span class="at">sample_frame_opt_in_binary =</span> <span class="fu">factor</span>(sample_frame_opt_in_binary)</span>
<span id="cb2-723"><a href="#cb2-723"></a>  )</span>
<span id="cb2-724"><a href="#cb2-724"></a></span>
<span id="cb2-725"><a href="#cb2-725"></a></span>
<span id="cb2-726"><a href="#cb2-726"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-727"><a href="#cb2-727"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb2-728"><a href="#cb2-728"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-729"><a href="#cb2-729"></a></span>
<span id="cb2-730"><a href="#cb2-730"></a><span class="co"># save sample weights from baseline wave</span></span>
<span id="cb2-731"><a href="#cb2-731"></a><span class="co"># save sample weights</span></span>
<span id="cb2-732"><a href="#cb2-732"></a>t0_sample_weights <span class="ot">&lt;-</span> dat_baseline<span class="sc">$</span>sample_weights</span>
<span id="cb2-733"><a href="#cb2-733"></a><span class="fu">here_save</span>(t0_sample_weights, <span class="st">"t0_sample_weights"</span>)</span>
<span id="cb2-734"><a href="#cb2-734"></a></span>
<span id="cb2-735"><a href="#cb2-735"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-736"><a href="#cb2-736"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb2-737"><a href="#cb2-737"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-738"><a href="#cb2-738"></a></span>
<span id="cb2-739"><a href="#cb2-739"></a></span>
<span id="cb2-740"><a href="#cb2-740"></a><span class="co"># make baseline table -----------------------------------------------------</span></span>
<span id="cb2-741"><a href="#cb2-741"></a></span>
<span id="cb2-742"><a href="#cb2-742"></a>baseline_table <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_make_tables</span>(</span>
<span id="cb2-743"><a href="#cb2-743"></a>  <span class="at">data =</span> dat_baseline,</span>
<span id="cb2-744"><a href="#cb2-744"></a>  <span class="at">vars =</span> baseline_vars,</span>
<span id="cb2-745"><a href="#cb2-745"></a>  <span class="at">by =</span> <span class="st">"wave"</span>,</span>
<span id="cb2-746"><a href="#cb2-746"></a>  <span class="at">labels =</span> var_labels_baseline,</span>
<span id="cb2-747"><a href="#cb2-747"></a>  <span class="at">table1_opts =</span> <span class="fu">list</span>(<span class="at">overall =</span> <span class="cn">FALSE</span>, <span class="at">transpose =</span> <span class="cn">FALSE</span>),</span>
<span id="cb2-748"><a href="#cb2-748"></a>  <span class="at">format =</span> <span class="st">"markdown"</span></span>
<span id="cb2-749"><a href="#cb2-749"></a>)</span>
<span id="cb2-750"><a href="#cb2-750"></a><span class="fu">print</span>(baseline_table)</span>
<span id="cb2-751"><a href="#cb2-751"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(baseline_table, <span class="st">"baseline_table"</span>, push_mods)</span>
<span id="cb2-752"><a href="#cb2-752"></a></span>
<span id="cb2-753"><a href="#cb2-753"></a><span class="co"># create exposure table by wave</span></span>
<span id="cb2-754"><a href="#cb2-754"></a>exposure_table <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_make_tables</span>(</span>
<span id="cb2-755"><a href="#cb2-755"></a>  <span class="at">data =</span> dat_long_final <span class="sc">|&gt;</span> <span class="fu">filter</span>(wave <span class="sc">%in%</span> <span class="fu">c</span>(baseline_wave, exposure_waves)),</span>
<span id="cb2-756"><a href="#cb2-756"></a>  <span class="at">vars =</span> exposure_var,</span>
<span id="cb2-757"><a href="#cb2-757"></a>  <span class="at">by =</span> <span class="st">"wave"</span>,</span>
<span id="cb2-758"><a href="#cb2-758"></a>  <span class="at">labels =</span> var_labels_exposure,</span>
<span id="cb2-759"><a href="#cb2-759"></a>  <span class="at">factor_vars =</span> exposure_var_binary,</span>
<span id="cb2-760"><a href="#cb2-760"></a>  <span class="at">table1_opts =</span> <span class="fu">list</span>(<span class="at">overall =</span> <span class="cn">FALSE</span>, <span class="at">transpose =</span> <span class="cn">FALSE</span>),</span>
<span id="cb2-761"><a href="#cb2-761"></a>  <span class="at">format =</span> <span class="st">"markdown"</span></span>
<span id="cb2-762"><a href="#cb2-762"></a>)</span>
<span id="cb2-763"><a href="#cb2-763"></a><span class="fu">print</span>(exposure_table)</span>
<span id="cb2-764"><a href="#cb2-764"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(exposure_table, <span class="st">"exposure_table"</span>, push_mods)</span>
<span id="cb2-765"><a href="#cb2-765"></a></span>
<span id="cb2-766"><a href="#cb2-766"></a><span class="co"># create outcomes table by wave</span></span>
<span id="cb2-767"><a href="#cb2-767"></a>outcomes_table <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_make_tables</span>(</span>
<span id="cb2-768"><a href="#cb2-768"></a>  <span class="at">data =</span> dat_long_final <span class="sc">|&gt;</span> <span class="fu">filter</span>(wave <span class="sc">%in%</span> <span class="fu">c</span>(baseline_wave, outcome_wave)),</span>
<span id="cb2-769"><a href="#cb2-769"></a>  <span class="at">vars =</span> outcome_vars,</span>
<span id="cb2-770"><a href="#cb2-770"></a>  <span class="at">by =</span> <span class="st">"wave"</span>,</span>
<span id="cb2-771"><a href="#cb2-771"></a>  <span class="at">labels =</span> var_labels_outcomes,</span>
<span id="cb2-772"><a href="#cb2-772"></a>  <span class="at">format =</span> <span class="st">"markdown"</span></span>
<span id="cb2-773"><a href="#cb2-773"></a>)</span>
<span id="cb2-774"><a href="#cb2-774"></a><span class="fu">print</span>(outcomes_table)</span>
<span id="cb2-775"><a href="#cb2-775"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(outcomes_table, <span class="st">"outcomes_table"</span>, push_mods)</span>
<span id="cb2-776"><a href="#cb2-776"></a></span>
<span id="cb2-777"><a href="#cb2-777"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-778"><a href="#cb2-778"></a><span class="co"># |     </span><span class="re">END</span><span class="co"> DO NOT ALTER     |</span></span>
<span id="cb2-779"><a href="#cb2-779"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-780"><a href="#cb2-780"></a></span>
<span id="cb2-781"><a href="#cb2-781"></a></span>
<span id="cb2-782"><a href="#cb2-782"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-783"><a href="#cb2-783"></a><span class="co"># |     </span><span class="re">END</span><span class="co">                  |</span></span>
<span id="cb2-784"><a href="#cb2-784"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-785"><a href="#cb2-785"></a></span>
<span id="cb2-786"><a href="#cb2-786"></a></span>
<span id="cb2-787"><a href="#cb2-787"></a><span class="co"># note: completed data preparation step -------------------------------------</span></span>
<span id="cb2-788"><a href="#cb2-788"></a><span class="co"># you're now ready for the next steps:</span></span>
<span id="cb2-789"><a href="#cb2-789"></a><span class="co"># 1. creating wide-format dataset for analysis </span></span>
<span id="cb2-790"><a href="#cb2-790"></a><span class="co"># 2. applying causal inference methods</span></span>
<span id="cb2-791"><a href="#cb2-791"></a><span class="co"># 3. conducting sensitivity analyses</span></span>
<span id="cb2-792"><a href="#cb2-792"></a></span>
<span id="cb2-793"><a href="#cb2-793"></a><span class="co"># key decisions summary:</span></span>
<span id="cb2-794"><a href="#cb2-794"></a><span class="co"># exposure variable: extraversion</span></span>
<span id="cb2-795"><a href="#cb2-795"></a><span class="co"># study waves: baseline (2018), exposure (2019), outcome (2020)</span></span>
<span id="cb2-796"><a href="#cb2-796"></a><span class="co"># baseline covariates: demographics, traits, health measures (excluding exposure)</span></span>
<span id="cb2-797"><a href="#cb2-797"></a><span class="co"># outcomes: health, psychological, wellbeing, and social variables</span></span>
<span id="cb2-798"><a href="#cb2-798"></a><span class="co"># binary cutpoint for exposure: here, 4 on the extraversion scale</span></span>
<span id="cb2-799"><a href="#cb2-799"></a><span class="co"># label names for tables</span></span>
<span id="cb2-800"><a href="#cb2-800"></a></span>
<span id="cb2-801"><a href="#cb2-801"></a></span>
<span id="cb2-802"><a href="#cb2-802"></a></span>
<span id="cb2-803"><a href="#cb2-803"></a></span>
<span id="cb2-804"><a href="#cb2-804"></a><span class="co"># THIS IS FOR INTEREST ONLY ----------------------------------------------------</span></span>
<span id="cb2-805"><a href="#cb2-805"></a><span class="co"># uncomment to view random chang in individuals</span></span>
<span id="cb2-806"><a href="#cb2-806"></a><span class="co"># visualise individual changes in exposure over time ------------------------</span></span>
<span id="cb2-807"><a href="#cb2-807"></a><span class="co"># useful for understanding exposure dynamics</span></span>
<span id="cb2-808"><a href="#cb2-808"></a><span class="co"># individual_plot &lt;- margot_plot_individual_responses(</span></span>
<span id="cb2-809"><a href="#cb2-809"></a><span class="co">#   dat_long_1,</span></span>
<span id="cb2-810"><a href="#cb2-810"></a><span class="co">#   y_vars = name_exposure,</span></span>
<span id="cb2-811"><a href="#cb2-811"></a><span class="co">#   id_col = "id",</span></span>
<span id="cb2-812"><a href="#cb2-812"></a><span class="co">#   waves = c(2018:2019),</span></span>
<span id="cb2-813"><a href="#cb2-813"></a><span class="co">#   random_draws = 56,  # number of randomly selected individuals to show</span></span>
<span id="cb2-814"><a href="#cb2-814"></a><span class="co">#   theme = theme_classic(),</span></span>
<span id="cb2-815"><a href="#cb2-815"></a><span class="co">#   scale_range = c(1, 7),  # range of the exposure variable</span></span>
<span id="cb2-816"><a href="#cb2-816"></a><span class="co">#   full_response_scale = TRUE,</span></span>
<span id="cb2-817"><a href="#cb2-817"></a><span class="co">#   seed = 123</span></span>
<span id="cb2-818"><a href="#cb2-818"></a><span class="co"># )</span></span>
<span id="cb2-819"><a href="#cb2-819"></a><span class="co"># print(individual_plot)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="script-2-make-wide-data-format-with-censoring-weights-is-here" class="level2">
<h2 class="anchored" data-anchor-id="script-2-make-wide-data-format-with-censoring-weights-is-here">Script 2: Make Wide Data Format With Censoring Weights is HERE</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># script 2: causal workflow for estimating average treatment effects using margot</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="co"># may 2025</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="co"># questions: joseph.bulbulia@vuw.ac.nz</span></span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="co"># +--------------------------+</span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="co"># |       DO NOT ALTER       |</span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co"># +--------------------------+</span></span>
<span id="cb3-8"><a href="#cb3-8"></a></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="co"># restart fresh session for a clean workspace</span></span>
<span id="cb3-10"><a href="#cb3-10"></a>rstudioapi<span class="sc">::</span><span class="fu">restartSession</span>()</span>
<span id="cb3-11"><a href="#cb3-11"></a></span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="co"># set seed for reproducibility</span></span>
<span id="cb3-13"><a href="#cb3-13"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb3-14"><a href="#cb3-14"></a></span>
<span id="cb3-15"><a href="#cb3-15"></a><span class="co"># libraries ---------------------------------------------------------------</span></span>
<span id="cb3-16"><a href="#cb3-16"></a><span class="co"># essential library ---------------------------------------------------------</span></span>
<span id="cb3-17"><a href="#cb3-17"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(margot, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb3-18"><a href="#cb3-18"></a>  devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"go-bayes/margot"</span>)</span>
<span id="cb3-19"><a href="#cb3-19"></a>}</span>
<span id="cb3-20"><a href="#cb3-20"></a></span>
<span id="cb3-21"><a href="#cb3-21"></a></span>
<span id="cb3-22"><a href="#cb3-22"></a><span class="cf">if</span> (<span class="fu">packageVersion</span>(<span class="st">"margot"</span>) <span class="sc">&lt;</span> <span class="st">"1.0.39"</span>) {</span>
<span id="cb3-23"><a href="#cb3-23"></a>  <span class="fu">stop</span>(<span class="st">"please install margot &gt;= 1.0.39 for this workflow</span><span class="sc">\n</span></span>
<span id="cb3-24"><a href="#cb3-24"></a><span class="st">       run: devtools::install_github(</span><span class="sc">\"</span><span class="st">go-bayes/margot</span><span class="sc">\"</span><span class="st">)</span></span>
<span id="cb3-25"><a href="#cb3-25"></a><span class="st">"</span>)</span>
<span id="cb3-26"><a href="#cb3-26"></a>}</span>
<span id="cb3-27"><a href="#cb3-27"></a></span>
<span id="cb3-28"><a href="#cb3-28"></a><span class="fu">library</span>(margot)</span>
<span id="cb3-29"><a href="#cb3-29"></a></span>
<span id="cb3-30"><a href="#cb3-30"></a><span class="co"># load packages -------------------------------------------------------------</span></span>
<span id="cb3-31"><a href="#cb3-31"></a><span class="co"># pacman will install missing packages automatically</span></span>
<span id="cb3-32"><a href="#cb3-32"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"pacman"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"pacman"</span>)</span>
<span id="cb3-33"><a href="#cb3-33"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb3-34"><a href="#cb3-34"></a>  tidyverse,       <span class="co"># data wrangling + plotting</span></span>
<span id="cb3-35"><a href="#cb3-35"></a>  qs,              <span class="co"># fast data i/o</span></span>
<span id="cb3-36"><a href="#cb3-36"></a>  here,            <span class="co"># project-relative file paths</span></span>
<span id="cb3-37"><a href="#cb3-37"></a>  data.table,      <span class="co"># fast data manipulation</span></span>
<span id="cb3-38"><a href="#cb3-38"></a>  fastDummies,     <span class="co"># dummy variable creation</span></span>
<span id="cb3-39"><a href="#cb3-39"></a>  naniar,          <span class="co"># missing data handling</span></span>
<span id="cb3-40"><a href="#cb3-40"></a>  skimr,           <span class="co"># summary statistics</span></span>
<span id="cb3-41"><a href="#cb3-41"></a>  grf,             <span class="co"># machine learning forests</span></span>
<span id="cb3-42"><a href="#cb3-42"></a>  kableExtra,      <span class="co"># tables</span></span>
<span id="cb3-43"><a href="#cb3-43"></a>  ggplot2,         <span class="co"># graphs</span></span>
<span id="cb3-44"><a href="#cb3-44"></a>  doParallel,      <span class="co"># parallel processing</span></span>
<span id="cb3-45"><a href="#cb3-45"></a>  grf,             <span class="co"># causal forests</span></span>
<span id="cb3-46"><a href="#cb3-46"></a>  janitor,         <span class="co"># variables names</span></span>
<span id="cb3-47"><a href="#cb3-47"></a>  stringr,         <span class="co"># variable names</span></span>
<span id="cb3-48"><a href="#cb3-48"></a>  patchwork,       <span class="co"># graphs</span></span>
<span id="cb3-49"><a href="#cb3-49"></a>  table1,           <span class="co"># tables</span></span>
<span id="cb3-50"><a href="#cb3-50"></a>  cli</span>
<span id="cb3-51"><a href="#cb3-51"></a>)</span>
<span id="cb3-52"><a href="#cb3-52"></a></span>
<span id="cb3-53"><a href="#cb3-53"></a><span class="co"># save paths -------------------------------------------------------------------</span></span>
<span id="cb3-54"><a href="#cb3-54"></a>push_mods <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"save_directory"</span>) </span>
<span id="cb3-55"><a href="#cb3-55"></a></span>
<span id="cb3-56"><a href="#cb3-56"></a><span class="co"># read data</span></span>
<span id="cb3-57"><a href="#cb3-57"></a>dat_long_final <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"dat_long_final"</span>)</span>
<span id="cb3-58"><a href="#cb3-58"></a></span>
<span id="cb3-59"><a href="#cb3-59"></a><span class="co"># read baseline sample weights</span></span>
<span id="cb3-60"><a href="#cb3-60"></a>t0_sample_weights <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"t0_sample_weights"</span>)</span>
<span id="cb3-61"><a href="#cb3-61"></a></span>
<span id="cb3-62"><a href="#cb3-62"></a><span class="co"># read exposure</span></span>
<span id="cb3-63"><a href="#cb3-63"></a>name_exposure <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"name_exposure"</span>)</span>
<span id="cb3-64"><a href="#cb3-64"></a>name_exposure_binary <span class="ot">=</span> <span class="fu">paste0</span>(name_exposure, <span class="st">"_binary"</span>)</span>
<span id="cb3-65"><a href="#cb3-65"></a>name_exposure_continuous <span class="ot">=</span> name_exposure</span>
<span id="cb3-66"><a href="#cb3-66"></a></span>
<span id="cb3-67"><a href="#cb3-67"></a><span class="co"># read variables</span></span>
<span id="cb3-68"><a href="#cb3-68"></a>baseline_vars <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"baseline_vars"</span>)</span>
<span id="cb3-69"><a href="#cb3-69"></a>exposure_var <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"exposure_var"</span>)</span>
<span id="cb3-70"><a href="#cb3-70"></a>outcome_vars <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"outcome_vars"</span>)</span>
<span id="cb3-71"><a href="#cb3-71"></a>baseline_wave <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"baseline_wave"</span>)</span>
<span id="cb3-72"><a href="#cb3-72"></a>exposure_waves <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"exposure_waves"</span>)</span>
<span id="cb3-73"><a href="#cb3-73"></a>outcome_wave <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"outcome_wave"</span>)</span>
<span id="cb3-74"><a href="#cb3-74"></a></span>
<span id="cb3-75"><a href="#cb3-75"></a><span class="co"># define continuous columns to keep</span></span>
<span id="cb3-76"><a href="#cb3-76"></a>continuous_columns_keep <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"t0_sample_weights"</span>)</span>
<span id="cb3-77"><a href="#cb3-77"></a></span>
<span id="cb3-78"><a href="#cb3-78"></a><span class="co"># define ordinal columns that we will expand into binary variables</span></span>
<span id="cb3-79"><a href="#cb3-79"></a>ordinal_columns <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"t0_education_level_coarsen"</span>,</span>
<span id="cb3-80"><a href="#cb3-80"></a>                     <span class="st">"t0_eth_cat"</span>,</span>
<span id="cb3-81"><a href="#cb3-81"></a>                     <span class="st">"t0_rural_gch_2018_l"</span>)</span>
<span id="cb3-82"><a href="#cb3-82"></a></span>
<span id="cb3-83"><a href="#cb3-83"></a><span class="co"># check is this the exposure variable that you want? </span></span>
<span id="cb3-84"><a href="#cb3-84"></a>name_exposure_binary</span>
<span id="cb3-85"><a href="#cb3-85"></a>name_exposure_continuous</span>
<span id="cb3-86"><a href="#cb3-86"></a></span>
<span id="cb3-87"><a href="#cb3-87"></a><span class="co"># define wide variable names</span></span>
<span id="cb3-88"><a href="#cb3-88"></a>t0_name_exposure_binary <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t0_"</span>, name_exposure_binary)</span>
<span id="cb3-89"><a href="#cb3-89"></a>t0_name_exposure_binary</span>
<span id="cb3-90"><a href="#cb3-90"></a></span>
<span id="cb3-91"><a href="#cb3-91"></a><span class="co"># make exposure names (continuous not genreally used)</span></span>
<span id="cb3-92"><a href="#cb3-92"></a>t1_name_exposure_binary <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t1_"</span>, name_exposure_binary)</span>
<span id="cb3-93"><a href="#cb3-93"></a>t1_name_exposure_binary</span>
<span id="cb3-94"><a href="#cb3-94"></a></span>
<span id="cb3-95"><a href="#cb3-95"></a><span class="co"># treatments (continuous verion)</span></span>
<span id="cb3-96"><a href="#cb3-96"></a>t0_name_exposure <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t0_"</span>, name_exposure_continuous)</span>
<span id="cb3-97"><a href="#cb3-97"></a>t1_name_exposure <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t1_"</span>, name_exposure_continuous)</span>
<span id="cb3-98"><a href="#cb3-98"></a>t0_name_exposure_continuous <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t0_"</span>, name_exposure)</span>
<span id="cb3-99"><a href="#cb3-99"></a>t1_name_exposure_continuous <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t1_"</span>, name_exposure)</span>
<span id="cb3-100"><a href="#cb3-100"></a></span>
<span id="cb3-101"><a href="#cb3-101"></a><span class="co"># raw outcomes</span></span>
<span id="cb3-102"><a href="#cb3-102"></a><span class="co"># read health outcomes</span></span>
<span id="cb3-103"><a href="#cb3-103"></a>outcome_vars <span class="ot">&lt;-</span> <span class="fu">here_read</span>(<span class="st">"outcome_vars"</span>)</span>
<span id="cb3-104"><a href="#cb3-104"></a>t2_outcome_z <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t2_"</span>, outcome_vars, <span class="st">"_z"</span>)</span>
<span id="cb3-105"><a href="#cb3-105"></a></span>
<span id="cb3-106"><a href="#cb3-106"></a><span class="co"># view</span></span>
<span id="cb3-107"><a href="#cb3-107"></a>t2_outcome_z</span>
<span id="cb3-108"><a href="#cb3-108"></a></span>
<span id="cb3-109"><a href="#cb3-109"></a><span class="co"># check</span></span>
<span id="cb3-110"><a href="#cb3-110"></a><span class="fu">str</span>(dat_long_final)</span>
<span id="cb3-111"><a href="#cb3-111"></a></span>
<span id="cb3-112"><a href="#cb3-112"></a><span class="co"># check</span></span>
<span id="cb3-113"><a href="#cb3-113"></a>naniar<span class="sc">::</span><span class="fu">gg_miss_var</span>(dat_long_final)</span>
<span id="cb3-114"><a href="#cb3-114"></a></span>
<span id="cb3-115"><a href="#cb3-115"></a><span class="co"># impute data --------------------------------------------------------------</span></span>
<span id="cb3-116"><a href="#cb3-116"></a><span class="co"># ordinal use</span></span>
<span id="cb3-117"><a href="#cb3-117"></a>ordinal_columns <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb3-118"><a href="#cb3-118"></a>  <span class="st">"t0_education_level_coarsen"</span>,</span>
<span id="cb3-119"><a href="#cb3-119"></a>  <span class="st">"t0_eth_cat"</span>,</span>
<span id="cb3-120"><a href="#cb3-120"></a>  <span class="st">"t0_rural_gch_2018_l"</span>,</span>
<span id="cb3-121"><a href="#cb3-121"></a>  <span class="st">"t0_gen_cohort"</span></span>
<span id="cb3-122"><a href="#cb3-122"></a>)</span>
<span id="cb3-123"><a href="#cb3-123"></a></span>
<span id="cb3-124"><a href="#cb3-124"></a><span class="co"># define cols we will not standardise</span></span>
<span id="cb3-125"><a href="#cb3-125"></a>continuous_columns_keep <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"t0_sample_weights"</span>)</span>
<span id="cb3-126"><a href="#cb3-126"></a></span>
<span id="cb3-127"><a href="#cb3-127"></a><span class="co"># remove sample weights</span></span>
<span id="cb3-128"><a href="#cb3-128"></a>dat_long_final_2 <span class="ot">&lt;-</span> dat_long_final <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>sample_weights)</span>
<span id="cb3-129"><a href="#cb3-129"></a></span>
<span id="cb3-130"><a href="#cb3-130"></a><span class="co"># prepare data for analysis ----------------------</span></span>
<span id="cb3-131"><a href="#cb3-131"></a>dat_long_final_2 <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">remove_numeric_attributes</span>(dat_long_final_2)</span>
<span id="cb3-132"><a href="#cb3-132"></a><span class="co"># wide data</span></span>
<span id="cb3-133"><a href="#cb3-133"></a>df_wide <span class="ot">&lt;-</span> <span class="fu">margot_wide_machine</span>(</span>
<span id="cb3-134"><a href="#cb3-134"></a>  dat_long_final,</span>
<span id="cb3-135"><a href="#cb3-135"></a>  <span class="at">id =</span> <span class="st">"id"</span>,</span>
<span id="cb3-136"><a href="#cb3-136"></a>  <span class="at">wave =</span> <span class="st">"wave"</span>,</span>
<span id="cb3-137"><a href="#cb3-137"></a>  baseline_vars,</span>
<span id="cb3-138"><a href="#cb3-138"></a>  <span class="at">exposure_var =</span> exposure_var,</span>
<span id="cb3-139"><a href="#cb3-139"></a>  outcome_vars,</span>
<span id="cb3-140"><a href="#cb3-140"></a>  <span class="at">confounder_vars =</span> <span class="cn">NULL</span>,</span>
<span id="cb3-141"><a href="#cb3-141"></a>  <span class="at">imputation_method =</span> <span class="st">"none"</span>,</span>
<span id="cb3-142"><a href="#cb3-142"></a>  <span class="at">include_exposure_var_baseline =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-143"><a href="#cb3-143"></a>  <span class="at">include_outcome_vars_baseline =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-144"><a href="#cb3-144"></a>  <span class="at">extend_baseline =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-145"><a href="#cb3-145"></a>  <span class="at">include_na_indicators =</span> <span class="cn">FALSE</span></span>
<span id="cb3-146"><a href="#cb3-146"></a>)</span>
<span id="cb3-147"><a href="#cb3-147"></a></span>
<span id="cb3-148"><a href="#cb3-148"></a><span class="co"># check</span></span>
<span id="cb3-149"><a href="#cb3-149"></a><span class="fu">colnames</span>(df_wide)</span>
<span id="cb3-150"><a href="#cb3-150"></a></span>
<span id="cb3-151"><a href="#cb3-151"></a><span class="co"># return sample weights</span></span>
<span id="cb3-152"><a href="#cb3-152"></a>df_wide<span class="sc">$</span>t0_sample_weights <span class="ot">&lt;-</span>  t0_sample_weights</span>
<span id="cb3-153"><a href="#cb3-153"></a></span>
<span id="cb3-154"><a href="#cb3-154"></a><span class="co"># save</span></span>
<span id="cb3-155"><a href="#cb3-155"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(df_wide, <span class="st">"df_wide"</span>)</span>
<span id="cb3-156"><a href="#cb3-156"></a></span>
<span id="cb3-157"><a href="#cb3-157"></a><span class="co">#df_wide &lt;- margot::here_read("df_wide")</span></span>
<span id="cb3-158"><a href="#cb3-158"></a>naniar<span class="sc">::</span><span class="fu">vis_miss</span>(df_wide, <span class="at">warn_large_data =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-159"><a href="#cb3-159"></a></span>
<span id="cb3-160"><a href="#cb3-160"></a><span class="co"># view</span></span>
<span id="cb3-161"><a href="#cb3-161"></a><span class="fu">glimpse</span>(df_wide)</span>
<span id="cb3-162"><a href="#cb3-162"></a></span>
<span id="cb3-163"><a href="#cb3-163"></a></span>
<span id="cb3-164"><a href="#cb3-164"></a><span class="co"># order data with missingness assigned to work with grf and lmtp</span></span>
<span id="cb3-165"><a href="#cb3-165"></a><span class="co"># if any outcome is censored all are censored</span></span>
<span id="cb3-166"><a href="#cb3-166"></a><span class="co"># create version for model reports</span></span>
<span id="cb3-167"><a href="#cb3-167"></a></span>
<span id="cb3-168"><a href="#cb3-168"></a><span class="co"># check</span></span>
<span id="cb3-169"><a href="#cb3-169"></a><span class="fu">colnames</span>(df_wide)</span>
<span id="cb3-170"><a href="#cb3-170"></a></span>
<span id="cb3-171"><a href="#cb3-171"></a></span>
<span id="cb3-172"><a href="#cb3-172"></a><span class="co"># made data wide in correct format</span></span>
<span id="cb3-173"><a href="#cb3-173"></a><span class="co"># ** ignore warning *** </span></span>
<span id="cb3-174"><a href="#cb3-174"></a>df_wide_encoded  <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_process_longitudinal_data_wider</span>(</span>
<span id="cb3-175"><a href="#cb3-175"></a>  df_wide,</span>
<span id="cb3-176"><a href="#cb3-176"></a>  <span class="at">ordinal_columns =</span> ordinal_columns,</span>
<span id="cb3-177"><a href="#cb3-177"></a>  <span class="at">continuous_columns_keep =</span> continuous_columns_keep,</span>
<span id="cb3-178"><a href="#cb3-178"></a>  <span class="at">not_lost_in_following_wave =</span> <span class="st">"not_lost_following_wave"</span>,</span>
<span id="cb3-179"><a href="#cb3-179"></a>  <span class="at">lost_in_following_wave =</span> <span class="st">"lost_following_wave"</span>,</span>
<span id="cb3-180"><a href="#cb3-180"></a>  <span class="at">remove_selected_columns =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-181"><a href="#cb3-181"></a>  <span class="at">exposure_var =</span> exposure_var,</span>
<span id="cb3-182"><a href="#cb3-182"></a>  <span class="at">scale_continuous =</span> <span class="cn">TRUE</span></span>
<span id="cb3-183"><a href="#cb3-183"></a>)</span>
<span id="cb3-184"><a href="#cb3-184"></a></span>
<span id="cb3-185"><a href="#cb3-185"></a><span class="fu">margot_process_longitudinal_data_wider</span>()</span>
<span id="cb3-186"><a href="#cb3-186"></a></span>
<span id="cb3-187"><a href="#cb3-187"></a><span class="co"># check</span></span>
<span id="cb3-188"><a href="#cb3-188"></a><span class="fu">colnames</span>(df_wide_encoded)</span>
<span id="cb3-189"><a href="#cb3-189"></a></span>
<span id="cb3-190"><a href="#cb3-190"></a><span class="co"># check</span></span>
<span id="cb3-191"><a href="#cb3-191"></a><span class="fu">table</span>(df_wide_encoded<span class="sc">$</span>t0_not_lost_following_wave)</span>
<span id="cb3-192"><a href="#cb3-192"></a></span>
<span id="cb3-193"><a href="#cb3-193"></a><span class="co"># make the binary variable numeric</span></span>
<span id="cb3-194"><a href="#cb3-194"></a>df_wide_encoded[[t0_name_exposure_binary]] <span class="ot">&lt;-</span></span>
<span id="cb3-195"><a href="#cb3-195"></a>  <span class="fu">as.numeric</span>(df_wide_encoded[[t0_name_exposure_binary]]) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb3-196"><a href="#cb3-196"></a>df_wide_encoded[[t1_name_exposure_binary]] <span class="ot">&lt;-</span></span>
<span id="cb3-197"><a href="#cb3-197"></a>  <span class="fu">as.numeric</span>(df_wide_encoded[[t1_name_exposure_binary]]) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb3-198"><a href="#cb3-198"></a></span>
<span id="cb3-199"><a href="#cb3-199"></a><span class="co"># view</span></span>
<span id="cb3-200"><a href="#cb3-200"></a>df_wide_encoded[[t0_name_exposure_binary]]</span>
<span id="cb3-201"><a href="#cb3-201"></a>df_wide_encoded[[t1_name_exposure_binary]]</span>
<span id="cb3-202"><a href="#cb3-202"></a></span>
<span id="cb3-203"><a href="#cb3-203"></a><span class="co"># 1. ensure both binaries only take values 0 or 1 (ignore NA)</span></span>
<span id="cb3-204"><a href="#cb3-204"></a><span class="fu">stopifnot</span>(<span class="fu">all</span>(df_wide_encoded[[t0_name_exposure_binary]][<span class="sc">!</span><span class="fu">is.na</span>(df_wide_encoded[[t0_name_exposure_binary]])] <span class="sc">%in%</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>),</span>
<span id="cb3-205"><a href="#cb3-205"></a>          <span class="fu">all</span>(df_wide_encoded[[t1_name_exposure_binary]][<span class="sc">!</span><span class="fu">is.na</span>(df_wide_encoded[[t1_name_exposure_binary]])] <span class="sc">%in%</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>))</span>
<span id="cb3-206"><a href="#cb3-206"></a></span>
<span id="cb3-207"><a href="#cb3-207"></a><span class="co"># 2. ensure NA‐patterns match between t1_exposure and t0_lost flag</span></span>
<span id="cb3-208"><a href="#cb3-208"></a><span class="co"># count n-as in t1 exposure</span></span>
<span id="cb3-209"><a href="#cb3-209"></a>n_na_t1 <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(df_wide_encoded[[t1_name_exposure_binary]]))</span>
<span id="cb3-210"><a href="#cb3-210"></a></span>
<span id="cb3-211"><a href="#cb3-211"></a><span class="co"># count how many were lost at t0</span></span>
<span id="cb3-212"><a href="#cb3-212"></a>n_lost_t0 <span class="ot">&lt;-</span> <span class="fu">sum</span>(df_wide_encoded<span class="sc">$</span>t0_lost_following_wave <span class="sc">==</span> <span class="dv">1</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-213"><a href="#cb3-213"></a></span>
<span id="cb3-214"><a href="#cb3-214"></a><span class="co"># print them for inspection</span></span>
<span id="cb3-215"><a href="#cb3-215"></a><span class="fu">message</span>(<span class="st">"NAs in "</span>, t1_name_exposure_binary, <span class="st">": "</span>, n_na_t1)</span>
<span id="cb3-216"><a href="#cb3-216"></a><span class="fu">message</span>(<span class="st">"t0_lost_following_wave == 1: "</span>, n_lost_t0)</span>
<span id="cb3-217"><a href="#cb3-217"></a></span>
<span id="cb3-218"><a href="#cb3-218"></a><span class="co"># stop if they don’t match</span></span>
<span id="cb3-219"><a href="#cb3-219"></a><span class="fu">stopifnot</span>(n_na_t1 <span class="sc">==</span> n_lost_t0)</span>
<span id="cb3-220"><a href="#cb3-220"></a></span>
<span id="cb3-221"><a href="#cb3-221"></a><span class="co"># 3. ensure if t1 is non‐NA then subject was not lost at t0</span></span>
<span id="cb3-222"><a href="#cb3-222"></a><span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="fu">is.na</span>(df_wide_encoded[[t1_name_exposure_binary]]) <span class="sc">|</span></span>
<span id="cb3-223"><a href="#cb3-223"></a>                df_wide_encoded[[<span class="st">"t0_not_lost_following_wave"</span>]] <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb3-224"><a href="#cb3-224"></a></span>
<span id="cb3-225"><a href="#cb3-225"></a><span class="co"># view</span></span>
<span id="cb3-226"><a href="#cb3-226"></a><span class="fu">glimpse</span>(df_wide_encoded)</span>
<span id="cb3-227"><a href="#cb3-227"></a></span>
<span id="cb3-228"><a href="#cb3-228"></a><span class="co">#naniar::vis_miss(df_wide_encoded, warn_large_data = FALSE)</span></span>
<span id="cb3-229"><a href="#cb3-229"></a>naniar<span class="sc">::</span><span class="fu">gg_miss_var</span>(df_wide_encoded)</span>
<span id="cb3-230"><a href="#cb3-230"></a></span>
<span id="cb3-231"><a href="#cb3-231"></a></span>
<span id="cb3-232"><a href="#cb3-232"></a><span class="co">#save data</span></span>
<span id="cb3-233"><a href="#cb3-233"></a><span class="fu">here_save</span>(df_wide_encoded, <span class="st">"df_wide_encoded"</span>)</span>
<span id="cb3-234"><a href="#cb3-234"></a></span>
<span id="cb3-235"><a href="#cb3-235"></a><span class="co"># new weights approach ---------------------------------------------------------</span></span>
<span id="cb3-236"><a href="#cb3-236"></a></span>
<span id="cb3-237"><a href="#cb3-237"></a></span>
<span id="cb3-238"><a href="#cb3-238"></a><span class="co"># panel attrition workflow using grf (two-stage IPCW + design weights)</span></span>
<span id="cb3-239"><a href="#cb3-239"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-240"><a href="#cb3-240"></a><span class="co"># builds weights in two stages:</span></span>
<span id="cb3-241"><a href="#cb3-241"></a><span class="co">#   w0 : baseline -&gt; t1  (baseline covariates)</span></span>
<span id="cb3-242"><a href="#cb3-242"></a><span class="co">#   w1 : t1 survivors -&gt; t2  (baseline + time-1 exposure)</span></span>
<span id="cb3-243"><a href="#cb3-243"></a><span class="co"># final weight = t0_sample_weights × w0 × w1, then trimmed &amp; normalised.</span></span>
<span id="cb3-244"><a href="#cb3-244"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-245"><a href="#cb3-245"></a></span>
<span id="cb3-246"><a href="#cb3-246"></a><span class="co"># ── 0 setup ───────────────────────────────────────────────────────────────────</span></span>
<span id="cb3-247"><a href="#cb3-247"></a></span>
<span id="cb3-248"><a href="#cb3-248"></a><span class="fu">library</span>(tidyverse)        <span class="co"># wrangling</span></span>
<span id="cb3-249"><a href="#cb3-249"></a><span class="fu">library</span>(glue)             <span class="co"># strings</span></span>
<span id="cb3-250"><a href="#cb3-250"></a><span class="fu">library</span>(grf)              <span class="co"># forests</span></span>
<span id="cb3-251"><a href="#cb3-251"></a><span class="fu">library</span>(cli)              <span class="co"># progress</span></span>
<span id="cb3-252"><a href="#cb3-252"></a></span>
<span id="cb3-253"><a href="#cb3-253"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb3-254"><a href="#cb3-254"></a></span>
<span id="cb3-255"><a href="#cb3-255"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-256"><a href="#cb3-256"></a><span class="co"># 1 import full, unfiltered baseline file</span></span>
<span id="cb3-257"><a href="#cb3-257"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-258"><a href="#cb3-258"></a></span>
<span id="cb3-259"><a href="#cb3-259"></a>df <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"df_wide_encoded"</span>)</span>
<span id="cb3-260"><a href="#cb3-260"></a>cli<span class="sc">::</span><span class="fu">cli_alert_info</span>(<span class="fu">glue</span>(<span class="st">"{nrow(df)} rows × {ncol(df)} columns loaded"</span>))</span>
<span id="cb3-261"><a href="#cb3-261"></a></span>
<span id="cb3-262"><a href="#cb3-262"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-263"><a href="#cb3-263"></a><span class="co"># 2 stage‑0 censoring: dropout between t0 → t1</span></span>
<span id="cb3-264"><a href="#cb3-264"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-265"><a href="#cb3-265"></a></span>
<span id="cb3-266"><a href="#cb3-266"></a>baseline_covars <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb3-267"><a href="#cb3-267"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"t0_"</span>), <span class="sc">-</span><span class="fu">ends_with</span>(<span class="st">"_lost"</span>), <span class="sc">-</span><span class="fu">ends_with</span>(<span class="st">"lost_following_wave"</span>), <span class="sc">-</span><span class="fu">ends_with</span>(<span class="st">"_weights"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb3-268"><a href="#cb3-268"></a>  <span class="fu">colnames</span>() <span class="sc">%&gt;%</span> <span class="fu">sort</span>()</span>
<span id="cb3-269"><a href="#cb3-269"></a></span>
<span id="cb3-270"><a href="#cb3-270"></a>X0 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(df[, baseline_covars])</span>
<span id="cb3-271"><a href="#cb3-271"></a>D0 <span class="ot">&lt;-</span> <span class="fu">factor</span>(df<span class="sc">$</span>t0_lost_following_wave, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))   <span class="co"># 0 = stayed, 1 = lost</span></span>
<span id="cb3-272"><a href="#cb3-272"></a></span>
<span id="cb3-273"><a href="#cb3-273"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"stage 0: probability forest for baseline dropout …"</span>)</span>
<span id="cb3-274"><a href="#cb3-274"></a></span>
<span id="cb3-275"><a href="#cb3-275"></a>pf0 <span class="ot">&lt;-</span> <span class="fu">probability_forest</span>(X0, D0)</span>
<span id="cb3-276"><a href="#cb3-276"></a>P0  <span class="ot">&lt;-</span> <span class="fu">predict</span>(pf0, X0)<span class="sc">$</span>pred[, <span class="dv">2</span>]               <span class="co"># P(dropout by t1)</span></span>
<span id="cb3-277"><a href="#cb3-277"></a>w0  <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(D0 <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> P0))         <span class="co"># IPCW for stage 0</span></span>
<span id="cb3-278"><a href="#cb3-278"></a>df<span class="sc">$</span>w0 <span class="ot">&lt;-</span> w0</span>
<span id="cb3-279"><a href="#cb3-279"></a></span>
<span id="cb3-280"><a href="#cb3-280"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-281"><a href="#cb3-281"></a><span class="co"># 3 stage‑1 censoring: dropout between t1 → t2 (baseline + exposure)</span></span>
<span id="cb3-282"><a href="#cb3-282"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-283"><a href="#cb3-283"></a></span>
<span id="cb3-284"><a href="#cb3-284"></a>exposure_var <span class="ot">&lt;-</span> t1_name_exposure_binary       <span class="co"># ← binary exposure variable name</span></span>
<span id="cb3-285"><a href="#cb3-285"></a></span>
<span id="cb3-286"><a href="#cb3-286"></a>df1 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(t0_lost_following_wave <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb3-287"><a href="#cb3-287"></a></span>
<span id="cb3-288"><a href="#cb3-288"></a><span class="co"># remove rows with missing exposure for stage‑1 model</span></span>
<span id="cb3-289"><a href="#cb3-289"></a>cen1_data <span class="ot">&lt;-</span> df1 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(.data[[exposure_var]]))</span>
<span id="cb3-290"><a href="#cb3-290"></a></span>
<span id="cb3-291"><a href="#cb3-291"></a>X1 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">cbind</span>(</span>
<span id="cb3-292"><a href="#cb3-292"></a>  cen1_data[, baseline_covars],</span>
<span id="cb3-293"><a href="#cb3-293"></a>  cen1_data[[exposure_var]]</span>
<span id="cb3-294"><a href="#cb3-294"></a>))</span>
<span id="cb3-295"><a href="#cb3-295"></a><span class="fu">colnames</span>(X1)[<span class="fu">ncol</span>(X1)] <span class="ot">&lt;-</span> exposure_var</span>
<span id="cb3-296"><a href="#cb3-296"></a></span>
<span id="cb3-297"><a href="#cb3-297"></a>D1 <span class="ot">&lt;-</span> <span class="fu">factor</span>(cen1_data<span class="sc">$</span>t1_lost_following_wave, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb3-298"><a href="#cb3-298"></a></span>
<span id="cb3-299"><a href="#cb3-299"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"stage 1: probability forest for second‑wave dropout …"</span>)</span>
<span id="cb3-300"><a href="#cb3-300"></a></span>
<span id="cb3-301"><a href="#cb3-301"></a>pf1 <span class="ot">&lt;-</span> <span class="fu">probability_forest</span>(X1, D1)               <span class="co"># 1 = lost before t2</span></span>
<span id="cb3-302"><a href="#cb3-302"></a>P1  <span class="ot">&lt;-</span> <span class="fu">predict</span>(pf1, X1)<span class="sc">$</span>pred[, <span class="dv">2</span>]</span>
<span id="cb3-303"><a href="#cb3-303"></a>w1  <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(D1 <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> P1))</span>
<span id="cb3-304"><a href="#cb3-304"></a></span>
<span id="cb3-305"><a href="#cb3-305"></a><span class="co"># map w1 back to df1 (rows with NA exposure get weight 0)</span></span>
<span id="cb3-306"><a href="#cb3-306"></a>df1<span class="sc">$</span>w1 <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb3-307"><a href="#cb3-307"></a>df1<span class="sc">$</span>w1[<span class="fu">match</span>(cen1_data<span class="sc">$</span>id, df1<span class="sc">$</span>id)] <span class="ot">&lt;-</span> w1</span>
<span id="cb3-308"><a href="#cb3-308"></a></span>
<span id="cb3-309"><a href="#cb3-309"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-310"><a href="#cb3-310"></a><span class="co"># 4 combine design × IPCW weights</span></span>
<span id="cb3-311"><a href="#cb3-311"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-312"><a href="#cb3-312"></a></span>
<span id="cb3-313"><a href="#cb3-313"></a><span class="co"># bring forward w0 for the matching rows (safe join)</span></span>
<span id="cb3-314"><a href="#cb3-314"></a>w0_vec <span class="ot">&lt;-</span> df<span class="sc">$</span>w0[<span class="fu">match</span>(df1<span class="sc">$</span>id, df<span class="sc">$</span>id)]</span>
<span id="cb3-315"><a href="#cb3-315"></a></span>
<span id="cb3-316"><a href="#cb3-316"></a><span class="co"># combined weight before trim / normalise</span></span>
<span id="cb3-317"><a href="#cb3-317"></a>raw_w <span class="ot">&lt;-</span> df1<span class="sc">$</span>t0_sample_weights <span class="sc">*</span> w0_vec <span class="sc">*</span> df1<span class="sc">$</span>w1</span>
<span id="cb3-318"><a href="#cb3-318"></a></span>
<span id="cb3-319"><a href="#cb3-319"></a>df1<span class="sc">$</span>raw_weight <span class="ot">&lt;-</span> raw_w</span>
<span id="cb3-320"><a href="#cb3-320"></a></span>
<span id="cb3-321"><a href="#cb3-321"></a><span class="co"># trim + normalise (exclude NA &amp; zeros)</span></span>
<span id="cb3-322"><a href="#cb3-322"></a>pos <span class="ot">&lt;-</span> raw_w[<span class="sc">!</span><span class="fu">is.na</span>(raw_w) <span class="sc">&amp;</span> raw_w <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb3-323"><a href="#cb3-323"></a></span>
<span id="cb3-324"><a href="#cb3-324"></a>lb  <span class="ot">&lt;-</span> <span class="fu">quantile</span>(pos, <span class="fl">0.00</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-325"><a href="#cb3-325"></a>ub  <span class="ot">&lt;-</span> <span class="fu">quantile</span>(pos, <span class="fl">0.99</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-326"><a href="#cb3-326"></a></span>
<span id="cb3-327"><a href="#cb3-327"></a>trimmed <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(raw_w, lb), ub)</span>
<span id="cb3-328"><a href="#cb3-328"></a>normalised <span class="ot">&lt;-</span> trimmed <span class="sc">/</span> <span class="fu">mean</span>(trimmed, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-329"><a href="#cb3-329"></a></span>
<span id="cb3-330"><a href="#cb3-330"></a>df1<span class="sc">$</span>combo_weights <span class="ot">&lt;-</span> normalised <span class="ot">&lt;-</span> trimmed <span class="sc">/</span> <span class="fu">mean</span>(trimmed)</span>
<span id="cb3-331"><a href="#cb3-331"></a></span>
<span id="cb3-332"><a href="#cb3-332"></a>df1<span class="sc">$</span>combo_weights <span class="ot">&lt;-</span> normalised</span>
<span id="cb3-333"><a href="#cb3-333"></a></span>
<span id="cb3-334"><a href="#cb3-334"></a><span class="fu">hist</span>(df1<span class="sc">$</span>combo_weights[df1<span class="sc">$</span>t1_lost_following_wave <span class="sc">==</span> <span class="dv">0</span>],</span>
<span id="cb3-335"><a href="#cb3-335"></a>     <span class="at">main =</span> <span class="st">"combined weights (observed)"</span>, <span class="at">xlab =</span> <span class="st">"weight"</span>)</span>
<span id="cb3-336"><a href="#cb3-336"></a></span>
<span id="cb3-337"><a href="#cb3-337"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-338"><a href="#cb3-338"></a><span class="co"># 5 analysis set: observed through t2 (not censored at either stage)</span></span>
<span id="cb3-339"><a href="#cb3-339"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-340"><a href="#cb3-340"></a></span>
<span id="cb3-341"><a href="#cb3-341"></a>df_analysis <span class="ot">&lt;-</span> df1 <span class="sc">%&gt;%</span></span>
<span id="cb3-342"><a href="#cb3-342"></a>  <span class="fu">filter</span>(t1_lost_following_wave <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-343"><a href="#cb3-343"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb3-344"><a href="#cb3-344"></a></span>
<span id="cb3-345"><a href="#cb3-345"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(df_analysis, <span class="st">"df_analysis_weighted_two_stage"</span>)</span>
<span id="cb3-346"><a href="#cb3-346"></a></span>
<span id="cb3-347"><a href="#cb3-347"></a>cli<span class="sc">::</span><span class="fu">cli_alert_success</span>(<span class="fu">glue</span>(<span class="st">"analysis sample: {nrow(df_analysis)} obs"</span>))</span>
<span id="cb3-348"><a href="#cb3-348"></a></span>
<span id="cb3-349"><a href="#cb3-349"></a><span class="co"># </span><span class="al">TEST</span><span class="co"> DO NOT UNCOMMENT</span></span>
<span id="cb3-350"><a href="#cb3-350"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-351"><a href="#cb3-351"></a><span class="co"># 6 causal forest (edit outcome var if needed)</span></span>
<span id="cb3-352"><a href="#cb3-352"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-353"><a href="#cb3-353"></a><span class="co"># </span></span>
<span id="cb3-354"><a href="#cb3-354"></a><span class="co"># outcome_var &lt;- "t2_kessler_latent_depression_z"   # ← edit</span></span>
<span id="cb3-355"><a href="#cb3-355"></a><span class="co"># </span></span>
<span id="cb3-356"><a href="#cb3-356"></a><span class="co"># Y &lt;- df_analysis[[outcome_var]]</span></span>
<span id="cb3-357"><a href="#cb3-357"></a><span class="co"># W &lt;- df_analysis[[exposure_var]]</span></span>
<span id="cb3-358"><a href="#cb3-358"></a><span class="co"># X &lt;- as.matrix(df_analysis[, baseline_covars])</span></span>
<span id="cb3-359"><a href="#cb3-359"></a><span class="co"># </span></span>
<span id="cb3-360"><a href="#cb3-360"></a><span class="co"># cf &lt;- causal_forest(</span></span>
<span id="cb3-361"><a href="#cb3-361"></a><span class="co">#   X, Y, W,</span></span>
<span id="cb3-362"><a href="#cb3-362"></a><span class="co">#   sample.weights = df_analysis$combo_weights,</span></span>
<span id="cb3-363"><a href="#cb3-363"></a><span class="co">#   num.trees      = 2000</span></span>
<span id="cb3-364"><a href="#cb3-364"></a><span class="co"># )</span></span>
<span id="cb3-365"><a href="#cb3-365"></a><span class="co"># </span></span>
<span id="cb3-366"><a href="#cb3-366"></a><span class="co"># print(average_treatment_effect(cf))</span></span>
<span id="cb3-367"><a href="#cb3-367"></a><span class="co"># margot::here_save(cf,          "cf_ipcw_two_stage")</span></span>
<span id="cb3-368"><a href="#cb3-368"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-369"><a href="#cb3-369"></a><span class="co"># 7 save objects</span></span>
<span id="cb3-370"><a href="#cb3-370"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-371"><a href="#cb3-371"></a></span>
<span id="cb3-372"><a href="#cb3-372"></a></span>
<span id="cb3-373"><a href="#cb3-373"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"two-stage IPCW workflow complete ✔"</span>)</span>
<span id="cb3-374"><a href="#cb3-374"></a></span>
<span id="cb3-375"><a href="#cb3-375"></a></span>
<span id="cb3-376"><a href="#cb3-376"></a><span class="co"># # maintain workflow </span></span>
<span id="cb3-377"><a href="#cb3-377"></a>E <span class="ot">&lt;-</span> baseline_covars</span>
<span id="cb3-378"><a href="#cb3-378"></a><span class="fu">here_save</span>(E, <span class="st">"E"</span>)</span>
<span id="cb3-379"><a href="#cb3-379"></a><span class="fu">length</span>(E)</span>
<span id="cb3-380"><a href="#cb3-380"></a><span class="fu">colnames</span>(df_analysis)</span>
<span id="cb3-381"><a href="#cb3-381"></a></span>
<span id="cb3-382"><a href="#cb3-382"></a></span>
<span id="cb3-383"><a href="#cb3-383"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"naming convention matcheds `grf` ✔"</span>)</span>
<span id="cb3-384"><a href="#cb3-384"></a></span>
<span id="cb3-385"><a href="#cb3-385"></a></span>
<span id="cb3-386"><a href="#cb3-386"></a><span class="co"># arrange</span></span>
<span id="cb3-387"><a href="#cb3-387"></a>df_grf <span class="ot">&lt;-</span> df_analysis <span class="sc">|&gt;</span></span>
<span id="cb3-388"><a href="#cb3-388"></a>  <span class="fu">relocate</span>(<span class="fu">ends_with</span>(<span class="st">"_weights"</span>), <span class="at">.before =</span> <span class="fu">starts_with</span>(<span class="st">"t0_"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb3-389"><a href="#cb3-389"></a>  <span class="fu">relocate</span>(<span class="fu">ends_with</span>(<span class="st">"_weight"</span>), <span class="at">.before =</span> <span class="fu">ends_with</span>(<span class="st">"_weights"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb3-390"><a href="#cb3-390"></a>  <span class="fu">relocate</span>(<span class="fu">starts_with</span>(<span class="st">"t0_"</span>), <span class="at">.before =</span> <span class="fu">starts_with</span>(<span class="st">"t1_"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb3-391"><a href="#cb3-391"></a>  <span class="fu">relocate</span>(<span class="fu">starts_with</span>(<span class="st">"t1_"</span>), <span class="at">.before =</span> <span class="fu">starts_with</span>(<span class="st">"t2_"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb3-392"><a href="#cb3-392"></a>  <span class="fu">relocate</span>(<span class="st">"t0_not_lost_following_wave"</span>, <span class="at">.before =</span> <span class="fu">starts_with</span>(<span class="st">"t1_"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb3-393"><a href="#cb3-393"></a>  <span class="fu">relocate</span>(<span class="fu">all_of</span>(t1_name_exposure_binary), <span class="at">.before =</span> <span class="fu">starts_with</span>(<span class="st">"t2_"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb3-394"><a href="#cb3-394"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb3-395"><a href="#cb3-395"></a></span>
<span id="cb3-396"><a href="#cb3-396"></a><span class="fu">colnames</span>(df_grf)</span>
<span id="cb3-397"><a href="#cb3-397"></a></span>
<span id="cb3-398"><a href="#cb3-398"></a></span>
<span id="cb3-399"><a href="#cb3-399"></a><span class="co"># +--------------------------+</span></span>
<span id="cb3-400"><a href="#cb3-400"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb3-401"><a href="#cb3-401"></a><span class="co"># +--------------------------+</span></span>
<span id="cb3-402"><a href="#cb3-402"></a><span class="co"># make sure to do this</span></span>
<span id="cb3-403"><a href="#cb3-403"></a><span class="co"># save final data</span></span>
<span id="cb3-404"><a href="#cb3-404"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(df_grf, <span class="st">"df_grf"</span>)</span>
<span id="cb3-405"><a href="#cb3-405"></a></span>
<span id="cb3-406"><a href="#cb3-406"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"saved data `df_grf` for models ✔"</span>)</span>
<span id="cb3-407"><a href="#cb3-407"></a></span>
<span id="cb3-408"><a href="#cb3-408"></a></span>
<span id="cb3-409"><a href="#cb3-409"></a><span class="co"># +--------------------------+</span></span>
<span id="cb3-410"><a href="#cb3-410"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb3-411"><a href="#cb3-411"></a><span class="co"># +--------------------------+</span></span>
<span id="cb3-412"><a href="#cb3-412"></a></span>
<span id="cb3-413"><a href="#cb3-413"></a></span>
<span id="cb3-414"><a href="#cb3-414"></a><span class="co"># check final dataset</span></span>
<span id="cb3-415"><a href="#cb3-415"></a><span class="fu">colnames</span>(df_grf)</span>
<span id="cb3-416"><a href="#cb3-416"></a></span>
<span id="cb3-417"><a href="#cb3-417"></a><span class="co"># visualise missing</span></span>
<span id="cb3-418"><a href="#cb3-418"></a><span class="co"># should have no missing in t1 and t2 variables</span></span>
<span id="cb3-419"><a href="#cb3-419"></a><span class="co"># handled by IPCW</span></span>
<span id="cb3-420"><a href="#cb3-420"></a><span class="co"># make final missing data graph</span></span>
<span id="cb3-421"><a href="#cb3-421"></a>missing_final_data_plot <span class="ot">&lt;-</span> naniar<span class="sc">::</span><span class="fu">vis_miss</span>(df_grf, <span class="at">warn_large_data =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-422"><a href="#cb3-422"></a>missing_final_data_plot</span>
<span id="cb3-423"><a href="#cb3-423"></a></span>
<span id="cb3-424"><a href="#cb3-424"></a><span class="co"># save plot</span></span>
<span id="cb3-425"><a href="#cb3-425"></a><span class="fu">margot_save_png</span>(missing_final_data_plot, <span class="at">prefix =</span> <span class="st">"missing_final_data"</span>)</span>
<span id="cb3-426"><a href="#cb3-426"></a></span>
<span id="cb3-427"><a href="#cb3-427"></a><span class="co"># checks</span></span>
<span id="cb3-428"><a href="#cb3-428"></a><span class="fu">colnames</span>(df_grf)</span>
<span id="cb3-429"><a href="#cb3-429"></a><span class="fu">str</span>(df_grf)</span>
<span id="cb3-430"><a href="#cb3-430"></a></span>
<span id="cb3-431"><a href="#cb3-431"></a><span class="co"># check exposures</span></span>
<span id="cb3-432"><a href="#cb3-432"></a><span class="fu">table</span>(df_grf[[t1_name_exposure_binary]])</span>
<span id="cb3-433"><a href="#cb3-433"></a></span>
<span id="cb3-434"><a href="#cb3-434"></a><span class="co"># check</span></span>
<span id="cb3-435"><a href="#cb3-435"></a><span class="fu">hist</span>(df_grf<span class="sc">$</span>t1_adjusted_weights)</span>
<span id="cb3-436"><a href="#cb3-436"></a></span>
<span id="cb3-437"><a href="#cb3-437"></a><span class="co"># calculate summary statistics</span></span>
<span id="cb3-438"><a href="#cb3-438"></a>t0_weight_summary <span class="ot">&lt;-</span> <span class="fu">summary</span>(df_wide_encoded)</span>
<span id="cb3-439"><a href="#cb3-439"></a></span>
<span id="cb3-440"><a href="#cb3-440"></a><span class="co"># check</span></span>
<span id="cb3-441"><a href="#cb3-441"></a><span class="fu">glimpse</span>(df_grf<span class="sc">$</span>t1_adjusted_weights)</span>
<span id="cb3-442"><a href="#cb3-442"></a></span>
<span id="cb3-443"><a href="#cb3-443"></a><span class="co"># visualise weight distributions</span></span>
<span id="cb3-444"><a href="#cb3-444"></a><span class="fu">hist</span>(df_grf<span class="sc">$</span>t1_adjusted_weights, <span class="at">main =</span> <span class="st">"t0_stabalised weights"</span>, <span class="at">xlab =</span> <span class="st">"Weight"</span>)</span>
<span id="cb3-445"><a href="#cb3-445"></a></span>
<span id="cb3-446"><a href="#cb3-446"></a><span class="co"># check n</span></span>
<span id="cb3-447"><a href="#cb3-447"></a>n_observed_grf <span class="ot">&lt;-</span> <span class="fu">nrow</span>(df_grf)</span>
<span id="cb3-448"><a href="#cb3-448"></a></span>
<span id="cb3-449"><a href="#cb3-449"></a><span class="co"># view</span></span>
<span id="cb3-450"><a href="#cb3-450"></a>n_observed_grf</span>
<span id="cb3-451"><a href="#cb3-451"></a></span>
<span id="cb3-452"><a href="#cb3-452"></a><span class="co"># save</span></span>
<span id="cb3-453"><a href="#cb3-453"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(n_observed_grf, <span class="st">"n_observed_grf"</span>)</span>
<span id="cb3-454"><a href="#cb3-454"></a></span>
<span id="cb3-455"><a href="#cb3-455"></a></span>
<span id="cb3-456"><a href="#cb3-456"></a></span>
<span id="cb3-457"><a href="#cb3-457"></a><span class="co"># +--------------------------+</span></span>
<span id="cb3-458"><a href="#cb3-458"></a><span class="co"># |     </span><span class="re">END</span><span class="co"> DO NOT ALTER     |</span></span>
<span id="cb3-459"><a href="#cb3-459"></a><span class="co"># +--------------------------+</span></span>
<span id="cb3-460"><a href="#cb3-460"></a></span>
<span id="cb3-461"><a href="#cb3-461"></a></span>
<span id="cb3-462"><a href="#cb3-462"></a><span class="co"># +--------------------------+</span></span>
<span id="cb3-463"><a href="#cb3-463"></a><span class="co"># |     </span><span class="re">END</span><span class="co">                  |</span></span>
<span id="cb3-464"><a href="#cb3-464"></a><span class="co"># +--------------------------+</span></span>
<span id="cb3-465"><a href="#cb3-465"></a></span>
<span id="cb3-466"><a href="#cb3-466"></a><span class="co"># this is just for your interest ------------------------------------------</span></span>
<span id="cb3-467"><a href="#cb3-467"></a><span class="co"># not used in final manuscript</span></span>
<span id="cb3-468"><a href="#cb3-468"></a><span class="co"># FOR INTEREESTS</span></span>
<span id="cb3-469"><a href="#cb3-469"></a><span class="co"># inspect propensity scores -----------------------------------------------</span></span>
<span id="cb3-470"><a href="#cb3-470"></a><span class="co"># get data</span></span>
<span id="cb3-471"><a href="#cb3-471"></a><span class="co"># df_grf &lt;- here_read('df_grf')</span></span>
<span id="cb3-472"><a href="#cb3-472"></a><span class="co"># </span></span>
<span id="cb3-473"><a href="#cb3-473"></a><span class="co"># # assign weights var name</span></span>
<span id="cb3-474"><a href="#cb3-474"></a><span class="co"># weights_var_name = "t0_adjusted_weights"</span></span>
<span id="cb3-475"><a href="#cb3-475"></a><span class="co"># </span></span>
<span id="cb3-476"><a href="#cb3-476"></a><span class="co"># # baseline covariates  # E already exists and is defined</span></span>
<span id="cb3-477"><a href="#cb3-477"></a><span class="co"># E</span></span>
<span id="cb3-478"><a href="#cb3-478"></a><span class="co"># </span></span>
<span id="cb3-479"><a href="#cb3-479"></a><span class="co"># # must be a data frame, no NA in exposure</span></span>
<span id="cb3-480"><a href="#cb3-480"></a><span class="co"># </span></span>
<span id="cb3-481"><a href="#cb3-481"></a><span class="co"># # df_grf is a data frame - we must process this data frame in several steps</span></span>
<span id="cb3-482"><a href="#cb3-482"></a><span class="co"># # user to specify which columns are outcomes, default to 'starts_with("t2_")'</span></span>
<span id="cb3-483"><a href="#cb3-483"></a><span class="co"># df_propensity_org &lt;- df_grf |&gt; select(!starts_with("t2_"))</span></span>
<span id="cb3-484"><a href="#cb3-484"></a><span class="co"># </span></span>
<span id="cb3-485"><a href="#cb3-485"></a><span class="co"># # Remove NAs and print message that this has been done</span></span>
<span id="cb3-486"><a href="#cb3-486"></a><span class="co"># df_propensity &lt;- df_propensity_org |&gt; drop_na() |&gt; droplevels()</span></span>
<span id="cb3-487"><a href="#cb3-487"></a><span class="co"># </span></span>
<span id="cb3-488"><a href="#cb3-488"></a><span class="co"># # E_propensity_names</span></span>
<span id="cb3-489"><a href="#cb3-489"></a><span class="co"># # first run model for baseline propensity if this is selected.  The default should be to not select it.</span></span>
<span id="cb3-490"><a href="#cb3-490"></a><span class="co"># propensity_model_and_plots &lt;- margot_propensity_model_and_plots(</span></span>
<span id="cb3-491"><a href="#cb3-491"></a><span class="co">#   df_propensity = df_propensity,</span></span>
<span id="cb3-492"><a href="#cb3-492"></a><span class="co">#   exposure_variable = t1_name_exposure_binary,</span></span>
<span id="cb3-493"><a href="#cb3-493"></a><span class="co">#   baseline_vars = E,</span></span>
<span id="cb3-494"><a href="#cb3-494"></a><span class="co">#   weights_var_name = weights_var_name,</span></span>
<span id="cb3-495"><a href="#cb3-495"></a><span class="co">#   estimand = "ATE",</span></span>
<span id="cb3-496"><a href="#cb3-496"></a><span class="co">#   method = "ebal",</span></span>
<span id="cb3-497"><a href="#cb3-497"></a><span class="co">#   focal = NULL</span></span>
<span id="cb3-498"><a href="#cb3-498"></a><span class="co"># )</span></span>
<span id="cb3-499"><a href="#cb3-499"></a><span class="co"># </span></span>
<span id="cb3-500"><a href="#cb3-500"></a><span class="co"># # visualise</span></span>
<span id="cb3-501"><a href="#cb3-501"></a><span class="co"># summary(propensity_model_and_plots$match_propensity)</span></span>
<span id="cb3-502"><a href="#cb3-502"></a><span class="co"># </span></span>
<span id="cb3-503"><a href="#cb3-503"></a><span class="co"># # key plot</span></span>
<span id="cb3-504"><a href="#cb3-504"></a><span class="co"># propensity_model_and_plots$love_plot</span></span>
<span id="cb3-505"><a href="#cb3-505"></a><span class="co"># </span></span>
<span id="cb3-506"><a href="#cb3-506"></a><span class="co"># # other plots</span></span>
<span id="cb3-507"><a href="#cb3-507"></a><span class="co"># propensity_model_and_plots$summary_plot</span></span>
<span id="cb3-508"><a href="#cb3-508"></a><span class="co"># propensity_model_and_plots$balance_table</span></span>
<span id="cb3-509"><a href="#cb3-509"></a><span class="co"># propensity_model_and_plots$diagnostics</span></span>
<span id="cb3-510"><a href="#cb3-510"></a><span class="co"># </span></span>
<span id="cb3-511"><a href="#cb3-511"></a><span class="co"># </span></span>
<span id="cb3-512"><a href="#cb3-512"></a><span class="co"># # check size</span></span>
<span id="cb3-513"><a href="#cb3-513"></a><span class="co"># size_bytes &lt;- object.size(propensity_model_and_plots)</span></span>
<span id="cb3-514"><a href="#cb3-514"></a><span class="co"># print(size_bytes, units = "auto") # Mb</span></span>
<span id="cb3-515"><a href="#cb3-515"></a><span class="co"># </span></span>
<span id="cb3-516"><a href="#cb3-516"></a><span class="co"># # use qs to save only if you have space</span></span>
<span id="cb3-517"><a href="#cb3-517"></a><span class="co"># here_save_qs(propensity_model_and_plots,</span></span>
<span id="cb3-518"><a href="#cb3-518"></a><span class="co">#              "propensity_model_and_plots",</span></span>
<span id="cb3-519"><a href="#cb3-519"></a><span class="co">#              push_mods)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="script-3-models-graphs-is-here" class="level2">
<h2 class="anchored" data-anchor-id="script-3-models-graphs-is-here">Script 3: Models &amp; Graphs is HERE</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># script 3: causal workflow for estimating average treatment effects using margot</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="co"># may 2025</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="co"># questions: joseph.bulbulia@vuw.ac.nz</span></span>
<span id="cb4-4"><a href="#cb4-4"></a></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co"># |       DO NOT ALTER       |</span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-8"><a href="#cb4-8"></a></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="co"># restart fresh session</span></span>
<span id="cb4-10"><a href="#cb4-10"></a></span>
<span id="cb4-11"><a href="#cb4-11"></a>rstudioapi<span class="sc">::</span><span class="fu">restartSession</span>()</span>
<span id="cb4-12"><a href="#cb4-12"></a></span>
<span id="cb4-13"><a href="#cb4-13"></a></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="co"># reproducibility ---------------------------------------------------------</span></span>
<span id="cb4-15"><a href="#cb4-15"></a></span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="co"># choose number</span></span>
<span id="cb4-17"><a href="#cb4-17"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb4-18"><a href="#cb4-18"></a>seed <span class="ot">=</span> <span class="dv">123</span></span>
<span id="cb4-19"><a href="#cb4-19"></a></span>
<span id="cb4-20"><a href="#cb4-20"></a><span class="co"># essential library ---------------------------------------------------------</span></span>
<span id="cb4-21"><a href="#cb4-21"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(margot, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb4-22"><a href="#cb4-22"></a>  devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"go-bayes/margot"</span>)</span>
<span id="cb4-23"><a href="#cb4-23"></a>  <span class="fu">library</span>(margot)</span>
<span id="cb4-24"><a href="#cb4-24"></a>}</span>
<span id="cb4-25"><a href="#cb4-25"></a></span>
<span id="cb4-26"><a href="#cb4-26"></a><span class="co"># min version of markgot</span></span>
<span id="cb4-27"><a href="#cb4-27"></a>min_version <span class="ot">&lt;-</span> <span class="st">"1.0.41"</span></span>
<span id="cb4-28"><a href="#cb4-28"></a><span class="cf">if</span> (<span class="fu">packageVersion</span>(<span class="st">"margot"</span>) <span class="sc">&lt;</span> min_version) {</span>
<span id="cb4-29"><a href="#cb4-29"></a>  <span class="fu">stop</span>(<span class="st">"please install margot &gt;= min_version for this workflow</span><span class="sc">\n</span></span>
<span id="cb4-30"><a href="#cb4-30"></a><span class="st">       run: devtools::install_github(</span><span class="sc">\"</span><span class="st">go-bayes/margot</span><span class="sc">\"</span><span class="st">)</span></span>
<span id="cb4-31"><a href="#cb4-31"></a><span class="st">"</span>)</span>
<span id="cb4-32"><a href="#cb4-32"></a>}</span>
<span id="cb4-33"><a href="#cb4-33"></a></span>
<span id="cb4-34"><a href="#cb4-34"></a><span class="co"># call library</span></span>
<span id="cb4-35"><a href="#cb4-35"></a><span class="fu">library</span>(<span class="st">"margot"</span>)</span>
<span id="cb4-36"><a href="#cb4-36"></a></span>
<span id="cb4-37"><a href="#cb4-37"></a><span class="co"># check package version</span></span>
<span id="cb4-38"><a href="#cb4-38"></a><span class="fu">packageVersion</span>(<span class="at">pkg =</span> <span class="st">"margot"</span>)</span>
<span id="cb4-39"><a href="#cb4-39"></a></span>
<span id="cb4-40"><a href="#cb4-40"></a></span>
<span id="cb4-41"><a href="#cb4-41"></a></span>
<span id="cb4-42"><a href="#cb4-42"></a><span class="co"># load libraries ----------------------------------------------------------</span></span>
<span id="cb4-43"><a href="#cb4-43"></a><span class="co"># pacman will install missing packages automatically</span></span>
<span id="cb4-44"><a href="#cb4-44"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"pacman"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"pacman"</span>)</span>
<span id="cb4-45"><a href="#cb4-45"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb4-46"><a href="#cb4-46"></a>  tidyverse,       <span class="co"># data wrangling + plotting</span></span>
<span id="cb4-47"><a href="#cb4-47"></a>  qs,              <span class="co"># fast data i/o</span></span>
<span id="cb4-48"><a href="#cb4-48"></a>  here,            <span class="co"># project-relative file paths</span></span>
<span id="cb4-49"><a href="#cb4-49"></a>  data.table,      <span class="co"># fast data manipulation</span></span>
<span id="cb4-50"><a href="#cb4-50"></a>  fastDummies,     <span class="co"># dummy variable creation</span></span>
<span id="cb4-51"><a href="#cb4-51"></a>  naniar,          <span class="co"># missing data handling</span></span>
<span id="cb4-52"><a href="#cb4-52"></a>  skimr,           <span class="co"># summary statistics</span></span>
<span id="cb4-53"><a href="#cb4-53"></a>  grf, ranger,     <span class="co"># machine learning forests</span></span>
<span id="cb4-54"><a href="#cb4-54"></a>  doParallel,      <span class="co"># parallel processing,</span></span>
<span id="cb4-55"><a href="#cb4-55"></a>  kableExtra,</span>
<span id="cb4-56"><a href="#cb4-56"></a>  ggplot2 ,        <span class="co"># graphs</span></span>
<span id="cb4-57"><a href="#cb4-57"></a>  rlang ,          <span class="co"># functions for base types/Core R/ 'Tidyverse'</span></span>
<span id="cb4-58"><a href="#cb4-58"></a>  purrr ,          <span class="co"># functional programming tools.</span></span>
<span id="cb4-59"><a href="#cb4-59"></a>  patchwork,      <span class="co"># nice graph placement</span></span>
<span id="cb4-60"><a href="#cb4-60"></a>  janitor,         <span class="co"># nice labels</span></span>
<span id="cb4-61"><a href="#cb4-61"></a>  glue,            <span class="co"># format/ interpolate a string</span></span>
<span id="cb4-62"><a href="#cb4-62"></a>  cli,</span>
<span id="cb4-63"><a href="#cb4-63"></a>  future,</span>
<span id="cb4-64"><a href="#cb4-64"></a>  crayon,</span>
<span id="cb4-65"><a href="#cb4-65"></a>  glue,</span>
<span id="cb4-66"><a href="#cb4-66"></a>  stringr, </span>
<span id="cb4-67"><a href="#cb4-67"></a>  furr</span>
<span id="cb4-68"><a href="#cb4-68"></a>)</span>
<span id="cb4-69"><a href="#cb4-69"></a></span>
<span id="cb4-70"><a href="#cb4-70"></a></span>
<span id="cb4-71"><a href="#cb4-71"></a></span>
<span id="cb4-72"><a href="#cb4-72"></a><span class="co"># directory path configuration -----------------------------------------------</span></span>
<span id="cb4-73"><a href="#cb4-73"></a><span class="co"># save path (customise for your own computer) ----------------------------</span></span>
<span id="cb4-74"><a href="#cb4-74"></a>push_mods <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"save_directory"</span>) </span>
<span id="cb4-75"><a href="#cb4-75"></a></span>
<span id="cb4-76"><a href="#cb4-76"></a><span class="co"># read original data (for plots) ------------------------------------------</span></span>
<span id="cb4-77"><a href="#cb4-77"></a>original_df <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"df_wide"</span>, push_mods)</span>
<span id="cb4-78"><a href="#cb4-78"></a></span>
<span id="cb4-79"><a href="#cb4-79"></a><span class="co"># plot title --------------------------------------------------------------</span></span>
<span id="cb4-80"><a href="#cb4-80"></a>title_binary <span class="ot">=</span> <span class="st">"Effects of {{name_exposure}} on {{name_outcomes}}"</span></span>
<span id="cb4-81"><a href="#cb4-81"></a>filename_prefix <span class="ot">=</span> <span class="st">"grf_extraversion_wb"</span></span>
<span id="cb4-82"><a href="#cb4-82"></a></span>
<span id="cb4-83"><a href="#cb4-83"></a><span class="co"># for manuscript later</span></span>
<span id="cb4-84"><a href="#cb4-84"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(title_binary,<span class="st">"title_binary"</span>)</span>
<span id="cb4-85"><a href="#cb4-85"></a></span>
<span id="cb4-86"><a href="#cb4-86"></a><span class="co"># import names ------------------------------------------------------------</span></span>
<span id="cb4-87"><a href="#cb4-87"></a>name_exposure <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"name_exposure"</span>)</span>
<span id="cb4-88"><a href="#cb4-88"></a>name_exposure</span>
<span id="cb4-89"><a href="#cb4-89"></a></span>
<span id="cb4-90"><a href="#cb4-90"></a><span class="co"># make exposure names</span></span>
<span id="cb4-91"><a href="#cb4-91"></a>t1_name_exposure_binary <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t1_"</span>, name_exposure, <span class="st">"_binary"</span>)</span>
<span id="cb4-92"><a href="#cb4-92"></a></span>
<span id="cb4-93"><a href="#cb4-93"></a><span class="co"># check exposure name</span></span>
<span id="cb4-94"><a href="#cb4-94"></a>t1_name_exposure_binary</span>
<span id="cb4-95"><a href="#cb4-95"></a></span>
<span id="cb4-96"><a href="#cb4-96"></a><span class="co"># read outcome vars</span></span>
<span id="cb4-97"><a href="#cb4-97"></a>outcome_vars <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"outcome_vars"</span>)</span>
<span id="cb4-98"><a href="#cb4-98"></a></span>
<span id="cb4-99"><a href="#cb4-99"></a><span class="co"># read and sort outcome variables -----------------------------------------</span></span>
<span id="cb4-100"><a href="#cb4-100"></a><span class="co"># we do this by domain: health, psych, present, life, social</span></span>
<span id="cb4-101"><a href="#cb4-101"></a>read_and_sort <span class="ot">&lt;-</span> <span class="cf">function</span>(key) {</span>
<span id="cb4-102"><a href="#cb4-102"></a>  raw  <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(key, push_mods)</span>
<span id="cb4-103"><a href="#cb4-103"></a>  vars <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t2_"</span>, raw, <span class="st">"_z"</span>)</span>
<span id="cb4-104"><a href="#cb4-104"></a>  <span class="fu">sort</span>(vars)</span>
<span id="cb4-105"><a href="#cb4-105"></a>}</span>
<span id="cb4-106"><a href="#cb4-106"></a>t2_outcome_z  <span class="ot">&lt;-</span> <span class="fu">read_and_sort</span>(<span class="st">"outcome_vars"</span>)</span>
<span id="cb4-107"><a href="#cb4-107"></a></span>
<span id="cb4-108"><a href="#cb4-108"></a><span class="co"># view</span></span>
<span id="cb4-109"><a href="#cb4-109"></a>t2_outcome_z</span>
<span id="cb4-110"><a href="#cb4-110"></a></span>
<span id="cb4-111"><a href="#cb4-111"></a></span>
<span id="cb4-112"><a href="#cb4-112"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-113"><a href="#cb4-113"></a><span class="co"># |     </span><span class="re">END</span><span class="co"> DO NOT ALTER     |</span></span>
<span id="cb4-114"><a href="#cb4-114"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-115"><a href="#cb4-115"></a></span>
<span id="cb4-116"><a href="#cb4-116"></a></span>
<span id="cb4-117"><a href="#cb4-117"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-118"><a href="#cb4-118"></a><span class="co"># |    MODIFY THIS SECTION   |</span></span>
<span id="cb4-119"><a href="#cb4-119"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-120"><a href="#cb4-120"></a></span>
<span id="cb4-121"><a href="#cb4-121"></a></span>
<span id="cb4-122"><a href="#cb4-122"></a><span class="co"># define names for titles -------------------------------------------------</span></span>
<span id="cb4-123"><a href="#cb4-123"></a></span>
<span id="cb4-124"><a href="#cb4-124"></a>nice_exposure_name <span class="ot">=</span>  stringr<span class="sc">::</span><span class="fu">str_to_sentence</span>(name_exposure)</span>
<span id="cb4-125"><a href="#cb4-125"></a>nice_outcome_name <span class="ot">=</span> <span class="st">"Wellbeing"</span></span>
<span id="cb4-126"><a href="#cb4-126"></a>title <span class="ot">=</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Effect of {nice_exposure_name} on {nice_outcome_name}"</span>)</span>
<span id="cb4-127"><a href="#cb4-127"></a>title</span>
<span id="cb4-128"><a href="#cb4-128"></a><span class="co"># save for final rport</span></span>
<span id="cb4-129"><a href="#cb4-129"></a><span class="fu">here_save</span>(title, <span class="st">"title"</span>)</span>
<span id="cb4-130"><a href="#cb4-130"></a></span>
<span id="cb4-131"><a href="#cb4-131"></a><span class="co"># combine outcomes ---------------------------------------------------------</span></span>
<span id="cb4-132"><a href="#cb4-132"></a><span class="co"># check outcome vars and make labels for graphs/tables</span></span>
<span id="cb4-133"><a href="#cb4-133"></a>outcome_vars</span>
<span id="cb4-134"><a href="#cb4-134"></a></span>
<span id="cb4-135"><a href="#cb4-135"></a></span>
<span id="cb4-136"><a href="#cb4-136"></a>label_mapping_all <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-137"><a href="#cb4-137"></a>  <span class="co">#"t2_alcohol_frequency_weekly_z" = "Alcohol Frequency",</span></span>
<span id="cb4-138"><a href="#cb4-138"></a>  <span class="co">#"t2_alcohol_intensity_weekly_z" = "Alcohol Intensity",</span></span>
<span id="cb4-139"><a href="#cb4-139"></a>  <span class="co">#"t2_hlth_bmi_z" = "BMI",</span></span>
<span id="cb4-140"><a href="#cb4-140"></a>  <span class="co">#"t2_hlth_sleep_hours_z" = "Sleep",</span></span>
<span id="cb4-141"><a href="#cb4-141"></a>  <span class="st">"t2_log_hours_exercise_z"</span> <span class="ot">=</span> <span class="st">"Hours of Exercise (log)"</span>,</span>
<span id="cb4-142"><a href="#cb4-142"></a>  <span class="co">#"t2_short_form_health_z" = "Short Form Health"</span></span>
<span id="cb4-143"><a href="#cb4-143"></a>  <span class="st">"t2_hlth_fatigue_z"</span> <span class="ot">=</span> <span class="st">"Fatigue"</span>,</span>
<span id="cb4-144"><a href="#cb4-144"></a>  <span class="st">"t2_kessler_latent_anxiety_z"</span> <span class="ot">=</span> <span class="st">"Anxiety"</span>,</span>
<span id="cb4-145"><a href="#cb4-145"></a>  <span class="st">"t2_kessler_latent_depression_z"</span> <span class="ot">=</span> <span class="st">"Depression"</span>,</span>
<span id="cb4-146"><a href="#cb4-146"></a>  <span class="st">"t2_rumination_z"</span> <span class="ot">=</span> <span class="st">"Rumination"</span>,</span>
<span id="cb4-147"><a href="#cb4-147"></a>  <span class="co"># "t2_bodysat_z" = "Body Satisfaction",</span></span>
<span id="cb4-148"><a href="#cb4-148"></a>  <span class="st">"t2_foregiveness_z"</span> <span class="ot">=</span> <span class="st">"Forgiveness"</span>,</span>
<span id="cb4-149"><a href="#cb4-149"></a>  <span class="st">"t2_perfectionism_z"</span> <span class="ot">=</span> <span class="st">"Perfectionism"</span>, </span>
<span id="cb4-150"><a href="#cb4-150"></a>  <span class="st">"t2_self_esteem_z"</span> <span class="ot">=</span> <span class="st">"Self Esteem"</span>,</span>
<span id="cb4-151"><a href="#cb4-151"></a>  <span class="co"># "t2_self_control_z" = "Self Control",</span></span>
<span id="cb4-152"><a href="#cb4-152"></a>  <span class="co"># "t2_sexual_satisfaction_z" = "Sexual Satisfaction".</span></span>
<span id="cb4-153"><a href="#cb4-153"></a>  <span class="st">"t2_gratitude_z"</span> <span class="ot">=</span> <span class="st">"Gratitude"</span>,</span>
<span id="cb4-154"><a href="#cb4-154"></a>  <span class="st">"t2_lifesat_z"</span> <span class="ot">=</span> <span class="st">"Life Satisfaction"</span>,</span>
<span id="cb4-155"><a href="#cb4-155"></a>  <span class="st">"t2_meaning_purpose_z"</span> <span class="ot">=</span> <span class="st">"Meaning: Purpose"</span>,</span>
<span id="cb4-156"><a href="#cb4-156"></a>  <span class="st">"t2_meaning_sense_z"</span> <span class="ot">=</span> <span class="st">"Meaning: Sense"</span>,</span>
<span id="cb4-157"><a href="#cb4-157"></a>  <span class="st">"t2_pwi_z"</span> <span class="ot">=</span> <span class="st">"Personal Well-being Index"</span>,</span>
<span id="cb4-158"><a href="#cb4-158"></a>  <span class="st">"t2_belong_z"</span> <span class="ot">=</span> <span class="st">"Social Belonging"</span>,</span>
<span id="cb4-159"><a href="#cb4-159"></a>  <span class="st">"t2_neighbourhood_community_z"</span> <span class="ot">=</span> <span class="st">"Neighbourhood Community"</span>,</span>
<span id="cb4-160"><a href="#cb4-160"></a>  <span class="st">"t2_support_z"</span> <span class="ot">=</span> <span class="st">"Social Support"</span></span>
<span id="cb4-161"><a href="#cb4-161"></a>)</span>
<span id="cb4-162"><a href="#cb4-162"></a></span>
<span id="cb4-163"><a href="#cb4-163"></a></span>
<span id="cb4-164"><a href="#cb4-164"></a><span class="co"># save</span></span>
<span id="cb4-165"><a href="#cb4-165"></a><span class="fu">here_save</span>(label_mapping_all, <span class="st">"label_mapping_all"</span>)</span>
<span id="cb4-166"><a href="#cb4-166"></a></span>
<span id="cb4-167"><a href="#cb4-167"></a><span class="co"># check</span></span>
<span id="cb4-168"><a href="#cb4-168"></a>label_mapping_all</span>
<span id="cb4-169"><a href="#cb4-169"></a></span>
<span id="cb4-170"><a href="#cb4-170"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"created and saved label_mapping for use in graphs/tables ✔"</span>)</span>
<span id="cb4-171"><a href="#cb4-171"></a></span>
<span id="cb4-172"><a href="#cb4-172"></a></span>
<span id="cb4-173"><a href="#cb4-173"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-174"><a href="#cb4-174"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb4-175"><a href="#cb4-175"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-176"><a href="#cb4-176"></a><span class="co"># select options that make sense fo your study/results</span></span>
<span id="cb4-177"><a href="#cb4-177"></a><span class="co"># might need to be tweaked after the analysis</span></span>
<span id="cb4-178"><a href="#cb4-178"></a></span>
<span id="cb4-179"><a href="#cb4-179"></a><span class="co"># make options -------------------------------------------------------------</span></span>
<span id="cb4-180"><a href="#cb4-180"></a><span class="co"># titles</span></span>
<span id="cb4-181"><a href="#cb4-181"></a>ate_title <span class="ot">=</span> <span class="st">"ATE Effects of {{nice_name_exposure}} on {{nice_name_outcome}}"</span></span>
<span id="cb4-182"><a href="#cb4-182"></a>subtitle <span class="ot">=</span> <span class="st">""</span></span>
<span id="cb4-183"><a href="#cb4-183"></a>filename_prefix <span class="ot">=</span> <span class="st">"final_report"</span></span>
<span id="cb4-184"><a href="#cb4-184"></a><span class="co">#</span></span>
<span id="cb4-185"><a href="#cb4-185"></a><span class="fu">here_save</span>(ate_title, <span class="st">"ate_title"</span>)</span>
<span id="cb4-186"><a href="#cb4-186"></a><span class="fu">here_save</span>(filename_prefix, <span class="st">"filename_prefix"</span>)</span>
<span id="cb4-187"><a href="#cb4-187"></a></span>
<span id="cb4-188"><a href="#cb4-188"></a><span class="co"># settings</span></span>
<span id="cb4-189"><a href="#cb4-189"></a>x_offset <span class="ot">=</span> <span class="sc">-</span>.<span class="dv">5</span></span>
<span id="cb4-190"><a href="#cb4-190"></a>x_lim_lo <span class="ot">=</span> <span class="sc">-</span>.<span class="dv">5</span></span>
<span id="cb4-191"><a href="#cb4-191"></a>x_lim_hi <span class="ot">=</span> .<span class="dv">5</span></span>
<span id="cb4-192"><a href="#cb4-192"></a></span>
<span id="cb4-193"><a href="#cb4-193"></a></span>
<span id="cb4-194"><a href="#cb4-194"></a><span class="co"># defaults for ate plots</span></span>
<span id="cb4-195"><a href="#cb4-195"></a>base_defaults_binary <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-196"><a href="#cb4-196"></a>  <span class="at">type =</span> <span class="st">"RD"</span>,</span>
<span id="cb4-197"><a href="#cb4-197"></a>  <span class="at">title =</span> ate_title,</span>
<span id="cb4-198"><a href="#cb4-198"></a>  <span class="at">e_val_bound_threshold =</span> <span class="fl">1.2</span>,</span>
<span id="cb4-199"><a href="#cb4-199"></a>  <span class="at">colors =</span> <span class="fu">c</span>(</span>
<span id="cb4-200"><a href="#cb4-200"></a>    <span class="st">"positive"</span> <span class="ot">=</span> <span class="st">"#E69F00"</span>,</span>
<span id="cb4-201"><a href="#cb4-201"></a>    <span class="st">"not reliable"</span> <span class="ot">=</span> <span class="st">"grey50"</span>,</span>
<span id="cb4-202"><a href="#cb4-202"></a>    <span class="st">"negative"</span> <span class="ot">=</span> <span class="st">"#56B4E9"</span></span>
<span id="cb4-203"><a href="#cb4-203"></a>  ),</span>
<span id="cb4-204"><a href="#cb4-204"></a>  <span class="at">x_offset =</span> x_offset,</span>
<span id="cb4-205"><a href="#cb4-205"></a>  <span class="co"># will be set based on type</span></span>
<span id="cb4-206"><a href="#cb4-206"></a>  <span class="at">x_lim_lo =</span> x_lim_lo,</span>
<span id="cb4-207"><a href="#cb4-207"></a>  <span class="co"># will be set based on type</span></span>
<span id="cb4-208"><a href="#cb4-208"></a>  <span class="at">x_lim_hi =</span> x_lim_hi,</span>
<span id="cb4-209"><a href="#cb4-209"></a>  <span class="at">text_size =</span> <span class="dv">4</span>,</span>
<span id="cb4-210"><a href="#cb4-210"></a>  <span class="at">linewidth =</span> <span class="fl">0.5</span>,</span>
<span id="cb4-211"><a href="#cb4-211"></a>  <span class="at">estimate_scale =</span> <span class="dv">1</span>,</span>
<span id="cb4-212"><a href="#cb4-212"></a>  <span class="at">base_size =</span> <span class="dv">18</span>,</span>
<span id="cb4-213"><a href="#cb4-213"></a>  <span class="at">point_size =</span> <span class="dv">2</span>,</span>
<span id="cb4-214"><a href="#cb4-214"></a>  <span class="at">title_size =</span> <span class="dv">19</span>,</span>
<span id="cb4-215"><a href="#cb4-215"></a>  <span class="at">subtitle_size =</span> <span class="dv">16</span>,</span>
<span id="cb4-216"><a href="#cb4-216"></a>  <span class="at">legend_text_size =</span> <span class="dv">10</span>,</span>
<span id="cb4-217"><a href="#cb4-217"></a>  <span class="at">legend_title_size =</span> <span class="dv">10</span>,</span>
<span id="cb4-218"><a href="#cb4-218"></a>  <span class="at">include_coefficients =</span> <span class="cn">FALSE</span></span>
<span id="cb4-219"><a href="#cb4-219"></a>)</span>
<span id="cb4-220"><a href="#cb4-220"></a></span>
<span id="cb4-221"><a href="#cb4-221"></a><span class="co"># save</span></span>
<span id="cb4-222"><a href="#cb4-222"></a></span>
<span id="cb4-223"><a href="#cb4-223"></a><span class="co"># health graph options</span></span>
<span id="cb4-224"><a href="#cb4-224"></a>outcomes_options_all <span class="ot">&lt;-</span> <span class="fu">margot_plot_create_options</span>(</span>
<span id="cb4-225"><a href="#cb4-225"></a>  <span class="at">title =</span> subtitle,</span>
<span id="cb4-226"><a href="#cb4-226"></a>  <span class="at">base_defaults =</span> base_defaults_binary,</span>
<span id="cb4-227"><a href="#cb4-227"></a>  <span class="at">subtitle =</span> subtitle,</span>
<span id="cb4-228"><a href="#cb4-228"></a>  <span class="at">filename_prefix =</span> filename_prefix</span>
<span id="cb4-229"><a href="#cb4-229"></a>)</span>
<span id="cb4-230"><a href="#cb4-230"></a></span>
<span id="cb4-231"><a href="#cb4-231"></a></span>
<span id="cb4-232"><a href="#cb4-232"></a><span class="co"># policy tree graph settings ----------------------------------------------</span></span>
<span id="cb4-233"><a href="#cb4-233"></a>decision_tree_defaults <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-234"><a href="#cb4-234"></a>  <span class="at">span_ratio       =</span> .<span class="dv">3</span>,</span>
<span id="cb4-235"><a href="#cb4-235"></a>  <span class="at">text_size        =</span> <span class="fl">3.8</span>,</span>
<span id="cb4-236"><a href="#cb4-236"></a>  <span class="at">y_padding        =</span> <span class="fl">0.25</span>,</span>
<span id="cb4-237"><a href="#cb4-237"></a>  <span class="at">edge_label_offset =</span> .<span class="dv">002</span>,</span>
<span id="cb4-238"><a href="#cb4-238"></a>  <span class="at">border_size      =</span> .<span class="dv">05</span></span>
<span id="cb4-239"><a href="#cb4-239"></a>)</span>
<span id="cb4-240"><a href="#cb4-240"></a>policy_tree_defaults <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-241"><a href="#cb4-241"></a>  <span class="at">point_alpha       =</span> .<span class="dv">5</span>,</span>
<span id="cb4-242"><a href="#cb4-242"></a>  <span class="at">title_size        =</span> <span class="dv">12</span>,</span>
<span id="cb4-243"><a href="#cb4-243"></a>  <span class="at">subtitle_size     =</span> <span class="dv">12</span>,</span>
<span id="cb4-244"><a href="#cb4-244"></a>  <span class="at">axis_title_size   =</span> <span class="dv">12</span>,</span>
<span id="cb4-245"><a href="#cb4-245"></a>  <span class="at">legend_title_size =</span> <span class="dv">12</span>,</span>
<span id="cb4-246"><a href="#cb4-246"></a>  <span class="at">split_line_color  =</span> <span class="st">"red"</span>,</span>
<span id="cb4-247"><a href="#cb4-247"></a>  <span class="at">split_line_alpha  =</span> .<span class="dv">8</span>,</span>
<span id="cb4-248"><a href="#cb4-248"></a>  <span class="at">split_label_color =</span> <span class="st">"red"</span>,</span>
<span id="cb4-249"><a href="#cb4-249"></a>  <span class="fu">list</span>(<span class="at">split_label_nudge_factor =</span> <span class="fl">0.007</span>)</span>
<span id="cb4-250"><a href="#cb4-250"></a>)</span>
<span id="cb4-251"><a href="#cb4-251"></a></span>
<span id="cb4-252"><a href="#cb4-252"></a></span>
<span id="cb4-253"><a href="#cb4-253"></a></span>
<span id="cb4-254"><a href="#cb4-254"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-255"><a href="#cb4-255"></a><span class="co"># |   </span><span class="re">END</span><span class="co"> MODIFY SECTION     |</span></span>
<span id="cb4-256"><a href="#cb4-256"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-257"><a href="#cb4-257"></a></span>
<span id="cb4-258"><a href="#cb4-258"></a><span class="co"># +----------------------------------------------+</span></span>
<span id="cb4-259"><a href="#cb4-259"></a><span class="co"># |       DO NOT ALTER  (except where noted)     |</span></span>
<span id="cb4-260"><a href="#cb4-260"></a><span class="co"># +----------------------------------------------+</span></span>
<span id="cb4-261"><a href="#cb4-261"></a></span>
<span id="cb4-262"><a href="#cb4-262"></a><span class="co"># load GRF data and prepare inputs ----------------------------------------</span></span>
<span id="cb4-263"><a href="#cb4-263"></a>df_grf <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">'df_grf'</span>, push_mods)</span>
<span id="cb4-264"><a href="#cb4-264"></a>E      <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">'E'</span>,      push_mods)</span>
<span id="cb4-265"><a href="#cb4-265"></a><span class="co"># check exposure binary</span></span>
<span id="cb4-266"><a href="#cb4-266"></a><span class="fu">stopifnot</span>(<span class="fu">all</span>(df_grf[[t1_name_exposure_binary]][<span class="sc">!</span><span class="fu">is.na</span>(df_grf[[t1_name_exposure_binary]])] <span class="sc">%in%</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>))</span>
<span id="cb4-267"><a href="#cb4-267"></a><span class="co"># set exposure and weights</span></span>
<span id="cb4-268"><a href="#cb4-268"></a></span>
<span id="cb4-269"><a href="#cb4-269"></a>W       <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(df_grf[[t1_name_exposure_binary]]) <span class="co"># note it is the processed weights for attrition "t1"</span></span>
<span id="cb4-270"><a href="#cb4-270"></a></span>
<span id="cb4-271"><a href="#cb4-271"></a><span class="co"># old workflow</span></span>
<span id="cb4-272"><a href="#cb4-272"></a><span class="co"># weights &lt;- df_grf$t1_adjusted_weights</span></span>
<span id="cb4-273"><a href="#cb4-273"></a></span>
<span id="cb4-274"><a href="#cb4-274"></a><span class="co"># new weights workflow, use "combo_weights" -- see revised script 2</span></span>
<span id="cb4-275"><a href="#cb4-275"></a>weights<span class="ot">&lt;-</span> df_grf<span class="sc">$</span>combo_weights</span>
<span id="cb4-276"><a href="#cb4-276"></a></span>
<span id="cb4-277"><a href="#cb4-277"></a><span class="fu">hist</span>(weights) <span class="co"># quick check for extreme weights</span></span>
<span id="cb4-278"><a href="#cb4-278"></a><span class="co"># select covariates and drop numeric attributes</span></span>
<span id="cb4-279"><a href="#cb4-279"></a>X <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">remove_numeric_attributes</span>(df_grf[E])</span>
<span id="cb4-280"><a href="#cb4-280"></a></span>
<span id="cb4-281"><a href="#cb4-281"></a></span>
<span id="cb4-282"><a href="#cb4-282"></a><span class="co"># set model defaults -----------------------------------------------------</span></span>
<span id="cb4-283"><a href="#cb4-283"></a>grf_defaults <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">seed =</span> <span class="dv">123</span>, <span class="at">stabilize.splits =</span> <span class="cn">TRUE</span>, <span class="at">num.trees =</span> <span class="dv">2000</span>)</span>
<span id="cb4-284"><a href="#cb4-284"></a></span>
<span id="cb4-285"><a href="#cb4-285"></a></span>
<span id="cb4-286"><a href="#cb4-286"></a><span class="co"># example: fit causal forest on a toy subset ------------------------------</span></span>
<span id="cb4-287"><a href="#cb4-287"></a><span class="co"># first, create a smaller test sample</span></span>
<span id="cb4-288"><a href="#cb4-288"></a>n   <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X)</span>
<span id="cb4-289"><a href="#cb4-289"></a>toy <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">seq_len</span>(n), <span class="fu">floor</span>(n <span class="sc">/</span> <span class="dv">4</span>))</span>
<span id="cb4-290"><a href="#cb4-290"></a><span class="co"># define toy data</span></span>
<span id="cb4-291"><a href="#cb4-291"></a>toy_data     <span class="ot">&lt;-</span> df_grf[toy, ]</span>
<span id="cb4-292"><a href="#cb4-292"></a>X_toy        <span class="ot">&lt;-</span> X[toy, ]</span>
<span id="cb4-293"><a href="#cb4-293"></a>W_toy        <span class="ot">&lt;-</span> W[toy]</span>
<span id="cb4-294"><a href="#cb4-294"></a>weights_toy  <span class="ot">&lt;-</span> weights[toy]</span>
<span id="cb4-295"><a href="#cb4-295"></a></span>
<span id="cb4-296"><a href="#cb4-296"></a><span class="co"># fit the model</span></span>
<span id="cb4-297"><a href="#cb4-297"></a>cf_out <span class="ot">&lt;-</span> <span class="fu">margot_causal_forest_parallel</span>( <span class="co">#&lt;- new function ***</span></span>
<span id="cb4-298"><a href="#cb4-298"></a>  <span class="at">data         =</span> toy_data,</span>
<span id="cb4-299"><a href="#cb4-299"></a>  <span class="co"># +--------------------------+</span></span>
<span id="cb4-300"><a href="#cb4-300"></a>  <span class="co"># |    MODIFY THIS           | </span></span>
<span id="cb4-301"><a href="#cb4-301"></a>  <span class="co"># +--------------------------+</span></span>
<span id="cb4-302"><a href="#cb4-302"></a>  <span class="at">outcome_vars =</span> <span class="fu">c</span>(<span class="st">"t2_kessler_latent_depression_z"</span>, <span class="st">"t2_kessler_latent_anxiety_z"</span>), <span class="co"># select variable in your outcome_variable set</span></span>
<span id="cb4-303"><a href="#cb4-303"></a>  <span class="co"># +--------------------------+</span></span>
<span id="cb4-304"><a href="#cb4-304"></a>  <span class="co"># |   </span><span class="re">END</span><span class="co"> MODIFY             |</span></span>
<span id="cb4-305"><a href="#cb4-305"></a>  <span class="co"># +--------------------------+</span></span>
<span id="cb4-306"><a href="#cb4-306"></a>  <span class="at">covariates   =</span> X_toy,</span>
<span id="cb4-307"><a href="#cb4-307"></a>  <span class="at">W            =</span> W_toy,</span>
<span id="cb4-308"><a href="#cb4-308"></a>  <span class="at">weights      =</span> weights_toy,</span>
<span id="cb4-309"><a href="#cb4-309"></a>  <span class="at">save_data    =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-310"><a href="#cb4-310"></a>  <span class="at">save_models  =</span> <span class="cn">TRUE</span></span>
<span id="cb4-311"><a href="#cb4-311"></a>)</span>
<span id="cb4-312"><a href="#cb4-312"></a></span>
<span id="cb4-313"><a href="#cb4-313"></a><span class="co"># inspect propensities ------------------------------------------------------</span></span>
<span id="cb4-314"><a href="#cb4-314"></a>qini_tbl <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_inspect_qini</span>(cf_out, <span class="at">propensity_bounds =</span> <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.97</span>))</span>
<span id="cb4-315"><a href="#cb4-315"></a></span>
<span id="cb4-316"><a href="#cb4-316"></a><span class="co"># show</span></span>
<span id="cb4-317"><a href="#cb4-317"></a><span class="fu">print</span>(qini_tbl)</span>
<span id="cb4-318"><a href="#cb4-318"></a></span>
<span id="cb4-319"><a href="#cb4-319"></a><span class="co"># plot policy-combo trees --------------------------------------------------</span></span>
<span id="cb4-320"><a href="#cb4-320"></a>combo1 <span class="ot">&lt;-</span> <span class="fu">margot_plot_policy_combo</span>(</span>
<span id="cb4-321"><a href="#cb4-321"></a>  <span class="at">result_object    =</span> cf_out,</span>
<span id="cb4-322"><a href="#cb4-322"></a>  <span class="co"># +--------------------------+</span></span>
<span id="cb4-323"><a href="#cb4-323"></a>  <span class="co"># |    MODIFY THIS           |</span></span>
<span id="cb4-324"><a href="#cb4-324"></a>  <span class="co"># +--------------------------+</span></span>
<span id="cb4-325"><a href="#cb4-325"></a>  <span class="at">model_name       =</span> <span class="st">"model_t2_kessler_latent_depression_z"</span>,</span>
<span id="cb4-326"><a href="#cb4-326"></a>  <span class="co"># +--------------------------+</span></span>
<span id="cb4-327"><a href="#cb4-327"></a>  <span class="co"># |   </span><span class="re">END</span><span class="co"> MODIFY             |</span></span>
<span id="cb4-328"><a href="#cb4-328"></a>  <span class="co"># +--------------------------+</span></span>
<span id="cb4-329"><a href="#cb4-329"></a>  <span class="at">max_depth        =</span> <span class="dv">1</span>L,          <span class="co"># depth-1 tree</span></span>
<span id="cb4-330"><a href="#cb4-330"></a>  <span class="at">decision_tree_args =</span> <span class="fu">list</span>(<span class="at">text_size =</span> <span class="dv">4</span>),</span>
<span id="cb4-331"><a href="#cb4-331"></a>  <span class="at">policy_tree_args   =</span> <span class="fu">list</span>(<span class="at">point_alpha =</span> <span class="fl">0.7</span>),</span>
<span id="cb4-332"><a href="#cb4-332"></a>  <span class="at">original_df        =</span> original_df,</span>
<span id="cb4-333"><a href="#cb4-333"></a>  <span class="at">label_mapping      =</span> label_mapping_all</span>
<span id="cb4-334"><a href="#cb4-334"></a>)</span>
<span id="cb4-335"><a href="#cb4-335"></a></span>
<span id="cb4-336"><a href="#cb4-336"></a><span class="co"># show</span></span>
<span id="cb4-337"><a href="#cb4-337"></a>combo1<span class="sc">$</span>combined_plot</span>
<span id="cb4-338"><a href="#cb4-338"></a></span>
<span id="cb4-339"><a href="#cb4-339"></a><span class="co"># you can repeat for depth-2 ----------------------------------------------</span></span>
<span id="cb4-340"><a href="#cb4-340"></a>combo2 <span class="ot">&lt;-</span> <span class="fu">margot_plot_policy_combo</span>(</span>
<span id="cb4-341"><a href="#cb4-341"></a>  <span class="at">result_object    =</span> cf_out,</span>
<span id="cb4-342"><a href="#cb4-342"></a>  <span class="co"># +--------------------------+</span></span>
<span id="cb4-343"><a href="#cb4-343"></a>  <span class="co"># |    MODIFY THIS           |</span></span>
<span id="cb4-344"><a href="#cb4-344"></a>  <span class="co"># +--------------------------+</span></span>
<span id="cb4-345"><a href="#cb4-345"></a>  <span class="at">model_name       =</span> <span class="st">"model_t2_kessler_latent_depression_z"</span>,</span>
<span id="cb4-346"><a href="#cb4-346"></a>  <span class="co"># +--------------------------+</span></span>
<span id="cb4-347"><a href="#cb4-347"></a>  <span class="co"># |   </span><span class="re">END</span><span class="co"> MODIFY             |</span></span>
<span id="cb4-348"><a href="#cb4-348"></a>  <span class="co"># +--------------------------+</span></span>
<span id="cb4-349"><a href="#cb4-349"></a>  <span class="at">max_depth        =</span> <span class="dv">2</span>L,</span>
<span id="cb4-350"><a href="#cb4-350"></a>  <span class="at">decision_tree_args =</span> decision_tree_defaults,</span>
<span id="cb4-351"><a href="#cb4-351"></a>  <span class="at">policy_tree_args   =</span> policy_tree_defaults,</span>
<span id="cb4-352"><a href="#cb4-352"></a>  <span class="at">original_df        =</span> original_df,</span>
<span id="cb4-353"><a href="#cb4-353"></a>  <span class="at">label_mapping      =</span> label_mapping_all</span>
<span id="cb4-354"><a href="#cb4-354"></a>)</span>
<span id="cb4-355"><a href="#cb4-355"></a></span>
<span id="cb4-356"><a href="#cb4-356"></a><span class="co"># show</span></span>
<span id="cb4-357"><a href="#cb4-357"></a>combo2<span class="sc">$</span>combined_plot</span>
<span id="cb4-358"><a href="#cb4-358"></a></span>
<span id="cb4-359"><a href="#cb4-359"></a><span class="co"># batch plotting ----------------------------------------------------------</span></span>
<span id="cb4-360"><a href="#cb4-360"></a>models_batch_1L <span class="ot">&lt;-</span> <span class="fu">margot_policy</span>(</span>
<span id="cb4-361"><a href="#cb4-361"></a>  cf_out,</span>
<span id="cb4-362"><a href="#cb4-362"></a>  <span class="at">save_plots         =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-363"><a href="#cb4-363"></a>  <span class="at">output_dir         =</span> here<span class="sc">::</span><span class="fu">here</span>(push_mods),</span>
<span id="cb4-364"><a href="#cb4-364"></a>  <span class="at">decision_tree_args =</span> decision_tree_defaults,</span>
<span id="cb4-365"><a href="#cb4-365"></a>  <span class="at">policy_tree_args   =</span> policy_tree_defaults,</span>
<span id="cb4-366"><a href="#cb4-366"></a>  <span class="co"># +--------------------------+</span></span>
<span id="cb4-367"><a href="#cb4-367"></a>  <span class="co"># |    MODIFY THIS           |</span></span>
<span id="cb4-368"><a href="#cb4-368"></a>  <span class="co"># +--------------------------+</span></span>
<span id="cb4-369"><a href="#cb4-369"></a>  <span class="at">model_names        =</span> <span class="st">"model_t2_kessler_latent_depression_z"</span>,</span>
<span id="cb4-370"><a href="#cb4-370"></a>  <span class="co"># +--------------------------+</span></span>
<span id="cb4-371"><a href="#cb4-371"></a>  <span class="co"># |   </span><span class="re">END</span><span class="co"> MODIFY             |</span></span>
<span id="cb4-372"><a href="#cb4-372"></a>  <span class="co"># +--------------------------+</span></span>
<span id="cb4-373"><a href="#cb4-373"></a>  <span class="at">original_df        =</span> original_df,</span>
<span id="cb4-374"><a href="#cb4-374"></a>  <span class="at">label_mapping      =</span> label_mapping_all,</span>
<span id="cb4-375"><a href="#cb4-375"></a>  <span class="at">max_depth          =</span> <span class="dv">1</span>L</span>
<span id="cb4-376"><a href="#cb4-376"></a>)</span>
<span id="cb4-377"><a href="#cb4-377"></a></span>
<span id="cb4-378"><a href="#cb4-378"></a><span class="co"># view first model's plots</span></span>
<span id="cb4-379"><a href="#cb4-379"></a>models_batch_1L[[<span class="dv">1</span>]][[<span class="dv">3</span>]]  <span class="co"># combo plot</span></span>
<span id="cb4-380"><a href="#cb4-380"></a>models_batch_1L[[<span class="dv">1</span>]][[<span class="dv">4</span>]]  <span class="co"># qini plot</span></span>
<span id="cb4-381"><a href="#cb4-381"></a></span>
<span id="cb4-382"><a href="#cb4-382"></a><span class="co"># sub plots</span></span>
<span id="cb4-383"><a href="#cb4-383"></a>models_batch_1L[[<span class="dv">1</span>]][[<span class="dv">1</span>]]  <span class="co"># predictions of policy tree</span></span>
<span id="cb4-384"><a href="#cb4-384"></a>models_batch_1L[[<span class="dv">1</span>]][[<span class="dv">2</span>]]  <span class="co"># policy tree</span></span>
<span id="cb4-385"><a href="#cb4-385"></a></span>
<span id="cb4-386"><a href="#cb4-386"></a><span class="co"># qini interpretations at different spends</span></span>
<span id="cb4-387"><a href="#cb4-387"></a><span class="co"># negative is bad</span></span>
<span id="cb4-388"><a href="#cb4-388"></a>models_batch_1L[[<span class="dv">1</span>]][[<span class="dv">5</span>]]  </span>
<span id="cb4-389"><a href="#cb4-389"></a></span>
<span id="cb4-390"><a href="#cb4-390"></a><span class="co"># 2L tree</span></span>
<span id="cb4-391"><a href="#cb4-391"></a>models_batch_2L <span class="ot">&lt;-</span> <span class="fu">margot_policy</span>(</span>
<span id="cb4-392"><a href="#cb4-392"></a>  cf_out,</span>
<span id="cb4-393"><a href="#cb4-393"></a>  <span class="at">save_plots         =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-394"><a href="#cb4-394"></a>  <span class="at">output_dir         =</span> here<span class="sc">::</span><span class="fu">here</span>(push_mods),</span>
<span id="cb4-395"><a href="#cb4-395"></a>  <span class="at">decision_tree_args =</span> decision_tree_defaults,</span>
<span id="cb4-396"><a href="#cb4-396"></a>  <span class="at">policy_tree_args   =</span> policy_tree_defaults,</span>
<span id="cb4-397"><a href="#cb4-397"></a>  <span class="co"># +--------------------------+</span></span>
<span id="cb4-398"><a href="#cb4-398"></a>  <span class="co"># |    MODIFY THIS           |</span></span>
<span id="cb4-399"><a href="#cb4-399"></a>  <span class="co"># +--------------------------+</span></span>
<span id="cb4-400"><a href="#cb4-400"></a>  <span class="at">model_names        =</span> <span class="st">"model_t2_kessler_latent_depression_z"</span>,</span>
<span id="cb4-401"><a href="#cb4-401"></a>  <span class="co"># +--------------------------+</span></span>
<span id="cb4-402"><a href="#cb4-402"></a>  <span class="co"># |   </span><span class="re">END</span><span class="co"> MODIFY             |</span></span>
<span id="cb4-403"><a href="#cb4-403"></a>  <span class="co"># +--------------------------+</span></span>
<span id="cb4-404"><a href="#cb4-404"></a>  <span class="at">original_df        =</span> original_df,</span>
<span id="cb4-405"><a href="#cb4-405"></a>  <span class="at">label_mapping      =</span> label_mapping_all,</span>
<span id="cb4-406"><a href="#cb4-406"></a>  <span class="at">max_depth          =</span> <span class="dv">2</span>L)</span>
<span id="cb4-407"><a href="#cb4-407"></a><span class="co"># view first model's plots</span></span>
<span id="cb4-408"><a href="#cb4-408"></a>models_batch_2L[[<span class="dv">1</span>]][[<span class="dv">3</span>]]  <span class="co"># combo plot</span></span>
<span id="cb4-409"><a href="#cb4-409"></a>models_batch_2L[[<span class="dv">1</span>]][[<span class="dv">4</span>]]  <span class="co"># qini plot - not convincing</span></span>
<span id="cb4-410"><a href="#cb4-410"></a></span>
<span id="cb4-411"><a href="#cb4-411"></a><span class="co"># 2. flip the selected outcomes (and regen trees)</span></span>
<span id="cb4-412"><a href="#cb4-412"></a><span class="co"># use -- when the outcome is undesirable and we want to minimise it </span></span>
<span id="cb4-413"><a href="#cb4-413"></a><span class="co"># (assuming the exposure is something we'd prescribe)</span></span>
<span id="cb4-414"><a href="#cb4-414"></a></span>
<span id="cb4-415"><a href="#cb4-415"></a><span class="co"># select models whose outcomes are undesirable  when the intervention is meant to be 'good'</span></span>
<span id="cb4-416"><a href="#cb4-416"></a><span class="co"># such variables will be specific to your study </span></span>
<span id="cb4-417"><a href="#cb4-417"></a></span>
<span id="cb4-418"><a href="#cb4-418"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-419"><a href="#cb4-419"></a><span class="co"># |    MODIFY THIS           |</span></span>
<span id="cb4-420"><a href="#cb4-420"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-421"><a href="#cb4-421"></a></span>
<span id="cb4-422"><a href="#cb4-422"></a>flip_outcomes_test <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"t2_kessler_latent_depression_z"</span>)</span>
<span id="cb4-423"><a href="#cb4-423"></a></span>
<span id="cb4-424"><a href="#cb4-424"></a><span class="co"># function to get the labels from the models (labels were defined above)</span></span>
<span id="cb4-425"><a href="#cb4-425"></a>flipped_names_test <span class="ot">&lt;-</span> <span class="fu">margot_get_labels</span>(flip_outcomes_test, label_mapping_all)</span>
<span id="cb4-426"><a href="#cb4-426"></a></span>
<span id="cb4-427"><a href="#cb4-427"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-428"><a href="#cb4-428"></a><span class="co"># |   </span><span class="re">END</span><span class="co"> MODIFY             |</span></span>
<span id="cb4-429"><a href="#cb4-429"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-430"><a href="#cb4-430"></a></span>
<span id="cb4-431"><a href="#cb4-431"></a><span class="co"># check size of objects</span></span>
<span id="cb4-432"><a href="#cb4-432"></a>lobstr<span class="sc">::</span><span class="fu">obj_size</span>(cf_out)                         <span class="co"># overall</span></span>
<span id="cb4-433"><a href="#cb4-433"></a>purrr<span class="sc">::</span><span class="fu">map_dbl</span>(cf_out, lobstr<span class="sc">::</span>obj_size)         <span class="co"># cf_out$results, cf_out$full_models, …</span></span>
<span id="cb4-434"><a href="#cb4-434"></a></span>
<span id="cb4-435"><a href="#cb4-435"></a>mdl <span class="ot">&lt;-</span> cf_out<span class="sc">$</span>results[[<span class="dv">1</span>]]</span>
<span id="cb4-436"><a href="#cb4-436"></a>purrr<span class="sc">::</span><span class="fu">map_dbl</span>(mdl, lobstr<span class="sc">::</span>obj_size)            <span class="co"># tau_hat, dr_scores, forest, …</span></span>
<span id="cb4-437"><a href="#cb4-437"></a></span>
<span id="cb4-438"><a href="#cb4-438"></a><span class="co"># run flip forests</span></span>
<span id="cb4-439"><a href="#cb4-439"></a>cf_out_f <span class="ot">&lt;-</span> <span class="fu">margot_flip_forests_parallel</span>( <span class="co">#&lt;- NEW FUNCTION </span></span>
<span id="cb4-440"><a href="#cb4-440"></a>  <span class="at">model_results =</span> cf_out,</span>
<span id="cb4-441"><a href="#cb4-441"></a>  <span class="at">flip_outcomes =</span> flip_outcomes_test,</span>
<span id="cb4-442"><a href="#cb4-442"></a>  <span class="at">recalc_policy =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-443"><a href="#cb4-443"></a>  <span class="at">max_size_GB    =</span> <span class="dv">15</span>) <span class="co"># SET FOR YOUR COMPUTER</span></span>
<span id="cb4-444"><a href="#cb4-444"></a></span>
<span id="cb4-445"><a href="#cb4-445"></a></span>
<span id="cb4-446"><a href="#cb4-446"></a><span class="co"># where there are very low or high propensity scores (prob of exposure) </span></span>
<span id="cb4-447"><a href="#cb4-447"></a><span class="co"># we might consider trimming</span></span>
<span id="cb4-448"><a href="#cb4-448"></a>margot<span class="sc">::</span><span class="fu">margot_inspect_qini</span>(cf_out_f, <span class="at">propensity_bounds =</span> <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.97</span>))</span>
<span id="cb4-449"><a href="#cb4-449"></a></span>
<span id="cb4-450"><a href="#cb4-450"></a></span>
<span id="cb4-451"><a href="#cb4-451"></a><span class="co"># if we had extreme scores (not used here)</span></span>
<span id="cb4-452"><a href="#cb4-452"></a><span class="co"># cf_out_flipped_trimmed &lt;- margot_rescue_qini(model_results      = cf_out_f,</span></span>
<span id="cb4-453"><a href="#cb4-453"></a><span class="co">#                                              propensity_bounds  = c(0.05, 0.95)) </span></span>
<span id="cb4-454"><a href="#cb4-454"></a></span>
<span id="cb4-455"><a href="#cb4-455"></a></span>
<span id="cb4-456"><a href="#cb4-456"></a></span>
<span id="cb4-457"><a href="#cb4-457"></a><span class="co"># flipped batch model</span></span>
<span id="cb4-458"><a href="#cb4-458"></a>models_batch_flipped_2L <span class="ot">&lt;-</span> <span class="fu">margot_policy</span>(</span>
<span id="cb4-459"><a href="#cb4-459"></a>  cf_out_f,</span>
<span id="cb4-460"><a href="#cb4-460"></a>  <span class="at">save_plots =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-461"><a href="#cb4-461"></a>  <span class="at">output_dir =</span> here<span class="sc">::</span><span class="fu">here</span>(push_mods),</span>
<span id="cb4-462"><a href="#cb4-462"></a>  <span class="at">decision_tree_args =</span> decision_tree_defaults,</span>
<span id="cb4-463"><a href="#cb4-463"></a>  <span class="at">policy_tree_args =</span> policy_tree_defaults,</span>
<span id="cb4-464"><a href="#cb4-464"></a>  <span class="co"># +--------------------------+</span></span>
<span id="cb4-465"><a href="#cb4-465"></a>  <span class="co"># |    MODIFY THIS           |</span></span>
<span id="cb4-466"><a href="#cb4-466"></a>  <span class="co"># +--------------------------+</span></span>
<span id="cb4-467"><a href="#cb4-467"></a>  <span class="at">model_names =</span> <span class="fu">c</span>(<span class="st">"model_t2_kessler_latent_depression_z"</span>),</span>
<span id="cb4-468"><a href="#cb4-468"></a>  <span class="co"># +--------------------------+</span></span>
<span id="cb4-469"><a href="#cb4-469"></a>  <span class="co"># |   </span><span class="re">END</span><span class="co"> MODIFY             |</span></span>
<span id="cb4-470"><a href="#cb4-470"></a>  <span class="co"># +--------------------------+</span></span>
<span id="cb4-471"><a href="#cb4-471"></a>  <span class="at">original_df =</span> original_df,</span>
<span id="cb4-472"><a href="#cb4-472"></a>  <span class="at">label_mapping =</span> label_mapping_all,</span>
<span id="cb4-473"><a href="#cb4-473"></a>  <span class="at">max_depth     =</span> <span class="dv">2</span>L,</span>
<span id="cb4-474"><a href="#cb4-474"></a>  <span class="at">output_objects =</span> <span class="st">"combined_plot"</span> <span class="co"># new parameter margot v1.0.39</span></span>
<span id="cb4-475"><a href="#cb4-475"></a>)</span>
<span id="cb4-476"><a href="#cb4-476"></a></span>
<span id="cb4-477"><a href="#cb4-477"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-478"><a href="#cb4-478"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb4-479"><a href="#cb4-479"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-480"><a href="#cb4-480"></a><span class="co"># flipped</span></span>
<span id="cb4-481"><a href="#cb4-481"></a><span class="co"># interpretation: exposure minimising depression</span></span>
<span id="cb4-482"><a href="#cb4-482"></a>models_batch_flipped_2L<span class="sc">$</span>model_t2_kessler_latent_depression_z</span>
<span id="cb4-483"><a href="#cb4-483"></a></span>
<span id="cb4-484"><a href="#cb4-484"></a></span>
<span id="cb4-485"><a href="#cb4-485"></a><span class="co"># *** </span><span class="al">NOTE</span><span class="co"> DIFFERENCES IN INTERPRETATION</span></span>
<span id="cb4-486"><a href="#cb4-486"></a></span>
<span id="cb4-487"><a href="#cb4-487"></a><span class="co"># not flipped: exposure as maximizing depression</span></span>
<span id="cb4-488"><a href="#cb4-488"></a>models_batch_2L[[<span class="dv">1</span>]][[<span class="dv">3</span>]]</span>
<span id="cb4-489"><a href="#cb4-489"></a></span>
<span id="cb4-490"><a href="#cb4-490"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-491"><a href="#cb4-491"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb4-492"><a href="#cb4-492"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-493"><a href="#cb4-493"></a><span class="co"># interpretation example </span></span>
<span id="cb4-494"><a href="#cb4-494"></a></span>
<span id="cb4-495"><a href="#cb4-495"></a></span>
<span id="cb4-496"><a href="#cb4-496"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"created and saved label_mapping for use in graphs/tables ✔"</span>)</span>
<span id="cb4-497"><a href="#cb4-497"></a></span>
<span id="cb4-498"><a href="#cb4-498"></a></span>
<span id="cb4-499"><a href="#cb4-499"></a><span class="co"># test interpretations ----------------------------------------------------</span></span>
<span id="cb4-500"><a href="#cb4-500"></a></span>
<span id="cb4-501"><a href="#cb4-501"></a></span>
<span id="cb4-502"><a href="#cb4-502"></a><span class="co"># policy tree interpretation: search depth = 1</span></span>
<span id="cb4-503"><a href="#cb4-503"></a>interpret_model_policy_test_1L <span class="ot">&lt;-</span> <span class="fu">margot_interpret_policy_batch</span>(cf_out_f, <span class="at">max_depth =</span> <span class="dv">1</span>)</span>
<span id="cb4-504"><a href="#cb4-504"></a><span class="fu">cat</span>(interpret_model_policy_test_1L)</span>
<span id="cb4-505"><a href="#cb4-505"></a></span>
<span id="cb4-506"><a href="#cb4-506"></a></span>
<span id="cb4-507"><a href="#cb4-507"></a><span class="co"># policy tree interpretation: search depth = 2</span></span>
<span id="cb4-508"><a href="#cb4-508"></a>interpret_model_policy_test_2L <span class="ot">&lt;-</span> <span class="fu">margot_interpret_policy_batch</span>(cf_out_f, <span class="at">max_depth =</span> <span class="dv">2</span>)</span>
<span id="cb4-509"><a href="#cb4-509"></a><span class="fu">cat</span>(interpret_model_policy_test_2L)</span>
<span id="cb4-510"><a href="#cb4-510"></a></span>
<span id="cb4-511"><a href="#cb4-511"></a></span>
<span id="cb4-512"><a href="#cb4-512"></a></span>
<span id="cb4-513"><a href="#cb4-513"></a><span class="co"># interpret rate ----------------------------------------------------------</span></span>
<span id="cb4-514"><a href="#cb4-514"></a></span>
<span id="cb4-515"><a href="#cb4-515"></a><span class="co"># create rate analysis table</span></span>
<span id="cb4-516"><a href="#cb4-516"></a>rate_table_all_test <span class="ot">&lt;-</span> <span class="fu">margot_rate</span>(</span>
<span id="cb4-517"><a href="#cb4-517"></a>  <span class="at">models =</span> cf_out_f,</span>
<span id="cb4-518"><a href="#cb4-518"></a>  <span class="at">policy =</span> <span class="st">"treat_best"</span>,  <span class="co"># or "withold_best" but don't attempt fitting curves or policytrees</span></span>
<span id="cb4-519"><a href="#cb4-519"></a>  <span class="at">label_mapping =</span> label_mapping_all</span>
<span id="cb4-520"><a href="#cb4-520"></a>)</span>
<span id="cb4-521"><a href="#cb4-521"></a></span>
<span id="cb4-522"><a href="#cb4-522"></a><span class="co"># view rate tables</span></span>
<span id="cb4-523"><a href="#cb4-523"></a>rate_table_all_test<span class="sc">$</span>rate_autoc <span class="sc">|&gt;</span> <span class="fu">kbl</span>(<span class="st">"markdown"</span>)</span>
<span id="cb4-524"><a href="#cb4-524"></a>rate_table_all_test<span class="sc">$</span>rate_qini <span class="sc">|&gt;</span> <span class="fu">kbl</span>(<span class="st">"markdown"</span>)</span>
<span id="cb4-525"><a href="#cb4-525"></a></span>
<span id="cb4-526"><a href="#cb4-526"></a></span>
<span id="cb4-527"><a href="#cb4-527"></a><span class="co"># generate interpretation</span></span>
<span id="cb4-528"><a href="#cb4-528"></a>rate_interpretation_all <span class="ot">&lt;-</span> <span class="fu">margot_interpret_rate</span>(</span>
<span id="cb4-529"><a href="#cb4-529"></a>  rate_table_all_test, </span>
<span id="cb4-530"><a href="#cb4-530"></a>  <span class="at">flipped_outcomes =</span> flipped_names_test</span>
<span id="cb4-531"><a href="#cb4-531"></a>)</span>
<span id="cb4-532"><a href="#cb4-532"></a></span>
<span id="cb4-533"><a href="#cb4-533"></a></span>
<span id="cb4-534"><a href="#cb4-534"></a></span>
<span id="cb4-535"><a href="#cb4-535"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"testing on smaller dataset completed ✔"</span>)</span>
<span id="cb4-536"><a href="#cb4-536"></a></span>
<span id="cb4-537"><a href="#cb4-537"></a></span>
<span id="cb4-538"><a href="#cb4-538"></a><span class="co"># ** uncomment to run full model**</span></span>
<span id="cb4-539"><a href="#cb4-539"></a></span>
<span id="cb4-540"><a href="#cb4-540"></a><span class="co"># causal forest model -----------------------------------------------------------</span></span>
<span id="cb4-541"><a href="#cb4-541"></a></span>
<span id="cb4-542"><a href="#cb4-542"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-543"><a href="#cb4-543"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb4-544"><a href="#cb4-544"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-545"><a href="#cb4-545"></a><span class="co"># !!!! THIS WILL TAKE TIME  !!!!!</span></span>
<span id="cb4-546"><a href="#cb4-546"></a>models_binary <span class="ot">&lt;-</span> <span class="fu">margot_causal_forest_parallel</span>(</span>
<span id="cb4-547"><a href="#cb4-547"></a>  <span class="at">data =</span> df_grf,</span>
<span id="cb4-548"><a href="#cb4-548"></a>  <span class="at">outcome_vars =</span> t2_outcome_z,</span>
<span id="cb4-549"><a href="#cb4-549"></a>  <span class="at">covariates =</span> X,</span>
<span id="cb4-550"><a href="#cb4-550"></a>  <span class="at">W =</span> W,</span>
<span id="cb4-551"><a href="#cb4-551"></a>  <span class="at">weights =</span> weights,</span>
<span id="cb4-552"><a href="#cb4-552"></a>  <span class="at">grf_defaults =</span> grf_defaults,</span>
<span id="cb4-553"><a href="#cb4-553"></a>  <span class="at">top_n_vars =</span> <span class="dv">15</span>,</span>
<span id="cb4-554"><a href="#cb4-554"></a>  <span class="at">save_models =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-555"><a href="#cb4-555"></a>  <span class="at">save_data =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-556"><a href="#cb4-556"></a>  <span class="at">train_proportion =</span> <span class="fl">0.7</span></span>
<span id="cb4-557"><a href="#cb4-557"></a>)</span>
<span id="cb4-558"><a href="#cb4-558"></a></span>
<span id="cb4-559"><a href="#cb4-559"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-560"><a href="#cb4-560"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb4-561"><a href="#cb4-561"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-562"><a href="#cb4-562"></a><span class="co"># !!!! THIS WILL TAKE TIME  !!!!!</span></span>
<span id="cb4-563"><a href="#cb4-563"></a><span class="co"># save model</span></span>
<span id="cb4-564"><a href="#cb4-564"></a>margot<span class="sc">::</span><span class="fu">here_save_qs</span>(models_binary, <span class="st">"models_binary"</span>, push_mods)</span>
<span id="cb4-565"><a href="#cb4-565"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-566"><a href="#cb4-566"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb4-567"><a href="#cb4-567"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-568"><a href="#cb4-568"></a></span>
<span id="cb4-569"><a href="#cb4-569"></a></span>
<span id="cb4-570"><a href="#cb4-570"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"causal forest model completed and saved ✔"</span>)</span>
<span id="cb4-571"><a href="#cb4-571"></a></span>
<span id="cb4-572"><a href="#cb4-572"></a></span>
<span id="cb4-573"><a href="#cb4-573"></a><span class="co"># read results ------------------------------------------------------------</span></span>
<span id="cb4-574"><a href="#cb4-574"></a><span class="co"># if you save models you do not need to re-run them</span></span>
<span id="cb4-575"><a href="#cb4-575"></a></span>
<span id="cb4-576"><a href="#cb4-576"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-577"><a href="#cb4-577"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb4-578"><a href="#cb4-578"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-579"><a href="#cb4-579"></a><span class="co"># reading models takes time</span></span>
<span id="cb4-580"><a href="#cb4-580"></a><span class="co"># if you want to check the size of an object use</span></span>
<span id="cb4-581"><a href="#cb4-581"></a><span class="co"># margot::margot_size(object)</span></span>
<span id="cb4-582"><a href="#cb4-582"></a></span>
<span id="cb4-583"><a href="#cb4-583"></a></span>
<span id="cb4-584"><a href="#cb4-584"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-585"><a href="#cb4-585"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb4-586"><a href="#cb4-586"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-587"><a href="#cb4-587"></a><span class="co"># !!!! THIS WILL TAKE TIME  !!!!!</span></span>
<span id="cb4-588"><a href="#cb4-588"></a>models_binary <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read_qs</span>(<span class="st">"models_binary"</span>, push_mods)</span>
<span id="cb4-589"><a href="#cb4-589"></a></span>
<span id="cb4-590"><a href="#cb4-590"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-591"><a href="#cb4-591"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb4-592"><a href="#cb4-592"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-593"><a href="#cb4-593"></a></span>
<span id="cb4-594"><a href="#cb4-594"></a><span class="co"># count models by category</span></span>
<span id="cb4-595"><a href="#cb4-595"></a><span class="co"># just a check</span></span>
<span id="cb4-596"><a href="#cb4-596"></a><span class="fu">cat</span>(<span class="st">"Number of original models:</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">length</span>(models_binary<span class="sc">$</span>results), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-597"><a href="#cb4-597"></a></span>
<span id="cb4-598"><a href="#cb4-598"></a></span>
<span id="cb4-599"><a href="#cb4-599"></a><span class="co"># make ate plots ----------------------------------------------------------</span></span>
<span id="cb4-600"><a href="#cb4-600"></a></span>
<span id="cb4-601"><a href="#cb4-601"></a><span class="co"># uncorrected results</span></span>
<span id="cb4-602"><a href="#cb4-602"></a>models_binary<span class="sc">$</span>combined_table</span>
<span id="cb4-603"><a href="#cb4-603"></a></span>
<span id="cb4-604"><a href="#cb4-604"></a><span class="co">#   ************* NEW - CORRECTION FOR FAMILY-WISE ERROR **********</span></span>
<span id="cb4-605"><a href="#cb4-605"></a>adj_tbl <span class="ot">&lt;-</span> <span class="fu">margot_correct_combined_table</span>(models_binary<span class="sc">$</span>combined_table,</span>
<span id="cb4-606"><a href="#cb4-606"></a>                                         <span class="at">adjust =</span> <span class="st">"bonferroni"</span>,</span>
<span id="cb4-607"><a href="#cb4-607"></a>                                         <span class="at">alpha  =</span> <span class="fl">0.05</span>,</span>
<span id="cb4-608"><a href="#cb4-608"></a>                                         <span class="at">scale  =</span> <span class="st">"RD"</span>)</span>
<span id="cb4-609"><a href="#cb4-609"></a></span>
<span id="cb4-610"><a href="#cb4-610"></a><span class="co"># then pass to the results</span></span>
<span id="cb4-611"><a href="#cb4-611"></a>ate_results <span class="ot">&lt;-</span> <span class="fu">margot_plot</span>(</span>
<span id="cb4-612"><a href="#cb4-612"></a>  adj_tbl, <span class="co"># &lt;- now pass the corrected results.</span></span>
<span id="cb4-613"><a href="#cb4-613"></a>  <span class="at">options =</span> outcomes_options_all,</span>
<span id="cb4-614"><a href="#cb4-614"></a>  <span class="at">label_mapping =</span> label_mapping_all,</span>
<span id="cb4-615"><a href="#cb4-615"></a>  <span class="at">include_coefficients =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-616"><a href="#cb4-616"></a>  <span class="at">save_output =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-617"><a href="#cb4-617"></a>  <span class="at">order =</span> <span class="st">"evaluebound_asc"</span>,</span>
<span id="cb4-618"><a href="#cb4-618"></a>  <span class="at">original_df =</span> original_df,</span>
<span id="cb4-619"><a href="#cb4-619"></a>  <span class="at">e_val_bound_threshold =</span> <span class="fl">1.1</span>,</span>
<span id="cb4-620"><a href="#cb4-620"></a>  <span class="at">rename_ate =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-621"><a href="#cb4-621"></a>  <span class="at">adjust =</span> <span class="st">"bonferroni"</span>,</span>
<span id="cb4-622"><a href="#cb4-622"></a>  <span class="at">alpha =</span> <span class="fl">0.05</span></span>
<span id="cb4-623"><a href="#cb4-623"></a>)</span>
<span id="cb4-624"><a href="#cb4-624"></a></span>
<span id="cb4-625"><a href="#cb4-625"></a></span>
<span id="cb4-626"><a href="#cb4-626"></a></span>
<span id="cb4-627"><a href="#cb4-627"></a></span>
<span id="cb4-628"><a href="#cb4-628"></a><span class="co"># view</span></span>
<span id="cb4-629"><a href="#cb4-629"></a><span class="fu">cat</span>(ate_results<span class="sc">$</span>interpretation)</span>
<span id="cb4-630"><a href="#cb4-630"></a></span>
<span id="cb4-631"><a href="#cb4-631"></a><span class="co"># check</span></span>
<span id="cb4-632"><a href="#cb4-632"></a>ate_results<span class="sc">$</span>plot</span>
<span id="cb4-633"><a href="#cb4-633"></a></span>
<span id="cb4-634"><a href="#cb4-634"></a><span class="co"># interpretation</span></span>
<span id="cb4-635"><a href="#cb4-635"></a><span class="fu">cat</span>(ate_results<span class="sc">$</span>interpretation)</span>
<span id="cb4-636"><a href="#cb4-636"></a></span>
<span id="cb4-637"><a href="#cb4-637"></a><span class="co"># save</span></span>
<span id="cb4-638"><a href="#cb4-638"></a><span class="fu">here_save</span>(ate_results, <span class="st">"ate_results"</span>)</span>
<span id="cb4-639"><a href="#cb4-639"></a></span>
<span id="cb4-640"><a href="#cb4-640"></a></span>
<span id="cb4-641"><a href="#cb4-641"></a><span class="co"># make markdown tables (to be imported into the manuscript)</span></span>
<span id="cb4-642"><a href="#cb4-642"></a>margot_bind_tables_markdown <span class="ot">&lt;-</span> <span class="fu">margot_bind_tables</span>(</span>
<span id="cb4-643"><a href="#cb4-643"></a>  adj_tbl,</span>
<span id="cb4-644"><a href="#cb4-644"></a>  <span class="co">#list(all_models$combined_table),</span></span>
<span id="cb4-645"><a href="#cb4-645"></a>  <span class="at">sort_E_val_bound =</span> <span class="st">"desc"</span>,</span>
<span id="cb4-646"><a href="#cb4-646"></a>  <span class="at">e_val_bound_threshold =</span> <span class="fl">1.1</span>,</span>
<span id="cb4-647"><a href="#cb4-647"></a>  <span class="co"># ← choose threshold</span></span>
<span id="cb4-648"><a href="#cb4-648"></a>  <span class="at">highlight_color =</span> <span class="cn">NULL</span>,</span>
<span id="cb4-649"><a href="#cb4-649"></a>  <span class="at">bold =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-650"><a href="#cb4-650"></a>  <span class="at">rename_cols =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-651"><a href="#cb4-651"></a>  <span class="at">col_renames =</span> <span class="fu">list</span>(<span class="st">"E-Value"</span> <span class="ot">=</span> <span class="st">"E_Value"</span>, <span class="st">"E-Value bound"</span> <span class="ot">=</span> <span class="st">"E_Val_bound"</span>),</span>
<span id="cb4-652"><a href="#cb4-652"></a>  <span class="at">rename_ate =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-653"><a href="#cb4-653"></a>  <span class="at">threshold_col =</span> <span class="st">"E_Val_bound"</span>,</span>
<span id="cb4-654"><a href="#cb4-654"></a>  <span class="at">output_format =</span> <span class="st">"markdown"</span>,</span>
<span id="cb4-655"><a href="#cb4-655"></a>  <span class="at">kbl_args =</span> <span class="fu">list</span>(</span>
<span id="cb4-656"><a href="#cb4-656"></a>    <span class="at">booktabs =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-657"><a href="#cb4-657"></a>    <span class="at">caption =</span> <span class="cn">NULL</span>,</span>
<span id="cb4-658"><a href="#cb4-658"></a>    <span class="at">align =</span> <span class="cn">NULL</span></span>
<span id="cb4-659"><a href="#cb4-659"></a>  )</span>
<span id="cb4-660"><a href="#cb4-660"></a>)</span>
<span id="cb4-661"><a href="#cb4-661"></a></span>
<span id="cb4-662"><a href="#cb4-662"></a><span class="co"># view markdown table</span></span>
<span id="cb4-663"><a href="#cb4-663"></a>margot_bind_tables_markdown</span>
<span id="cb4-664"><a href="#cb4-664"></a></span>
<span id="cb4-665"><a href="#cb4-665"></a><span class="co"># save for publication</span></span>
<span id="cb4-666"><a href="#cb4-666"></a><span class="fu">here_save</span>(margot_bind_tables_markdown, <span class="st">"margot_bind_tables_markdown"</span>)</span>
<span id="cb4-667"><a href="#cb4-667"></a></span>
<span id="cb4-668"><a href="#cb4-668"></a></span>
<span id="cb4-669"><a href="#cb4-669"></a><span class="co"># evaluate models ---------------------------------------------------------</span></span>
<span id="cb4-670"><a href="#cb4-670"></a><span class="co"># trim models if extreme propensity scores dominate</span></span>
<span id="cb4-671"><a href="#cb4-671"></a><span class="co"># diag_tbl_98 &lt;- margot_inspect_qini(models_binary,</span></span>
<span id="cb4-672"><a href="#cb4-672"></a><span class="co">#                                        propensity_bounds = c(0.01, 0.99))</span></span>
<span id="cb4-673"><a href="#cb4-673"></a></span>
<span id="cb4-674"><a href="#cb4-674"></a></span>
<span id="cb4-675"><a href="#cb4-675"></a></span>
<span id="cb4-676"><a href="#cb4-676"></a></span>
<span id="cb4-677"><a href="#cb4-677"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-678"><a href="#cb4-678"></a><span class="co"># |     </span><span class="re">END</span><span class="co"> DO NOT ALTER     |</span></span>
<span id="cb4-679"><a href="#cb4-679"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-680"><a href="#cb4-680"></a></span>
<span id="cb4-681"><a href="#cb4-681"></a></span>
<span id="cb4-682"><a href="#cb4-682"></a></span>
<span id="cb4-683"><a href="#cb4-683"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-684"><a href="#cb4-684"></a><span class="co"># |    MODIFY THIS SECTION   |</span></span>
<span id="cb4-685"><a href="#cb4-685"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-686"><a href="#cb4-686"></a></span>
<span id="cb4-687"><a href="#cb4-687"></a></span>
<span id="cb4-688"><a href="#cb4-688"></a><span class="co"># FLIPPING OUTCOMES  ------------------------------------------------------</span></span>
<span id="cb4-689"><a href="#cb4-689"></a></span>
<span id="cb4-690"><a href="#cb4-690"></a><span class="co"># note that the meaning of a heterogeneity will vary depending on our interests.</span></span>
<span id="cb4-691"><a href="#cb4-691"></a><span class="co"># typically we are interested in whether an exposure improves life, and whether there is variability (aka HTE) in degrees of improvement.</span></span>
<span id="cb4-692"><a href="#cb4-692"></a><span class="co"># in this case we must take negative outcomes and "flip" them -- recalculating the policy trees and qini curves for each</span></span>
<span id="cb4-693"><a href="#cb4-693"></a><span class="co"># for example if the outcome is depression, then by flipping depression we better understand how the exposure *reduces* depression. </span></span>
<span id="cb4-694"><a href="#cb4-694"></a><span class="co"># what if the exposure is harmful? say what if we are interested in the effect of depression on wellbeing? In that case, we might</span></span>
<span id="cb4-695"><a href="#cb4-695"></a><span class="co"># want to "flip" the positive outcomes. That is, we might want to understand for whom a negative exposure is extra harmful. </span></span>
<span id="cb4-696"><a href="#cb4-696"></a><span class="co"># here we imagine that extroversion is generally positive in its effects, and so we "flip" the negative outcomes. </span></span>
<span id="cb4-697"><a href="#cb4-697"></a><span class="co"># if you were interested in a negative exposure, say "neuroticism" then you would probably want to flip the positive outcomes. </span></span>
<span id="cb4-698"><a href="#cb4-698"></a><span class="co"># note there are further questions we might ask. We might consider who responds more 'weakly" to a negative exposure (or perhaps to a positive exposure).</span></span>
<span id="cb4-699"><a href="#cb4-699"></a><span class="co"># Such a question could make sense if we had an exposure that was generally very strong. </span></span>
<span id="cb4-700"><a href="#cb4-700"></a><span class="co"># however, let's stay focussed on evaluating evaluating strong responders. We will flip the negative outcomes if we expect the exposure is positive,</span></span>
<span id="cb4-701"><a href="#cb4-701"></a><span class="co"># and flip the positive outcomes if we expect the exposure to be generally negative. </span></span>
<span id="cb4-702"><a href="#cb4-702"></a><span class="co"># if there is no natural "positive" or negative, then just make sure the valence of the outcomes aligns, so that all are oriented in the same </span></span>
<span id="cb4-703"><a href="#cb4-703"></a><span class="co"># direction if they have a valence.  if unsure, just ask for help!</span></span>
<span id="cb4-704"><a href="#cb4-704"></a></span>
<span id="cb4-705"><a href="#cb4-705"></a><span class="co"># flipping models: outcomes we want to minimise given the exposure --------</span></span>
<span id="cb4-706"><a href="#cb4-706"></a><span class="co"># standard negative outcomes/  not used in this example</span></span>
<span id="cb4-707"><a href="#cb4-707"></a><span class="co"># flipping models: outcomes we want to minimise given the exposure --------</span></span>
<span id="cb4-708"><a href="#cb4-708"></a><span class="co"># standard negative outcomes/  not used in this example</span></span>
<span id="cb4-709"><a href="#cb4-709"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-710"><a href="#cb4-710"></a><span class="co"># |    MODIFY THIS           |</span></span>
<span id="cb4-711"><a href="#cb4-711"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-712"><a href="#cb4-712"></a></span>
<span id="cb4-713"><a href="#cb4-713"></a><span class="co"># WHICH OUTCOMES -- if any ARE UNDESIREABLE? </span></span>
<span id="cb4-714"><a href="#cb4-714"></a>flip_outcomes_standard <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb4-715"><a href="#cb4-715"></a>  <span class="co">#"t2_alcohol_frequency_weekly_z",</span></span>
<span id="cb4-716"><a href="#cb4-716"></a>  <span class="co">#"t2_alcohol_intensity_z",</span></span>
<span id="cb4-717"><a href="#cb4-717"></a>  <span class="co">#"t2_hlth_bmi_z",</span></span>
<span id="cb4-718"><a href="#cb4-718"></a>  <span class="co">#"t2_hlth_fatigue_z",</span></span>
<span id="cb4-719"><a href="#cb4-719"></a>  <span class="st">"t2_kessler_latent_anxiety_z"</span>, <span class="co">#  ← select</span></span>
<span id="cb4-720"><a href="#cb4-720"></a>  <span class="st">"t2_kessler_latent_depression_z"</span>,<span class="co">#  ← select</span></span>
<span id="cb4-721"><a href="#cb4-721"></a>  <span class="st">"t2_rumination_z"</span> <span class="co">#  ← select</span></span>
<span id="cb4-722"><a href="#cb4-722"></a>  <span class="co">#"t2_perfectionism_z" # the exposure variable was not investigated</span></span>
<span id="cb4-723"><a href="#cb4-723"></a>)</span>
<span id="cb4-724"><a href="#cb4-724"></a></span>
<span id="cb4-725"><a href="#cb4-725"></a><span class="co"># when exposure is negative and you want to focus on how much worse off</span></span>
<span id="cb4-726"><a href="#cb4-726"></a><span class="co"># some people are use this: </span></span>
<span id="cb4-727"><a href="#cb4-727"></a></span>
<span id="cb4-728"><a href="#cb4-728"></a><span class="co"># NOT IF THE EXPOSURE IS NEGATIVE, FOCUS ON WHICH OUTCOMES, if any, ARE POSITIVE AND FLIP THESE?</span></span>
<span id="cb4-729"><a href="#cb4-729"></a><span class="co"># flip_outcomes&lt;- c( setdiff(t2_outcomes_all, flip_outcomes_standard) )</span></span>
<span id="cb4-730"><a href="#cb4-730"></a></span>
<span id="cb4-731"><a href="#cb4-731"></a><span class="co"># our example has the exposure as positive</span></span>
<span id="cb4-732"><a href="#cb4-732"></a>flip_outcomes <span class="ot">&lt;-</span> flip_outcomes_standard</span>
<span id="cb4-733"><a href="#cb4-733"></a></span>
<span id="cb4-734"><a href="#cb4-734"></a><span class="co"># check</span></span>
<span id="cb4-735"><a href="#cb4-735"></a>flip_outcomes</span>
<span id="cb4-736"><a href="#cb4-736"></a></span>
<span id="cb4-737"><a href="#cb4-737"></a></span>
<span id="cb4-738"><a href="#cb4-738"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-739"><a href="#cb4-739"></a><span class="co"># |   </span><span class="re">END</span><span class="co"> MODIFY             |</span></span>
<span id="cb4-740"><a href="#cb4-740"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-741"><a href="#cb4-741"></a></span>
<span id="cb4-742"><a href="#cb4-742"></a><span class="co"># checks for when exposure is *damaging** </span></span>
<span id="cb4-743"><a href="#cb4-743"></a><span class="co"># neg_check &lt;- vapply(all_models$results[ paste0("model_", flip_outcomes) ],</span></span>
<span id="cb4-744"><a href="#cb4-744"></a><span class="co">#                     \(x) mean(x$tau_hat, na.rm = TRUE) &lt; 0, logical(1))</span></span>
<span id="cb4-745"><a href="#cb4-745"></a><span class="co"># stopifnot(all(neg_check))   # every chosen outcome has a negative mean cate</span></span>
<span id="cb4-746"><a href="#cb4-746"></a></span>
<span id="cb4-747"><a href="#cb4-747"></a><span class="co"># get labels</span></span>
<span id="cb4-748"><a href="#cb4-748"></a>flipped_names <span class="ot">&lt;-</span> <span class="fu">margot_get_labels</span>(flip_outcomes, label_mapping_all)</span>
<span id="cb4-749"><a href="#cb4-749"></a></span>
<span id="cb4-750"><a href="#cb4-750"></a><span class="co"># check</span></span>
<span id="cb4-751"><a href="#cb4-751"></a>flipped_names</span>
<span id="cb4-752"><a href="#cb4-752"></a></span>
<span id="cb4-753"><a href="#cb4-753"></a><span class="co"># save for publication</span></span>
<span id="cb4-754"><a href="#cb4-754"></a><span class="fu">here_save</span>(flipped_names, <span class="st">"flipped_names"</span>)</span>
<span id="cb4-755"><a href="#cb4-755"></a></span>
<span id="cb4-756"><a href="#cb4-756"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"flipped outcomes identified and names saved ✔"</span>)</span>
<span id="cb4-757"><a href="#cb4-757"></a></span>
<span id="cb4-758"><a href="#cb4-758"></a></span>
<span id="cb4-759"><a href="#cb4-759"></a><span class="co"># flip negatively oriented outcomes --------------------------------------</span></span>
<span id="cb4-760"><a href="#cb4-760"></a></span>
<span id="cb4-761"><a href="#cb4-761"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-762"><a href="#cb4-762"></a><span class="co"># |       DO NOT ALTER       |</span></span>
<span id="cb4-763"><a href="#cb4-763"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-764"><a href="#cb4-764"></a></span>
<span id="cb4-765"><a href="#cb4-765"></a></span>
<span id="cb4-766"><a href="#cb4-766"></a><span class="co"># flip models using margot's function</span></span>
<span id="cb4-767"><a href="#cb4-767"></a></span>
<span id="cb4-768"><a href="#cb4-768"></a><span class="co">#  *** this will take some time ***</span></span>
<span id="cb4-769"><a href="#cb4-769"></a></span>
<span id="cb4-770"><a href="#cb4-770"></a><span class="co"># ** give it time **</span></span>
<span id="cb4-771"><a href="#cb4-771"></a><span class="co"># ** once run/ comment out **</span></span>
<span id="cb4-772"><a href="#cb4-772"></a></span>
<span id="cb4-773"><a href="#cb4-773"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-774"><a href="#cb4-774"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb4-775"><a href="#cb4-775"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-776"><a href="#cb4-776"></a><span class="co"># !!!! THIS WILL TAKE TIME  !!!!!</span></span>
<span id="cb4-777"><a href="#cb4-777"></a>models_binary_flipped_all <span class="ot">&lt;-</span> <span class="fu">margot_flip_forests_parallel</span>(models_binary,</span>
<span id="cb4-778"><a href="#cb4-778"></a>                                                 <span class="at">flip_outcomes =</span> flip_outcomes_standard,</span>
<span id="cb4-779"><a href="#cb4-779"></a>                                                 <span class="at">recalc_policy =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-780"><a href="#cb4-780"></a>                                                 <span class="at">max_size_GB =</span> <span class="dv">32</span>)</span>
<span id="cb4-781"><a href="#cb4-781"></a></span>
<span id="cb4-782"><a href="#cb4-782"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"flipped forest models completed ✔"</span>)</span>
<span id="cb4-783"><a href="#cb4-783"></a></span>
<span id="cb4-784"><a href="#cb4-784"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-785"><a href="#cb4-785"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb4-786"><a href="#cb4-786"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-787"><a href="#cb4-787"></a><span class="co"># !!!! THIS WILL TAKE TIME  !!!!!</span></span>
<span id="cb4-788"><a href="#cb4-788"></a><span class="co"># save</span></span>
<span id="cb4-789"><a href="#cb4-789"></a><span class="fu">here_save_qs</span>(models_binary_flipped_all, <span class="st">"models_binary_flipped_all"</span>, push_mods)</span>
<span id="cb4-790"><a href="#cb4-790"></a></span>
<span id="cb4-791"><a href="#cb4-791"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-792"><a href="#cb4-792"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb4-793"><a href="#cb4-793"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-794"><a href="#cb4-794"></a></span>
<span id="cb4-795"><a href="#cb4-795"></a></span>
<span id="cb4-796"><a href="#cb4-796"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-797"><a href="#cb4-797"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb4-798"><a href="#cb4-798"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-799"><a href="#cb4-799"></a><span class="co"># !!!! THIS WILL TAKE TIME  !!!!!</span></span>
<span id="cb4-800"><a href="#cb4-800"></a><span class="co"># read back if needed</span></span>
<span id="cb4-801"><a href="#cb4-801"></a>models_binary_flipped_all <span class="ot">&lt;-</span> <span class="fu">here_read_qs</span>(<span class="st">"models_binary_flipped_all"</span>, push_mods)</span>
<span id="cb4-802"><a href="#cb4-802"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-803"><a href="#cb4-803"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb4-804"><a href="#cb4-804"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-805"><a href="#cb4-805"></a></span>
<span id="cb4-806"><a href="#cb4-806"></a><span class="co"># where there are very low or high propensity scores (prob of exposure) we might consider trimming</span></span>
<span id="cb4-807"><a href="#cb4-807"></a><span class="co"># margot::margot_inspect_qini(models_binary_flipped_all, propensity_bounds = c(0.05, 0.95))</span></span>
<span id="cb4-808"><a href="#cb4-808"></a><span class="co"># </span></span>
<span id="cb4-809"><a href="#cb4-809"></a><span class="co"># </span></span>
<span id="cb4-810"><a href="#cb4-810"></a><span class="co"># # if we had extreme scores (not used here)</span></span>
<span id="cb4-811"><a href="#cb4-811"></a><span class="co"># models_binary_flipped_all_t &lt;- margot_rescue_qini(model_results  = models_binary_flipped_all,</span></span>
<span id="cb4-812"><a href="#cb4-812"></a><span class="co">#                                              propensity_bounds  = c(0.05, 0.95))</span></span>
<span id="cb4-813"><a href="#cb4-813"></a></span>
<span id="cb4-814"><a href="#cb4-814"></a><span class="co"># heterogeneity and policy analysis workflow -----------------------------</span></span>
<span id="cb4-815"><a href="#cb4-815"></a><span class="co"># step 1: omnibus heterogeneity test ---------------------------------------</span></span>
<span id="cb4-816"><a href="#cb4-816"></a><span class="co"># test for treatment effect heterogeneity across all flipped outcomes</span></span>
<span id="cb4-817"><a href="#cb4-817"></a><span class="co">#   omnibus calibration test asks: 'Can the forest rank units by τ(x) at all?'  a null result means the ordering of CATEs is </span></span>
<span id="cb4-818"><a href="#cb4-818"></a><span class="co"># indistinguishable from noise, not that all HTE is zero.</span></span>
<span id="cb4-819"><a href="#cb4-819"></a>omnibus_results <span class="ot">&lt;-</span></span>
<span id="cb4-820"><a href="#cb4-820"></a>  margot<span class="sc">::</span><span class="fu">margot_omnibus_hetero_test</span>(</span>
<span id="cb4-821"><a href="#cb4-821"></a>    models_binary_flipped_all,</span>
<span id="cb4-822"><a href="#cb4-822"></a>    <span class="at">label_mapping =</span> label_mapping_all</span>
<span id="cb4-823"><a href="#cb4-823"></a>  )</span>
<span id="cb4-824"><a href="#cb4-824"></a></span>
<span id="cb4-825"><a href="#cb4-825"></a><span class="co"># display summary and interpretation</span></span>
<span id="cb4-826"><a href="#cb4-826"></a>omnibus_results<span class="sc">$</span>summary_table <span class="sc">%&gt;%</span> <span class="fu">kbl</span>(<span class="st">"markdown"</span>)</span>
<span id="cb4-827"><a href="#cb4-827"></a><span class="fu">cat</span>(omnibus_results<span class="sc">$</span>brief_interpretation, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-828"><a href="#cb4-828"></a></span>
<span id="cb4-829"><a href="#cb4-829"></a><span class="co"># step 2: compute rate heterogeneity metrics ------------------------------</span></span>
<span id="cb4-830"><a href="#cb4-830"></a><span class="co"># calculate rate-autoc and rate-qini tables</span></span>
<span id="cb4-831"><a href="#cb4-831"></a><span class="co"># note: RATE-AUTOC asks: 'If I only treat the top k\% by τ(x), do I maximise average gain?' </span></span>
<span id="cb4-832"><a href="#cb4-832"></a><span class="co"># it rewards extreme uplift but can be volatile.</span></span>
<span id="cb4-833"><a href="#cb4-833"></a><span class="co"># RATE-Qini asks: 'if i treat more broadly, do I still improve aggregate outcome?' it trades intensity for coverage.</span></span>
<span id="cb4-834"><a href="#cb4-834"></a>rate_results <span class="ot">&lt;-</span></span>
<span id="cb4-835"><a href="#cb4-835"></a>  <span class="fu">margot_rate</span>(</span>
<span id="cb4-836"><a href="#cb4-836"></a>    <span class="at">models   =</span> models_binary_flipped_all,</span>
<span id="cb4-837"><a href="#cb4-837"></a>    <span class="at">policy   =</span> <span class="st">"treat_best"</span>,</span>
<span id="cb4-838"><a href="#cb4-838"></a>    <span class="at">label_mapping =</span> label_mapping_all</span>
<span id="cb4-839"><a href="#cb4-839"></a>  )</span>
<span id="cb4-840"><a href="#cb4-840"></a></span>
<span id="cb4-841"><a href="#cb4-841"></a><span class="co"># show rate tables</span></span>
<span id="cb4-842"><a href="#cb4-842"></a>rate_results<span class="sc">$</span>rate_autoc <span class="sc">%&gt;%</span> <span class="fu">kbl</span>(<span class="st">"markdown"</span>)</span>
<span id="cb4-843"><a href="#cb4-843"></a>rate_results<span class="sc">$</span>rate_qini <span class="sc">%&gt;%</span> <span class="fu">kbl</span>(<span class="st">"markdown"</span>)</span>
<span id="cb4-844"><a href="#cb4-844"></a></span>
<span id="cb4-845"><a href="#cb4-845"></a><span class="co"># save rate results</span></span>
<span id="cb4-846"><a href="#cb4-846"></a><span class="fu">here_save</span>(rate_results, <span class="st">"rate_results"</span>)</span>
<span id="cb4-847"><a href="#cb4-847"></a></span>
<span id="cb4-848"><a href="#cb4-848"></a><span class="co"># generate textual interpretations for rate metrics</span></span>
<span id="cb4-849"><a href="#cb4-849"></a>rate_interp <span class="ot">&lt;-</span></span>
<span id="cb4-850"><a href="#cb4-850"></a>  <span class="fu">margot_interpret_rate</span>(</span>
<span id="cb4-851"><a href="#cb4-851"></a>    rate_results,</span>
<span id="cb4-852"><a href="#cb4-852"></a>    <span class="at">flipped_outcomes =</span> flipped_names</span>
<span id="cb4-853"><a href="#cb4-853"></a>  )</span>
<span id="cb4-854"><a href="#cb4-854"></a><span class="fu">cat</span>(rate_interp<span class="sc">$</span>autoc_results, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-855"><a href="#cb4-855"></a><span class="fu">cat</span>(rate_interp<span class="sc">$</span>qini_results, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-856"><a href="#cb4-856"></a><span class="fu">cat</span>(rate_interp<span class="sc">$</span>comparison, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-857"><a href="#cb4-857"></a><span class="fu">here_save</span>(rate_interp, <span class="st">"rate_interpretation"</span>)</span>
<span id="cb4-858"><a href="#cb4-858"></a></span>
<span id="cb4-859"><a href="#cb4-859"></a><span class="co"># organise model groups by heterogeneity evidence</span></span>
<span id="cb4-860"><a href="#cb4-860"></a>model_groups <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-861"><a href="#cb4-861"></a>  <span class="at">autoc  =</span> rate_interp<span class="sc">$</span>autoc_model_names,</span>
<span id="cb4-862"><a href="#cb4-862"></a>  <span class="at">qini   =</span> rate_interp<span class="sc">$</span>qini_model_names,</span>
<span id="cb4-863"><a href="#cb4-863"></a>  <span class="at">either =</span> rate_interp<span class="sc">$</span>either_model_names</span>
<span id="cb4-864"><a href="#cb4-864"></a>)</span>
<span id="cb4-865"><a href="#cb4-865"></a></span>
<span id="cb4-866"><a href="#cb4-866"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"rate metrics and interpretations complete ✔"</span>)</span>
<span id="cb4-867"><a href="#cb4-867"></a></span>
<span id="cb4-868"><a href="#cb4-868"></a><span class="co"># helper: combine and save ggplot objects ---------------------------------</span></span>
<span id="cb4-869"><a href="#cb4-869"></a>combine_and_save <span class="ot">&lt;-</span> <span class="cf">function</span>(plots, prefix) {</span>
<span id="cb4-870"><a href="#cb4-870"></a>  <span class="cf">if</span> (<span class="fu">length</span>(plots) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb4-871"><a href="#cb4-871"></a>    <span class="fu">message</span>(<span class="st">"no "</span>, prefix, <span class="st">" plots to combine"</span>)</span>
<span id="cb4-872"><a href="#cb4-872"></a>    <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb4-873"><a href="#cb4-873"></a>  }</span>
<span id="cb4-874"><a href="#cb4-874"></a>  cols     <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">length</span>(plots) <span class="sc">&gt;</span> <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb4-875"><a href="#cb4-875"></a>  combined <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">reduce</span>(plots, <span class="st">`</span><span class="at">+</span><span class="st">`</span>) <span class="sc">+</span></span>
<span id="cb4-876"><a href="#cb4-876"></a>    patchwork<span class="sc">::</span><span class="fu">plot_layout</span>(<span class="at">ncol =</span> cols) <span class="sc">&amp;</span></span>
<span id="cb4-877"><a href="#cb4-877"></a>    patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb4-878"><a href="#cb4-878"></a>      <span class="at">title    =</span> <span class="fu">toupper</span>(prefix),</span>
<span id="cb4-879"><a href="#cb4-879"></a>      <span class="at">subtitle =</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{length(plots)} models"</span>),</span>
<span id="cb4-880"><a href="#cb4-880"></a>      <span class="at">tag_levels =</span> <span class="st">"A"</span></span>
<span id="cb4-881"><a href="#cb4-881"></a>    )</span>
<span id="cb4-882"><a href="#cb4-882"></a>  <span class="fu">print</span>(combined)</span>
<span id="cb4-883"><a href="#cb4-883"></a>  <span class="fu">ggsave</span>(</span>
<span id="cb4-884"><a href="#cb4-884"></a>    here<span class="sc">::</span><span class="fu">here</span>(push_mods, <span class="fu">paste0</span>(<span class="st">"combined_"</span>, prefix, <span class="st">".pdf"</span>)),</span>
<span id="cb4-885"><a href="#cb4-885"></a>    combined,</span>
<span id="cb4-886"><a href="#cb4-886"></a>    <span class="at">width  =</span> <span class="fu">ifelse</span>(cols <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">8</span>, <span class="dv">12</span>),</span>
<span id="cb4-887"><a href="#cb4-887"></a>    <span class="at">height =</span> <span class="dv">6</span> <span class="sc">*</span> <span class="fu">ceiling</span>(<span class="fu">length</span>(plots) <span class="sc">/</span> cols)</span>
<span id="cb4-888"><a href="#cb4-888"></a>  )</span>
<span id="cb4-889"><a href="#cb4-889"></a>  combined</span>
<span id="cb4-890"><a href="#cb4-890"></a>}</span>
<span id="cb4-891"><a href="#cb4-891"></a></span>
<span id="cb4-892"><a href="#cb4-892"></a><span class="co"># step 3: plot rate curves -----------------------------------------------</span></span>
<span id="cb4-893"><a href="#cb4-893"></a>autoc_plots <span class="ot">&lt;-</span></span>
<span id="cb4-894"><a href="#cb4-894"></a>  <span class="fu">margot_plot_rate_batch</span>(</span>
<span id="cb4-895"><a href="#cb4-895"></a>    <span class="at">models      =</span> models_binary_flipped_all,</span>
<span id="cb4-896"><a href="#cb4-896"></a>    <span class="at">save_plots  =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-897"><a href="#cb4-897"></a>    <span class="at">model_names =</span> model_groups<span class="sc">$</span>autoc</span>
<span id="cb4-898"><a href="#cb4-898"></a>  )</span>
<span id="cb4-899"><a href="#cb4-899"></a>combined_autoc <span class="ot">&lt;-</span> <span class="fu">combine_and_save</span>(autoc_plots, <span class="st">"rate_autoc"</span>)</span>
<span id="cb4-900"><a href="#cb4-900"></a></span>
<span id="cb4-901"><a href="#cb4-901"></a>qini_rate_plots <span class="ot">&lt;-</span></span>
<span id="cb4-902"><a href="#cb4-902"></a>  <span class="fu">margot_plot_rate_batch</span>(</span>
<span id="cb4-903"><a href="#cb4-903"></a>    <span class="at">models      =</span> models_binary_flipped_all,</span>
<span id="cb4-904"><a href="#cb4-904"></a>    <span class="at">save_plots  =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-905"><a href="#cb4-905"></a>    <span class="at">model_names =</span> model_groups<span class="sc">$</span>qini</span>
<span id="cb4-906"><a href="#cb4-906"></a>  )</span>
<span id="cb4-907"><a href="#cb4-907"></a>combined_qini_rate <span class="ot">&lt;-</span> <span class="fu">combine_and_save</span>(qini_rate_plots, <span class="st">"rate_qini"</span>)</span>
<span id="cb4-908"><a href="#cb4-908"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"rate curves plotted ✔"</span>)</span>
<span id="cb4-909"><a href="#cb4-909"></a></span>
<span id="cb4-910"><a href="#cb4-910"></a><span class="co"># view </span></span>
<span id="cb4-911"><a href="#cb4-911"></a>autoc_plots<span class="sc">$</span>model_t2_log_hours_exercise_z</span>
<span id="cb4-912"><a href="#cb4-912"></a>autoc_plots<span class="sc">$</span>model_t2_meaning_sense_z</span>
<span id="cb4-913"><a href="#cb4-913"></a></span>
<span id="cb4-914"><a href="#cb4-914"></a><span class="co"># step 4: Qini model curves --------------------------------------------</span></span>
<span id="cb4-915"><a href="#cb4-915"></a>qini_policy_results <span class="ot">&lt;-</span></span>
<span id="cb4-916"><a href="#cb4-916"></a>  <span class="fu">margot_policy</span>(</span>
<span id="cb4-917"><a href="#cb4-917"></a>    models_binary_flipped_all,</span>
<span id="cb4-918"><a href="#cb4-918"></a>    <span class="at">save_plots         =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-919"><a href="#cb4-919"></a>    <span class="at">output_dir         =</span> here<span class="sc">::</span><span class="fu">here</span>(push_mods),</span>
<span id="cb4-920"><a href="#cb4-920"></a>    <span class="at">decision_tree_args =</span> <span class="fu">list</span>(),</span>
<span id="cb4-921"><a href="#cb4-921"></a>    <span class="at">policy_tree_args   =</span> <span class="fu">list</span>(),</span>
<span id="cb4-922"><a href="#cb4-922"></a>    <span class="at">model_names        =</span> model_groups<span class="sc">$</span>qini,</span>
<span id="cb4-923"><a href="#cb4-923"></a>    <span class="at">original_df        =</span> original_df,</span>
<span id="cb4-924"><a href="#cb4-924"></a>    <span class="at">label_mapping      =</span> label_mapping_all,</span>
<span id="cb4-925"><a href="#cb4-925"></a>    <span class="at">max_depth          =</span> <span class="dv">2</span>L,</span>
<span id="cb4-926"><a href="#cb4-926"></a>    <span class="at">output_objects     =</span> <span class="fu">c</span>(<span class="st">"qini_plot"</span>, <span class="st">"diff_gain_summaries"</span>)</span>
<span id="cb4-927"><a href="#cb4-927"></a>  )</span>
<span id="cb4-928"><a href="#cb4-928"></a></span>
<span id="cb4-929"><a href="#cb4-929"></a><span class="co"># extract and combine Qini plots\ nqini_plots &lt;- purrr::map(qini_policy_results, ~ .x[[1]])</span></span>
<span id="cb4-930"><a href="#cb4-930"></a>combined_qini_curves <span class="ot">&lt;-</span> <span class="fu">combine_and_save</span>(qini_plots, <span class="st">"qini_curves"</span>)</span>
<span id="cb4-931"><a href="#cb4-931"></a></span>
<span id="cb4-932"><a href="#cb4-932"></a><span class="co"># view qini plots</span></span>
<span id="cb4-933"><a href="#cb4-933"></a>qini_plots <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(qini_policy_results, <span class="sc">~</span> .x<span class="sc">$</span>qini_plot)</span>
<span id="cb4-934"><a href="#cb4-934"></a>qini_plots</span>
<span id="cb4-935"><a href="#cb4-935"></a></span>
<span id="cb4-936"><a href="#cb4-936"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"Qini model curves plotted ✔"</span>)</span>
<span id="cb4-937"><a href="#cb4-937"></a></span>
<span id="cb4-938"><a href="#cb4-938"></a><span class="co"># step 5: main focus – 2-level policy trees -------------------------------</span></span>
<span id="cb4-939"><a href="#cb4-939"></a><span class="co"># policy value (our 2-level tree on the 30 % test fold) asks: 'under a low-complexity rule, do treated units in the selected leaves really outperform?'</span></span>
<span id="cb4-940"><a href="#cb4-940"></a>policy_2L <span class="ot">&lt;-</span></span>
<span id="cb4-941"><a href="#cb4-941"></a>  <span class="fu">margot_policy</span>(</span>
<span id="cb4-942"><a href="#cb4-942"></a>    models_binary_flipped_all,</span>
<span id="cb4-943"><a href="#cb4-943"></a>    <span class="at">save_plots         =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-944"><a href="#cb4-944"></a>    <span class="at">output_dir         =</span> here<span class="sc">::</span><span class="fu">here</span>(push_mods),</span>
<span id="cb4-945"><a href="#cb4-945"></a>    <span class="at">decision_tree_args =</span> decision_tree_defaults,</span>
<span id="cb4-946"><a href="#cb4-946"></a>    <span class="at">policy_tree_args   =</span> policy_tree_defaults,</span>
<span id="cb4-947"><a href="#cb4-947"></a>    <span class="at">model_names        =</span> model_groups<span class="sc">$</span>either,</span>
<span id="cb4-948"><a href="#cb4-948"></a>    <span class="at">original_df        =</span> original_df,</span>
<span id="cb4-949"><a href="#cb4-949"></a>    <span class="at">label_mapping      =</span> label_mapping_all,</span>
<span id="cb4-950"><a href="#cb4-950"></a>    <span class="at">max_depth          =</span> <span class="dv">2</span>L,</span>
<span id="cb4-951"><a href="#cb4-951"></a>    <span class="at">output_objects     =</span> <span class="st">"combined_plot"</span></span>
<span id="cb4-952"><a href="#cb4-952"></a>  )</span>
<span id="cb4-953"><a href="#cb4-953"></a></span>
<span id="cb4-954"><a href="#cb4-954"></a><span class="co"># extract and display 2L policy tree plots</span></span>
<span id="cb4-955"><a href="#cb4-955"></a>plots_2L <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(policy_2L, <span class="sc">~</span> .x[[<span class="dv">1</span>]])</span>
<span id="cb4-956"><a href="#cb4-956"></a>purrr<span class="sc">::</span><span class="fu">walk</span>(plots_2L, print)</span>
<span id="cb4-957"><a href="#cb4-957"></a></span>
<span id="cb4-958"><a href="#cb4-958"></a><span class="co"># interpret 2L policy trees</span></span>
<span id="cb4-959"><a href="#cb4-959"></a>interp_2L <span class="ot">&lt;-</span></span>
<span id="cb4-960"><a href="#cb4-960"></a>  <span class="fu">margot_interpret_policy_batch</span>(</span>
<span id="cb4-961"><a href="#cb4-961"></a>    models_binary_flipped_all,</span>
<span id="cb4-962"><a href="#cb4-962"></a>    <span class="at">model_names =</span> model_groups<span class="sc">$</span>either</span>
<span id="cb4-963"><a href="#cb4-963"></a>  )</span>
<span id="cb4-964"><a href="#cb4-964"></a><span class="fu">cat</span>(interp_2L, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-965"><a href="#cb4-965"></a></span>
<span id="cb4-966"><a href="#cb4-966"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"main 2L policy trees analysed ✔"</span>)</span>
<span id="cb4-967"><a href="#cb4-967"></a></span>
<span id="cb4-968"><a href="#cb4-968"></a><span class="co"># step 6: secondary focus – qualitative assessment of policy trees ----</span></span>
<span id="cb4-969"><a href="#cb4-969"></a>policy_1L <span class="ot">&lt;-</span></span>
<span id="cb4-970"><a href="#cb4-970"></a>  <span class="fu">margot_policy</span>(</span>
<span id="cb4-971"><a href="#cb4-971"></a>    models_binary_flipped_all,</span>
<span id="cb4-972"><a href="#cb4-972"></a>    <span class="at">save_plots         =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-973"><a href="#cb4-973"></a>    <span class="at">output_dir         =</span> here<span class="sc">::</span><span class="fu">here</span>(push_mods),</span>
<span id="cb4-974"><a href="#cb4-974"></a>    <span class="at">decision_tree_args =</span> decision_tree_defaults,</span>
<span id="cb4-975"><a href="#cb4-975"></a>    <span class="at">policy_tree_args   =</span> policy_tree_defaults,</span>
<span id="cb4-976"><a href="#cb4-976"></a>    <span class="at">model_names        =</span> model_groups<span class="sc">$</span>either,</span>
<span id="cb4-977"><a href="#cb4-977"></a>    <span class="at">original_df        =</span> original_df,</span>
<span id="cb4-978"><a href="#cb4-978"></a>    <span class="at">label_mapping      =</span> label_mapping_all,</span>
<span id="cb4-979"><a href="#cb4-979"></a>    <span class="at">max_depth          =</span> <span class="dv">1</span>L,</span>
<span id="cb4-980"><a href="#cb4-980"></a>    <span class="at">output_objects     =</span> <span class="st">"combined_plot"</span></span>
<span id="cb4-981"><a href="#cb4-981"></a>  )</span>
<span id="cb4-982"><a href="#cb4-982"></a>plots_1L <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(policy_1L, <span class="sc">~</span> .x[[<span class="dv">1</span>]])</span>
<span id="cb4-983"><a href="#cb4-983"></a></span>
<span id="cb4-984"><a href="#cb4-984"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"secondary 1L policy trees reviewed ✔"</span>)</span>
<span id="cb4-985"><a href="#cb4-985"></a></span>
<span id="cb4-986"><a href="#cb4-986"></a><span class="co"># view</span></span>
<span id="cb4-987"><a href="#cb4-987"></a>plots_1L<span class="sc">$</span>model_t2_log_hours_exercise_z</span>
<span id="cb4-988"><a href="#cb4-988"></a>plots_1L<span class="sc">$</span>model_t2_meaning_sense_z</span>
<span id="cb4-989"><a href="#cb4-989"></a></span>
<span id="cb4-990"><a href="#cb4-990"></a><span class="co"># step 7: secondary focus – 2-level policy trees -------------------------</span></span>
<span id="cb4-991"><a href="#cb4-991"></a><span class="co"># policies fror all outcomes</span></span>
<span id="cb4-992"><a href="#cb4-992"></a>policy_all_2L <span class="ot">&lt;-</span></span>
<span id="cb4-993"><a href="#cb4-993"></a>  <span class="fu">margot_policy</span>(</span>
<span id="cb4-994"><a href="#cb4-994"></a>    models_binary_flipped_all,</span>
<span id="cb4-995"><a href="#cb4-995"></a>    <span class="at">save_plots         =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-996"><a href="#cb4-996"></a>    <span class="at">output_dir         =</span> here<span class="sc">::</span><span class="fu">here</span>(push_mods),</span>
<span id="cb4-997"><a href="#cb4-997"></a>    <span class="at">decision_tree_args =</span> decision_tree_defaults,</span>
<span id="cb4-998"><a href="#cb4-998"></a>    <span class="at">policy_tree_args   =</span> policy_tree_defaults,</span>
<span id="cb4-999"><a href="#cb4-999"></a>    <span class="co"># model_names        = model_groups$either,</span></span>
<span id="cb4-1000"><a href="#cb4-1000"></a>    <span class="at">original_df        =</span> original_df,</span>
<span id="cb4-1001"><a href="#cb4-1001"></a>    <span class="at">label_mapping      =</span> label_mapping_all,</span>
<span id="cb4-1002"><a href="#cb4-1002"></a>    <span class="at">max_depth          =</span> <span class="dv">2</span>L,</span>
<span id="cb4-1003"><a href="#cb4-1003"></a>    <span class="at">output_objects     =</span> <span class="st">"combined_plot"</span></span>
<span id="cb4-1004"><a href="#cb4-1004"></a>  )</span>
<span id="cb4-1005"><a href="#cb4-1005"></a><span class="co"># extract and display 2L policy tree plots</span></span>
<span id="cb4-1006"><a href="#cb4-1006"></a>plots_all_2L <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(policy_all_2L, <span class="sc">~</span> .x[[<span class="dv">1</span>]])</span>
<span id="cb4-1007"><a href="#cb4-1007"></a>purrr<span class="sc">::</span><span class="fu">walk</span>(plots_all_2L, print).</span>
<span id="cb4-1008"><a href="#cb4-1008"></a></span>
<span id="cb4-1009"><a href="#cb4-1009"></a><span class="co"># view</span></span>
<span id="cb4-1010"><a href="#cb4-1010"></a>plots_all_2L<span class="sc">$</span>model_t2_log_hours_exercise_z</span>
<span id="cb4-1011"><a href="#cb4-1011"></a>plots_all_2L<span class="sc">$</span>model_t2_meaning_sense_z</span>
<span id="cb4-1012"><a href="#cb4-1012"></a></span>
<span id="cb4-1013"><a href="#cb4-1013"></a><span class="co"># others -- not reliable, only exploratory</span></span>
<span id="cb4-1014"><a href="#cb4-1014"></a>plots_all_2L<span class="sc">$</span>model_t2_belong_z <span class="co"># etc</span></span>
<span id="cb4-1015"><a href="#cb4-1015"></a></span>
<span id="cb4-1016"><a href="#cb4-1016"></a></span>
<span id="cb4-1017"><a href="#cb4-1017"></a><span class="co"># interpret 2L policy trees</span></span>
<span id="cb4-1018"><a href="#cb4-1018"></a>interp_all_2L <span class="ot">&lt;-</span></span>
<span id="cb4-1019"><a href="#cb4-1019"></a>  <span class="fu">margot_interpret_policy_batch</span>(</span>
<span id="cb4-1020"><a href="#cb4-1020"></a>    models_binary_flipped_all,</span>
<span id="cb4-1021"><a href="#cb4-1021"></a>    <span class="at">model_names =</span> model_groups<span class="sc">$</span>either</span>
<span id="cb4-1022"><a href="#cb4-1022"></a>  )</span>
<span id="cb4-1023"><a href="#cb4-1023"></a><span class="fu">cat</span>(interp_all_2L, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-1024"><a href="#cb4-1024"></a></span>
<span id="cb4-1025"><a href="#cb4-1025"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"main 2L policy trees analysed ✔"</span>)</span>
<span id="cb4-1026"><a href="#cb4-1026"></a>plots_all_2L<span class="sc">$</span>model_t2_belong_z</span>
<span id="cb4-1027"><a href="#cb4-1027"></a></span>
<span id="cb4-1028"><a href="#cb4-1028"></a></span>
<span id="cb4-1029"><a href="#cb4-1029"></a></span>
<span id="cb4-1030"><a href="#cb4-1030"></a><span class="co"># step 8 BONFERRONI CORRECTION TO WORKFLOW ---------------------------------------</span></span>
<span id="cb4-1031"><a href="#cb4-1031"></a><span class="co">#–– 1·a  (already produced by margot_flip_forests) ––––––––––––––––––––––</span></span>
<span id="cb4-1032"><a href="#cb4-1032"></a>flipped <span class="ot">&lt;-</span> models_binary_flipped_all          <span class="co"># &lt;- our object</span></span>
<span id="cb4-1033"><a href="#cb4-1033"></a></span>
<span id="cb4-1034"><a href="#cb4-1034"></a><span class="co">#–– 1·b  outcome-level screening ––––––––––––––––––––––––––––––––––––––––</span></span>
<span id="cb4-1035"><a href="#cb4-1035"></a><span class="co">#  ➜ keep outcomes whose ATE 95 % CI excludes 0   **OR**</span></span>
<span id="cb4-1036"><a href="#cb4-1036"></a><span class="co">#    whose AUTOC RATE CI excludes 0  (choose your favourite rule)</span></span>
<span id="cb4-1037"><a href="#cb4-1037"></a></span>
<span id="cb4-1038"><a href="#cb4-1038"></a>keep <span class="ot">&lt;-</span> <span class="fu">margot_screen_models</span>(</span>
<span id="cb4-1039"><a href="#cb4-1039"></a>  flipped,</span>
<span id="cb4-1040"><a href="#cb4-1040"></a>  <span class="at">rule =</span> <span class="st">"rate"</span>,        <span class="co"># &lt;– implementation-specific</span></span>
<span id="cb4-1041"><a href="#cb4-1041"></a>  <span class="at">target =</span> <span class="st">"either"</span>,            <span class="co"># &lt;– or "QINI"</span></span>
<span id="cb4-1042"><a href="#cb4-1042"></a>  <span class="at">alpha =</span> <span class="fl">0.05</span>,</span>
<span id="cb4-1043"><a href="#cb4-1043"></a>  <span class="at">adjust =</span>  <span class="st">"bonferroni"</span></span>
<span id="cb4-1044"><a href="#cb4-1044"></a>)</span>
<span id="cb4-1045"><a href="#cb4-1045"></a></span>
<span id="cb4-1046"><a href="#cb4-1046"></a></span>
<span id="cb4-1047"><a href="#cb4-1047"></a><span class="co"># get models</span></span>
<span id="cb4-1048"><a href="#cb4-1048"></a>model_keep  <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"model_"</span>, keep)</span>
<span id="cb4-1049"><a href="#cb4-1049"></a></span>
<span id="cb4-1050"><a href="#cb4-1050"></a><span class="co"># view</span></span>
<span id="cb4-1051"><a href="#cb4-1051"></a>model_keep</span>
<span id="cb4-1052"><a href="#cb4-1052"></a></span>
<span id="cb4-1053"><a href="#cb4-1053"></a><span class="co"># corrected policies</span></span>
<span id="cb4-1054"><a href="#cb4-1054"></a>policy_2L_corrected <span class="ot">&lt;-</span></span>
<span id="cb4-1055"><a href="#cb4-1055"></a>  <span class="fu">margot_policy</span>(</span>
<span id="cb4-1056"><a href="#cb4-1056"></a>    models_binary_flipped_all,</span>
<span id="cb4-1057"><a href="#cb4-1057"></a>    <span class="at">save_plots         =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-1058"><a href="#cb4-1058"></a>    <span class="at">output_dir         =</span> here<span class="sc">::</span><span class="fu">here</span>(push_mods),</span>
<span id="cb4-1059"><a href="#cb4-1059"></a>    <span class="at">decision_tree_args =</span> decision_tree_defaults,</span>
<span id="cb4-1060"><a href="#cb4-1060"></a>    <span class="at">policy_tree_args   =</span> policy_tree_defaults,</span>
<span id="cb4-1061"><a href="#cb4-1061"></a>    <span class="at">model_names        =</span> model_keep,</span>
<span id="cb4-1062"><a href="#cb4-1062"></a>    <span class="at">original_df        =</span> original_df,</span>
<span id="cb4-1063"><a href="#cb4-1063"></a>    <span class="at">label_mapping      =</span> label_mapping_all,</span>
<span id="cb4-1064"><a href="#cb4-1064"></a>    <span class="at">max_depth          =</span> <span class="dv">2</span>L,</span>
<span id="cb4-1065"><a href="#cb4-1065"></a>    <span class="at">output_objects     =</span> <span class="st">"combined_plot"</span></span>
<span id="cb4-1066"><a href="#cb4-1066"></a>  )</span>
<span id="cb4-1067"><a href="#cb4-1067"></a><span class="co"># extract and display 2L policy tree plots</span></span>
<span id="cb4-1068"><a href="#cb4-1068"></a>plots_2L_corrected <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(policy_2L_corrected, <span class="sc">~</span> .x[[<span class="dv">1</span>]])</span>
<span id="cb4-1069"><a href="#cb4-1069"></a>purrr<span class="sc">::</span><span class="fu">walk</span>(plots_2L_corrected, print)</span>
<span id="cb4-1070"><a href="#cb4-1070"></a></span>
<span id="cb4-1071"><a href="#cb4-1071"></a><span class="co"># view</span></span>
<span id="cb4-1072"><a href="#cb4-1072"></a>plots_2L_corrected<span class="sc">$</span>model_t2_neighbourhood_community_z</span>
<span id="cb4-1073"><a href="#cb4-1073"></a></span>
<span id="cb4-1074"><a href="#cb4-1074"></a></span>
<span id="cb4-1075"><a href="#cb4-1075"></a><span class="co"># others -- not reliable, only exploratory</span></span>
<span id="cb4-1076"><a href="#cb4-1076"></a>plots_all_2L<span class="sc">$</span>model_t2_belong_z <span class="co"># etc</span></span>
<span id="cb4-1077"><a href="#cb4-1077"></a></span>
<span id="cb4-1078"><a href="#cb4-1078"></a></span>
<span id="cb4-1079"><a href="#cb4-1079"></a><span class="co"># interpret 2L policy trees</span></span>
<span id="cb4-1080"><a href="#cb4-1080"></a>interp_all_2L <span class="ot">&lt;-</span></span>
<span id="cb4-1081"><a href="#cb4-1081"></a>  <span class="fu">margot_interpret_policy_batch</span>(models_binary_flipped_all, <span class="at">model_names =</span> model_groups<span class="sc">$</span>either)</span>
<span id="cb4-1082"><a href="#cb4-1082"></a><span class="fu">cat</span>(interp_all_2L, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-1083"><a href="#cb4-1083"></a></span>
<span id="cb4-1084"><a href="#cb4-1084"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"main 2L policy trees analysed ✔"</span>)</span>
<span id="cb4-1085"><a href="#cb4-1085"></a>plots_all_2L<span class="sc">$</span>model_t2_belong_z</span>
<span id="cb4-1086"><a href="#cb4-1086"></a></span>
<span id="cb4-1087"><a href="#cb4-1087"></a><span class="co"># view</span></span>
<span id="cb4-1088"><a href="#cb4-1088"></a>models_binary_flipped_all<span class="sc">$</span>results<span class="sc">$</span>model_t2_kessler_latent_anxiety_z<span class="sc">$</span>policy_tree_depth_2</span>
<span id="cb4-1089"><a href="#cb4-1089"></a></span>
<span id="cb4-1090"><a href="#cb4-1090"></a></span>
<span id="cb4-1091"><a href="#cb4-1091"></a></span>
<span id="cb4-1092"><a href="#cb4-1092"></a><span class="co"># IGNORE - DEVELOPING</span></span>
<span id="cb4-1093"><a href="#cb4-1093"></a><span class="co"># #–– 2·b  loop over the *kept* outcomes only ––––––––––––––––––––––––––––</span></span>
<span id="cb4-1094"><a href="#cb4-1094"></a><span class="co"># developing</span></span>
<span id="cb4-1095"><a href="#cb4-1095"></a><span class="co"># flipped$results[paste0("model_", keep)] &lt;-</span></span>
<span id="cb4-1096"><a href="#cb4-1096"></a><span class="co">#   purrr::map(flipped$results[paste0("model_", keep)],</span></span>
<span id="cb4-1097"><a href="#cb4-1097"></a><span class="co">#              add_policy_p,</span></span>
<span id="cb4-1098"><a href="#cb4-1098"></a><span class="co">#              depth = 2,</span></span>
<span id="cb4-1099"><a href="#cb4-1099"></a><span class="co">#              R     = 999,</span></span>
<span id="cb4-1100"><a href="#cb4-1100"></a><span class="co">#              seed  = 2025)</span></span>
<span id="cb4-1101"><a href="#cb4-1101"></a><span class="co"># </span></span>
<span id="cb4-1102"><a href="#cb4-1102"></a><span class="co"># </span></span>
<span id="cb4-1103"><a href="#cb4-1103"></a><span class="co"># # view</span></span>
<span id="cb4-1104"><a href="#cb4-1104"></a><span class="co"># flipped$results$model_t2_belong_z$policy_value</span></span>
<span id="cb4-1105"><a href="#cb4-1105"></a><span class="co"># </span></span>
<span id="cb4-1106"><a href="#cb4-1106"></a><span class="co"># </span></span>
<span id="cb4-1107"><a href="#cb4-1107"></a><span class="co"># #–– 3·a  assemble every metric + Bonferroni adjustment ––––––––––––––––––</span></span>
<span id="cb4-1108"><a href="#cb4-1108"></a><span class="co"># res_tbl  &lt;- margot_summarise_all(flipped, target = "both", adjust = "none")</span></span>
<span id="cb4-1109"><a href="#cb4-1109"></a><span class="co"># dplyr::glimpse(res_tbl)</span></span>
<span id="cb4-1110"><a href="#cb4-1110"></a><span class="co"># </span></span>
<span id="cb4-1111"><a href="#cb4-1111"></a><span class="co"># # focus on the screened models only</span></span>
<span id="cb4-1112"><a href="#cb4-1112"></a><span class="co"># res_tbl &lt;- dplyr::filter(res_tbl, outcome %in% keep) |&gt;</span></span>
<span id="cb4-1113"><a href="#cb4-1113"></a><span class="co">#   dplyr::mutate(</span></span>
<span id="cb4-1114"><a href="#cb4-1114"></a><span class="co">#     pv_est = purrr::map_dbl(outcome,</span></span>
<span id="cb4-1115"><a href="#cb4-1115"></a><span class="co">#                             ~ flipped$results[[paste0("model_", .x)]]$policy_value$estimate),</span></span>
<span id="cb4-1116"><a href="#cb4-1116"></a><span class="co">#     pv_se  = purrr::map_dbl(outcome,</span></span>
<span id="cb4-1117"><a href="#cb4-1117"></a><span class="co">#                             ~ flipped$results[[paste0("model_", .x)]]$policy_value$std.err)</span></span>
<span id="cb4-1118"><a href="#cb4-1118"></a><span class="co">#   )</span></span>
<span id="cb4-1119"><a href="#cb4-1119"></a><span class="co"># </span></span>
<span id="cb4-1120"><a href="#cb4-1120"></a><span class="co"># #–– 3·b  prettify &amp; print –––––––––––––––––––––––––––––––––––––––––––––––</span></span>
<span id="cb4-1121"><a href="#cb4-1121"></a><span class="co"># report &lt;- res_tbl %&gt;%</span></span>
<span id="cb4-1122"><a href="#cb4-1122"></a><span class="co">#   transmute(</span></span>
<span id="cb4-1123"><a href="#cb4-1123"></a><span class="co">#     Outcome        = tools::toTitleCase(gsub("_z$", "", sub("^t2_", "", outcome))),</span></span>
<span id="cb4-1124"><a href="#cb4-1124"></a><span class="co">#     `ATE  (±SE)`   = sprintf("%.3f ± %.3f", ate_est,  ate_se),</span></span>
<span id="cb4-1125"><a href="#cb4-1125"></a><span class="co">#     `RATE AUTOC`   = sprintf("%.3f [%.3f, %.3f]",</span></span>
<span id="cb4-1126"><a href="#cb4-1126"></a><span class="co">#                              rate_autoc, rate_autoc_lo, rate_autoc_hi),</span></span>
<span id="cb4-1127"><a href="#cb4-1127"></a><span class="co">#     `RATE QINI`    = sprintf("%.3f [%.3f, %.3f]",</span></span>
<span id="cb4-1128"><a href="#cb4-1128"></a><span class="co">#                              rate_qini,  rate_qini_lo,  rate_qini_hi),</span></span>
<span id="cb4-1129"><a href="#cb4-1129"></a><span class="co">#     `Policy Δ (±SE)` = sprintf("%.3f ± %.3f", pv_est, pv_se),</span></span>
<span id="cb4-1130"><a href="#cb4-1130"></a><span class="co">#     `Policy p`     = sprintf("%.3f", policy_p),</span></span>
<span id="cb4-1131"><a href="#cb4-1131"></a><span class="co">#     `p-adj`        = sprintf("%.3f", p_adj),</span></span>
<span id="cb4-1132"><a href="#cb4-1132"></a><span class="co">#     `Sig FW(.05)`  = ifelse(pass, "✓", "✗")</span></span>
<span id="cb4-1133"><a href="#cb4-1133"></a><span class="co">#   )</span></span>
<span id="cb4-1134"><a href="#cb4-1134"></a><span class="co"># knitr::kable(report, caption = "Treatment-effect &amp; policy results (Bonferroni corrected)")</span></span>
<span id="cb4-1135"><a href="#cb4-1135"></a></span>
<span id="cb4-1136"><a href="#cb4-1136"></a></span>
<span id="cb4-1137"><a href="#cb4-1137"></a></span>
<span id="cb4-1138"><a href="#cb4-1138"></a></span>
<span id="cb4-1139"><a href="#cb4-1139"></a><span class="co"># PLANNED COMPARISONS -----------------------------------------------------</span></span>
<span id="cb4-1140"><a href="#cb4-1140"></a></span>
<span id="cb4-1141"><a href="#cb4-1141"></a></span>
<span id="cb4-1142"><a href="#cb4-1142"></a></span>
<span id="cb4-1143"><a href="#cb4-1143"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-1144"><a href="#cb4-1144"></a><span class="co"># |    MODIFY THIS SECTION   |</span></span>
<span id="cb4-1145"><a href="#cb4-1145"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-1146"><a href="#cb4-1146"></a></span>
<span id="cb4-1147"><a href="#cb4-1147"></a></span>
<span id="cb4-1148"><a href="#cb4-1148"></a></span>
<span id="cb4-1149"><a href="#cb4-1149"></a><span class="co"># theoretical comparisons ---------------------------------------------------</span></span>
<span id="cb4-1150"><a href="#cb4-1150"></a><span class="co"># individual theoretical comparisons (if relevant)</span></span>
<span id="cb4-1151"><a href="#cb4-1151"></a><span class="co"># need to get values for wealth if wealth is compared</span></span>
<span id="cb4-1152"><a href="#cb4-1152"></a></span>
<span id="cb4-1153"><a href="#cb4-1153"></a><span class="co"># step 1 get information for wealth for conditonal comparisons</span></span>
<span id="cb4-1154"><a href="#cb4-1154"></a><span class="fu">head</span>(df_grf<span class="sc">$</span>t0_log_household_inc_z)</span>
<span id="cb4-1155"><a href="#cb4-1155"></a></span>
<span id="cb4-1156"><a href="#cb4-1156"></a><span class="co"># get mean on original data scale</span></span>
<span id="cb4-1157"><a href="#cb4-1157"></a>log_mean_inc <span class="ot">&lt;-</span> <span class="fu">mean</span>(original_df<span class="sc">$</span>t0_log_household_inc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-1158"><a href="#cb4-1158"></a></span>
<span id="cb4-1159"><a href="#cb4-1159"></a><span class="co"># get sd on original data scale</span></span>
<span id="cb4-1160"><a href="#cb4-1160"></a>log_sd_inc <span class="ot">&lt;-</span> <span class="fu">sd</span>(original_df<span class="sc">$</span>t0_log_household_inc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-1161"><a href="#cb4-1161"></a></span>
<span id="cb4-1162"><a href="#cb4-1162"></a><span class="co"># function to get back to data scale</span></span>
<span id="cb4-1163"><a href="#cb4-1163"></a><span class="fu">margot_back_transform_log_z</span>(</span>
<span id="cb4-1164"><a href="#cb4-1164"></a>  <span class="at">log_mean =</span> log_mean_inc,</span>
<span id="cb4-1165"><a href="#cb4-1165"></a>  <span class="at">log_sd =</span> log_sd_inc,</span>
<span id="cb4-1166"><a href="#cb4-1166"></a>  <span class="at">z_scores =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb4-1167"><a href="#cb4-1167"></a>  <span class="at">label =</span> <span class="st">"data_scale"</span></span>
<span id="cb4-1168"><a href="#cb4-1168"></a>)</span>
<span id="cb4-1169"><a href="#cb4-1169"></a></span>
<span id="cb4-1170"><a href="#cb4-1170"></a><span class="co"># define complex conditions for subsetting</span></span>
<span id="cb4-1171"><a href="#cb4-1171"></a>complex_condition_political <span class="ot">&lt;-</span> X[, <span class="st">"t0_political_conservative_z"</span>] <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">&amp;</span></span>
<span id="cb4-1172"><a href="#cb4-1172"></a>  X[, <span class="st">"t0_political_conservative_z"</span>] <span class="sc">&lt;</span> <span class="dv">1</span></span>
<span id="cb4-1173"><a href="#cb4-1173"></a></span>
<span id="cb4-1174"><a href="#cb4-1174"></a>complex_condition_wealth <span class="ot">&lt;-</span> X[, <span class="st">"t0_log_household_inc_z"</span>] <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">&amp;</span></span>
<span id="cb4-1175"><a href="#cb4-1175"></a>  X[, <span class="st">"t0_log_household_inc_z"</span>] <span class="sc">&lt;</span> <span class="dv">1</span></span>
<span id="cb4-1176"><a href="#cb4-1176"></a></span>
<span id="cb4-1177"><a href="#cb4-1177"></a>complex_condition_age <span class="ot">&lt;-</span> X[, <span class="st">"t0_age_z"</span>] <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">&amp;</span></span>
<span id="cb4-1178"><a href="#cb4-1178"></a>  X[, <span class="st">"t0_age_z"</span>] <span class="sc">&lt;</span> <span class="dv">1</span></span>
<span id="cb4-1179"><a href="#cb4-1179"></a></span>
<span id="cb4-1180"><a href="#cb4-1180"></a><span class="co"># # if we have specific groups to compare</span></span>
<span id="cb4-1181"><a href="#cb4-1181"></a><span class="co"># complex_condition_age_under_neg_1_sd  &lt;- X[, "t0_age_z"] &lt; -1</span></span>
<span id="cb4-1182"><a href="#cb4-1182"></a><span class="co"># complex_condition_age_gr_eq_neg_1_sd  &lt;- X[, "t0_age_z"] &gt; -1</span></span>
<span id="cb4-1183"><a href="#cb4-1183"></a></span>
<span id="cb4-1184"><a href="#cb4-1184"></a><span class="co"># check ages to get number</span></span>
<span id="cb4-1185"><a href="#cb4-1185"></a><span class="fu">mean</span>(original_df<span class="sc">$</span>t0_age) <span class="sc">-</span> <span class="fu">sd</span>(original_df<span class="sc">$</span>t0_age)</span>
<span id="cb4-1186"><a href="#cb4-1186"></a><span class="fu">mean</span>(original_df<span class="sc">$</span>t0_age) <span class="sc">+</span> <span class="fu">sd</span>(original_df<span class="sc">$</span>t0_age)</span>
<span id="cb4-1187"><a href="#cb4-1187"></a></span>
<span id="cb4-1188"><a href="#cb4-1188"></a></span>
<span id="cb4-1189"><a href="#cb4-1189"></a><span class="co"># wealth subsets</span></span>
<span id="cb4-1190"><a href="#cb4-1190"></a>subsets_standard_wealth <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-1191"><a href="#cb4-1191"></a>  <span class="at">Poor =</span> <span class="fu">list</span>(</span>
<span id="cb4-1192"><a href="#cb4-1192"></a>    <span class="at">var =</span> <span class="st">"t0_log_household_inc_z"</span>,</span>
<span id="cb4-1193"><a href="#cb4-1193"></a>    <span class="at">value =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb4-1194"><a href="#cb4-1194"></a>    <span class="at">operator =</span> <span class="st">"&lt;"</span>,</span>
<span id="cb4-1195"><a href="#cb4-1195"></a>    <span class="at">description =</span> <span class="st">"Effects among those HShold income &lt; -1 SD (NZD ~41k)"</span>,</span>
<span id="cb4-1196"><a href="#cb4-1196"></a>    <span class="at">label =</span> <span class="st">"Poor"</span>  <span class="co"># label remains as is, but could be changed if desired</span></span>
<span id="cb4-1197"><a href="#cb4-1197"></a>  ),</span>
<span id="cb4-1198"><a href="#cb4-1198"></a>  <span class="at">MiddleIncome =</span> <span class="fu">list</span>(<span class="at">subset_condition =</span> complex_condition_wealth, <span class="at">description =</span> <span class="st">"Effects among those HS_hold income within +/-1SD (&gt; NZD 41k &lt; NZD 191k)"</span>),</span>
<span id="cb4-1199"><a href="#cb4-1199"></a>  <span class="at">Rich =</span> <span class="fu">list</span>(</span>
<span id="cb4-1200"><a href="#cb4-1200"></a>    <span class="at">var =</span> <span class="st">"t0_log_household_inc_z"</span>,</span>
<span id="cb4-1201"><a href="#cb4-1201"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb4-1202"><a href="#cb4-1202"></a>    <span class="at">operator =</span> <span class="st">"&gt;"</span>,</span>
<span id="cb4-1203"><a href="#cb4-1203"></a>    <span class="at">description =</span> <span class="st">"Effects among those HS_hold income &gt; +1 SD (NZD 191k)"</span>,</span>
<span id="cb4-1204"><a href="#cb4-1204"></a>    <span class="at">label =</span> <span class="st">"Rich"</span></span>
<span id="cb4-1205"><a href="#cb4-1205"></a>  )</span>
<span id="cb4-1206"><a href="#cb4-1206"></a>)</span>
<span id="cb4-1207"><a href="#cb4-1207"></a></span>
<span id="cb4-1208"><a href="#cb4-1208"></a><span class="co"># political subsets</span></span>
<span id="cb4-1209"><a href="#cb4-1209"></a>subsets_standard_political <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-1210"><a href="#cb4-1210"></a>  <span class="at">Liberal =</span> <span class="fu">list</span>(</span>
<span id="cb4-1211"><a href="#cb4-1211"></a>    <span class="at">var =</span> <span class="st">"t0_political_conservative_z"</span>,</span>
<span id="cb4-1212"><a href="#cb4-1212"></a>    <span class="at">value =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb4-1213"><a href="#cb4-1213"></a>    <span class="at">operator =</span> <span class="st">"&lt;"</span>,</span>
<span id="cb4-1214"><a href="#cb4-1214"></a>    <span class="at">description =</span> <span class="st">"Effects among those &lt; -1 SD in political conservativism"</span>,</span>
<span id="cb4-1215"><a href="#cb4-1215"></a>    <span class="at">label =</span> <span class="st">"Liberal"</span></span>
<span id="cb4-1216"><a href="#cb4-1216"></a>  ),</span>
<span id="cb4-1217"><a href="#cb4-1217"></a>  <span class="at">Centrist =</span> <span class="fu">list</span>(</span>
<span id="cb4-1218"><a href="#cb4-1218"></a>    <span class="at">var =</span> <span class="st">"t0_political_conservative_z"</span>,</span>
<span id="cb4-1219"><a href="#cb4-1219"></a>    <span class="co"># operator = "&lt;",</span></span>
<span id="cb4-1220"><a href="#cb4-1220"></a>    <span class="at">subset_condition =</span> complex_condition_political,</span>
<span id="cb4-1221"><a href="#cb4-1221"></a>    <span class="at">description =</span> <span class="st">"Effects among those &gt; -1 SD and &lt; +1 in political conservativism"</span>,</span>
<span id="cb4-1222"><a href="#cb4-1222"></a>    <span class="at">label =</span> <span class="st">"Centrist"</span></span>
<span id="cb4-1223"><a href="#cb4-1223"></a>  ),</span>
<span id="cb4-1224"><a href="#cb4-1224"></a>  <span class="at">Conservative =</span> <span class="fu">list</span>(</span>
<span id="cb4-1225"><a href="#cb4-1225"></a>    <span class="at">var =</span> <span class="st">"t0_political_conservative_z"</span>,</span>
<span id="cb4-1226"><a href="#cb4-1226"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb4-1227"><a href="#cb4-1227"></a>    <span class="at">operator =</span> <span class="st">"&gt;"</span>,</span>
<span id="cb4-1228"><a href="#cb4-1228"></a>    <span class="at">description =</span> <span class="st">"Effects among those &gt; +1 SD in political conservativism"</span>,</span>
<span id="cb4-1229"><a href="#cb4-1229"></a>    <span class="at">label =</span> <span class="st">"Conservative"</span></span>
<span id="cb4-1230"><a href="#cb4-1230"></a>  )</span>
<span id="cb4-1231"><a href="#cb4-1231"></a>)</span>
<span id="cb4-1232"><a href="#cb4-1232"></a></span>
<span id="cb4-1233"><a href="#cb4-1233"></a></span>
<span id="cb4-1234"><a href="#cb4-1234"></a><span class="co"># political subsets</span></span>
<span id="cb4-1235"><a href="#cb4-1235"></a>subsets_standard_age <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-1236"><a href="#cb4-1236"></a>  <span class="at">Younger =</span> <span class="fu">list</span>(</span>
<span id="cb4-1237"><a href="#cb4-1237"></a>    <span class="at">var =</span> <span class="st">"t0_age_z"</span>,</span>
<span id="cb4-1238"><a href="#cb4-1238"></a>    <span class="at">value =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb4-1239"><a href="#cb4-1239"></a>    <span class="at">operator =</span> <span class="st">"&lt;"</span>,</span>
<span id="cb4-1240"><a href="#cb4-1240"></a>    <span class="at">description =</span> <span class="st">"Effects among those &lt; under 35 years old"</span>,</span>
<span id="cb4-1241"><a href="#cb4-1241"></a>    <span class="at">label =</span> <span class="st">"Age &lt; 35"</span></span>
<span id="cb4-1242"><a href="#cb4-1242"></a>  ),</span>
<span id="cb4-1243"><a href="#cb4-1243"></a>  <span class="at">Middle =</span> <span class="fu">list</span>(</span>
<span id="cb4-1244"><a href="#cb4-1244"></a>    <span class="at">var =</span> <span class="st">"t0_age_z"</span>,</span>
<span id="cb4-1245"><a href="#cb4-1245"></a>    <span class="co"># operator = "&lt;",</span></span>
<span id="cb4-1246"><a href="#cb4-1246"></a>    <span class="at">subset_condition =</span> complex_condition_age,</span>
<span id="cb4-1247"><a href="#cb4-1247"></a>    <span class="at">description =</span> <span class="st">"Effects among those 35-62"</span>,</span>
<span id="cb4-1248"><a href="#cb4-1248"></a>    <span class="at">label =</span> <span class="st">"Age 35-62"</span></span>
<span id="cb4-1249"><a href="#cb4-1249"></a>  ),</span>
<span id="cb4-1250"><a href="#cb4-1250"></a>  <span class="at">Older =</span> <span class="fu">list</span>(</span>
<span id="cb4-1251"><a href="#cb4-1251"></a>    <span class="at">var =</span> <span class="st">"t0_age_z"</span>,</span>
<span id="cb4-1252"><a href="#cb4-1252"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb4-1253"><a href="#cb4-1253"></a>    <span class="at">operator =</span> <span class="st">"&gt;"</span>,</span>
<span id="cb4-1254"><a href="#cb4-1254"></a>    <span class="at">description =</span> <span class="st">"Effects among those &gt; 62"</span>,</span>
<span id="cb4-1255"><a href="#cb4-1255"></a>    <span class="at">label =</span> <span class="st">"Age &gt; 62"</span></span>
<span id="cb4-1256"><a href="#cb4-1256"></a>  )</span>
<span id="cb4-1257"><a href="#cb4-1257"></a>)</span>
<span id="cb4-1258"><a href="#cb4-1258"></a></span>
<span id="cb4-1259"><a href="#cb4-1259"></a></span>
<span id="cb4-1260"><a href="#cb4-1260"></a><span class="co"># gender subsets</span></span>
<span id="cb4-1261"><a href="#cb4-1261"></a>subsets_standard_gender <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-1262"><a href="#cb4-1262"></a>  <span class="at">Female =</span> <span class="fu">list</span>(</span>
<span id="cb4-1263"><a href="#cb4-1263"></a>    <span class="at">var =</span> <span class="st">"t0_male_binary"</span>,</span>
<span id="cb4-1264"><a href="#cb4-1264"></a>    <span class="at">value =</span> <span class="dv">0</span>,</span>
<span id="cb4-1265"><a href="#cb4-1265"></a>    <span class="at">description =</span> <span class="st">"Females"</span></span>
<span id="cb4-1266"><a href="#cb4-1266"></a>  ),</span>
<span id="cb4-1267"><a href="#cb4-1267"></a>  <span class="at">Male =</span> <span class="fu">list</span>(</span>
<span id="cb4-1268"><a href="#cb4-1268"></a>    <span class="at">var =</span> <span class="st">"t0_male_binary"</span>,</span>
<span id="cb4-1269"><a href="#cb4-1269"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb4-1270"><a href="#cb4-1270"></a>    <span class="at">description =</span> <span class="st">"Males"</span></span>
<span id="cb4-1271"><a href="#cb4-1271"></a>  )</span>
<span id="cb4-1272"><a href="#cb4-1272"></a>)</span>
<span id="cb4-1273"><a href="#cb4-1273"></a></span>
<span id="cb4-1274"><a href="#cb4-1274"></a><span class="co"># ethnicity subsets</span></span>
<span id="cb4-1275"><a href="#cb4-1275"></a>subsets_standard_ethnicity <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-1276"><a href="#cb4-1276"></a>  <span class="at">Asian =</span> <span class="fu">list</span>(</span>
<span id="cb4-1277"><a href="#cb4-1277"></a>    <span class="at">var =</span> <span class="st">"t0_eth_cat_asian_binary"</span>,</span>
<span id="cb4-1278"><a href="#cb4-1278"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb4-1279"><a href="#cb4-1279"></a>    <span class="at">description =</span> <span class="st">"Asians"</span></span>
<span id="cb4-1280"><a href="#cb4-1280"></a>  ),</span>
<span id="cb4-1281"><a href="#cb4-1281"></a>  <span class="at">Euro =</span> <span class="fu">list</span>(</span>
<span id="cb4-1282"><a href="#cb4-1282"></a>    <span class="at">var =</span> <span class="st">"t0_eth_cat_euro_binary"</span>,</span>
<span id="cb4-1283"><a href="#cb4-1283"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb4-1284"><a href="#cb4-1284"></a>    <span class="at">description =</span> <span class="st">"Europeans (Pakeha)"</span></span>
<span id="cb4-1285"><a href="#cb4-1285"></a>  ),</span>
<span id="cb4-1286"><a href="#cb4-1286"></a>  <span class="at">Pacific =</span> <span class="fu">list</span>(</span>
<span id="cb4-1287"><a href="#cb4-1287"></a>    <span class="at">var =</span> <span class="st">"t0_eth_cat_pacific_binary"</span>,</span>
<span id="cb4-1288"><a href="#cb4-1288"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb4-1289"><a href="#cb4-1289"></a>    <span class="at">description =</span> <span class="st">"Pacific Peoples"</span></span>
<span id="cb4-1290"><a href="#cb4-1290"></a>  ),</span>
<span id="cb4-1291"><a href="#cb4-1291"></a>  <span class="at">Maori =</span> <span class="fu">list</span>(</span>
<span id="cb4-1292"><a href="#cb4-1292"></a>    <span class="at">var =</span> <span class="st">"t0_eth_cat_maori_binary"</span>,</span>
<span id="cb4-1293"><a href="#cb4-1293"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb4-1294"><a href="#cb4-1294"></a>    <span class="at">description =</span> <span class="st">"Māori"</span></span>
<span id="cb4-1295"><a href="#cb4-1295"></a>  )</span>
<span id="cb4-1296"><a href="#cb4-1296"></a>)</span>
<span id="cb4-1297"><a href="#cb4-1297"></a></span>
<span id="cb4-1298"><a href="#cb4-1298"></a></span>
<span id="cb4-1299"><a href="#cb4-1299"></a><span class="co"># batch planned subgroup analysis -----------------------------------------</span></span>
<span id="cb4-1300"><a href="#cb4-1300"></a><span class="co"># set up lists of models, names, and subtitles</span></span>
<span id="cb4-1301"><a href="#cb4-1301"></a>domain_models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-1302"><a href="#cb4-1302"></a>  models_binary <span class="co"># HERE WE USE THE ORIGINAL MODELS</span></span>
<span id="cb4-1303"><a href="#cb4-1303"></a>)</span>
<span id="cb4-1304"><a href="#cb4-1304"></a></span>
<span id="cb4-1305"><a href="#cb4-1305"></a></span>
<span id="cb4-1306"><a href="#cb4-1306"></a><span class="co"># set up domain names</span></span>
<span id="cb4-1307"><a href="#cb4-1307"></a>domain_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"wellbeing"</span>)</span>
<span id="cb4-1308"><a href="#cb4-1308"></a></span>
<span id="cb4-1309"><a href="#cb4-1309"></a><span class="co"># set up subtitles</span></span>
<span id="cb4-1310"><a href="#cb4-1310"></a>subtitles <span class="ot">&lt;-</span> <span class="st">""</span></span>
<span id="cb4-1311"><a href="#cb4-1311"></a></span>
<span id="cb4-1312"><a href="#cb4-1312"></a><span class="co"># set up subset types in a list</span></span>
<span id="cb4-1313"><a href="#cb4-1313"></a>subset_types <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-1314"><a href="#cb4-1314"></a>  <span class="at">wealth =</span> subsets_standard_wealth,</span>
<span id="cb4-1315"><a href="#cb4-1315"></a>  <span class="at">ethnicity =</span> subsets_standard_ethnicity,</span>
<span id="cb4-1316"><a href="#cb4-1316"></a>  <span class="at">political =</span> subsets_standard_political,</span>
<span id="cb4-1317"><a href="#cb4-1317"></a>  <span class="at">gender =</span> subsets_standard_gender,</span>
<span id="cb4-1318"><a href="#cb4-1318"></a>  <span class="at">cohort =</span> subsets_standard_age</span>
<span id="cb4-1319"><a href="#cb4-1319"></a>)</span>
<span id="cb4-1320"><a href="#cb4-1320"></a></span>
<span id="cb4-1321"><a href="#cb4-1321"></a></span>
<span id="cb4-1322"><a href="#cb4-1322"></a><span class="co"># run model</span></span>
<span id="cb4-1323"><a href="#cb4-1323"></a>planned_subset_results <span class="ot">&lt;-</span> <span class="fu">margot_planned_subgroups_batch</span>(</span>
<span id="cb4-1324"><a href="#cb4-1324"></a>  <span class="at">domain_models =</span> domain_models,</span>
<span id="cb4-1325"><a href="#cb4-1325"></a>  <span class="at">X =</span> X,</span>
<span id="cb4-1326"><a href="#cb4-1326"></a>  <span class="at">base_defaults =</span> base_defaults_binary,</span>
<span id="cb4-1327"><a href="#cb4-1327"></a>  <span class="at">subset_types =</span> subset_types,</span>
<span id="cb4-1328"><a href="#cb4-1328"></a>  <span class="at">original_df =</span> original_df,</span>
<span id="cb4-1329"><a href="#cb4-1329"></a>  <span class="at">domain_names =</span> domain_names,</span>
<span id="cb4-1330"><a href="#cb4-1330"></a>  <span class="at">subtitles =</span> subtitles</span>
<span id="cb4-1331"><a href="#cb4-1331"></a>)</span>
<span id="cb4-1332"><a href="#cb4-1332"></a></span>
<span id="cb4-1333"><a href="#cb4-1333"></a></span>
<span id="cb4-1334"><a href="#cb4-1334"></a><span class="co"># results</span></span>
<span id="cb4-1335"><a href="#cb4-1335"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>wealth<span class="sc">$</span>explanation)</span>
<span id="cb4-1336"><a href="#cb4-1336"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>ethnicity<span class="sc">$</span>explanation)</span>
<span id="cb4-1337"><a href="#cb4-1337"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>political<span class="sc">$</span>explanation)</span>
<span id="cb4-1338"><a href="#cb4-1338"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>gender<span class="sc">$</span>explanation)</span>
<span id="cb4-1339"><a href="#cb4-1339"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>cohort<span class="sc">$</span>explanation)</span>
<span id="cb4-1340"><a href="#cb4-1340"></a></span>
<span id="cb4-1341"><a href="#cb4-1341"></a></span>
<span id="cb4-1342"><a href="#cb4-1342"></a></span>
<span id="cb4-1343"><a href="#cb4-1343"></a><span class="co"># cohort subgroups --------------------------------------------------------</span></span>
<span id="cb4-1344"><a href="#cb4-1344"></a></span>
<span id="cb4-1345"><a href="#cb4-1345"></a><span class="co"># plots -------------------------------------------------------------------</span></span>
<span id="cb4-1346"><a href="#cb4-1346"></a><span class="co"># results plots</span></span>
<span id="cb4-1347"><a href="#cb4-1347"></a><span class="co"># health</span></span>
<span id="cb4-1348"><a href="#cb4-1348"></a>plots_subgroup_wealth<span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb4-1349"><a href="#cb4-1349"></a>  <span class="fu">list</span>(</span>
<span id="cb4-1350"><a href="#cb4-1350"></a>    planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>Poor<span class="sc">$</span>plot,</span>
<span id="cb4-1351"><a href="#cb4-1351"></a>    planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>MiddleIncome<span class="sc">$</span>plot,</span>
<span id="cb4-1352"><a href="#cb4-1352"></a>    planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>Rich<span class="sc">$</span>plot</span>
<span id="cb4-1353"><a href="#cb4-1353"></a>  ),</span>
<span id="cb4-1354"><a href="#cb4-1354"></a>  <span class="at">ncol =</span> <span class="dv">1</span></span>
<span id="cb4-1355"><a href="#cb4-1355"></a>) <span class="sc">+</span></span>
<span id="cb4-1356"><a href="#cb4-1356"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">"Wealth"</span>,</span>
<span id="cb4-1357"><a href="#cb4-1357"></a>                             <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>, <span class="at">face =</span> <span class="st">"bold"</span>)))</span>
<span id="cb4-1358"><a href="#cb4-1358"></a></span>
<span id="cb4-1359"><a href="#cb4-1359"></a><span class="co"># view</span></span>
<span id="cb4-1360"><a href="#cb4-1360"></a>plots_subgroup_wealth</span>
<span id="cb4-1361"><a href="#cb4-1361"></a></span>
<span id="cb4-1362"><a href="#cb4-1362"></a><span class="co"># plots</span></span>
<span id="cb4-1363"><a href="#cb4-1363"></a>plots_subgroup_ethnicity <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb4-1364"><a href="#cb4-1364"></a>  <span class="fu">list</span>(</span>
<span id="cb4-1365"><a href="#cb4-1365"></a>    planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Asian<span class="sc">$</span>plot,</span>
<span id="cb4-1366"><a href="#cb4-1366"></a>    planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Euro<span class="sc">$</span>plot,</span>
<span id="cb4-1367"><a href="#cb4-1367"></a>    planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Pacific<span class="sc">$</span>plot,</span>
<span id="cb4-1368"><a href="#cb4-1368"></a>    planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Maori<span class="sc">$</span>plot</span>
<span id="cb4-1369"><a href="#cb4-1369"></a>    </span>
<span id="cb4-1370"><a href="#cb4-1370"></a>  ),</span>
<span id="cb4-1371"><a href="#cb4-1371"></a>  <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb4-1372"><a href="#cb4-1372"></a>) <span class="sc">+</span></span>
<span id="cb4-1373"><a href="#cb4-1373"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">"Ethnicity"</span>,</span>
<span id="cb4-1374"><a href="#cb4-1374"></a>                             <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>, <span class="at">face =</span> <span class="st">"bold"</span>)))</span>
<span id="cb4-1375"><a href="#cb4-1375"></a></span>
<span id="cb4-1376"><a href="#cb4-1376"></a><span class="co"># view</span></span>
<span id="cb4-1377"><a href="#cb4-1377"></a><span class="fu">print</span>(plots_subgroup_ethnicity)</span>
<span id="cb4-1378"><a href="#cb4-1378"></a></span>
<span id="cb4-1379"><a href="#cb4-1379"></a><span class="co"># plots</span></span>
<span id="cb4-1380"><a href="#cb4-1380"></a>plots_subgroup_political <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb4-1381"><a href="#cb4-1381"></a>  <span class="fu">list</span>(</span>
<span id="cb4-1382"><a href="#cb4-1382"></a>    planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>political<span class="sc">$</span>results<span class="sc">$</span>Liberal<span class="sc">$</span>plot,</span>
<span id="cb4-1383"><a href="#cb4-1383"></a>    planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>political<span class="sc">$</span>results<span class="sc">$</span>Centrist<span class="sc">$</span>plot,</span>
<span id="cb4-1384"><a href="#cb4-1384"></a>    planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>political<span class="sc">$</span>results<span class="sc">$</span>Conservative<span class="sc">$</span>plot  </span>
<span id="cb4-1385"><a href="#cb4-1385"></a>  ),</span>
<span id="cb4-1386"><a href="#cb4-1386"></a>  <span class="at">ncol =</span> <span class="dv">1</span></span>
<span id="cb4-1387"><a href="#cb4-1387"></a>) <span class="sc">+</span></span>
<span id="cb4-1388"><a href="#cb4-1388"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">"Political Orientation"</span>,</span>
<span id="cb4-1389"><a href="#cb4-1389"></a>                             <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>, <span class="at">face =</span> <span class="st">"bold"</span>)))</span>
<span id="cb4-1390"><a href="#cb4-1390"></a></span>
<span id="cb4-1391"><a href="#cb4-1391"></a><span class="co"># view</span></span>
<span id="cb4-1392"><a href="#cb4-1392"></a><span class="fu">print</span>(plots_subgroup_political)</span>
<span id="cb4-1393"><a href="#cb4-1393"></a></span>
<span id="cb4-1394"><a href="#cb4-1394"></a><span class="co"># plots</span></span>
<span id="cb4-1395"><a href="#cb4-1395"></a>plots_subgroup_gender <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb4-1396"><a href="#cb4-1396"></a>  <span class="fu">list</span>(</span>
<span id="cb4-1397"><a href="#cb4-1397"></a>    planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>gender<span class="sc">$</span>results<span class="sc">$</span>Female<span class="sc">$</span>plot,</span>
<span id="cb4-1398"><a href="#cb4-1398"></a>    planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>gender<span class="sc">$</span>results<span class="sc">$</span>Male<span class="sc">$</span>plot</span>
<span id="cb4-1399"><a href="#cb4-1399"></a>  ),</span>
<span id="cb4-1400"><a href="#cb4-1400"></a>  <span class="at">ncol =</span> <span class="dv">1</span></span>
<span id="cb4-1401"><a href="#cb4-1401"></a>) <span class="sc">+</span></span>
<span id="cb4-1402"><a href="#cb4-1402"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">"Gender"</span>,</span>
<span id="cb4-1403"><a href="#cb4-1403"></a>                             <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>, <span class="at">face =</span> <span class="st">"bold"</span>)))</span>
<span id="cb4-1404"><a href="#cb4-1404"></a></span>
<span id="cb4-1405"><a href="#cb4-1405"></a><span class="co"># view</span></span>
<span id="cb4-1406"><a href="#cb4-1406"></a><span class="fu">print</span>(plots_subgroup_gender)</span>
<span id="cb4-1407"><a href="#cb4-1407"></a></span>
<span id="cb4-1408"><a href="#cb4-1408"></a><span class="co"># plots</span></span>
<span id="cb4-1409"><a href="#cb4-1409"></a>plots_subgroup_cohort <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb4-1410"><a href="#cb4-1410"></a>  <span class="fu">list</span>(</span>
<span id="cb4-1411"><a href="#cb4-1411"></a>    planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span><span class="st">`</span><span class="at">Age &lt; 35</span><span class="st">`</span><span class="sc">$</span>plot,</span>
<span id="cb4-1412"><a href="#cb4-1412"></a>    planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span><span class="st">`</span><span class="at">Age 35-62</span><span class="st">`</span><span class="sc">$</span>plot,</span>
<span id="cb4-1413"><a href="#cb4-1413"></a>    planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span><span class="st">`</span><span class="at">Age &gt; 62</span><span class="st">`</span><span class="sc">$</span>plot</span>
<span id="cb4-1414"><a href="#cb4-1414"></a>  ),</span>
<span id="cb4-1415"><a href="#cb4-1415"></a>  <span class="at">ncol =</span> <span class="dv">1</span></span>
<span id="cb4-1416"><a href="#cb4-1416"></a>) <span class="sc">+</span></span>
<span id="cb4-1417"><a href="#cb4-1417"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">"Age Cohorts"</span>,</span>
<span id="cb4-1418"><a href="#cb4-1418"></a>                             <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>, <span class="at">face =</span> <span class="st">"bold"</span>)))</span>
<span id="cb4-1419"><a href="#cb4-1419"></a></span>
<span id="cb4-1420"><a href="#cb4-1420"></a><span class="co"># view</span></span>
<span id="cb4-1421"><a href="#cb4-1421"></a><span class="fu">print</span>(plots_subgroup_cohort)</span>
<span id="cb4-1422"><a href="#cb4-1422"></a></span>
<span id="cb4-1423"><a href="#cb4-1423"></a></span>
<span id="cb4-1424"><a href="#cb4-1424"></a></span>
<span id="cb4-1425"><a href="#cb4-1425"></a></span>
<span id="cb4-1426"><a href="#cb4-1426"></a><span class="co"># COMPARE GROUPS ----------------------------------------------------------</span></span>
<span id="cb4-1427"><a href="#cb4-1427"></a>planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span><span class="st">`</span><span class="at">Age &lt; 35</span><span class="st">`</span><span class="sc">$</span>transformed_table</span>
<span id="cb4-1428"><a href="#cb4-1428"></a></span>
<span id="cb4-1429"><a href="#cb4-1429"></a>group_comparison_age_young_old <span class="ot">&lt;-</span> <span class="fu">margot_compare_groups</span>(</span>
<span id="cb4-1430"><a href="#cb4-1430"></a>  planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span><span class="st">`</span><span class="at">Age &lt; 35</span><span class="st">`</span><span class="sc">$</span>transformed_table, <span class="co"># reference</span></span>
<span id="cb4-1431"><a href="#cb4-1431"></a>  planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span><span class="st">`</span><span class="at">Age &gt; 62</span><span class="st">`</span><span class="sc">$</span>transformed_table, <span class="co"># comparison</span></span>
<span id="cb4-1432"><a href="#cb4-1432"></a>  <span class="at">type =</span> <span class="st">"RD"</span>,</span>
<span id="cb4-1433"><a href="#cb4-1433"></a>  <span class="at">label_mapping =</span> <span class="cn">NULL</span>,</span>
<span id="cb4-1434"><a href="#cb4-1434"></a>  <span class="at">decimal_places =</span> <span class="dv">4</span></span>
<span id="cb4-1435"><a href="#cb4-1435"></a>)</span>
<span id="cb4-1436"><a href="#cb4-1436"></a></span>
<span id="cb4-1437"><a href="#cb4-1437"></a><span class="co"># results</span></span>
<span id="cb4-1438"><a href="#cb4-1438"></a>group_comparison_age_young_old<span class="sc">$</span>results</span>
<span id="cb4-1439"><a href="#cb4-1439"></a>group_comparison_age_young_old<span class="sc">$</span>interpretation</span>
<span id="cb4-1440"><a href="#cb4-1440"></a></span>
<span id="cb4-1441"><a href="#cb4-1441"></a></span>
<span id="cb4-1442"><a href="#cb4-1442"></a></span>
<span id="cb4-1443"><a href="#cb4-1443"></a><span class="co"># compare another group ---------------------------------------------------</span></span>
<span id="cb4-1444"><a href="#cb4-1444"></a></span>
<span id="cb4-1445"><a href="#cb4-1445"></a>planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span><span class="st">`</span><span class="at">Age &lt; 35</span><span class="st">`</span><span class="sc">$</span>transformed_table</span>
<span id="cb4-1446"><a href="#cb4-1446"></a></span>
<span id="cb4-1447"><a href="#cb4-1447"></a>group_comparison_ethn_euro_maori <span class="ot">&lt;-</span> <span class="fu">margot_compare_groups</span>(</span>
<span id="cb4-1448"><a href="#cb4-1448"></a>  planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Euro<span class="sc">$</span>transformed_table, <span class="co"># reference</span></span>
<span id="cb4-1449"><a href="#cb4-1449"></a>  planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Maori<span class="sc">$</span>transformed_table, <span class="co"># comparison</span></span>
<span id="cb4-1450"><a href="#cb4-1450"></a>  <span class="at">type =</span> <span class="st">"RD"</span>,</span>
<span id="cb4-1451"><a href="#cb4-1451"></a>  <span class="at">label_mapping =</span> <span class="cn">NULL</span>,</span>
<span id="cb4-1452"><a href="#cb4-1452"></a>  <span class="at">decimal_places =</span> <span class="dv">4</span></span>
<span id="cb4-1453"><a href="#cb4-1453"></a>)</span>
<span id="cb4-1454"><a href="#cb4-1454"></a></span>
<span id="cb4-1455"><a href="#cb4-1455"></a><span class="co"># results</span></span>
<span id="cb4-1456"><a href="#cb4-1456"></a>group_comparison_ethn_euro_maori<span class="sc">$</span>results <span class="co"># no differences</span></span>
<span id="cb4-1457"><a href="#cb4-1457"></a>group_comparison_ethn_euro_maori<span class="sc">$</span>interpretation <span class="co"># no differences</span></span>
<span id="cb4-1458"><a href="#cb4-1458"></a></span>
<span id="cb4-1459"><a href="#cb4-1459"></a></span>
<span id="cb4-1460"><a href="#cb4-1460"></a><span class="co"># compare another group ---------------------------------------------------</span></span>
<span id="cb4-1461"><a href="#cb4-1461"></a><span class="co"># gender</span></span>
<span id="cb4-1462"><a href="#cb4-1462"></a>group_comparison_gender<span class="ot">&lt;-</span> <span class="fu">margot_compare_groups</span>(</span>
<span id="cb4-1463"><a href="#cb4-1463"></a>  planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>gender<span class="sc">$</span>results<span class="sc">$</span>Female<span class="sc">$</span>transformed_table, <span class="co"># reference</span></span>
<span id="cb4-1464"><a href="#cb4-1464"></a>  planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>gender<span class="sc">$</span>results<span class="sc">$</span>Male<span class="sc">$</span>transformed_table, <span class="co"># comparison</span></span>
<span id="cb4-1465"><a href="#cb4-1465"></a>  <span class="at">type =</span> <span class="st">"RD"</span>,</span>
<span id="cb4-1466"><a href="#cb4-1466"></a>  <span class="at">label_mapping =</span> <span class="cn">NULL</span>,</span>
<span id="cb4-1467"><a href="#cb4-1467"></a>  <span class="at">decimal_places =</span> <span class="dv">4</span></span>
<span id="cb4-1468"><a href="#cb4-1468"></a>)</span>
<span id="cb4-1469"><a href="#cb4-1469"></a></span>
<span id="cb4-1470"><a href="#cb4-1470"></a><span class="co"># results</span></span>
<span id="cb4-1471"><a href="#cb4-1471"></a>group_comparison_gender<span class="sc">$</span>results <span class="co"># no reliable differences</span></span>
<span id="cb4-1472"><a href="#cb4-1472"></a>group_comparison_gender<span class="sc">$</span>interpretation <span class="co"># no differences</span></span>
<span id="cb4-1473"><a href="#cb4-1473"></a></span>
<span id="cb4-1474"><a href="#cb4-1474"></a></span>
<span id="cb4-1475"><a href="#cb4-1475"></a><span class="co"># TAKE HOME</span></span>
<span id="cb4-1476"><a href="#cb4-1476"></a><span class="co"># first these are simulated data, so true effects are attenuated</span></span>
<span id="cb4-1477"><a href="#cb4-1477"></a><span class="co"># second, when we allow our models to be flexible, we find that pre-defined group comparisons often come up short</span></span>
<span id="cb4-1478"><a href="#cb4-1478"></a></span>
<span id="cb4-1479"><a href="#cb4-1479"></a></span>
<span id="cb4-1480"><a href="#cb4-1480"></a><span class="co"># plot options: showcased ---------------------------------------------</span></span>
<span id="cb4-1481"><a href="#cb4-1481"></a><span class="co"># default</span></span>
<span id="cb4-1482"><a href="#cb4-1482"></a><span class="fu">margot_plot_decision_tree</span>(models_binary, <span class="st">"model_t2_support_z"</span>, )</span>
<span id="cb4-1483"><a href="#cb4-1483"></a><span class="co"># tighten branches for easier viewing in single graphs</span></span>
<span id="cb4-1484"><a href="#cb4-1484"></a>margot<span class="sc">::</span><span class="fu">margot_plot_decision_tree</span>(</span>
<span id="cb4-1485"><a href="#cb4-1485"></a>  models_binary,</span>
<span id="cb4-1486"><a href="#cb4-1486"></a>  <span class="st">"model_t2_support_z"</span>,</span>
<span id="cb4-1487"><a href="#cb4-1487"></a>  <span class="at">span_ratio =</span> .<span class="dv">30</span>,</span>
<span id="cb4-1488"><a href="#cb4-1488"></a>  <span class="at">text_size =</span> <span class="fl">3.8</span>,</span>
<span id="cb4-1489"><a href="#cb4-1489"></a>  <span class="at">border_size =</span> .<span class="dv">1</span>,</span>
<span id="cb4-1490"><a href="#cb4-1490"></a>  <span class="co">#  title = "none",</span></span>
<span id="cb4-1491"><a href="#cb4-1491"></a>  <span class="at">original_df =</span> original_df</span>
<span id="cb4-1492"><a href="#cb4-1492"></a>)</span>
<span id="cb4-1493"><a href="#cb4-1493"></a><span class="co"># colour decision node</span></span>
<span id="cb4-1494"><a href="#cb4-1494"></a>margot<span class="sc">::</span><span class="fu">margot_plot_decision_tree</span>(</span>
<span id="cb4-1495"><a href="#cb4-1495"></a>  models_binary,</span>
<span id="cb4-1496"><a href="#cb4-1496"></a>  <span class="st">"model_t2_support_z"</span>,</span>
<span id="cb4-1497"><a href="#cb4-1497"></a>  <span class="at">span_ratio =</span> .<span class="dv">3</span>,</span>
<span id="cb4-1498"><a href="#cb4-1498"></a>  <span class="at">text_size =</span> <span class="dv">4</span>,</span>
<span id="cb4-1499"><a href="#cb4-1499"></a>  <span class="at">title =</span> <span class="st">"New Title"</span>,</span>
<span id="cb4-1500"><a href="#cb4-1500"></a>  <span class="at">non_leaf_fill =</span>  <span class="st">"violet"</span>,</span>
<span id="cb4-1501"><a href="#cb4-1501"></a>  <span class="at">original_df =</span> original_df</span>
<span id="cb4-1502"><a href="#cb4-1502"></a>)</span>
<span id="cb4-1503"><a href="#cb4-1503"></a><span class="co"># make new title</span></span>
<span id="cb4-1504"><a href="#cb4-1504"></a>margot<span class="sc">::</span><span class="fu">margot_plot_decision_tree</span>(</span>
<span id="cb4-1505"><a href="#cb4-1505"></a>  models_binary,</span>
<span id="cb4-1506"><a href="#cb4-1506"></a>  <span class="st">"model_t2_support_z"</span>,</span>
<span id="cb4-1507"><a href="#cb4-1507"></a>  <span class="at">span_ratio =</span> .<span class="dv">2</span>,</span>
<span id="cb4-1508"><a href="#cb4-1508"></a>  <span class="at">text_size =</span> <span class="dv">3</span>,</span>
<span id="cb4-1509"><a href="#cb4-1509"></a>  <span class="at">title =</span> <span class="st">"New Title"</span>,</span>
<span id="cb4-1510"><a href="#cb4-1510"></a>  <span class="at">non_leaf_fill =</span>  <span class="st">"white"</span>,</span>
<span id="cb4-1511"><a href="#cb4-1511"></a>  <span class="at">original_df =</span> original_df</span>
<span id="cb4-1512"><a href="#cb4-1512"></a>)</span>
<span id="cb4-1513"><a href="#cb4-1513"></a></span>
<span id="cb4-1514"><a href="#cb4-1514"></a><span class="co"># remove title</span></span>
<span id="cb4-1515"><a href="#cb4-1515"></a>margot<span class="sc">::</span><span class="fu">margot_plot_decision_tree</span>(</span>
<span id="cb4-1516"><a href="#cb4-1516"></a>  models_binary,</span>
<span id="cb4-1517"><a href="#cb4-1517"></a>  <span class="st">"model_t2_support_z"</span>,</span>
<span id="cb4-1518"><a href="#cb4-1518"></a>  <span class="at">text_size =</span> <span class="dv">5</span>,</span>
<span id="cb4-1519"><a href="#cb4-1519"></a>  <span class="at">title =</span> <span class="st">'none'</span>,</span>
<span id="cb4-1520"><a href="#cb4-1520"></a>  <span class="co"># set title to none</span></span>
<span id="cb4-1521"><a href="#cb4-1521"></a>  <span class="at">original_df =</span> original_df</span>
<span id="cb4-1522"><a href="#cb4-1522"></a>)</span>
<span id="cb4-1523"><a href="#cb4-1523"></a></span>
<span id="cb4-1524"><a href="#cb4-1524"></a></span>
<span id="cb4-1525"><a href="#cb4-1525"></a><span class="co"># adjust only the alpha</span></span>
<span id="cb4-1526"><a href="#cb4-1526"></a>margot<span class="sc">::</span><span class="fu">margot_plot_policy_tree</span>(models_binary, <span class="st">"model_t2_support_z"</span>, <span class="at">point_alpha =</span> .<span class="dv">1</span>)</span>
<span id="cb4-1527"><a href="#cb4-1527"></a>margot<span class="sc">::</span><span class="fu">margot_plot_policy_tree</span>(models_binary, <span class="st">"model_t2_support_z"</span>, <span class="at">point_alpha =</span> .<span class="dv">9</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="code-explanations" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="code-explanations">Code Explanations</h2>
<section id="script-01-initial-data-wrangling" class="level3">
<h3 class="anchored" data-anchor-id="script-01-initial-data-wrangling">Script 01 Initial Data Wrangling</h3>
<p>Key checkpoints in the <em>wrangle-1</em> script are as follows;</p>
<section id="first-pick-your-three-study-waves" class="level4">
<h4 class="anchored" data-anchor-id="first-pick-your-three-study-waves">First — pick your three study waves*</h4>
<p>Note waves run from October –&gt; September of the year following the wave.</p>
<p>Note: - baseline variables must appear in the baseline wave - the exposure variable must appear in both the baseline wave and exposure wave (but need not appear in the outcome wave) - outcome variables must appear in both the baseline wave and outcome wave (but need not appear in the exposure wave.)</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># +--------------------------+</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="co"># +--------------------------+</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="co"># +--------------------------+</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="co"># | OPTIONALLY MODIFY SECTION|</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="co"># +--------------------------+</span></span>
<span id="cb5-7"><a href="#cb5-7"></a></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="co"># **  define your study waves **</span></span>
<span id="cb5-9"><a href="#cb5-9"></a>baseline_wave      <span class="ot">&lt;-</span> <span class="st">"2018"</span>        <span class="co"># baseline measurement</span></span>
<span id="cb5-10"><a href="#cb5-10"></a>exposure_waves     <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"2019"</span>)     <span class="co"># when exposure is measured</span></span>
<span id="cb5-11"><a href="#cb5-11"></a>outcome_wave       <span class="ot">&lt;-</span> <span class="st">"2020"</span>        <span class="co"># when outcomes are measured</span></span>
<span id="cb5-12"><a href="#cb5-12"></a>all_waves          <span class="ot">&lt;-</span> <span class="fu">c</span>(baseline_wave, exposure_waves, outcome_wave)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="second-pick-your-exposure" class="level4">
<h4 class="anchored" data-anchor-id="second-pick-your-exposure">Second — pick your exposure</h4>
<p>Decide which variable is the ‘cause’. Here it is <code>extraversion</code>. Verify it exists at baseline (<code>t0_</code>) <em>and</em> at the exposure wave (<code>t1_</code>)</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># define study variables ----------------------------------------------------</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="co"># ** key decision 2: define your exposure variable **</span></span>
<span id="cb6-3"><a href="#cb6-3"></a></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="co"># +--------------------------+</span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="co"># +--------------------------+</span></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="co"># +--------------------------+</span></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="co"># |    MODIFY THIS SECTION   |</span></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="co"># +--------------------------+</span></span>
<span id="cb6-10"><a href="#cb6-10"></a>name_exposure <span class="ot">&lt;-</span> <span class="st">"extraversion"</span></span>
<span id="cb6-11"><a href="#cb6-11"></a></span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="co"># exposure variable labels</span></span>
<span id="cb6-13"><a href="#cb6-13"></a>var_labels_exposure <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb6-14"><a href="#cb6-14"></a>  <span class="st">"extraversion"</span> <span class="ot">=</span> <span class="st">"Extraversion"</span>,</span>
<span id="cb6-15"><a href="#cb6-15"></a>  <span class="st">"extraversion_binary"</span> <span class="ot">=</span> <span class="st">"Extraversion (binary)"</span></span>
<span id="cb6-16"><a href="#cb6-16"></a>)</span>
<span id="cb6-17"><a href="#cb6-17"></a><span class="co"># +--------------------------+</span></span>
<span id="cb6-18"><a href="#cb6-18"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb6-19"><a href="#cb6-19"></a><span class="co"># +--------------------------+</span></span>
<span id="cb6-20"><a href="#cb6-20"></a><span class="co"># +--------------------------+</span></span>
<span id="cb6-21"><a href="#cb6-21"></a><span class="co"># |   </span><span class="re">END</span><span class="co"> MODIFY SECTION     |</span></span>
<span id="cb6-22"><a href="#cb6-22"></a><span class="co"># +--------------------------+</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="third-choose-your-outcome-variables-ensuring-they-are-in-the-baseline-wave-and-outcome-wave" class="level4">
<h4 class="anchored" data-anchor-id="third-choose-your-outcome-variables-ensuring-they-are-in-the-baseline-wave-and-outcome-wave">Third – choose your outcome variables (ensuring they are in the baseline wave and outcome wave)</h4>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># +--------------------------+</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="co"># +--------------------------+</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="co"># +--------------------------+</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="co"># |    MODIFY THIS SECTION   |</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="co"># +--------------------------+</span></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="co"># ** key decision 3: define outcome variables **</span></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="co"># here, we are focussing on a subset of wellbeing outcomes</span></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="co"># chose outcomes relevant to * your * study. Might be all/some/none/exactly </span></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="co"># these:</span></span>
<span id="cb7-11"><a href="#cb7-11"></a>outcome_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb7-12"><a href="#cb7-12"></a>  <span class="co"># health outcomes</span></span>
<span id="cb7-13"><a href="#cb7-13"></a>  <span class="co"># "alcohol_frequency_weekly", "alcohol_intensity",</span></span>
<span id="cb7-14"><a href="#cb7-14"></a>  <span class="co"># "hlth_bmi", </span></span>
<span id="cb7-15"><a href="#cb7-15"></a>  <span class="st">"log_hours_exercise"</span>, </span>
<span id="cb7-16"><a href="#cb7-16"></a>  <span class="co"># "hlth_sleep_hours", </span></span>
<span id="cb7-17"><a href="#cb7-17"></a>  <span class="co"># "short_form_health",</span></span>
<span id="cb7-18"><a href="#cb7-18"></a>  </span>
<span id="cb7-19"><a href="#cb7-19"></a>  <span class="co"># psychological outcomes</span></span>
<span id="cb7-20"><a href="#cb7-20"></a>  <span class="co"># "hlth_fatigue", </span></span>
<span id="cb7-21"><a href="#cb7-21"></a>  <span class="st">"kessler_latent_anxiety"</span>, </span>
<span id="cb7-22"><a href="#cb7-22"></a>  <span class="st">"kessler_latent_depression"</span>, </span>
<span id="cb7-23"><a href="#cb7-23"></a>  <span class="st">"rumination"</span>,</span>
<span id="cb7-24"><a href="#cb7-24"></a>  </span>
<span id="cb7-25"><a href="#cb7-25"></a>  <span class="co"># well-being outcomes</span></span>
<span id="cb7-26"><a href="#cb7-26"></a>  <span class="co"># "bodysat", </span></span>
<span id="cb7-27"><a href="#cb7-27"></a>  <span class="co">#"forgiveness", "gratitude", </span></span>
<span id="cb7-28"><a href="#cb7-28"></a>  <span class="st">"lifesat"</span>, <span class="st">"meaning_purpose"</span>, <span class="st">"meaning_sense"</span>, </span>
<span id="cb7-29"><a href="#cb7-29"></a>  <span class="co"># "perfectionism", </span></span>
<span id="cb7-30"><a href="#cb7-30"></a>  <span class="st">"pwi"</span>, </span>
<span id="cb7-31"><a href="#cb7-31"></a>  <span class="co">#"self_control", </span></span>
<span id="cb7-32"><a href="#cb7-32"></a>  <span class="st">"self_esteem"</span>, </span>
<span id="cb7-33"><a href="#cb7-33"></a>  <span class="co">#"sexual_satisfaction",</span></span>
<span id="cb7-34"><a href="#cb7-34"></a>  </span>
<span id="cb7-35"><a href="#cb7-35"></a>  <span class="co"># social outcomes</span></span>
<span id="cb7-36"><a href="#cb7-36"></a>  <span class="st">"belong"</span>, <span class="st">"neighbourhood_community"</span>, <span class="st">"support"</span></span>
<span id="cb7-37"><a href="#cb7-37"></a>)</span>
<span id="cb7-38"><a href="#cb7-38"></a><span class="co"># +--------------------------+</span></span>
<span id="cb7-39"><a href="#cb7-39"></a><span class="co"># |   </span><span class="re">END</span><span class="co"> MODIFY SECTION     |</span></span>
<span id="cb7-40"><a href="#cb7-40"></a><span class="co"># +--------------------------+</span></span>
<span id="cb7-41"><a href="#cb7-41"></a><span class="co"># +--------------------------+</span></span>
<span id="cb7-42"><a href="#cb7-42"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb7-43"><a href="#cb7-43"></a><span class="co"># +--------------------------+</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="fourth-define-baseline-covariates" class="level4">
<h4 class="anchored" data-anchor-id="fourth-define-baseline-covariates">Fourth: define baseline covariates</h4>
<p>Define baseline variables. The primary role of these variables is to control unmeasured confounding. We will also use these variables to investigate treatment effect heterogeneity. Note that the exposure at baseline and the outcomes at baseline will automatically be included in this set later.</p>
<p><strong>You may use the following variables without modifying them.</strong></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="co"># +--------------------------+</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="co"># +--------------------------+</span></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="co"># +--------------------------+</span></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="co"># | OPTIONALLY MODIFY SECTION|</span></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="co"># +--------------------------+</span></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="co"># define baseline variables -----------------------------------------------</span></span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="co"># key decision 4 **  define baseline covariates **</span></span>
<span id="cb8-9"><a href="#cb8-9"></a><span class="co"># these are demographics, traits, etc. measured at baseline, that are common</span></span>
<span id="cb8-10"><a href="#cb8-10"></a><span class="co"># causes of the exposure and outcome.  </span></span>
<span id="cb8-11"><a href="#cb8-11"></a><span class="co"># note we will automatically include baseline measures of the exposure and outcome</span></span>
<span id="cb8-12"><a href="#cb8-12"></a><span class="co"># later in the workflow.</span></span>
<span id="cb8-13"><a href="#cb8-13"></a></span>
<span id="cb8-14"><a href="#cb8-14"></a>baseline_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb8-15"><a href="#cb8-15"></a>  <span class="co"># demographics</span></span>
<span id="cb8-16"><a href="#cb8-16"></a>  <span class="st">"age"</span>, <span class="st">"born_nz_binary"</span>, <span class="st">"education_level_coarsen"</span>,</span>
<span id="cb8-17"><a href="#cb8-17"></a>  <span class="st">"employed_binary"</span>, <span class="st">"eth_cat"</span>, <span class="st">"male_binary"</span>,</span>
<span id="cb8-18"><a href="#cb8-18"></a>  <span class="st">"not_heterosexual_binary"</span>, <span class="st">"parent_binary"</span>, <span class="st">"partner_binary"</span>,</span>
<span id="cb8-19"><a href="#cb8-19"></a>  <span class="st">"rural_gch_2018_l"</span>, <span class="st">"sample_frame_opt_in_binary"</span>,</span>
<span id="cb8-20"><a href="#cb8-20"></a>  </span>
<span id="cb8-21"><a href="#cb8-21"></a>  <span class="co"># personality traits (excluding exposure)</span></span>
<span id="cb8-22"><a href="#cb8-22"></a>  <span class="st">"agreeableness"</span>, <span class="st">"conscientiousness"</span>, <span class="st">"neuroticism"</span>, <span class="st">"openness"</span>,</span>
<span id="cb8-23"><a href="#cb8-23"></a>  </span>
<span id="cb8-24"><a href="#cb8-24"></a>  <span class="co"># health and lifestyle</span></span>
<span id="cb8-25"><a href="#cb8-25"></a>  <span class="st">"alcohol_frequency"</span>, <span class="st">"alcohol_intensity"</span>, <span class="st">"hlth_disability_binary"</span>,</span>
<span id="cb8-26"><a href="#cb8-26"></a>  <span class="st">"log_hours_children"</span>, <span class="st">"log_hours_commute"</span>, <span class="st">"log_hours_exercise"</span>,</span>
<span id="cb8-27"><a href="#cb8-27"></a>  <span class="st">"log_hours_housework"</span>, <span class="st">"log_household_inc"</span>,</span>
<span id="cb8-28"><a href="#cb8-28"></a>  <span class="st">"short_form_health"</span>, <span class="st">"smoker_binary"</span>,</span>
<span id="cb8-29"><a href="#cb8-29"></a>  </span>
<span id="cb8-30"><a href="#cb8-30"></a>  <span class="co"># social and psychological</span></span>
<span id="cb8-31"><a href="#cb8-31"></a>  <span class="st">"belong"</span>, <span class="st">"nz_dep2018"</span>, <span class="st">"nzsei_13_l"</span>,</span>
<span id="cb8-32"><a href="#cb8-32"></a>  <span class="st">"political_conservative"</span>, <span class="st">"religion_identification_level"</span></span>
<span id="cb8-33"><a href="#cb8-33"></a>)</span>
<span id="cb8-34"><a href="#cb8-34"></a><span class="co"># +--------------------------+</span></span>
<span id="cb8-35"><a href="#cb8-35"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb8-36"><a href="#cb8-36"></a><span class="co"># +--------------------------+</span></span>
<span id="cb8-37"><a href="#cb8-37"></a><span class="co"># +--------------------------+</span></span>
<span id="cb8-38"><a href="#cb8-38"></a><span class="co"># |   </span><span class="re">END</span><span class="co"> MODIFY SECTION     |</span></span>
<span id="cb8-39"><a href="#cb8-39"></a><span class="co"># +--------------------------+</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="five-select-baseline-cohort-population-using-eligibility-criteria-that-are-sensible-for-your-study" class="level4">
<h4 class="anchored" data-anchor-id="five-select-baseline-cohort-population-using-eligibility-criteria-that-are-sensible-for-your-study">Five – select baseline cohort population using eligibility criteria that are sensible for your study</h4>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="co"># +--------------------------+</span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="co"># +--------------------------+</span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="co"># +--------------------------+</span></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="co"># | OPTIONALLY MODIFY SECTION|</span></span>
<span id="cb9-6"><a href="#cb9-6"></a><span class="co"># +--------------------------+</span></span>
<span id="cb9-7"><a href="#cb9-7"></a></span>
<span id="cb9-8"><a href="#cb9-8"></a><span class="co"># select eligible participants ----------------------------------------------</span></span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="co"># only include participants who have exposure data at baseline</span></span>
<span id="cb9-10"><a href="#cb9-10"></a></span>
<span id="cb9-11"><a href="#cb9-11"></a><span class="co"># You might require tighter conditions </span></span>
<span id="cb9-12"><a href="#cb9-12"></a><span class="co"># for example, if you are interested in the effects of hours of childcare, </span></span>
<span id="cb9-13"><a href="#cb9-13"></a><span class="co"># you might want to select only those who were parents at baseline. </span></span>
<span id="cb9-14"><a href="#cb9-14"></a><span class="co"># talk to me if you think you might night tighter eligibility criteria.</span></span>
<span id="cb9-15"><a href="#cb9-15"></a></span>
<span id="cb9-16"><a href="#cb9-16"></a>ids_baseline <span class="ot">&lt;-</span> dat_prep <span class="sc">|&gt;</span> </span>
<span id="cb9-17"><a href="#cb9-17"></a>  <span class="co"># allow missing exposure at baseline</span></span>
<span id="cb9-18"><a href="#cb9-18"></a>  <span class="co"># this would give us greater confidence that we generalise to the target population</span></span>
<span id="cb9-19"><a href="#cb9-19"></a>  <span class="co"># filter(wave == baseline_wave) |&gt; </span></span>
<span id="cb9-20"><a href="#cb9-20"></a>  <span class="co"># option: do not allow missing exposure at baseline</span></span>
<span id="cb9-21"><a href="#cb9-21"></a>  <span class="co"># this gives us greater confidence that we recover a incident effect</span></span>
<span id="cb9-22"><a href="#cb9-22"></a>  <span class="fu">filter</span>(wave <span class="sc">==</span> baseline_wave, <span class="sc">!</span><span class="fu">is.na</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_exposure))) <span class="sc">|&gt;</span> </span>
<span id="cb9-23"><a href="#cb9-23"></a>  <span class="fu">pull</span>(id)</span>
<span id="cb9-24"><a href="#cb9-24"></a></span>
<span id="cb9-25"><a href="#cb9-25"></a><span class="co"># filter data to include only eligible participants and relevant waves</span></span>
<span id="cb9-26"><a href="#cb9-26"></a>dat_long_1 <span class="ot">&lt;-</span> dat_prep <span class="sc">|&gt;</span> </span>
<span id="cb9-27"><a href="#cb9-27"></a>  <span class="fu">filter</span>(id <span class="sc">%in%</span> ids_baseline, wave <span class="sc">%in%</span> all_waves) <span class="sc">|&gt;</span> </span>
<span id="cb9-28"><a href="#cb9-28"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb9-29"><a href="#cb9-29"></a></span>
<span id="cb9-30"><a href="#cb9-30"></a><span class="co"># +--------------------------+</span></span>
<span id="cb9-31"><a href="#cb9-31"></a><span class="co"># |</span><span class="re">END</span><span class="co"> OPTIONALLY MODIFY SEC.|</span></span>
<span id="cb9-32"><a href="#cb9-32"></a><span class="co"># +--------------------------+</span></span>
<span id="cb9-33"><a href="#cb9-33"></a><span class="co"># +--------------------------+</span></span>
<span id="cb9-34"><a href="#cb9-34"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb9-35"><a href="#cb9-35"></a><span class="co"># +--------------------------+</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="six-choose-a-binary-cut-point" class="level4">
<h4 class="anchored" data-anchor-id="six-choose-a-binary-cut-point">Six – choose a binary cut-point</h4>
<p>Causal inference requires a contrast between two conditions. The splits give us the conditions of a hypothetical experiment.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="co"># +--------------------------+</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="co"># +--------------------------+</span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="co"># +--------------------------+</span></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="co"># |    MODIFY THIS SECTION   |</span></span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="co"># +--------------------------+</span></span>
<span id="cb10-8"><a href="#cb10-8"></a><span class="co"># define cutpoints</span></span>
<span id="cb10-9"><a href="#cb10-9"></a>cut_points <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>)</span>
<span id="cb10-10"><a href="#cb10-10"></a></span>
<span id="cb10-11"><a href="#cb10-11"></a><span class="co"># use later in positivity graph</span></span>
<span id="cb10-12"><a href="#cb10-12"></a>lower_cut <span class="ot">&lt;-</span> cut_points[[<span class="dv">1</span>]]</span>
<span id="cb10-13"><a href="#cb10-13"></a>upper_cut <span class="ot">&lt;-</span> cut_points[[<span class="dv">2</span>]]</span>
<span id="cb10-14"><a href="#cb10-14"></a>threshold <span class="ot">&lt;-</span> <span class="st">'&gt;'</span> <span class="co"># if upper</span></span>
<span id="cb10-15"><a href="#cb10-15"></a></span>
<span id="cb10-16"><a href="#cb10-16"></a><span class="co"># save for manuscript</span></span>
<span id="cb10-17"><a href="#cb10-17"></a><span class="fu">here_save</span>(lower_cut, <span class="st">"lower_cut"</span>)</span>
<span id="cb10-18"><a href="#cb10-18"></a><span class="fu">here_save</span>(upper_cut, <span class="st">"upper_cut"</span>)</span>
<span id="cb10-19"><a href="#cb10-19"></a><span class="fu">here_save</span>(threshold, <span class="st">"threshold"</span>)</span>
<span id="cb10-20"><a href="#cb10-20"></a></span>
<span id="cb10-21"><a href="#cb10-21"></a><span class="co"># make graph</span></span>
<span id="cb10-22"><a href="#cb10-22"></a>graph_cut <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_plot_categorical</span>(</span>
<span id="cb10-23"><a href="#cb10-23"></a>  dat_long_exposure,</span>
<span id="cb10-24"><a href="#cb10-24"></a>  <span class="at">col_name         =</span> name_exposure,</span>
<span id="cb10-25"><a href="#cb10-25"></a>  <span class="at">sd_multipliers =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>), <span class="co"># select to suit</span></span>
<span id="cb10-26"><a href="#cb10-26"></a>  <span class="co"># either use n_divisions for equal-sized groups:</span></span>
<span id="cb10-27"><a href="#cb10-27"></a>  <span class="co"># n_divisions      = 2,</span></span>
<span id="cb10-28"><a href="#cb10-28"></a>  <span class="co"># or use custom_breaks for specific values:</span></span>
<span id="cb10-29"><a href="#cb10-29"></a>  <span class="at">custom_breaks    =</span> cut_points,  <span class="co"># ** adjust as needed **</span></span>
<span id="cb10-30"><a href="#cb10-30"></a>  <span class="co"># could be "lower", no difference in this case, as no one == 4</span></span>
<span id="cb10-31"><a href="#cb10-31"></a>  <span class="at">cutpoint_inclusive =</span> <span class="st">"upper"</span>,</span>
<span id="cb10-32"><a href="#cb10-32"></a>  <span class="at">show_mean        =</span> <span class="cn">TRUE</span>,</span>
<span id="cb10-33"><a href="#cb10-33"></a>  <span class="at">show_median      =</span> <span class="cn">FALSE</span>,</span>
<span id="cb10-34"><a href="#cb10-34"></a>  <span class="at">show_sd          =</span> <span class="cn">TRUE</span></span>
<span id="cb10-35"><a href="#cb10-35"></a>)</span>
<span id="cb10-36"><a href="#cb10-36"></a><span class="fu">print</span>(graph_cut)</span>
<span id="cb10-37"><a href="#cb10-37"></a></span>
<span id="cb10-38"><a href="#cb10-38"></a><span class="co"># save your graph</span></span>
<span id="cb10-39"><a href="#cb10-39"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(graph_cut, <span class="st">"graph_cut"</span>, push_mods)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Ask: which break meaningfully separate groups into two exposure groups? Is the split *theoretically motivated**? adjust <code>custom_breaks</code> until the answer is ‘yes’. then commit:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>dat_long_2 <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">create_ordered_variable</span>(</span>
<span id="cb11-2"><a href="#cb11-2"></a>  dat_long_1,</span>
<span id="cb11-3"><a href="#cb11-3"></a>  <span class="at">var_name           =</span> name_exposure,</span>
<span id="cb11-4"><a href="#cb11-4"></a>  <span class="at">custom_breaks      =</span> cut_points,  <span class="co"># ** -- adjust based on your decision above -- **</span></span>
<span id="cb11-5"><a href="#cb11-5"></a>  <span class="at">cutpoint_inclusive =</span> <span class="st">"upper"</span></span>
<span id="cb11-6"><a href="#cb11-6"></a>)s</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="seven-save-as-you-go." class="level4">
<h4 class="anchored" data-anchor-id="seven-save-as-you-go.">Seven — save as you go.</h4>
<p>Use <code>margot::here_save()</code> (objects) and <code>here_save_qs()</code> (large objects) right after you create something you’ll cite in your report. The convention keeps analysis, tables, and manuscript in sync.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="fu">here_save</span>(dat_long_final,          <span class="st">"dat_long_final"</span>)</span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="fu">here_save</span>(percent_missing_baseline,  <span class="st">"percent_missing_baseline"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="remember-to-check-the-positivity-assumption" class="level4">
<h4 class="anchored" data-anchor-id="remember-to-check-the-positivity-assumption">Remember to check the positivity assumption</h4>
<p>Is there change between <code>t0_</code> and <code>t1_</code> in the exposure variable?</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="co"># create transition matrices to check positivity ----------------------------</span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="co"># this helps assess whether there are sufficient observations in all exposure states</span></span>
<span id="cb13-3"><a href="#cb13-3"></a>dt_positivity <span class="ot">&lt;-</span> dat_long_final <span class="sc">|&gt;</span></span>
<span id="cb13-4"><a href="#cb13-4"></a>  <span class="fu">filter</span>(wave <span class="sc">%in%</span> <span class="fu">c</span>(baseline_wave, exposure_waves)) <span class="sc">|&gt;</span></span>
<span id="cb13-5"><a href="#cb13-5"></a>  <span class="fu">select</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_exposure), id, wave) <span class="sc">|&gt;</span></span>
<span id="cb13-6"><a href="#cb13-6"></a>  <span class="fu">mutate</span>(<span class="at">exposure =</span> <span class="fu">round</span>(<span class="fu">as.numeric</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_exposure)), <span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb13-7"><a href="#cb13-7"></a>  <span class="co"># create binary exposure based on cutpoint</span></span>
<span id="cb13-8"><a href="#cb13-8"></a>  <span class="fu">mutate</span>(<span class="at">exposure_binary =</span> <span class="fu">ifelse</span>(exposure <span class="sc">&gt;</span> upper_cut, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">|&gt;</span> <span class="co"># check</span></span>
<span id="cb13-9"><a href="#cb13-9"></a>  <span class="do">## *-- modify this --* </span></span>
<span id="cb13-10"><a href="#cb13-10"></a>  <span class="fu">mutate</span>(<span class="at">wave =</span> <span class="fu">as.numeric</span>(wave) <span class="sc">-</span><span class="dv">1</span> )</span>
<span id="cb13-11"><a href="#cb13-11"></a></span>
<span id="cb13-12"><a href="#cb13-12"></a><span class="co"># create transition tables</span></span>
<span id="cb13-13"><a href="#cb13-13"></a>transition_tables <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_transition_table</span>(</span>
<span id="cb13-14"><a href="#cb13-14"></a>  dt_positivity,</span>
<span id="cb13-15"><a href="#cb13-15"></a>  <span class="at">state_var =</span> <span class="st">"exposure"</span>,</span>
<span id="cb13-16"><a href="#cb13-16"></a>  <span class="at">id_var =</span> <span class="st">"id"</span>,</span>
<span id="cb13-17"><a href="#cb13-17"></a>  <span class="at">waves =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb13-18"><a href="#cb13-18"></a>  <span class="at">wave_var =</span> <span class="st">"wave"</span>,</span>
<span id="cb13-19"><a href="#cb13-19"></a>  <span class="at">table_name =</span> <span class="st">"transition_table"</span></span>
<span id="cb13-20"><a href="#cb13-20"></a>)</span>
<span id="cb13-21"><a href="#cb13-21"></a><span class="fu">print</span>(transition_tables<span class="sc">$</span>tables[[<span class="dv">1</span>]])</span>
<span id="cb13-22"><a href="#cb13-22"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(transition_tables, <span class="st">"transition_tables"</span>, push_mods)</span>
<span id="cb13-23"><a href="#cb13-23"></a></span>
<span id="cb13-24"><a href="#cb13-24"></a><span class="co"># create binary transition tables</span></span>
<span id="cb13-25"><a href="#cb13-25"></a>transition_tables_binary <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_transition_table</span>(</span>
<span id="cb13-26"><a href="#cb13-26"></a>  dt_positivity,</span>
<span id="cb13-27"><a href="#cb13-27"></a>  <span class="at">state_var =</span> <span class="st">"exposure_binary"</span>,</span>
<span id="cb13-28"><a href="#cb13-28"></a>  <span class="at">id_var =</span> <span class="st">"id"</span>,</span>
<span id="cb13-29"><a href="#cb13-29"></a>  <span class="at">waves =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb13-30"><a href="#cb13-30"></a>  <span class="at">wave_var =</span> <span class="st">"wave"</span>,</span>
<span id="cb13-31"><a href="#cb13-31"></a>  <span class="at">table_name =</span> <span class="st">"transition_table_binary"</span></span>
<span id="cb13-32"><a href="#cb13-32"></a>)</span>
<span id="cb13-33"><a href="#cb13-33"></a><span class="fu">print</span>(transition_tables_binary<span class="sc">$</span>tables[[<span class="dv">1</span>]])</span>
<span id="cb13-34"><a href="#cb13-34"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(transition_tables_binary, <span class="st">"transition_tables_binary"</span>, push_mods)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="take-away-think-about-the-hypothetical-experiment-you-wish-to-perform-with-observational-data." class="level4">
<h4 class="anchored" data-anchor-id="take-away-think-about-the-hypothetical-experiment-you-wish-to-perform-with-observational-data.">Take-away: Think about the hypothetical experiment you wish to perform with observational data.</h4>
<p>Decide early (exposure, cut-point, outcomes, waves), <em>checkpoint</em> everything with <code>here_save()</code>, and the rest of the pipeline flows.</p>
</section>
</section>
<section id="script-2-prepare-final-wide-data" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="script-2-prepare-final-wide-data">Script 2: Prepare Final Wide Data</h3>
<p><strong>Purpose</strong></p>
<p>Convert the tidy long data into a grf-ready wide matrix and correct for dropout bias with inverse-probability-of-censoring weighting (IPCW).</p>
<section id="step-1-go-wide-automatically" class="level4">
<h4 class="anchored" data-anchor-id="step-1-go-wide-automatically">Step 1 – go wide automatically</h4>
<p><code>margot_wide_machine()</code> reshapes each wave into <code>t0_</code>, <code>t1_</code>, <code>t2_</code> columns. You gave it all the names in script 1, so no new choices here. Inspect <code>df_wide</code> just to be sure the columns look sensible (baseline before exposure before outcome).</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="fu">colnames</span>(df_wide)</span>
<span id="cb14-2"><a href="#cb14-2"></a>naniar<span class="sc">::</span><span class="fu">vis_miss</span>(df_wide)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-2-encode-scale-for-algorithms" class="level4">
<h4 class="anchored" data-anchor-id="step-2-encode-scale-for-algorithms">Step 2 – Encode + scale for algorithms</h4>
<p><code>margot_process_longitudinal_data_wider()</code> turns factors into dummies, scales continuous variables, and appends loss-to-follow-up flags. The result is <code>df_wide_encoded</code>.</p>
<p>Quick sanity check: the exposure binaries should be <code>0/1</code> and their <code>NA</code>s must match the *_lost* indicators.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="fu">table</span>(df_wide_encoded<span class="sc">$</span>t0_not_lost_following_wave)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-3-build-ipcw-weights" class="level4">
<h4 class="anchored" data-anchor-id="step-3-build-ipcw-weights">Step 3 – Build IPCW weights*</h4>
<p><strong>Why?</strong> observations that resemble those who dropped out are up-weighted, so estimates stay unbiased when data vanish.</p>
</section>
<section id="step-4-drop-the-censored" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="step-4-drop-the-censored">Step 4 – drop the censored</h4>
<p>Rows with <code>*_lost_following_wave == 1</code> are removed, leaving <code>df_grf</code>. This dataset feeds the causal forest and should now have <strong>no missing values</strong> in any <code>t1_</code> or <code>t2_</code> column. Missingness is permitted in <code>t0_</code> columns</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>naniar<span class="sc">::</span><span class="fu">vis_miss</span>(df_grf)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="../laboratory/missing_final_data_plot.jpg" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption class="margin-caption">Graph of Missingness in Final Cleaned Dataset, time is ordered left (early) to right (late), no missing values in outcomes, missingness permitted for baseline variables</figcaption>
</figure>
</div>
</section>
<section id="step-5-checkpoint-everything" class="level4">
<h4 class="anchored" data-anchor-id="step-5-checkpoint-everything">Step 5 – checkpoint everything</h4>
<p>Each major object (<code>df_wide</code>, <code>df_wide_encoded</code>, <code>df_grf</code>, the weight vectors) is saved with <code>here_save()</code> or <code>here_save_qs()</code>. this keeps the analysis reproducible and the manuscript tables in sync.</p>
</section>
<section id="takeaway-what-you-must-do" class="level4">
<h4 class="anchored" data-anchor-id="takeaway-what-you-must-do">Takeaway: what you must do</h4>
<ol type="1">
<li><strong>Run the script without edits.</strong><br>
</li>
<li>confirm <code>df_grf</code> has the expected number of rows and no missing cells.</li>
</ol>
<p>Script 2 is a conveyor belt: long <span class="math inline">\to</span> wide <span class="math inline">\to</span> weighted <span class="math inline">\to</span> clean. yYur only job is to eyeball the parcels before they roll into the modelling bay.</p>
</section>
</section>
<section id="script-3-the-analysis" class="level3">
<h3 class="anchored" data-anchor-id="script-3-the-analysis">Script 3 The Analysis</h3>
<section id="reproducibility-scaffold" class="level4">
<h4 class="anchored" data-anchor-id="reproducibility-scaffold">1 Reproducibility scaffold</h4>
<div class="sourceCode" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)                 <span class="co"># lock randomness  </span></span>
<span id="cb17-2"><a href="#cb17-2"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(margot, qs …)  <span class="co"># load every tool once  </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>No choices here—just <strong>run</strong> and move on.</p>
</section>
<section id="pull-in-prepared-objects" class="level4">
<h4 class="anchored" data-anchor-id="pull-in-prepared-objects">2 Pull in prepared objects</h4>
<div class="sourceCode" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>df_grf           <span class="ot">&lt;-</span> <span class="fu">here_read</span>(<span class="st">"df_grf"</span>)     <span class="co"># wide, weighted data  </span></span>
<span id="cb18-2"><a href="#cb18-2"></a>name_exposure    <span class="ot">&lt;-</span> <span class="fu">here_read</span>(<span class="st">"name_exposure"</span>)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If anything is <code>NULL</code>, return to scripts 1–2 and debug.</p>
</section>
<section id="sanity-check-with-a-toy-forest" class="level4">
<h4 class="anchored" data-anchor-id="sanity-check-with-a-toy-forest">3 Sanity-check with a toy forest</h4>
<p>Fit one outcome on ¼ of the data to confirm the pipeline before burning CPU hours.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>cf_out <span class="ot">&lt;-</span> <span class="fu">margot_causal_forest</span>(</span>
<span id="cb19-2"><a href="#cb19-2"></a>  <span class="at">data         =</span> df_grf[<span class="fu">sample</span>(<span class="fu">nrow</span>(df_grf), <span class="fu">nrow</span>(df_grf)<span class="sc">/</span><span class="dv">4</span>), ],</span>
<span id="cb19-3"><a href="#cb19-3"></a>  <span class="at">outcome_vars =</span> <span class="st">"t2_kessler_latent_depression_z"</span>,</span>
<span id="cb19-4"><a href="#cb19-4"></a>  <span class="at">covariates   =</span> X,           <span class="co"># baseline covariates E</span></span>
<span id="cb19-5"><a href="#cb19-5"></a>  <span class="at">W            =</span> W,           <span class="co"># exposure</span></span>
<span id="cb19-6"><a href="#cb19-6"></a>  <span class="at">weights      =</span> weights</span>
<span id="cb19-7"><a href="#cb19-7"></a>)</span>
<span id="cb19-8"><a href="#cb19-8"></a><span class="fu">margot_plot_policy_combo</span>(cf_out, <span class="at">max_depth =</span> <span class="dv">1</span>L)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Success = a plot appears without errors.</p>
</section>
<section id="full-model-batches-ate-tables" class="level4">
<h4 class="anchored" data-anchor-id="full-model-batches-ate-tables">4 Full model batches + ATE tables</h4>
<p>Loop over the five outcome domains, saving each model to <code>models_example_2/</code>.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>models_binary <span class="ot">&lt;-</span> <span class="fu">margot_causal_forest</span>(</span>
<span id="cb20-2"><a href="#cb20-2"></a>  <span class="at">data =</span> df_grf,</span>
<span id="cb20-3"><a href="#cb20-3"></a>  <span class="at">outcome_vars =</span> t2_outcome_z,</span>
<span id="cb20-4"><a href="#cb20-4"></a>  <span class="at">covariates   =</span> X, <span class="at">W =</span> W, <span class="at">weights =</span> weights,</span>
<span id="cb20-5"><a href="#cb20-5"></a>  <span class="at">save_models  =</span> <span class="cn">TRUE</span>, <span class="at">save_data =</span> <span class="cn">TRUE</span></span>
<span id="cb20-6"><a href="#cb20-6"></a>)</span>
<span id="cb20-7"><a href="#cb20-7"></a><span class="fu">here_save_qs</span>(models_binary_health, <span class="st">"models_binary"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then create ATE plots and interpretations with <code>margot_plot()</code>. Save as these go straight into the manuscript.</p>
</section>
<section id="heterogeneous-treatment-effects-cate" class="level4">
<h4 class="anchored" data-anchor-id="heterogeneous-treatment-effects-cate">5 Heterogeneous Treatment Effects (CATE)</h4>
<p><em>Evidence phase</em></p>
<ul>
<li><strong>RATE AUTOC</strong> &amp; <strong>Qini curves</strong> via <code>margot_rate()</code> and <code>margot_inspect_qini()</code> flag outcomes with meaningful heterogeneity.</li>
</ul>
<p><em>Action phase</em></p>
<ul>
<li><strong>Flip</strong> outcomes you want to <em>minimise</em> (e.g.&nbsp;depression) so positive CATE = good.</li>
</ul>
<div class="sourceCode" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="co"># flipping models: outcomes we want to minimise given the exposure --------</span></span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="co"># standard negative outcomes/  not used in this example</span></span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="co"># +--------------------------+</span></span>
<span id="cb21-4"><a href="#cb21-4"></a><span class="co"># |    MODIFY THIS           |</span></span>
<span id="cb21-5"><a href="#cb21-5"></a><span class="co"># +--------------------------+</span></span>
<span id="cb21-6"><a href="#cb21-6"></a>flip_outcomes_standard <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb21-7"><a href="#cb21-7"></a>  <span class="co">#"t2_alcohol_frequency_weekly_z",</span></span>
<span id="cb21-8"><a href="#cb21-8"></a>  <span class="co">#"t2_alcohol_intensity_z",</span></span>
<span id="cb21-9"><a href="#cb21-9"></a>  <span class="co">#"t2_hlth_bmi_z",</span></span>
<span id="cb21-10"><a href="#cb21-10"></a>  <span class="co">#"t2_hlth_fatigue_z",</span></span>
<span id="cb21-11"><a href="#cb21-11"></a>  <span class="st">"t2_kessler_latent_anxiety_z"</span>, <span class="co">#  ← select</span></span>
<span id="cb21-12"><a href="#cb21-12"></a>  <span class="st">"t2_kessler_latent_depression_z"</span>,<span class="co">#  ← select</span></span>
<span id="cb21-13"><a href="#cb21-13"></a>  <span class="st">"t2_rumination_z"</span> <span class="co">#  ← select</span></span>
<span id="cb21-14"><a href="#cb21-14"></a>  <span class="co">#"t2_perfectionism_z" # the exposure variable was not investigated</span></span>
<span id="cb21-15"><a href="#cb21-15"></a>)</span>
<span id="cb21-16"><a href="#cb21-16"></a></span>
<span id="cb21-17"><a href="#cb21-17"></a><span class="co"># when exposure is negative and you want to focus on how much worse off</span></span>
<span id="cb21-18"><a href="#cb21-18"></a><span class="co"># some people are use this: </span></span>
<span id="cb21-19"><a href="#cb21-19"></a><span class="co"># flip_outcomes&lt;- c( setdiff(t2_outcomes_all, flip_outcomes_standard) )</span></span>
<span id="cb21-20"><a href="#cb21-20"></a></span>
<span id="cb21-21"><a href="#cb21-21"></a><span class="co"># our example has the exposure as positive</span></span>
<span id="cb21-22"><a href="#cb21-22"></a>flip_outcomes <span class="ot">&lt;-</span> flip_outcomes_standard</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Don’t forget to get and save the labels for these models:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="co"># get labels</span></span>
<span id="cb22-2"><a href="#cb22-2"></a>flipped_names <span class="ot">&lt;-</span> <span class="fu">margot_get_labels</span>(flip_outcomes, label_mapping_all)</span>
<span id="cb22-3"><a href="#cb22-3"></a></span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="co"># check</span></span>
<span id="cb22-5"><a href="#cb22-5"></a>flipped_names</span>
<span id="cb22-6"><a href="#cb22-6"></a></span>
<span id="cb22-7"><a href="#cb22-7"></a><span class="co"># save for publication</span></span>
<span id="cb22-8"><a href="#cb22-8"></a><span class="fu">here_save</span>(flipped_names, <span class="st">"flipped_names"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>Fit <strong>policy trees</strong> (<code>margot_policy()</code>, <code>max_depth = 2L</code>) to discover actionable rules.</p></li>
<li><p>Depth-1 trees are often trivial; depth-2 gives interpretable nuance.</p></li>
</ul>
<p>Check that every split variable exists in the original data and that leaves map sensibly onto subgroups (no cells with &lt; 30 observations).</p>
<p>Key workflow is:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="co"># run the margot_policy function</span></span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="co"># policy tree analysis depth 2L -------------------------------------------------</span></span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="co"># make policy trees</span></span>
<span id="cb23-4"><a href="#cb23-4"></a><span class="co"># *** 2l is much more persuasive ***</span></span>
<span id="cb23-5"><a href="#cb23-5"></a>plots_policy_trees_2L <span class="ot">&lt;-</span> <span class="fu">margot_policy</span>(</span>
<span id="cb23-6"><a href="#cb23-6"></a>  models_binary_flipped_all,</span>
<span id="cb23-7"><a href="#cb23-7"></a>  <span class="at">save_plots =</span> <span class="cn">FALSE</span>,</span>
<span id="cb23-8"><a href="#cb23-8"></a>  <span class="at">output_dir =</span> here<span class="sc">::</span><span class="fu">here</span>(push_mods),</span>
<span id="cb23-9"><a href="#cb23-9"></a>  <span class="at">decision_tree_args =</span> decision_tree_defaults,</span>
<span id="cb23-10"><a href="#cb23-10"></a>  <span class="at">policy_tree_args =</span> policy_tree_defaults,</span>
<span id="cb23-11"><a href="#cb23-11"></a>  <span class="at">model_names =</span> rate_interpretation_all<span class="sc">$</span>either_model_names,</span>
<span id="cb23-12"><a href="#cb23-12"></a>  <span class="co"># defined above</span></span>
<span id="cb23-13"><a href="#cb23-13"></a>  <span class="at">original_df =</span> original_df,</span>
<span id="cb23-14"><a href="#cb23-14"></a>  <span class="at">label_mapping =</span> label_mapping_all,</span>
<span id="cb23-15"><a href="#cb23-15"></a>  <span class="at">max_depth =</span> <span class="dv">2</span>L</span>
<span id="cb23-16"><a href="#cb23-16"></a>)</span>
<span id="cb23-17"><a href="#cb23-17"></a></span>
<span id="cb23-18"><a href="#cb23-18"></a>n_models <span class="ot">&lt;-</span> <span class="fu">length</span>(rate_interpretation_all<span class="sc">$</span>either_model_names)</span>
<span id="cb23-19"><a href="#cb23-19"></a></span>
<span id="cb23-20"><a href="#cb23-20"></a>model_outputs_2L <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span>n_models, <span class="sc">~</span>plots_policy_trees_2L[[.x]][[<span class="dv">3</span>]])</span>
<span id="cb23-21"><a href="#cb23-21"></a><span class="fu">names</span>(model_outputs_2L) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"model_"</span>, <span class="dv">1</span><span class="sc">:</span>n_models)</span>
<span id="cb23-22"><a href="#cb23-22"></a></span>
<span id="cb23-23"><a href="#cb23-23"></a><span class="co"># view plots (three in this example)</span></span>
<span id="cb23-24"><a href="#cb23-24"></a>model_outputs_2L<span class="sc">$</span>model_1</span>
<span id="cb23-25"><a href="#cb23-25"></a>model_outputs_2L<span class="sc">$</span>model_2</span>
<span id="cb23-26"><a href="#cb23-26"></a>model_outputs_2L<span class="sc">$</span>model_3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You get the interpretation with this:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>interpret_plots_policy_trees_2L <span class="ot">&lt;-</span> <span class="fu">margot_interpret_policy_batch</span>(</span>
<span id="cb24-2"><a href="#cb24-2"></a>  models_binary_flipped_all, <span class="at">model_names =</span> rate_interpretation_all<span class="sc">$</span>either_model_names)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If you were wanting to evaluate all models qualitatively, with appropriate caution you could use this code, <strong>BUT</strong> warn your audience and inspect results to see if the predictive plots capture well-defined subgroups.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="co"># ALL model 2L</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>all_plots_policy_trees_2L <span class="ot">&lt;-</span> <span class="fu">margot_policy</span>(</span>
<span id="cb25-3"><a href="#cb25-3"></a>  models_binary_flipped_all,</span>
<span id="cb25-4"><a href="#cb25-4"></a>  <span class="at">save_plots =</span> <span class="cn">FALSE</span>,</span>
<span id="cb25-5"><a href="#cb25-5"></a>  <span class="at">output_dir =</span> here<span class="sc">::</span><span class="fu">here</span>(push_mods),</span>
<span id="cb25-6"><a href="#cb25-6"></a>  <span class="at">decision_tree_args =</span> decision_tree_defaults,</span>
<span id="cb25-7"><a href="#cb25-7"></a>  <span class="at">policy_tree_args =</span> policy_tree_defaults,</span>
<span id="cb25-8"><a href="#cb25-8"></a>  <span class="co"># model_names = rate_interpretation_all$either_model_names, # use all</span></span>
<span id="cb25-9"><a href="#cb25-9"></a>  <span class="co"># defined above</span></span>
<span id="cb25-10"><a href="#cb25-10"></a>  <span class="at">original_df =</span> original_df,</span>
<span id="cb25-11"><a href="#cb25-11"></a>  <span class="at">label_mapping =</span> label_mapping_all,</span>
<span id="cb25-12"><a href="#cb25-12"></a>  <span class="at">max_depth =</span> <span class="dv">2</span>L</span>
<span id="cb25-13"><a href="#cb25-13"></a>)</span>
<span id="cb25-14"><a href="#cb25-14"></a>n_models_all <span class="ot">&lt;-</span> <span class="fu">length</span>(models_binary_flipped_all<span class="sc">$</span>results)</span>
<span id="cb25-15"><a href="#cb25-15"></a>n_models_all</span>
<span id="cb25-16"><a href="#cb25-16"></a></span>
<span id="cb25-17"><a href="#cb25-17"></a>model_outputs_2L_all <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span>n_models_all, <span class="sc">~</span>all_plots_policy_trees_2L[[.x]][[<span class="dv">3</span>]])</span>
<span id="cb25-18"><a href="#cb25-18"></a><span class="fu">names</span>(model_outputs_2L_all) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"model_"</span>, <span class="dv">1</span><span class="sc">:</span>n_models_all)</span>
<span id="cb25-19"><a href="#cb25-19"></a></span>
<span id="cb25-20"><a href="#cb25-20"></a><span class="co"># view</span></span>
<span id="cb25-21"><a href="#cb25-21"></a>model_outputs_2L_all<span class="sc">$</span>model_1 <span class="co"># ← convincing? </span></span>
<span id="cb25-22"><a href="#cb25-22"></a>model_outputs_2L_all<span class="sc">$</span>model_2 <span class="co"># ← convincing? </span></span>
<span id="cb25-23"><a href="#cb25-23"></a>model_outputs_2L_all<span class="sc">$</span>model_3 <span class="co"># ← convincing? </span></span>
<span id="cb25-24"><a href="#cb25-24"></a>model_outputs_2L_all<span class="sc">$</span>model_4 <span class="co"># ← convincing? </span></span>
<span id="cb25-25"><a href="#cb25-25"></a>model_outputs_2L_all<span class="sc">$</span>model_5 <span class="co"># ← convincing? </span></span>
<span id="cb25-26"><a href="#cb25-26"></a>model_outputs_2L_all<span class="sc">$</span>model_6 <span class="co"># ← convincing? </span></span>
<span id="cb25-27"><a href="#cb25-27"></a>model_outputs_2L_all<span class="sc">$</span>model_7 <span class="co"># ← convincing? </span></span>
<span id="cb25-28"><a href="#cb25-28"></a>model_outputs_2L_all<span class="sc">$</span>model_8 <span class="co"># ← convincing? </span></span>
<span id="cb25-29"><a href="#cb25-29"></a>model_outputs_2L_all<span class="sc">$</span>model_9 <span class="co"># ← convincing?  </span></span>
<span id="cb25-30"><a href="#cb25-30"></a>model_outputs_2L_all<span class="sc">$</span>model_10 <span class="co"># ← convincing? </span></span>
<span id="cb25-31"><a href="#cb25-31"></a>model_outputs_2L_all<span class="sc">$</span>model_11 <span class="co"># ← convincing? </span></span>
<span id="cb25-32"><a href="#cb25-32"></a>model_outputs_2L_all<span class="sc">$</span>model_12 <span class="co"># ← convincing? </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And then to interpret:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="co"># interpretation</span></span>
<span id="cb26-2"><a href="#cb26-2"></a>interpret_plots_policy_trees_2L_all <span class="ot">&lt;-</span> <span class="fu">margot_interpret_policy_batch</span>(models_binary_flipped_all, <span class="at">max_depth =</span> <span class="dv">2</span>)</span>
<span id="cb26-3"><a href="#cb26-3"></a></span>
<span id="cb26-4"><a href="#cb26-4"></a><span class="co"># view interpretation</span></span>
<span id="cb26-5"><a href="#cb26-5"></a><span class="fu">cat</span>(interpret_plots_policy_trees_2L_all)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>*Note that we do not save these outputs for the mansuscript. We will instead re-generate the graphs and interpretations when we import results into the quarto result template. We’ll cover this part of the workflow in the remaining weeks.</p>
</section>
<section id="report-subgroup-analyses-optional" class="level4">
<h4 class="anchored" data-anchor-id="report-subgroup-analyses-optional">6 Report subgroup analyses (optional)</h4>
<p>When theory predicts effect modification—age bands, income thirds, etc.—use <code>margot_planned_subgroups_batch()</code>. The helper auto-generates tables and mini-plots; just pass the subset definitions you crafted:</p>
<p>First we need to set up continitions for continuous variables, like this:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a><span class="co"># step 1 get information for wealth for conditonal comparisons</span></span>
<span id="cb27-2"><a href="#cb27-2"></a><span class="fu">head</span>(df_grf<span class="sc">$</span>t0_log_household_inc_z)</span>
<span id="cb27-3"><a href="#cb27-3"></a></span>
<span id="cb27-4"><a href="#cb27-4"></a><span class="co"># get mean on original data scale</span></span>
<span id="cb27-5"><a href="#cb27-5"></a>log_mean_inc <span class="ot">&lt;-</span> <span class="fu">mean</span>(original_df<span class="sc">$</span>t0_log_household_inc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-6"><a href="#cb27-6"></a></span>
<span id="cb27-7"><a href="#cb27-7"></a><span class="co"># get sd on original data scale</span></span>
<span id="cb27-8"><a href="#cb27-8"></a>log_sd_inc <span class="ot">&lt;-</span> <span class="fu">sd</span>(original_df<span class="sc">$</span>t0_log_household_inc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-9"><a href="#cb27-9"></a></span>
<span id="cb27-10"><a href="#cb27-10"></a><span class="co"># function to get back to data scale</span></span>
<span id="cb27-11"><a href="#cb27-11"></a><span class="fu">margot_back_transform_log_z</span>(</span>
<span id="cb27-12"><a href="#cb27-12"></a>  <span class="at">log_mean =</span> log_mean_inc,</span>
<span id="cb27-13"><a href="#cb27-13"></a>  <span class="at">log_sd =</span> log_sd_inc,</span>
<span id="cb27-14"><a href="#cb27-14"></a>  <span class="at">z_scores =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb27-15"><a href="#cb27-15"></a>  <span class="at">label =</span> <span class="st">"data_scale"</span></span>
<span id="cb27-16"><a href="#cb27-16"></a>)</span>
<span id="cb27-17"><a href="#cb27-17"></a></span>
<span id="cb27-18"><a href="#cb27-18"></a><span class="co"># define complex conditions for subsetting</span></span>
<span id="cb27-19"><a href="#cb27-19"></a>complex_condition_political <span class="ot">&lt;-</span> X[, <span class="st">"t0_political_conservative_z"</span>] <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">&amp;</span></span>
<span id="cb27-20"><a href="#cb27-20"></a>  X[, <span class="st">"t0_political_conservative_z"</span>] <span class="sc">&lt;</span> <span class="dv">1</span></span>
<span id="cb27-21"><a href="#cb27-21"></a></span>
<span id="cb27-22"><a href="#cb27-22"></a>complex_condition_wealth <span class="ot">&lt;-</span> X[, <span class="st">"t0_log_household_inc_z"</span>] <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">&amp;</span></span>
<span id="cb27-23"><a href="#cb27-23"></a>  X[, <span class="st">"t0_log_household_inc_z"</span>] <span class="sc">&lt;</span> <span class="dv">1</span></span>
<span id="cb27-24"><a href="#cb27-24"></a></span>
<span id="cb27-25"><a href="#cb27-25"></a>complex_condition_age <span class="ot">&lt;-</span> X[, <span class="st">"t0_age_z"</span>] <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">&amp;</span></span>
<span id="cb27-26"><a href="#cb27-26"></a>  X[, <span class="st">"t0_age_z"</span>] <span class="sc">&lt;</span> <span class="dv">1</span></span>
<span id="cb27-27"><a href="#cb27-27"></a></span>
<span id="cb27-28"><a href="#cb27-28"></a><span class="co"># # if we have specific groups to compare</span></span>
<span id="cb27-29"><a href="#cb27-29"></a><span class="co"># complex_condition_age_under_neg_1_sd  &lt;- X[, "t0_age_z"] &lt; -1</span></span>
<span id="cb27-30"><a href="#cb27-30"></a><span class="co"># complex_condition_age_gr_eq_neg_1_sd  &lt;- X[, "t0_age_z"] &gt; -1</span></span>
<span id="cb27-31"><a href="#cb27-31"></a></span>
<span id="cb27-32"><a href="#cb27-32"></a><span class="co"># check ages to get number</span></span>
<span id="cb27-33"><a href="#cb27-33"></a><span class="fu">mean</span>(original_df<span class="sc">$</span>t0_age) <span class="sc">-</span> <span class="fu">sd</span>(original_df<span class="sc">$</span>t0_age)</span>
<span id="cb27-34"><a href="#cb27-34"></a><span class="fu">mean</span>(original_df<span class="sc">$</span>t0_age) <span class="sc">+</span> <span class="fu">sd</span>(original_df<span class="sc">$</span>t0_age)</span>
<span id="cb27-35"><a href="#cb27-35"></a></span>
<span id="cb27-36"><a href="#cb27-36"></a></span>
<span id="cb27-37"><a href="#cb27-37"></a><span class="co"># wealth subsets</span></span>
<span id="cb27-38"><a href="#cb27-38"></a>subsets_standard_wealth <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb27-39"><a href="#cb27-39"></a>  <span class="at">Poor =</span> <span class="fu">list</span>(</span>
<span id="cb27-40"><a href="#cb27-40"></a>    <span class="at">var =</span> <span class="st">"t0_log_household_inc_z"</span>,</span>
<span id="cb27-41"><a href="#cb27-41"></a>    <span class="at">value =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb27-42"><a href="#cb27-42"></a>    <span class="at">operator =</span> <span class="st">"&lt;"</span>,</span>
<span id="cb27-43"><a href="#cb27-43"></a>    <span class="at">description =</span> <span class="st">"Effects among those HShold income &lt; -1 SD (NZD ~41k)"</span>,</span>
<span id="cb27-44"><a href="#cb27-44"></a>    <span class="at">label =</span> <span class="st">"Poor"</span>  <span class="co"># label remains as is, but could be changed if desired</span></span>
<span id="cb27-45"><a href="#cb27-45"></a>  ),</span>
<span id="cb27-46"><a href="#cb27-46"></a>  <span class="at">MiddleIncome =</span> <span class="fu">list</span>(<span class="at">subset_condition =</span> complex_condition_wealth, <span class="at">description =</span> <span class="st">"Effects among those HS_hold income within +/-1SD (&gt; NZD 41k &lt; NZD 191k)"</span>),</span>
<span id="cb27-47"><a href="#cb27-47"></a>  <span class="at">Rich =</span> <span class="fu">list</span>(</span>
<span id="cb27-48"><a href="#cb27-48"></a>    <span class="at">var =</span> <span class="st">"t0_log_household_inc_z"</span>,</span>
<span id="cb27-49"><a href="#cb27-49"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb27-50"><a href="#cb27-50"></a>    <span class="at">operator =</span> <span class="st">"&gt;"</span>,</span>
<span id="cb27-51"><a href="#cb27-51"></a>    <span class="at">description =</span> <span class="st">"Effects among those HS_hold income &gt; +1 SD (NZD 191k)"</span>,</span>
<span id="cb27-52"><a href="#cb27-52"></a>    <span class="at">label =</span> <span class="st">"Rich"</span></span>
<span id="cb27-53"><a href="#cb27-53"></a>  )</span>
<span id="cb27-54"><a href="#cb27-54"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Or for categorical variables like this:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="co"># ethnicity subsets</span></span>
<span id="cb28-2"><a href="#cb28-2"></a>subsets_standard_ethnicity <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb28-3"><a href="#cb28-3"></a>  <span class="at">Asian =</span> <span class="fu">list</span>(</span>
<span id="cb28-4"><a href="#cb28-4"></a>    <span class="at">var =</span> <span class="st">"t0_eth_cat_asian_binary"</span>,</span>
<span id="cb28-5"><a href="#cb28-5"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb28-6"><a href="#cb28-6"></a>    <span class="at">description =</span> <span class="st">"Asians"</span></span>
<span id="cb28-7"><a href="#cb28-7"></a>  ),</span>
<span id="cb28-8"><a href="#cb28-8"></a>  <span class="at">Euro =</span> <span class="fu">list</span>(</span>
<span id="cb28-9"><a href="#cb28-9"></a>    <span class="at">var =</span> <span class="st">"t0_eth_cat_euro_binary"</span>,</span>
<span id="cb28-10"><a href="#cb28-10"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb28-11"><a href="#cb28-11"></a>    <span class="at">description =</span> <span class="st">"Europeans (Pakeha)"</span></span>
<span id="cb28-12"><a href="#cb28-12"></a>  ),</span>
<span id="cb28-13"><a href="#cb28-13"></a>  <span class="at">Pacific =</span> <span class="fu">list</span>(</span>
<span id="cb28-14"><a href="#cb28-14"></a>    <span class="at">var =</span> <span class="st">"t0_eth_cat_pacific_binary"</span>,</span>
<span id="cb28-15"><a href="#cb28-15"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb28-16"><a href="#cb28-16"></a>    <span class="at">description =</span> <span class="st">"Pacific Peoples"</span></span>
<span id="cb28-17"><a href="#cb28-17"></a>  ),</span>
<span id="cb28-18"><a href="#cb28-18"></a>  <span class="at">Maori =</span> <span class="fu">list</span>(</span>
<span id="cb28-19"><a href="#cb28-19"></a>    <span class="at">var =</span> <span class="st">"t0_eth_cat_maori_binary"</span>,</span>
<span id="cb28-20"><a href="#cb28-20"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb28-21"><a href="#cb28-21"></a>    <span class="at">description =</span> <span class="st">"Māori"</span></span>
<span id="cb28-22"><a href="#cb28-22"></a>  )</span>
<span id="cb28-23"><a href="#cb28-23"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We set up subtypes like this:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a><span class="co"># set up subset types in a list</span></span>
<span id="cb29-2"><a href="#cb29-2"></a>subset_types <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb29-3"><a href="#cb29-3"></a>  <span class="at">wealth =</span> subsets_standard_wealth,</span>
<span id="cb29-4"><a href="#cb29-4"></a>  <span class="at">ethnicity =</span> subsets_standard_ethnicity,</span>
<span id="cb29-5"><a href="#cb29-5"></a>)</span>
<span id="cb29-6"><a href="#cb29-6"></a></span>
<span id="cb29-7"><a href="#cb29-7"></a></span>
<span id="cb29-8"><a href="#cb29-8"></a><span class="co"># run model</span></span>
<span id="cb29-9"><a href="#cb29-9"></a>planned_subset_results <span class="ot">&lt;-</span> <span class="fu">margot_planned_subgroups_batch</span>(</span>
<span id="cb29-10"><a href="#cb29-10"></a>  <span class="at">domain_models =</span> domain_models,</span>
<span id="cb29-11"><a href="#cb29-11"></a>  <span class="at">X =</span> X,</span>
<span id="cb29-12"><a href="#cb29-12"></a>  <span class="at">base_defaults =</span> base_defaults_binary,</span>
<span id="cb29-13"><a href="#cb29-13"></a>  <span class="at">subset_types =</span> subset_types,</span>
<span id="cb29-14"><a href="#cb29-14"></a>  <span class="at">original_df =</span> original_df,</span>
<span id="cb29-15"><a href="#cb29-15"></a>  <span class="at">domain_names =</span> domain_names,</span>
<span id="cb29-16"><a href="#cb29-16"></a>  <span class="at">subtitles =</span> subtitles</span>
<span id="cb29-17"><a href="#cb29-17"></a>)</span>
<span id="cb29-18"><a href="#cb29-18"></a></span>
<span id="cb29-19"><a href="#cb29-19"></a></span>
<span id="cb29-20"><a href="#cb29-20"></a><span class="co"># results</span></span>
<span id="cb29-21"><a href="#cb29-21"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>wealth<span class="sc">$</span>explanation)</span>
<span id="cb29-22"><a href="#cb29-22"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>ethnicity<span class="sc">$</span>explanation)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And then we can carry on to graphs and tables as described in the scripts. Note that an interesting set of subgroups to investigate by ’default` are: gender/age/ethnicity. However, unless there are theoretical reasons to expect such differences we should be <em>very cautious</em> about inferring too much. As we can see from the policy trees, heterogeneity doesn’t unfold at our pre-defined categories, but rather in surprising ways.</p>
</section>
<section id="takeaway" class="level4">
<h4 class="anchored" data-anchor-id="takeaway">Takeaway</h4>
<p>Run the script in order, <strong>eyes on three checkpoints</strong>: the toy forest plot, convincing Qini/RATE curves/interpretations, and sensible policy-tree leaves. Everything else is auto-saved for the manuscript.</p>
</section>
</section>
</section>
</section>
<section id="part-2" class="level1 page-columns page-full">
<h1>Part 2:</h1>
<ul>
<li><strong>Sensitivity Analysis: E-values</strong></li>
<li><strong>Workflow</strong></li>
</ul>
<!-- ### Modified Treatment Policies and E-values -->
<!-- A modified treatment policy is a *flexible* intervention of the following form:  -->
<!-- $$ -->
<!-- \mathbf{d}^\lambda (a_1) = \begin{cases} 4 & \text{if } a_1 < 4 \\  -->
<!-- a_1 & \text{otherwise} \end{cases} -->
<!-- $$ -->
<!-- $$ -->
<!-- \mathbf{d}^\phi (a_1) = \begin{cases} 0 & \text{if } a_1 > 0 \\  -->
<!-- a_1 & \text{otherwise} \end{cases} -->
<!-- $$ -->
<!-- $$ g' = \text{Intervention 1 - Intervention 2} = E[Y(\mathbf{d}^\lambda) - Y(\mathbf{d}^\phi)] $$ -->
<!-- $$ g'' = \text{Intervention 1 - Intervention 2} = E[Y(\mathbf{d}^\lambda) - Y(\mathbf{d}^\phi)] $$ -->
<!-- $$ -->
<!-- {\delta}(g) ={g'} - {g''} -->
<!-- $$ -->
<!-- Rather than shifting an entire population into one of two states, the estimand flexibly shifts a population according to a pre-specified function.  -->
<!-- see: @hoffman2023 -->
<section id="sensitivity-analysis-using-e-values" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="sensitivity-analysis-using-e-values">Sensitivity Analysis using E-values</h3>
<blockquote class="blockquote">
<p>The minimum strength of association on the risk ratio scale that an unmeasured confounder would need to have with both the exposure and the outcome, conditional on the measured covariates, to fully explain away a specific exposure-outcome association</p>
</blockquote>
<p>See: <span class="citation" data-cites="mathur2018">Mathur et al. (<a href="#ref-mathur2018" role="doc-biblioref">2018</a>)</span>; <span class="citation" data-cites="linden2020EVALUE">Linden, Mathur, and VanderWeele (<a href="#ref-linden2020EVALUE" role="doc-biblioref">2020</a>)</span>; <span class="citation" data-cites="vanderweele2017">Tyler J. VanderWeele and Ding (<a href="#ref-vanderweele2017" role="doc-biblioref">2017</a>)</span>.</p>
<div class="no-row-height column-margin column-container"><div id="ref-mathur2018" class="csl-entry" role="listitem">
Mathur, Maya B, Peng Ding, Corinne A Riddell, and Tyler J VanderWeele. 2018. <span>“Website and r Package for Computing <span>E</span>-Values.”</span> <em>Epidemiology (Cambridge, Mass.)</em> 29 (5): e45.
</div></div><p>For example, suppose that the lower bound of the the E-value was 1.3 with the lower bound of the confidence interval = 1.12, we might then write:</p>
<blockquote class="blockquote">
<p>With an observed risk ratio of RR=1.3, an unmeasured confounder that was associated with both the outcome and the exposure by a risk ratio of 1.3-fold each (or 30%), above and beyond the measured confounders, could explain away the estimate, but weaker joint confounder associations could not; to move the confidence interval to include the null, an unmeasured confounder that was associated with the outcome and the exposure by a risk ratio of 1.12-fold (or 12%) each could do so, but weaker joint confounder associations could not.</p>
</blockquote>
<p>The equations are as follows (for risk ratios)</p>
<p><span class="math display">
E-value_{RR} = RR + \sqrt{RR \times (RR - 1)}
</span></p>
<p><span class="math display">
E-value_{LCL} = LCL + \sqrt{LCL \times (LCL - 1)}
</span></p>
<p>Here is an R function that will calculate E-values</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a><span class="co"># evalue for risk ratio</span></span>
<span id="cb30-2"><a href="#cb30-2"></a>calculate_e_value <span class="ot">&lt;-</span> <span class="cf">function</span>(rr, lcl) {</span>
<span id="cb30-3"><a href="#cb30-3"></a>  e_value_rr <span class="ot">=</span> rr <span class="sc">+</span> <span class="fu">sqrt</span>(rr<span class="sc">*</span>(rr <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb30-4"><a href="#cb30-4"></a>  e_value_lcl <span class="ot">=</span> lcl <span class="sc">+</span> <span class="fu">sqrt</span>(lcl<span class="sc">*</span>(lcl <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb30-5"><a href="#cb30-5"></a>  </span>
<span id="cb30-6"><a href="#cb30-6"></a>  <span class="fu">list</span>(<span class="at">e_value_rr =</span> e_value_rr, <span class="at">e_value_lcl =</span> e_value_lcl)</span>
<span id="cb30-7"><a href="#cb30-7"></a>}</span>
<span id="cb30-8"><a href="#cb30-8"></a></span>
<span id="cb30-9"><a href="#cb30-9"></a><span class="co"># e.g. smoking causes cancer</span></span>
<span id="cb30-10"><a href="#cb30-10"></a><span class="co"># finding   RR = 10.73 (95% CI: 8.02, 14.36)</span></span>
<span id="cb30-11"><a href="#cb30-11"></a>evalue_computed <span class="ot">&lt;-</span> <span class="fu">calculate_e_value</span>(<span class="fl">10.73</span>, <span class="fl">8.02</span>)</span>
<span id="cb30-12"><a href="#cb30-12"></a></span>
<span id="cb30-13"><a href="#cb30-13"></a><span class="co">#print</span></span>
<span id="cb30-14"><a href="#cb30-14"></a>evalue_computed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>$e_value_rr
[1] 20.94777

$e_value_lcl
[1] 15.52336</code></pre>
</div>
</div>
<p>We write:</p>
<blockquote class="blockquote">
<p>With an observed risk ratio of RR=10.7, an unmeasured confounder that was associated 20.9477737-fold each, above and beyond the measured confounders, could explain away the estimate, but weaker joint confounder associations could not; to move the confidence interval to include the null, an unmeasured confounder that was associated with the outcome and the exposure by a risk ratio of <code>e_value_rr$e_value_lcl</code>-fold each could do so, but weaker joint confounder associations could not.</p>
</blockquote>
<p>Note that in this class, most of the outcomes will be (standardised) continuous outcomes. Here’s a function and LaTeX code to describe the approximation.</p>
<p>This function takes a linear regression coefficient estimate (<code>est</code>), its standard error (<code>se</code>), the standard deviation of the outcome (<code>sd</code>), a contrast of interest in the exposure (<code>delta</code>, which defaults to 1), and a “true” standardized mean difference (true, which defaults to 0). It calculates the odds ratio using the formula from Chinn (2000) and VanderWeele (2017), and then uses this to calculate the E-value.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a><span class="co">#evalue for ols</span></span>
<span id="cb32-2"><a href="#cb32-2"></a>compute_evalue_ols <span class="ot">&lt;-</span> <span class="cf">function</span>(est, se, <span class="at">delta =</span> <span class="dv">1</span>, <span class="at">true =</span> <span class="dv">0</span>) {</span>
<span id="cb32-3"><a href="#cb32-3"></a>  <span class="co"># rescale estimate and SE to get a contrast of size delta</span></span>
<span id="cb32-4"><a href="#cb32-4"></a>  est <span class="ot">&lt;-</span> est <span class="sc">/</span> delta</span>
<span id="cb32-5"><a href="#cb32-5"></a>  se <span class="ot">&lt;-</span> se <span class="sc">/</span> delta</span>
<span id="cb32-6"><a href="#cb32-6"></a></span>
<span id="cb32-7"><a href="#cb32-7"></a>  <span class="co"># compute transformed odds ratio and ci's</span></span>
<span id="cb32-8"><a href="#cb32-8"></a>  odds_ratio <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fl">0.91</span> <span class="sc">*</span> est)</span>
<span id="cb32-9"><a href="#cb32-9"></a>  lo <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fl">0.91</span> <span class="sc">*</span> est <span class="sc">-</span> <span class="fl">1.78</span> <span class="sc">*</span> se)</span>
<span id="cb32-10"><a href="#cb32-10"></a>  hi <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fl">0.91</span> <span class="sc">*</span> est <span class="sc">+</span> <span class="fl">1.78</span> <span class="sc">*</span> se)</span>
<span id="cb32-11"><a href="#cb32-11"></a></span>
<span id="cb32-12"><a href="#cb32-12"></a>  <span class="co"># compute E-Values based on the RR values</span></span>
<span id="cb32-13"><a href="#cb32-13"></a>  evalue_point_estimate <span class="ot">&lt;-</span> odds_ratio <span class="sc">*</span> <span class="fu">sqrt</span>(odds_ratio <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb32-14"><a href="#cb32-14"></a>  evalue_lower_ci <span class="ot">&lt;-</span> lo <span class="sc">*</span> <span class="fu">sqrt</span>(lo <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb32-15"><a href="#cb32-15"></a></span>
<span id="cb32-16"><a href="#cb32-16"></a>  <span class="co"># return the e-values</span></span>
<span id="cb32-17"><a href="#cb32-17"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">EValue_PointEstimate =</span> evalue_point_estimate,</span>
<span id="cb32-18"><a href="#cb32-18"></a>              <span class="at">EValue_LowerCI =</span> evalue_lower_ci))</span>
<span id="cb32-19"><a href="#cb32-19"></a>}</span>
<span id="cb32-20"><a href="#cb32-20"></a></span>
<span id="cb32-21"><a href="#cb32-21"></a></span>
<span id="cb32-22"><a href="#cb32-22"></a><span class="co"># example:</span></span>
<span id="cb32-23"><a href="#cb32-23"></a><span class="co"># suppose we have an estimate of 0.5, a standard error of 0.1, and a standard deviation of 1.</span></span>
<span id="cb32-24"><a href="#cb32-24"></a><span class="co"># this would correspond to a half a standard deviation increase in the outcome per unit increase in the exposure.</span></span>
<span id="cb32-25"><a href="#cb32-25"></a>results <span class="ot">&lt;-</span> <span class="fu">compute_evalue_ols</span>(<span class="at">est =</span> <span class="fl">0.5</span>, <span class="at">se =</span> <span class="fl">0.1</span>, <span class="at">delta =</span> <span class="dv">1</span>)</span>
<span id="cb32-26"><a href="#cb32-26"></a>point_round <span class="ot">&lt;-</span> <span class="fu">round</span>(results<span class="sc">$</span>EValue_PointEstimate, <span class="dv">3</span>)</span>
<span id="cb32-27"><a href="#cb32-27"></a>ci_round <span class="ot">&lt;-</span> <span class="fu">round</span>(results<span class="sc">$</span>EValue_LowerCI, <span class="dv">3</span>)</span>
<span id="cb32-28"><a href="#cb32-28"></a></span>
<span id="cb32-29"><a href="#cb32-29"></a><span class="co"># print results</span></span>
<span id="cb32-30"><a href="#cb32-30"></a><span class="fu">print</span>(point_round)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.53</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a><span class="fu">print</span>(ci_round)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2.009</code></pre>
</div>
</div>
<p>We write:</p>
<blockquote class="blockquote">
<p>With an observed risk ratio of 2.53, an unmeasured confounder that was associated with both the outcome and the exposure by a risk ratio of 2.53-fold each, above and beyond the measured confounders, could explain away the estimate, but weaker joint confounder associations could not; to move the confidence interval to include the null, an unmeasured confounder that was associated with the outcome and the exposure by a risk ratio of 2.009-fold each could do so, but weaker joint confounder associations could not.</p>
</blockquote>
<p>Note the E-values package will do the computational work for us and this is what we use in the <code>margot</code> package to obtain E-values for sensitivity analysis.</p>
</section>
<section id="part-2-guide-for-preparing-your-study" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="part-2-guide-for-preparing-your-study">Part 2 Guide For Preparing Your Study</h2>
<p>Recall that psychology begins with two questions.</p>
<blockquote class="blockquote">
<p>What do I want to know about thought and behaviour? What is the target population?</p>
</blockquote>
<p>In cross-cultural psychology, these questions relate to differences, and similarities, between groups.</p>
<p>Suppose we have asked a question. How can we address it using observational data?</p>
<p>Too fast.</p>
<p>Our question must be made precise.</p>
<p>Today we will consider how to make psychological questions precise, and how to answer them, using 3-wave panel designs <span class="citation" data-cites="vanderweele2020">(<a href="#ref-vanderweele2020" role="doc-biblioref">Tyler J. VanderWeele, Mathur, and Chen 2020</a>)</span>.</p>
<div class="no-row-height column-margin column-container"></div></section>
<section id="comprehensive-checklist-for-detailed-reporting-of-a-causal-inferenctial-study." class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="comprehensive-checklist-for-detailed-reporting-of-a-causal-inferenctial-study.">Comprehensive Checklist for Detailed Reporting of a Causal Inferenctial Study.</h2>
<section id="step-1-formulate-the-research-question" class="level4">
<h4 class="anchored" data-anchor-id="step-1-formulate-the-research-question">Step 1: Formulate the Research Question</h4>
<ul>
<li><strong>State your question:</strong> is my question clearly stated? If not, state it.</li>
<li><strong>Relevance:</strong> have I explained its importance? If not, explain.</li>
<li><strong>Ethics</strong> how might this question affect people? How might not investigating this question affect people?</li>
<li><strong>Causality:</strong> Is my question causal? If not, refine your question.</li>
<li><strong>Heterogeneous Treatment Effects</strong>: Do I want to examine who responds differently (CATE)?</li>
<li><strong>Subgroup analysis:</strong> does my question involve a subgroup (e.g., cultural group)? If not, develop a subgroup analysis question.</li>
<li><strong>Explain the Framework:</strong> can I explain the causal inference framework and convey the gist to non-specialists? If not, review course materials.</li>
</ul>
</section>
<section id="determine-data-requirements" class="level4">
<h4 class="anchored" data-anchor-id="determine-data-requirements">Determine Data Requirements</h4>
<ul>
<li><strong>Data types:</strong> are my data experimental? If yes, your project may not fit this course.</li>
<li><strong>Time-series data:</strong> are my data time-series? If not, reconsider your causal question.</li>
<li><strong>Data waves:</strong> do I have at least three waves of data? If not, beware of confounding control issues.</li>
<li><strong>Data source:</strong> are my data from the NZAVS simulated data set? If not, consult with me.</li>
</ul>
</section>
<section id="determine-the-outcome" class="level4">
<h4 class="anchored" data-anchor-id="determine-the-outcome">Determine the Outcome</h4>
<ul>
<li><strong>Outcome variable:</strong> is the outcome variable <em>Y</em> defined? If not, define it.</li>
<li><strong>Multiple outcomes:</strong> are there multiple outcomes? If yes, explain and define them.</li>
<li><strong>Outcome relevance:</strong> can I explain how the outcome variable/s relate to my question? If not, clarify.</li>
<li><strong>Outcome type:</strong> is my outcome binary and rare? If yes, consider logistic regression. If my outcome is continuous, consider z-transforming it or categorising it (consult an expert).</li>
<li><strong>Outcome timing:</strong> does the outcome appear after the exposure? It should.</li>
</ul>
</section>
<section id="determine-the-exposure" class="level4">
<h4 class="anchored" data-anchor-id="determine-the-exposure">Determine the Exposure</h4>
<ul>
<li><strong>Exposure variable:</strong> is the exposure variable <em>A</em> defined? If not, define it.</li>
<li><strong>Multiple exposures:</strong> are there multiple exposures? If yes, reassess; if only one exposure, proceed.</li>
<li><strong>Exposure relevance:</strong> can I explain how the exposure variable relates to my question? If not, clarify.</li>
<li><strong>Positivity:</strong> can we intervene on the exposure at all levels of the covariates? We should be able to.</li>
<li><strong>Consistency:</strong> can I interpret what it means to intervene on the exposure? I should be able to.</li>
<li><strong>Exchangeability:</strong> are different versions of the exposure conditionally exchangeable given measured baseline confounders? They should be.</li>
<li><strong>Exposure type:</strong> is the exposure binary or continuous?</li>
<li><strong>Shift intervention</strong>: Am I contrasting static interventions or modified treatment policies? (Not relevant for your final report)</li>
<li><strong>Exposure timing:</strong> Does the exposure appear before the outcome? It should.</li>
</ul>
</section>
<section id="account-for-confounders" class="level4">
<h4 class="anchored" data-anchor-id="account-for-confounders">Account for Confounders</h4>
<ul>
<li><strong>Baseline confounders:</strong> Have I defined my baseline confounders <em>L</em>? I should have.</li>
<li><strong>Justification:</strong> Can I explain how the baseline confounders could affect both <em>A</em> and <em>Y</em>? I should be able to.</li>
<li><strong>Timing:</strong> Are the baseline confounders measured before the exposure? They should be.</li>
<li><strong>Inclusion:</strong> Is the baseline measure of the exposure and the baseline outcome included in the set of baseline confounders? They should be.</li>
<li><strong>Sufficiency:</strong> Are the baseline confounders sufficient to ensure balance on the exposure, such that <em>A</em> is independent of <em>Y</em> given <em>L</em>? If not, plan a sensitivity analysis.</li>
<li><strong>Confounder type:</strong> Are the confounders continuous or binary? If so, consider converting them to z-scores. If they are categorical with three or more levels, do not convert them to z-scores.</li>
</ul>
</section>
<section id="draw-a-causal-diagram-with-unmeasured-confounders" class="level4">
<h4 class="anchored" data-anchor-id="draw-a-causal-diagram-with-unmeasured-confounders">Draw a Causal Diagram with Unmeasured Confounders</h4>
<ul>
<li><strong>Unmeasured confounders:</strong> Does previous science suggest the presence of unmeasured confounders? If not, expand your understanding.</li>
<li><strong>Causal diagram:</strong> Have I drawn a causal diagram (DAG) to highlight both measured and unmeasured sources of confounding? I should have.</li>
<li><strong>Measurement error:</strong> Have I described potential biases from measurement errors? If not, we’ll discuss later.</li>
<li><strong>Temporal order:</strong> Does my DAG have time indicators to ensure correct temporal order? It should.</li>
<li><strong>Time consistency:</strong> Is my DAG organized so that time follows in a consistent direction? It should.</li>
</ul>
</section>
<section id="identify-the-estimand" class="level4">
<h4 class="anchored" data-anchor-id="identify-the-estimand">Identify the Estimand</h4>
<ul>
<li>ATE or CATE or both? (For you – it will be both)</li>
</ul>
</section>
<section id="understanding-source-and-target-populations" class="level4">
<h4 class="anchored" data-anchor-id="understanding-source-and-target-populations">Understanding Source and Target Populations</h4>
<ul>
<li><strong>Populations identified:</strong> Have I explained how my sample relates to my target populations? I should have.</li>
<li><strong>Generalisability and transportability:</strong> Have I considered whether my results generalise different populations? I should have.</li>
</ul>
</section>
<section id="set-eligibility-criteria" class="level4">
<h4 class="anchored" data-anchor-id="set-eligibility-criteria">Set Eligibility Criteria</h4>
<ul>
<li><strong>Criteria stated:</strong> Have I stated the eligibility criteria for the study? I should have.</li>
</ul>
</section>
<section id="describe-sample-characteristics" class="level4">
<h4 class="anchored" data-anchor-id="describe-sample-characteristics">Describe Sample Characteristics</h4>
<ul>
<li><strong>Descriptive statistics:</strong> have I provided descriptive statistics for demographic information taken at baseline? I should have.</li>
<li><strong>Exposure change:</strong> Have I demonstrated the magnitudes of change in the exposure from baseline to the exposure interval? I should have.</li>
<li><strong>References:</strong> Have I included references for more information about the sample? I should have.</li>
</ul>
</section>
<section id="addressing-missing-data" class="level4">
<h4 class="anchored" data-anchor-id="addressing-missing-data">Addressing Missing Data</h4>
<ul>
<li><strong>Missing data checks:</strong> Have I checked for missing data? I should have.</li>
<li><strong>Missing data plan:</strong> If there is missing data, have I described how I will address it? I should have.</li>
</ul>
</section>
<section id="selecting-the-model-approach-if-not-using-machine-learning-lecture-7" class="level4">
<h4 class="anchored" data-anchor-id="selecting-the-model-approach-if-not-using-machine-learning-lecture-7">Selecting the Model Approach: If Not Using Machine Learning (Lecture 7)</h4>
<ul>
<li><strong>Approach decision:</strong> Have I decided on using G-computation, IPTW, or Doubly-Robust Estimation? I should have.</li>
<li><strong>Interactions:</strong> If not using machine learning, have I included the interaction of the exposure and baseline covariates? I should have.</li>
<li><strong>Big data:</strong> If I have a large data set, should I include the interaction of the exposure, group, and baseline confounders? I should consider it.</li>
<li><strong>Model specification:</strong> have I double-checked the model specification? I should.</li>
<li><strong>Outcome assessment:</strong> If the outcome is rare and binary, have I specified logistic regression? If it’s continuous, have I considered converting it to z-scores?</li>
<li><strong>Sensitivity analysis:</strong> am I planning a sensitivity analysis using simulation? If yes, describe it (e.g.&nbsp;E-values.)</li>
</ul>
</section>
<section id="machine-learing" class="level4">
<h4 class="anchored" data-anchor-id="machine-learing">Machine Learing</h4>
<p>Have I explained how causal forests work (next week’s lecture).</p>
</section>
<section id="clarify-unmeasured-pre-treatment-covariates" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="clarify-unmeasured-pre-treatment-covariates">Clarify unmeasured pre-treatment covariates</h3>
<p>Let <strong>U</strong> denoted unmeasured pre-treatment covariates that may potentially bias the statistical association between <em>A</em> and <em>Y</em> independently of the measured covariates.</p>
<section id="consider" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="consider">Consider:</h4>
<ul>
<li>To affect <em>Y</em> and <em>A</em>, <em>U</em> must occur before <em>A</em>.</li>
<li>It is useful to draw a causal diagramme to illustrate all potential sources of bias.</li>
<li>Causal diagrammes are qualitative tools that require specialist expertise. We cannot typically obtain a causal graph from the data.</li>
<li>A causal diagramme should include only as much information as is required to assess confounding. See <a href="#fig-dag-outcomewide" class="quarto-xref">Figure&nbsp;1</a> for an example.</li>
<li>Because we cannot ensure the absence of unmeasured confounders in observational settings, it is vital to conduct sensitivity analyses for the results. For sensitivity analyeses, we use E-values.</li>
</ul>
<div class="cell page-columns page-full">
<div class="cell-output-display page-columns page-full">
<div id="fig-dag-outcomewide" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-dag-outcomewide-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="09-content_files/figure-html/fig-dag-outcomewide-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-dag-outcomewide-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Causal graph: three-wave panel design.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="choose-the-scale-for-a-causal-contrast" class="level3">
<h3 class="anchored" data-anchor-id="choose-the-scale-for-a-causal-contrast">Choose the scale for a causal contrast</h3>
<p>Difference/ Risk ratio?</p>
<section id="consider-1" class="level4">
<h4 class="anchored" data-anchor-id="consider-1">Consider:</h4>
<ul>
<li><em>In this course, we are interested in stratum specific comparisons</em></li>
<li>In the causal inference literature, the concept we use to make sense of stratum specific comparisons is called “effect modification.”</li>
<li>By inferring effects within strata, we may evaluate whether the effects of different exposures or treatments on some well-defined outcome (measured in some well-defined time-period after the exposure) differ depending on group measurement.</li>
<li>The logic of effect modification differs slightly from that of interaction.</li>
</ul>
</section>
<section id="aside-extensions" class="level4">
<h4 class="anchored" data-anchor-id="aside-extensions">Aside: extensions</h4>
<p>For continuous exposures, we must stipulate the level of contrast for the exposure (e.g.&nbsp;weekly versus monthly church attendance):</p>
<p><span class="math display">ATE_{A,A'} = E[Y(A) - Y(A')| L]</span></p>
<p>This essentially denotes an average treatment effect comparing the outcome under treatment level <span class="math inline">A</span> to the outcome under treatment level <span class="math inline">A'</span>.</p>
<p>Likewise:</p>
<p><span class="math display">ATE_{A/A'} = \frac{E[Y(A)| L]}{E[Y(A')| L]}</span></p>
<p>This defines the contrast of <span class="math inline">A</span> and <span class="math inline">A'</span> on a ratio scale.</p>
</section>
<section id="describe-the-populations-for-whom-the-intended-study-is-meant-to-generalise-by-distinguishing-between-source-and-target-populations." class="level4">
<h4 class="anchored" data-anchor-id="describe-the-populations-for-whom-the-intended-study-is-meant-to-generalise-by-distinguishing-between-source-and-target-populations.">Describe the population(s) for whom the intended study is meant to generalise by distinguishing between source and target populations.</h4>
<p>Consider the following concepts:</p>
<ul>
<li><p><strong>Source population</strong>: a source population is where we gather our data for a study. We pull our specific sample from this group. It needs to mirror the broader group for our conclusions to be valid and widely applicable.</p></li>
<li><p><strong>Target population</strong>: the target population is the larger group we aim to apply our study’s results to. It could be defined by location, demographics, or specific conditions. The closer the source matches the target in ways that are relevant to our causal questions, the stronger our causal inferences about the target population will be.</p>
<ul>
<li><strong>Generalisability</strong> refers to the ability to apply the causal effects estimated from a sample to the population it was drawn from. In simpler terms, it deals with the extrapolation of causal knowledge from a sample to the broader population. This concept is also called “external validity”.</li>
</ul></li>
</ul>
<p><span class="math display">\text{Generalisability} = PATE \approx ATE_{\text{sample}}</span></p>
<ul>
<li><strong>Transportability</strong> refers to the ability to extrapolate causal effects learned from a source population to a target population when certain conditions are met. It deals with the transfer of causal knowledge across different settings or populations.</li>
</ul>
<p><span class="math display">\text{Transportability} = ATE_{\text{target}} \approx f(ATE_{\text{source}}, T)</span></p>
<p>where <span class="math inline">f</span> is a function and <span class="math inline">T</span> is a function that maps the results from our source population to another population. To achieve transportability, we need information about the source and target populations and an understanding of how the relationships between treatment, outcome, and covariates differ between the populations. Assessing transportability requires scientific knowledge.</p>
</section>
</section>
<section id="summary-step-1-consider-how-much-we-need-to-do-when-asking-a-causal-question" class="level3">
<h3 class="anchored" data-anchor-id="summary-step-1-consider-how-much-we-need-to-do-when-asking-a-causal-question">Summary Step 1: Consider how much we need to do when asking a causal question!</h3>
<p>We discover that asking a causal question is a multifaceted task. It demands careful definition of the outcome, including its timing, the exposure, and covariates. It also requires selecting the appropriate scale for causal contrast, controlling for confounding, and potentially adjusting for sample weights or stratification. Finally, when asking a causal question, we must consider for whom the results apply. Only after following these steps can we then ask: “How may we answer this causal question?”</p>
</section>
</section>
<section id="step-2-answer-your-question" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="step-2-answer-your-question">STEP 2: Answer Your Question</h2>
<section id="obtain-longitudinal-data" class="level4">
<h4 class="anchored" data-anchor-id="obtain-longitudinal-data">Obtain longitudinal data</h4>
<p>Note that causal inference from observational data turns on the appropriate temporal ordering of the key variables involved in the study.</p>
<p>Recall we have defined.</p>
<ul>
<li><p><strong>A</strong>: Our exposure or treatment variable, denoted as <strong>A</strong>. Here we consider the example of ‘Church attendance’.</p></li>
<li><p><strong>Y</strong>: The outcome variable we are interested in, represented by <strong>Y</strong>, is psychological distress. We operationalise this variable through the ‘Kessler-6’ distress scale.</p></li>
<li><p><strong>L</strong>: The confounding variables, collectively referred to as <strong>L</strong>, represent factors that can independently influence both <strong>A</strong> and <strong>Y</strong>. For example, socio-economic status could be a confounder that impacts both the likelihood of church attendance and the levels of psychological distress.</p></li>
</ul>
<p>Given the importance of temporal ordering, we must now define time:</p>
<ul>
<li><strong>t</strong> <span class="math inline">\in</span> T: Let <span class="math inline">t</span> denote within a multiwave panel study with <strong>T</strong> measurement intervals.</li>
</ul>
<p>Where <span class="math inline">t/\text{{exposure}}</span> denotes the measurement interval for the exposure. Longitudinal data collection provides us the ability to establish a causal model such that:</p>
<p><span class="math display">t_{confounders} &lt; t_{exposure}&lt; t_{outcome}</span></p>
<p>To minimise the posibility of time-varying confounding and obtain the clearest effect estimates, we should acquire the most recent values of <span class="math inline">\mathbf{L}</span> preceding <span class="math inline">A</span> and the latest values of <span class="math inline">A</span> before <span class="math inline">Y</span>.</p>
<p>Note in <a href="#fig-dag-outcomewide" class="quarto-xref">Figure&nbsp;1</a>, We use the prefixes “t0, t1, and t2” to denote temporal ordering. We include in the set of baseline confounders the pre-exposure measurement of <em>A</em> and <em>Y</em>. This allows for more substantial confounding control. For unmeasured confounder to affect both the exposure and the outcome, it would need to do so independently of the pre-exposure confounders. Additionally, including the baseline exposure gives us an effect estimate for the incidence exposure, rather than the prevelance of the exposure. This helps us to assess the expected change in the outcome were we to initate a change in the exposure.</p>
</section>
<section id="include-the-measured-exposure-with-baseline-covariates" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="include-the-measured-exposure-with-baseline-covariates">Include the measured exposure with baseline covariates</h3>
<p>Controlling for prior exposure enables the interpretation of the effect estimate as a change in the exposure in a manner akin to a randomised trial. We propose that the effect estimate with prior control for the exposure estimates the “incidence exposure” rather than the “prevalence exposure” <span class="citation" data-cites="danaei2012">(<a href="#ref-danaei2012" role="doc-biblioref">Danaei, Tavakkoli, and Hernán 2012</a>)</span>. It is crucial to estimate the incidence exposure because if the effects of an exposure are harmful in the short term such that these effects are not subsequently measured, a failure to adjust for prior exposure will yield the illusion that the exposure is beneficial. Furthermore, this approach aids in controlling for unmeasured confounding. For such a confounder to explain away the observed exposure-outcome association, it would need to do so independently of the prior level of the exposure and outcome.</p>
<div class="no-row-height column-margin column-container"><div id="ref-danaei2012" class="csl-entry" role="listitem">
Danaei, Goodarz, Mohammad Tavakkoli, and Miguel A. Hernán. 2012. <span>“Bias in observational studies of prevalent users: lessons for comparative effectiveness research from a meta-analysis of statins.”</span> <em>American Journal of Epidemiology</em> 175 (4): 250–62. <a href="https://doi.org/10.1093/aje/kwr301">https://doi.org/10.1093/aje/kwr301</a>.
</div></div></section>
<section id="state-the-eligibility-criteria-for-participation" class="level3">
<h3 class="anchored" data-anchor-id="state-the-eligibility-criteria-for-participation">State the eligibility criteria for participation</h3>
<p>This step is invaluable for assessing whether we are answering the causal question that we have asked.</p>
<section id="consider-2" class="level4">
<h4 class="anchored" data-anchor-id="consider-2">Consider:</h4>
<ul>
<li>Generalisability: we cannot evaluate inferences to a target group from the source population if we do not describe the source population</li>
<li>Eligibility criteria will help us to ensure whether we have correctly evaluated potential measurement bias/error in our instruments.</li>
</ul>
<p>For example, the New Zealand Attitudes and Values Study is a National Probability study of New Zealanders. The details provided in the supplementary materials describe how individuals were randomly selected from the country’s electoral roll. From these invitations there was typically less than 15% response rate. How might this process of recruitment affect generalisability and transportability of our results?</p>
<ul>
<li>Aside: discuss per protocol effects/ intention to treat effects</li>
</ul>
</section>
</section>
<section id="determine-how-missing-data-will-be-handled" class="level3">
<h3 class="anchored" data-anchor-id="determine-how-missing-data-will-be-handled">Determine how missing data will be handled</h3>
<ul>
<li>As we will consider in the upcoming weeks, loss to follow up and non-response opens sources for bias. We must develop a strategy for handling missing data.</li>
</ul>
</section>
<section id="state-a-statistical-model" class="level3">
<h3 class="anchored" data-anchor-id="state-a-statistical-model">State a statistical model</h3>
<p>The models we have considered in this course are G-computation, Inverse Probability of Treatement Weighting, and Doubly-Robust estimation.</p>
</section>
<section id="reporting" class="level3">
<h3 class="anchored" data-anchor-id="reporting">Reporting</h3>
<p>Consider the following ideas about how to report one’s model:</p>
<ul>
<li><strong>Estimator</strong>: Doubly robust where possible.</li>
<li><strong>Propensity Score Reporting:</strong> Detail the process of propensity score derivation, including the model used and any variable transformations.</li>
<li><strong>WeightIt Package:</strong> Explicitly mention the use of the ‘WeightIt’ package in R, including any specific options or parameters used in the propensity score estimation process.</li>
<li><strong>Method Variations:</strong> Report if different methods were used to obtain propensity scores, and the reasons behind the choice of methods such as ‘ebal’, ‘energy’, and ‘ps’.</li>
<li><strong>Continuous Exposures:</strong> Highlight that for continuous exposures, only the ‘energy’ option was used for propensity score estimation. (not relevant for your report)</li>
<li><strong>Binary Exposure</strong> Justify your cutpoints by referencing theory/existing knowledge <em>in advance</em> of conducting the analysis.</li>
<li><strong>Subgroup Estimation:</strong> Confirm that the propensity scores for subgroups were estimated separately, and discuss how the weights were subsequently combined with the original data.</li>
<li><strong>Covariate Balance:</strong> Include a Love plot to visually represent covariate balance on the exposure both before and after weighting.</li>
<li><strong>Weighting Algorithm Statistics:</strong> Report the statistics for the weighting algorithms as provided by the WeightIt package, including any measures of balance or fit.</li>
<li><strong>Outcome Regression Model:</strong> Clearly report the type of regression model used to estimate outcome model coefficients (e.g., linear regression, Poisson, binomial), and mention if the exposure was interacted with the baseline covariates. Do not report model coefficients as these have no interpretation.</li>
<li><strong>Subgroup Interaction:</strong> Address whether the subgroup was included separately as an interaction in the outcome model, and if the model successfully converged.</li>
<li><strong>Machine Learning Using <code>lmtp</code></strong> If using the <code>lmtp</code> package, do a stratified analysis. (see today’s lab)</li>
<li><strong>Model coefficients:</strong> note that the model coefficients should not be interpreted, as they are not meaningful in this context.</li>
<li><strong>Confidence intervals and standard errors:</strong> Describe the methods used to derive confidence intervals and standard errors, noting the use of the ‘clarify’ package in R for simulation based inference.</li>
</ul>
</section>
<section id="example-of-how-to-report-a-doubly-robust-method-in-your-report" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="example-of-how-to-report-a-doubly-robust-method-in-your-report">Example of how to report a doubly robust method in your report</h3>
<p>The Doubly Robust Estimation method for Subgroup Analysis Estimator is a sophisticated tool combining features of both IPTW and G-computation methods, providing unbiased estimates if either the propensity score or outcome model is correctly specified. The process involves five main steps:</p>
<p><strong>Step 1</strong> involves the estimation of the propensity score, a measure of the conditional probability of exposure given the covariates and the subgroup indicator. This score is calculated using statistical models such as logistic regression, with the model choice depending on the nature of the data and exposure. Weights for each individual are then calculated using this propensity score. These weights depend on the exposure status and are computed differently for exposed and unexposed individuals. The estimation of propensity scores is performed separately within each subgroup stratum.</p>
<p><strong>Step 2</strong> focuses on fitting a weighted outcome model, making use of the previously calculated weights from the propensity scores. This model estimates the outcome conditional on exposure, covariates, and subgroup, integrating the weights into the estimation process. Unlike in propensity score model estimation, covariates are included as variables in the outcome model. This inclusion makes the method doubly robust - providing a consistent effect estimate if either the propensity score or the outcome model is correctly specified, thereby reducing the assumption of correct model specification.</p>
<p><strong>Step 3</strong> entails the simulation of potential outcomes for each individual in each subgroup. These hypothetical scenarios assume universal exposure to the intervention within each subgroup, regardless of actual exposure levels. The expectation of potential outcomes is calculated for each individual in each subgroup, using individual-specific weights. These scenarios are performed for both the current and alternative interventions.</p>
<p><strong>Step 4</strong> is the estimation of the average causal effect for each subgroup, achieved by comparing the computed expected values of potential outcomes under each intervention level. The difference represents the average causal effect of changing the exposure within each subgroup.</p>
<p><strong>Step 5</strong> involves comparing differences in causal effects across groups by calculating the differences in the estimated causal effects between different subgroups. Confidence intervals and standard errors for these calculations are determined using simulation-based inference methods <span class="citation" data-cites="greifer2023">(<a href="#ref-greifer2023" role="doc-biblioref">Greifer et al. 2023</a>)</span>. This step allows for a comprehensive comparison of the impact of different interventions across various subgroups, while encorporating uncertainty.</p>
<div class="no-row-height column-margin column-container"></div></section>
<section id="inference" class="level3">
<h3 class="anchored" data-anchor-id="inference">Inference</h3>
<p>Consider the following ideas about what to discuss in one’s findings: Consider the following ideas about what to discuss in one’s findings. The order of exposition might be different.</p>
<ol type="1">
<li><p><strong>Summary of results</strong>: What did you find?</p></li>
<li><p><strong>Interpretation of E-values:</strong> Interpret the E-values used for sensitivity analysis. State what they represent in terms of the robustness of the findings to potential unmeasured confounding.</p></li>
<li><p><strong>Causal Effect Interpretation:</strong> What is the interest of the effect, if any, if an effect was observed? Interpret the average causal effect of changing the exposure level within each subgroup, and discuss its relevance to the research question.</p></li>
<li><p><strong>Comparison of Subgroups:</strong> Discuss how differences in causal effect estimates between different subgroups, if observed, or if not observed, contribute to the overall findings of the study.</p></li>
<li><p><strong>Uncertainty and Confidence Intervals:</strong> Consider the uncertainty around the estimated causal effects, and interpret the confidence intervals to understand the precision of the estimates.</p></li>
<li><p><strong>Generalisability and Transportability:</strong> Reflect on the generalizability of the study results to other contexts or populations. Discuss any factors that might influence the transportability of the causal effects found in the study. (Again see lecture 9.)</p></li>
<li><p><strong>Assumptions and Limitations:</strong> Reflect on the assumptions made during the study and identify any limitations in the methodology that could affect the interpretation of results. State that the implications of different intervention levels on potential outcomes are not analysed.</p></li>
<li><p><strong>Theoretical Relevance</strong>: How are these findings relevant to existing theories.</p></li>
<li><p><strong>Replication and Future Research:</strong> Consider how the study could be replicated or expanded upon in future research, and how the findings contribute to the existing body of knowledge in the field.</p></li>
<li><p><strong>Real-world Implications:</strong> Discuss the real-world implications of the findings, and how they could be applied in policy, practice, or further research.</p></li>
</ol>
</section>
</section>
<section id="appendix-a-details-of-estimation-approaches" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="appendix-a-details-of-estimation-approaches">Appendix A: Details of Estimation Approaches</h2>
<section id="g-computation-for-subgroup-analysis-estimator" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="g-computation-for-subgroup-analysis-estimator">G-computation for Subgroup Analysis Estimator</h3>
<p><strong>Step 1:</strong> Estimate the outcome model. Fit a model for the outcome <span class="math inline">Y</span>, conditional on the exposure <span class="math inline">A</span>, the covariates <span class="math inline">L</span>, and subgroup indicator <span class="math inline">G</span>. This model can be a linear regression, logistic regression, or another statistical model. The goal is to capture the relationship between the outcome, exposure, confounders, and subgroups.</p>
<p><span class="math display"> \hat{E}(Y|A,L,G) = f_Y(A,L,G; \theta_Y) </span></p>
<p>This equation represents the expected value of the outcome <span class="math inline">Y</span> given the exposure <span class="math inline">A</span>, covariates <span class="math inline">L</span>, and subgroup <span class="math inline">G</span>, as modelled by the function <span class="math inline">f_Y</span> with parameters <span class="math inline">\theta_Y</span>. This formulation allows for the prediction of the average outcome <span class="math inline">Y</span> given certain values of <span class="math inline">A</span>, <span class="math inline">L</span>, and <span class="math inline">G</span>.</p>
<p><strong>Step 2:</strong> Simulate potential outcomes. For each individual in each subgroup, predict their potential outcome under the intervention <span class="math inline">A=a</span> using the estimated outcome model:</p>
<p><span class="math display">\hat{E}(Y(a)|G=g) = \hat{E}[Y|A=a,L,G=g; \hat{\theta}_Y]</span></p>
<p>We also predict the potential outcome for everyone in each subgroup under the causal contrast, setting the intervention for everyone in that group to <span class="math inline">A=a'</span>:</p>
<p><span class="math display">\hat{E}(Y(a')|G=g) = \hat{E}[Y|A=a',L,G=g; \hat{\theta}_Y]</span></p>
<p>In these equations, <span class="math inline">Y</span> represents the potential outcome, <span class="math inline">A</span> is the intervention, <span class="math inline">L</span> are the covariates, <span class="math inline">G=g</span> represents the subgroup, and <span class="math inline">\theta_Y</span> are the parameters of the outcome model.</p>
<p><strong>Step 3:</strong> Calculate the estimated difference for each subgroup <span class="math inline">g</span>:</p>
<p><span class="math display">\hat{\delta}_g = \hat{E}[Y(a)|G=g] - \hat{E}[Y(a')|G=g]</span></p>
<p>This difference <span class="math inline">\hat{\delta}_g</span> represents the average causal effect of changing the exposure from level <span class="math inline">a'</span> to level <span class="math inline">a</span> within each subgroup <span class="math inline">g</span>.</p>
<p>We use simulation-based inference methods to compute standard errors and confidence intervals <span class="citation" data-cites="greifer2023">(<a href="#ref-greifer2023" role="doc-biblioref">Greifer et al. 2023</a>)</span>.</p>
<div class="no-row-height column-margin column-container"></div><p><strong>Step 4:</strong> Compare differences in causal effects by subgroups:</p>
<p><span class="math display">\hat{\gamma} = \hat{\delta}_g - \hat{\delta}_{g'}</span></p>
<p>where,</p>
<p><span class="math display">\hat{\gamma} = \overbrace{\big( \hat{E}[Y(a)|G=g] - \hat{E}[Y(a^{\prime})|G=g] \big)}^{\hat{\delta_g}} - \overbrace{\big(\hat{E}[Y(a^{\prime})|G=g^{\prime}]- \hat{E}[Y(a)|G=g^{\prime}]\big)}^{\hat{\delta_{g^{\prime}}}}</span></p>
<p>This difference <span class="math inline">\hat{\gamma}</span> represents the difference in the average causal effects between the subgroups <span class="math inline">g</span> and <span class="math inline">g'</span>. It measures the difference in effect of the exposure <span class="math inline">A</span> within subgroup <span class="math inline">G</span> on the outcome <span class="math inline">Y</span>.</p>
<p><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;<span class="math inline">A</span> and <span class="math inline">G</span> on <span class="math inline">Y</span> might not be additive. We assume that the potential confounders <span class="math inline">L</span> are sufficient to control for confounding. See Appendix</p></div></div><p>We again use simulation-based inference methods to compute standard errors and confidence intervals <span class="citation" data-cites="greifer2023">(<a href="#ref-greifer2023" role="doc-biblioref">Greifer et al. 2023</a>)</span>.</p>
</section>
<section id="inverse-probability-of-treatment-weighting-iptw-for-subgroup-analysis-estimator" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="inverse-probability-of-treatment-weighting-iptw-for-subgroup-analysis-estimator">Inverse Probability of Treatment Weighting (IPTW) for Subgroup Analysis Estimator</h3>
<p><strong>Step 1:</strong> Estimate the propensity score. The propensity score <span class="math inline">e(L, G)</span> is the conditional probability of the exposure <span class="math inline">A = 1</span>, given the covariates <span class="math inline">L</span> and subgroup indicator <span class="math inline">G</span>. This can be modeled using logistic regression or other suitable methods, depending on the nature of the data and the exposure.</p>
<p><span class="math display">\hat{e} = P(A = 1 | L, G) = f_A(L, G; \theta_A)</span></p>
<p>Here, <span class="math inline">f_A(L, G; \theta_A)</span> is a function (statistical model) that estimates the probability of the exposure <span class="math inline">A = 1</span> given covariates <span class="math inline">L</span> and subgroup <span class="math inline">G</span>. Then, we calculate the weights for each individual, denoted as <span class="math inline">v</span>, using the estimated propensity score:</p>
<p><span class="math display">
v =
\begin{cases}
\frac{1}{\hat{e}} &amp; \text{if } A = 1 \\
\frac{1}{1-\hat{e}} &amp; \text{if } A = 0
\end{cases}
</span></p>
<p><strong>Step 2:</strong> Fit a weighted outcome model. Using the weights calculated from the estimated propensity scores, fit a model for the outcome <span class="math inline">Y</span>, conditional on the exposure <span class="math inline">A</span> and subgroup <span class="math inline">G</span>. This can be represented as:</p>
<p><span class="math display"> \hat{E}(Y|A, G; V) = f_Y(A, G ; \theta_Y, V) </span></p>
<p>In this model, <span class="math inline">f_Y</span> is a function (such as a weighted regression model) with parameters <span class="math inline">θ_Y</span>.</p>
<p><strong>Step 3:</strong> Simulate potential outcomes. For each individual in each subgroup, simulate their potential outcome under the hypothetical scenario where everyone in the subgroup is exposed to the intervention <span class="math inline">A=a</span> regardless of their actual exposure level:</p>
<p><span class="math display">\hat{E}(Y(a)|G=g) = \hat{E}[Y|A=a,G=g; \hat{\theta}_Y, v]</span></p>
<p>And also under the hypothetical scenario where everyone is exposed to intervention <span class="math inline">A=a'</span>:</p>
<p><span class="math display">\hat{E}(Y(a')|G=g) = \hat{E}[Y|A=a',G=g; \hat{\theta}_Y, v]</span></p>
<p><strong>Step 4:</strong> Estimate the average causal effect for each subgroup as the difference in the predicted outcomes:</p>
<p><span class="math display">\hat{\delta}_g = \hat{E}[Y(a)|G=g] - \hat{E}[Y(a')|G=g]</span></p>
<p>The estimated difference <span class="math inline">\hat{\delta}_g</span> represents the average causal effect within group <span class="math inline">g</span>.</p>
<p><strong>Step 5:</strong> Compare differences in causal effects by groups. Compute the differences in the estimated causal effects between different subgroups:</p>
<p><span class="math display">\hat{\gamma} = \hat{\delta}_g - \hat{\delta}_{g'}</span></p>
<p>where,</p>
<p><span class="math display">\hat{\gamma} = \overbrace{\big( \hat{E}[Y(a)|G=g] - \hat{E}[Y(a')|G=g] \big)}^{\hat{\delta_g}} - \overbrace{\big(\hat{E}[Y(a')|G=g']- \hat{E}[Y(a)|G=g']\big)}^{\hat{\delta_{g'}}}</span></p>
<p>This <span class="math inline">\hat{\gamma}</span> represents the difference in the average causal effects between the subgroups <span class="math inline">g</span> and <span class="math inline">g'</span>.</p>
<p>We again use simulation-based inference methods to compute standard errors and confidence intervals <span class="citation" data-cites="greifer2023">(<a href="#ref-greifer2023" role="doc-biblioref">Greifer et al. 2023</a>)</span>.</p>
<div class="no-row-height column-margin column-container"></div></section>
<section id="doubly-robust-estimation-for-subgroup-analysis-estimator" class="level3">
<h3 class="anchored" data-anchor-id="doubly-robust-estimation-for-subgroup-analysis-estimator">Doubly Robust Estimation for Subgroup Analysis Estimator</h3>
<p>It appears that the Doubly Robust Estimation explanation for subgroup analysis is already clear and correct, covering all the necessary steps in the process. Nevertheless, there’s a slight confusion in step 4. The difference <span class="math inline">\delta_g</span> is not defined within the document. I assume that you intended to write <span class="math inline">\hat{\delta}_g</span>. Here’s the corrected version:</p>
</section>
<section id="doubly-robust-estimation-for-subgroup-analysis-estimator-1" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="doubly-robust-estimation-for-subgroup-analysis-estimator-1">Doubly Robust Estimation for Subgroup Analysis Estimator</h3>
<p>Doubly Robust Estimation is a powerful technique that combines the strengths of both the IPTW and G-computation methods. It uses both the propensity score model and the outcome model, which makes it doubly robust: it produces unbiased estimates if either one of the models is correctly specified.</p>
<p><strong>Step 1</strong> Estimate the propensity score. The propensity score <span class="math inline">\hat{e}(L, G)</span> is the conditional probability of the exposure <span class="math inline">A = 1</span>, given the covariates <span class="math inline">L</span> and subgroup indicator <span class="math inline">G</span>. This can be modeled using logistic regression or other suitable methods, depending on the nature of the data and the exposure.</p>
<p><span class="math display">\hat{e} = P(A = 1 | L, G) = f_A(L, G; \theta_A)</span></p>
<p>Here, <span class="math inline">f_A(L, G; \theta_A)</span> is a function (statistical model) that estimates the probability of the exposure <span class="math inline">A = 1</span> given covariates <span class="math inline">L</span> and subgroup <span class="math inline">G</span>. Then, we calculate the weights for each individual, denoted as <span class="math inline">v</span>, using the estimated propensity score:</p>
<p><span class="math display">
v =
\begin{cases}
\frac{1}{\hat{e}} &amp; \text{if } A = 1 \\
\frac{1}{1-\hat{e}} &amp; \text{if } A = 0
\end{cases}
</span></p>
<p><strong>Step 2</strong> Fit a weighted outcome model. Using the weights calculated from the estimated propensity scores, fit a model for the outcome <span class="math inline">Y</span>, conditional on the exposure <span class="math inline">A</span>, covariates <span class="math inline">L</span>, and subgroup <span class="math inline">G</span>.</p>
<p><span class="math display"> \hat{E}(Y|A, L, G; V) = f_Y(A, L, G ; \theta_Y, V) </span></p>
<p><strong>Step 3</strong> For each individual in each subgroup, simulate their potential outcome under the hypothetical scenario where everyone in the subgroup is exposed to the intervention <span class="math inline">A=a</span> regardless of their actual exposure level:</p>
<p><span class="math display">\hat{E}(Y(a)|G=g) = \hat{E}[Y|A=a,G=g; L,\hat{\theta}_Y, v]</span></p>
<p>And also under the hypothetical scenario where everyone in each subgroup is exposed to intervention <span class="math inline">A=a'</span>:</p>
<p><span class="math display">\hat{E}(Y(a')|G=g) = \hat{E}[Y|A=a',G=g; L; \hat{\theta}_Y, v]</span></p>
<p><strong>Step 4</strong> Estimate the average causal effect for each subgroup. Compute the estimated expected value of the potential outcomes under each intervention level for each subgroup:</p>
<p><span class="math display">\hat{\delta}_g = \hat{E}[Y(a)|G=g] - \hat{E}[Y(a')|G=g]</span></p>
<p>The estimated difference <span class="math inline">\hat{\delta}_g</span> represents the average causal effect of changing the exposure from level <span class="math inline">a'</span> to level <span class="math inline">a</span> within each subgroup.</p>
<p><strong>Step 5</strong> Compare differences in causal effects by groups. Compute the differences in the estimated causal effects between different subgroups:</p>
<p><span class="math display">\hat{\gamma} = \hat{\delta}_g - \hat{\delta}_{g'}</span></p>
<p>where,</p>
<p><span class="math display">\hat{\gamma} = \overbrace{\big( \hat{E}[Y(a)|G=g] - \hat{E}[Y(a')|G=g] \big)}^{\hat{\delta_g}} - \overbrace{\big(\hat{E}[Y(a')|G=g']- \hat{E}[Y(a)|G=g']\big)}^{\hat{\delta_{g'}}}</span></p>
<p>We again use simulation-based inference methods to compute standard errors and confidence intervals <span class="citation" data-cites="greifer2023">(<a href="#ref-greifer2023" role="doc-biblioref">Greifer et al. 2023</a>)</span>.</p>
<div class="no-row-height column-margin column-container"></div></section>
</section>
<section id="appendix-b-g-computation-for-subgroup-analysis-estimator-with-non-additive-effects" class="level2">
<h2 class="anchored" data-anchor-id="appendix-b-g-computation-for-subgroup-analysis-estimator-with-non-additive-effects">Appendix B: G-computation for Subgroup Analysis Estimator with Non-Additive Effects</h2>
<p><strong>Step 1:</strong> Estimate the outcome model. Fit a model for the outcome <span class="math inline">Y</span>, conditional on the exposure <span class="math inline">A</span>, the covariates <span class="math inline">L</span>, subgroup indicator <span class="math inline">G</span>, and interactions between <span class="math inline">A</span> and <span class="math inline">G</span>. This model can be a linear regression, logistic regression, or another statistical model. The goal is to capture the relationship between the outcome, exposure, confounders, subgroups, and their interactions.</p>
<p><span class="math display"> \hat{E}(Y|A,L,G,AG) = f_Y(A,L,G,AG; \theta_Y) </span></p>
<p>This equation represents the expected value of the outcome <span class="math inline">Y</span> given the exposure <span class="math inline">A</span>, covariates <span class="math inline">L</span>, subgroup <span class="math inline">G</span>, and interaction term <span class="math inline">AG</span>, as modeled by the function <span class="math inline">f_Y</span> with parameters <span class="math inline">\theta_Y</span>.</p>
<p><strong>Step 2:</strong> Simulate potential outcomes. For each individual in each subgroup, predict their potential outcome under the intervention <span class="math inline">A=a</span> using the estimated outcome model:</p>
<p><span class="math display">\hat{E}(Y(a)|G=g) = \hat{E}[Y|A=a,L,G=g,AG=ag; \hat{\theta}_Y]</span></p>
<p>We also predict the potential outcome for everyone in each subgroup under the causal contrast, setting the intervention for everyone in that group to <span class="math inline">A=a'</span>:</p>
<p><span class="math display">\hat{E}(Y(a')|G=g) = \hat{E}[Y|A=a',L,G=g,AG=a'g; \hat{\theta}_Y]</span></p>
<p><strong>Step 3:</strong> Calculate the estimated difference for each subgroup <span class="math inline">g</span>:</p>
<p><span class="math display">\hat{\delta}_g = \hat{E}[Y(a)|G=g] - \hat{E}[Y(a')|G=g]</span></p>
<p><strong>Step 4:</strong> Compare differences in causal effects by subgroups:</p>
<p><span class="math display">\hat{\gamma} = \hat{\delta}_g - \hat{\delta}_{g'}</span></p>
<p>where,</p>
<p><span class="math display">\hat{\gamma} = \overbrace{\big( \hat{E}[Y(a)|G=g] - \hat{E}[Y(a^{\prime})|G=g] \big)}^{\hat{\delta_g}} - \overbrace{\big(\hat{E}[Y(a^{\prime})|G=g^{\prime}]- \hat{E}[Y(a)|G=g^{\prime}]\big)}^{\hat{\delta_{g^{\prime}}}}</span></p>
<p>This difference <span class="math inline">\hat{\gamma}</span> represents the difference in the average causal effects between the subgroups <span class="math inline">g</span> and <span class="math inline">g'</span>, taking into account the interaction effect of the exposure <span class="math inline">A</span> and the subgroup <span class="math inline">G</span> on the outcome <span class="math inline">Y</span>.</p>
<p>Note that the interaction term <span class="math inline">AG</span> (or <span class="math inline">ag</span> and <span class="math inline">a'g</span> in the potential outcomes) stands for the interaction between the exposure level and the subgroup. This term is necessary to accommodate the non-additive effects in the model. As before, we must ensure that potential confounders <span class="math inline">L</span> are sufficient to control for confounding.</p>
</section>
<section id="appendix-c-doubly-robust-estimation-for-subgroup-analysis-estimator-with-interaction" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="appendix-c-doubly-robust-estimation-for-subgroup-analysis-estimator-with-interaction">Appendix C: Doubly Robust Estimation for Subgroup Analysis Estimator with Interaction</h2>
<p>Again, Doubly Robust Estimation combines the strengths of both the IPTW and G-computation methods. It uses both the propensity score model and the outcome model, which makes it doubly robust: it produces unbiased estimates if either one of the models is correctly specified.</p>
<p><strong>Step 1</strong> Estimate the propensity score. The propensity score <span class="math inline">e(L, G)</span> is the conditional probability of the exposure <span class="math inline">A = 1</span>, given the covariates <span class="math inline">L</span> and subgroup indicator <span class="math inline">G</span>. This can be modeled using logistic regression or other suitable methods, depending on the nature of the data and the exposure.</p>
<p><span class="math display">e = P(A = 1 | L, G) = f_A(L, G; \theta_A)</span></p>
<p>Here, <span class="math inline">f_A(L, G; \theta_A)</span> is a function (statistical model) that estimates the probability of the exposure <span class="math inline">A = 1</span> given covariates <span class="math inline">L</span> and subgroup <span class="math inline">G</span>. Then, we calculate the weights for each individual, denoted as <span class="math inline">v</span>, using the estimated propensity score:</p>
<p><span class="math display">
v =
\begin{cases}
\frac{1}{\hat{e}} &amp; \text{if } A = 1 \\
\frac{1}{1-\hat{e}} &amp; \text{if } A = 0
\end{cases}
</span></p>
<p><strong>Step 2</strong> Fit a weighted outcome model. Using the weights calculated from the estimated propensity scores, fit a model for the outcome <span class="math inline">Y</span>, conditional on the exposure <span class="math inline">A</span>, covariates <span class="math inline">L</span>, subgroup <span class="math inline">G</span> and the interaction between <span class="math inline">A</span> and <span class="math inline">G</span>.</p>
<p><span class="math display"> \hat{E}(Y|A, L, G, AG; V) = f_Y(A, L, G, AG ; \theta_Y, V) </span></p>
<p><strong>Step 3</strong> For each individual in each subgroup, simulate their potential outcome under the hypothetical scenario where everyone in the subgroup is exposed to the intervention <span class="math inline">A=a</span> regardless of their actual exposure level:</p>
<p><span class="math display">\hat{E}(Y(a)|G=g) = \hat{E}[Y|A=a,G=g, AG=ag; L,\hat{\theta}_Y, v]</span></p>
<p>And also under the hypothetical scenario where everyone in each subgroup is exposed to intervention <span class="math inline">A=a'</span>:</p>
<p><span class="math display">\hat{E}(Y(a')|G=g) = \hat{E}[Y|A=a',G=g, AG=a'g; L; \hat{\theta}_Y, v]</span></p>
<p><strong>Step 4</strong> Estimate the average causal effect for each subgroup. Compute the estimated expected value of the potential outcomes under each intervention level for each subgroup:</p>
<p><span class="math display">\hat{\delta}_g = \hat{E}[Y(a)|G=g] - \hat{E}[Y(a')|G=g]</span></p>
<p>The estimated difference <span class="math inline">\hat{\delta}_g</span> represents the average causal effect of changing the exposure from level <span class="math inline">a'</span> to level <span class="math inline">a</span> within each subgroup.</p>
<p><strong>Step 5</strong> Compare differences in causal effects by groups. Compute the differences in the estimated causal effects between different subgroups:</p>
<p><span class="math display">\hat{\gamma} = \hat{\delta}_g - \hat{\delta}_{g'}</span></p>
<p>where,</p>
<p><span class="math display">\hat{\gamma} = \overbrace{\big( \hat{E}[Y(a)|G=g] - \hat{E}[Y(a')|G=g] \big)}^{\hat{\delta_g}} - \overbrace{\big(\hat{E}[Y(a')|G=g']- \hat{E}[Y(a)|G=g']\big)}^{\hat{\delta_{g'}}}</span></p>
<p>We again use simulation-based inference methods to compute standard errors and confidence intervals <span class="citation" data-cites="greifer2023">(<a href="#ref-greifer2023" role="doc-biblioref">Greifer et al. 2023</a>)</span>.</p>
<div class="no-row-height column-margin column-container"></div></section>
<section id="appendix-d-marginal-structural-models-for-estimating-population-average-treatment-effect-with-interaction-doubly-robust" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="appendix-d-marginal-structural-models-for-estimating-population-average-treatment-effect-with-interaction-doubly-robust">Appendix D: Marginal Structural Models for Estimating Population Average Treatment Effect with Interaction (Doubly Robust)</h2>
<p>Sometimes we will only wish to estimate a marginal effect. In that case.</p>
<p><strong>Step 1</strong> Estimate the propensity score. The propensity score <span class="math inline">e(L)</span> is the conditional probability of the exposure <span class="math inline">A = 1</span>, given the covariates <span class="math inline">L</span> which contains the subgroup <span class="math inline">G</span>. This can be modelled using logistic regression or other functions as described in <span class="citation" data-cites="greifer2023">Greifer et al. (<a href="#ref-greifer2023" role="doc-biblioref">2023</a>)</span></p>
<div class="no-row-height column-margin column-container"></div><p><span class="math display">\hat{e} = P(A = 1 | L) = f_A(L; \theta_A)</span></p>
<p>Here, <span class="math inline">f_A(L; \theta_A)</span> is a function (a statistical model) that estimates the probability of the exposure <span class="math inline">A = 1</span> given covariates <span class="math inline">L</span>. Then, we calculate the weights for each individual, denoted as <span class="math inline">v</span>, using the estimated propensity score:</p>
<p><span class="math display">
v =
\begin{cases}
\frac{1}{e} &amp; \text{if } A = 1 \\
\frac{1}{1-e} &amp; \text{if } A = 0
\end{cases}
</span></p>
<p><strong>Step 2</strong> Fit a weighted outcome model. Using the weights calculated from the estimated propensity scores, fit a model for the outcome <span class="math inline">Y</span>, conditional on the exposure <span class="math inline">A</span> and covariates <span class="math inline">L</span>.</p>
<p><span class="math display"> \hat{E}(Y|A, L; V) = f_Y(A, L; \theta_Y, V) </span></p>
<p>This model should include terms for both the main effects of <span class="math inline">A</span> and <span class="math inline">L</span> and their interaction <span class="math inline">AL</span>.</p>
<p><strong>Step 3</strong> For the entire population, simulate the potential outcome under the hypothetical scenario where everyone is exposed to the intervention <span class="math inline">A=a</span> regardless of their actual exposure level:</p>
<p><span class="math display">\hat{E}(Y(a)) = \hat{E}[Y|A=a; L,\hat{\theta}_Y, v]</span></p>
<p>And also under the hypothetical scenario where everyone is exposed to intervention <span class="math inline">A=a'</span>:</p>
<p><span class="math display">\hat{E}(Y(a')) = \hat{E}[Y|A=a'; L; \hat{\theta}_Y, v]</span></p>
<p><strong>Step 4</strong> Estimate the average causal effect for the entire population. Compute the estimated expected value of the potential outcomes under each intervention level for the entire population:</p>
<p><span class="math display">\hat{\delta} = \hat{E}[Y(a)] - \hat{E}[Y(a')]</span></p>
<p>The estimated difference <span class="math inline">\hat{\delta}</span> represents the average causal effect of changing the exposure from level <span class="math inline">a'</span> to level <span class="math inline">a</span> in the entire population.</p>
<p>We again use simulation-based inference methods to compute standard errors and confidence intervals <span class="citation" data-cites="greifer2023">(<a href="#ref-greifer2023" role="doc-biblioref">Greifer et al. 2023</a>)</span>.</p>
<div class="no-row-height column-margin column-container"><div id="ref-greifer2023" class="csl-entry" role="listitem">
Greifer, Noah, Steven Worthington, Stefano Iacus, and Gary King. 2023. <em>Clarify: Simulation-Based Inference for Regression Models</em>. <a href="https://iqss.github.io/clarify/">https://iqss.github.io/clarify/</a>.
</div></div><section id="machine-learning" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="machine-learning">Machine Learning</h3>
<p>Example from https://osf.io/cnphs</p>
<div class="page-columns page-full"><blockquote class="blockquote">
<p>We perform statistical estimation using semi-parametric Targeted Learning, specifically a Targeted Minimum Loss-based Estimation (TMLE) estimator. TMLE is a robust method that combines machine learning techniques with traditional statistical models to estimate causal effects while providing valid statistical uncertainty measures for these estimates <span class="citation" data-cites="van2012targeted van2014targeted">(<a href="#ref-van2012targeted" role="doc-biblioref">Laan and Gruber 2012</a>; <a href="#ref-van2014targeted" role="doc-biblioref">Van der Laan 2014</a>)</span>.</p>
</blockquote><div class="no-row-height column-margin column-container"><div id="ref-van2012targeted" class="csl-entry" role="listitem">
Laan, Mark J van der, and Susan Gruber. 2012. <span>“Targeted Minimum Loss Based Estimation of Causal Effects of Multiple Time Point Interventions.”</span> <em>The International Journal of Biostatistics</em> 8 (1).
</div><div id="ref-van2014targeted" class="csl-entry" role="listitem">
Van der Laan, Mark J. 2014. <span>“Targeted Estimation of Nuisance Parameters to Obtain Valid Statistical Inference.”</span> <em>The International Journal of Biostatistics</em> 10 (1): 29–57.
</div></div></div>
<div class="page-columns page-full"><blockquote class="blockquote">
<p>TMLE operates through a two-step process that involves modelling both the outcome and treatment (exposure). Initially, TMLE employs machine learning algorithms to flexibly model the relationship between treatments, covariates, and outcomes. This flexibility allows TMLE to account for complex, high-dimensional covariate spaces without imposing restrictive model assumptions; <span class="citation" data-cites="vanderlaan2011 vanderlaan2018">(<a href="#ref-vanderlaan2011" role="doc-biblioref">Van Der Laan and Rose 2011</a>, <a href="#ref-vanderlaan2018" role="doc-biblioref">2018</a>)</span>. The outcome of this step is a set of initial estimates for these relationships.</p>
</blockquote><div class="no-row-height column-margin column-container"><div id="ref-vanderlaan2011" class="csl-entry" role="listitem">
Van Der Laan, Mark J., and Sherri Rose. 2011. <em>Targeted Learning: Causal Inference for Observational and Experimental Data</em>. Springer Series in Statistics. New York, NY: Springer. <a href="https://link.springer.com/10.1007/978-1-4419-9782-1">https://link.springer.com/10.1007/978-1-4419-9782-1</a>.
</div><div id="ref-vanderlaan2018" class="csl-entry" role="listitem">
———. 2018. <em>Targeted Learning in Data Science: Causal Inference for Complex Longitudinal Studies</em>. Springer Series in Statistics. Cham: Springer International Publishing. <a href="http://link.springer.com/10.1007/978-3-319-65304-4">http://link.springer.com/10.1007/978-3-319-65304-4</a>.
</div></div></div>
<div class="page-columns page-full"><blockquote class="blockquote">
<p>The second step of TMLE involves ``targeting’’ these initial estimates by incorporating information about the observed data distribution to improve the accuracy of the causal effect estimate. TMLE achieves this precision through an iterative updating process, which adjusts the initial estimates towards the true causal effect. This updating process is guided by the efficient influence function, ensuring that the final TMLE estimate is as close as possible, given the measures and data, to the targeted causal effect while still being robust to model-misspecification in either the outcome or the treatment model <span class="citation" data-cites="van2014discussion">(<a href="#ref-van2014discussion" role="doc-biblioref">Laan, Luedtke, and Dı́az 2014</a>)</span>.</p>
</blockquote><div class="no-row-height column-margin column-container"><div id="ref-van2014discussion" class="csl-entry" role="listitem">
Laan, Mark J van der, Alexander R Luedtke, and Iván Dı́az. 2014. <span>“Discussion of Identification, Estimation and Approximation of Risk Under Interventions That Depend on the Natural Value of Treatment Using Observational Data, by <span>J</span>essica <span>Y</span>oung, <span>M</span>iguel <span>H</span>ern<span>á</span>n, and <span>J</span>ames <span>R</span>obins.”</span> <em>Epidemiologic Methods</em> 3 (1): 21–31.
</div></div></div>
<div class="page-columns page-full"><blockquote class="blockquote">
<p>Again, a central feature of TMLE is its double-robustness property. If either the treatment model or the outcome model is correctly specified, the TMLE estimator will consistently estimate the causal effect. Additionally, we used cross-validation to avoid over-fitting, following the pre-stated protocols in Bulbulia <span class="citation" data-cites="bulbulia2024PRACTICAL">(<a href="#ref-bulbulia2024PRACTICAL" role="doc-biblioref">Bulbulia 2024c</a>)</span>. The integration of TMLE and machine learning technologies reduces the dependence on restrictive modelling assumptions and introduces an additional layer of robustness. For further details of the specific targeted learning strategy we favour, see <span class="citation" data-cites="duxedaz2021 hoffman2022">Hoffman et al. (<a href="#ref-hoffman2023" role="doc-biblioref">2023</a>)</span>. We perform estimation using the package <span class="citation" data-cites="williams2021">(<a href="#ref-williams2021" role="doc-biblioref">Williams and Díaz 2021</a>)</span>. We used the library for semi-parametric estimation with the predefined libraries , , and <span class="citation" data-cites="xgboost2023 polley2023 Ranger2017">(<a href="#ref-xgboost2023" role="doc-biblioref">Chen et al. 2023</a>; <a href="#ref-polley2023" role="doc-biblioref">Polley et al. 2023</a>; <a href="#ref-Ranger2017" role="doc-biblioref">Wright and Ziegler 2017</a>)</span>. We created graphs, tables and output reports using the package <span class="citation" data-cites="margot2024">(<a href="#ref-margot2024" role="doc-biblioref">Bulbulia 2024b</a>)</span>.</p>
</blockquote><div class="no-row-height column-margin column-container"><div id="ref-bulbulia2024PRACTICAL" class="csl-entry" role="listitem">
———. 2024c. <span>“A Practical Guide to Causal Inference in Three-Wave Panel Studies.”</span> <em>PsyArXiv Preprints</em>, February. <a href="https://doi.org/10.31234/osf.io/uyg3d">https://doi.org/10.31234/osf.io/uyg3d</a>.
</div><div id="ref-hoffman2023" class="csl-entry" role="listitem">
Hoffman, Katherine L., Diego Salazar-Barreto, Kara E. Rudolph, and Iván Díaz. 2023. <span>“Introducing Longitudinal Modified Treatment Policies: A Unified Framework for Studying Complex Exposures,”</span> April. <a href="https://doi.org/10.48550/arXiv.2304.09460">https://doi.org/10.48550/arXiv.2304.09460</a>.
</div><div id="ref-williams2021" class="csl-entry" role="listitem">
Williams, Nicholas T., and Iván Díaz. 2021. <em><span class="nocase">l</span>mtp: Non-Parametric Causal Effects of Feasible Interventions Based on Modified Treatment Policies</em>. <a href="https://doi.org/10.5281/zenodo.3874931">https://doi.org/10.5281/zenodo.3874931</a>.
</div><div id="ref-xgboost2023" class="csl-entry" role="listitem">
Chen, Tianqi, Tong He, Michael Benesty, Vadim Khotilovich, Yuan Tang, Hyunsu Cho, Kailong Chen, et al. 2023. <em>Xgboost: Extreme Gradient Boosting</em>. <a href="https://CRAN.R-project.org/package=xgboost">https://CRAN.R-project.org/package=xgboost</a>.
</div><div id="ref-polley2023" class="csl-entry" role="listitem">
Polley, Eric, Erin LeDell, Chris Kennedy, and Mark van der Laan Laan. 2023. <em>SuperLearner: Super Learner Prediction</em>. <a href="https://CRAN.R-project.org/package=SuperLearner">https://CRAN.R-project.org/package=SuperLearner</a>.
</div><div id="ref-Ranger2017" class="csl-entry" role="listitem">
Wright, Marvin N., and Andreas Ziegler. 2017. <span>“<span class="nocase">ranger</span>: A Fast Implementation of Random Forests for High Dimensional Data in <span>C++</span> and <span>R</span>.”</span> <em>Journal of Statistical Software</em> 77 (1): 1–17. <a href="https://doi.org/10.18637/jss.v077.i01">https://doi.org/10.18637/jss.v077.i01</a>.
</div><div id="ref-margot2024" class="csl-entry" role="listitem">
———. 2024b. <em>Margot: MARGinal Observational Treatment-Effects</em>. <a href="https://doi.org/10.5281/zenodo.10907724">https://doi.org/10.5281/zenodo.10907724</a>.
</div></div></div>
<section id="sensitivity-analysis-using-the-e-value" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="sensitivity-analysis-using-the-e-value">Sensitivity Analysis Using the E-value</h4>
<div class="page-columns page-full"><blockquote class="blockquote">
<p>To assess the sensitivity of results to unmeasured confounding, we report VanderWeele and Ding’s ``E-value’’ in all analyses <span class="citation" data-cites="vanderweele2017">(<a href="#ref-vanderweele2017" role="doc-biblioref">Tyler J. VanderWeele and Ding 2017</a>)</span>. The E-value quantifies the minimum strength of association (on the risk ratio scale) that an unmeasured confounder would need to have with both the exposure and the outcome (after considering the measured covariates) to explain away the observed exposure-outcome association <span class="citation" data-cites="linden2020EVALUE vanderweele2020">(<a href="#ref-linden2020EVALUE" role="doc-biblioref">Linden, Mathur, and VanderWeele 2020</a>; <a href="#ref-vanderweele2020" role="doc-biblioref">Tyler J. VanderWeele, Mathur, and Chen 2020</a>)</span>. To evaluate the strength of evidence, we use the bound of the E-value 95% confidence interval closest to 1.</p>
</blockquote><div class="no-row-height column-margin column-container"><div id="ref-vanderweele2017" class="csl-entry" role="listitem">
VanderWeele, Tyler J., and Peng Ding. 2017. <span>“Sensitivity Analysis in Observational Research: Introducing the <span>E</span>-Value.”</span> <em>Annals of Internal Medicine</em> 167 (4): 268–74. <a href="https://doi.org/10.7326/M16-2607">https://doi.org/10.7326/M16-2607</a>.
</div><div id="ref-linden2020EVALUE" class="csl-entry" role="listitem">
Linden, Ariel, Maya B Mathur, and Tyler J VanderWeele. 2020. <span>“Conducting Sensitivity Analysis for Unmeasured Confounding in Observational Studies Using e-Values: The Evalue Package.”</span> <em>The Stata Journal</em> 20 (1): 162–75.
</div><div id="ref-vanderweele2020" class="csl-entry" role="listitem">
VanderWeele, Tyler J, Maya B Mathur, and Ying Chen. 2020. <span>“Outcome-Wide Longitudinal Designs for Causal Inference: A New Template for Empirical Studies.”</span> <em>Statistical Science</em> 35 (3): 437–66.
</div></div></div>
</section>
</section>
<section id="packages" class="level3">
<h3 class="anchored" data-anchor-id="packages">Packages</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a>report<span class="sc">::</span><span class="fu">cite_packages</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  - Bulbulia J (2024). _margot: MARGinal Observational Treatment-effects_. doi:10.5281/zenodo.10907724 &lt;https://doi.org/10.5281/zenodo.10907724&gt;, R package version 1.0.41 Functions to obtain MARGinal Observational Treatment-effects from observational data., &lt;https://go-bayes.github.io/margot/&gt;.
  - Chang W (2023). _extrafont: Tools for Using Fonts_. doi:10.32614/CRAN.package.extrafont &lt;https://doi.org/10.32614/CRAN.package.extrafont&gt;, R package version 0.19, &lt;https://CRAN.R-project.org/package=extrafont&gt;.
  - Grolemund G, Wickham H (2011). "Dates and Times Made Easy with lubridate." _Journal of Statistical Software_, *40*(3), 1-25. &lt;https://www.jstatsoft.org/v40/i03/&gt;.
  - Müller K, Wickham H (2023). _tibble: Simple Data Frames_. doi:10.32614/CRAN.package.tibble &lt;https://doi.org/10.32614/CRAN.package.tibble&gt;, R package version 3.2.1, &lt;https://CRAN.R-project.org/package=tibble&gt;.
  - R Core Team (2025). _R: A Language and Environment for Statistical Computing_. R Foundation for Statistical Computing, Vienna, Austria. &lt;https://www.R-project.org/&gt;.
  - Wickham H (2016). _ggplot2: Elegant Graphics for Data Analysis_. Springer-Verlag New York. ISBN 978-3-319-24277-4, &lt;https://ggplot2.tidyverse.org&gt;.
  - Wickham H (2023). _forcats: Tools for Working with Categorical Variables (Factors)_. doi:10.32614/CRAN.package.forcats &lt;https://doi.org/10.32614/CRAN.package.forcats&gt;, R package version 1.0.0, &lt;https://CRAN.R-project.org/package=forcats&gt;.
  - Wickham H (2023). _stringr: Simple, Consistent Wrappers for Common String Operations_. doi:10.32614/CRAN.package.stringr &lt;https://doi.org/10.32614/CRAN.package.stringr&gt;, R package version 1.5.1, &lt;https://CRAN.R-project.org/package=stringr&gt;.
  - Wickham H, Averick M, Bryan J, Chang W, McGowan LD, François R, Grolemund G, Hayes A, Henry L, Hester J, Kuhn M, Pedersen TL, Miller E, Bache SM, Müller K, Ooms J, Robinson D, Seidel DP, Spinu V, Takahashi K, Vaughan D, Wilke C, Woo K, Yutani H (2019). "Welcome to the tidyverse." _Journal of Open Source Software_, *4*(43), 1686. doi:10.21105/joss.01686 &lt;https://doi.org/10.21105/joss.01686&gt;.
  - Wickham H, François R, Henry L, Müller K, Vaughan D (2023). _dplyr: A Grammar of Data Manipulation_. doi:10.32614/CRAN.package.dplyr &lt;https://doi.org/10.32614/CRAN.package.dplyr&gt;, R package version 1.1.4, &lt;https://CRAN.R-project.org/package=dplyr&gt;.
  - Wickham H, Henry L (2025). _purrr: Functional Programming Tools_. doi:10.32614/CRAN.package.purrr &lt;https://doi.org/10.32614/CRAN.package.purrr&gt;, R package version 1.0.4, &lt;https://CRAN.R-project.org/package=purrr&gt;.
  - Wickham H, Hester J, Bryan J (2024). _readr: Read Rectangular Text Data_. doi:10.32614/CRAN.package.readr &lt;https://doi.org/10.32614/CRAN.package.readr&gt;, R package version 2.1.5, &lt;https://CRAN.R-project.org/package=readr&gt;.
  - Wickham H, Vaughan D, Girlich M (2024). _tidyr: Tidy Messy Data_. doi:10.32614/CRAN.package.tidyr &lt;https://doi.org/10.32614/CRAN.package.tidyr&gt;, R package version 1.3.1, &lt;https://CRAN.R-project.org/package=tidyr&gt;.
  - Xie Y (2025). _tinytex: Helper Functions to Install and Maintain TeX Live, and Compile LaTeX Documents_. R package version 0.57, &lt;https://github.com/rstudio/tinytex&gt;. Xie Y (2019). "TinyTeX: A lightweight, cross-platform, and easy-to-maintain LaTeX distribution based on TeX Live." _TUGboat_, *40*(1), 30-32. &lt;https://tug.org/TUGboat/Contents/contents40-1.html&gt;.</code></pre>
</div>
</div>


<!-- -->


</section>
</section>
</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb38" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb38-1"><a href="#cb38-1"></a><span class="co">---</span></span>
<span id="cb38-2"><a href="#cb38-2"></a><span class="an">title:</span><span class="co"> "Causal inference: a step by step guide"</span></span>
<span id="cb38-3"><a href="#cb38-3"></a><span class="an">date:</span><span class="co"> "2025-MAY-06"</span></span>
<span id="cb38-4"><a href="#cb38-4"></a><span class="an">bibliography:</span><span class="co"> /Users/joseph/GIT/templates/bib/references.bib</span></span>
<span id="cb38-5"><a href="#cb38-5"></a><span class="an">editor_options:</span><span class="co"> </span></span>
<span id="cb38-6"><a href="#cb38-6"></a><span class="co">  chunk_output_type: console</span></span>
<span id="cb38-7"><a href="#cb38-7"></a><span class="an">format:</span></span>
<span id="cb38-8"><a href="#cb38-8"></a><span class="co">  html:</span></span>
<span id="cb38-9"><a href="#cb38-9"></a><span class="co">    warnings: FALSE</span></span>
<span id="cb38-10"><a href="#cb38-10"></a><span class="co">    error: FALSE</span></span>
<span id="cb38-11"><a href="#cb38-11"></a><span class="co">    messages: FALSE</span></span>
<span id="cb38-12"><a href="#cb38-12"></a><span class="co">    code-overflow: scroll</span></span>
<span id="cb38-13"><a href="#cb38-13"></a><span class="co">    highlight-style: Ayu</span></span>
<span id="cb38-14"><a href="#cb38-14"></a><span class="co">    code-line-numbers: true</span></span>
<span id="cb38-15"><a href="#cb38-15"></a><span class="co">    code-fold: true</span></span>
<span id="cb38-16"><a href="#cb38-16"></a><span class="co">    code-tools:</span></span>
<span id="cb38-17"><a href="#cb38-17"></a><span class="co">      source: true</span></span>
<span id="cb38-18"><a href="#cb38-18"></a><span class="co">      toggle: false</span></span>
<span id="cb38-19"><a href="#cb38-19"></a><span class="an">html-math-method:</span><span class="co"> katex</span></span>
<span id="cb38-20"><a href="#cb38-20"></a><span class="an">reference-location:</span><span class="co"> margin</span></span>
<span id="cb38-21"><a href="#cb38-21"></a><span class="an">citation-location:</span><span class="co"> margin</span></span>
<span id="cb38-22"><a href="#cb38-22"></a><span class="an">cap-location:</span><span class="co"> margin</span></span>
<span id="cb38-23"><a href="#cb38-23"></a><span class="an">code-block-border-left:</span><span class="co"> true</span></span>
<span id="cb38-24"><a href="#cb38-24"></a><span class="co">---</span></span>
<span id="cb38-25"><a href="#cb38-25"></a></span>
<span id="cb38-28"><a href="#cb38-28"></a><span class="in">```{r}</span></span>
<span id="cb38-29"><a href="#cb38-29"></a><span class="co">#| include: false</span></span>
<span id="cb38-30"><a href="#cb38-30"></a><span class="co">#| echo: false</span></span>
<span id="cb38-31"><a href="#cb38-31"></a><span class="co">#read libraries</span></span>
<span id="cb38-32"><a href="#cb38-32"></a></span>
<span id="cb38-33"><a href="#cb38-33"></a><span class="fu">library</span>(<span class="st">"tinytex"</span>)</span>
<span id="cb38-34"><a href="#cb38-34"></a><span class="fu">library</span>(extrafont)</span>
<span id="cb38-35"><a href="#cb38-35"></a><span class="fu">loadfonts</span>(<span class="at">device =</span> <span class="st">"all"</span>)</span>
<span id="cb38-36"><a href="#cb38-36"></a></span>
<span id="cb38-37"><a href="#cb38-37"></a><span class="fu">library</span>(<span class="st">"margot"</span>)</span>
<span id="cb38-38"><a href="#cb38-38"></a><span class="fu">library</span>(<span class="st">"tidyverse"</span>)</span>
<span id="cb38-39"><a href="#cb38-39"></a></span>
<span id="cb38-40"><a href="#cb38-40"></a><span class="in">```</span></span>
<span id="cb38-41"><a href="#cb38-41"></a></span>
<span id="cb38-42"><a href="#cb38-42"></a></span>
<span id="cb38-43"><a href="#cb38-43"></a>::: {.callout-note}</span>
<span id="cb38-44"><a href="#cb38-44"></a>**Required**</span>
<span id="cb38-45"><a href="#cb38-45"></a><span class="ss">- </span>grf package readings <span class="co">[</span><span class="ot">https://grf-labs.github.io/grf/</span><span class="co">](https://grf-labs.github.io/grf/)</span></span>
<span id="cb38-46"><a href="#cb38-46"></a><span class="ss">- </span>Do "Homework" form Lecture 8</span>
<span id="cb38-47"><a href="#cb38-47"></a></span>
<span id="cb38-48"><a href="#cb38-48"></a>**Optional**</span>
<span id="cb38-49"><a href="#cb38-49"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@Bulbulia2024PracticalGuide</span><span class="co">] [link]</span>(https://osf.io/preprints/psyarxiv/uyg3d)</span>
<span id="cb38-50"><a href="#cb38-50"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@hoffman2023</span><span class="co">] [link]</span>(https://arxiv.org/pdf/2304.09460.pdf)</span>
<span id="cb38-51"><a href="#cb38-51"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@vanderweele2020</span><span class="co">] [link]</span>(https://www.dropbox.com/scl/fi/srpynr0dvjcndveplcydn/OutcomeWide_StatisticalScience.pdf?rlkey=h4fv32oyjegdfl3jq9u1fifc3&amp;dl=0)</span>
<span id="cb38-52"><a href="#cb38-52"></a>:::</span>
<span id="cb38-53"><a href="#cb38-53"></a></span>
<span id="cb38-54"><a href="#cb38-54"></a>::: {.callout-important}</span>
<span id="cb38-55"><a href="#cb38-55"></a><span class="fu">## Key concepts</span></span>
<span id="cb38-56"><a href="#cb38-56"></a></span>
<span id="cb38-57"><a href="#cb38-57"></a>Doing a causal analysis</span>
<span id="cb38-58"><a href="#cb38-58"></a></span>
<span id="cb38-59"><a href="#cb38-59"></a>:::</span>
<span id="cb38-60"><a href="#cb38-60"></a></span>
<span id="cb38-61"><a href="#cb38-61"></a>::: {.callout-important}</span>
<span id="cb38-62"><a href="#cb38-62"></a><span class="ss">-  </span>Download the R script</span>
<span id="cb38-63"><a href="#cb38-63"></a><span class="ss">-  </span>Download the relevant libraries.</span>
<span id="cb38-64"><a href="#cb38-64"></a><span class="ss">-  </span>Will go through this script step-by-step.</span>
<span id="cb38-65"><a href="#cb38-65"></a>:::</span>
<span id="cb38-66"><a href="#cb38-66"></a></span>
<span id="cb38-67"><a href="#cb38-67"></a></span>
<span id="cb38-68"><a href="#cb38-68"></a></span>
<span id="cb38-69"><a href="#cb38-69"></a></span>
<span id="cb38-70"><a href="#cb38-70"></a><span class="fu"># Part 1: Laboratory</span></span>
<span id="cb38-71"><a href="#cb38-71"></a></span>
<span id="cb38-72"><a href="#cb38-72"></a></span>
<span id="cb38-73"><a href="#cb38-73"></a></span>
<span id="cb38-74"><a href="#cb38-74"></a><span class="fu">### Scripts for a full analysis</span></span>
<span id="cb38-75"><a href="#cb38-75"></a></span>
<span id="cb38-76"><a href="#cb38-76"></a>::: {.callout-note-script-0}</span>
<span id="cb38-77"><a href="#cb38-77"></a><span class="co">[</span><span class="ot">Download full lab scripts 0</span><span class="co">](../laboratory/lab-10/00-setup-L10.R)</span></span>
<span id="cb38-78"><a href="#cb38-78"></a>:::</span>
<span id="cb38-79"><a href="#cb38-79"></a></span>
<span id="cb38-80"><a href="#cb38-80"></a></span>
<span id="cb38-81"><a href="#cb38-81"></a>::: {.callout-note-script-1}</span>
<span id="cb38-82"><a href="#cb38-82"></a><span class="co">[</span><span class="ot">Download full lab scripts 1</span><span class="co">](../laboratory/ ../laboratory/lab-10/01-init-L10.R)</span></span>
<span id="cb38-83"><a href="#cb38-83"></a>:::</span>
<span id="cb38-84"><a href="#cb38-84"></a></span>
<span id="cb38-85"><a href="#cb38-85"></a>::: {.callout-note-script-2}</span>
<span id="cb38-86"><a href="#cb38-86"></a><span class="co">[</span><span class="ot">Download full lab scripts 2</span><span class="co">]( ../laboratory/lab-10/02-make-wide-L10.R)</span></span>
<span id="cb38-87"><a href="#cb38-87"></a>:::</span>
<span id="cb38-88"><a href="#cb38-88"></a></span>
<span id="cb38-89"><a href="#cb38-89"></a>::: {.callout-note-script-3}</span>
<span id="cb38-90"><a href="#cb38-90"></a><span class="co">[</span><span class="ot">Download full lab scripts 3</span><span class="co">](../laboratory/lab-10/03-models-L10.R)</span></span>
<span id="cb38-91"><a href="#cb38-91"></a>:::</span>
<span id="cb38-92"><a href="#cb38-92"></a></span>
<span id="cb38-93"><a href="#cb38-93"></a></span>
<span id="cb38-94"><a href="#cb38-94"></a><span class="fu">## Script 0: Synthetic Data Fetch</span></span>
<span id="cb38-95"><a href="#cb38-95"></a></span>
<span id="cb38-96"><a href="#cb38-96"></a>**Run in full. No need to change anything.**  </span>
<span id="cb38-97"><a href="#cb38-97"></a></span>
<span id="cb38-98"><a href="#cb38-98"></a>This script prepares your data. Run it once -- running it twice would be like turning the ignition off just to start your car again.</span>
<span id="cb38-99"><a href="#cb38-99"></a></span>
<span id="cb38-100"><a href="#cb38-100"></a></span>
<span id="cb38-103"><a href="#cb38-103"></a><span class="in">```{r}</span></span>
<span id="cb38-104"><a href="#cb38-104"></a><span class="co">#| include: true</span></span>
<span id="cb38-105"><a href="#cb38-105"></a><span class="co">#| eval: false</span></span>
<span id="cb38-106"><a href="#cb38-106"></a><span class="co">#| file: ../laboratory/lab-10/00-setup-L10.R</span></span>
<span id="cb38-107"><a href="#cb38-107"></a><span class="in">```</span></span>
<span id="cb38-108"><a href="#cb38-108"></a></span>
<span id="cb38-109"><a href="#cb38-109"></a><span class="fu">## Script 1: Initial Data Wrangling is HERE</span></span>
<span id="cb38-110"><a href="#cb38-110"></a></span>
<span id="cb38-113"><a href="#cb38-113"></a><span class="in">```{r}</span></span>
<span id="cb38-114"><a href="#cb38-114"></a><span class="co">#| include: true</span></span>
<span id="cb38-115"><a href="#cb38-115"></a><span class="co">#| eval: false</span></span>
<span id="cb38-116"><a href="#cb38-116"></a><span class="co">#| file: ../laboratory/lab-10/01-init-L10.R</span></span>
<span id="cb38-117"><a href="#cb38-117"></a></span>
<span id="cb38-118"><a href="#cb38-118"></a><span class="in">```</span></span>
<span id="cb38-119"><a href="#cb38-119"></a></span>
<span id="cb38-120"><a href="#cb38-120"></a></span>
<span id="cb38-121"><a href="#cb38-121"></a><span class="fu">## Script 2: Make Wide Data Format With Censoring Weights is HERE</span></span>
<span id="cb38-122"><a href="#cb38-122"></a></span>
<span id="cb38-125"><a href="#cb38-125"></a><span class="in">```{r}</span></span>
<span id="cb38-126"><a href="#cb38-126"></a><span class="co">#| include: true</span></span>
<span id="cb38-127"><a href="#cb38-127"></a><span class="co">#| eval: false</span></span>
<span id="cb38-128"><a href="#cb38-128"></a><span class="co">#| file: ../laboratory/lab-10/02-make-wide-L10.R</span></span>
<span id="cb38-129"><a href="#cb38-129"></a></span>
<span id="cb38-130"><a href="#cb38-130"></a><span class="in">```</span></span>
<span id="cb38-131"><a href="#cb38-131"></a></span>
<span id="cb38-132"><a href="#cb38-132"></a></span>
<span id="cb38-133"><a href="#cb38-133"></a></span>
<span id="cb38-134"><a href="#cb38-134"></a><span class="fu">## Script 3: Models &amp; Graphs is HERE</span></span>
<span id="cb38-135"><a href="#cb38-135"></a></span>
<span id="cb38-136"><a href="#cb38-136"></a></span>
<span id="cb38-139"><a href="#cb38-139"></a><span class="in">```{r}</span></span>
<span id="cb38-140"><a href="#cb38-140"></a><span class="co">#| include: true</span></span>
<span id="cb38-141"><a href="#cb38-141"></a><span class="co">#| eval: false</span></span>
<span id="cb38-142"><a href="#cb38-142"></a><span class="co">#| file: ../laboratory/lab-10/03-models-L10.R</span></span>
<span id="cb38-143"><a href="#cb38-143"></a></span>
<span id="cb38-144"><a href="#cb38-144"></a><span class="in">```</span></span>
<span id="cb38-145"><a href="#cb38-145"></a></span>
<span id="cb38-146"><a href="#cb38-146"></a></span>
<span id="cb38-147"><a href="#cb38-147"></a><span class="fu">## Code Explanations</span></span>
<span id="cb38-148"><a href="#cb38-148"></a></span>
<span id="cb38-149"><a href="#cb38-149"></a><span class="fu">### Script 01 Initial Data Wrangling</span></span>
<span id="cb38-150"><a href="#cb38-150"></a></span>
<span id="cb38-151"><a href="#cb38-151"></a>Key checkpoints in the *wrangle-1* script are as follows;</span>
<span id="cb38-152"><a href="#cb38-152"></a></span>
<span id="cb38-153"><a href="#cb38-153"></a></span>
<span id="cb38-154"><a href="#cb38-154"></a><span class="fu">#### First — pick your three study waves* </span></span>
<span id="cb38-155"><a href="#cb38-155"></a></span>
<span id="cb38-156"><a href="#cb38-156"></a>Note waves run from October --&gt; September of the year following the wave.</span>
<span id="cb38-157"><a href="#cb38-157"></a></span>
<span id="cb38-158"><a href="#cb38-158"></a>Note: </span>
<span id="cb38-159"><a href="#cb38-159"></a><span class="ss">- </span>baseline variables must appear in the baseline wave</span>
<span id="cb38-160"><a href="#cb38-160"></a><span class="ss">- </span>the exposure variable must appear in both the baseline wave and exposure wave (but need not appear in the outcome wave)</span>
<span id="cb38-161"><a href="#cb38-161"></a><span class="ss">- </span>outcome variables must appear in both the baseline wave and outcome wave (but need not appear in the exposure wave.)</span>
<span id="cb38-162"><a href="#cb38-162"></a></span>
<span id="cb38-163"><a href="#cb38-163"></a></span>
<span id="cb38-164"><a href="#cb38-164"></a><span class="in">```r</span></span>
<span id="cb38-165"><a href="#cb38-165"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-166"><a href="#cb38-166"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb38-167"><a href="#cb38-167"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-168"><a href="#cb38-168"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-169"><a href="#cb38-169"></a><span class="co"># | OPTIONALLY MODIFY SECTION|</span></span>
<span id="cb38-170"><a href="#cb38-170"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-171"><a href="#cb38-171"></a></span>
<span id="cb38-172"><a href="#cb38-172"></a><span class="co"># **  define your study waves **</span></span>
<span id="cb38-173"><a href="#cb38-173"></a>baseline_wave      <span class="ot">&lt;-</span> <span class="st">"2018"</span>        <span class="co"># baseline measurement</span></span>
<span id="cb38-174"><a href="#cb38-174"></a>exposure_waves     <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"2019"</span>)     <span class="co"># when exposure is measured</span></span>
<span id="cb38-175"><a href="#cb38-175"></a>outcome_wave       <span class="ot">&lt;-</span> <span class="st">"2020"</span>        <span class="co"># when outcomes are measured</span></span>
<span id="cb38-176"><a href="#cb38-176"></a>all_waves          <span class="ot">&lt;-</span> <span class="fu">c</span>(baseline_wave, exposure_waves, outcome_wave)</span>
<span id="cb38-177"><a href="#cb38-177"></a><span class="in">```</span></span>
<span id="cb38-178"><a href="#cb38-178"></a></span>
<span id="cb38-179"><a href="#cb38-179"></a></span>
<span id="cb38-180"><a href="#cb38-180"></a></span>
<span id="cb38-181"><a href="#cb38-181"></a><span class="fu">#### Second — pick your exposure </span></span>
<span id="cb38-182"><a href="#cb38-182"></a></span>
<span id="cb38-183"><a href="#cb38-183"></a>Decide which variable is the 'cause'. Here it is <span class="in">`extraversion`</span>. Verify it exists at baseline (<span class="in">`t0_`</span>) *and* at the exposure wave (<span class="in">`t1_`</span>)</span>
<span id="cb38-184"><a href="#cb38-184"></a></span>
<span id="cb38-185"><a href="#cb38-185"></a></span>
<span id="cb38-186"><a href="#cb38-186"></a><span class="in">```r</span></span>
<span id="cb38-187"><a href="#cb38-187"></a><span class="co"># define study variables ----------------------------------------------------</span></span>
<span id="cb38-188"><a href="#cb38-188"></a><span class="co"># ** key decision 2: define your exposure variable **</span></span>
<span id="cb38-189"><a href="#cb38-189"></a></span>
<span id="cb38-190"><a href="#cb38-190"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-191"><a href="#cb38-191"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb38-192"><a href="#cb38-192"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-193"><a href="#cb38-193"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-194"><a href="#cb38-194"></a><span class="co"># |    MODIFY THIS SECTION   |</span></span>
<span id="cb38-195"><a href="#cb38-195"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-196"><a href="#cb38-196"></a>name_exposure <span class="ot">&lt;-</span> <span class="st">"extraversion"</span></span>
<span id="cb38-197"><a href="#cb38-197"></a></span>
<span id="cb38-198"><a href="#cb38-198"></a><span class="co"># exposure variable labels</span></span>
<span id="cb38-199"><a href="#cb38-199"></a>var_labels_exposure <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb38-200"><a href="#cb38-200"></a>  <span class="st">"extraversion"</span> <span class="ot">=</span> <span class="st">"Extraversion"</span>,</span>
<span id="cb38-201"><a href="#cb38-201"></a>  <span class="st">"extraversion_binary"</span> <span class="ot">=</span> <span class="st">"Extraversion (binary)"</span></span>
<span id="cb38-202"><a href="#cb38-202"></a>)</span>
<span id="cb38-203"><a href="#cb38-203"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-204"><a href="#cb38-204"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb38-205"><a href="#cb38-205"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-206"><a href="#cb38-206"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-207"><a href="#cb38-207"></a><span class="co"># |   </span><span class="re">END</span><span class="co"> MODIFY SECTION     |</span></span>
<span id="cb38-208"><a href="#cb38-208"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-209"><a href="#cb38-209"></a><span class="in">```</span></span>
<span id="cb38-210"><a href="#cb38-210"></a></span>
<span id="cb38-211"><a href="#cb38-211"></a></span>
<span id="cb38-212"><a href="#cb38-212"></a><span class="fu">#### Third -- choose your outcome variables (ensuring they are in the baseline wave and outcome wave)</span></span>
<span id="cb38-213"><a href="#cb38-213"></a></span>
<span id="cb38-214"><a href="#cb38-214"></a></span>
<span id="cb38-215"><a href="#cb38-215"></a></span>
<span id="cb38-216"><a href="#cb38-216"></a><span class="in">```r</span></span>
<span id="cb38-217"><a href="#cb38-217"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-218"><a href="#cb38-218"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb38-219"><a href="#cb38-219"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-220"><a href="#cb38-220"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-221"><a href="#cb38-221"></a><span class="co"># |    MODIFY THIS SECTION   |</span></span>
<span id="cb38-222"><a href="#cb38-222"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-223"><a href="#cb38-223"></a><span class="co"># ** key decision 3: define outcome variables **</span></span>
<span id="cb38-224"><a href="#cb38-224"></a><span class="co"># here, we are focussing on a subset of wellbeing outcomes</span></span>
<span id="cb38-225"><a href="#cb38-225"></a><span class="co"># chose outcomes relevant to * your * study. Might be all/some/none/exactly </span></span>
<span id="cb38-226"><a href="#cb38-226"></a><span class="co"># these:</span></span>
<span id="cb38-227"><a href="#cb38-227"></a>outcome_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb38-228"><a href="#cb38-228"></a>  <span class="co"># health outcomes</span></span>
<span id="cb38-229"><a href="#cb38-229"></a>  <span class="co"># "alcohol_frequency_weekly", "alcohol_intensity",</span></span>
<span id="cb38-230"><a href="#cb38-230"></a>  <span class="co"># "hlth_bmi", </span></span>
<span id="cb38-231"><a href="#cb38-231"></a>  <span class="st">"log_hours_exercise"</span>, </span>
<span id="cb38-232"><a href="#cb38-232"></a>  <span class="co"># "hlth_sleep_hours", </span></span>
<span id="cb38-233"><a href="#cb38-233"></a>  <span class="co"># "short_form_health",</span></span>
<span id="cb38-234"><a href="#cb38-234"></a>  </span>
<span id="cb38-235"><a href="#cb38-235"></a>  <span class="co"># psychological outcomes</span></span>
<span id="cb38-236"><a href="#cb38-236"></a>  <span class="co"># "hlth_fatigue", </span></span>
<span id="cb38-237"><a href="#cb38-237"></a>  <span class="st">"kessler_latent_anxiety"</span>, </span>
<span id="cb38-238"><a href="#cb38-238"></a>  <span class="st">"kessler_latent_depression"</span>, </span>
<span id="cb38-239"><a href="#cb38-239"></a>  <span class="st">"rumination"</span>,</span>
<span id="cb38-240"><a href="#cb38-240"></a>  </span>
<span id="cb38-241"><a href="#cb38-241"></a>  <span class="co"># well-being outcomes</span></span>
<span id="cb38-242"><a href="#cb38-242"></a>  <span class="co"># "bodysat", </span></span>
<span id="cb38-243"><a href="#cb38-243"></a>  <span class="co">#"forgiveness", "gratitude", </span></span>
<span id="cb38-244"><a href="#cb38-244"></a>  <span class="st">"lifesat"</span>, <span class="st">"meaning_purpose"</span>, <span class="st">"meaning_sense"</span>, </span>
<span id="cb38-245"><a href="#cb38-245"></a>  <span class="co"># "perfectionism", </span></span>
<span id="cb38-246"><a href="#cb38-246"></a>  <span class="st">"pwi"</span>, </span>
<span id="cb38-247"><a href="#cb38-247"></a>  <span class="co">#"self_control", </span></span>
<span id="cb38-248"><a href="#cb38-248"></a>  <span class="st">"self_esteem"</span>, </span>
<span id="cb38-249"><a href="#cb38-249"></a>  <span class="co">#"sexual_satisfaction",</span></span>
<span id="cb38-250"><a href="#cb38-250"></a>  </span>
<span id="cb38-251"><a href="#cb38-251"></a>  <span class="co"># social outcomes</span></span>
<span id="cb38-252"><a href="#cb38-252"></a>  <span class="st">"belong"</span>, <span class="st">"neighbourhood_community"</span>, <span class="st">"support"</span></span>
<span id="cb38-253"><a href="#cb38-253"></a>)</span>
<span id="cb38-254"><a href="#cb38-254"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-255"><a href="#cb38-255"></a><span class="co"># |   </span><span class="re">END</span><span class="co"> MODIFY SECTION     |</span></span>
<span id="cb38-256"><a href="#cb38-256"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-257"><a href="#cb38-257"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-258"><a href="#cb38-258"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb38-259"><a href="#cb38-259"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-260"><a href="#cb38-260"></a><span class="in">```</span></span>
<span id="cb38-261"><a href="#cb38-261"></a></span>
<span id="cb38-262"><a href="#cb38-262"></a></span>
<span id="cb38-263"><a href="#cb38-263"></a><span class="fu">#### Fourth: define baseline covariates</span></span>
<span id="cb38-264"><a href="#cb38-264"></a></span>
<span id="cb38-265"><a href="#cb38-265"></a>Define baseline variables. The primary role of these variables is to control unmeasured confounding. We will also use these variables to investigate treatment effect heterogeneity. Note that the exposure at baseline and the outcomes at baseline will automatically be included in this set later. </span>
<span id="cb38-266"><a href="#cb38-266"></a></span>
<span id="cb38-267"><a href="#cb38-267"></a>**You may use the following variables without modifying them.**</span>
<span id="cb38-268"><a href="#cb38-268"></a></span>
<span id="cb38-269"><a href="#cb38-269"></a></span>
<span id="cb38-270"><a href="#cb38-270"></a><span class="in">```r</span></span>
<span id="cb38-271"><a href="#cb38-271"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-272"><a href="#cb38-272"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb38-273"><a href="#cb38-273"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-274"><a href="#cb38-274"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-275"><a href="#cb38-275"></a><span class="co"># | OPTIONALLY MODIFY SECTION|</span></span>
<span id="cb38-276"><a href="#cb38-276"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-277"><a href="#cb38-277"></a><span class="co"># define baseline variables -----------------------------------------------</span></span>
<span id="cb38-278"><a href="#cb38-278"></a><span class="co"># key decision 4 **  define baseline covariates **</span></span>
<span id="cb38-279"><a href="#cb38-279"></a><span class="co"># these are demographics, traits, etc. measured at baseline, that are common</span></span>
<span id="cb38-280"><a href="#cb38-280"></a><span class="co"># causes of the exposure and outcome.  </span></span>
<span id="cb38-281"><a href="#cb38-281"></a><span class="co"># note we will automatically include baseline measures of the exposure and outcome</span></span>
<span id="cb38-282"><a href="#cb38-282"></a><span class="co"># later in the workflow.</span></span>
<span id="cb38-283"><a href="#cb38-283"></a></span>
<span id="cb38-284"><a href="#cb38-284"></a>baseline_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb38-285"><a href="#cb38-285"></a>  <span class="co"># demographics</span></span>
<span id="cb38-286"><a href="#cb38-286"></a>  <span class="st">"age"</span>, <span class="st">"born_nz_binary"</span>, <span class="st">"education_level_coarsen"</span>,</span>
<span id="cb38-287"><a href="#cb38-287"></a>  <span class="st">"employed_binary"</span>, <span class="st">"eth_cat"</span>, <span class="st">"male_binary"</span>,</span>
<span id="cb38-288"><a href="#cb38-288"></a>  <span class="st">"not_heterosexual_binary"</span>, <span class="st">"parent_binary"</span>, <span class="st">"partner_binary"</span>,</span>
<span id="cb38-289"><a href="#cb38-289"></a>  <span class="st">"rural_gch_2018_l"</span>, <span class="st">"sample_frame_opt_in_binary"</span>,</span>
<span id="cb38-290"><a href="#cb38-290"></a>  </span>
<span id="cb38-291"><a href="#cb38-291"></a>  <span class="co"># personality traits (excluding exposure)</span></span>
<span id="cb38-292"><a href="#cb38-292"></a>  <span class="st">"agreeableness"</span>, <span class="st">"conscientiousness"</span>, <span class="st">"neuroticism"</span>, <span class="st">"openness"</span>,</span>
<span id="cb38-293"><a href="#cb38-293"></a>  </span>
<span id="cb38-294"><a href="#cb38-294"></a>  <span class="co"># health and lifestyle</span></span>
<span id="cb38-295"><a href="#cb38-295"></a>  <span class="st">"alcohol_frequency"</span>, <span class="st">"alcohol_intensity"</span>, <span class="st">"hlth_disability_binary"</span>,</span>
<span id="cb38-296"><a href="#cb38-296"></a>  <span class="st">"log_hours_children"</span>, <span class="st">"log_hours_commute"</span>, <span class="st">"log_hours_exercise"</span>,</span>
<span id="cb38-297"><a href="#cb38-297"></a>  <span class="st">"log_hours_housework"</span>, <span class="st">"log_household_inc"</span>,</span>
<span id="cb38-298"><a href="#cb38-298"></a>  <span class="st">"short_form_health"</span>, <span class="st">"smoker_binary"</span>,</span>
<span id="cb38-299"><a href="#cb38-299"></a>  </span>
<span id="cb38-300"><a href="#cb38-300"></a>  <span class="co"># social and psychological</span></span>
<span id="cb38-301"><a href="#cb38-301"></a>  <span class="st">"belong"</span>, <span class="st">"nz_dep2018"</span>, <span class="st">"nzsei_13_l"</span>,</span>
<span id="cb38-302"><a href="#cb38-302"></a>  <span class="st">"political_conservative"</span>, <span class="st">"religion_identification_level"</span></span>
<span id="cb38-303"><a href="#cb38-303"></a>)</span>
<span id="cb38-304"><a href="#cb38-304"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-305"><a href="#cb38-305"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb38-306"><a href="#cb38-306"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-307"><a href="#cb38-307"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-308"><a href="#cb38-308"></a><span class="co"># |   </span><span class="re">END</span><span class="co"> MODIFY SECTION     |</span></span>
<span id="cb38-309"><a href="#cb38-309"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-310"><a href="#cb38-310"></a></span>
<span id="cb38-311"><a href="#cb38-311"></a><span class="in">```</span></span>
<span id="cb38-312"><a href="#cb38-312"></a></span>
<span id="cb38-313"><a href="#cb38-313"></a><span class="fu">#### Five -- select baseline cohort population using eligibility criteria that are sensible for your study</span></span>
<span id="cb38-314"><a href="#cb38-314"></a></span>
<span id="cb38-315"><a href="#cb38-315"></a></span>
<span id="cb38-316"><a href="#cb38-316"></a><span class="in">```r</span></span>
<span id="cb38-317"><a href="#cb38-317"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-318"><a href="#cb38-318"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb38-319"><a href="#cb38-319"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-320"><a href="#cb38-320"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-321"><a href="#cb38-321"></a><span class="co"># | OPTIONALLY MODIFY SECTION|</span></span>
<span id="cb38-322"><a href="#cb38-322"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-323"><a href="#cb38-323"></a></span>
<span id="cb38-324"><a href="#cb38-324"></a><span class="co"># select eligible participants ----------------------------------------------</span></span>
<span id="cb38-325"><a href="#cb38-325"></a><span class="co"># only include participants who have exposure data at baseline</span></span>
<span id="cb38-326"><a href="#cb38-326"></a></span>
<span id="cb38-327"><a href="#cb38-327"></a><span class="co"># You might require tighter conditions </span></span>
<span id="cb38-328"><a href="#cb38-328"></a><span class="co"># for example, if you are interested in the effects of hours of childcare, </span></span>
<span id="cb38-329"><a href="#cb38-329"></a><span class="co"># you might want to select only those who were parents at baseline. </span></span>
<span id="cb38-330"><a href="#cb38-330"></a><span class="co"># talk to me if you think you might night tighter eligibility criteria.</span></span>
<span id="cb38-331"><a href="#cb38-331"></a></span>
<span id="cb38-332"><a href="#cb38-332"></a>ids_baseline <span class="ot">&lt;-</span> dat_prep <span class="sc">|&gt;</span> </span>
<span id="cb38-333"><a href="#cb38-333"></a>  <span class="co"># allow missing exposure at baseline</span></span>
<span id="cb38-334"><a href="#cb38-334"></a>  <span class="co"># this would give us greater confidence that we generalise to the target population</span></span>
<span id="cb38-335"><a href="#cb38-335"></a>  <span class="co"># filter(wave == baseline_wave) |&gt; </span></span>
<span id="cb38-336"><a href="#cb38-336"></a>  <span class="co"># option: do not allow missing exposure at baseline</span></span>
<span id="cb38-337"><a href="#cb38-337"></a>  <span class="co"># this gives us greater confidence that we recover a incident effect</span></span>
<span id="cb38-338"><a href="#cb38-338"></a>  <span class="fu">filter</span>(wave <span class="sc">==</span> baseline_wave, <span class="sc">!</span><span class="fu">is.na</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_exposure))) <span class="sc">|&gt;</span> </span>
<span id="cb38-339"><a href="#cb38-339"></a>  <span class="fu">pull</span>(id)</span>
<span id="cb38-340"><a href="#cb38-340"></a></span>
<span id="cb38-341"><a href="#cb38-341"></a><span class="co"># filter data to include only eligible participants and relevant waves</span></span>
<span id="cb38-342"><a href="#cb38-342"></a>dat_long_1 <span class="ot">&lt;-</span> dat_prep <span class="sc">|&gt;</span> </span>
<span id="cb38-343"><a href="#cb38-343"></a>  <span class="fu">filter</span>(id <span class="sc">%in%</span> ids_baseline, wave <span class="sc">%in%</span> all_waves) <span class="sc">|&gt;</span> </span>
<span id="cb38-344"><a href="#cb38-344"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb38-345"><a href="#cb38-345"></a></span>
<span id="cb38-346"><a href="#cb38-346"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-347"><a href="#cb38-347"></a><span class="co"># |</span><span class="re">END</span><span class="co"> OPTIONALLY MODIFY SEC.|</span></span>
<span id="cb38-348"><a href="#cb38-348"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-349"><a href="#cb38-349"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-350"><a href="#cb38-350"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb38-351"><a href="#cb38-351"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-352"><a href="#cb38-352"></a><span class="in">```</span></span>
<span id="cb38-353"><a href="#cb38-353"></a></span>
<span id="cb38-354"><a href="#cb38-354"></a></span>
<span id="cb38-355"><a href="#cb38-355"></a><span class="fu">#### Six -- choose a binary cut-point</span></span>
<span id="cb38-356"><a href="#cb38-356"></a></span>
<span id="cb38-357"><a href="#cb38-357"></a></span>
<span id="cb38-358"><a href="#cb38-358"></a>Causal inference requires a contrast between two conditions. The splits give us the conditions of a hypothetical experiment.</span>
<span id="cb38-359"><a href="#cb38-359"></a></span>
<span id="cb38-360"><a href="#cb38-360"></a></span>
<span id="cb38-361"><a href="#cb38-361"></a></span>
<span id="cb38-362"><a href="#cb38-362"></a><span class="in">```r</span></span>
<span id="cb38-363"><a href="#cb38-363"></a></span>
<span id="cb38-364"><a href="#cb38-364"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-365"><a href="#cb38-365"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb38-366"><a href="#cb38-366"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-367"><a href="#cb38-367"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-368"><a href="#cb38-368"></a><span class="co"># |    MODIFY THIS SECTION   |</span></span>
<span id="cb38-369"><a href="#cb38-369"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-370"><a href="#cb38-370"></a><span class="co"># define cutpoints</span></span>
<span id="cb38-371"><a href="#cb38-371"></a>cut_points <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>)</span>
<span id="cb38-372"><a href="#cb38-372"></a></span>
<span id="cb38-373"><a href="#cb38-373"></a><span class="co"># use later in positivity graph</span></span>
<span id="cb38-374"><a href="#cb38-374"></a>lower_cut <span class="ot">&lt;-</span> cut_points[[<span class="dv">1</span>]]</span>
<span id="cb38-375"><a href="#cb38-375"></a>upper_cut <span class="ot">&lt;-</span> cut_points[[<span class="dv">2</span>]]</span>
<span id="cb38-376"><a href="#cb38-376"></a>threshold <span class="ot">&lt;-</span> <span class="st">'&gt;'</span> <span class="co"># if upper</span></span>
<span id="cb38-377"><a href="#cb38-377"></a></span>
<span id="cb38-378"><a href="#cb38-378"></a><span class="co"># save for manuscript</span></span>
<span id="cb38-379"><a href="#cb38-379"></a><span class="fu">here_save</span>(lower_cut, <span class="st">"lower_cut"</span>)</span>
<span id="cb38-380"><a href="#cb38-380"></a><span class="fu">here_save</span>(upper_cut, <span class="st">"upper_cut"</span>)</span>
<span id="cb38-381"><a href="#cb38-381"></a><span class="fu">here_save</span>(threshold, <span class="st">"threshold"</span>)</span>
<span id="cb38-382"><a href="#cb38-382"></a></span>
<span id="cb38-383"><a href="#cb38-383"></a><span class="co"># make graph</span></span>
<span id="cb38-384"><a href="#cb38-384"></a>graph_cut <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_plot_categorical</span>(</span>
<span id="cb38-385"><a href="#cb38-385"></a>  dat_long_exposure,</span>
<span id="cb38-386"><a href="#cb38-386"></a>  <span class="at">col_name         =</span> name_exposure,</span>
<span id="cb38-387"><a href="#cb38-387"></a>  <span class="at">sd_multipliers =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>), <span class="co"># select to suit</span></span>
<span id="cb38-388"><a href="#cb38-388"></a>  <span class="co"># either use n_divisions for equal-sized groups:</span></span>
<span id="cb38-389"><a href="#cb38-389"></a>  <span class="co"># n_divisions      = 2,</span></span>
<span id="cb38-390"><a href="#cb38-390"></a>  <span class="co"># or use custom_breaks for specific values:</span></span>
<span id="cb38-391"><a href="#cb38-391"></a>  <span class="at">custom_breaks    =</span> cut_points,  <span class="co"># ** adjust as needed **</span></span>
<span id="cb38-392"><a href="#cb38-392"></a>  <span class="co"># could be "lower", no difference in this case, as no one == 4</span></span>
<span id="cb38-393"><a href="#cb38-393"></a>  <span class="at">cutpoint_inclusive =</span> <span class="st">"upper"</span>,</span>
<span id="cb38-394"><a href="#cb38-394"></a>  <span class="at">show_mean        =</span> <span class="cn">TRUE</span>,</span>
<span id="cb38-395"><a href="#cb38-395"></a>  <span class="at">show_median      =</span> <span class="cn">FALSE</span>,</span>
<span id="cb38-396"><a href="#cb38-396"></a>  <span class="at">show_sd          =</span> <span class="cn">TRUE</span></span>
<span id="cb38-397"><a href="#cb38-397"></a>)</span>
<span id="cb38-398"><a href="#cb38-398"></a><span class="fu">print</span>(graph_cut)</span>
<span id="cb38-399"><a href="#cb38-399"></a></span>
<span id="cb38-400"><a href="#cb38-400"></a><span class="co"># save your graph</span></span>
<span id="cb38-401"><a href="#cb38-401"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(graph_cut, <span class="st">"graph_cut"</span>, push_mods)</span>
<span id="cb38-402"><a href="#cb38-402"></a><span class="in">```</span></span>
<span id="cb38-403"><a href="#cb38-403"></a></span>
<span id="cb38-404"><a href="#cb38-404"></a>Ask: which break meaningfully separate groups into two exposure groups? Is the split *theoretically motivated**? adjust <span class="in">`custom_breaks`</span> until the answer is 'yes'. then commit:</span>
<span id="cb38-405"><a href="#cb38-405"></a></span>
<span id="cb38-406"><a href="#cb38-406"></a></span>
<span id="cb38-407"><a href="#cb38-407"></a><span class="in">```r</span></span>
<span id="cb38-408"><a href="#cb38-408"></a>dat_long_2 <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">create_ordered_variable</span>(</span>
<span id="cb38-409"><a href="#cb38-409"></a>  dat_long_1,</span>
<span id="cb38-410"><a href="#cb38-410"></a>  <span class="at">var_name           =</span> name_exposure,</span>
<span id="cb38-411"><a href="#cb38-411"></a>  <span class="at">custom_breaks      =</span> cut_points,  <span class="co"># ** -- adjust based on your decision above -- **</span></span>
<span id="cb38-412"><a href="#cb38-412"></a>  <span class="at">cutpoint_inclusive =</span> <span class="st">"upper"</span></span>
<span id="cb38-413"><a href="#cb38-413"></a>)s</span>
<span id="cb38-414"><a href="#cb38-414"></a><span class="in">```</span></span>
<span id="cb38-415"><a href="#cb38-415"></a></span>
<span id="cb38-416"><a href="#cb38-416"></a></span>
<span id="cb38-417"><a href="#cb38-417"></a></span>
<span id="cb38-418"><a href="#cb38-418"></a><span class="fu">#### Seven — save as you go.</span></span>
<span id="cb38-419"><a href="#cb38-419"></a></span>
<span id="cb38-420"><a href="#cb38-420"></a>Use <span class="in">`margot::here_save()`</span> (objects) and <span class="in">`here_save_qs()`</span> (large objects) right after you create something you’ll cite in your report. The convention keeps analysis, tables, and manuscript in sync.</span>
<span id="cb38-421"><a href="#cb38-421"></a></span>
<span id="cb38-422"><a href="#cb38-422"></a><span class="in">```r</span></span>
<span id="cb38-423"><a href="#cb38-423"></a><span class="fu">here_save</span>(dat_long_final,          <span class="st">"dat_long_final"</span>)</span>
<span id="cb38-424"><a href="#cb38-424"></a><span class="fu">here_save</span>(percent_missing_baseline,  <span class="st">"percent_missing_baseline"</span>)</span>
<span id="cb38-425"><a href="#cb38-425"></a><span class="in">```</span></span>
<span id="cb38-426"><a href="#cb38-426"></a></span>
<span id="cb38-427"><a href="#cb38-427"></a></span>
<span id="cb38-428"><a href="#cb38-428"></a><span class="fu">#### Remember to check the positivity assumption </span></span>
<span id="cb38-429"><a href="#cb38-429"></a></span>
<span id="cb38-430"><a href="#cb38-430"></a>Is there change between <span class="in">`t0_`</span> and <span class="in">`t1_`</span> in the exposure variable? </span>
<span id="cb38-431"><a href="#cb38-431"></a></span>
<span id="cb38-432"><a href="#cb38-432"></a><span class="in">```r</span></span>
<span id="cb38-433"><a href="#cb38-433"></a><span class="co"># create transition matrices to check positivity ----------------------------</span></span>
<span id="cb38-434"><a href="#cb38-434"></a><span class="co"># this helps assess whether there are sufficient observations in all exposure states</span></span>
<span id="cb38-435"><a href="#cb38-435"></a>dt_positivity <span class="ot">&lt;-</span> dat_long_final <span class="sc">|&gt;</span></span>
<span id="cb38-436"><a href="#cb38-436"></a>  <span class="fu">filter</span>(wave <span class="sc">%in%</span> <span class="fu">c</span>(baseline_wave, exposure_waves)) <span class="sc">|&gt;</span></span>
<span id="cb38-437"><a href="#cb38-437"></a>  <span class="fu">select</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_exposure), id, wave) <span class="sc">|&gt;</span></span>
<span id="cb38-438"><a href="#cb38-438"></a>  <span class="fu">mutate</span>(<span class="at">exposure =</span> <span class="fu">round</span>(<span class="fu">as.numeric</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_exposure)), <span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb38-439"><a href="#cb38-439"></a>  <span class="co"># create binary exposure based on cutpoint</span></span>
<span id="cb38-440"><a href="#cb38-440"></a>  <span class="fu">mutate</span>(<span class="at">exposure_binary =</span> <span class="fu">ifelse</span>(exposure <span class="sc">&gt;</span> upper_cut, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">|&gt;</span> <span class="co"># check</span></span>
<span id="cb38-441"><a href="#cb38-441"></a>  <span class="do">## *-- modify this --* </span></span>
<span id="cb38-442"><a href="#cb38-442"></a>  <span class="fu">mutate</span>(<span class="at">wave =</span> <span class="fu">as.numeric</span>(wave) <span class="sc">-</span><span class="dv">1</span> )</span>
<span id="cb38-443"><a href="#cb38-443"></a></span>
<span id="cb38-444"><a href="#cb38-444"></a><span class="co"># create transition tables</span></span>
<span id="cb38-445"><a href="#cb38-445"></a>transition_tables <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_transition_table</span>(</span>
<span id="cb38-446"><a href="#cb38-446"></a>  dt_positivity,</span>
<span id="cb38-447"><a href="#cb38-447"></a>  <span class="at">state_var =</span> <span class="st">"exposure"</span>,</span>
<span id="cb38-448"><a href="#cb38-448"></a>  <span class="at">id_var =</span> <span class="st">"id"</span>,</span>
<span id="cb38-449"><a href="#cb38-449"></a>  <span class="at">waves =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb38-450"><a href="#cb38-450"></a>  <span class="at">wave_var =</span> <span class="st">"wave"</span>,</span>
<span id="cb38-451"><a href="#cb38-451"></a>  <span class="at">table_name =</span> <span class="st">"transition_table"</span></span>
<span id="cb38-452"><a href="#cb38-452"></a>)</span>
<span id="cb38-453"><a href="#cb38-453"></a><span class="fu">print</span>(transition_tables<span class="sc">$</span>tables[[<span class="dv">1</span>]])</span>
<span id="cb38-454"><a href="#cb38-454"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(transition_tables, <span class="st">"transition_tables"</span>, push_mods)</span>
<span id="cb38-455"><a href="#cb38-455"></a></span>
<span id="cb38-456"><a href="#cb38-456"></a><span class="co"># create binary transition tables</span></span>
<span id="cb38-457"><a href="#cb38-457"></a>transition_tables_binary <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_transition_table</span>(</span>
<span id="cb38-458"><a href="#cb38-458"></a>  dt_positivity,</span>
<span id="cb38-459"><a href="#cb38-459"></a>  <span class="at">state_var =</span> <span class="st">"exposure_binary"</span>,</span>
<span id="cb38-460"><a href="#cb38-460"></a>  <span class="at">id_var =</span> <span class="st">"id"</span>,</span>
<span id="cb38-461"><a href="#cb38-461"></a>  <span class="at">waves =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb38-462"><a href="#cb38-462"></a>  <span class="at">wave_var =</span> <span class="st">"wave"</span>,</span>
<span id="cb38-463"><a href="#cb38-463"></a>  <span class="at">table_name =</span> <span class="st">"transition_table_binary"</span></span>
<span id="cb38-464"><a href="#cb38-464"></a>)</span>
<span id="cb38-465"><a href="#cb38-465"></a><span class="fu">print</span>(transition_tables_binary<span class="sc">$</span>tables[[<span class="dv">1</span>]])</span>
<span id="cb38-466"><a href="#cb38-466"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(transition_tables_binary, <span class="st">"transition_tables_binary"</span>, push_mods)</span>
<span id="cb38-467"><a href="#cb38-467"></a></span>
<span id="cb38-468"><a href="#cb38-468"></a><span class="in">```</span></span>
<span id="cb38-469"><a href="#cb38-469"></a></span>
<span id="cb38-470"><a href="#cb38-470"></a></span>
<span id="cb38-471"><a href="#cb38-471"></a><span class="fu">#### Take-away: Think about the hypothetical experiment you wish to perform with observational data. </span></span>
<span id="cb38-472"><a href="#cb38-472"></a></span>
<span id="cb38-473"><a href="#cb38-473"></a>Decide early (exposure, cut-point, outcomes, waves), *checkpoint* everything with <span class="in">`here_save()`</span>, and the rest of the pipeline flows.</span>
<span id="cb38-474"><a href="#cb38-474"></a></span>
<span id="cb38-475"><a href="#cb38-475"></a></span>
<span id="cb38-476"><a href="#cb38-476"></a><span class="fu">### Script 2: Prepare Final Wide Data</span></span>
<span id="cb38-477"><a href="#cb38-477"></a></span>
<span id="cb38-478"><a href="#cb38-478"></a>**Purpose**  </span>
<span id="cb38-479"><a href="#cb38-479"></a></span>
<span id="cb38-480"><a href="#cb38-480"></a>Convert the tidy long data into a grf-ready wide matrix and correct for dropout bias with inverse-probability-of-censoring weighting (IPCW).</span>
<span id="cb38-481"><a href="#cb38-481"></a></span>
<span id="cb38-482"><a href="#cb38-482"></a><span class="fu">#### Step 1 – go wide automatically</span></span>
<span id="cb38-483"><a href="#cb38-483"></a></span>
<span id="cb38-484"><a href="#cb38-484"></a><span class="in">`margot_wide_machine()`</span> reshapes each wave into <span class="in">`t0_`</span>, <span class="in">`t1_`</span>, <span class="in">`t2_`</span> columns. You gave it all the names in script 1, so no new choices here. Inspect <span class="in">`df_wide`</span> just to be sure the columns look sensible (baseline before exposure before outcome).</span>
<span id="cb38-485"><a href="#cb38-485"></a></span>
<span id="cb38-486"><a href="#cb38-486"></a></span>
<span id="cb38-487"><a href="#cb38-487"></a><span class="in">```r</span></span>
<span id="cb38-488"><a href="#cb38-488"></a><span class="fu">colnames</span>(df_wide)</span>
<span id="cb38-489"><a href="#cb38-489"></a>naniar<span class="sc">::</span><span class="fu">vis_miss</span>(df_wide)</span>
<span id="cb38-490"><a href="#cb38-490"></a><span class="in">```</span></span>
<span id="cb38-491"><a href="#cb38-491"></a></span>
<span id="cb38-492"><a href="#cb38-492"></a><span class="fu">#### Step 2 – Encode + scale for algorithms</span></span>
<span id="cb38-493"><a href="#cb38-493"></a></span>
<span id="cb38-494"><a href="#cb38-494"></a><span class="in">`margot_process_longitudinal_data_wider()`</span> turns factors into dummies, scales continuous variables, and appends loss-to-follow-up flags. The result is <span class="in">`df_wide_encoded`</span>.  </span>
<span id="cb38-495"><a href="#cb38-495"></a></span>
<span id="cb38-496"><a href="#cb38-496"></a>Quick sanity check: the exposure binaries should be <span class="in">`0/1`</span> and their <span class="in">`NA`</span>s must match the *_lost* indicators.</span>
<span id="cb38-497"><a href="#cb38-497"></a></span>
<span id="cb38-498"><a href="#cb38-498"></a><span class="in">```r</span></span>
<span id="cb38-499"><a href="#cb38-499"></a><span class="fu">table</span>(df_wide_encoded<span class="sc">$</span>t0_not_lost_following_wave)</span>
<span id="cb38-500"><a href="#cb38-500"></a><span class="in">```</span></span>
<span id="cb38-501"><a href="#cb38-501"></a></span>
<span id="cb38-502"><a href="#cb38-502"></a></span>
<span id="cb38-503"><a href="#cb38-503"></a><span class="fu">#### Step 3 – Build IPCW weights*</span></span>
<span id="cb38-504"><a href="#cb38-504"></a></span>
<span id="cb38-505"><a href="#cb38-505"></a></span>
<span id="cb38-506"><a href="#cb38-506"></a>**Why?** observations that resemble those who dropped out are up-weighted, so estimates stay unbiased when data vanish.</span>
<span id="cb38-507"><a href="#cb38-507"></a></span>
<span id="cb38-508"><a href="#cb38-508"></a></span>
<span id="cb38-509"><a href="#cb38-509"></a></span>
<span id="cb38-510"><a href="#cb38-510"></a><span class="fu">#### Step 4 – drop the censored </span></span>
<span id="cb38-511"><a href="#cb38-511"></a>Rows with <span class="in">`*_lost_following_wave == 1`</span> are removed, leaving <span class="in">`df_grf`</span>. This dataset feeds the causal forest and should now have **no missing values** in any <span class="in">`t1_`</span> or <span class="in">`t2_`</span> column. Missingness is permitted in <span class="in">`t0_`</span> columns</span>
<span id="cb38-512"><a href="#cb38-512"></a></span>
<span id="cb38-513"><a href="#cb38-513"></a><span class="in">```r</span></span>
<span id="cb38-514"><a href="#cb38-514"></a>naniar<span class="sc">::</span><span class="fu">vis_miss</span>(df_grf)  </span>
<span id="cb38-515"><a href="#cb38-515"></a><span class="in">```</span></span>
<span id="cb38-516"><a href="#cb38-516"></a></span>
<span id="cb38-517"><a href="#cb38-517"></a><span class="al">![Graph of Missingness in Final Cleaned Dataset, time is ordered left (early) to right (late), no missing values in outcomes, missingness permitted for baseline variables](../laboratory/missing_final_data_plot.jpg)</span>{width=100%}</span>
<span id="cb38-518"><a href="#cb38-518"></a></span>
<span id="cb38-519"><a href="#cb38-519"></a></span>
<span id="cb38-520"><a href="#cb38-520"></a><span class="fu">#### Step 5 – checkpoint everything</span></span>
<span id="cb38-521"><a href="#cb38-521"></a></span>
<span id="cb38-522"><a href="#cb38-522"></a>Each major object (<span class="in">`df_wide`</span>, <span class="in">`df_wide_encoded`</span>, <span class="in">`df_grf`</span>, the weight vectors) is saved with <span class="in">`here_save()`</span> or <span class="in">`here_save_qs()`</span>. this keeps the analysis reproducible and the manuscript tables in sync.</span>
<span id="cb38-523"><a href="#cb38-523"></a></span>
<span id="cb38-524"><a href="#cb38-524"></a></span>
<span id="cb38-525"><a href="#cb38-525"></a><span class="fu">#### Takeaway: what you must do</span></span>
<span id="cb38-526"><a href="#cb38-526"></a></span>
<span id="cb38-527"><a href="#cb38-527"></a><span class="ss">1. </span>**Run the script without edits.**  </span>
<span id="cb38-528"><a href="#cb38-528"></a><span class="ss">2. </span>confirm <span class="in">`df_grf`</span> has the expected number of rows and no missing cells.</span>
<span id="cb38-529"><a href="#cb38-529"></a></span>
<span id="cb38-530"><a href="#cb38-530"></a></span>
<span id="cb38-531"><a href="#cb38-531"></a>Script 2 is a conveyor belt: long $\to$ wide  $\to$ weighted  $\to$ clean. yYur only job is to eyeball the parcels before they roll into the modelling bay.</span>
<span id="cb38-532"><a href="#cb38-532"></a></span>
<span id="cb38-533"><a href="#cb38-533"></a></span>
<span id="cb38-534"><a href="#cb38-534"></a></span>
<span id="cb38-535"><a href="#cb38-535"></a><span class="fu">### Script 3 The Analysis</span></span>
<span id="cb38-536"><a href="#cb38-536"></a></span>
<span id="cb38-537"><a href="#cb38-537"></a></span>
<span id="cb38-538"><a href="#cb38-538"></a><span class="fu">#### 1 Reproducibility scaffold  </span></span>
<span id="cb38-539"><a href="#cb38-539"></a></span>
<span id="cb38-540"><a href="#cb38-540"></a><span class="in">```r</span></span>
<span id="cb38-541"><a href="#cb38-541"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)                 <span class="co"># lock randomness  </span></span>
<span id="cb38-542"><a href="#cb38-542"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(margot, qs …)  <span class="co"># load every tool once  </span></span>
<span id="cb38-543"><a href="#cb38-543"></a><span class="in">```</span></span>
<span id="cb38-544"><a href="#cb38-544"></a>No choices here—just **run** and move on.</span>
<span id="cb38-545"><a href="#cb38-545"></a></span>
<span id="cb38-546"><a href="#cb38-546"></a></span>
<span id="cb38-547"><a href="#cb38-547"></a></span>
<span id="cb38-548"><a href="#cb38-548"></a><span class="fu">#### 2 Pull in prepared objects  </span></span>
<span id="cb38-549"><a href="#cb38-549"></a></span>
<span id="cb38-550"><a href="#cb38-550"></a><span class="in">```r</span></span>
<span id="cb38-551"><a href="#cb38-551"></a>df_grf           <span class="ot">&lt;-</span> <span class="fu">here_read</span>(<span class="st">"df_grf"</span>)     <span class="co"># wide, weighted data  </span></span>
<span id="cb38-552"><a href="#cb38-552"></a>name_exposure    <span class="ot">&lt;-</span> <span class="fu">here_read</span>(<span class="st">"name_exposure"</span>)  </span>
<span id="cb38-553"><a href="#cb38-553"></a><span class="in">```</span></span>
<span id="cb38-554"><a href="#cb38-554"></a></span>
<span id="cb38-555"><a href="#cb38-555"></a>If anything is <span class="in">`NULL`</span>, return to scripts 1–2 and debug.</span>
<span id="cb38-556"><a href="#cb38-556"></a></span>
<span id="cb38-557"><a href="#cb38-557"></a></span>
<span id="cb38-558"><a href="#cb38-558"></a></span>
<span id="cb38-559"><a href="#cb38-559"></a><span class="fu">#### 3 Sanity-check with a toy forest  </span></span>
<span id="cb38-560"><a href="#cb38-560"></a></span>
<span id="cb38-561"><a href="#cb38-561"></a>Fit one outcome on ¼ of the data to confirm the pipeline before burning CPU hours.</span>
<span id="cb38-562"><a href="#cb38-562"></a></span>
<span id="cb38-563"><a href="#cb38-563"></a><span class="in">```r</span></span>
<span id="cb38-564"><a href="#cb38-564"></a>cf_out <span class="ot">&lt;-</span> <span class="fu">margot_causal_forest</span>(</span>
<span id="cb38-565"><a href="#cb38-565"></a>  <span class="at">data         =</span> df_grf[<span class="fu">sample</span>(<span class="fu">nrow</span>(df_grf), <span class="fu">nrow</span>(df_grf)<span class="sc">/</span><span class="dv">4</span>), ],</span>
<span id="cb38-566"><a href="#cb38-566"></a>  <span class="at">outcome_vars =</span> <span class="st">"t2_kessler_latent_depression_z"</span>,</span>
<span id="cb38-567"><a href="#cb38-567"></a>  <span class="at">covariates   =</span> X,           <span class="co"># baseline covariates E</span></span>
<span id="cb38-568"><a href="#cb38-568"></a>  <span class="at">W            =</span> W,           <span class="co"># exposure</span></span>
<span id="cb38-569"><a href="#cb38-569"></a>  <span class="at">weights      =</span> weights</span>
<span id="cb38-570"><a href="#cb38-570"></a>)</span>
<span id="cb38-571"><a href="#cb38-571"></a><span class="fu">margot_plot_policy_combo</span>(cf_out, <span class="at">max_depth =</span> <span class="dv">1</span>L)</span>
<span id="cb38-572"><a href="#cb38-572"></a><span class="in">```</span></span>
<span id="cb38-573"><a href="#cb38-573"></a></span>
<span id="cb38-574"><a href="#cb38-574"></a>Success = a plot appears without errors.</span>
<span id="cb38-575"><a href="#cb38-575"></a></span>
<span id="cb38-576"><a href="#cb38-576"></a></span>
<span id="cb38-577"><a href="#cb38-577"></a><span class="fu">#### 4 Full model batches + ATE tables  </span></span>
<span id="cb38-578"><a href="#cb38-578"></a></span>
<span id="cb38-579"><a href="#cb38-579"></a>Loop over the five outcome domains, saving each model to <span class="in">`models_example_2/`</span>.</span>
<span id="cb38-580"><a href="#cb38-580"></a></span>
<span id="cb38-581"><a href="#cb38-581"></a><span class="in">```r</span></span>
<span id="cb38-582"><a href="#cb38-582"></a>models_binary <span class="ot">&lt;-</span> <span class="fu">margot_causal_forest</span>(</span>
<span id="cb38-583"><a href="#cb38-583"></a>  <span class="at">data =</span> df_grf,</span>
<span id="cb38-584"><a href="#cb38-584"></a>  <span class="at">outcome_vars =</span> t2_outcome_z,</span>
<span id="cb38-585"><a href="#cb38-585"></a>  <span class="at">covariates   =</span> X, <span class="at">W =</span> W, <span class="at">weights =</span> weights,</span>
<span id="cb38-586"><a href="#cb38-586"></a>  <span class="at">save_models  =</span> <span class="cn">TRUE</span>, <span class="at">save_data =</span> <span class="cn">TRUE</span></span>
<span id="cb38-587"><a href="#cb38-587"></a>)</span>
<span id="cb38-588"><a href="#cb38-588"></a><span class="fu">here_save_qs</span>(models_binary_health, <span class="st">"models_binary"</span>)</span>
<span id="cb38-589"><a href="#cb38-589"></a><span class="in">```</span></span>
<span id="cb38-590"><a href="#cb38-590"></a></span>
<span id="cb38-591"><a href="#cb38-591"></a>Then create ATE plots and interpretations with <span class="in">`margot_plot()`</span>.  Save as these go straight into the manuscript.</span>
<span id="cb38-592"><a href="#cb38-592"></a></span>
<span id="cb38-593"><a href="#cb38-593"></a></span>
<span id="cb38-594"><a href="#cb38-594"></a></span>
<span id="cb38-595"><a href="#cb38-595"></a><span class="fu">#### 5 Heterogeneous Treatment Effects (CATE)  </span></span>
<span id="cb38-596"><a href="#cb38-596"></a></span>
<span id="cb38-597"><a href="#cb38-597"></a>*Evidence phase*  </span>
<span id="cb38-598"><a href="#cb38-598"></a></span>
<span id="cb38-599"><a href="#cb38-599"></a><span class="ss">-   </span>**RATE AUTOC** &amp; **Qini curves** via <span class="in">`margot_rate()`</span> and <span class="in">`margot_inspect_qini()`</span> flag outcomes with meaningful heterogeneity.  </span>
<span id="cb38-600"><a href="#cb38-600"></a></span>
<span id="cb38-601"><a href="#cb38-601"></a>*Action phase*  </span>
<span id="cb38-602"><a href="#cb38-602"></a></span>
<span id="cb38-603"><a href="#cb38-603"></a><span class="ss">-  </span>**Flip** outcomes you want to *minimise* (e.g. depression) so positive CATE = good.  </span>
<span id="cb38-604"><a href="#cb38-604"></a></span>
<span id="cb38-605"><a href="#cb38-605"></a><span class="in">```r</span></span>
<span id="cb38-606"><a href="#cb38-606"></a><span class="co"># flipping models: outcomes we want to minimise given the exposure --------</span></span>
<span id="cb38-607"><a href="#cb38-607"></a><span class="co"># standard negative outcomes/  not used in this example</span></span>
<span id="cb38-608"><a href="#cb38-608"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-609"><a href="#cb38-609"></a><span class="co"># |    MODIFY THIS           |</span></span>
<span id="cb38-610"><a href="#cb38-610"></a><span class="co"># +--------------------------+</span></span>
<span id="cb38-611"><a href="#cb38-611"></a>flip_outcomes_standard <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb38-612"><a href="#cb38-612"></a>  <span class="co">#"t2_alcohol_frequency_weekly_z",</span></span>
<span id="cb38-613"><a href="#cb38-613"></a>  <span class="co">#"t2_alcohol_intensity_z",</span></span>
<span id="cb38-614"><a href="#cb38-614"></a>  <span class="co">#"t2_hlth_bmi_z",</span></span>
<span id="cb38-615"><a href="#cb38-615"></a>  <span class="co">#"t2_hlth_fatigue_z",</span></span>
<span id="cb38-616"><a href="#cb38-616"></a>  <span class="st">"t2_kessler_latent_anxiety_z"</span>, <span class="co">#  ← select</span></span>
<span id="cb38-617"><a href="#cb38-617"></a>  <span class="st">"t2_kessler_latent_depression_z"</span>,<span class="co">#  ← select</span></span>
<span id="cb38-618"><a href="#cb38-618"></a>  <span class="st">"t2_rumination_z"</span> <span class="co">#  ← select</span></span>
<span id="cb38-619"><a href="#cb38-619"></a>  <span class="co">#"t2_perfectionism_z" # the exposure variable was not investigated</span></span>
<span id="cb38-620"><a href="#cb38-620"></a>)</span>
<span id="cb38-621"><a href="#cb38-621"></a></span>
<span id="cb38-622"><a href="#cb38-622"></a><span class="co"># when exposure is negative and you want to focus on how much worse off</span></span>
<span id="cb38-623"><a href="#cb38-623"></a><span class="co"># some people are use this: </span></span>
<span id="cb38-624"><a href="#cb38-624"></a><span class="co"># flip_outcomes&lt;- c( setdiff(t2_outcomes_all, flip_outcomes_standard) )</span></span>
<span id="cb38-625"><a href="#cb38-625"></a></span>
<span id="cb38-626"><a href="#cb38-626"></a><span class="co"># our example has the exposure as positive</span></span>
<span id="cb38-627"><a href="#cb38-627"></a>flip_outcomes <span class="ot">&lt;-</span> flip_outcomes_standard</span>
<span id="cb38-628"><a href="#cb38-628"></a><span class="in">```</span></span>
<span id="cb38-629"><a href="#cb38-629"></a></span>
<span id="cb38-630"><a href="#cb38-630"></a>Don't forget to get and save the labels for these models:</span>
<span id="cb38-631"><a href="#cb38-631"></a></span>
<span id="cb38-632"><a href="#cb38-632"></a><span class="in">```r</span></span>
<span id="cb38-633"><a href="#cb38-633"></a><span class="co"># get labels</span></span>
<span id="cb38-634"><a href="#cb38-634"></a>flipped_names <span class="ot">&lt;-</span> <span class="fu">margot_get_labels</span>(flip_outcomes, label_mapping_all)</span>
<span id="cb38-635"><a href="#cb38-635"></a></span>
<span id="cb38-636"><a href="#cb38-636"></a><span class="co"># check</span></span>
<span id="cb38-637"><a href="#cb38-637"></a>flipped_names</span>
<span id="cb38-638"><a href="#cb38-638"></a></span>
<span id="cb38-639"><a href="#cb38-639"></a><span class="co"># save for publication</span></span>
<span id="cb38-640"><a href="#cb38-640"></a><span class="fu">here_save</span>(flipped_names, <span class="st">"flipped_names"</span>)</span>
<span id="cb38-641"><a href="#cb38-641"></a><span class="in">```</span></span>
<span id="cb38-642"><a href="#cb38-642"></a></span>
<span id="cb38-643"><a href="#cb38-643"></a><span class="ss">-  </span>Fit **policy trees** (<span class="in">`margot_policy()`</span>, <span class="in">`max_depth = 2L`</span>) to discover actionable rules.  </span>
<span id="cb38-644"><a href="#cb38-644"></a></span>
<span id="cb38-645"><a href="#cb38-645"></a><span class="ss">- </span>Depth-1 trees are often trivial; depth-2 gives interpretable nuance.</span>
<span id="cb38-646"><a href="#cb38-646"></a></span>
<span id="cb38-647"><a href="#cb38-647"></a>Check that every split variable exists in the original data and that leaves map sensibly onto subgroups (no cells with &lt; 30 observations).</span>
<span id="cb38-648"><a href="#cb38-648"></a></span>
<span id="cb38-649"><a href="#cb38-649"></a></span>
<span id="cb38-650"><a href="#cb38-650"></a>Key workflow is: </span>
<span id="cb38-651"><a href="#cb38-651"></a></span>
<span id="cb38-652"><a href="#cb38-652"></a><span class="in">```r</span></span>
<span id="cb38-653"><a href="#cb38-653"></a><span class="co"># run the margot_policy function</span></span>
<span id="cb38-654"><a href="#cb38-654"></a><span class="co"># policy tree analysis depth 2L -------------------------------------------------</span></span>
<span id="cb38-655"><a href="#cb38-655"></a><span class="co"># make policy trees</span></span>
<span id="cb38-656"><a href="#cb38-656"></a><span class="co"># *** 2l is much more persuasive ***</span></span>
<span id="cb38-657"><a href="#cb38-657"></a>plots_policy_trees_2L <span class="ot">&lt;-</span> <span class="fu">margot_policy</span>(</span>
<span id="cb38-658"><a href="#cb38-658"></a>  models_binary_flipped_all,</span>
<span id="cb38-659"><a href="#cb38-659"></a>  <span class="at">save_plots =</span> <span class="cn">FALSE</span>,</span>
<span id="cb38-660"><a href="#cb38-660"></a>  <span class="at">output_dir =</span> here<span class="sc">::</span><span class="fu">here</span>(push_mods),</span>
<span id="cb38-661"><a href="#cb38-661"></a>  <span class="at">decision_tree_args =</span> decision_tree_defaults,</span>
<span id="cb38-662"><a href="#cb38-662"></a>  <span class="at">policy_tree_args =</span> policy_tree_defaults,</span>
<span id="cb38-663"><a href="#cb38-663"></a>  <span class="at">model_names =</span> rate_interpretation_all<span class="sc">$</span>either_model_names,</span>
<span id="cb38-664"><a href="#cb38-664"></a>  <span class="co"># defined above</span></span>
<span id="cb38-665"><a href="#cb38-665"></a>  <span class="at">original_df =</span> original_df,</span>
<span id="cb38-666"><a href="#cb38-666"></a>  <span class="at">label_mapping =</span> label_mapping_all,</span>
<span id="cb38-667"><a href="#cb38-667"></a>  <span class="at">max_depth =</span> <span class="dv">2</span>L</span>
<span id="cb38-668"><a href="#cb38-668"></a>)</span>
<span id="cb38-669"><a href="#cb38-669"></a></span>
<span id="cb38-670"><a href="#cb38-670"></a>n_models <span class="ot">&lt;-</span> <span class="fu">length</span>(rate_interpretation_all<span class="sc">$</span>either_model_names)</span>
<span id="cb38-671"><a href="#cb38-671"></a></span>
<span id="cb38-672"><a href="#cb38-672"></a>model_outputs_2L <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span>n_models, <span class="sc">~</span>plots_policy_trees_2L[[.x]][[<span class="dv">3</span>]])</span>
<span id="cb38-673"><a href="#cb38-673"></a><span class="fu">names</span>(model_outputs_2L) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"model_"</span>, <span class="dv">1</span><span class="sc">:</span>n_models)</span>
<span id="cb38-674"><a href="#cb38-674"></a></span>
<span id="cb38-675"><a href="#cb38-675"></a><span class="co"># view plots (three in this example)</span></span>
<span id="cb38-676"><a href="#cb38-676"></a>model_outputs_2L<span class="sc">$</span>model_1</span>
<span id="cb38-677"><a href="#cb38-677"></a>model_outputs_2L<span class="sc">$</span>model_2</span>
<span id="cb38-678"><a href="#cb38-678"></a>model_outputs_2L<span class="sc">$</span>model_3</span>
<span id="cb38-679"><a href="#cb38-679"></a><span class="in">```</span></span>
<span id="cb38-680"><a href="#cb38-680"></a></span>
<span id="cb38-681"><a href="#cb38-681"></a></span>
<span id="cb38-682"><a href="#cb38-682"></a>You get the interpretation with this: </span>
<span id="cb38-683"><a href="#cb38-683"></a></span>
<span id="cb38-684"><a href="#cb38-684"></a><span class="in">```r</span></span>
<span id="cb38-685"><a href="#cb38-685"></a>interpret_plots_policy_trees_2L <span class="ot">&lt;-</span> <span class="fu">margot_interpret_policy_batch</span>(</span>
<span id="cb38-686"><a href="#cb38-686"></a>  models_binary_flipped_all, <span class="at">model_names =</span> rate_interpretation_all<span class="sc">$</span>either_model_names)</span>
<span id="cb38-687"><a href="#cb38-687"></a><span class="in">```</span></span>
<span id="cb38-688"><a href="#cb38-688"></a></span>
<span id="cb38-689"><a href="#cb38-689"></a></span>
<span id="cb38-690"><a href="#cb38-690"></a>If you were wanting to evaluate all models qualitatively, with appropriate caution you could use this code, </span>
<span id="cb38-691"><a href="#cb38-691"></a>**BUT** warn your audience and inspect results to see if the predictive plots capture well-defined subgroups.</span>
<span id="cb38-692"><a href="#cb38-692"></a></span>
<span id="cb38-693"><a href="#cb38-693"></a></span>
<span id="cb38-694"><a href="#cb38-694"></a><span class="in">```r</span></span>
<span id="cb38-695"><a href="#cb38-695"></a><span class="co"># ALL model 2L</span></span>
<span id="cb38-696"><a href="#cb38-696"></a>all_plots_policy_trees_2L <span class="ot">&lt;-</span> <span class="fu">margot_policy</span>(</span>
<span id="cb38-697"><a href="#cb38-697"></a>  models_binary_flipped_all,</span>
<span id="cb38-698"><a href="#cb38-698"></a>  <span class="at">save_plots =</span> <span class="cn">FALSE</span>,</span>
<span id="cb38-699"><a href="#cb38-699"></a>  <span class="at">output_dir =</span> here<span class="sc">::</span><span class="fu">here</span>(push_mods),</span>
<span id="cb38-700"><a href="#cb38-700"></a>  <span class="at">decision_tree_args =</span> decision_tree_defaults,</span>
<span id="cb38-701"><a href="#cb38-701"></a>  <span class="at">policy_tree_args =</span> policy_tree_defaults,</span>
<span id="cb38-702"><a href="#cb38-702"></a>  <span class="co"># model_names = rate_interpretation_all$either_model_names, # use all</span></span>
<span id="cb38-703"><a href="#cb38-703"></a>  <span class="co"># defined above</span></span>
<span id="cb38-704"><a href="#cb38-704"></a>  <span class="at">original_df =</span> original_df,</span>
<span id="cb38-705"><a href="#cb38-705"></a>  <span class="at">label_mapping =</span> label_mapping_all,</span>
<span id="cb38-706"><a href="#cb38-706"></a>  <span class="at">max_depth =</span> <span class="dv">2</span>L</span>
<span id="cb38-707"><a href="#cb38-707"></a>)</span>
<span id="cb38-708"><a href="#cb38-708"></a>n_models_all <span class="ot">&lt;-</span> <span class="fu">length</span>(models_binary_flipped_all<span class="sc">$</span>results)</span>
<span id="cb38-709"><a href="#cb38-709"></a>n_models_all</span>
<span id="cb38-710"><a href="#cb38-710"></a></span>
<span id="cb38-711"><a href="#cb38-711"></a>model_outputs_2L_all <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span>n_models_all, <span class="sc">~</span>all_plots_policy_trees_2L[[.x]][[<span class="dv">3</span>]])</span>
<span id="cb38-712"><a href="#cb38-712"></a><span class="fu">names</span>(model_outputs_2L_all) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"model_"</span>, <span class="dv">1</span><span class="sc">:</span>n_models_all)</span>
<span id="cb38-713"><a href="#cb38-713"></a></span>
<span id="cb38-714"><a href="#cb38-714"></a><span class="co"># view</span></span>
<span id="cb38-715"><a href="#cb38-715"></a>model_outputs_2L_all<span class="sc">$</span>model_1 <span class="co"># ← convincing? </span></span>
<span id="cb38-716"><a href="#cb38-716"></a>model_outputs_2L_all<span class="sc">$</span>model_2 <span class="co"># ← convincing? </span></span>
<span id="cb38-717"><a href="#cb38-717"></a>model_outputs_2L_all<span class="sc">$</span>model_3 <span class="co"># ← convincing? </span></span>
<span id="cb38-718"><a href="#cb38-718"></a>model_outputs_2L_all<span class="sc">$</span>model_4 <span class="co"># ← convincing? </span></span>
<span id="cb38-719"><a href="#cb38-719"></a>model_outputs_2L_all<span class="sc">$</span>model_5 <span class="co"># ← convincing? </span></span>
<span id="cb38-720"><a href="#cb38-720"></a>model_outputs_2L_all<span class="sc">$</span>model_6 <span class="co"># ← convincing? </span></span>
<span id="cb38-721"><a href="#cb38-721"></a>model_outputs_2L_all<span class="sc">$</span>model_7 <span class="co"># ← convincing? </span></span>
<span id="cb38-722"><a href="#cb38-722"></a>model_outputs_2L_all<span class="sc">$</span>model_8 <span class="co"># ← convincing? </span></span>
<span id="cb38-723"><a href="#cb38-723"></a>model_outputs_2L_all<span class="sc">$</span>model_9 <span class="co"># ← convincing?  </span></span>
<span id="cb38-724"><a href="#cb38-724"></a>model_outputs_2L_all<span class="sc">$</span>model_10 <span class="co"># ← convincing? </span></span>
<span id="cb38-725"><a href="#cb38-725"></a>model_outputs_2L_all<span class="sc">$</span>model_11 <span class="co"># ← convincing? </span></span>
<span id="cb38-726"><a href="#cb38-726"></a>model_outputs_2L_all<span class="sc">$</span>model_12 <span class="co"># ← convincing? </span></span>
<span id="cb38-727"><a href="#cb38-727"></a></span>
<span id="cb38-728"><a href="#cb38-728"></a><span class="in">```</span></span>
<span id="cb38-729"><a href="#cb38-729"></a></span>
<span id="cb38-730"><a href="#cb38-730"></a>And then to interpret:</span>
<span id="cb38-731"><a href="#cb38-731"></a></span>
<span id="cb38-732"><a href="#cb38-732"></a><span class="in">```r</span></span>
<span id="cb38-733"><a href="#cb38-733"></a><span class="co"># interpretation</span></span>
<span id="cb38-734"><a href="#cb38-734"></a>interpret_plots_policy_trees_2L_all <span class="ot">&lt;-</span> <span class="fu">margot_interpret_policy_batch</span>(models_binary_flipped_all, <span class="at">max_depth =</span> <span class="dv">2</span>)</span>
<span id="cb38-735"><a href="#cb38-735"></a></span>
<span id="cb38-736"><a href="#cb38-736"></a><span class="co"># view interpretation</span></span>
<span id="cb38-737"><a href="#cb38-737"></a><span class="fu">cat</span>(interpret_plots_policy_trees_2L_all)</span>
<span id="cb38-738"><a href="#cb38-738"></a><span class="in">```</span></span>
<span id="cb38-739"><a href="#cb38-739"></a></span>
<span id="cb38-740"><a href="#cb38-740"></a>*Note that we do not save these outputs for the mansuscript.  We will instead re-generate the graphs and interpretations when we import results into the quarto result template.  We'll cover this part of the workflow in the remaining weeks. </span>
<span id="cb38-741"><a href="#cb38-741"></a></span>
<span id="cb38-742"><a href="#cb38-742"></a></span>
<span id="cb38-743"><a href="#cb38-743"></a><span class="fu">#### 6 Report subgroup analyses (optional)  </span></span>
<span id="cb38-744"><a href="#cb38-744"></a></span>
<span id="cb38-745"><a href="#cb38-745"></a>When theory predicts effect modification—age bands, income thirds, etc.—use <span class="in">`margot_planned_subgroups_batch()`</span>. The helper auto-generates tables and mini-plots; just pass the subset definitions you crafted:</span>
<span id="cb38-746"><a href="#cb38-746"></a></span>
<span id="cb38-747"><a href="#cb38-747"></a>First we need to set up continitions for continuous variables, like this: </span>
<span id="cb38-748"><a href="#cb38-748"></a></span>
<span id="cb38-749"><a href="#cb38-749"></a><span class="in">```r</span></span>
<span id="cb38-750"><a href="#cb38-750"></a><span class="co"># step 1 get information for wealth for conditonal comparisons</span></span>
<span id="cb38-751"><a href="#cb38-751"></a><span class="fu">head</span>(df_grf<span class="sc">$</span>t0_log_household_inc_z)</span>
<span id="cb38-752"><a href="#cb38-752"></a></span>
<span id="cb38-753"><a href="#cb38-753"></a><span class="co"># get mean on original data scale</span></span>
<span id="cb38-754"><a href="#cb38-754"></a>log_mean_inc <span class="ot">&lt;-</span> <span class="fu">mean</span>(original_df<span class="sc">$</span>t0_log_household_inc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb38-755"><a href="#cb38-755"></a></span>
<span id="cb38-756"><a href="#cb38-756"></a><span class="co"># get sd on original data scale</span></span>
<span id="cb38-757"><a href="#cb38-757"></a>log_sd_inc <span class="ot">&lt;-</span> <span class="fu">sd</span>(original_df<span class="sc">$</span>t0_log_household_inc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb38-758"><a href="#cb38-758"></a></span>
<span id="cb38-759"><a href="#cb38-759"></a><span class="co"># function to get back to data scale</span></span>
<span id="cb38-760"><a href="#cb38-760"></a><span class="fu">margot_back_transform_log_z</span>(</span>
<span id="cb38-761"><a href="#cb38-761"></a>  <span class="at">log_mean =</span> log_mean_inc,</span>
<span id="cb38-762"><a href="#cb38-762"></a>  <span class="at">log_sd =</span> log_sd_inc,</span>
<span id="cb38-763"><a href="#cb38-763"></a>  <span class="at">z_scores =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb38-764"><a href="#cb38-764"></a>  <span class="at">label =</span> <span class="st">"data_scale"</span></span>
<span id="cb38-765"><a href="#cb38-765"></a>)</span>
<span id="cb38-766"><a href="#cb38-766"></a></span>
<span id="cb38-767"><a href="#cb38-767"></a><span class="co"># define complex conditions for subsetting</span></span>
<span id="cb38-768"><a href="#cb38-768"></a>complex_condition_political <span class="ot">&lt;-</span> X[, <span class="st">"t0_political_conservative_z"</span>] <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">&amp;</span></span>
<span id="cb38-769"><a href="#cb38-769"></a>  X[, <span class="st">"t0_political_conservative_z"</span>] <span class="sc">&lt;</span> <span class="dv">1</span></span>
<span id="cb38-770"><a href="#cb38-770"></a></span>
<span id="cb38-771"><a href="#cb38-771"></a>complex_condition_wealth <span class="ot">&lt;-</span> X[, <span class="st">"t0_log_household_inc_z"</span>] <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">&amp;</span></span>
<span id="cb38-772"><a href="#cb38-772"></a>  X[, <span class="st">"t0_log_household_inc_z"</span>] <span class="sc">&lt;</span> <span class="dv">1</span></span>
<span id="cb38-773"><a href="#cb38-773"></a></span>
<span id="cb38-774"><a href="#cb38-774"></a>complex_condition_age <span class="ot">&lt;-</span> X[, <span class="st">"t0_age_z"</span>] <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">&amp;</span></span>
<span id="cb38-775"><a href="#cb38-775"></a>  X[, <span class="st">"t0_age_z"</span>] <span class="sc">&lt;</span> <span class="dv">1</span></span>
<span id="cb38-776"><a href="#cb38-776"></a></span>
<span id="cb38-777"><a href="#cb38-777"></a><span class="co"># # if we have specific groups to compare</span></span>
<span id="cb38-778"><a href="#cb38-778"></a><span class="co"># complex_condition_age_under_neg_1_sd  &lt;- X[, "t0_age_z"] &lt; -1</span></span>
<span id="cb38-779"><a href="#cb38-779"></a><span class="co"># complex_condition_age_gr_eq_neg_1_sd  &lt;- X[, "t0_age_z"] &gt; -1</span></span>
<span id="cb38-780"><a href="#cb38-780"></a></span>
<span id="cb38-781"><a href="#cb38-781"></a><span class="co"># check ages to get number</span></span>
<span id="cb38-782"><a href="#cb38-782"></a><span class="fu">mean</span>(original_df<span class="sc">$</span>t0_age) <span class="sc">-</span> <span class="fu">sd</span>(original_df<span class="sc">$</span>t0_age)</span>
<span id="cb38-783"><a href="#cb38-783"></a><span class="fu">mean</span>(original_df<span class="sc">$</span>t0_age) <span class="sc">+</span> <span class="fu">sd</span>(original_df<span class="sc">$</span>t0_age)</span>
<span id="cb38-784"><a href="#cb38-784"></a></span>
<span id="cb38-785"><a href="#cb38-785"></a></span>
<span id="cb38-786"><a href="#cb38-786"></a><span class="co"># wealth subsets</span></span>
<span id="cb38-787"><a href="#cb38-787"></a>subsets_standard_wealth <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb38-788"><a href="#cb38-788"></a>  <span class="at">Poor =</span> <span class="fu">list</span>(</span>
<span id="cb38-789"><a href="#cb38-789"></a>    <span class="at">var =</span> <span class="st">"t0_log_household_inc_z"</span>,</span>
<span id="cb38-790"><a href="#cb38-790"></a>    <span class="at">value =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb38-791"><a href="#cb38-791"></a>    <span class="at">operator =</span> <span class="st">"&lt;"</span>,</span>
<span id="cb38-792"><a href="#cb38-792"></a>    <span class="at">description =</span> <span class="st">"Effects among those HShold income &lt; -1 SD (NZD ~41k)"</span>,</span>
<span id="cb38-793"><a href="#cb38-793"></a>    <span class="at">label =</span> <span class="st">"Poor"</span>  <span class="co"># label remains as is, but could be changed if desired</span></span>
<span id="cb38-794"><a href="#cb38-794"></a>  ),</span>
<span id="cb38-795"><a href="#cb38-795"></a>  <span class="at">MiddleIncome =</span> <span class="fu">list</span>(<span class="at">subset_condition =</span> complex_condition_wealth, <span class="at">description =</span> <span class="st">"Effects among those HS_hold income within +/-1SD (&gt; NZD 41k &lt; NZD 191k)"</span>),</span>
<span id="cb38-796"><a href="#cb38-796"></a>  <span class="at">Rich =</span> <span class="fu">list</span>(</span>
<span id="cb38-797"><a href="#cb38-797"></a>    <span class="at">var =</span> <span class="st">"t0_log_household_inc_z"</span>,</span>
<span id="cb38-798"><a href="#cb38-798"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb38-799"><a href="#cb38-799"></a>    <span class="at">operator =</span> <span class="st">"&gt;"</span>,</span>
<span id="cb38-800"><a href="#cb38-800"></a>    <span class="at">description =</span> <span class="st">"Effects among those HS_hold income &gt; +1 SD (NZD 191k)"</span>,</span>
<span id="cb38-801"><a href="#cb38-801"></a>    <span class="at">label =</span> <span class="st">"Rich"</span></span>
<span id="cb38-802"><a href="#cb38-802"></a>  )</span>
<span id="cb38-803"><a href="#cb38-803"></a>)</span>
<span id="cb38-804"><a href="#cb38-804"></a><span class="in">```</span></span>
<span id="cb38-805"><a href="#cb38-805"></a></span>
<span id="cb38-806"><a href="#cb38-806"></a>Or for categorical variables like this: </span>
<span id="cb38-807"><a href="#cb38-807"></a></span>
<span id="cb38-808"><a href="#cb38-808"></a><span class="in">```r</span></span>
<span id="cb38-809"><a href="#cb38-809"></a><span class="co"># ethnicity subsets</span></span>
<span id="cb38-810"><a href="#cb38-810"></a>subsets_standard_ethnicity <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb38-811"><a href="#cb38-811"></a>  <span class="at">Asian =</span> <span class="fu">list</span>(</span>
<span id="cb38-812"><a href="#cb38-812"></a>    <span class="at">var =</span> <span class="st">"t0_eth_cat_asian_binary"</span>,</span>
<span id="cb38-813"><a href="#cb38-813"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb38-814"><a href="#cb38-814"></a>    <span class="at">description =</span> <span class="st">"Asians"</span></span>
<span id="cb38-815"><a href="#cb38-815"></a>  ),</span>
<span id="cb38-816"><a href="#cb38-816"></a>  <span class="at">Euro =</span> <span class="fu">list</span>(</span>
<span id="cb38-817"><a href="#cb38-817"></a>    <span class="at">var =</span> <span class="st">"t0_eth_cat_euro_binary"</span>,</span>
<span id="cb38-818"><a href="#cb38-818"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb38-819"><a href="#cb38-819"></a>    <span class="at">description =</span> <span class="st">"Europeans (Pakeha)"</span></span>
<span id="cb38-820"><a href="#cb38-820"></a>  ),</span>
<span id="cb38-821"><a href="#cb38-821"></a>  <span class="at">Pacific =</span> <span class="fu">list</span>(</span>
<span id="cb38-822"><a href="#cb38-822"></a>    <span class="at">var =</span> <span class="st">"t0_eth_cat_pacific_binary"</span>,</span>
<span id="cb38-823"><a href="#cb38-823"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb38-824"><a href="#cb38-824"></a>    <span class="at">description =</span> <span class="st">"Pacific Peoples"</span></span>
<span id="cb38-825"><a href="#cb38-825"></a>  ),</span>
<span id="cb38-826"><a href="#cb38-826"></a>  <span class="at">Maori =</span> <span class="fu">list</span>(</span>
<span id="cb38-827"><a href="#cb38-827"></a>    <span class="at">var =</span> <span class="st">"t0_eth_cat_maori_binary"</span>,</span>
<span id="cb38-828"><a href="#cb38-828"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb38-829"><a href="#cb38-829"></a>    <span class="at">description =</span> <span class="st">"Māori"</span></span>
<span id="cb38-830"><a href="#cb38-830"></a>  )</span>
<span id="cb38-831"><a href="#cb38-831"></a>)</span>
<span id="cb38-832"><a href="#cb38-832"></a><span class="in">```</span></span>
<span id="cb38-833"><a href="#cb38-833"></a></span>
<span id="cb38-834"><a href="#cb38-834"></a>We set up subtypes like this: </span>
<span id="cb38-835"><a href="#cb38-835"></a></span>
<span id="cb38-836"><a href="#cb38-836"></a></span>
<span id="cb38-837"><a href="#cb38-837"></a><span class="in">```r</span></span>
<span id="cb38-838"><a href="#cb38-838"></a><span class="co"># set up subset types in a list</span></span>
<span id="cb38-839"><a href="#cb38-839"></a>subset_types <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb38-840"><a href="#cb38-840"></a>  <span class="at">wealth =</span> subsets_standard_wealth,</span>
<span id="cb38-841"><a href="#cb38-841"></a>  <span class="at">ethnicity =</span> subsets_standard_ethnicity,</span>
<span id="cb38-842"><a href="#cb38-842"></a>)</span>
<span id="cb38-843"><a href="#cb38-843"></a></span>
<span id="cb38-844"><a href="#cb38-844"></a></span>
<span id="cb38-845"><a href="#cb38-845"></a><span class="co"># run model</span></span>
<span id="cb38-846"><a href="#cb38-846"></a>planned_subset_results <span class="ot">&lt;-</span> <span class="fu">margot_planned_subgroups_batch</span>(</span>
<span id="cb38-847"><a href="#cb38-847"></a>  <span class="at">domain_models =</span> domain_models,</span>
<span id="cb38-848"><a href="#cb38-848"></a>  <span class="at">X =</span> X,</span>
<span id="cb38-849"><a href="#cb38-849"></a>  <span class="at">base_defaults =</span> base_defaults_binary,</span>
<span id="cb38-850"><a href="#cb38-850"></a>  <span class="at">subset_types =</span> subset_types,</span>
<span id="cb38-851"><a href="#cb38-851"></a>  <span class="at">original_df =</span> original_df,</span>
<span id="cb38-852"><a href="#cb38-852"></a>  <span class="at">domain_names =</span> domain_names,</span>
<span id="cb38-853"><a href="#cb38-853"></a>  <span class="at">subtitles =</span> subtitles</span>
<span id="cb38-854"><a href="#cb38-854"></a>)</span>
<span id="cb38-855"><a href="#cb38-855"></a></span>
<span id="cb38-856"><a href="#cb38-856"></a></span>
<span id="cb38-857"><a href="#cb38-857"></a><span class="co"># results</span></span>
<span id="cb38-858"><a href="#cb38-858"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>wealth<span class="sc">$</span>explanation)</span>
<span id="cb38-859"><a href="#cb38-859"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>ethnicity<span class="sc">$</span>explanation)</span>
<span id="cb38-860"><a href="#cb38-860"></a><span class="in">```</span></span>
<span id="cb38-861"><a href="#cb38-861"></a></span>
<span id="cb38-862"><a href="#cb38-862"></a>And then we can carry on to graphs and tables as described in the scripts. Note that an interesting set of subgroups to investigate by 'default` are: gender/age/ethnicity. However, unless there are theoretical reasons to expect such differences we should be *very cautious* about inferring too much. </span>
<span id="cb38-863"><a href="#cb38-863"></a>As we can see from the policy trees, heterogeneity doesn't unfold at our pre-defined categories, but rather in surprising ways.</span>
<span id="cb38-864"><a href="#cb38-864"></a></span>
<span id="cb38-865"><a href="#cb38-865"></a></span>
<span id="cb38-866"><a href="#cb38-866"></a></span>
<span id="cb38-867"><a href="#cb38-867"></a><span class="fu">#### Takeaway  </span></span>
<span id="cb38-868"><a href="#cb38-868"></a></span>
<span id="cb38-869"><a href="#cb38-869"></a>Run the script in order, **eyes on three checkpoints**: the toy forest plot, convincing Qini/RATE curves/interpretations, and sensible policy-tree leaves. Everything else is auto-saved for the manuscript.</span>
<span id="cb38-870"><a href="#cb38-870"></a></span>
<span id="cb38-871"><a href="#cb38-871"></a></span>
<span id="cb38-872"><a href="#cb38-872"></a></span>
<span id="cb38-873"><a href="#cb38-873"></a></span>
<span id="cb38-874"><a href="#cb38-874"></a></span>
<span id="cb38-875"><a href="#cb38-875"></a><span class="fu"># Part 2: </span></span>
<span id="cb38-876"><a href="#cb38-876"></a></span>
<span id="cb38-877"><a href="#cb38-877"></a><span class="ss">- </span>**Sensitivity Analysis: E-values**</span>
<span id="cb38-878"><a href="#cb38-878"></a><span class="ss">- </span>**Workflow**</span>
<span id="cb38-879"><a href="#cb38-879"></a></span>
<span id="cb38-880"><a href="#cb38-880"></a></span>
<span id="cb38-881"><a href="#cb38-881"></a></span>
<span id="cb38-882"><a href="#cb38-882"></a></span>
<span id="cb38-883"><a href="#cb38-883"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Modified Treatment Policies and E-values --&gt;</span></span>
<span id="cb38-884"><a href="#cb38-884"></a></span>
<span id="cb38-885"><a href="#cb38-885"></a></span>
<span id="cb38-886"><a href="#cb38-886"></a><span class="co">&lt;!-- A modified treatment policy is a *flexible* intervention of the following form:  --&gt;</span></span>
<span id="cb38-887"><a href="#cb38-887"></a></span>
<span id="cb38-888"><a href="#cb38-888"></a></span>
<span id="cb38-889"><a href="#cb38-889"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb38-890"><a href="#cb38-890"></a><span class="co">&lt;!-- \mathbf{d}^\lambda (a_1) = \begin{cases} 4 &amp; \text{if } a_1 &lt; 4 \\  --&gt;</span></span>
<span id="cb38-891"><a href="#cb38-891"></a><span class="co">&lt;!-- a_1 &amp; \text{otherwise} \end{cases} --&gt;</span></span>
<span id="cb38-892"><a href="#cb38-892"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb38-893"><a href="#cb38-893"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb38-894"><a href="#cb38-894"></a><span class="co">&lt;!-- \mathbf{d}^\phi (a_1) = \begin{cases} 0 &amp; \text{if } a_1 &gt; 0 \\  --&gt;</span></span>
<span id="cb38-895"><a href="#cb38-895"></a><span class="co">&lt;!-- a_1 &amp; \text{otherwise} \end{cases} --&gt;</span></span>
<span id="cb38-896"><a href="#cb38-896"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb38-897"><a href="#cb38-897"></a></span>
<span id="cb38-898"><a href="#cb38-898"></a><span class="co">&lt;!-- $$ g' = \text{Intervention 1 - Intervention 2} = E[Y(\mathbf{d}^\lambda) - Y(\mathbf{d}^\phi)] $$ --&gt;</span></span>
<span id="cb38-899"><a href="#cb38-899"></a></span>
<span id="cb38-900"><a href="#cb38-900"></a><span class="co">&lt;!-- $$ g'' = \text{Intervention 1 - Intervention 2} = E[Y(\mathbf{d}^\lambda) - Y(\mathbf{d}^\phi)] $$ --&gt;</span></span>
<span id="cb38-901"><a href="#cb38-901"></a></span>
<span id="cb38-902"><a href="#cb38-902"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb38-903"><a href="#cb38-903"></a><span class="co">&lt;!-- {\delta}(g) ={g'} - {g''} --&gt;</span></span>
<span id="cb38-904"><a href="#cb38-904"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb38-905"><a href="#cb38-905"></a></span>
<span id="cb38-906"><a href="#cb38-906"></a></span>
<span id="cb38-907"><a href="#cb38-907"></a><span class="co">&lt;!-- Rather than shifting an entire population into one of two states, the estimand flexibly shifts a population according to a pre-specified function.  --&gt;</span></span>
<span id="cb38-908"><a href="#cb38-908"></a></span>
<span id="cb38-909"><a href="#cb38-909"></a><span class="co">&lt;!-- see: @hoffman2023 --&gt;</span></span>
<span id="cb38-910"><a href="#cb38-910"></a></span>
<span id="cb38-911"><a href="#cb38-911"></a></span>
<span id="cb38-912"><a href="#cb38-912"></a><span class="fu">### Sensitivity Analysis using E-values</span></span>
<span id="cb38-913"><a href="#cb38-913"></a></span>
<span id="cb38-914"><a href="#cb38-914"></a></span>
<span id="cb38-915"><a href="#cb38-915"></a><span class="at">&gt; The minimum strength of association on the risk ratio scale that an unmeasured confounder would need to have with both the exposure and the outcome, conditional on the measured covariates, to fully explain away a specific exposure-outcome association</span></span>
<span id="cb38-916"><a href="#cb38-916"></a></span>
<span id="cb38-917"><a href="#cb38-917"></a>See: @mathur2018; @linden2020EVALUE; @vanderweele2017.</span>
<span id="cb38-918"><a href="#cb38-918"></a></span>
<span id="cb38-919"><a href="#cb38-919"></a>For example, suppose that the lower bound of the the E-value was 1.3 with the lower bound of the confidence interval = 1.12, we might then write:</span>
<span id="cb38-920"><a href="#cb38-920"></a></span>
<span id="cb38-921"><a href="#cb38-921"></a><span class="at">&gt; With an observed risk ratio of RR=1.3, an unmeasured confounder that was associated with both the outcome and the exposure by a risk ratio of 1.3-fold each (or 30%), above and beyond the measured confounders, could explain away the estimate, but weaker joint confounder associations could not; to move the confidence interval to include the null, an unmeasured confounder that was associated with the outcome and the exposure by a risk ratio of 1.12-fold (or 12%) each could do so, but weaker joint confounder associations could not.</span></span>
<span id="cb38-922"><a href="#cb38-922"></a></span>
<span id="cb38-923"><a href="#cb38-923"></a>The equations are as follows (for risk ratios)</span>
<span id="cb38-924"><a href="#cb38-924"></a></span>
<span id="cb38-925"><a href="#cb38-925"></a>$$</span>
<span id="cb38-926"><a href="#cb38-926"></a>E-value_{RR} = RR + \sqrt{RR \times (RR - 1)}</span>
<span id="cb38-927"><a href="#cb38-927"></a>$$ </span>
<span id="cb38-928"><a href="#cb38-928"></a></span>
<span id="cb38-929"><a href="#cb38-929"></a>$$</span>
<span id="cb38-930"><a href="#cb38-930"></a>E-value_{LCL} = LCL + \sqrt{LCL \times (LCL - 1)}</span>
<span id="cb38-931"><a href="#cb38-931"></a>$$</span>
<span id="cb38-932"><a href="#cb38-932"></a></span>
<span id="cb38-933"><a href="#cb38-933"></a>Here is an R function that will calculate E-values</span>
<span id="cb38-934"><a href="#cb38-934"></a></span>
<span id="cb38-937"><a href="#cb38-937"></a><span class="in">```{r}</span></span>
<span id="cb38-938"><a href="#cb38-938"></a><span class="co">#| eval: true</span></span>
<span id="cb38-939"><a href="#cb38-939"></a><span class="co"># evalue for risk ratio</span></span>
<span id="cb38-940"><a href="#cb38-940"></a>calculate_e_value <span class="ot">&lt;-</span> <span class="cf">function</span>(rr, lcl) {</span>
<span id="cb38-941"><a href="#cb38-941"></a>  e_value_rr <span class="ot">=</span> rr <span class="sc">+</span> <span class="fu">sqrt</span>(rr<span class="sc">*</span>(rr <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb38-942"><a href="#cb38-942"></a>  e_value_lcl <span class="ot">=</span> lcl <span class="sc">+</span> <span class="fu">sqrt</span>(lcl<span class="sc">*</span>(lcl <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb38-943"><a href="#cb38-943"></a>  </span>
<span id="cb38-944"><a href="#cb38-944"></a>  <span class="fu">list</span>(<span class="at">e_value_rr =</span> e_value_rr, <span class="at">e_value_lcl =</span> e_value_lcl)</span>
<span id="cb38-945"><a href="#cb38-945"></a>}</span>
<span id="cb38-946"><a href="#cb38-946"></a></span>
<span id="cb38-947"><a href="#cb38-947"></a><span class="co"># e.g. smoking causes cancer</span></span>
<span id="cb38-948"><a href="#cb38-948"></a><span class="co"># finding   RR = 10.73 (95% CI: 8.02, 14.36)</span></span>
<span id="cb38-949"><a href="#cb38-949"></a>evalue_computed <span class="ot">&lt;-</span> <span class="fu">calculate_e_value</span>(<span class="fl">10.73</span>, <span class="fl">8.02</span>)</span>
<span id="cb38-950"><a href="#cb38-950"></a></span>
<span id="cb38-951"><a href="#cb38-951"></a><span class="co">#print</span></span>
<span id="cb38-952"><a href="#cb38-952"></a>evalue_computed</span>
<span id="cb38-953"><a href="#cb38-953"></a></span>
<span id="cb38-954"><a href="#cb38-954"></a><span class="in">```</span></span>
<span id="cb38-955"><a href="#cb38-955"></a></span>
<span id="cb38-956"><a href="#cb38-956"></a>We write:</span>
<span id="cb38-957"><a href="#cb38-957"></a></span>
<span id="cb38-958"><a href="#cb38-958"></a><span class="at">&gt; With an observed risk ratio of RR=10.7, an unmeasured confounder that was associated </span><span class="in">`r evalue_computed$e_value_rr`</span><span class="at">-fold each, above and beyond the measured confounders, could explain away the estimate, but weaker joint confounder associations could not; to move the confidence interval to include the null, an unmeasured confounder that was associated with the outcome and the exposure by a risk ratio of </span><span class="in">`e_value_rr$e_value_lcl`</span><span class="at">-fold each could do so, but weaker joint confounder associations could not.</span></span>
<span id="cb38-959"><a href="#cb38-959"></a></span>
<span id="cb38-960"><a href="#cb38-960"></a>Note that in this class, most of the outcomes will be (standardised) continuous outcomes. Here's a function and LaTeX code to describe the approximation.</span>
<span id="cb38-961"><a href="#cb38-961"></a></span>
<span id="cb38-962"><a href="#cb38-962"></a>This function takes a linear regression coefficient estimate (<span class="in">`est`</span>), its standard error (<span class="in">`se`</span>), the standard deviation of the outcome (<span class="in">`sd`</span>), a contrast of interest in the exposure (<span class="in">`delta`</span>, which defaults to 1), and a "true" standardized mean difference (true, which defaults to 0). It calculates the odds ratio using the formula from Chinn (2000) and VanderWeele (2017), and then uses this to calculate the E-value.</span>
<span id="cb38-963"><a href="#cb38-963"></a></span>
<span id="cb38-966"><a href="#cb38-966"></a><span class="in">```{r}</span></span>
<span id="cb38-967"><a href="#cb38-967"></a><span class="co">#| label: evalue_ols</span></span>
<span id="cb38-968"><a href="#cb38-968"></a></span>
<span id="cb38-969"><a href="#cb38-969"></a><span class="co">#evalue for ols</span></span>
<span id="cb38-970"><a href="#cb38-970"></a>compute_evalue_ols <span class="ot">&lt;-</span> <span class="cf">function</span>(est, se, <span class="at">delta =</span> <span class="dv">1</span>, <span class="at">true =</span> <span class="dv">0</span>) {</span>
<span id="cb38-971"><a href="#cb38-971"></a>  <span class="co"># rescale estimate and SE to get a contrast of size delta</span></span>
<span id="cb38-972"><a href="#cb38-972"></a>  est <span class="ot">&lt;-</span> est <span class="sc">/</span> delta</span>
<span id="cb38-973"><a href="#cb38-973"></a>  se <span class="ot">&lt;-</span> se <span class="sc">/</span> delta</span>
<span id="cb38-974"><a href="#cb38-974"></a></span>
<span id="cb38-975"><a href="#cb38-975"></a>  <span class="co"># compute transformed odds ratio and ci's</span></span>
<span id="cb38-976"><a href="#cb38-976"></a>  odds_ratio <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fl">0.91</span> <span class="sc">*</span> est)</span>
<span id="cb38-977"><a href="#cb38-977"></a>  lo <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fl">0.91</span> <span class="sc">*</span> est <span class="sc">-</span> <span class="fl">1.78</span> <span class="sc">*</span> se)</span>
<span id="cb38-978"><a href="#cb38-978"></a>  hi <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fl">0.91</span> <span class="sc">*</span> est <span class="sc">+</span> <span class="fl">1.78</span> <span class="sc">*</span> se)</span>
<span id="cb38-979"><a href="#cb38-979"></a></span>
<span id="cb38-980"><a href="#cb38-980"></a>  <span class="co"># compute E-Values based on the RR values</span></span>
<span id="cb38-981"><a href="#cb38-981"></a>  evalue_point_estimate <span class="ot">&lt;-</span> odds_ratio <span class="sc">*</span> <span class="fu">sqrt</span>(odds_ratio <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb38-982"><a href="#cb38-982"></a>  evalue_lower_ci <span class="ot">&lt;-</span> lo <span class="sc">*</span> <span class="fu">sqrt</span>(lo <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb38-983"><a href="#cb38-983"></a></span>
<span id="cb38-984"><a href="#cb38-984"></a>  <span class="co"># return the e-values</span></span>
<span id="cb38-985"><a href="#cb38-985"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">EValue_PointEstimate =</span> evalue_point_estimate,</span>
<span id="cb38-986"><a href="#cb38-986"></a>              <span class="at">EValue_LowerCI =</span> evalue_lower_ci))</span>
<span id="cb38-987"><a href="#cb38-987"></a>}</span>
<span id="cb38-988"><a href="#cb38-988"></a></span>
<span id="cb38-989"><a href="#cb38-989"></a></span>
<span id="cb38-990"><a href="#cb38-990"></a><span class="co"># example:</span></span>
<span id="cb38-991"><a href="#cb38-991"></a><span class="co"># suppose we have an estimate of 0.5, a standard error of 0.1, and a standard deviation of 1.</span></span>
<span id="cb38-992"><a href="#cb38-992"></a><span class="co"># this would correspond to a half a standard deviation increase in the outcome per unit increase in the exposure.</span></span>
<span id="cb38-993"><a href="#cb38-993"></a>results <span class="ot">&lt;-</span> <span class="fu">compute_evalue_ols</span>(<span class="at">est =</span> <span class="fl">0.5</span>, <span class="at">se =</span> <span class="fl">0.1</span>, <span class="at">delta =</span> <span class="dv">1</span>)</span>
<span id="cb38-994"><a href="#cb38-994"></a>point_round <span class="ot">&lt;-</span> <span class="fu">round</span>(results<span class="sc">$</span>EValue_PointEstimate, <span class="dv">3</span>)</span>
<span id="cb38-995"><a href="#cb38-995"></a>ci_round <span class="ot">&lt;-</span> <span class="fu">round</span>(results<span class="sc">$</span>EValue_LowerCI, <span class="dv">3</span>)</span>
<span id="cb38-996"><a href="#cb38-996"></a></span>
<span id="cb38-997"><a href="#cb38-997"></a><span class="co"># print results</span></span>
<span id="cb38-998"><a href="#cb38-998"></a><span class="fu">print</span>(point_round)</span>
<span id="cb38-999"><a href="#cb38-999"></a><span class="fu">print</span>(ci_round)</span>
<span id="cb38-1000"><a href="#cb38-1000"></a></span>
<span id="cb38-1001"><a href="#cb38-1001"></a><span class="in">```</span></span>
<span id="cb38-1002"><a href="#cb38-1002"></a></span>
<span id="cb38-1003"><a href="#cb38-1003"></a>We write:</span>
<span id="cb38-1004"><a href="#cb38-1004"></a></span>
<span id="cb38-1005"><a href="#cb38-1005"></a><span class="at">&gt; With an observed risk ratio of </span><span class="in">`r point_round`</span><span class="at">, an unmeasured confounder that was associated with both the outcome and the exposure by a risk ratio of </span><span class="in">`r point_round`</span><span class="at">-fold each, above and beyond the measured confounders, could explain away the estimate, but weaker joint confounder associations could not; to move the confidence interval to include the null, an unmeasured confounder that was associated with the outcome and the exposure by a risk ratio of </span><span class="in">`r ci_round`</span><span class="at">-fold each could do so, but weaker joint confounder associations could not.</span></span>
<span id="cb38-1006"><a href="#cb38-1006"></a></span>
<span id="cb38-1007"><a href="#cb38-1007"></a>Note the E-values package will do the computational work for us and this is what we use in the <span class="in">`margot`</span> package to obtain E-values for sensitivity analysis.</span>
<span id="cb38-1008"><a href="#cb38-1008"></a></span>
<span id="cb38-1009"><a href="#cb38-1009"></a></span>
<span id="cb38-1010"><a href="#cb38-1010"></a></span>
<span id="cb38-1011"><a href="#cb38-1011"></a></span>
<span id="cb38-1012"><a href="#cb38-1012"></a></span>
<span id="cb38-1013"><a href="#cb38-1013"></a><span class="fu">## Part 2 Guide For Preparing Your Study</span></span>
<span id="cb38-1014"><a href="#cb38-1014"></a></span>
<span id="cb38-1015"><a href="#cb38-1015"></a></span>
<span id="cb38-1016"><a href="#cb38-1016"></a>Recall that psychology begins with two questions. </span>
<span id="cb38-1017"><a href="#cb38-1017"></a></span>
<span id="cb38-1018"><a href="#cb38-1018"></a><span class="at">&gt; What do I want to know about thought and behaviour? </span></span>
<span id="cb38-1019"><a href="#cb38-1019"></a><span class="at">&gt; What is the target population? </span></span>
<span id="cb38-1020"><a href="#cb38-1020"></a></span>
<span id="cb38-1021"><a href="#cb38-1021"></a>In cross-cultural psychology, these questions relate to differences, and similarities, between groups.</span>
<span id="cb38-1022"><a href="#cb38-1022"></a></span>
<span id="cb38-1023"><a href="#cb38-1023"></a>Suppose we have asked a question. How can we address it using observational data?</span>
<span id="cb38-1024"><a href="#cb38-1024"></a></span>
<span id="cb38-1025"><a href="#cb38-1025"></a>Too fast.</span>
<span id="cb38-1026"><a href="#cb38-1026"></a></span>
<span id="cb38-1027"><a href="#cb38-1027"></a>Our question must be made precise. </span>
<span id="cb38-1028"><a href="#cb38-1028"></a></span>
<span id="cb38-1029"><a href="#cb38-1029"></a>Today we will consider how to make psychological questions precise, and how to answer them, using 3-wave panel designs <span class="co">[</span><span class="ot">@vanderweele2020</span><span class="co">]</span>.</span>
<span id="cb38-1030"><a href="#cb38-1030"></a></span>
<span id="cb38-1031"><a href="#cb38-1031"></a></span>
<span id="cb38-1032"><a href="#cb38-1032"></a><span class="fu">## Comprehensive Checklist for Detailed Reporting of a Causal Inferenctial Study.</span></span>
<span id="cb38-1033"><a href="#cb38-1033"></a></span>
<span id="cb38-1034"><a href="#cb38-1034"></a><span class="fu">#### Step 1: Formulate the Research Question</span></span>
<span id="cb38-1035"><a href="#cb38-1035"></a></span>
<span id="cb38-1036"><a href="#cb38-1036"></a><span class="ss">-   </span>**State your question:** is my question clearly stated? If not, state it.</span>
<span id="cb38-1037"><a href="#cb38-1037"></a><span class="ss">-   </span>**Relevance:** have I explained its importance? If not, explain.</span>
<span id="cb38-1038"><a href="#cb38-1038"></a><span class="ss">-   </span>**Ethics** how might this question affect people? How might not investigating this question affect people? </span>
<span id="cb38-1039"><a href="#cb38-1039"></a><span class="ss">-   </span>**Causality:** Is my question causal? If not, refine your question.</span>
<span id="cb38-1040"><a href="#cb38-1040"></a><span class="ss">-   </span>**Heterogeneous Treatment Effects**:  Do I want to examine who responds differently (CATE)?</span>
<span id="cb38-1041"><a href="#cb38-1041"></a><span class="ss">-   </span>**Subgroup analysis:** does my question involve a subgroup (e.g., cultural group)? If not, develop a subgroup analysis question.</span>
<span id="cb38-1042"><a href="#cb38-1042"></a><span class="ss">-   </span>**Explain the Framework:** can I explain the causal inference framework and convey the gist to non-specialists? If not, review course materials.</span>
<span id="cb38-1043"><a href="#cb38-1043"></a></span>
<span id="cb38-1044"><a href="#cb38-1044"></a><span class="fu">#### Determine Data Requirements</span></span>
<span id="cb38-1045"><a href="#cb38-1045"></a></span>
<span id="cb38-1046"><a href="#cb38-1046"></a><span class="ss">-   </span>**Data types:** are my data experimental? If yes, your project may not fit this course.</span>
<span id="cb38-1047"><a href="#cb38-1047"></a><span class="ss">-   </span>**Time-series data:** are my data time-series? If not, reconsider your causal question.</span>
<span id="cb38-1048"><a href="#cb38-1048"></a><span class="ss">-   </span>**Data waves:** do I have at least three waves of data? If not, beware of confounding control issues.</span>
<span id="cb38-1049"><a href="#cb38-1049"></a><span class="ss">-   </span>**Data source:** are my data from the NZAVS simulated data set? If not, consult with me.</span>
<span id="cb38-1050"><a href="#cb38-1050"></a></span>
<span id="cb38-1051"><a href="#cb38-1051"></a><span class="fu">#### Determine the Outcome</span></span>
<span id="cb38-1052"><a href="#cb38-1052"></a></span>
<span id="cb38-1053"><a href="#cb38-1053"></a><span class="ss">-   </span>**Outcome variable:** is the outcome variable *Y* defined? If not, define it.</span>
<span id="cb38-1054"><a href="#cb38-1054"></a><span class="ss">-   </span>**Multiple outcomes:** are there multiple outcomes? If yes, explain and define them.</span>
<span id="cb38-1055"><a href="#cb38-1055"></a><span class="ss">-   </span>**Outcome relevance:** can I explain how the outcome variable/s relate to my question? If not, clarify.</span>
<span id="cb38-1056"><a href="#cb38-1056"></a><span class="ss">-   </span>**Outcome type:** is my outcome binary and rare? If yes, consider logistic regression. If my outcome is continuous, consider z-transforming it or categorising it (consult an expert).</span>
<span id="cb38-1057"><a href="#cb38-1057"></a><span class="ss">-   </span>**Outcome timing:** does the outcome appear after the exposure? It should.</span>
<span id="cb38-1058"><a href="#cb38-1058"></a></span>
<span id="cb38-1059"><a href="#cb38-1059"></a><span class="fu">#### Determine the Exposure</span></span>
<span id="cb38-1060"><a href="#cb38-1060"></a></span>
<span id="cb38-1061"><a href="#cb38-1061"></a><span class="ss">-   </span>**Exposure variable:** is the exposure variable *A* defined? If not, define it.</span>
<span id="cb38-1062"><a href="#cb38-1062"></a><span class="ss">-   </span>**Multiple exposures:** are there multiple exposures? If yes, reassess; if only one exposure, proceed.</span>
<span id="cb38-1063"><a href="#cb38-1063"></a><span class="ss">-   </span>**Exposure relevance:** can I explain how the exposure variable relates to my question? If not, clarify.</span>
<span id="cb38-1064"><a href="#cb38-1064"></a><span class="ss">-   </span>**Positivity:** can we intervene on the exposure at all levels of the covariates? We should be able to.</span>
<span id="cb38-1065"><a href="#cb38-1065"></a><span class="ss">-   </span>**Consistency:** can I interpret what it means to intervene on the exposure? I should be able to.</span>
<span id="cb38-1066"><a href="#cb38-1066"></a><span class="ss">-   </span>**Exchangeability:** are different versions of the exposure conditionally exchangeable given measured baseline confounders? They should be.</span>
<span id="cb38-1067"><a href="#cb38-1067"></a><span class="ss">-   </span>**Exposure type:** is the exposure binary or continuous?</span>
<span id="cb38-1068"><a href="#cb38-1068"></a><span class="ss">-   </span>**Shift intervention**: Am I contrasting static interventions or modified treatment policies?  (Not relevant for your final report)</span>
<span id="cb38-1069"><a href="#cb38-1069"></a><span class="ss">-   </span>**Exposure timing:** Does the exposure appear before the outcome? It should.</span>
<span id="cb38-1070"><a href="#cb38-1070"></a></span>
<span id="cb38-1071"><a href="#cb38-1071"></a><span class="fu">#### Account for Confounders</span></span>
<span id="cb38-1072"><a href="#cb38-1072"></a></span>
<span id="cb38-1073"><a href="#cb38-1073"></a><span class="ss">-   </span>**Baseline confounders:** Have I defined my baseline confounders *L*? I should have.</span>
<span id="cb38-1074"><a href="#cb38-1074"></a><span class="ss">-   </span>**Justification:** Can I explain how the baseline confounders could affect both *A* and *Y*? I should be able to.</span>
<span id="cb38-1075"><a href="#cb38-1075"></a><span class="ss">-   </span>**Timing:** Are the baseline confounders measured before the exposure? They should be.</span>
<span id="cb38-1076"><a href="#cb38-1076"></a><span class="ss">-   </span>**Inclusion:** Is the baseline measure of the exposure and the baseline outcome included in the set of baseline confounders? They should be.</span>
<span id="cb38-1077"><a href="#cb38-1077"></a><span class="ss">-   </span>**Sufficiency:** Are the baseline confounders sufficient to ensure balance on the exposure, such that *A* is independent of *Y* given *L*? If not, plan a sensitivity analysis.</span>
<span id="cb38-1078"><a href="#cb38-1078"></a><span class="ss">-   </span>**Confounder type:** Are the confounders continuous or binary? If so, consider converting them to z-scores. If they are categorical with three or more levels, do not convert them to z-scores.</span>
<span id="cb38-1079"><a href="#cb38-1079"></a></span>
<span id="cb38-1080"><a href="#cb38-1080"></a><span class="fu">#### Draw a Causal Diagram with Unmeasured Confounders</span></span>
<span id="cb38-1081"><a href="#cb38-1081"></a></span>
<span id="cb38-1082"><a href="#cb38-1082"></a><span class="ss">-   </span>**Unmeasured confounders:** Does previous science suggest the presence of unmeasured confounders? If not, expand your understanding.</span>
<span id="cb38-1083"><a href="#cb38-1083"></a><span class="ss">-   </span>**Causal diagram:** Have I drawn a causal diagram (DAG) to highlight both measured and unmeasured sources of confounding? I should have.</span>
<span id="cb38-1084"><a href="#cb38-1084"></a><span class="ss">-   </span>**Measurement error:** Have I described potential biases from measurement errors? If not, we'll discuss later.</span>
<span id="cb38-1085"><a href="#cb38-1085"></a><span class="ss">-   </span>**Temporal order:** Does my DAG have time indicators to ensure correct temporal order? It should.</span>
<span id="cb38-1086"><a href="#cb38-1086"></a><span class="ss">-   </span>**Time consistency:** Is my DAG organized so that time follows in a consistent direction? It should.</span>
<span id="cb38-1087"><a href="#cb38-1087"></a></span>
<span id="cb38-1088"><a href="#cb38-1088"></a><span class="fu">#### Identify the Estimand</span></span>
<span id="cb38-1089"><a href="#cb38-1089"></a></span>
<span id="cb38-1090"><a href="#cb38-1090"></a><span class="ss">- </span>ATE or CATE or both? (For you -- it will be both)</span>
<span id="cb38-1091"><a href="#cb38-1091"></a></span>
<span id="cb38-1092"><a href="#cb38-1092"></a><span class="fu">#### Understanding Source and Target Populations</span></span>
<span id="cb38-1093"><a href="#cb38-1093"></a></span>
<span id="cb38-1094"><a href="#cb38-1094"></a><span class="ss">-   </span>**Populations identified:** Have I explained how my sample relates to my target populations? I should have.</span>
<span id="cb38-1095"><a href="#cb38-1095"></a><span class="ss">-   </span>**Generalisability and transportability:** Have I considered whether my results generalise different populations?  I should have.</span>
<span id="cb38-1096"><a href="#cb38-1096"></a></span>
<span id="cb38-1097"><a href="#cb38-1097"></a><span class="fu">#### Set Eligibility Criteria</span></span>
<span id="cb38-1098"><a href="#cb38-1098"></a></span>
<span id="cb38-1099"><a href="#cb38-1099"></a><span class="ss">-   </span>**Criteria stated:** Have I stated the eligibility criteria for the study? I should have.</span>
<span id="cb38-1100"><a href="#cb38-1100"></a></span>
<span id="cb38-1101"><a href="#cb38-1101"></a><span class="fu">#### Describe Sample Characteristics</span></span>
<span id="cb38-1102"><a href="#cb38-1102"></a></span>
<span id="cb38-1103"><a href="#cb38-1103"></a><span class="ss">-   </span>**Descriptive statistics:** have I provided descriptive statistics for demographic information taken at baseline? I should have.</span>
<span id="cb38-1104"><a href="#cb38-1104"></a><span class="ss">-   </span>**Exposure change:** Have I demonstrated the magnitudes of change in the exposure from baseline to the exposure interval? I should have.</span>
<span id="cb38-1105"><a href="#cb38-1105"></a><span class="ss">-   </span>**References:** Have I included references for more information about the sample? I should have.</span>
<span id="cb38-1106"><a href="#cb38-1106"></a></span>
<span id="cb38-1107"><a href="#cb38-1107"></a><span class="fu">#### Addressing Missing Data</span></span>
<span id="cb38-1108"><a href="#cb38-1108"></a></span>
<span id="cb38-1109"><a href="#cb38-1109"></a><span class="ss">-   </span>**Missing data checks:** Have I checked for missing data? I should have.</span>
<span id="cb38-1110"><a href="#cb38-1110"></a><span class="ss">-   </span>**Missing data plan:** If there is missing data, have I described how I will address it? I should have.</span>
<span id="cb38-1111"><a href="#cb38-1111"></a></span>
<span id="cb38-1112"><a href="#cb38-1112"></a><span class="fu">#### Selecting the Model Approach: If Not Using Machine Learning (Lecture 7)</span></span>
<span id="cb38-1113"><a href="#cb38-1113"></a></span>
<span id="cb38-1114"><a href="#cb38-1114"></a><span class="ss">-   </span>**Approach decision:** Have I decided on using G-computation, IPTW, or Doubly-Robust Estimation? I should have.</span>
<span id="cb38-1115"><a href="#cb38-1115"></a><span class="ss">-   </span>**Interactions:** If not using machine learning, have I included the interaction of the exposure and baseline covariates? I should have.</span>
<span id="cb38-1116"><a href="#cb38-1116"></a><span class="ss">-   </span>**Big data:** If I have a large data set, should I include the interaction of the exposure, group, and baseline confounders? I should consider it.</span>
<span id="cb38-1117"><a href="#cb38-1117"></a><span class="ss">-   </span>**Model specification:** have I double-checked the model specification? I should.</span>
<span id="cb38-1118"><a href="#cb38-1118"></a><span class="ss">-   </span>**Outcome assessment:** If the outcome is rare and binary, have I specified logistic regression? If it's continuous, have I considered converting it to z-scores?</span>
<span id="cb38-1119"><a href="#cb38-1119"></a><span class="ss">-   </span>**Sensitivity analysis:** am I planning a sensitivity analysis using simulation? If yes, describe it (e.g. E-values.)</span>
<span id="cb38-1120"><a href="#cb38-1120"></a></span>
<span id="cb38-1121"><a href="#cb38-1121"></a><span class="fu">#### Machine Learing</span></span>
<span id="cb38-1122"><a href="#cb38-1122"></a></span>
<span id="cb38-1123"><a href="#cb38-1123"></a>Have I explained how causal forests work (next week's lecture).</span>
<span id="cb38-1124"><a href="#cb38-1124"></a></span>
<span id="cb38-1125"><a href="#cb38-1125"></a><span class="fu">### Clarify unmeasured pre-treatment covariates</span></span>
<span id="cb38-1126"><a href="#cb38-1126"></a></span>
<span id="cb38-1127"><a href="#cb38-1127"></a>Let **U** denoted unmeasured pre-treatment covariates that may potentially bias the statistical association between *A* and *Y* independently of the measured covariates.</span>
<span id="cb38-1128"><a href="#cb38-1128"></a></span>
<span id="cb38-1129"><a href="#cb38-1129"></a><span class="fu">#### Consider:</span></span>
<span id="cb38-1130"><a href="#cb38-1130"></a></span>
<span id="cb38-1131"><a href="#cb38-1131"></a><span class="ss">-   </span>To affect *Y* and *A*, *U* must occur before *A*.</span>
<span id="cb38-1132"><a href="#cb38-1132"></a><span class="ss">-   </span>It is useful to draw a causal diagramme to illustrate all potential sources of bias.</span>
<span id="cb38-1133"><a href="#cb38-1133"></a><span class="ss">-   </span>Causal diagrammes are qualitative tools that require specialist expertise. We cannot typically obtain a causal graph from the data.</span>
<span id="cb38-1134"><a href="#cb38-1134"></a><span class="ss">-   </span>A causal diagramme should include only as much information as is required to assess confounding. See @fig-dag-outcomewide for an example.</span>
<span id="cb38-1135"><a href="#cb38-1135"></a><span class="ss">-   </span>Because we cannot ensure the absence of unmeasured confounders in observational settings, it is vital to conduct sensitivity analyses for the results. For sensitivity analyeses, we use E-values.</span>
<span id="cb38-1136"><a href="#cb38-1136"></a></span>
<span id="cb38-1139"><a href="#cb38-1139"></a><span class="in">```{tikz}</span></span>
<span id="cb38-1140"><a href="#cb38-1140"></a><span class="in">#| label: fig-dag-outcomewide</span></span>
<span id="cb38-1141"><a href="#cb38-1141"></a><span class="in">#| fig-cap: "Causal graph: three-wave panel design." </span></span>
<span id="cb38-1142"><a href="#cb38-1142"></a><span class="in">#| out-width: 100%</span></span>
<span id="cb38-1143"><a href="#cb38-1143"></a><span class="in">#| echo: false</span></span>
<span id="cb38-1144"><a href="#cb38-1144"></a><span class="in">#| code-fold: true</span></span>
<span id="cb38-1145"><a href="#cb38-1145"></a></span>
<span id="cb38-1146"><a href="#cb38-1146"></a><span class="in">\usetikzlibrary{positioning}</span></span>
<span id="cb38-1147"><a href="#cb38-1147"></a><span class="in">\usetikzlibrary{shapes.geometric}</span></span>
<span id="cb38-1148"><a href="#cb38-1148"></a><span class="in">\usetikzlibrary{arrows}</span></span>
<span id="cb38-1149"><a href="#cb38-1149"></a><span class="in">\usetikzlibrary{decorations}</span></span>
<span id="cb38-1150"><a href="#cb38-1150"></a><span class="in">\tikzstyle{Arrow} = [-&gt;, thin, preaction = {decorate}]</span></span>
<span id="cb38-1151"><a href="#cb38-1151"></a><span class="in">\tikzset{&gt;=latex}</span></span>
<span id="cb38-1152"><a href="#cb38-1152"></a></span>
<span id="cb38-1153"><a href="#cb38-1153"></a><span class="in">\begin{tikzpicture}[{every node/.append style}=draw]</span></span>
<span id="cb38-1154"><a href="#cb38-1154"></a><span class="in">\node [rectangle, draw=white] (U) at (0, 0) {U};</span></span>
<span id="cb38-1155"><a href="#cb38-1155"></a><span class="in">\node [rectangle, draw=black, align=left] (L) at (2, 0) {t0/L \\t0/A \\t0/Y};</span></span>
<span id="cb38-1156"><a href="#cb38-1156"></a><span class="in">\node [rectangle, draw=white] (A) at (4, 0) {t1/A};</span></span>
<span id="cb38-1157"><a href="#cb38-1157"></a><span class="in">\node [ellipse, draw=white] (Y) at (6, 0) {t2/Y};</span></span>
<span id="cb38-1158"><a href="#cb38-1158"></a><span class="in">\draw [-latex, draw=black] (U) to (L);</span></span>
<span id="cb38-1159"><a href="#cb38-1159"></a><span class="in">\draw [-latex, draw=black] (L) to (A);</span></span>
<span id="cb38-1160"><a href="#cb38-1160"></a><span class="in">\draw [-latex, draw=red, dotted] (A) to (Y);</span></span>
<span id="cb38-1161"><a href="#cb38-1161"></a><span class="in">\draw [-latex, bend left=50, draw =black] (L) to (Y);</span></span>
<span id="cb38-1162"><a href="#cb38-1162"></a><span class="in">\draw [-latex, bend right=50, draw =black, dotted] (U) to (Y);</span></span>
<span id="cb38-1163"><a href="#cb38-1163"></a><span class="in">\draw [-latex, bend left=50, draw =black, dotted] (U) to (A);</span></span>
<span id="cb38-1164"><a href="#cb38-1164"></a></span>
<span id="cb38-1165"><a href="#cb38-1165"></a><span class="in">\end{tikzpicture}</span></span>
<span id="cb38-1166"><a href="#cb38-1166"></a><span class="in">```</span></span>
<span id="cb38-1167"><a href="#cb38-1167"></a></span>
<span id="cb38-1168"><a href="#cb38-1168"></a><span class="fu">### Choose the scale for a causal contrast</span></span>
<span id="cb38-1169"><a href="#cb38-1169"></a></span>
<span id="cb38-1170"><a href="#cb38-1170"></a>Difference/ Risk ratio? </span>
<span id="cb38-1171"><a href="#cb38-1171"></a></span>
<span id="cb38-1172"><a href="#cb38-1172"></a><span class="fu">#### Consider:</span></span>
<span id="cb38-1173"><a href="#cb38-1173"></a></span>
<span id="cb38-1174"><a href="#cb38-1174"></a><span class="ss">-   </span>*In this course, we are interested in stratum specific comparisons*</span>
<span id="cb38-1175"><a href="#cb38-1175"></a><span class="ss">-   </span>In the causal inference literature, the concept we use to make sense of stratum specific comparisons is called "effect modification."</span>
<span id="cb38-1176"><a href="#cb38-1176"></a><span class="ss">-   </span>By inferring effects within strata, we may evaluate whether the effects of different exposures or treatments on some well-defined outcome (measured in some well-defined time-period after the exposure) differ depending on group measurement.</span>
<span id="cb38-1177"><a href="#cb38-1177"></a><span class="ss">-   </span>The logic of effect modification differs slightly from that of interaction.</span>
<span id="cb38-1178"><a href="#cb38-1178"></a></span>
<span id="cb38-1179"><a href="#cb38-1179"></a><span class="fu">#### Aside: extensions</span></span>
<span id="cb38-1180"><a href="#cb38-1180"></a></span>
<span id="cb38-1181"><a href="#cb38-1181"></a>For continuous exposures, we must stipulate the level of contrast for the exposure (e.g. weekly versus monthly church attendance):</span>
<span id="cb38-1182"><a href="#cb38-1182"></a></span>
<span id="cb38-1183"><a href="#cb38-1183"></a>$$ATE_{A,A'} = E<span class="co">[</span><span class="ot">Y(A) - Y(A')| L</span><span class="co">]</span>$$</span>
<span id="cb38-1184"><a href="#cb38-1184"></a></span>
<span id="cb38-1185"><a href="#cb38-1185"></a>This essentially denotes an average treatment effect comparing the outcome under treatment level $A$ to the outcome under treatment level $A'$.</span>
<span id="cb38-1186"><a href="#cb38-1186"></a></span>
<span id="cb38-1187"><a href="#cb38-1187"></a>Likewise:</span>
<span id="cb38-1188"><a href="#cb38-1188"></a></span>
<span id="cb38-1189"><a href="#cb38-1189"></a>$$ATE_{A/A'} = \frac{E<span class="co">[</span><span class="ot">Y(A)| L</span><span class="co">]</span>}{E<span class="co">[</span><span class="ot">Y(A')| L</span><span class="co">]</span>}$$</span>
<span id="cb38-1190"><a href="#cb38-1190"></a></span>
<span id="cb38-1191"><a href="#cb38-1191"></a>This defines the contrast of $A$ and $A'$ on a ratio scale.</span>
<span id="cb38-1192"><a href="#cb38-1192"></a></span>
<span id="cb38-1193"><a href="#cb38-1193"></a><span class="fu">#### Describe the population(s) for whom the intended study is meant to generalise by distinguishing between source and target populations.</span></span>
<span id="cb38-1194"><a href="#cb38-1194"></a></span>
<span id="cb38-1195"><a href="#cb38-1195"></a>Consider the following concepts:</span>
<span id="cb38-1196"><a href="#cb38-1196"></a></span>
<span id="cb38-1197"><a href="#cb38-1197"></a><span class="ss">-   </span>**Source population**: a source population is where we gather our data for a study. We pull our specific sample from this group. It needs to mirror the broader group for our conclusions to be valid and widely applicable.</span>
<span id="cb38-1198"><a href="#cb38-1198"></a></span>
<span id="cb38-1199"><a href="#cb38-1199"></a><span class="ss">-   </span>**Target population**: the target population is the larger group we aim to apply our study's results to. It could be defined by location, demographics, or specific conditions. The closer the source matches the target in ways that are relevant to our causal questions, the stronger our causal inferences about the target population will be.</span>
<span id="cb38-1200"><a href="#cb38-1200"></a></span>
<span id="cb38-1201"><a href="#cb38-1201"></a><span class="ss">    -   </span>**Generalisability** refers to the ability to apply the causal effects estimated from a sample to the population it was drawn from. In simpler terms, it deals with the extrapolation of causal knowledge from a sample to the broader population. This concept is also called "external validity".</span>
<span id="cb38-1202"><a href="#cb38-1202"></a></span>
<span id="cb38-1203"><a href="#cb38-1203"></a>$$\text{Generalisability} = PATE \approx ATE_{\text{sample}}$$</span>
<span id="cb38-1204"><a href="#cb38-1204"></a></span>
<span id="cb38-1205"><a href="#cb38-1205"></a><span class="ss">-   </span>**Transportability** refers to the ability to extrapolate causal effects learned from a source population to a target population when certain conditions are met. It deals with the transfer of causal knowledge across different settings or populations.</span>
<span id="cb38-1206"><a href="#cb38-1206"></a></span>
<span id="cb38-1207"><a href="#cb38-1207"></a>$$\text{Transportability} = ATE_{\text{target}} \approx f(ATE_{\text{source}}, T)$$</span>
<span id="cb38-1208"><a href="#cb38-1208"></a></span>
<span id="cb38-1209"><a href="#cb38-1209"></a>where $f$ is a function and $T$ is a function that maps the results from our source population to another population. To achieve transportability, we need information about the source and target populations and an understanding of how the relationships between treatment, outcome, and covariates differ between the populations. Assessing transportability requires scientific knowledge.</span>
<span id="cb38-1210"><a href="#cb38-1210"></a></span>
<span id="cb38-1211"><a href="#cb38-1211"></a><span class="fu">### Summary Step 1: Consider how much we need to do when asking a causal question!</span></span>
<span id="cb38-1212"><a href="#cb38-1212"></a></span>
<span id="cb38-1213"><a href="#cb38-1213"></a>We discover that asking a causal question is a multifaceted task. It demands careful definition of the outcome, including its timing, the exposure, and covariates. It also requires selecting the appropriate scale for causal contrast, controlling for confounding, and potentially adjusting for sample weights or stratification. Finally, when asking a causal question, we must consider for whom the results apply. Only after following these steps can we then ask: "How may we answer this causal question?"</span>
<span id="cb38-1214"><a href="#cb38-1214"></a></span>
<span id="cb38-1215"><a href="#cb38-1215"></a><span class="fu">## STEP 2: Answer Your Question</span></span>
<span id="cb38-1216"><a href="#cb38-1216"></a></span>
<span id="cb38-1217"><a href="#cb38-1217"></a><span class="fu">#### Obtain longitudinal data</span></span>
<span id="cb38-1218"><a href="#cb38-1218"></a></span>
<span id="cb38-1219"><a href="#cb38-1219"></a>Note that causal inference from observational data turns on the appropriate temporal ordering of the key variables involved in the study.</span>
<span id="cb38-1220"><a href="#cb38-1220"></a></span>
<span id="cb38-1221"><a href="#cb38-1221"></a>Recall we have defined.</span>
<span id="cb38-1222"><a href="#cb38-1222"></a></span>
<span id="cb38-1223"><a href="#cb38-1223"></a><span class="ss">-   </span>**A**: Our exposure or treatment variable, denoted as **A**. Here we consider the example of 'Church attendance'.</span>
<span id="cb38-1224"><a href="#cb38-1224"></a></span>
<span id="cb38-1225"><a href="#cb38-1225"></a><span class="ss">-   </span>**Y**: The outcome variable we are interested in, represented by **Y**, is psychological distress. We operationalise this variable through the 'Kessler-6' distress scale.</span>
<span id="cb38-1226"><a href="#cb38-1226"></a></span>
<span id="cb38-1227"><a href="#cb38-1227"></a><span class="ss">-   </span>**L**: The confounding variables, collectively referred to as **L**, represent factors that can independently influence both **A** and **Y**. For example, socio-economic status could be a confounder that impacts both the likelihood of church attendance and the levels of psychological distress.</span>
<span id="cb38-1228"><a href="#cb38-1228"></a></span>
<span id="cb38-1229"><a href="#cb38-1229"></a>Given the importance of temporal ordering, we must now define time:</span>
<span id="cb38-1230"><a href="#cb38-1230"></a></span>
<span id="cb38-1231"><a href="#cb38-1231"></a><span class="ss">-   </span>**t** $\in$ T: Let $t$ denote within a multiwave panel study with **T** measurement intervals.</span>
<span id="cb38-1232"><a href="#cb38-1232"></a></span>
<span id="cb38-1233"><a href="#cb38-1233"></a>Where $t/\text{{exposure}}$ denotes the measurement interval for the exposure. Longitudinal data collection provides us the ability to establish a causal model such that:</span>
<span id="cb38-1234"><a href="#cb38-1234"></a></span>
<span id="cb38-1235"><a href="#cb38-1235"></a>$$t_{confounders} &lt; t_{exposure}&lt; t_{outcome}$$</span>
<span id="cb38-1236"><a href="#cb38-1236"></a></span>
<span id="cb38-1237"><a href="#cb38-1237"></a>To minimise the posibility of time-varying confounding and obtain the clearest effect estimates, we should acquire the most recent values of $\mathbf{L}$ preceding $A$ and the latest values of $A$ before $Y$.</span>
<span id="cb38-1238"><a href="#cb38-1238"></a></span>
<span id="cb38-1239"><a href="#cb38-1239"></a>Note in @fig-dag-outcomewide, We use the prefixes "t0, t1, and t2" to denote temporal ordering. We include in the set of baseline confounders the pre-exposure measurement of *A* and *Y*. This allows for more substantial confounding control. For unmeasured confounder to affect both the exposure and the outcome, it would need to do so independently of the pre-exposure confounders. Additionally, including the baseline exposure gives us an effect estimate for the incidence exposure, rather than the prevelance of the exposure. This helps us to assess the expected change in the outcome were we to initate a change in the exposure.</span>
<span id="cb38-1240"><a href="#cb38-1240"></a></span>
<span id="cb38-1241"><a href="#cb38-1241"></a><span class="fu">### Include the measured exposure with baseline covariates</span></span>
<span id="cb38-1242"><a href="#cb38-1242"></a></span>
<span id="cb38-1243"><a href="#cb38-1243"></a>Controlling for prior exposure enables the interpretation of the effect estimate as a change in the exposure in a manner akin to a randomised trial. We propose that the effect estimate with prior control for the exposure estimates the "incidence exposure" rather than the "prevalence exposure" <span class="co">[</span><span class="ot">@danaei2012</span><span class="co">]</span>. It is crucial to estimate the incidence exposure because if the effects of an exposure are harmful in the short term such that these effects are not subsequently measured, a failure to adjust for prior exposure will yield the illusion that the exposure is beneficial. Furthermore, this approach aids in controlling for unmeasured confounding. For such a confounder to explain away the observed exposure-outcome association, it would need to do so independently of the prior level of the exposure and outcome.</span>
<span id="cb38-1244"><a href="#cb38-1244"></a></span>
<span id="cb38-1245"><a href="#cb38-1245"></a><span class="fu">### State the eligibility criteria for participation</span></span>
<span id="cb38-1246"><a href="#cb38-1246"></a></span>
<span id="cb38-1247"><a href="#cb38-1247"></a>This step is invaluable for assessing whether we are answering the causal question that we have asked.</span>
<span id="cb38-1248"><a href="#cb38-1248"></a></span>
<span id="cb38-1249"><a href="#cb38-1249"></a><span class="fu">#### Consider:</span></span>
<span id="cb38-1250"><a href="#cb38-1250"></a></span>
<span id="cb38-1251"><a href="#cb38-1251"></a><span class="ss">-   </span>Generalisability: we cannot evaluate inferences to a target group from the source population if we do not describe the source population</span>
<span id="cb38-1252"><a href="#cb38-1252"></a><span class="ss">-   </span>Eligibility criteria will help us to ensure whether we have correctly evaluated potential measurement bias/error in our instruments.</span>
<span id="cb38-1253"><a href="#cb38-1253"></a></span>
<span id="cb38-1254"><a href="#cb38-1254"></a>For example, the New Zealand Attitudes and Values Study is a National Probability study of New Zealanders. The details provided in the supplementary materials describe how individuals were randomly selected from the country's electoral roll. From these invitations there was typically less than 15% response rate. How might this process of recruitment affect generalisability and transportability of our results?</span>
<span id="cb38-1255"><a href="#cb38-1255"></a></span>
<span id="cb38-1256"><a href="#cb38-1256"></a><span class="ss">-   </span>Aside: discuss per protocol effects/ intention to treat effects</span>
<span id="cb38-1257"><a href="#cb38-1257"></a></span>
<span id="cb38-1258"><a href="#cb38-1258"></a><span class="fu">### Determine how missing data will be handled</span></span>
<span id="cb38-1259"><a href="#cb38-1259"></a></span>
<span id="cb38-1260"><a href="#cb38-1260"></a><span class="ss">-   </span>As we will consider in the upcoming weeks, loss to follow up and non-response opens sources for bias. We must develop a strategy for handling missing data.</span>
<span id="cb38-1261"><a href="#cb38-1261"></a></span>
<span id="cb38-1262"><a href="#cb38-1262"></a><span class="fu">### State a statistical model</span></span>
<span id="cb38-1263"><a href="#cb38-1263"></a></span>
<span id="cb38-1264"><a href="#cb38-1264"></a>The models we have considered in this course are G-computation, Inverse Probability of Treatement Weighting, and Doubly-Robust estimation.</span>
<span id="cb38-1265"><a href="#cb38-1265"></a></span>
<span id="cb38-1266"><a href="#cb38-1266"></a><span class="fu">### Reporting</span></span>
<span id="cb38-1267"><a href="#cb38-1267"></a></span>
<span id="cb38-1268"><a href="#cb38-1268"></a>Consider the following ideas about how to report one's model:</span>
<span id="cb38-1269"><a href="#cb38-1269"></a></span>
<span id="cb38-1270"><a href="#cb38-1270"></a><span class="ss">-   </span>**Estimator**: Doubly robust where possible.</span>
<span id="cb38-1271"><a href="#cb38-1271"></a><span class="ss">-   </span>**Propensity Score Reporting:** Detail the process of propensity score derivation, including the model used and any variable transformations.</span>
<span id="cb38-1272"><a href="#cb38-1272"></a><span class="ss">-   </span>**WeightIt Package:** Explicitly mention the use of the 'WeightIt' package in R, including any specific options or parameters used in the propensity score estimation process.</span>
<span id="cb38-1273"><a href="#cb38-1273"></a><span class="ss">-   </span>**Method Variations:** Report if different methods were used to obtain propensity scores, and the reasons behind the choice of methods such as 'ebal', 'energy', and 'ps'.</span>
<span id="cb38-1274"><a href="#cb38-1274"></a><span class="ss">-   </span>**Continuous Exposures:** Highlight that for continuous exposures, only the 'energy' option was used for propensity score estimation. (not relevant for your report)</span>
<span id="cb38-1275"><a href="#cb38-1275"></a><span class="ss">-  </span>**Binary Exposure** Justify your cutpoints by referencing theory/existing knowledge *in advance* of conducting the analysis.</span>
<span id="cb38-1276"><a href="#cb38-1276"></a><span class="ss">-   </span>**Subgroup Estimation:** Confirm that the propensity scores for subgroups were estimated separately, and discuss how the weights were subsequently combined with the original data.</span>
<span id="cb38-1277"><a href="#cb38-1277"></a><span class="ss">-   </span>**Covariate Balance:** Include a Love plot to visually represent covariate balance on the exposure both before and after weighting.</span>
<span id="cb38-1278"><a href="#cb38-1278"></a><span class="ss">-   </span>**Weighting Algorithm Statistics:** Report the statistics for the weighting algorithms as provided by the WeightIt package, including any measures of balance or fit.</span>
<span id="cb38-1279"><a href="#cb38-1279"></a><span class="ss">-   </span>**Outcome Regression Model:** Clearly report the type of regression model used to estimate outcome model coefficients (e.g., linear regression, Poisson, binomial), and mention if the exposure was interacted with the baseline covariates. Do not report model coefficients as these have no interpretation.</span>
<span id="cb38-1280"><a href="#cb38-1280"></a><span class="ss">-   </span>**Subgroup Interaction:** Address whether the subgroup was included separately as an interaction in the outcome model, and if the model successfully converged.</span>
<span id="cb38-1281"><a href="#cb38-1281"></a><span class="ss">-   </span>**Machine Learning Using `lmtp`** If using the <span class="in">`lmtp`</span> package, do a stratified analysis. (see today's lab)</span>
<span id="cb38-1282"><a href="#cb38-1282"></a><span class="ss">-   </span>**Model coefficients:** note that the model coefficients should not be interpreted, as they are not meaningful in this context.</span>
<span id="cb38-1283"><a href="#cb38-1283"></a><span class="ss">-   </span>**Confidence intervals and standard errors:** Describe the methods used to derive confidence intervals and standard errors, noting the use of the 'clarify' package in R for simulation based inference.</span>
<span id="cb38-1284"><a href="#cb38-1284"></a></span>
<span id="cb38-1285"><a href="#cb38-1285"></a><span class="fu">### Example of how to report a doubly robust method in your report</span></span>
<span id="cb38-1286"><a href="#cb38-1286"></a></span>
<span id="cb38-1287"><a href="#cb38-1287"></a>The Doubly Robust Estimation method for Subgroup Analysis Estimator is a sophisticated tool combining features of both IPTW and G-computation methods, providing unbiased estimates if either the propensity score or outcome model is correctly specified. The process involves five main steps:</span>
<span id="cb38-1288"><a href="#cb38-1288"></a></span>
<span id="cb38-1289"><a href="#cb38-1289"></a>**Step 1** involves the estimation of the propensity score, a measure of the conditional probability of exposure given the covariates and the subgroup indicator. This score is calculated using statistical models such as logistic regression, with the model choice depending on the nature of the data and exposure. Weights for each individual are then calculated using this propensity score. These weights depend on the exposure status and are computed differently for exposed and unexposed individuals. The estimation of propensity scores is performed separately within each subgroup stratum.</span>
<span id="cb38-1290"><a href="#cb38-1290"></a></span>
<span id="cb38-1291"><a href="#cb38-1291"></a>**Step 2** focuses on fitting a weighted outcome model, making use of the previously calculated weights from the propensity scores. This model estimates the outcome conditional on exposure, covariates, and subgroup, integrating the weights into the estimation process. Unlike in propensity score model estimation, covariates are included as variables in the outcome model. This inclusion makes the method doubly robust - providing a consistent effect estimate if either the propensity score or the outcome model is correctly specified, thereby reducing the assumption of correct model specification.</span>
<span id="cb38-1292"><a href="#cb38-1292"></a></span>
<span id="cb38-1293"><a href="#cb38-1293"></a>**Step 3** entails the simulation of potential outcomes for each individual in each subgroup. These hypothetical scenarios assume universal exposure to the intervention within each subgroup, regardless of actual exposure levels. The expectation of potential outcomes is calculated for each individual in each subgroup, using individual-specific weights. These scenarios are performed for both the current and alternative interventions.</span>
<span id="cb38-1294"><a href="#cb38-1294"></a></span>
<span id="cb38-1295"><a href="#cb38-1295"></a>**Step 4** is the estimation of the average causal effect for each subgroup, achieved by comparing the computed expected values of potential outcomes under each intervention level. The difference represents the average causal effect of changing the exposure within each subgroup. </span>
<span id="cb38-1296"><a href="#cb38-1296"></a></span>
<span id="cb38-1297"><a href="#cb38-1297"></a>**Step 5** involves comparing differences in causal effects across groups by calculating the differences in the estimated causal effects between different subgroups. Confidence intervals and standard errors for these calculations are determined using simulation-based inference methods <span class="co">[</span><span class="ot">@greifer2023</span><span class="co">]</span>. This step allows for a comprehensive comparison of the impact of different interventions across various subgroups, while encorporating uncertainty.</span>
<span id="cb38-1298"><a href="#cb38-1298"></a></span>
<span id="cb38-1299"><a href="#cb38-1299"></a><span class="fu">### Inference</span></span>
<span id="cb38-1300"><a href="#cb38-1300"></a></span>
<span id="cb38-1301"><a href="#cb38-1301"></a>Consider the following ideas about what to discuss in one's findings:</span>
<span id="cb38-1302"><a href="#cb38-1302"></a>Consider the following ideas about what to discuss in one's findings. The order of exposition might be different.</span>
<span id="cb38-1303"><a href="#cb38-1303"></a></span>
<span id="cb38-1304"><a href="#cb38-1304"></a><span class="ss">1.  </span>**Summary of results**:  What did you find?</span>
<span id="cb38-1305"><a href="#cb38-1305"></a></span>
<span id="cb38-1306"><a href="#cb38-1306"></a><span class="ss">2. </span>**Interpretation of E-values:** Interpret the E-values used for sensitivity analysis. State what they represent in terms of the robustness of the findings to potential unmeasured confounding.</span>
<span id="cb38-1307"><a href="#cb38-1307"></a></span>
<span id="cb38-1308"><a href="#cb38-1308"></a><span class="ss">3.  </span>**Causal Effect Interpretation:** What is the interest of the effect, if any, if an effect was observed? Interpret the average causal effect of changing the exposure level within each subgroup, and discuss its relevance to the research question. </span>
<span id="cb38-1309"><a href="#cb38-1309"></a></span>
<span id="cb38-1310"><a href="#cb38-1310"></a><span class="ss">4.  </span>**Comparison of Subgroups:** Discuss how differences in causal effect estimates between different subgroups, if observed, or if not observed, contribute to the overall findings of the study.</span>
<span id="cb38-1311"><a href="#cb38-1311"></a></span>
<span id="cb38-1312"><a href="#cb38-1312"></a><span class="ss">5.  </span>**Uncertainty and Confidence Intervals:** Consider the uncertainty around the estimated causal effects, and interpret the confidence intervals to understand the precision of the estimates.</span>
<span id="cb38-1313"><a href="#cb38-1313"></a></span>
<span id="cb38-1314"><a href="#cb38-1314"></a><span class="ss">6.  </span>**Generalisability and Transportability:** Reflect on the generalizability of the study results to other contexts or populations. Discuss any factors that might influence the transportability of the causal effects found in the study. (Again see lecture 9.)</span>
<span id="cb38-1315"><a href="#cb38-1315"></a></span>
<span id="cb38-1316"><a href="#cb38-1316"></a><span class="ss">7.  </span>**Assumptions and Limitations:** Reflect on the assumptions made during the study and identify any limitations in the methodology that could affect the interpretation of results. State that the implications of different intervention levels on potential outcomes are not analysed. </span>
<span id="cb38-1317"><a href="#cb38-1317"></a></span>
<span id="cb38-1318"><a href="#cb38-1318"></a><span class="ss">8.  </span>**Theoretical Relevance**: How are these findings relevant to existing theories. </span>
<span id="cb38-1319"><a href="#cb38-1319"></a></span>
<span id="cb38-1320"><a href="#cb38-1320"></a><span class="ss">9.  </span>**Replication and Future Research:** Consider how the study could be replicated or expanded upon in future research, and how the findings contribute to the existing body of knowledge in the field.</span>
<span id="cb38-1321"><a href="#cb38-1321"></a></span>
<span id="cb38-1322"><a href="#cb38-1322"></a><span class="ss">10. </span>**Real-world Implications:** Discuss the real-world implications of the findings, and how they could be applied in policy, practice, or further research.</span>
<span id="cb38-1323"><a href="#cb38-1323"></a></span>
<span id="cb38-1324"><a href="#cb38-1324"></a></span>
<span id="cb38-1325"><a href="#cb38-1325"></a><span class="fu">## Appendix A: Details of Estimation Approaches</span></span>
<span id="cb38-1326"><a href="#cb38-1326"></a></span>
<span id="cb38-1327"><a href="#cb38-1327"></a><span class="fu">### G-computation for Subgroup Analysis Estimator</span></span>
<span id="cb38-1328"><a href="#cb38-1328"></a></span>
<span id="cb38-1329"><a href="#cb38-1329"></a>**Step 1:** Estimate the outcome model. Fit a model for the outcome $Y$, conditional on the exposure $A$, the covariates $L$, and subgroup indicator $G$. This model can be a linear regression, logistic regression, or another statistical model. The goal is to capture the relationship between the outcome, exposure, confounders, and subgroups.</span>
<span id="cb38-1330"><a href="#cb38-1330"></a></span>
<span id="cb38-1331"><a href="#cb38-1331"></a>$$ \hat{E}(Y|A,L,G) = f_Y(A,L,G; \theta_Y) $$</span>
<span id="cb38-1332"><a href="#cb38-1332"></a></span>
<span id="cb38-1333"><a href="#cb38-1333"></a>This equation represents the expected value of the outcome $Y$ given the exposure $A$, covariates $L$, and subgroup $G$, as modelled by the function $f_Y$ with parameters $\theta_Y$. This formulation allows for the prediction of the average outcome $Y$ given certain values of $A$, $L$, and $G$.</span>
<span id="cb38-1334"><a href="#cb38-1334"></a></span>
<span id="cb38-1335"><a href="#cb38-1335"></a>**Step 2:** Simulate potential outcomes. For each individual in each subgroup, predict their potential outcome under the intervention $A=a$ using the estimated outcome model:</span>
<span id="cb38-1336"><a href="#cb38-1336"></a></span>
<span id="cb38-1337"><a href="#cb38-1337"></a>$$\hat{E}(Y(a)|G=g) = \hat{E}<span class="co">[</span><span class="ot">Y|A=a,L,G=g; \hat{\theta}_Y</span><span class="co">]</span>$$</span>
<span id="cb38-1338"><a href="#cb38-1338"></a></span>
<span id="cb38-1339"><a href="#cb38-1339"></a>We also predict the potential outcome for everyone in each subgroup under the causal contrast, setting the intervention for everyone in that group to $A=a'$:</span>
<span id="cb38-1340"><a href="#cb38-1340"></a></span>
<span id="cb38-1341"><a href="#cb38-1341"></a>$$\hat{E}(Y(a')|G=g) = \hat{E}<span class="co">[</span><span class="ot">Y|A=a',L,G=g; \hat{\theta}_Y</span><span class="co">]</span>$$</span>
<span id="cb38-1342"><a href="#cb38-1342"></a></span>
<span id="cb38-1343"><a href="#cb38-1343"></a>In these equations, $Y$ represents the potential outcome, $A$ is the intervention, $L$ are the covariates, $G=g$ represents the subgroup, and $\theta_Y$ are the parameters of the outcome model.</span>
<span id="cb38-1344"><a href="#cb38-1344"></a></span>
<span id="cb38-1345"><a href="#cb38-1345"></a>**Step 3:** Calculate the estimated difference for each subgroup $g$:</span>
<span id="cb38-1346"><a href="#cb38-1346"></a></span>
<span id="cb38-1347"><a href="#cb38-1347"></a>$$\hat{\delta}_g = \hat{E}<span class="co">[</span><span class="ot">Y(a)|G=g</span><span class="co">]</span> - \hat{E}<span class="co">[</span><span class="ot">Y(a')|G=g</span><span class="co">]</span>$$</span>
<span id="cb38-1348"><a href="#cb38-1348"></a></span>
<span id="cb38-1349"><a href="#cb38-1349"></a>This difference $\hat{\delta}_g$ represents the average causal effect of changing the exposure from level $a'$ to level $a$ within each subgroup $g$.</span>
<span id="cb38-1350"><a href="#cb38-1350"></a></span>
<span id="cb38-1351"><a href="#cb38-1351"></a>We use simulation-based inference methods to compute standard errors and confidence intervals <span class="co">[</span><span class="ot">@greifer2023</span><span class="co">]</span>.</span>
<span id="cb38-1352"><a href="#cb38-1352"></a></span>
<span id="cb38-1353"><a href="#cb38-1353"></a>**Step 4:** Compare differences in causal effects by subgroups:</span>
<span id="cb38-1354"><a href="#cb38-1354"></a></span>
<span id="cb38-1355"><a href="#cb38-1355"></a>$$\hat{\gamma} = \hat{\delta}_g - \hat{\delta}_{g'}$$</span>
<span id="cb38-1356"><a href="#cb38-1356"></a></span>
<span id="cb38-1357"><a href="#cb38-1357"></a>where,</span>
<span id="cb38-1358"><a href="#cb38-1358"></a></span>
<span id="cb38-1359"><a href="#cb38-1359"></a>$$\hat{\gamma} = \overbrace{\big( \hat{E}<span class="co">[</span><span class="ot">Y(a)|G=g</span><span class="co">]</span> - \hat{E}<span class="co">[</span><span class="ot">Y(a^{\prime})|G=g</span><span class="co">]</span> \big)}^{\hat{\delta_g}} - \overbrace{\big(\hat{E}<span class="co">[</span><span class="ot">Y(a^{\prime})|G=g^{\prime}</span><span class="co">]</span>- \hat{E}<span class="co">[</span><span class="ot">Y(a)|G=g^{\prime}</span><span class="co">]</span>\big)}^{\hat{\delta_{g^{\prime}}}}$$</span>
<span id="cb38-1360"><a href="#cb38-1360"></a></span>
<span id="cb38-1361"><a href="#cb38-1361"></a>This difference $\hat{\gamma}$ represents the difference in the average causal effects between the subgroups $g$ and $g'$. It measures the difference in effect of the exposure $A$ within subgroup $G$ on the outcome $Y$.</span>
<span id="cb38-1362"><a href="#cb38-1362"></a></span>
<span id="cb38-1363"><a href="#cb38-1363"></a></span>
<span id="cb38-1364"><a href="#cb38-1364"></a><span class="ot">[^note_care]</span> </span>
<span id="cb38-1365"><a href="#cb38-1365"></a></span>
<span id="cb38-1366"><a href="#cb38-1366"></a><span class="ot">[^note_care]: </span>$A$ and $G$ on $Y$ might not be additive. We assume that the potential confounders $L$ are sufficient to control for confounding. See Appendix</span>
<span id="cb38-1367"><a href="#cb38-1367"></a></span>
<span id="cb38-1368"><a href="#cb38-1368"></a></span>
<span id="cb38-1369"><a href="#cb38-1369"></a>We again use simulation-based inference methods to compute standard errors and confidence intervals <span class="co">[</span><span class="ot">@greifer2023</span><span class="co">]</span>.</span>
<span id="cb38-1370"><a href="#cb38-1370"></a></span>
<span id="cb38-1371"><a href="#cb38-1371"></a></span>
<span id="cb38-1372"><a href="#cb38-1372"></a></span>
<span id="cb38-1373"><a href="#cb38-1373"></a></span>
<span id="cb38-1374"><a href="#cb38-1374"></a><span class="fu">### Inverse Probability of Treatment Weighting (IPTW) for Subgroup Analysis Estimator</span></span>
<span id="cb38-1375"><a href="#cb38-1375"></a></span>
<span id="cb38-1376"><a href="#cb38-1376"></a></span>
<span id="cb38-1377"><a href="#cb38-1377"></a>**Step 1:** Estimate the propensity score. The propensity score $e(L, G)$ is the conditional probability of the exposure $A = 1$, given the covariates $L$ and subgroup indicator $G$. This can be modeled using logistic regression or other suitable methods, depending on the nature of the data and the exposure.</span>
<span id="cb38-1378"><a href="#cb38-1378"></a></span>
<span id="cb38-1379"><a href="#cb38-1379"></a>$$\hat{e} = P(A = 1 | L, G) = f_A(L, G; \theta_A)$$</span>
<span id="cb38-1380"><a href="#cb38-1380"></a></span>
<span id="cb38-1381"><a href="#cb38-1381"></a>Here, $f_A(L, G; \theta_A)$ is a function (statistical model) that estimates the probability of the exposure $A = 1$ given covariates $L$ and subgroup $G$. Then, we calculate the weights for each individual, denoted as $v$, using the estimated propensity score:</span>
<span id="cb38-1382"><a href="#cb38-1382"></a></span>
<span id="cb38-1383"><a href="#cb38-1383"></a>$$</span>
<span id="cb38-1384"><a href="#cb38-1384"></a>v = </span>
<span id="cb38-1385"><a href="#cb38-1385"></a>\begin{cases} </span>
<span id="cb38-1386"><a href="#cb38-1386"></a>\frac{1}{\hat{e}} &amp; \text{if } A = 1 <span class="sc">\\</span></span>
<span id="cb38-1387"><a href="#cb38-1387"></a>\frac{1}{1-\hat{e}} &amp; \text{if } A = 0 </span>
<span id="cb38-1388"><a href="#cb38-1388"></a>\end{cases}</span>
<span id="cb38-1389"><a href="#cb38-1389"></a>$$</span>
<span id="cb38-1390"><a href="#cb38-1390"></a></span>
<span id="cb38-1391"><a href="#cb38-1391"></a>**Step 2:** Fit a weighted outcome model. Using the weights calculated from the estimated propensity scores, fit a model for the outcome $Y$, conditional on the exposure $A$ and subgroup $G$. This can be represented as:</span>
<span id="cb38-1392"><a href="#cb38-1392"></a></span>
<span id="cb38-1393"><a href="#cb38-1393"></a>$$ \hat{E}(Y|A, G; V) = f_Y(A, G ; \theta_Y, V) $$</span>
<span id="cb38-1394"><a href="#cb38-1394"></a></span>
<span id="cb38-1395"><a href="#cb38-1395"></a>In this model, $f_Y$ is a function (such as a weighted regression model) with parameters $θ_Y$.</span>
<span id="cb38-1396"><a href="#cb38-1396"></a></span>
<span id="cb38-1397"><a href="#cb38-1397"></a>**Step 3:** Simulate potential outcomes. For each individual in each subgroup, simulate their potential outcome under the hypothetical scenario where everyone in the subgroup is exposed to the intervention $A=a$ regardless of their actual exposure level:</span>
<span id="cb38-1398"><a href="#cb38-1398"></a></span>
<span id="cb38-1399"><a href="#cb38-1399"></a>$$\hat{E}(Y(a)|G=g) = \hat{E}<span class="co">[</span><span class="ot">Y|A=a,G=g; \hat{\theta}_Y, v</span><span class="co">]</span>$$</span>
<span id="cb38-1400"><a href="#cb38-1400"></a></span>
<span id="cb38-1401"><a href="#cb38-1401"></a>And also under the hypothetical scenario where everyone is exposed to intervention $A=a'$:</span>
<span id="cb38-1402"><a href="#cb38-1402"></a></span>
<span id="cb38-1403"><a href="#cb38-1403"></a>$$\hat{E}(Y(a')|G=g) = \hat{E}<span class="co">[</span><span class="ot">Y|A=a',G=g; \hat{\theta}_Y, v</span><span class="co">]</span>$$</span>
<span id="cb38-1404"><a href="#cb38-1404"></a></span>
<span id="cb38-1405"><a href="#cb38-1405"></a>**Step 4:** Estimate the average causal effect for each subgroup as the difference in the predicted outcomes:</span>
<span id="cb38-1406"><a href="#cb38-1406"></a></span>
<span id="cb38-1407"><a href="#cb38-1407"></a>$$\hat{\delta}_g = \hat{E}<span class="co">[</span><span class="ot">Y(a)|G=g</span><span class="co">]</span> - \hat{E}<span class="co">[</span><span class="ot">Y(a')|G=g</span><span class="co">]</span>$$</span>
<span id="cb38-1408"><a href="#cb38-1408"></a></span>
<span id="cb38-1409"><a href="#cb38-1409"></a>The estimated difference $\hat{\delta}_g$ represents the average causal effect within group $g$.</span>
<span id="cb38-1410"><a href="#cb38-1410"></a></span>
<span id="cb38-1411"><a href="#cb38-1411"></a>**Step 5:** Compare differences in causal effects by groups. Compute the differences in the estimated causal effects between different subgroups:</span>
<span id="cb38-1412"><a href="#cb38-1412"></a></span>
<span id="cb38-1413"><a href="#cb38-1413"></a>$$\hat{\gamma} = \hat{\delta}_g - \hat{\delta}_{g'}$$</span>
<span id="cb38-1414"><a href="#cb38-1414"></a></span>
<span id="cb38-1415"><a href="#cb38-1415"></a>where,</span>
<span id="cb38-1416"><a href="#cb38-1416"></a></span>
<span id="cb38-1417"><a href="#cb38-1417"></a>$$\hat{\gamma} = \overbrace{\big( \hat{E}<span class="co">[</span><span class="ot">Y(a)|G=g</span><span class="co">]</span> - \hat{E}<span class="co">[</span><span class="ot">Y(a')|G=g</span><span class="co">]</span> \big)}^{\hat{\delta_g}} - \overbrace{\big(\hat{E}<span class="co">[</span><span class="ot">Y(a')|G=g'</span><span class="co">]</span>- \hat{E}<span class="co">[</span><span class="ot">Y(a)|G=g'</span><span class="co">]</span>\big)}^{\hat{\delta_{g'}}}$$</span>
<span id="cb38-1418"><a href="#cb38-1418"></a></span>
<span id="cb38-1419"><a href="#cb38-1419"></a>This $\hat{\gamma}$ represents the difference in the average causal effects between the subgroups $g$ and $g'$.</span>
<span id="cb38-1420"><a href="#cb38-1420"></a></span>
<span id="cb38-1421"><a href="#cb38-1421"></a></span>
<span id="cb38-1422"><a href="#cb38-1422"></a>We again use simulation-based inference methods to compute standard errors and confidence intervals <span class="co">[</span><span class="ot">@greifer2023</span><span class="co">]</span>.</span>
<span id="cb38-1423"><a href="#cb38-1423"></a></span>
<span id="cb38-1424"><a href="#cb38-1424"></a></span>
<span id="cb38-1425"><a href="#cb38-1425"></a><span class="fu">### Doubly Robust Estimation for Subgroup Analysis Estimator</span></span>
<span id="cb38-1426"><a href="#cb38-1426"></a>It appears that the Doubly Robust Estimation explanation for subgroup analysis is already clear and correct, covering all the necessary steps in the process. Nevertheless, there's a slight confusion in step 4. The difference $\delta_g$ is not defined within the document. I assume that you intended to write $\hat{\delta}_g$. Here's the corrected version:</span>
<span id="cb38-1427"><a href="#cb38-1427"></a></span>
<span id="cb38-1428"><a href="#cb38-1428"></a><span class="fu">### Doubly Robust Estimation for Subgroup Analysis Estimator</span></span>
<span id="cb38-1429"><a href="#cb38-1429"></a></span>
<span id="cb38-1430"><a href="#cb38-1430"></a>Doubly Robust Estimation is a powerful technique that combines the strengths of both the IPTW and G-computation methods. It uses both the propensity score model and the outcome model, which makes it doubly robust: it produces unbiased estimates if either one of the models is correctly specified.</span>
<span id="cb38-1431"><a href="#cb38-1431"></a></span>
<span id="cb38-1432"><a href="#cb38-1432"></a>**Step 1** Estimate the propensity score. The propensity score $\hat{e}(L, G)$ is the conditional probability of the exposure $A = 1$, given the covariates $L$ and subgroup indicator $G$. This can be modeled using logistic regression or other suitable methods, depending on the nature of the data and the exposure.</span>
<span id="cb38-1433"><a href="#cb38-1433"></a></span>
<span id="cb38-1434"><a href="#cb38-1434"></a>$$\hat{e} = P(A = 1 | L, G) = f_A(L, G; \theta_A)$$</span>
<span id="cb38-1435"><a href="#cb38-1435"></a></span>
<span id="cb38-1436"><a href="#cb38-1436"></a>Here, $f_A(L, G; \theta_A)$ is a function (statistical model) that estimates the probability of the exposure $A = 1$ given covariates $L$ and subgroup $G$. Then, we calculate the weights for each individual, denoted as $v$, using the estimated propensity score:</span>
<span id="cb38-1437"><a href="#cb38-1437"></a></span>
<span id="cb38-1438"><a href="#cb38-1438"></a>$$</span>
<span id="cb38-1439"><a href="#cb38-1439"></a>v = </span>
<span id="cb38-1440"><a href="#cb38-1440"></a>\begin{cases} </span>
<span id="cb38-1441"><a href="#cb38-1441"></a>\frac{1}{\hat{e}} &amp; \text{if } A = 1 <span class="sc">\\</span></span>
<span id="cb38-1442"><a href="#cb38-1442"></a>\frac{1}{1-\hat{e}} &amp; \text{if } A = 0 </span>
<span id="cb38-1443"><a href="#cb38-1443"></a>\end{cases}</span>
<span id="cb38-1444"><a href="#cb38-1444"></a>$$</span>
<span id="cb38-1445"><a href="#cb38-1445"></a></span>
<span id="cb38-1446"><a href="#cb38-1446"></a>**Step 2** Fit a weighted outcome model. Using the weights calculated from the estimated propensity scores, fit a model for the outcome $Y$, conditional on the exposure $A$, covariates $L$, and subgroup $G$.</span>
<span id="cb38-1447"><a href="#cb38-1447"></a></span>
<span id="cb38-1448"><a href="#cb38-1448"></a>$$ \hat{E}(Y|A, L, G; V) = f_Y(A, L, G ; \theta_Y, V) $$</span>
<span id="cb38-1449"><a href="#cb38-1449"></a></span>
<span id="cb38-1450"><a href="#cb38-1450"></a>**Step 3** For each individual in each subgroup, simulate their potential outcome under the hypothetical scenario where everyone in the subgroup is exposed to the intervention $A=a$ regardless of their actual exposure level:</span>
<span id="cb38-1451"><a href="#cb38-1451"></a></span>
<span id="cb38-1452"><a href="#cb38-1452"></a>$$\hat{E}(Y(a)|G=g) = \hat{E}<span class="co">[</span><span class="ot">Y|A=a,G=g; L,\hat{\theta}_Y, v</span><span class="co">]</span>$$</span>
<span id="cb38-1453"><a href="#cb38-1453"></a></span>
<span id="cb38-1454"><a href="#cb38-1454"></a>And also under the hypothetical scenario where everyone in each subgroup is exposed to intervention $A=a'$:</span>
<span id="cb38-1455"><a href="#cb38-1455"></a></span>
<span id="cb38-1456"><a href="#cb38-1456"></a>$$\hat{E}(Y(a')|G=g) = \hat{E}<span class="co">[</span><span class="ot">Y|A=a',G=g; L; \hat{\theta}_Y, v</span><span class="co">]</span>$$</span>
<span id="cb38-1457"><a href="#cb38-1457"></a></span>
<span id="cb38-1458"><a href="#cb38-1458"></a>**Step 4** Estimate the average causal effect for each subgroup. Compute the estimated expected value of the potential outcomes under each intervention level for each subgroup:</span>
<span id="cb38-1459"><a href="#cb38-1459"></a></span>
<span id="cb38-1460"><a href="#cb38-1460"></a>$$\hat{\delta}_g = \hat{E}<span class="co">[</span><span class="ot">Y(a)|G=g</span><span class="co">]</span> - \hat{E}<span class="co">[</span><span class="ot">Y(a')|G=g</span><span class="co">]</span>$$</span>
<span id="cb38-1461"><a href="#cb38-1461"></a></span>
<span id="cb38-1462"><a href="#cb38-1462"></a>The estimated difference $\hat{\delta}_g$ represents the average causal effect of changing the exposure from level $a'$ to level $a$ within each subgroup.</span>
<span id="cb38-1463"><a href="#cb38-1463"></a></span>
<span id="cb38-1464"><a href="#cb38-1464"></a>**Step 5** Compare differences in causal effects by groups. Compute the differences in the estimated causal effects between different subgroups:</span>
<span id="cb38-1465"><a href="#cb38-1465"></a></span>
<span id="cb38-1466"><a href="#cb38-1466"></a>$$\hat{\gamma} = \hat{\delta}_g - \hat{\delta}_{g'}$$</span>
<span id="cb38-1467"><a href="#cb38-1467"></a></span>
<span id="cb38-1468"><a href="#cb38-1468"></a>where,</span>
<span id="cb38-1469"><a href="#cb38-1469"></a></span>
<span id="cb38-1470"><a href="#cb38-1470"></a>$$\hat{\gamma} = \overbrace{\big( \hat{E}<span class="co">[</span><span class="ot">Y(a)|G=g</span><span class="co">]</span> - \hat{E}<span class="co">[</span><span class="ot">Y(a')|G=g</span><span class="co">]</span> \big)}^{\hat{\delta_g}} - \overbrace{\big(\hat{E}<span class="co">[</span><span class="ot">Y(a')|G=g'</span><span class="co">]</span>- \hat{E}<span class="co">[</span><span class="ot">Y(a)|G=g'</span><span class="co">]</span>\big)}^{\hat{\delta_{g'}}}$$</span>
<span id="cb38-1471"><a href="#cb38-1471"></a></span>
<span id="cb38-1472"><a href="#cb38-1472"></a></span>
<span id="cb38-1473"><a href="#cb38-1473"></a>We again use simulation-based inference methods to compute standard errors and confidence intervals <span class="co">[</span><span class="ot">@greifer2023</span><span class="co">]</span>.</span>
<span id="cb38-1474"><a href="#cb38-1474"></a></span>
<span id="cb38-1475"><a href="#cb38-1475"></a></span>
<span id="cb38-1476"><a href="#cb38-1476"></a><span class="fu">## Appendix B: G-computation for Subgroup Analysis Estimator with Non-Additive Effects</span></span>
<span id="cb38-1477"><a href="#cb38-1477"></a></span>
<span id="cb38-1478"><a href="#cb38-1478"></a>**Step 1:** Estimate the outcome model. Fit a model for the outcome $Y$, conditional on the exposure $A$, the covariates $L$, subgroup indicator $G$, and interactions between $A$ and $G$. This model can be a linear regression, logistic regression, or another statistical model. The goal is to capture the relationship between the outcome, exposure, confounders, subgroups, and their interactions.</span>
<span id="cb38-1479"><a href="#cb38-1479"></a></span>
<span id="cb38-1480"><a href="#cb38-1480"></a>$$ \hat{E}(Y|A,L,G,AG) = f_Y(A,L,G,AG; \theta_Y) $$</span>
<span id="cb38-1481"><a href="#cb38-1481"></a></span>
<span id="cb38-1482"><a href="#cb38-1482"></a>This equation represents the expected value of the outcome $Y$ given the exposure $A$, covariates $L$, subgroup $G$, and interaction term $AG$, as modeled by the function $f_Y$ with parameters $\theta_Y$. </span>
<span id="cb38-1483"><a href="#cb38-1483"></a></span>
<span id="cb38-1484"><a href="#cb38-1484"></a>**Step 2:** Simulate potential outcomes. For each individual in each subgroup, predict their potential outcome under the intervention $A=a$ using the estimated outcome model:</span>
<span id="cb38-1485"><a href="#cb38-1485"></a></span>
<span id="cb38-1486"><a href="#cb38-1486"></a>$$\hat{E}(Y(a)|G=g) = \hat{E}<span class="co">[</span><span class="ot">Y|A=a,L,G=g,AG=ag; \hat{\theta}_Y</span><span class="co">]</span>$$</span>
<span id="cb38-1487"><a href="#cb38-1487"></a></span>
<span id="cb38-1488"><a href="#cb38-1488"></a>We also predict the potential outcome for everyone in each subgroup under the causal contrast, setting the intervention for everyone in that group to $A=a'$:</span>
<span id="cb38-1489"><a href="#cb38-1489"></a></span>
<span id="cb38-1490"><a href="#cb38-1490"></a>$$\hat{E}(Y(a')|G=g) = \hat{E}<span class="co">[</span><span class="ot">Y|A=a',L,G=g,AG=a'g; \hat{\theta}_Y</span><span class="co">]</span>$$</span>
<span id="cb38-1491"><a href="#cb38-1491"></a></span>
<span id="cb38-1492"><a href="#cb38-1492"></a>**Step 3:** Calculate the estimated difference for each subgroup $g$:</span>
<span id="cb38-1493"><a href="#cb38-1493"></a></span>
<span id="cb38-1494"><a href="#cb38-1494"></a>$$\hat{\delta}_g = \hat{E}<span class="co">[</span><span class="ot">Y(a)|G=g</span><span class="co">]</span> - \hat{E}<span class="co">[</span><span class="ot">Y(a')|G=g</span><span class="co">]</span>$$</span>
<span id="cb38-1495"><a href="#cb38-1495"></a></span>
<span id="cb38-1496"><a href="#cb38-1496"></a>**Step 4:** Compare differences in causal effects by subgroups:</span>
<span id="cb38-1497"><a href="#cb38-1497"></a></span>
<span id="cb38-1498"><a href="#cb38-1498"></a>$$\hat{\gamma} = \hat{\delta}_g - \hat{\delta}_{g'}$$</span>
<span id="cb38-1499"><a href="#cb38-1499"></a></span>
<span id="cb38-1500"><a href="#cb38-1500"></a>where,</span>
<span id="cb38-1501"><a href="#cb38-1501"></a></span>
<span id="cb38-1502"><a href="#cb38-1502"></a>$$\hat{\gamma} = \overbrace{\big( \hat{E}<span class="co">[</span><span class="ot">Y(a)|G=g</span><span class="co">]</span> - \hat{E}<span class="co">[</span><span class="ot">Y(a^{\prime})|G=g</span><span class="co">]</span> \big)}^{\hat{\delta_g}} - \overbrace{\big(\hat{E}<span class="co">[</span><span class="ot">Y(a^{\prime})|G=g^{\prime}</span><span class="co">]</span>- \hat{E}<span class="co">[</span><span class="ot">Y(a)|G=g^{\prime}</span><span class="co">]</span>\big)}^{\hat{\delta_{g^{\prime}}}}$$</span>
<span id="cb38-1503"><a href="#cb38-1503"></a></span>
<span id="cb38-1504"><a href="#cb38-1504"></a>This difference $\hat{\gamma}$ represents the difference in the average causal effects between the subgroups $g$ and $g'$, taking into account the interaction effect of the exposure $A$ and the subgroup $G$ on the outcome $Y$.</span>
<span id="cb38-1505"><a href="#cb38-1505"></a></span>
<span id="cb38-1506"><a href="#cb38-1506"></a>Note that the interaction term $AG$ (or $ag$ and $a'g$ in the potential outcomes) stands for the interaction between the exposure level and the subgroup. This term is necessary to accommodate the non-additive effects in the model. As before, we must ensure that potential confounders $L$ are sufficient to control for confounding. </span>
<span id="cb38-1507"><a href="#cb38-1507"></a></span>
<span id="cb38-1508"><a href="#cb38-1508"></a><span class="fu">## Appendix C: Doubly Robust Estimation for Subgroup Analysis Estimator with Interaction</span></span>
<span id="cb38-1509"><a href="#cb38-1509"></a></span>
<span id="cb38-1510"><a href="#cb38-1510"></a>Again, Doubly Robust Estimation combines the strengths of both the IPTW and G-computation methods. It uses both the propensity score model and the outcome model, which makes it doubly robust: it produces unbiased estimates if either one of the models is correctly specified.</span>
<span id="cb38-1511"><a href="#cb38-1511"></a></span>
<span id="cb38-1512"><a href="#cb38-1512"></a>**Step 1** Estimate the propensity score. The propensity score $e(L, G)$ is the conditional probability of the exposure $A = 1$, given the covariates $L$ and subgroup indicator $G$. This can be modeled using logistic regression or other suitable methods, depending on the nature of the data and the exposure.</span>
<span id="cb38-1513"><a href="#cb38-1513"></a></span>
<span id="cb38-1514"><a href="#cb38-1514"></a>$$e = P(A = 1 | L, G) = f_A(L, G; \theta_A)$$</span>
<span id="cb38-1515"><a href="#cb38-1515"></a></span>
<span id="cb38-1516"><a href="#cb38-1516"></a>Here, $f_A(L, G; \theta_A)$ is a function (statistical model) that estimates the probability of the exposure $A = 1$ given covariates $L$ and subgroup $G$. Then, we calculate the weights for each individual, denoted as $v$, using the estimated propensity score:</span>
<span id="cb38-1517"><a href="#cb38-1517"></a></span>
<span id="cb38-1518"><a href="#cb38-1518"></a>$$</span>
<span id="cb38-1519"><a href="#cb38-1519"></a>v = </span>
<span id="cb38-1520"><a href="#cb38-1520"></a>\begin{cases} </span>
<span id="cb38-1521"><a href="#cb38-1521"></a>\frac{1}{\hat{e}} &amp; \text{if } A = 1 <span class="sc">\\</span></span>
<span id="cb38-1522"><a href="#cb38-1522"></a>\frac{1}{1-\hat{e}} &amp; \text{if } A = 0 </span>
<span id="cb38-1523"><a href="#cb38-1523"></a>\end{cases}</span>
<span id="cb38-1524"><a href="#cb38-1524"></a>$$</span>
<span id="cb38-1525"><a href="#cb38-1525"></a></span>
<span id="cb38-1526"><a href="#cb38-1526"></a>**Step 2** Fit a weighted outcome model. Using the weights calculated from the estimated propensity scores, fit a model for the outcome $Y$, conditional on the exposure $A$, covariates $L$, subgroup $G$ and the interaction between $A$ and $G$.</span>
<span id="cb38-1527"><a href="#cb38-1527"></a></span>
<span id="cb38-1528"><a href="#cb38-1528"></a>$$ \hat{E}(Y|A, L, G, AG; V) = f_Y(A, L, G, AG ; \theta_Y, V) $$</span>
<span id="cb38-1529"><a href="#cb38-1529"></a></span>
<span id="cb38-1530"><a href="#cb38-1530"></a>**Step 3** For each individual in each subgroup, simulate their potential outcome under the hypothetical scenario where everyone in the subgroup is exposed to the intervention $A=a$ regardless of their actual exposure level:</span>
<span id="cb38-1531"><a href="#cb38-1531"></a></span>
<span id="cb38-1532"><a href="#cb38-1532"></a>$$\hat{E}(Y(a)|G=g) = \hat{E}<span class="co">[</span><span class="ot">Y|A=a,G=g, AG=ag; L,\hat{\theta}_Y, v</span><span class="co">]</span>$$</span>
<span id="cb38-1533"><a href="#cb38-1533"></a></span>
<span id="cb38-1534"><a href="#cb38-1534"></a>And also under the hypothetical scenario where everyone in each subgroup is exposed to intervention $A=a'$:</span>
<span id="cb38-1535"><a href="#cb38-1535"></a></span>
<span id="cb38-1536"><a href="#cb38-1536"></a>$$\hat{E}(Y(a')|G=g) = \hat{E}<span class="co">[</span><span class="ot">Y|A=a',G=g, AG=a'g; L; \hat{\theta}_Y, v</span><span class="co">]</span>$$</span>
<span id="cb38-1537"><a href="#cb38-1537"></a></span>
<span id="cb38-1538"><a href="#cb38-1538"></a>**Step 4** Estimate the average causal effect for each subgroup. Compute the estimated expected value of the potential outcomes under each intervention level for each subgroup:</span>
<span id="cb38-1539"><a href="#cb38-1539"></a></span>
<span id="cb38-1540"><a href="#cb38-1540"></a>$$\hat{\delta}_g = \hat{E}<span class="co">[</span><span class="ot">Y(a)|G=g</span><span class="co">]</span> - \hat{E}<span class="co">[</span><span class="ot">Y(a')|G=g</span><span class="co">]</span>$$</span>
<span id="cb38-1541"><a href="#cb38-1541"></a></span>
<span id="cb38-1542"><a href="#cb38-1542"></a>The estimated difference $\hat{\delta}_g$ represents the average causal effect of changing the exposure from level $a'$ to level $a$ within each subgroup.</span>
<span id="cb38-1543"><a href="#cb38-1543"></a></span>
<span id="cb38-1544"><a href="#cb38-1544"></a>**Step 5** Compare differences in causal effects by groups. Compute the differences in the estimated causal effects between different subgroups:</span>
<span id="cb38-1545"><a href="#cb38-1545"></a></span>
<span id="cb38-1546"><a href="#cb38-1546"></a>$$\hat{\gamma} = \hat{\delta}_g - \hat{\delta}_{g'}$$</span>
<span id="cb38-1547"><a href="#cb38-1547"></a></span>
<span id="cb38-1548"><a href="#cb38-1548"></a>where,</span>
<span id="cb38-1549"><a href="#cb38-1549"></a></span>
<span id="cb38-1550"><a href="#cb38-1550"></a>$$\hat{\gamma} = \overbrace{\big( \hat{E}<span class="co">[</span><span class="ot">Y(a)|G=g</span><span class="co">]</span> - \hat{E}<span class="co">[</span><span class="ot">Y(a')|G=g</span><span class="co">]</span> \big)}^{\hat{\delta_g}} - \overbrace{\big(\hat{E}<span class="co">[</span><span class="ot">Y(a')|G=g'</span><span class="co">]</span>- \hat{E}<span class="co">[</span><span class="ot">Y(a)|G=g'</span><span class="co">]</span>\big)}^{\hat{\delta_{g'}}}$$</span>
<span id="cb38-1551"><a href="#cb38-1551"></a></span>
<span id="cb38-1552"><a href="#cb38-1552"></a>We again use simulation-based inference methods to compute standard errors and confidence intervals <span class="co">[</span><span class="ot">@greifer2023</span><span class="co">]</span>.</span>
<span id="cb38-1553"><a href="#cb38-1553"></a></span>
<span id="cb38-1554"><a href="#cb38-1554"></a></span>
<span id="cb38-1555"><a href="#cb38-1555"></a></span>
<span id="cb38-1556"><a href="#cb38-1556"></a><span class="fu">## Appendix D: Marginal Structural Models for Estimating Population Average Treatment Effect with Interaction (Doubly Robust)</span></span>
<span id="cb38-1557"><a href="#cb38-1557"></a></span>
<span id="cb38-1558"><a href="#cb38-1558"></a></span>
<span id="cb38-1559"><a href="#cb38-1559"></a>Sometimes we will only wish to estimate a marginal effect. In that case.</span>
<span id="cb38-1560"><a href="#cb38-1560"></a></span>
<span id="cb38-1561"><a href="#cb38-1561"></a>**Step 1** Estimate the propensity score. The propensity score $e(L)$ is the conditional probability of the exposure $A = 1$, given the covariates $L$ which contains the subgroup $G$. This can be modelled using logistic regression or other functions as described in @greifer2023</span>
<span id="cb38-1562"><a href="#cb38-1562"></a></span>
<span id="cb38-1563"><a href="#cb38-1563"></a>$$\hat{e} = P(A = 1 | L) = f_A(L; \theta_A)$$</span>
<span id="cb38-1564"><a href="#cb38-1564"></a></span>
<span id="cb38-1565"><a href="#cb38-1565"></a>Here, $f_A(L; \theta_A)$ is a function (a statistical model) that estimates the probability of the exposure $A = 1$ given covariates $L$. Then, we calculate the weights for each individual, denoted as $v$, using the estimated propensity score:</span>
<span id="cb38-1566"><a href="#cb38-1566"></a></span>
<span id="cb38-1567"><a href="#cb38-1567"></a>$$</span>
<span id="cb38-1568"><a href="#cb38-1568"></a>v = </span>
<span id="cb38-1569"><a href="#cb38-1569"></a>\begin{cases} </span>
<span id="cb38-1570"><a href="#cb38-1570"></a>\frac{1}{e} &amp; \text{if } A = 1 <span class="sc">\\</span></span>
<span id="cb38-1571"><a href="#cb38-1571"></a>\frac{1}{1-e} &amp; \text{if } A = 0 </span>
<span id="cb38-1572"><a href="#cb38-1572"></a>\end{cases}</span>
<span id="cb38-1573"><a href="#cb38-1573"></a>$$</span>
<span id="cb38-1574"><a href="#cb38-1574"></a></span>
<span id="cb38-1575"><a href="#cb38-1575"></a>**Step 2** Fit a weighted outcome model. Using the weights calculated from the estimated propensity scores, fit a model for the outcome $Y$, conditional on the exposure $A$ and covariates $L$.</span>
<span id="cb38-1576"><a href="#cb38-1576"></a></span>
<span id="cb38-1577"><a href="#cb38-1577"></a>$$ \hat{E}(Y|A, L; V) = f_Y(A, L; \theta_Y, V) $$</span>
<span id="cb38-1578"><a href="#cb38-1578"></a></span>
<span id="cb38-1579"><a href="#cb38-1579"></a>This model should include terms for both the main effects of $A$ and $L$ and their interaction $AL$.</span>
<span id="cb38-1580"><a href="#cb38-1580"></a></span>
<span id="cb38-1581"><a href="#cb38-1581"></a>**Step 3** For the entire population, simulate the potential outcome under the hypothetical scenario where everyone is exposed to the intervention $A=a$ regardless of their actual exposure level:</span>
<span id="cb38-1582"><a href="#cb38-1582"></a></span>
<span id="cb38-1583"><a href="#cb38-1583"></a>$$\hat{E}(Y(a)) = \hat{E}<span class="co">[</span><span class="ot">Y|A=a; L,\hat{\theta}_Y, v</span><span class="co">]</span>$$</span>
<span id="cb38-1584"><a href="#cb38-1584"></a></span>
<span id="cb38-1585"><a href="#cb38-1585"></a>And also under the hypothetical scenario where everyone is exposed to intervention $A=a'$:</span>
<span id="cb38-1586"><a href="#cb38-1586"></a></span>
<span id="cb38-1587"><a href="#cb38-1587"></a>$$\hat{E}(Y(a')) = \hat{E}<span class="co">[</span><span class="ot">Y|A=a'; L; \hat{\theta}_Y, v</span><span class="co">]</span>$$</span>
<span id="cb38-1588"><a href="#cb38-1588"></a></span>
<span id="cb38-1589"><a href="#cb38-1589"></a>**Step 4** Estimate the average causal effect for the entire population. Compute the estimated expected value of the potential outcomes under each intervention level for the entire population:</span>
<span id="cb38-1590"><a href="#cb38-1590"></a></span>
<span id="cb38-1591"><a href="#cb38-1591"></a>$$\hat{\delta} = \hat{E}<span class="co">[</span><span class="ot">Y(a)</span><span class="co">]</span> - \hat{E}<span class="co">[</span><span class="ot">Y(a')</span><span class="co">]</span>$$</span>
<span id="cb38-1592"><a href="#cb38-1592"></a></span>
<span id="cb38-1593"><a href="#cb38-1593"></a>The estimated difference $\hat{\delta}$ represents the average causal effect of changing the exposure from level $a'$ to level $a$ in the entire population.</span>
<span id="cb38-1594"><a href="#cb38-1594"></a></span>
<span id="cb38-1595"><a href="#cb38-1595"></a>We again use simulation-based inference methods to compute standard errors and confidence intervals <span class="co">[</span><span class="ot">@greifer2023</span><span class="co">]</span>.</span>
<span id="cb38-1596"><a href="#cb38-1596"></a></span>
<span id="cb38-1597"><a href="#cb38-1597"></a></span>
<span id="cb38-1598"><a href="#cb38-1598"></a><span class="fu">### Machine Learning</span></span>
<span id="cb38-1599"><a href="#cb38-1599"></a></span>
<span id="cb38-1600"><a href="#cb38-1600"></a>Example from https://osf.io/cnphs</span>
<span id="cb38-1601"><a href="#cb38-1601"></a></span>
<span id="cb38-1602"><a href="#cb38-1602"></a></span>
<span id="cb38-1603"><a href="#cb38-1603"></a><span class="at">&gt; We perform statistical estimation using semi-parametric Targeted</span></span>
<span id="cb38-1604"><a href="#cb38-1604"></a><span class="at">Learning, specifically a Targeted Minimum Loss-based Estimation (TMLE)</span></span>
<span id="cb38-1605"><a href="#cb38-1605"></a><span class="at">estimator. TMLE is a robust method that combines machine learning</span></span>
<span id="cb38-1606"><a href="#cb38-1606"></a><span class="at">techniques with traditional statistical models to estimate causal</span></span>
<span id="cb38-1607"><a href="#cb38-1607"></a><span class="at">effects while providing valid statistical uncertainty measures for these</span></span>
<span id="cb38-1608"><a href="#cb38-1608"></a><span class="at">estimates </span><span class="co">[</span><span class="ot">@van2012targeted; @van2014targeted</span><span class="co">]</span><span class="at">.</span></span>
<span id="cb38-1609"><a href="#cb38-1609"></a></span>
<span id="cb38-1610"><a href="#cb38-1610"></a><span class="at">&gt; TMLE operates through a two-step process that involves modelling both</span></span>
<span id="cb38-1611"><a href="#cb38-1611"></a><span class="at">the outcome and treatment (exposure). Initially, TMLE employs machine</span></span>
<span id="cb38-1612"><a href="#cb38-1612"></a><span class="at">learning algorithms to flexibly model the relationship between</span></span>
<span id="cb38-1613"><a href="#cb38-1613"></a><span class="at">treatments, covariates, and outcomes. This flexibility allows TMLE to</span></span>
<span id="cb38-1614"><a href="#cb38-1614"></a><span class="at">account for complex, high-dimensional covariate spaces</span></span>
<span id="cb38-1615"><a href="#cb38-1615"></a><span class="at">\emph{efficiently} without imposing restrictive model assumptions;</span></span>
<span id="cb38-1616"><a href="#cb38-1616"></a><span class="co">[</span><span class="ot">@vanderlaan2011; @vanderlaan2018</span><span class="co">]</span><span class="at">. The outcome of this step is a set</span></span>
<span id="cb38-1617"><a href="#cb38-1617"></a><span class="at">of initial estimates for these relationships.</span></span>
<span id="cb38-1618"><a href="#cb38-1618"></a></span>
<span id="cb38-1619"><a href="#cb38-1619"></a><span class="at">&gt; The second step of TMLE involves ``targeting'' these initial estimates</span></span>
<span id="cb38-1620"><a href="#cb38-1620"></a><span class="at">by incorporating information about the observed data distribution to</span></span>
<span id="cb38-1621"><a href="#cb38-1621"></a><span class="at">improve the accuracy of the causal effect estimate. TMLE achieves this</span></span>
<span id="cb38-1622"><a href="#cb38-1622"></a><span class="at">precision through an iterative updating process, which adjusts the</span></span>
<span id="cb38-1623"><a href="#cb38-1623"></a><span class="at">initial estimates towards the true causal effect. This updating process</span></span>
<span id="cb38-1624"><a href="#cb38-1624"></a><span class="at">is guided by the efficient influence function, ensuring that the final</span></span>
<span id="cb38-1625"><a href="#cb38-1625"></a><span class="at">TMLE estimate is as close as possible, given the measures and data, to</span></span>
<span id="cb38-1626"><a href="#cb38-1626"></a><span class="at">the targeted causal effect while still being robust to</span></span>
<span id="cb38-1627"><a href="#cb38-1627"></a><span class="at">model-misspecification in either the outcome or the treatment model</span></span>
<span id="cb38-1628"><a href="#cb38-1628"></a><span class="co">[</span><span class="ot">@van2014discussion</span><span class="co">]</span><span class="at">.</span></span>
<span id="cb38-1629"><a href="#cb38-1629"></a></span>
<span id="cb38-1630"><a href="#cb38-1630"></a><span class="at">&gt; Again, a central feature of TMLE is its double-robustness property. If</span></span>
<span id="cb38-1631"><a href="#cb38-1631"></a><span class="at">either the treatment model or the outcome model is correctly specified,</span></span>
<span id="cb38-1632"><a href="#cb38-1632"></a><span class="at">the TMLE estimator will consistently estimate the causal effect.</span></span>
<span id="cb38-1633"><a href="#cb38-1633"></a><span class="at">Additionally, we used cross-validation to avoid over-fitting, following</span></span>
<span id="cb38-1634"><a href="#cb38-1634"></a><span class="at">the pre-stated protocols in Bulbulia </span><span class="co">[</span><span class="ot">@bulbulia2024PRACTICAL</span><span class="co">]</span><span class="at">. The integration of TMLE</span></span>
<span id="cb38-1635"><a href="#cb38-1635"></a><span class="at">and machine learning technologies reduces the dependence on restrictive</span></span>
<span id="cb38-1636"><a href="#cb38-1636"></a><span class="at">modelling assumptions and introduces an additional layer of robustness.</span></span>
<span id="cb38-1637"><a href="#cb38-1637"></a><span class="at">For further details of the specific targeted learning strategy we</span></span>
<span id="cb38-1638"><a href="#cb38-1638"></a><span class="at">favour, see </span><span class="co">[</span><span class="ot">@duxedaz2021; @hoffman2022, @hoffman2023</span><span class="co">]</span><span class="at">. We perform estimation using the</span></span>
<span id="cb38-1639"><a href="#cb38-1639"></a><span class="at">\texttt{lmtp} package </span><span class="co">[</span><span class="ot">@williams2021</span><span class="co">]</span><span class="at">. We used the \texttt{superlearner} library for semi-parametric estimation with the predefined libraries \texttt{SL.ranger},</span></span>
<span id="cb38-1640"><a href="#cb38-1640"></a><span class="at">\texttt{SL.glmnet}, and \texttt{SL.xgboost} </span><span class="co">[</span><span class="ot">@xgboost2023; @polley2023; @Ranger2017</span><span class="co">]</span><span class="at">. We created graphs, tables and output reports using the \texttt{margot} package</span></span>
<span id="cb38-1641"><a href="#cb38-1641"></a><span class="co">[</span><span class="ot">@margot2024</span><span class="co">]</span><span class="at">.</span></span>
<span id="cb38-1642"><a href="#cb38-1642"></a></span>
<span id="cb38-1643"><a href="#cb38-1643"></a><span class="fu">#### Sensitivity Analysis Using the E-value</span></span>
<span id="cb38-1644"><a href="#cb38-1644"></a></span>
<span id="cb38-1645"><a href="#cb38-1645"></a><span class="at">&gt; To assess the sensitivity of results to unmeasured confounding, we</span></span>
<span id="cb38-1646"><a href="#cb38-1646"></a><span class="at">report VanderWeele and Ding's ``E-value'' in all analyses</span></span>
<span id="cb38-1647"><a href="#cb38-1647"></a><span class="co">[</span><span class="ot">@vanderweele2017</span><span class="co">]</span><span class="at">. The E-value quantifies the minimum strength of association (on the risk ratio scale) that an unmeasured confounder would need to have with both the exposure</span></span>
<span id="cb38-1648"><a href="#cb38-1648"></a><span class="at">and the outcome (after considering the measured covariates) to explain</span></span>
<span id="cb38-1649"><a href="#cb38-1649"></a><span class="at">away the observed exposure-outcome association</span></span>
<span id="cb38-1650"><a href="#cb38-1650"></a><span class="co">[</span><span class="ot">@linden2020EVALUE; @vanderweele2020</span><span class="co">]</span><span class="at">. To</span></span>
<span id="cb38-1651"><a href="#cb38-1651"></a><span class="at">evaluate the strength of evidence, we use the bound of the E-value 95\%</span></span>
<span id="cb38-1652"><a href="#cb38-1652"></a><span class="at">confidence interval closest to 1.</span></span>
<span id="cb38-1653"><a href="#cb38-1653"></a></span>
<span id="cb38-1654"><a href="#cb38-1654"></a></span>
<span id="cb38-1655"><a href="#cb38-1655"></a></span>
<span id="cb38-1656"><a href="#cb38-1656"></a></span>
<span id="cb38-1657"><a href="#cb38-1657"></a><span class="fu">### Packages</span></span>
<span id="cb38-1658"><a href="#cb38-1658"></a></span>
<span id="cb38-1661"><a href="#cb38-1661"></a><span class="in">```{r}</span></span>
<span id="cb38-1662"><a href="#cb38-1662"></a>report<span class="sc">::</span><span class="fu">cite_packages</span>()</span>
<span id="cb38-1663"><a href="#cb38-1663"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>