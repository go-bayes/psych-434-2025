<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.20">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Joseph Bulbulia">
<meta name="dcterms.date" content="2025-04-29">

<title>Estimation of ATE and CATE Using Machine Learning – PSYC 434 Conducting Research Across Cultures: Trimester 1, 2025</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-6b83053bd867e91890e3c09412db0bb7.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-b150b11e25d71d79f94868488eae0a4a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css">

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">PSYC 434 Conducting Research Across Cultures: Trimester 1, 2025</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../content/course-outline.html"> 
<span class="menu-text">Course Outline</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-content" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Content</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-content">    
        <li>
    <a class="dropdown-item" href="../content/glossary.pdf">
 <span class="dropdown-text">Glossary</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/course-outline.html">
 <span class="dropdown-text">Course Outline</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/01-content.html">
 <span class="dropdown-text">Week 1: Course Introduction - R (installing packages)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/02-content.html">
 <span class="dropdown-text">Week 2: Causal Diagrams - Elementary Structures and Rules - R (using the interface)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/03-content.html">
 <span class="dropdown-text">Week 3: Causal Diagrams - Confounding Bias - R (regression/simulation)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/04-content.html">
 <span class="dropdown-text">Week 4: Causal Diagrams - Interaction, Measurement Bias, Selection Bias - R (regression/simulation)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/05-content.html">
 <span class="dropdown-text">Week 5: Causal Inference - Average Treatment Effects - R (regression/simulation: ATE)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/06-content.html">
 <span class="dropdown-text">Week 6: Conditional Average Treatment Effects (CATE) - R (regression/simulation: ATE)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/07-quiz.html">
 <span class="dropdown-text">Week 7: In Class Test</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/08-content.html">
 <span class="dropdown-text">Week 8: Estimation of ATE and CATE using machine learning - R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/09-content.html">
 <span class="dropdown-text">Week 9: Theoretically postulated Subgroups analysis- R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/10-content.html">
 <span class="dropdown-text">Week 10: Hands On: Writing Up Your Analysis: Quarto Documents</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/11-content.html">
 <span class="dropdown-text">Week 11: Measurement: Factor Analysis, CFA, MultiGroup CFA, Partial Invariance/ And How These Approaches Fail</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/12-content.html">
 <span class="dropdown-text">Week 12: Student Presentations</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Estimation of ATE and CATE Using Machine Learning</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
                      </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-heading">Affiliation</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author">Joseph Bulbulia <a href="mailto:joseph.bulbulia@vuw.ac.nz" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0000-0002-5861-2056" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              Victoria University of Wellington, New Zealand
            </p>
        </div>
    </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">April 29, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#part-1-heterogeneous-treatment-effect-analysis-with-causal-forests" id="toc-part-1-heterogeneous-treatment-effect-analysis-with-causal-forests" class="nav-link active" data-scroll-target="#part-1-heterogeneous-treatment-effect-analysis-with-causal-forests">PART 1 Heterogeneous-Treatment-Effect Analysis with <strong>causal forests</strong></a>
  <ul class="collapse">
  <li><a href="#why-worry-about-heterogeneity" id="toc-why-worry-about-heterogeneity" class="nav-link" data-scroll-target="#why-worry-about-heterogeneity">Why worry about heterogeneity?</a></li>
  <li><a href="#start-with-estimating-the-average-treatment-effect-ate" id="toc-start-with-estimating-the-average-treatment-effect-ate" class="nav-link" data-scroll-target="#start-with-estimating-the-average-treatment-effect-ate">1 Start with estimating the average treatment effect (ATE)</a></li>
  <li><a href="#do-effects-differ-across-people" id="toc-do-effects-differ-across-people" class="nav-link" data-scroll-target="#do-effects-differ-across-people">2 Do effects differ across people?</a></li>
  <li><a href="#from-straight-lines-to-trees" id="toc-from-straight-lines-to-trees" class="nav-link" data-scroll-target="#from-straight-lines-to-trees">3. From straight lines to trees</a></li>
  <li><a href="#building-honest-trees-avoiding-over-fitting" id="toc-building-honest-trees-avoiding-over-fitting" class="nav-link" data-scroll-target="#building-honest-trees-avoiding-over-fitting">4 Building Honest Trees: Avoiding Over-Fitting</a></li>
  <li><a href="#handling-missing-data" id="toc-handling-missing-data" class="nav-link" data-scroll-target="#handling-missing-data">5 Handling missing data</a></li>
  <li><a href="#is-the-heterogeneity-actionable-rate-statistics" id="toc-is-the-heterogeneity-actionable-rate-statistics" class="nav-link" data-scroll-target="#is-the-heterogeneity-actionable-rate-statistics">6 Is the heterogeneity <em>actionable</em>? — RATE statistics</a></li>
  <li><a href="#rate-autoc-example" id="toc-rate-autoc-example" class="nav-link" data-scroll-target="#rate-autoc-example">7 RATE AUTOC EXAMPLE</a></li>
  <li><a href="#visualising-policy-value-the-qini-curve" id="toc-visualising-policy-value-the-qini-curve" class="nav-link" data-scroll-target="#visualising-policy-value-the-qini-curve">8 Visualising policy value: the Qini curve</a></li>
  <li><a href="#from-a-black-box-to-simple-rules-policy-trees" id="toc-from-a-black-box-to-simple-rules-policy-trees" class="nav-link" data-scroll-target="#from-a-black-box-to-simple-rules-policy-trees">9 From ‘a black box’ to simple rules: policy trees</a></li>
  <li><a href="#ethical-and-practical-considerations" id="toc-ethical-and-practical-considerations" class="nav-link" data-scroll-target="#ethical-and-practical-considerations">10 Ethical and practical considerations</a></li>
  <li><a href="#summarynext-steps" id="toc-summarynext-steps" class="nav-link" data-scroll-target="#summarynext-steps">Summary/next steps</a></li>
  </ul></li>
  <li><a href="#part-1-laboratory-data-preparation-and-analysis-scripts" id="toc-part-1-laboratory-data-preparation-and-analysis-scripts" class="nav-link" data-scroll-target="#part-1-laboratory-data-preparation-and-analysis-scripts">PART 1 Laboratory: Data Preparation and Analysis Scripts</a>
  <ul class="collapse">
  <li><a href="#link-to-data-dictionary" id="toc-link-to-data-dictionary" class="nav-link" data-scroll-target="#link-to-data-dictionary">Link to data dictionary</a></li>
  <li><a href="#script-0-synthetic-data-fetch" id="toc-script-0-synthetic-data-fetch" class="nav-link" data-scroll-target="#script-0-synthetic-data-fetch">Script 0: Synthetic Data Fetch</a></li>
  <li><a href="#script-1-initial-data-wrangling" id="toc-script-1-initial-data-wrangling" class="nav-link" data-scroll-target="#script-1-initial-data-wrangling">Script 1: Initial Data Wrangling</a></li>
  <li><a href="#script-2-make-wide-data-format-with-censoring-weights" id="toc-script-2-make-wide-data-format-with-censoring-weights" class="nav-link" data-scroll-target="#script-2-make-wide-data-format-with-censoring-weights">Script 2: Make Wide Data Format With Censoring Weights</a></li>
  <li><a href="#script-3-models-graphs" id="toc-script-3-models-graphs" class="nav-link" data-scroll-target="#script-3-models-graphs">Script 3: Models &amp; Graphs</a></li>
  <li><a href="#homework-prepare-a-fresh-set-of-analysis-scripts-using-a-different-exposure" id="toc-homework-prepare-a-fresh-set-of-analysis-scripts-using-a-different-exposure" class="nav-link" data-scroll-target="#homework-prepare-a-fresh-set-of-analysis-scripts-using-a-different-exposure">HOMEWORK: Prepare a fresh set of analysis scripts using a different exposure</a>
  <ul class="collapse">
  <li><a href="#packages" id="toc-packages" class="nav-link" data-scroll-target="#packages">Packages</a></li>
  </ul></li>
  <li><a href="#appendix" id="toc-appendix" class="nav-link" data-scroll-target="#appendix">Appendix</a></li>
  <li><a href="#review-the-fundamental-problem-of-causal-inference-as-a-missing-data-problem" id="toc-review-the-fundamental-problem-of-causal-inference-as-a-missing-data-problem" class="nav-link" data-scroll-target="#review-the-fundamental-problem-of-causal-inference-as-a-missing-data-problem">Review: The Fundamental Problem of Causal Inference as a Missing Data Problem</a></li>
  <li><a href="#subgroup-analysis" id="toc-subgroup-analysis" class="nav-link" data-scroll-target="#subgroup-analysis">Subgroup analysis</a>
  <ul class="collapse">
  <li><a href="#causal-estimand-statistical-estimand-statistical-estimator" id="toc-causal-estimand-statistical-estimand-statistical-estimator" class="nav-link" data-scroll-target="#causal-estimand-statistical-estimand-statistical-estimator">Causal Estimand, Statistical Estimand, Statistical Estimator</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Required</strong> - <a href="https://grf-labs.github.io/grf/">https://grf-labs.github.io/grf/</a></p>
<p><strong>Optional</strong> - <span class="citation" data-cites="vanderweele2020">(<a href="#ref-vanderweele2020" role="doc-biblioref">VanderWeele, Mathur, and Chen 2020</a>)</span> <a href="https://www.dropbox.com/scl/fi/srpynr0dvjcndveplcydn/OutcomeWide_StatisticalScience.pdf?rlkey=h4fv32oyjegdfl3jq9u1fifc3&amp;dl=0">link</a> - <span class="citation" data-cites="suzuki2020">(<a href="#ref-suzuki2020" role="doc-biblioref">Suzuki, Shinozaki, and Yamamoto 2020</a>)</span> <a href="https://www.dropbox.com/scl/fi/4midxwr9ltg9oce02e0ss/suzuki-causal-diagrams.pdf?rlkey=uktzf3nurtgpbj8m4h0xz82dn&amp;dl=0">link</a> - <span class="citation" data-cites="Bulbulia2024PracticalGuide">(<a href="#ref-Bulbulia2024PracticalGuide" role="doc-biblioref">Bulbulia 2024</a>)</span> <a href="https://osf.io/preprints/psyarxiv/uyg3d">link</a> - <span class="citation" data-cites="hoffman2023">(<a href="#ref-hoffman2023" role="doc-biblioref">Hoffman et al. 2023</a>)</span> <a href="https://arxiv.org/pdf/2304.09460.pdf">link</a></p>
</div>
</div>
<div class="no-row-height column-margin column-container"><div id="ref-hoffman2023" class="csl-entry" role="listitem">
Hoffman, Katherine L., Diego Salazar-Barreto, Kara E. Rudolph, and Iván Díaz. 2023. <span>“Introducing Longitudinal Modified Treatment Policies: A Unified Framework for Studying Complex Exposures,”</span> April. <a href="https://doi.org/10.48550/arXiv.2304.09460">https://doi.org/10.48550/arXiv.2304.09460</a>.
</div></div><div class="no-row-height column-margin column-container"><div id="ref-Bulbulia2024PracticalGuide" class="csl-entry" role="listitem">
Bulbulia, J. A. 2024. <span>“A Practical Guide to Causal Inference in Three-Wave Panel Studies.”</span> OSF. <a href="https://doi.org/10.31234/osf.io/uyg3d">https://doi.org/10.31234/osf.io/uyg3d</a>.
</div></div><div class="no-row-height column-margin column-container"><div id="ref-suzuki2020" class="csl-entry" role="listitem">
Suzuki, Etsuji, Tomohiro Shinozaki, and Eiji Yamamoto. 2020. <span>“Causal Diagrams: Pitfalls and Tips.”</span> <em>Journal of Epidemiology</em> 30 (4): 153–62. <a href="https://doi.org/10.2188/jea.JE20190192">https://doi.org/10.2188/jea.JE20190192</a>.
</div></div><div class="no-row-height column-margin column-container"><div id="ref-vanderweele2020" class="csl-entry" role="listitem">
VanderWeele, Tyler J, Maya B Mathur, and Ying Chen. 2020. <span>“Outcome-Wide Longitudinal Designs for Causal Inference: A New Template for Empirical Studies.”</span> <em>Statistical Science</em> 35 (3): 437–66.
</div></div><div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Key concepts
</div>
</div>
<div class="callout-body-container callout-body">
<p>The workflow below introduces <strong>heterogeneous-treatment-effect (HTE) analysis</strong> with <em>causal forests</em>. By the end of the lecture you should understand six technical ideas: (1) ATE (lectures 1-5) (2) CATE (lecture 6) (3) The estimator <span class="math inline">\widehat{\tau}(x)</span>, (lecture 6) (4) the RATE statistics drawn from a <strong>Targeting-Operator Characteristic</strong> (TOC) curve (new) (5) Qini Curves (new) (6) <strong>policy trees</strong>—and know how each fits into an applied research pipelin (new)</p>
</div>
</div>
<section id="part-1-heterogeneous-treatment-effect-analysis-with-causal-forests" class="level1 page-columns page-full">
<h1>PART 1 Heterogeneous-Treatment-Effect Analysis with <strong>causal forests</strong></h1>
<section id="why-worry-about-heterogeneity" class="level3">
<h3 class="anchored" data-anchor-id="why-worry-about-heterogeneity">Why worry about heterogeneity?</h3>
<p>Relying on the average treatment effect (ATE) is a bit like handing out size-nine shoes to an entire student body: on <em>average</em> they might fit, but watch the tall students hobble and the small ones trip.</p>
<p>Today we will focus on the causal question: “What would be the effects on multi-dimensional well-being if everyone spent at least one hour a week socialising with their community?”</p>
<p>Note that a one-hour boost in weekly community socialising could send some students’ sense of belonging soaring while leaving others desolated. Spotting that spread, measuring how big it really is, and deciding whether it is worth tailoring an exposure to individual ‘shoe sizes’ are the three practical goals of Heterogeneous Treatment Effects analysis.</p>
<hr>
</section>
<section id="start-with-estimating-the-average-treatment-effect-ate" class="level3">
<h3 class="anchored" data-anchor-id="start-with-estimating-the-average-treatment-effect-ate">1 Start with estimating the average treatment effect (ATE)</h3>
<p>Assume the <a href="https://go-bayes.github.io/psych-434-2025/content/05-content.html#how-can-we-make-contrasts-between-counterfactual-potential-outcomes">Three Fundamental Assumptions of Causal Inference here</a> are met. Suppose we wish to estimate the average treatment effect for socialising with one’s community.</p>
<p>We begin with the most straightforward (and secretly impossible) counterfactual: *run two parallel universes—one where <strong>everyone</strong> gets the treatment, another where <strong>no-one</strong> does—and compare the final scores. The resulting difference is the <strong>average treatment effect</strong>:</p>
<p><span class="math display">
\text{ATE}=E\!\bigl[Y(1)-Y(0)\bigr].
</span></p>
<p>This gives us the average response – the shoe size… You’ve seen this before.</p>
<hr>
</section>
<section id="do-effects-differ-across-people" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="do-effects-differ-across-people">2 Do effects differ across people?</h3>
<p>Variation is captured by the <strong>conditional average treatment effect (CATE)</strong>,</p>
<p><span class="math display">
\tau(x)=E\!\bigl[Y(1)-Y(0)\mid X=x\bigr],
</span></p>
<p>where <span class="math inline">X</span> gathers pre-treatment covariates – age, baseline wellbeing, personality, whatever we have measured and included in our model. Normally these will be our <em>baseline confounders.</em></p>
<p>If <span class="math inline">\tau(x)</span> turns out to be flat, we say there is no evidence for heterogeneity worth targeting.</p>
<p>People differ in countless, overlapping ways. Think of age, baseline wellbeing, personality traits, study habits, and more.</p>
<p>A linear interaction model tests whether the treatment works differently along one straight dimension, such as gender, by fitting a straight line.</p>
<p>But real‐world data often twist and turn. If the true relationship bends like a garden hose, a straight line will miss the curve.</p>
<p>Regression forests fix this by letting the data place splits wherever the shape changes, so they can follow any bends that appear <span class="citation" data-cites="wager2018">(<a href="#ref-wager2018" role="doc-biblioref">Wager and Athey 2018</a>)</span>.</p>
<div class="no-row-height column-margin column-container"></div><p>Straight-line models are fine for simple patterns, but regression forests can trace the curves that simple lines overlook.</p>
<p>Causal forests are based on regression forests, where the splitting attempts to maximise differences in causal effect estimates. What this means will soon be clear.</p>
</section>
<section id="from-straight-lines-to-trees" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="from-straight-lines-to-trees">3. From straight lines to trees</h3>
<p>Traditional ‘parametric’ models (like simple regression) guess a single functional shape – often a straight line – before seeing the data. A <strong>non-parametric</strong> model, by contrast, lets the data decide the shape. A <em>regression tree</em> is the simplest non-parametric learner we will use.</p>
<ol type="1">
<li><strong>Regression tree</strong></li>
</ol>
<p><em>Idea</em>: split the covariate space by asking yes/no questions— ‘Age ≤ 20?’, ‘Baseline wellbeing &gt; 0.3?’ — until each terminal <strong>leaf</strong> is fairly homogeneous. Inside a leaf the predicted outcome is just the sample mean, so the tree builds a <em>piece-wise constant</em> surface instead of a global line.<br>
<em>Analogy</em>: think of tiling a garden with stepping-stones: each stone is flat, but taken together they follow the ground’s contours.</p>
<ol start="2" type="1">
<li><p><strong>Regression forest</strong><br>
A single tree is quick and interpretable but unstable: small changes in the data can move the splits and shift predictions. A <strong>random forest</strong> grows many trees on bootstrap samples and averages their outputs. Averaging cancels much of the noise <span class="citation" data-cites="breiman2001random">(<a href="#ref-breiman2001random" role="doc-biblioref">Breiman 2001</a>)</span>.</p></li>
<li><p><strong>Causal Forests</strong><br>
To estimate treatment effects rather than outcomes, each tree plays a two-step ‘honest’ game <span class="citation" data-cites="wager2018">(<a href="#ref-wager2018" role="doc-biblioref">Wager and Athey 2018</a>)</span>:</p>
<ul>
<li>use one half of its sample to choose splits that separate treated from control units;<br>
</li>
<li>use the other half to compute treatment-control differences within every leaf.</li>
</ul>
<p>For a new individual with covariates <span class="math inline">x_i</span> each tree supplies a noisy leaf-level effect; the forest reports the <strong>average</strong>, written</p></li>
</ol>
<div class="no-row-height column-margin column-container"><div id="ref-breiman2001random" class="csl-entry" role="listitem">
Breiman, Leo. 2001. <span>“Random Forests.”</span> <em>Machine Learning</em> 45 (1): 5–32. <a href="https://doi.org/10.1023/A:1010933404324">https://doi.org/10.1023/A:1010933404324</a>.
</div><div id="ref-wager2018" class="csl-entry" role="listitem">
Wager, Stefan, and Susan Athey. 2018. <span>“Estimation and Inference of Heterogeneous Treatment Effects Using Random Forests.”</span> <em>Journal of the American Statistical Association</em> 113 (523): 1228–42. <a href="https://doi.org/10.1080/01621459.2017.1319839">https://doi.org/10.1080/01621459.2017.1319839</a>.
</div></div><p><span class="math display">
  \widehat{\tau}(x)=E[Y(1)-Y(0)\mid X=x].
</span></p>
<p>Because the noisy estimates point in many directions, their average is markedly less variable – <em>the wisdom of trees is a wisdom of crowds</em>.</p>
<p>Straight‑line models suit simple patterns; regression forests flex to any bends; causal forests add a third dimension – variation in treatment responses. We’ll see this in action/</p>
<p>For more about causal forests see (~18mins in…)</p>
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/YBbnCDRCcAI" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
<!-- So, a regression tree chops the data into locally flat chunks; a regression forest averages many such trees to smooth away chance idiosyncrasies; a causal forest adds honesty so that its averaged differences, though never directly observable for any one person, give our best data-driven forecast of individual treatment effects. -->
<hr>
</section>
<section id="building-honest-trees-avoiding-over-fitting" class="level3">
<h3 class="anchored" data-anchor-id="building-honest-trees-avoiding-over-fitting">4 Building Honest Trees: Avoiding Over-Fitting</h3>
<p>Sample splitting meanings partitioning your data into training and testing sets. This avoids overfittign the model to observations (remember we seek to estimate parameters for an entire population under two different exposures, at most, only one of which is observed on any individual.) Sample splitting is a feature of estimation in cauasal forests – we separate model selection from estimation. Moreover, the forest adds a second safeguard: <strong>out-of-bag (OOB) prediction</strong>. Each <span class="math inline">\widehat{\tau}(x_i)</span> is averaged only over trees that never used <span class="math inline">i</span> in their split phase. Together, honesty and OOB prediction deliver reliable uncertainty estimates even in high-dimensional settings (i.e.&nbsp;settings with <em>many</em> covariates.)</p>
<hr>
</section>
<section id="handling-missing-data" class="level3">
<h3 class="anchored" data-anchor-id="handling-missing-data">5 Handling missing data</h3>
<p>The <code>grf</code> package adopts <strong>Missing Incorporated in Attributes (MIA)</strong> splitting. ‘Missing’ can itself become a branch, so cases are neither discarded nor randomly imputed. This pragmatic approach keeps all observations in play while preserving the forest’s interpretability.</p>
<hr>
</section>
<section id="is-the-heterogeneity-actionable-rate-statistics" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="is-the-heterogeneity-actionable-rate-statistics">6 Is the heterogeneity <em>actionable</em>? — RATE statistics</h3>
<p>Once we have a personalised score <span class="math inline">\widehat{\tau}(x)</span> for every unit, the practical question is whether <em>targeting</em> high scorers delivers a benefit large enough to justify the extra effort. The tool of choice is the <strong>Targeting-Operator Characteristic (TOC)</strong> curve:</p>
<p><span class="math display">
G(q)=\frac{1}{n}\sum_{i=1}^{\lfloor qn\rfloor}\widehat{\tau}_{(i)}, \qquad 0\le q\le1,
</span></p>
<p>where <span class="math inline">\widehat{\tau}_{(1)}\ge\widehat{\tau}_{(2)}\ge\cdots</span> are the estimated effects sorted from largest to smallest. The horizontal axis <span class="math inline">q</span> is the fraction of the population we would treat; the vertical axis <span class="math inline">G(q)</span> is the cumulative gain we expect from treating that top slice.</p>
<p>Two integrals of the TOC curve summarise how lucrative targeting could be:</p>
<ul>
<li><p><strong>RATE AUTOC</strong> (Area <em>Under</em> the TOC) puts equal weight on every <span class="math inline">q</span>. This answers: <em>If benefits are concentrated among the very best prospects, how much can we harvest by cherry-picking them?</em></p></li>
<li><p><strong>RATE Qini</strong> applies heavier weight to the mid-range of <span class="math inline">q</span>. This is the go-to metric when investigators face a fixed, moderate-sized budget—say, “we can afford to treat 40 % of individuals; will targeting help?” <span class="citation" data-cites="yadlowsky2021evaluating">(<a href="#ref-yadlowsky2021evaluating" role="doc-biblioref">Yadlowsky et al. 2021</a>)</span>. We will evaluate the curve at treatment of 20% and 50% of the population.</p></li>
</ul>
<div class="no-row-height column-margin column-container"><div id="ref-yadlowsky2021evaluating" class="csl-entry" role="listitem">
Yadlowsky, Steve, Scott Fleming, Nigam Shah, Emma Brunskill, and Stefan Wager. 2021. <span>“Evaluating Treatment Prioritization Rules via Rank-Weighted Average Treatment Effects.”</span> <em>arXiv Preprint arXiv:2111.07966</em>. <a href="https://doi.org/10.48550/arXiv.2111.07966">https://doi.org/10.48550/arXiv.2111.07966</a>.
</div></div><p>To quantify the economic or policy value of heterogeneity, rank units by <span class="math inline">\widehat{\tau}(x)</span> and draw a <strong>Targeting-Operator Characteristic (TOC)</strong> curve that plots cumulative gain against the fraction <span class="math inline">q</span> of the population treated.</p>
<hr>
</section>
<section id="rate-autoc-example" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="rate-autoc-example">7 RATE AUTOC EXAMPLE</h3>
<p>Although OOB predictions are ‘out-of-sample’ for individual trees, the full forest still reuses information. A simple remedy when estimating the RATE AUTOC and Qini is to split the data, <strong>training</strong> the forest on one fold and <strong>testing</strong> RATE/Qini on the other. Again, this explicit splitting blocks optimistic bias and yields honest test statistics (such as confidence intervals) <span class="citation" data-cites="grf2024">(<a href="#ref-grf2024" role="doc-biblioref">Tibshirani et al. 2024</a>)</span>.</p>
<div class="no-row-height column-margin column-container"></div><div class="cell page-columns page-full">
<div id="fig-rate-example" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-rate-example-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="08-content_files/figure-html/fig-rate-example-1.png" class="img-fluid figure-img column-screen" width="672">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig" id="fig-rate-example-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: RATE AUTOC: Hours Socialising → Sense of Meaning
</figcaption>
</figure>
</div>
</div>
<p><a href="#fig-rate-example" class="quarto-xref">Figure&nbsp;1</a> depicts a typical RATE AUTOC curve with sample splitting. A steep initial rise indicates that a small, correctly targeted programme could deliver large gains. Note that the curve begins dipping below zero past about 30% of the sample. At that point we might be doing worse than the ATE by targeting the CATE – at least for some.</p>
<div class="page-columns page-full"><p><strong>Remember – figuring out who will benefit from a treatment is a difficult statistical problem <span class="citation" data-cites="grf2024">(<a href="#ref-grf2024" role="doc-biblioref">Tibshirani et al. 2024</a>)</span>.</strong></p><div class="no-row-height column-margin column-container"><div id="ref-grf2024" class="csl-entry" role="listitem">
Tibshirani, Julie, Susan Athey, Erik Sverdrup, and Stefan Wager. 2024. <em>Grf: Generalized Random Forests</em>. <a href="https://github.com/grf-labs/grf">https://github.com/grf-labs/grf</a>.
</div></div></div>
<hr>
</section>
<section id="visualising-policy-value-the-qini-curve" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="visualising-policy-value-the-qini-curve">8 Visualising policy value: the Qini curve</h3>
<p>A <strong>Qini curve</strong> displays cumulative benefit on the vertical axis and treatment coverage (% of the population treated) on the horizontal. As with the AUTOC curve we are using a held-out test fold to validate the response curve.</p>
<div class="cell page-columns page-full">
<div id="fig-qini-example" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-qini-example-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="08-content_files/figure-html/fig-qini-example-1.png" class="img-fluid figure-img column-screen" width="672">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig" id="fig-qini-example-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Qini Curve: Hours Socialising → Social Belonging
</figcaption>
</figure>
</div>
</div>
<p><a href="#fig-qini-example" class="quarto-xref">Figure&nbsp;2</a>: we find that focussing on the top 20 % of individuals nets a gain of 0.08 units (95 % CI 0.04–0.12). Widening the net to 50 % bumps the haul to 0.13 units (95 % CI 0.07–0.19). After that the curve flattens – once we’ve treated everyone who offers a decent return, there are no more ‘big fish’ left to catch.</p>
<hr>
</section>
<section id="from-a-black-box-to-simple-rules-policy-trees" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="from-a-black-box-to-simple-rules-policy-trees">9 From ‘a black box’ to simple rules: policy trees</h3>
<p>The causal forest hands us a personalised CATE for every individual, mapping a <strong>high-dimensional</strong> covariate vector <span class="math inline">X</span> to a number <span class="math inline">\widehat{\tau}(X)</span>. Helpful as that forecast may be, it stops short of telling us <em>what to do</em>: the function itself is too tangled — thousands of overlapping splits – to translate directly into a policy.</p>
<p>The <strong>policytree</strong> algorithm bridges that gap by collapsing the forest’s many <span class="math inline">\widehat{\tau}(X)</span> values into a single, shallow decision tree whose depth you choose; each split is chosen to maximise expected benefit <span class="citation" data-cites="policytree_package_2024">(<a href="#ref-policytree_package_2024" role="doc-biblioref">Sverdrup et al. 2024</a>)</span>. In this course we cap the depth at <strong>two</strong> for a practical balance, specifially:</p>
<div class="no-row-height column-margin column-container"><div id="ref-policytree_package_2024" class="csl-entry" role="listitem">
Sverdrup, Erik, Ayush Kanodia, Zhengyuan Zhou, Susan Athey, and Stefan Wager. 2024. <em>Policytree: Policy Learning via Doubly Robust Empirical Welfare Maximization over Trees</em>. <a href="https://CRAN.R-project.org/package=policytree">https://CRAN.R-project.org/package=policytree</a>.
</div></div><ul>
<li>At most three yes/no questions per rule, so the logic fits on a slide you can present to policy-makers</li>
<li>Each leaf still contains enough observations to yield a stable effect estimate;<br>
</li>
<li>Deeper trees increase computational complexity faster than they improve payoffs.</li>
</ul>
<div class="cell page-columns page-full">
<div id="fig-decision-tree" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-decision-tree-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="08-content_files/figure-html/fig-decision-tree-1.png" class="img-fluid figure-img column-screen" width="672">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig" id="fig-decision-tree-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Decision tree for Social Belonging
</figcaption>
</figure>
</div>
</div>
<p><strong>Policy Tree Findings for Effect of Hour Socialising on Social Belonging:</strong></p>
<p>Participants are first split by Self Esteem at -0.925 (original scale: 3.958). For those with Self Esteem <span class="math inline">&lt;=</span> this threshold, the next split is by Neuroticism at 0.642 (original scale: 4.228). Within that subgroup, individuals with Neuroticism <span class="math inline">&lt;=</span> the threshold are recommended <strong>control</strong>, while those with Neuroticism <span class="math inline">&gt;</span> the threshold are recommended <strong>treated</strong>.</p>
<p>For participants with Self Esteem <span class="math inline">&gt;</span> -0.925 (original scale: 3.958), the second split is by Social Belonging at 0.776 (original scale: 5.972). In this subgroup, individuals with Social Belonging <span class="math inline">&lt;=</span> the threshold are recommended <strong>treated</strong>, while those with Social Belonging <span class="math inline">&gt;</span> the threshold are recommended <strong>control</strong>.</p>
<div id="fig-policy-map" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-policy-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="08-content_files/figure-html/fig-policy-map-1.png" class="img-fluid figure-img" width="1536">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-policy-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Predicted treatment assignment (predictions out of training sample)
</figcaption>
</figure>
</div>
<hr>
</section>
<section id="ethical-and-practical-considerations" class="level3">
<h3 class="anchored" data-anchor-id="ethical-and-practical-considerations">10 Ethical and practical considerations</h3>
<p>There is no guarantee that statistical optimality will line up with social optimality. A rule that maximises expected health gains might still be <strong>unaffordable</strong> for a public agency, <strong>unfair</strong> to a protected group, or <strong>opaque</strong> to those asked to trust it. We all have our notions of fairness, and we can’t be expected to ignore them. Moreover, the estimation of CATE is always senstive to which variables we include in our model (see the caveats in <a href="https://go-bayes.github.io/psych-434-2025/content/06-content.html#appendix-b-evidence-for-effect-modification-is-relative-to-inclusion-of-other-variables-in-the-model">Lecture 6</a>).</p>
<p>So, we should not consider CATE an absolute guide to practice. We should be cautious.</p>
<p>Yet the very same CATE machinery that powers targeting also helps science move past a <em>one-size-fits-all</em> mindset. By mapping treatment effects across a high-dimensional covariate space, we can test whether our favourite categories – gender, age group, clinical severity – actually capture the differences that matter. Sometimes they do; often they don’t, revealing that nature is not carved at the joints of our folk classifications. Discovering <em>where</em> the forest finds meaningful splits can generate fresh psychological hypotheses about who responds, why, and under what circumstances, even when no policy decision is on the table. Over the next several weeks, we shall return to this point with examples.</p>
<!-- Before deployment we therefore need three extra layers of scrutiny: -->
<!-- 1. **Cost realism**   Will the programme's administrative and opportunity costs erase the forecast benefit?  A cost–effectiveness analysis can reveal when a simpler, less 'optimal' rule actually delivers better value.   -->
<!-- 2. **Fairness auditing**  check whether error rates or treatment probabilities differ by gender, ethnicity, or socioeconomic status.  If gaps appear, consider adjusting the loss function or adding fairness constraints [@mitchell2021algorithmic].   -->
<!-- 3. **Transparency and consent**   Publish the rule, document data sources, and secure stakeholder buy-in.  Transparent governance limits the risk of political backlash and encourages external replication. -->
<hr>
</section>
<section id="summarynext-steps" class="level3">
<h3 class="anchored" data-anchor-id="summarynext-steps">Summary/next steps</h3>
<p>Our workflow answers three questions in sequence:</p>
<ol type="1">
<li><strong>Is there substantial heterogeneity?</strong> Reject <span class="math inline">H_0{:}\tau(x)</span> constant if RATE AUTOC or RATE Qini is positive and statistically reliable<br>
</li>
<li><strong>Does targeting pay at realistic budgets?</strong> Inspect the slope of the Qini curve around plausible coverage levels.</li>
<li><strong>Can we express the targeting rule in a few defensible steps?</strong> fit and validate a shallow policy tree.</li>
</ol>
<p>In the lab section you will reproduce each stage on a simulated dataset.</p>
<hr>
</section>
</section>
<section id="part-1-laboratory-data-preparation-and-analysis-scripts" class="level1">
<h1>PART 1 Laboratory: Data Preparation and Analysis Scripts</h1>
<section id="link-to-data-dictionary" class="level3">
<h3 class="anchored" data-anchor-id="link-to-data-dictionary">Link to data dictionary</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>For information about the variables in the synthetic data, download the New Zealand Attitudes and Values Data Dictionary here under “Primary Resources”</p>
<p><a href="https://osf.io/75snb/">https://osf.io/75snb/</a></p>
</div>
</div>
</section>
<section id="script-0-synthetic-data-fetch" class="level2">
<h2 class="anchored" data-anchor-id="script-0-synthetic-data-fetch">Script 0: Synthetic Data Fetch</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># for students: reproducibility is like following a recipe; each step ensures the same result</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co"># restart fresh session if needed</span></span>
<span id="cb1-3"><a href="#cb1-3"></a></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co"># +--------------------------+</span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="co"># |       DO NOT ALTER       |</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="co"># +--------------------------+</span></span>
<span id="cb1-7"><a href="#cb1-7"></a></span>
<span id="cb1-8"><a href="#cb1-8"></a>rstudioapi<span class="sc">::</span><span class="fu">restartSession</span>()</span>
<span id="cb1-9"><a href="#cb1-9"></a></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="co"># set seed for reproducibility</span></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb1-12"><a href="#cb1-12"></a></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="co"># essential library ---------------------------------------------------------</span></span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="co"># install and load 'margot' from GitHub if missing</span></span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(margot, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb1-16"><a href="#cb1-16"></a>  devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"go-bayes/margot"</span>)</span>
<span id="cb1-17"><a href="#cb1-17"></a>  <span class="fu">library</span>(margot)</span>
<span id="cb1-18"><a href="#cb1-18"></a>}</span>
<span id="cb1-19"><a href="#cb1-19"></a></span>
<span id="cb1-20"><a href="#cb1-20"></a></span>
<span id="cb1-21"><a href="#cb1-21"></a><span class="cf">if</span> (<span class="fu">packageVersion</span>(<span class="st">"margot"</span>) <span class="sc">&lt;</span> <span class="st">"1.0.43"</span>) {</span>
<span id="cb1-22"><a href="#cb1-22"></a>  <span class="fu">stop</span>(<span class="st">"please install margot &gt;= 1.0.43 for this workflow</span><span class="sc">\n</span></span>
<span id="cb1-23"><a href="#cb1-23"></a><span class="st">       run: devtools::install_github(</span><span class="sc">\"</span><span class="st">go-bayes/margot</span><span class="sc">\"</span><span class="st">)</span></span>
<span id="cb1-24"><a href="#cb1-24"></a><span class="st">"</span>)</span>
<span id="cb1-25"><a href="#cb1-25"></a>}</span>
<span id="cb1-26"><a href="#cb1-26"></a></span>
<span id="cb1-27"><a href="#cb1-27"></a><span class="co"># call library</span></span>
<span id="cb1-28"><a href="#cb1-28"></a><span class="fu">library</span>(<span class="st">"margot"</span>)</span>
<span id="cb1-29"><a href="#cb1-29"></a></span>
<span id="cb1-30"><a href="#cb1-30"></a></span>
<span id="cb1-31"><a href="#cb1-31"></a></span>
<span id="cb1-32"><a href="#cb1-32"></a><span class="co"># load packages ----------------------------------------------------------</span></span>
<span id="cb1-33"><a href="#cb1-33"></a><span class="co"># install and load other packages from CRAN if missing</span></span>
<span id="cb1-34"><a href="#cb1-34"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"tidyverse"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb1-35"><a href="#cb1-35"></a>  <span class="fu">install.packages</span>(<span class="st">"tidyverse"</span>)</span>
<span id="cb1-36"><a href="#cb1-36"></a>}</span>
<span id="cb1-37"><a href="#cb1-37"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-38"><a href="#cb1-38"></a></span>
<span id="cb1-39"><a href="#cb1-39"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"qs"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb1-40"><a href="#cb1-40"></a>  <span class="fu">install.packages</span>(<span class="st">"qs"</span>)</span>
<span id="cb1-41"><a href="#cb1-41"></a>}</span>
<span id="cb1-42"><a href="#cb1-42"></a><span class="fu">library</span>(qs)</span>
<span id="cb1-43"><a href="#cb1-43"></a></span>
<span id="cb1-44"><a href="#cb1-44"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"here"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb1-45"><a href="#cb1-45"></a>  <span class="fu">install.packages</span>(<span class="st">"here"</span>)</span>
<span id="cb1-46"><a href="#cb1-46"></a>}</span>
<span id="cb1-47"><a href="#cb1-47"></a><span class="fu">library</span>(here)</span>
<span id="cb1-48"><a href="#cb1-48"></a></span>
<span id="cb1-49"><a href="#cb1-49"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"cli"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb1-50"><a href="#cb1-50"></a>  <span class="fu">install.packages</span>(<span class="st">"cli"</span>)</span>
<span id="cb1-51"><a href="#cb1-51"></a>}</span>
<span id="cb1-52"><a href="#cb1-52"></a><span class="fu">library</span>(<span class="st">"cli"</span>)</span>
<span id="cb1-53"><a href="#cb1-53"></a></span>
<span id="cb1-54"><a href="#cb1-54"></a></span>
<span id="cb1-55"><a href="#cb1-55"></a><span class="co"># create data directory if it doesn't exist -----------------------------</span></span>
<span id="cb1-56"><a href="#cb1-56"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"data"</span>)) {</span>
<span id="cb1-57"><a href="#cb1-57"></a>  <span class="fu">dir.create</span>(<span class="st">"data"</span>)  <span class="co"># first time only: make a folder named 'data'</span></span>
<span id="cb1-58"><a href="#cb1-58"></a>}</span>
<span id="cb1-59"><a href="#cb1-59"></a></span>
<span id="cb1-60"><a href="#cb1-60"></a><span class="co"># define file paths ------------------------------------------------------</span></span>
<span id="cb1-61"><a href="#cb1-61"></a><span class="co"># use here() to build paths relative to your project root</span></span>
<span id="cb1-62"><a href="#cb1-62"></a>data_dir <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>)</span>
<span id="cb1-63"><a href="#cb1-63"></a></span>
<span id="cb1-64"><a href="#cb1-64"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"created data folder ✔"</span>)</span>
<span id="cb1-65"><a href="#cb1-65"></a></span>
<span id="cb1-66"><a href="#cb1-66"></a></span>
<span id="cb1-67"><a href="#cb1-67"></a><span class="co"># download synthetic data ------------------------------------------------</span></span>
<span id="cb1-68"><a href="#cb1-68"></a><span class="co"># specify the url for the data file</span></span>
<span id="cb1-69"><a href="#cb1-69"></a>url <span class="ot">&lt;-</span> <span class="st">"https://www.dropbox.com/scl/fi/ru0ecayju04ja8ky1mhel/df_nz_long.qs?rlkey=prpk9a5v4vcg1ilhkgf357dhd&amp;dl=1"</span></span>
<span id="cb1-70"><a href="#cb1-70"></a></span>
<span id="cb1-71"><a href="#cb1-71"></a><span class="co"># download to a temporary file for safety</span></span>
<span id="cb1-72"><a href="#cb1-72"></a>tmp_file <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".qs"</span>)</span>
<span id="cb1-73"><a href="#cb1-73"></a><span class="fu">download.file</span>(url, tmp_file, <span class="at">mode =</span> <span class="st">"wb"</span>)</span>
<span id="cb1-74"><a href="#cb1-74"></a></span>
<span id="cb1-75"><a href="#cb1-75"></a><span class="co"># read the data into R using qread</span></span>
<span id="cb1-76"><a href="#cb1-76"></a>df_nz_long <span class="ot">&lt;-</span> <span class="fu">qread</span>(tmp_file)</span>
<span id="cb1-77"><a href="#cb1-77"></a></span>
<span id="cb1-78"><a href="#cb1-78"></a><span class="co"># inspect the data -------------------------------------------------------</span></span>
<span id="cb1-79"><a href="#cb1-79"></a><span class="co"># view the first few rows to check it loaded correctly</span></span>
<span id="cb1-80"><a href="#cb1-80"></a><span class="fu">print</span>(<span class="fu">head</span>(df_nz_long))</span>
<span id="cb1-81"><a href="#cb1-81"></a></span>
<span id="cb1-82"><a href="#cb1-82"></a><span class="co"># list column names so you know what variables are available</span></span>
<span id="cb1-83"><a href="#cb1-83"></a><span class="fu">print</span>(<span class="fu">colnames</span>(df_nz_long))</span>
<span id="cb1-84"><a href="#cb1-84"></a></span>
<span id="cb1-85"><a href="#cb1-85"></a><span class="co"># save a copy of the data ------------------------------------------------</span></span>
<span id="cb1-86"><a href="#cb1-86"></a><span class="co"># save the dataset to your data directory for future use</span></span>
<span id="cb1-87"><a href="#cb1-87"></a><span class="fu">here_save_qs</span>(df_nz_long, <span class="st">"df_nz_long"</span>, data_dir)</span>
<span id="cb1-88"><a href="#cb1-88"></a></span>
<span id="cb1-89"><a href="#cb1-89"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"downloaded data to data folder for furture use ✔"</span>)</span>
<span id="cb1-90"><a href="#cb1-90"></a></span>
<span id="cb1-91"><a href="#cb1-91"></a><span class="co"># +--------------------------+</span></span>
<span id="cb1-92"><a href="#cb1-92"></a><span class="co"># |     </span><span class="re">END</span><span class="co"> DO NOT ALTER     |</span></span>
<span id="cb1-93"><a href="#cb1-93"></a><span class="co"># +--------------------------+</span></span>
<span id="cb1-94"><a href="#cb1-94"></a></span>
<span id="cb1-95"><a href="#cb1-95"></a></span>
<span id="cb1-96"><a href="#cb1-96"></a><span class="co"># +--------------------------+</span></span>
<span id="cb1-97"><a href="#cb1-97"></a><span class="co"># |     </span><span class="re">END</span><span class="co">                  |</span></span>
<span id="cb1-98"><a href="#cb1-98"></a><span class="co"># +--------------------------+</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="script-1-initial-data-wrangling" class="level2">
<h2 class="anchored" data-anchor-id="script-1-initial-data-wrangling">Script 1: Initial Data Wrangling</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># script 1 workflow lecture 10</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co"># may 2025</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co"># questions: joseph.bulbulia@vuw.ac.nz</span></span>
<span id="cb2-4"><a href="#cb2-4"></a></span>
<span id="cb2-5"><a href="#cb2-5"></a></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="co"># |       DO NOT ALTER       |</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-9"><a href="#cb2-9"></a></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="co"># restart fresh session for a clean workspace</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>rstudioapi<span class="sc">::</span><span class="fu">restartSession</span>()</span>
<span id="cb2-12"><a href="#cb2-12"></a></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="co"># set seed for reproducibility</span></span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb2-15"><a href="#cb2-15"></a></span>
<span id="cb2-16"><a href="#cb2-16"></a><span class="co"># essential library ---------------------------------------------------------</span></span>
<span id="cb2-17"><a href="#cb2-17"></a><span class="co"># install and load 'margot' from GitHub if missing</span></span>
<span id="cb2-18"><a href="#cb2-18"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(margot, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb2-19"><a href="#cb2-19"></a>  devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"go-bayes/margot"</span>)</span>
<span id="cb2-20"><a href="#cb2-20"></a>  <span class="fu">library</span>(margot)</span>
<span id="cb2-21"><a href="#cb2-21"></a>}</span>
<span id="cb2-22"><a href="#cb2-22"></a></span>
<span id="cb2-23"><a href="#cb2-23"></a><span class="co"># min version of margot</span></span>
<span id="cb2-24"><a href="#cb2-24"></a><span class="cf">if</span> (<span class="fu">packageVersion</span>(<span class="st">"margot"</span>) <span class="sc">&lt;</span> <span class="st">"1.0.47"</span>) {</span>
<span id="cb2-25"><a href="#cb2-25"></a>  <span class="fu">stop</span>(<span class="st">"please install margot &gt;= 1.0.47 for this workflow</span><span class="sc">\n</span></span>
<span id="cb2-26"><a href="#cb2-26"></a><span class="st">       run: devtools::install_github(</span><span class="sc">\"</span><span class="st">go-bayes/margot</span><span class="sc">\"</span><span class="st">)</span></span>
<span id="cb2-27"><a href="#cb2-27"></a><span class="st">"</span>)</span>
<span id="cb2-28"><a href="#cb2-28"></a>}</span>
<span id="cb2-29"><a href="#cb2-29"></a></span>
<span id="cb2-30"><a href="#cb2-30"></a><span class="co"># call library</span></span>
<span id="cb2-31"><a href="#cb2-31"></a><span class="fu">library</span>(<span class="st">"margot"</span>)</span>
<span id="cb2-32"><a href="#cb2-32"></a></span>
<span id="cb2-33"><a href="#cb2-33"></a><span class="co"># load packages -------------------------------------------------------------</span></span>
<span id="cb2-34"><a href="#cb2-34"></a><span class="co"># pacman will install missing packages automatically</span></span>
<span id="cb2-35"><a href="#cb2-35"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"pacman"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"pacman"</span>)</span>
<span id="cb2-36"><a href="#cb2-36"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb2-37"><a href="#cb2-37"></a>  tidyverse,       <span class="co"># data wrangling + plotting</span></span>
<span id="cb2-38"><a href="#cb2-38"></a>  qs,              <span class="co"># fast data i/o</span></span>
<span id="cb2-39"><a href="#cb2-39"></a>  here,            <span class="co"># project-relative file paths</span></span>
<span id="cb2-40"><a href="#cb2-40"></a>  data.table,      <span class="co"># fast data manipulation</span></span>
<span id="cb2-41"><a href="#cb2-41"></a>  fastDummies,     <span class="co"># dummy variable creation</span></span>
<span id="cb2-42"><a href="#cb2-42"></a>  naniar,          <span class="co"># missing data handling</span></span>
<span id="cb2-43"><a href="#cb2-43"></a>  skimr,           <span class="co"># summary statistics</span></span>
<span id="cb2-44"><a href="#cb2-44"></a>  grf,             <span class="co"># machine learning forests</span></span>
<span id="cb2-45"><a href="#cb2-45"></a>  kableExtra,      <span class="co"># tables</span></span>
<span id="cb2-46"><a href="#cb2-46"></a>  ggplot2,         <span class="co"># graphs</span></span>
<span id="cb2-47"><a href="#cb2-47"></a>  doParallel,       <span class="co"># parallel processing</span></span>
<span id="cb2-48"><a href="#cb2-48"></a>  grf,             <span class="co"># causal forests</span></span>
<span id="cb2-49"><a href="#cb2-49"></a>  janitor,          <span class="co"># variables names</span></span>
<span id="cb2-50"><a href="#cb2-50"></a>  stringr,          <span class="co"># variable names</span></span>
<span id="cb2-51"><a href="#cb2-51"></a>  patchwork,        <span class="co"># graphs</span></span>
<span id="cb2-52"><a href="#cb2-52"></a>  table1,          <span class="co"># tables,</span></span>
<span id="cb2-53"><a href="#cb2-53"></a>  cli</span>
<span id="cb2-54"><a href="#cb2-54"></a>)</span>
<span id="cb2-55"><a href="#cb2-55"></a></span>
<span id="cb2-56"><a href="#cb2-56"></a></span>
<span id="cb2-57"><a href="#cb2-57"></a><span class="co"># create directories --------------------------------------------------------</span></span>
<span id="cb2-58"><a href="#cb2-58"></a><span class="co"># create data directory if it doesn't exist</span></span>
<span id="cb2-59"><a href="#cb2-59"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"data"</span>)) {</span>
<span id="cb2-60"><a href="#cb2-60"></a>  <span class="fu">dir.create</span>(<span class="st">"data"</span>)  <span class="co"># first time only: make a folder named 'data'</span></span>
<span id="cb2-61"><a href="#cb2-61"></a>}</span>
<span id="cb2-62"><a href="#cb2-62"></a></span>
<span id="cb2-63"><a href="#cb2-63"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"save_directory"</span>)) {</span>
<span id="cb2-64"><a href="#cb2-64"></a>  <span class="fu">dir.create</span>(<span class="st">"save_directory"</span>)  <span class="co"># first time only: make a folder named 'data'</span></span>
<span id="cb2-65"><a href="#cb2-65"></a>}</span>
<span id="cb2-66"><a href="#cb2-66"></a></span>
<span id="cb2-67"><a href="#cb2-67"></a><span class="co"># set up data directory structure</span></span>
<span id="cb2-68"><a href="#cb2-68"></a>data_dir    <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>)</span>
<span id="cb2-69"><a href="#cb2-69"></a>push_mods <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"save_directory"</span>) </span>
<span id="cb2-70"><a href="#cb2-70"></a></span>
<span id="cb2-71"><a href="#cb2-71"></a></span>
<span id="cb2-72"><a href="#cb2-72"></a><span class="co"># load data -----------------------------------------------------------------</span></span>
<span id="cb2-73"><a href="#cb2-73"></a>df_nz_long <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read_qs</span>(<span class="st">"df_nz_long"</span>, data_dir)</span>
<span id="cb2-74"><a href="#cb2-74"></a></span>
<span id="cb2-75"><a href="#cb2-75"></a></span>
<span id="cb2-76"><a href="#cb2-76"></a><span class="co"># initial data prep ---------------------------------------------------------</span></span>
<span id="cb2-77"><a href="#cb2-77"></a><span class="co"># prepare intial data</span></span>
<span id="cb2-78"><a href="#cb2-78"></a><span class="co"># define labels for rural classification</span></span>
<span id="cb2-79"><a href="#cb2-79"></a>rural_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb2-80"><a href="#cb2-80"></a>  <span class="st">"High Urban Accessibility"</span>, </span>
<span id="cb2-81"><a href="#cb2-81"></a>  <span class="st">"Medium Urban Accessibility"</span>,</span>
<span id="cb2-82"><a href="#cb2-82"></a>  <span class="st">"Low Urban Accessibility"</span>, </span>
<span id="cb2-83"><a href="#cb2-83"></a>  <span class="st">"Remote"</span>, </span>
<span id="cb2-84"><a href="#cb2-84"></a>  <span class="st">"Very Remote"</span></span>
<span id="cb2-85"><a href="#cb2-85"></a>)</span>
<span id="cb2-86"><a href="#cb2-86"></a></span>
<span id="cb2-87"><a href="#cb2-87"></a>dat_prep <span class="ot">&lt;-</span> df_nz_long <span class="sc">|&gt;</span></span>
<span id="cb2-88"><a href="#cb2-88"></a>  <span class="fu">arrange</span>(id, wave) <span class="sc">|&gt;</span></span>
<span id="cb2-89"><a href="#cb2-89"></a>  margot<span class="sc">::</span><span class="fu">remove_numeric_attributes</span>() <span class="sc">|&gt;</span></span>
<span id="cb2-90"><a href="#cb2-90"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-91"><a href="#cb2-91"></a>    <span class="co"># cap extreme values</span></span>
<span id="cb2-92"><a href="#cb2-92"></a>    <span class="at">alcohol_intensity =</span> <span class="fu">pmin</span>(alcohol_intensity, <span class="dv">15</span>),</span>
<span id="cb2-93"><a href="#cb2-93"></a>    <span class="co"># flag heavy drinkers: freq ≥3 → 1, ≤2 → 0, else NA</span></span>
<span id="cb2-94"><a href="#cb2-94"></a>    <span class="at">heavy_drinker =</span> <span class="fu">case_when</span>(</span>
<span id="cb2-95"><a href="#cb2-95"></a>      alcohol_frequency <span class="sc">&gt;=</span> <span class="dv">3</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb2-96"><a href="#cb2-96"></a>      alcohol_frequency <span class="sc">&lt;=</span> <span class="dv">2</span> <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb2-97"><a href="#cb2-97"></a>      <span class="cn">TRUE</span>                  <span class="sc">~</span> <span class="cn">NA_real_</span></span>
<span id="cb2-98"><a href="#cb2-98"></a>    ),</span>
<span id="cb2-99"><a href="#cb2-99"></a>    <span class="co"># map freq categories to weekly counts</span></span>
<span id="cb2-100"><a href="#cb2-100"></a>    <span class="at">alcohol_frequency_weekly =</span> <span class="fu">recode</span>(</span>
<span id="cb2-101"><a href="#cb2-101"></a>      alcohol_frequency,</span>
<span id="cb2-102"><a href="#cb2-102"></a>      <span class="st">`</span><span class="at">0</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">0</span>, <span class="st">`</span><span class="at">1</span><span class="st">`</span> <span class="ot">=</span> <span class="fl">0.25</span>,</span>
<span id="cb2-103"><a href="#cb2-103"></a>      <span class="st">`</span><span class="at">2</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">`</span><span class="at">3</span><span class="st">`</span> <span class="ot">=</span> <span class="fl">2.5</span>,</span>
<span id="cb2-104"><a href="#cb2-104"></a>      <span class="st">`</span><span class="at">4</span><span class="st">`</span> <span class="ot">=</span> <span class="fl">4.5</span>,</span>
<span id="cb2-105"><a href="#cb2-105"></a>      <span class="at">.default =</span> <span class="cn">NA_real_</span></span>
<span id="cb2-106"><a href="#cb2-106"></a>    ),</span>
<span id="cb2-107"><a href="#cb2-107"></a>    <span class="co"># relabel rural factor</span></span>
<span id="cb2-108"><a href="#cb2-108"></a>    <span class="at">rural_gch_2018_l =</span> <span class="fu">factor</span>(</span>
<span id="cb2-109"><a href="#cb2-109"></a>      rural_gch_2018_l,</span>
<span id="cb2-110"><a href="#cb2-110"></a>      <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,</span>
<span id="cb2-111"><a href="#cb2-111"></a>      <span class="at">labels =</span> rural_labels,</span>
<span id="cb2-112"><a href="#cb2-112"></a>      <span class="at">ordered =</span> <span class="cn">TRUE</span></span>
<span id="cb2-113"><a href="#cb2-113"></a>    )</span>
<span id="cb2-114"><a href="#cb2-114"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb2-115"><a href="#cb2-115"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb2-116"><a href="#cb2-116"></a></span>
<span id="cb2-117"><a href="#cb2-117"></a></span>
<span id="cb2-118"><a href="#cb2-118"></a></span>
<span id="cb2-119"><a href="#cb2-119"></a><span class="co"># view variable names -----------------------------------------------------</span></span>
<span id="cb2-120"><a href="#cb2-120"></a><span class="fu">print</span>(<span class="fu">colnames</span>(df_nz_long)) </span>
<span id="cb2-121"><a href="#cb2-121"></a></span>
<span id="cb2-122"><a href="#cb2-122"></a></span>
<span id="cb2-123"><a href="#cb2-123"></a><span class="co"># get total participants</span></span>
<span id="cb2-124"><a href="#cb2-124"></a>n_total <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_nz_long<span class="sc">$</span>id))</span>
<span id="cb2-125"><a href="#cb2-125"></a></span>
<span id="cb2-126"><a href="#cb2-126"></a><span class="co"># pretty number</span></span>
<span id="cb2-127"><a href="#cb2-127"></a>n_total <span class="ot">=</span> margot<span class="sc">::</span><span class="fu">pretty_number</span>(n_total)</span>
<span id="cb2-128"><a href="#cb2-128"></a></span>
<span id="cb2-129"><a href="#cb2-129"></a><span class="co"># save</span></span>
<span id="cb2-130"><a href="#cb2-130"></a><span class="fu">here_save</span>(n_total, <span class="st">"n_total"</span>)</span>
<span id="cb2-131"><a href="#cb2-131"></a></span>
<span id="cb2-132"><a href="#cb2-132"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-133"><a href="#cb2-133"></a><span class="co"># |     </span><span class="re">END</span><span class="co"> DO NOT ALTER     |</span></span>
<span id="cb2-134"><a href="#cb2-134"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-135"><a href="#cb2-135"></a></span>
<span id="cb2-136"><a href="#cb2-136"></a></span>
<span id="cb2-137"><a href="#cb2-137"></a></span>
<span id="cb2-138"><a href="#cb2-138"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-139"><a href="#cb2-139"></a><span class="co"># |    MODIFY THIS SECTION   |</span></span>
<span id="cb2-140"><a href="#cb2-140"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-141"><a href="#cb2-141"></a></span>
<span id="cb2-142"><a href="#cb2-142"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-143"><a href="#cb2-143"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb2-144"><a href="#cb2-144"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-145"><a href="#cb2-145"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-146"><a href="#cb2-146"></a><span class="co"># | OPTIONALLY MODIFY SECTION|</span></span>
<span id="cb2-147"><a href="#cb2-147"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-148"><a href="#cb2-148"></a></span>
<span id="cb2-149"><a href="#cb2-149"></a><span class="co"># define study variables ----------------------------------------------------</span></span>
<span id="cb2-150"><a href="#cb2-150"></a><span class="co"># ** key decision 1: define your three study waves **</span></span>
<span id="cb2-151"><a href="#cb2-151"></a><span class="co"># **  define your study waves **</span></span>
<span id="cb2-152"><a href="#cb2-152"></a>baseline_wave      <span class="ot">&lt;-</span> <span class="st">"2018"</span>        <span class="co"># baseline measurement</span></span>
<span id="cb2-153"><a href="#cb2-153"></a>exposure_waves     <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"2019"</span>)     <span class="co"># when exposure is measured</span></span>
<span id="cb2-154"><a href="#cb2-154"></a>outcome_wave       <span class="ot">&lt;-</span> <span class="st">"2020"</span>        <span class="co"># when outcomes are measured</span></span>
<span id="cb2-155"><a href="#cb2-155"></a>all_waves          <span class="ot">&lt;-</span> <span class="fu">c</span>(baseline_wave, exposure_waves, outcome_wave)</span>
<span id="cb2-156"><a href="#cb2-156"></a></span>
<span id="cb2-157"><a href="#cb2-157"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"set waves for three-wave study ✔"</span>)</span>
<span id="cb2-158"><a href="#cb2-158"></a></span>
<span id="cb2-159"><a href="#cb2-159"></a></span>
<span id="cb2-160"><a href="#cb2-160"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-161"><a href="#cb2-161"></a><span class="co"># |</span><span class="re">END</span><span class="co"> OPTIONALLY MODIFY SEC.|</span></span>
<span id="cb2-162"><a href="#cb2-162"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-163"><a href="#cb2-163"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-164"><a href="#cb2-164"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb2-165"><a href="#cb2-165"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-166"><a href="#cb2-166"></a></span>
<span id="cb2-167"><a href="#cb2-167"></a></span>
<span id="cb2-168"><a href="#cb2-168"></a></span>
<span id="cb2-169"><a href="#cb2-169"></a><span class="co"># define exposure variable ----------------------------------------------------</span></span>
<span id="cb2-170"><a href="#cb2-170"></a><span class="co"># ** key decision 2: define your exposure variable **</span></span>
<span id="cb2-171"><a href="#cb2-171"></a></span>
<span id="cb2-172"><a href="#cb2-172"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-173"><a href="#cb2-173"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb2-174"><a href="#cb2-174"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-175"><a href="#cb2-175"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-176"><a href="#cb2-176"></a><span class="co"># |    MODIFY THIS SECTION   |</span></span>
<span id="cb2-177"><a href="#cb2-177"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-178"><a href="#cb2-178"></a>name_exposure <span class="ot">&lt;-</span> <span class="st">"extraversion"</span></span>
<span id="cb2-179"><a href="#cb2-179"></a></span>
<span id="cb2-180"><a href="#cb2-180"></a><span class="co"># exposure variable labels</span></span>
<span id="cb2-181"><a href="#cb2-181"></a>var_labels_exposure <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb2-182"><a href="#cb2-182"></a>  <span class="st">"extraversion"</span> <span class="ot">=</span> <span class="st">"Extraversion"</span>,</span>
<span id="cb2-183"><a href="#cb2-183"></a>  <span class="st">"extraversion_binary"</span> <span class="ot">=</span> <span class="st">"Extraversion (binary)"</span></span>
<span id="cb2-184"><a href="#cb2-184"></a>)</span>
<span id="cb2-185"><a href="#cb2-185"></a></span>
<span id="cb2-186"><a href="#cb2-186"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"set variable name for exposure ✔"</span>)</span>
<span id="cb2-187"><a href="#cb2-187"></a></span>
<span id="cb2-188"><a href="#cb2-188"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-189"><a href="#cb2-189"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb2-190"><a href="#cb2-190"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-191"><a href="#cb2-191"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-192"><a href="#cb2-192"></a><span class="co"># |   </span><span class="re">END</span><span class="co"> MODIFY SECTION     |</span></span>
<span id="cb2-193"><a href="#cb2-193"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-194"><a href="#cb2-194"></a></span>
<span id="cb2-195"><a href="#cb2-195"></a></span>
<span id="cb2-196"><a href="#cb2-196"></a></span>
<span id="cb2-197"><a href="#cb2-197"></a></span>
<span id="cb2-198"><a href="#cb2-198"></a></span>
<span id="cb2-199"><a href="#cb2-199"></a></span>
<span id="cb2-200"><a href="#cb2-200"></a><span class="co"># define outcome variables -------------------------------------------</span></span>
<span id="cb2-201"><a href="#cb2-201"></a><span class="co"># ** key decision 3: define your outcome variable **</span></span>
<span id="cb2-202"><a href="#cb2-202"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-203"><a href="#cb2-203"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb2-204"><a href="#cb2-204"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-205"><a href="#cb2-205"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-206"><a href="#cb2-206"></a><span class="co"># |    MODIFY THIS SECTION   |</span></span>
<span id="cb2-207"><a href="#cb2-207"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-208"><a href="#cb2-208"></a><span class="co"># ** key decision 3: define outcome variables **</span></span>
<span id="cb2-209"><a href="#cb2-209"></a><span class="co"># here, we are focussing on a subset of wellbeing outcomes</span></span>
<span id="cb2-210"><a href="#cb2-210"></a><span class="co"># chose outcomes relevant to * your * study. Might be all/some/none/exactly </span></span>
<span id="cb2-211"><a href="#cb2-211"></a><span class="co"># these:</span></span>
<span id="cb2-212"><a href="#cb2-212"></a>outcome_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb2-213"><a href="#cb2-213"></a>  <span class="co"># health outcomes</span></span>
<span id="cb2-214"><a href="#cb2-214"></a>  <span class="co"># "alcohol_frequency_weekly", "alcohol_intensity",</span></span>
<span id="cb2-215"><a href="#cb2-215"></a>  <span class="co"># "hlth_bmi", </span></span>
<span id="cb2-216"><a href="#cb2-216"></a>  <span class="st">"log_hours_exercise"</span>, </span>
<span id="cb2-217"><a href="#cb2-217"></a>  <span class="co"># "hlth_sleep_hours", </span></span>
<span id="cb2-218"><a href="#cb2-218"></a>  <span class="co"># "short_form_health",</span></span>
<span id="cb2-219"><a href="#cb2-219"></a>  </span>
<span id="cb2-220"><a href="#cb2-220"></a>  <span class="co"># psychological outcomes</span></span>
<span id="cb2-221"><a href="#cb2-221"></a>  <span class="co"># "hlth_fatigue", </span></span>
<span id="cb2-222"><a href="#cb2-222"></a>  <span class="st">"kessler_latent_anxiety"</span>, </span>
<span id="cb2-223"><a href="#cb2-223"></a>  <span class="st">"kessler_latent_depression"</span>, </span>
<span id="cb2-224"><a href="#cb2-224"></a>  <span class="st">"rumination"</span>,</span>
<span id="cb2-225"><a href="#cb2-225"></a>  </span>
<span id="cb2-226"><a href="#cb2-226"></a>  <span class="co"># well-being outcomes</span></span>
<span id="cb2-227"><a href="#cb2-227"></a>  <span class="co"># "bodysat", </span></span>
<span id="cb2-228"><a href="#cb2-228"></a>  <span class="co">#"forgiveness", "gratitude", </span></span>
<span id="cb2-229"><a href="#cb2-229"></a>  <span class="st">"lifesat"</span>, <span class="st">"meaning_purpose"</span>, <span class="st">"meaning_sense"</span>, </span>
<span id="cb2-230"><a href="#cb2-230"></a>  <span class="co"># "perfectionism", </span></span>
<span id="cb2-231"><a href="#cb2-231"></a>  <span class="st">"pwi"</span>, </span>
<span id="cb2-232"><a href="#cb2-232"></a>  <span class="co">#"self_control", </span></span>
<span id="cb2-233"><a href="#cb2-233"></a>  <span class="st">"self_esteem"</span>, </span>
<span id="cb2-234"><a href="#cb2-234"></a>  <span class="co">#"sexual_satisfaction",</span></span>
<span id="cb2-235"><a href="#cb2-235"></a>  </span>
<span id="cb2-236"><a href="#cb2-236"></a>  <span class="co"># social outcomes</span></span>
<span id="cb2-237"><a href="#cb2-237"></a>  <span class="st">"belong"</span>, <span class="st">"neighbourhood_community"</span>, <span class="st">"support"</span></span>
<span id="cb2-238"><a href="#cb2-238"></a>)</span>
<span id="cb2-239"><a href="#cb2-239"></a></span>
<span id="cb2-240"><a href="#cb2-240"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"set variable name for outcomes ✔"</span>)</span>
<span id="cb2-241"><a href="#cb2-241"></a></span>
<span id="cb2-242"><a href="#cb2-242"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-243"><a href="#cb2-243"></a><span class="co"># |   </span><span class="re">END</span><span class="co"> MODIFY SECTION     |</span></span>
<span id="cb2-244"><a href="#cb2-244"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-245"><a href="#cb2-245"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-246"><a href="#cb2-246"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb2-247"><a href="#cb2-247"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-248"><a href="#cb2-248"></a></span>
<span id="cb2-249"><a href="#cb2-249"></a></span>
<span id="cb2-250"><a href="#cb2-250"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-251"><a href="#cb2-251"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb2-252"><a href="#cb2-252"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-253"><a href="#cb2-253"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-254"><a href="#cb2-254"></a><span class="co"># | OPTIONALLY MODIFY SECTION|</span></span>
<span id="cb2-255"><a href="#cb2-255"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-256"><a href="#cb2-256"></a><span class="co"># define baseline variables -----------------------------------------------</span></span>
<span id="cb2-257"><a href="#cb2-257"></a><span class="co"># key decision 4 **  define baseline covariates **</span></span>
<span id="cb2-258"><a href="#cb2-258"></a><span class="co"># these are demographics, traits, etc. measured at baseline, that are common</span></span>
<span id="cb2-259"><a href="#cb2-259"></a><span class="co"># causes of the exposure and outcome.  </span></span>
<span id="cb2-260"><a href="#cb2-260"></a><span class="co"># note we will automatically include baseline measures of the exposure and outcome</span></span>
<span id="cb2-261"><a href="#cb2-261"></a><span class="co"># later in the workflow.</span></span>
<span id="cb2-262"><a href="#cb2-262"></a></span>
<span id="cb2-263"><a href="#cb2-263"></a>baseline_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb2-264"><a href="#cb2-264"></a>  <span class="co"># demographics</span></span>
<span id="cb2-265"><a href="#cb2-265"></a>  <span class="st">"age"</span>, <span class="st">"born_nz_binary"</span>, <span class="st">"education_level_coarsen"</span>,</span>
<span id="cb2-266"><a href="#cb2-266"></a>  <span class="st">"employed_binary"</span>, <span class="st">"eth_cat"</span>, <span class="st">"male_binary"</span>,</span>
<span id="cb2-267"><a href="#cb2-267"></a>  <span class="st">"not_heterosexual_binary"</span>, <span class="st">"parent_binary"</span>, <span class="st">"partner_binary"</span>,</span>
<span id="cb2-268"><a href="#cb2-268"></a>  <span class="st">"rural_gch_2018_l"</span>, <span class="st">"sample_frame_opt_in_binary"</span>,</span>
<span id="cb2-269"><a href="#cb2-269"></a>  </span>
<span id="cb2-270"><a href="#cb2-270"></a>  <span class="co"># personality traits (excluding exposure)</span></span>
<span id="cb2-271"><a href="#cb2-271"></a>  <span class="st">"agreeableness"</span>, <span class="st">"conscientiousness"</span>, <span class="st">"neuroticism"</span>, <span class="st">"openness"</span>,</span>
<span id="cb2-272"><a href="#cb2-272"></a>  </span>
<span id="cb2-273"><a href="#cb2-273"></a>  <span class="co"># health and lifestyle</span></span>
<span id="cb2-274"><a href="#cb2-274"></a>  <span class="st">"alcohol_frequency"</span>, <span class="st">"alcohol_intensity"</span>, <span class="st">"hlth_disability_binary"</span>,</span>
<span id="cb2-275"><a href="#cb2-275"></a>  <span class="st">"log_hours_children"</span>, <span class="st">"log_hours_commute"</span>, <span class="st">"log_hours_exercise"</span>,</span>
<span id="cb2-276"><a href="#cb2-276"></a>  <span class="st">"log_hours_housework"</span>, <span class="st">"log_household_inc"</span>,</span>
<span id="cb2-277"><a href="#cb2-277"></a>  <span class="st">"short_form_health"</span>, <span class="st">"smoker_binary"</span>,</span>
<span id="cb2-278"><a href="#cb2-278"></a>  </span>
<span id="cb2-279"><a href="#cb2-279"></a>  <span class="co"># social and psychological</span></span>
<span id="cb2-280"><a href="#cb2-280"></a>  <span class="st">"belong"</span>, <span class="st">"nz_dep2018"</span>, <span class="st">"nzsei_13_l"</span>,</span>
<span id="cb2-281"><a href="#cb2-281"></a>  <span class="st">"political_conservative"</span>, <span class="st">"religion_identification_level"</span>,</span>
<span id="cb2-282"><a href="#cb2-282"></a>  </span>
<span id="cb2-283"><a href="#cb2-283"></a>  <span class="co"># religious denominations</span></span>
<span id="cb2-284"><a href="#cb2-284"></a>  <span class="st">"religion_bigger_denominations"</span> <span class="co"># &lt;- added for interest *OPTIONAL</span></span>
<span id="cb2-285"><a href="#cb2-285"></a>)</span>
<span id="cb2-286"><a href="#cb2-286"></a></span>
<span id="cb2-287"><a href="#cb2-287"></a></span>
<span id="cb2-288"><a href="#cb2-288"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"set baseline covariate names  ✔"</span>)</span>
<span id="cb2-289"><a href="#cb2-289"></a></span>
<span id="cb2-290"><a href="#cb2-290"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-291"><a href="#cb2-291"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb2-292"><a href="#cb2-292"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-293"><a href="#cb2-293"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-294"><a href="#cb2-294"></a><span class="co"># |   </span><span class="re">END</span><span class="co"> MODIFY SECTION     |</span></span>
<span id="cb2-295"><a href="#cb2-295"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-296"><a href="#cb2-296"></a></span>
<span id="cb2-297"><a href="#cb2-297"></a></span>
<span id="cb2-298"><a href="#cb2-298"></a></span>
<span id="cb2-299"><a href="#cb2-299"></a></span>
<span id="cb2-300"><a href="#cb2-300"></a></span>
<span id="cb2-301"><a href="#cb2-301"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-302"><a href="#cb2-302"></a><span class="co"># |       DO NOT ALTER       |</span></span>
<span id="cb2-303"><a href="#cb2-303"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-304"><a href="#cb2-304"></a></span>
<span id="cb2-305"><a href="#cb2-305"></a><span class="co"># after selecting your exposure/ baseline / outcome variables do not modify this</span></span>
<span id="cb2-306"><a href="#cb2-306"></a><span class="co"># code</span></span>
<span id="cb2-307"><a href="#cb2-307"></a></span>
<span id="cb2-308"><a href="#cb2-308"></a><span class="co"># make binary variable (UNLESS YOUR EXPOSURE IS A BINARY VARIABLE)</span></span>
<span id="cb2-309"><a href="#cb2-309"></a>exposure_var_binary <span class="ot">=</span> <span class="fu">paste0</span>(name_exposure, <span class="st">"_binary"</span>)</span>
<span id="cb2-310"><a href="#cb2-310"></a></span>
<span id="cb2-311"><a href="#cb2-311"></a><span class="co"># make exposure variable list (we will keep both the continuous and binary variable)</span></span>
<span id="cb2-312"><a href="#cb2-312"></a>exposure_var  <span class="ot">&lt;-</span> <span class="fu">c</span>(name_exposure, <span class="fu">paste0</span>(name_exposure, <span class="st">"_binary"</span>))</span>
<span id="cb2-313"><a href="#cb2-313"></a></span>
<span id="cb2-314"><a href="#cb2-314"></a><span class="co"># sort for easier reference</span></span>
<span id="cb2-315"><a href="#cb2-315"></a>baseline_vars <span class="ot">&lt;-</span> <span class="fu">sort</span>(baseline_vars)</span>
<span id="cb2-316"><a href="#cb2-316"></a>outcome_vars <span class="ot">&lt;-</span> <span class="fu">sort</span>(outcome_vars)</span>
<span id="cb2-317"><a href="#cb2-317"></a></span>
<span id="cb2-318"><a href="#cb2-318"></a><span class="co"># save key variables --------------------------------------------------------</span></span>
<span id="cb2-319"><a href="#cb2-319"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(name_exposure, <span class="st">"name_exposure"</span>)</span>
<span id="cb2-320"><a href="#cb2-320"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(var_labels_exposure,<span class="st">"var_labels_exposure"</span>)</span>
<span id="cb2-321"><a href="#cb2-321"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(baseline_vars,<span class="st">"baseline_vars"</span>)</span>
<span id="cb2-322"><a href="#cb2-322"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(exposure_var, <span class="st">"exposure_var"</span>)</span>
<span id="cb2-323"><a href="#cb2-323"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(exposure_var_binary, <span class="st">"exposure_var_binary"</span>)</span>
<span id="cb2-324"><a href="#cb2-324"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(outcome_vars, <span class="st">"outcome_vars"</span>)</span>
<span id="cb2-325"><a href="#cb2-325"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(baseline_wave, <span class="st">"baseline_wave"</span>)</span>
<span id="cb2-326"><a href="#cb2-326"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(exposure_waves, <span class="st">"exposure_waves"</span>)</span>
<span id="cb2-327"><a href="#cb2-327"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(outcome_wave, <span class="st">"outcome_wave"</span>)</span>
<span id="cb2-328"><a href="#cb2-328"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(all_waves,<span class="st">"all_waves"</span>)</span>
<span id="cb2-329"><a href="#cb2-329"></a></span>
<span id="cb2-330"><a href="#cb2-330"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"saved names and labels to be used for manuscript  ✔"</span>)</span>
<span id="cb2-331"><a href="#cb2-331"></a></span>
<span id="cb2-332"><a href="#cb2-332"></a></span>
<span id="cb2-333"><a href="#cb2-333"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-334"><a href="#cb2-334"></a><span class="co"># |     </span><span class="re">END</span><span class="co"> DO NOT ALTER     |</span></span>
<span id="cb2-335"><a href="#cb2-335"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-336"><a href="#cb2-336"></a></span>
<span id="cb2-337"><a href="#cb2-337"></a></span>
<span id="cb2-338"><a href="#cb2-338"></a></span>
<span id="cb2-339"><a href="#cb2-339"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-340"><a href="#cb2-340"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb2-341"><a href="#cb2-341"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-342"><a href="#cb2-342"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-343"><a href="#cb2-343"></a><span class="co"># | OPTIONALLY MODIFY SECTION|</span></span>
<span id="cb2-344"><a href="#cb2-344"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-345"><a href="#cb2-345"></a></span>
<span id="cb2-346"><a href="#cb2-346"></a><span class="co"># select eligible participants ----------------------------------------------</span></span>
<span id="cb2-347"><a href="#cb2-347"></a><span class="co"># only include participants who have exposure data at baseline</span></span>
<span id="cb2-348"><a href="#cb2-348"></a></span>
<span id="cb2-349"><a href="#cb2-349"></a><span class="co"># You might require tighter conditions </span></span>
<span id="cb2-350"><a href="#cb2-350"></a><span class="co"># for example, if you are interested in the effects of hours of childcare, </span></span>
<span id="cb2-351"><a href="#cb2-351"></a><span class="co"># you might want to select only those who were parents at baseline. </span></span>
<span id="cb2-352"><a href="#cb2-352"></a><span class="co"># talk to me if you think you might night tighter eligibility criteria.</span></span>
<span id="cb2-353"><a href="#cb2-353"></a></span>
<span id="cb2-354"><a href="#cb2-354"></a>ids_baseline <span class="ot">&lt;-</span> dat_prep <span class="sc">|&gt;</span> </span>
<span id="cb2-355"><a href="#cb2-355"></a>  <span class="co"># allow missing exposure at baseline</span></span>
<span id="cb2-356"><a href="#cb2-356"></a>  <span class="co"># this would give us greater confidence that we generalise to the target population</span></span>
<span id="cb2-357"><a href="#cb2-357"></a>  <span class="co"># filter(wave == baseline_wave) |&gt; </span></span>
<span id="cb2-358"><a href="#cb2-358"></a>  <span class="co"># option: do not allow missing exposure at baseline</span></span>
<span id="cb2-359"><a href="#cb2-359"></a>  <span class="co"># this gives us greater confidence that we recover a incident effect</span></span>
<span id="cb2-360"><a href="#cb2-360"></a>  <span class="fu">filter</span>(wave <span class="sc">==</span> baseline_wave, <span class="sc">!</span><span class="fu">is.na</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_exposure))) <span class="sc">|&gt;</span> </span>
<span id="cb2-361"><a href="#cb2-361"></a>  <span class="fu">pull</span>(id)</span>
<span id="cb2-362"><a href="#cb2-362"></a></span>
<span id="cb2-363"><a href="#cb2-363"></a><span class="co"># n eligible</span></span>
<span id="cb2-364"><a href="#cb2-364"></a>n_participants <span class="ot">&lt;-</span> <span class="fu">length</span>(ids_baseline)</span>
<span id="cb2-365"><a href="#cb2-365"></a></span>
<span id="cb2-366"><a href="#cb2-366"></a><span class="co"># make pretty number</span></span>
<span id="cb2-367"><a href="#cb2-367"></a>n_participants <span class="ot">=</span> margot<span class="sc">::</span><span class="fu">pretty_number</span>(n_participants)</span>
<span id="cb2-368"><a href="#cb2-368"></a></span>
<span id="cb2-369"><a href="#cb2-369"></a><span class="co"># save</span></span>
<span id="cb2-370"><a href="#cb2-370"></a><span class="fu">here_save</span>(n_participants, <span class="st">"n_participants"</span>)</span>
<span id="cb2-371"><a href="#cb2-371"></a></span>
<span id="cb2-372"><a href="#cb2-372"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"set eligibility criteria for baseline cohort ✔"</span>)</span>
<span id="cb2-373"><a href="#cb2-373"></a></span>
<span id="cb2-374"><a href="#cb2-374"></a></span>
<span id="cb2-375"><a href="#cb2-375"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-376"><a href="#cb2-376"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb2-377"><a href="#cb2-377"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-378"><a href="#cb2-378"></a></span>
<span id="cb2-379"><a href="#cb2-379"></a><span class="co"># EXAMPLE count different eligibility conditions ----------------------------------------------</span></span>
<span id="cb2-380"><a href="#cb2-380"></a></span>
<span id="cb2-381"><a href="#cb2-381"></a></span>
<span id="cb2-382"><a href="#cb2-382"></a><span class="co"># define eligibility criteria</span></span>
<span id="cb2-383"><a href="#cb2-383"></a>eligible_ids <span class="ot">&lt;-</span> df_nz_long <span class="sc">|&gt;</span> </span>
<span id="cb2-384"><a href="#cb2-384"></a>  <span class="fu">filter</span>(wave <span class="sc">==</span> <span class="dv">2018</span> <span class="sc">&amp;</span> year_measured <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> age <span class="sc">&lt;</span> <span class="dv">30</span> <span class="sc">&amp;</span> eth_cat <span class="sc">==</span> <span class="st">"pacific"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb2-385"><a href="#cb2-385"></a>  <span class="fu">distinct</span>(id) <span class="sc">|&gt;</span> </span>
<span id="cb2-386"><a href="#cb2-386"></a>  <span class="fu">pull</span>(id)</span>
<span id="cb2-387"><a href="#cb2-387"></a></span>
<span id="cb2-388"><a href="#cb2-388"></a><span class="co"># count eligible ids</span></span>
<span id="cb2-389"><a href="#cb2-389"></a><span class="fu">length</span>(eligible_ids)</span>
<span id="cb2-390"><a href="#cb2-390"></a></span>
<span id="cb2-391"><a href="#cb2-391"></a><span class="co"># filter data to include only eligible participants</span></span>
<span id="cb2-392"><a href="#cb2-392"></a>dat_long_different_eligibility <span class="ot">&lt;-</span> dat_prep <span class="sc">|&gt;</span> </span>
<span id="cb2-393"><a href="#cb2-393"></a>  <span class="fu">filter</span>(id <span class="sc">%in%</span> eligible_ids, wave <span class="sc">%in%</span> all_waves) <span class="sc">|&gt;</span> </span>
<span id="cb2-394"><a href="#cb2-394"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb2-395"><a href="#cb2-395"></a></span>
<span id="cb2-396"><a href="#cb2-396"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-397"><a href="#cb2-397"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb2-398"><a href="#cb2-398"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-399"><a href="#cb2-399"></a></span>
<span id="cb2-400"><a href="#cb2-400"></a><span class="co"># filter using general conditions -----------------------------------------</span></span>
<span id="cb2-401"><a href="#cb2-401"></a></span>
<span id="cb2-402"><a href="#cb2-402"></a></span>
<span id="cb2-403"><a href="#cb2-403"></a><span class="co"># filter data to include only eligible participants and relevant waves</span></span>
<span id="cb2-404"><a href="#cb2-404"></a>dat_long_1 <span class="ot">&lt;-</span> dat_prep <span class="sc">|&gt;</span> </span>
<span id="cb2-405"><a href="#cb2-405"></a>  <span class="fu">filter</span>(id <span class="sc">%in%</span> ids_baseline, wave <span class="sc">%in%</span> all_waves) <span class="sc">|&gt;</span> </span>
<span id="cb2-406"><a href="#cb2-406"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb2-407"><a href="#cb2-407"></a></span>
<span id="cb2-408"><a href="#cb2-408"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-409"><a href="#cb2-409"></a><span class="co"># |</span><span class="re">END</span><span class="co"> OPTIONALLY MODIFY SEC.|</span></span>
<span id="cb2-410"><a href="#cb2-410"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-411"><a href="#cb2-411"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-412"><a href="#cb2-412"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb2-413"><a href="#cb2-413"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-414"><a href="#cb2-414"></a></span>
<span id="cb2-415"><a href="#cb2-415"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-416"><a href="#cb2-416"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb2-417"><a href="#cb2-417"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-418"><a href="#cb2-418"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-419"><a href="#cb2-419"></a><span class="co"># |    MODIFY THIS SECTION   |</span></span>
<span id="cb2-420"><a href="#cb2-420"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-421"><a href="#cb2-421"></a><span class="co"># plot distribution to help with cutpoint decision</span></span>
<span id="cb2-422"><a href="#cb2-422"></a>dat_long_exposure <span class="ot">&lt;-</span> dat_long_1 <span class="sc">|&gt;</span> <span class="fu">filter</span>(wave <span class="sc">%in%</span> exposure_waves)</span>
<span id="cb2-423"><a href="#cb2-423"></a></span>
<span id="cb2-424"><a href="#cb2-424"></a></span>
<span id="cb2-425"><a href="#cb2-425"></a></span>
<span id="cb2-426"><a href="#cb2-426"></a><span class="co"># define cutpoints for graph ----------------------------------------------</span></span>
<span id="cb2-427"><a href="#cb2-427"></a></span>
<span id="cb2-428"><a href="#cb2-428"></a><span class="co"># define cutpoints *-- these can be adjusted --* </span></span>
<span id="cb2-429"><a href="#cb2-429"></a>cut_points <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>)</span>
<span id="cb2-430"><a href="#cb2-430"></a></span>
<span id="cb2-431"><a href="#cb2-431"></a><span class="co"># to use later in positivity graph in manuscript</span></span>
<span id="cb2-432"><a href="#cb2-432"></a>lower_cut <span class="ot">&lt;-</span> cut_points[[<span class="dv">1</span>]]</span>
<span id="cb2-433"><a href="#cb2-433"></a>upper_cut <span class="ot">&lt;-</span> cut_points[[<span class="dv">2</span>]]</span>
<span id="cb2-434"><a href="#cb2-434"></a>threshold <span class="ot">&lt;-</span> <span class="st">'&gt;'</span> <span class="co"># if upper</span></span>
<span id="cb2-435"><a href="#cb2-435"></a>inverse_threshold <span class="ot">&lt;-</span> <span class="st">'&lt;='</span></span>
<span id="cb2-436"><a href="#cb2-436"></a>scale_range <span class="ot">=</span> <span class="st">'scale range 1-7'</span></span>
<span id="cb2-437"><a href="#cb2-437"></a></span>
<span id="cb2-438"><a href="#cb2-438"></a></span>
<span id="cb2-439"><a href="#cb2-439"></a><span class="co"># save for manuscript</span></span>
<span id="cb2-440"><a href="#cb2-440"></a><span class="fu">here_save</span>(lower_cut, <span class="st">"lower_cut"</span>)</span>
<span id="cb2-441"><a href="#cb2-441"></a><span class="fu">here_save</span>(upper_cut, <span class="st">"upper_cut"</span>)</span>
<span id="cb2-442"><a href="#cb2-442"></a><span class="fu">here_save</span>(threshold, <span class="st">"threshold"</span>)</span>
<span id="cb2-443"><a href="#cb2-443"></a><span class="fu">here_save</span>(inverse_threshold, <span class="st">"inverse_threshold"</span>)</span>
<span id="cb2-444"><a href="#cb2-444"></a><span class="fu">here_save</span>(scale_range, <span class="st">"scale_range"</span>)</span>
<span id="cb2-445"><a href="#cb2-445"></a></span>
<span id="cb2-446"><a href="#cb2-446"></a></span>
<span id="cb2-447"><a href="#cb2-447"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"set thresholds for binary variable (if variable is continuous) ✔"</span>)</span>
<span id="cb2-448"><a href="#cb2-448"></a></span>
<span id="cb2-449"><a href="#cb2-449"></a></span>
<span id="cb2-450"><a href="#cb2-450"></a><span class="co"># make graph</span></span>
<span id="cb2-451"><a href="#cb2-451"></a>graph_cut <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_plot_categorical</span>(</span>
<span id="cb2-452"><a href="#cb2-452"></a>  dat_long_exposure,</span>
<span id="cb2-453"><a href="#cb2-453"></a>  <span class="at">col_name         =</span> name_exposure,</span>
<span id="cb2-454"><a href="#cb2-454"></a>  <span class="at">sd_multipliers =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>), <span class="co"># select to suit</span></span>
<span id="cb2-455"><a href="#cb2-455"></a>  <span class="co"># either use n_divisions for equal-sized groups:</span></span>
<span id="cb2-456"><a href="#cb2-456"></a>  <span class="co"># n_divisions      = 2,</span></span>
<span id="cb2-457"><a href="#cb2-457"></a>  <span class="co"># or use custom_breaks for specific values:</span></span>
<span id="cb2-458"><a href="#cb2-458"></a>  <span class="at">custom_breaks    =</span> cut_points,  <span class="co"># ** adjust as needed **</span></span>
<span id="cb2-459"><a href="#cb2-459"></a>  <span class="co"># could be "lower", no difference in this case, as no one == 4</span></span>
<span id="cb2-460"><a href="#cb2-460"></a>  <span class="at">cutpoint_inclusive =</span> <span class="st">"upper"</span>,</span>
<span id="cb2-461"><a href="#cb2-461"></a>  <span class="at">show_mean        =</span> <span class="cn">TRUE</span>,</span>
<span id="cb2-462"><a href="#cb2-462"></a>  <span class="at">show_median      =</span> <span class="cn">FALSE</span>,</span>
<span id="cb2-463"><a href="#cb2-463"></a>  <span class="at">show_sd          =</span> <span class="cn">TRUE</span></span>
<span id="cb2-464"><a href="#cb2-464"></a>)</span>
<span id="cb2-465"><a href="#cb2-465"></a><span class="fu">print</span>(graph_cut)</span>
<span id="cb2-466"><a href="#cb2-466"></a></span>
<span id="cb2-467"><a href="#cb2-467"></a><span class="co"># save your graph</span></span>
<span id="cb2-468"><a href="#cb2-468"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(graph_cut, <span class="st">"graph_cut"</span>, push_mods)</span>
<span id="cb2-469"><a href="#cb2-469"></a></span>
<span id="cb2-470"><a href="#cb2-470"></a><span class="co"># create binary exposure variable based on chosen cutpoint</span></span>
<span id="cb2-471"><a href="#cb2-471"></a>dat_long_2 <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">create_ordered_variable</span>(</span>
<span id="cb2-472"><a href="#cb2-472"></a>  dat_long_1,</span>
<span id="cb2-473"><a href="#cb2-473"></a>  <span class="at">var_name           =</span> name_exposure,</span>
<span id="cb2-474"><a href="#cb2-474"></a>  <span class="at">custom_breaks      =</span> cut_points,  <span class="co"># ** -- adjust based on your decision above -- **</span></span>
<span id="cb2-475"><a href="#cb2-475"></a>  <span class="at">cutpoint_inclusive =</span> <span class="st">"upper"</span></span>
<span id="cb2-476"><a href="#cb2-476"></a>)</span>
<span id="cb2-477"><a href="#cb2-477"></a></span>
<span id="cb2-478"><a href="#cb2-478"></a></span>
<span id="cb2-479"><a href="#cb2-479"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"created binary variable (if variable is continuous) ✔"</span>)</span>
<span id="cb2-480"><a href="#cb2-480"></a></span>
<span id="cb2-481"><a href="#cb2-481"></a></span>
<span id="cb2-482"><a href="#cb2-482"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-483"><a href="#cb2-483"></a><span class="co"># |   </span><span class="re">END</span><span class="co"> MODIFY SECTION     |</span></span>
<span id="cb2-484"><a href="#cb2-484"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-485"><a href="#cb2-485"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-486"><a href="#cb2-486"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb2-487"><a href="#cb2-487"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-488"><a href="#cb2-488"></a></span>
<span id="cb2-489"><a href="#cb2-489"></a></span>
<span id="cb2-490"><a href="#cb2-490"></a></span>
<span id="cb2-491"><a href="#cb2-491"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-492"><a href="#cb2-492"></a><span class="co"># |       DO NOT ALTER       |</span></span>
<span id="cb2-493"><a href="#cb2-493"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-494"><a href="#cb2-494"></a></span>
<span id="cb2-495"><a href="#cb2-495"></a><span class="co"># process binary variables and log-transform --------------------------------</span></span>
<span id="cb2-496"><a href="#cb2-496"></a><span class="co"># convert binary factors to 0/1 format</span></span>
<span id="cb2-497"><a href="#cb2-497"></a>dat_long_3 <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_process_binary_vars</span>(dat_long_2)</span>
<span id="cb2-498"><a href="#cb2-498"></a></span>
<span id="cb2-499"><a href="#cb2-499"></a><span class="co"># log-transform hours and income variables: tables for analysis (only logged versions of vars)</span></span>
<span id="cb2-500"><a href="#cb2-500"></a>dat_long_final <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_log_transform_vars</span>(</span>
<span id="cb2-501"><a href="#cb2-501"></a>  dat_long_3,</span>
<span id="cb2-502"><a href="#cb2-502"></a>  <span class="at">vars            =</span> <span class="fu">c</span>(<span class="fu">starts_with</span>(<span class="st">"hours_"</span>), <span class="st">"household_inc"</span>), <span class="co"># **--- think about this ---***</span></span>
<span id="cb2-503"><a href="#cb2-503"></a>  <span class="at">prefix          =</span> <span class="st">"log_"</span>,</span>
<span id="cb2-504"><a href="#cb2-504"></a>  <span class="at">keep_original   =</span> <span class="cn">FALSE</span>,</span>
<span id="cb2-505"><a href="#cb2-505"></a>  <span class="at">exceptions =</span> exposure_var <span class="co"># omit original variables#  **--- think about this ---***</span></span>
<span id="cb2-506"><a href="#cb2-506"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb2-507"><a href="#cb2-507"></a>  <span class="co"># select only variables needed for analysis</span></span>
<span id="cb2-508"><a href="#cb2-508"></a>  <span class="fu">select</span>(<span class="fu">all_of</span>(<span class="fu">c</span>(baseline_vars, exposure_var, outcome_vars, <span class="st">"id"</span>, <span class="st">"wave"</span>, <span class="st">"year_measured"</span>, <span class="st">"sample_weights"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb2-509"><a href="#cb2-509"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb2-510"><a href="#cb2-510"></a></span>
<span id="cb2-511"><a href="#cb2-511"></a></span>
<span id="cb2-512"><a href="#cb2-512"></a></span>
<span id="cb2-513"><a href="#cb2-513"></a><span class="co"># check missing data --------------------------------------------------------</span></span>
<span id="cb2-514"><a href="#cb2-514"></a><span class="co"># this is crucial to understand potential biases</span></span>
<span id="cb2-515"><a href="#cb2-515"></a>missing_summary <span class="ot">&lt;-</span> naniar<span class="sc">::</span><span class="fu">miss_var_summary</span>(dat_long_final)</span>
<span id="cb2-516"><a href="#cb2-516"></a><span class="fu">print</span>(missing_summary)</span>
<span id="cb2-517"><a href="#cb2-517"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(missing_summary, <span class="st">"missing_summary"</span>, push_mods)</span>
<span id="cb2-518"><a href="#cb2-518"></a></span>
<span id="cb2-519"><a href="#cb2-519"></a></span>
<span id="cb2-520"><a href="#cb2-520"></a></span>
<span id="cb2-521"><a href="#cb2-521"></a><span class="co"># visualise missing data pattern</span></span>
<span id="cb2-522"><a href="#cb2-522"></a><span class="co"># ** -- takes a while to render ** </span></span>
<span id="cb2-523"><a href="#cb2-523"></a>vis_miss <span class="ot">&lt;-</span> naniar<span class="sc">::</span><span class="fu">vis_miss</span>(dat_long_final, <span class="at">warn_large_data =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-524"><a href="#cb2-524"></a><span class="fu">print</span>(vis_miss)</span>
<span id="cb2-525"><a href="#cb2-525"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(vis_miss, <span class="st">"vis_miss"</span>, push_mods)</span>
<span id="cb2-526"><a href="#cb2-526"></a></span>
<span id="cb2-527"><a href="#cb2-527"></a><span class="co"># calculate percentage of missing data at baseline</span></span>
<span id="cb2-528"><a href="#cb2-528"></a>dat_baseline_pct <span class="ot">&lt;-</span> dat_long_final <span class="sc">|&gt;</span> <span class="fu">filter</span>(wave <span class="sc">==</span> baseline_wave)</span>
<span id="cb2-529"><a href="#cb2-529"></a>percent_missing_baseline <span class="ot">&lt;-</span> naniar<span class="sc">::</span><span class="fu">pct_miss</span>(dat_baseline_pct)</span>
<span id="cb2-530"><a href="#cb2-530"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(percent_missing_baseline, <span class="st">"percent_missing_baseline"</span>, push_mods)</span>
<span id="cb2-531"><a href="#cb2-531"></a></span>
<span id="cb2-532"><a href="#cb2-532"></a><span class="co"># save prepared dataset for next stage --------------------------------------</span></span>
<span id="cb2-533"><a href="#cb2-533"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(dat_long_final, <span class="st">"dat_long_final"</span>, push_mods)</span>
<span id="cb2-534"><a href="#cb2-534"></a></span>
<span id="cb2-535"><a href="#cb2-535"></a></span>
<span id="cb2-536"><a href="#cb2-536"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"made and saved final long data set for further processign in script 02 ✔"</span>)</span>
<span id="cb2-537"><a href="#cb2-537"></a></span>
<span id="cb2-538"><a href="#cb2-538"></a></span>
<span id="cb2-539"><a href="#cb2-539"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-540"><a href="#cb2-540"></a><span class="co"># |     </span><span class="re">END</span><span class="co"> DO NOT ALTER     |</span></span>
<span id="cb2-541"><a href="#cb2-541"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-542"><a href="#cb2-542"></a></span>
<span id="cb2-543"><a href="#cb2-543"></a></span>
<span id="cb2-544"><a href="#cb2-544"></a><span class="co"># check positivity --------------------------------------------------------</span></span>
<span id="cb2-545"><a href="#cb2-545"></a></span>
<span id="cb2-546"><a href="#cb2-546"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-547"><a href="#cb2-547"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb2-548"><a href="#cb2-548"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-549"><a href="#cb2-549"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-550"><a href="#cb2-550"></a><span class="co"># |    MODIFY THIS SECTION   |</span></span>
<span id="cb2-551"><a href="#cb2-551"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-552"><a href="#cb2-552"></a></span>
<span id="cb2-553"><a href="#cb2-553"></a></span>
<span id="cb2-554"><a href="#cb2-554"></a><span class="co"># check</span></span>
<span id="cb2-555"><a href="#cb2-555"></a>threshold <span class="co"># defined above</span></span>
<span id="cb2-556"><a href="#cb2-556"></a>upper_cut <span class="co"># defined above</span></span>
<span id="cb2-557"><a href="#cb2-557"></a>name_exposure <span class="co"># defined above</span></span>
<span id="cb2-558"><a href="#cb2-558"></a></span>
<span id="cb2-559"><a href="#cb2-559"></a></span>
<span id="cb2-560"><a href="#cb2-560"></a><span class="co"># create transition matrices to check positivity ----------------------------</span></span>
<span id="cb2-561"><a href="#cb2-561"></a><span class="co"># this helps assess whether there are sufficient observations in all exposure states</span></span>
<span id="cb2-562"><a href="#cb2-562"></a>dt_positivity <span class="ot">&lt;-</span> dat_long_final <span class="sc">|&gt;</span></span>
<span id="cb2-563"><a href="#cb2-563"></a>  <span class="fu">filter</span>(wave <span class="sc">%in%</span> <span class="fu">c</span>(baseline_wave, exposure_waves)) <span class="sc">|&gt;</span></span>
<span id="cb2-564"><a href="#cb2-564"></a>  <span class="fu">select</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_exposure), id, wave) <span class="sc">|&gt;</span></span>
<span id="cb2-565"><a href="#cb2-565"></a>  <span class="fu">mutate</span>(<span class="at">exposure =</span> <span class="fu">round</span>(<span class="fu">as.numeric</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_exposure)), <span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb2-566"><a href="#cb2-566"></a>  <span class="co"># create binary exposure based on cutpoint</span></span>
<span id="cb2-567"><a href="#cb2-567"></a>  <span class="fu">mutate</span>(<span class="at">exposure_binary =</span> <span class="fu">ifelse</span>(exposure <span class="sc">&gt;</span> upper_cut, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">|&gt;</span> <span class="co"># check</span></span>
<span id="cb2-568"><a href="#cb2-568"></a>  <span class="do">## *-- modify this --* </span></span>
<span id="cb2-569"><a href="#cb2-569"></a>  <span class="fu">mutate</span>(<span class="at">wave =</span> <span class="fu">as.numeric</span>(wave) <span class="sc">-</span><span class="dv">1</span> )</span>
<span id="cb2-570"><a href="#cb2-570"></a></span>
<span id="cb2-571"><a href="#cb2-571"></a><span class="co"># create transition tables</span></span>
<span id="cb2-572"><a href="#cb2-572"></a>transition_tables <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_transition_table</span>(</span>
<span id="cb2-573"><a href="#cb2-573"></a>  dt_positivity,</span>
<span id="cb2-574"><a href="#cb2-574"></a>  <span class="at">state_var =</span> <span class="st">"exposure"</span>,</span>
<span id="cb2-575"><a href="#cb2-575"></a>  <span class="at">id_var =</span> <span class="st">"id"</span>,</span>
<span id="cb2-576"><a href="#cb2-576"></a>  <span class="at">waves =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb2-577"><a href="#cb2-577"></a>  <span class="at">wave_var =</span> <span class="st">"wave"</span>,</span>
<span id="cb2-578"><a href="#cb2-578"></a>  <span class="at">table_name =</span> <span class="st">"transition_table"</span></span>
<span id="cb2-579"><a href="#cb2-579"></a>)</span>
<span id="cb2-580"><a href="#cb2-580"></a></span>
<span id="cb2-581"><a href="#cb2-581"></a><span class="co"># check</span></span>
<span id="cb2-582"><a href="#cb2-582"></a><span class="fu">print</span>(transition_tables<span class="sc">$</span>tables[[<span class="dv">1</span>]])</span>
<span id="cb2-583"><a href="#cb2-583"></a></span>
<span id="cb2-584"><a href="#cb2-584"></a><span class="co"># save</span></span>
<span id="cb2-585"><a href="#cb2-585"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(transition_tables, <span class="st">"transition_tables"</span>, push_mods)</span>
<span id="cb2-586"><a href="#cb2-586"></a></span>
<span id="cb2-587"><a href="#cb2-587"></a><span class="co"># create binary transition tables</span></span>
<span id="cb2-588"><a href="#cb2-588"></a>transition_tables_binary <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_transition_table</span>(</span>
<span id="cb2-589"><a href="#cb2-589"></a>  dt_positivity,</span>
<span id="cb2-590"><a href="#cb2-590"></a>  <span class="at">state_var =</span> <span class="st">"exposure_binary"</span>,</span>
<span id="cb2-591"><a href="#cb2-591"></a>  <span class="at">id_var =</span> <span class="st">"id"</span>,</span>
<span id="cb2-592"><a href="#cb2-592"></a>  <span class="at">waves =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb2-593"><a href="#cb2-593"></a>  <span class="at">wave_var =</span> <span class="st">"wave"</span>,</span>
<span id="cb2-594"><a href="#cb2-594"></a>  <span class="at">table_name =</span> <span class="st">"transition_table_binary"</span></span>
<span id="cb2-595"><a href="#cb2-595"></a>)</span>
<span id="cb2-596"><a href="#cb2-596"></a></span>
<span id="cb2-597"><a href="#cb2-597"></a><span class="co"># check</span></span>
<span id="cb2-598"><a href="#cb2-598"></a><span class="fu">print</span>(transition_tables_binary<span class="sc">$</span>tables[[<span class="dv">1</span>]])</span>
<span id="cb2-599"><a href="#cb2-599"></a></span>
<span id="cb2-600"><a href="#cb2-600"></a><span class="co"># save</span></span>
<span id="cb2-601"><a href="#cb2-601"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(transition_tables_binary, <span class="st">"transition_tables_binary"</span>, push_mods)</span>
<span id="cb2-602"><a href="#cb2-602"></a></span>
<span id="cb2-603"><a href="#cb2-603"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-604"><a href="#cb2-604"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb2-605"><a href="#cb2-605"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-606"><a href="#cb2-606"></a></span>
<span id="cb2-607"><a href="#cb2-607"></a><span class="co"># create tables -----------------------------------------------------------</span></span>
<span id="cb2-608"><a href="#cb2-608"></a><span class="co"># baseline variable labels</span></span>
<span id="cb2-609"><a href="#cb2-609"></a>var_labels_baseline <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb2-610"><a href="#cb2-610"></a>  <span class="co"># demographics</span></span>
<span id="cb2-611"><a href="#cb2-611"></a>  <span class="st">"age"</span> <span class="ot">=</span> <span class="st">"Age"</span>,</span>
<span id="cb2-612"><a href="#cb2-612"></a>  <span class="st">"born_nz_binary"</span> <span class="ot">=</span> <span class="st">"Born in NZ"</span>,</span>
<span id="cb2-613"><a href="#cb2-613"></a>  <span class="st">"education_level_coarsen"</span> <span class="ot">=</span> <span class="st">"Education Level"</span>,</span>
<span id="cb2-614"><a href="#cb2-614"></a>  <span class="st">"employed_binary"</span> <span class="ot">=</span> <span class="st">"Employed"</span>,</span>
<span id="cb2-615"><a href="#cb2-615"></a>  <span class="st">"eth_cat"</span> <span class="ot">=</span> <span class="st">"Ethnicity"</span>,</span>
<span id="cb2-616"><a href="#cb2-616"></a>  <span class="st">"male_binary"</span> <span class="ot">=</span> <span class="st">"Male"</span>,</span>
<span id="cb2-617"><a href="#cb2-617"></a>  <span class="st">"not_heterosexual_binary"</span> <span class="ot">=</span> <span class="st">"Non-heterosexual"</span>,</span>
<span id="cb2-618"><a href="#cb2-618"></a>  <span class="st">"parent_binary"</span> <span class="ot">=</span> <span class="st">"Parent"</span>,</span>
<span id="cb2-619"><a href="#cb2-619"></a>  <span class="st">"partner_binary"</span> <span class="ot">=</span> <span class="st">"Has Partner"</span>,</span>
<span id="cb2-620"><a href="#cb2-620"></a>  <span class="st">"rural_gch_2018_l"</span> <span class="ot">=</span> <span class="st">"Rural Classification"</span>,</span>
<span id="cb2-621"><a href="#cb2-621"></a>  <span class="st">"sample_frame_opt_in_binary"</span> <span class="ot">=</span> <span class="st">"Sample Frame Opt-In"</span>,</span>
<span id="cb2-622"><a href="#cb2-622"></a>  </span>
<span id="cb2-623"><a href="#cb2-623"></a>  <span class="co"># economic &amp; social status</span></span>
<span id="cb2-624"><a href="#cb2-624"></a>  <span class="st">"household_inc"</span> <span class="ot">=</span> <span class="st">"Household Income"</span>,</span>
<span id="cb2-625"><a href="#cb2-625"></a>  <span class="st">"log_household_inc"</span> <span class="ot">=</span> <span class="st">"Log Household Income"</span>,</span>
<span id="cb2-626"><a href="#cb2-626"></a>  <span class="st">"nz_dep2018"</span> <span class="ot">=</span> <span class="st">"NZ Deprivation Index"</span>,</span>
<span id="cb2-627"><a href="#cb2-627"></a>  <span class="st">"nzsei_13_l"</span> <span class="ot">=</span> <span class="st">"Occupational Prestige Index"</span>,</span>
<span id="cb2-628"><a href="#cb2-628"></a>  <span class="st">"household_inc"</span> <span class="ot">=</span> <span class="st">"Household Income"</span>,</span>
<span id="cb2-629"><a href="#cb2-629"></a></span>
<span id="cb2-630"><a href="#cb2-630"></a>  </span>
<span id="cb2-631"><a href="#cb2-631"></a>  <span class="co"># personality traits</span></span>
<span id="cb2-632"><a href="#cb2-632"></a>  <span class="st">"agreeableness"</span> <span class="ot">=</span> <span class="st">"Agreeableness"</span>,</span>
<span id="cb2-633"><a href="#cb2-633"></a>  <span class="st">"conscientiousness"</span> <span class="ot">=</span> <span class="st">"Conscientiousness"</span>,</span>
<span id="cb2-634"><a href="#cb2-634"></a>  <span class="st">"neuroticism"</span> <span class="ot">=</span> <span class="st">"Neuroticism"</span>,</span>
<span id="cb2-635"><a href="#cb2-635"></a>  <span class="st">"openness"</span> <span class="ot">=</span> <span class="st">"Openness"</span>,</span>
<span id="cb2-636"><a href="#cb2-636"></a>  </span>
<span id="cb2-637"><a href="#cb2-637"></a>  <span class="co"># beliefs &amp; attitudes</span></span>
<span id="cb2-638"><a href="#cb2-638"></a>  <span class="st">"political_conservative"</span> <span class="ot">=</span> <span class="st">"Political Conservatism"</span>,</span>
<span id="cb2-639"><a href="#cb2-639"></a>  <span class="st">"religion_identification_level"</span> <span class="ot">=</span> <span class="st">"Religious Identification"</span>,</span>
<span id="cb2-640"><a href="#cb2-640"></a>  </span>
<span id="cb2-641"><a href="#cb2-641"></a>  <span class="co"># health behaviors</span></span>
<span id="cb2-642"><a href="#cb2-642"></a>  <span class="st">"alcohol_frequency"</span> <span class="ot">=</span> <span class="st">"Alcohol Frequency"</span>,</span>
<span id="cb2-643"><a href="#cb2-643"></a>  <span class="st">"alcohol_intensity"</span> <span class="ot">=</span> <span class="st">"Alcohol Intensity"</span>,</span>
<span id="cb2-644"><a href="#cb2-644"></a>  <span class="st">"hlth_disability_binary"</span> <span class="ot">=</span> <span class="st">"Disability Status"</span>,</span>
<span id="cb2-645"><a href="#cb2-645"></a>  <span class="st">"smoker_binary"</span> <span class="ot">=</span> <span class="st">"Smoker"</span>,</span>
<span id="cb2-646"><a href="#cb2-646"></a>  <span class="st">"hours_exercise"</span> <span class="ot">=</span> <span class="st">"Hours of Exercise"</span>,</span>
<span id="cb2-647"><a href="#cb2-647"></a>  </span>
<span id="cb2-648"><a href="#cb2-648"></a>  </span>
<span id="cb2-649"><a href="#cb2-649"></a>  <span class="co"># time use</span></span>
<span id="cb2-650"><a href="#cb2-650"></a>  <span class="st">"hours_children"</span> <span class="ot">=</span> <span class="st">"Hours with Children"</span>,</span>
<span id="cb2-651"><a href="#cb2-651"></a>  <span class="st">"hours_commute"</span> <span class="ot">=</span> <span class="st">"Hours Commuting"</span>,</span>
<span id="cb2-652"><a href="#cb2-652"></a>  <span class="st">"hours_exercise"</span> <span class="ot">=</span> <span class="st">"Hours Exercising"</span>,</span>
<span id="cb2-653"><a href="#cb2-653"></a>  <span class="st">"hours_housework"</span> <span class="ot">=</span> <span class="st">"Hours on Housework"</span>,</span>
<span id="cb2-654"><a href="#cb2-654"></a>  <span class="st">"log_hours_children"</span> <span class="ot">=</span> <span class="st">"Log Hours with Children"</span>,</span>
<span id="cb2-655"><a href="#cb2-655"></a>  <span class="st">"log_hours_commute"</span> <span class="ot">=</span> <span class="st">"Log Hours Commuting"</span>,</span>
<span id="cb2-656"><a href="#cb2-656"></a>  <span class="st">"log_hours_exercise"</span> <span class="ot">=</span> <span class="st">"Log Hours Exercising"</span>,</span>
<span id="cb2-657"><a href="#cb2-657"></a>  <span class="st">"log_hours_housework"</span> <span class="ot">=</span> <span class="st">"Log Hours on Housework"</span>,</span>
<span id="cb2-658"><a href="#cb2-658"></a>  </span>
<span id="cb2-659"><a href="#cb2-659"></a></span>
<span id="cb2-660"><a href="#cb2-660"></a>  <span class="co"># Added (Optional)</span></span>
<span id="cb2-661"><a href="#cb2-661"></a>  <span class="st">"religion_bigger_denominations"</span> <span class="ot">=</span> <span class="st">"Major Religions"</span></span>
<span id="cb2-662"><a href="#cb2-662"></a>)</span>
<span id="cb2-663"><a href="#cb2-663"></a><span class="fu">here_save</span>(var_labels_baseline, <span class="st">"var_labels_baseline"</span>)</span>
<span id="cb2-664"><a href="#cb2-664"></a></span>
<span id="cb2-665"><a href="#cb2-665"></a><span class="co"># outcome variable labels, organized by domain</span></span>
<span id="cb2-666"><a href="#cb2-666"></a><span class="co"># reivew your outcomes make sure they appear on the list below</span></span>
<span id="cb2-667"><a href="#cb2-667"></a><span class="co"># comment out what you do not need</span></span>
<span id="cb2-668"><a href="#cb2-668"></a>outcome_vars</span>
<span id="cb2-669"><a href="#cb2-669"></a>df_nz_long<span class="sc">$</span>religion_bigger_denominations</span>
<span id="cb2-670"><a href="#cb2-670"></a><span class="co"># get names</span></span>
<span id="cb2-671"><a href="#cb2-671"></a>var_labels_outcomes <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb2-672"><a href="#cb2-672"></a>  <span class="co"># "alcohol_frequency_weekly" = "Alcohol Frequency (weekly)",</span></span>
<span id="cb2-673"><a href="#cb2-673"></a>  <span class="co"># "alcohol_intensity" = "Alcohol Intensity",</span></span>
<span id="cb2-674"><a href="#cb2-674"></a>  <span class="co"># "hlth_bmi" = "Body Mass Index",</span></span>
<span id="cb2-675"><a href="#cb2-675"></a>  <span class="co"># "hlth_sleep_hours" = "Sleep",</span></span>
<span id="cb2-676"><a href="#cb2-676"></a>  <span class="st">"log_hours_exercise"</span> <span class="ot">=</span> <span class="st">"Hours of Exercise (log)"</span>,</span>
<span id="cb2-677"><a href="#cb2-677"></a> <span class="co"># "short_form_health" = "Short Form Health",</span></span>
<span id="cb2-678"><a href="#cb2-678"></a>  <span class="st">"hlth_fatigue"</span> <span class="ot">=</span> <span class="st">"Fatigue"</span>,</span>
<span id="cb2-679"><a href="#cb2-679"></a>  <span class="st">"kessler_latent_anxiety"</span> <span class="ot">=</span> <span class="st">"Anxiety"</span>,</span>
<span id="cb2-680"><a href="#cb2-680"></a>  <span class="st">"kessler_latent_depression"</span> <span class="ot">=</span> <span class="st">"Depression"</span>,</span>
<span id="cb2-681"><a href="#cb2-681"></a> <span class="co"># "rumination" = "Rumination",</span></span>
<span id="cb2-682"><a href="#cb2-682"></a>  <span class="st">"bodysat"</span> <span class="ot">=</span> <span class="st">"Body Satisfaction"</span>,</span>
<span id="cb2-683"><a href="#cb2-683"></a> <span class="co"># "forgiveness" = "Forgiveness",</span></span>
<span id="cb2-684"><a href="#cb2-684"></a> <span class="co"># "perfectionism" = "Perfectionism",</span></span>
<span id="cb2-685"><a href="#cb2-685"></a> <span class="co"># "self_control" = "Self Control",</span></span>
<span id="cb2-686"><a href="#cb2-686"></a>  <span class="st">"self_esteem"</span> <span class="ot">=</span> <span class="st">"Self Esteem"</span>,</span>
<span id="cb2-687"><a href="#cb2-687"></a>  <span class="st">"sexual_satisfaction"</span> <span class="ot">=</span> <span class="st">"Sexual Satisfaction"</span>,</span>
<span id="cb2-688"><a href="#cb2-688"></a> <span class="co"># "gratitude" = "Gratitude",</span></span>
<span id="cb2-689"><a href="#cb2-689"></a>  <span class="st">"lifesat"</span> <span class="ot">=</span> <span class="st">"Life Satisfaction"</span>,</span>
<span id="cb2-690"><a href="#cb2-690"></a>  <span class="st">"meaning_purpose"</span> <span class="ot">=</span> <span class="st">"Meaning: Purpose"</span>,</span>
<span id="cb2-691"><a href="#cb2-691"></a>  <span class="st">"meaning_sense"</span> <span class="ot">=</span> <span class="st">"Meaning: Sense"</span>,</span>
<span id="cb2-692"><a href="#cb2-692"></a>  <span class="st">"pwi"</span> <span class="ot">=</span> <span class="st">"Personal Well-being Index"</span>,</span>
<span id="cb2-693"><a href="#cb2-693"></a>  <span class="st">"belong"</span> <span class="ot">=</span> <span class="st">"Social Belonging"</span>,</span>
<span id="cb2-694"><a href="#cb2-694"></a>  <span class="st">"neighbourhood_community"</span> <span class="ot">=</span> <span class="st">"Neighbourhood Community"</span>,</span>
<span id="cb2-695"><a href="#cb2-695"></a>  <span class="st">"support"</span> <span class="ot">=</span> <span class="st">"Social Support"</span></span>
<span id="cb2-696"><a href="#cb2-696"></a>)</span>
<span id="cb2-697"><a href="#cb2-697"></a></span>
<span id="cb2-698"><a href="#cb2-698"></a><span class="co"># save for manuscript</span></span>
<span id="cb2-699"><a href="#cb2-699"></a><span class="fu">here_save</span>(var_labels_outcomes, <span class="st">"var_labels_outcomes"</span>)</span>
<span id="cb2-700"><a href="#cb2-700"></a></span>
<span id="cb2-701"><a href="#cb2-701"></a></span>
<span id="cb2-702"><a href="#cb2-702"></a></span>
<span id="cb2-703"><a href="#cb2-703"></a></span>
<span id="cb2-704"><a href="#cb2-704"></a><span class="co"># save all variable translations</span></span>
<span id="cb2-705"><a href="#cb2-705"></a>var_labels_measures <span class="ot">&lt;-</span> <span class="fu">c</span>(var_labels_baseline, var_labels_exposure, var_labels_outcomes)</span>
<span id="cb2-706"><a href="#cb2-706"></a>var_labels_measures</span>
<span id="cb2-707"><a href="#cb2-707"></a></span>
<span id="cb2-708"><a href="#cb2-708"></a><span class="co"># save for manuscript</span></span>
<span id="cb2-709"><a href="#cb2-709"></a><span class="fu">here_save</span>(var_labels_measures, <span class="st">"var_labels_measures"</span>)</span>
<span id="cb2-710"><a href="#cb2-710"></a></span>
<span id="cb2-711"><a href="#cb2-711"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-712"><a href="#cb2-712"></a><span class="co"># |   </span><span class="re">END</span><span class="co"> MODIFY SECTION     |</span></span>
<span id="cb2-713"><a href="#cb2-713"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-714"><a href="#cb2-714"></a></span>
<span id="cb2-715"><a href="#cb2-715"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-716"><a href="#cb2-716"></a><span class="co"># |       DO NOT ALTER       |</span></span>
<span id="cb2-717"><a href="#cb2-717"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-718"><a href="#cb2-718"></a><span class="co"># tables ------------------------------------------------------------------</span></span>
<span id="cb2-719"><a href="#cb2-719"></a><span class="co"># create baseline characteristics table</span></span>
<span id="cb2-720"><a href="#cb2-720"></a>dat_baseline <span class="ot">=</span> dat_long_final <span class="sc">|&gt;</span></span>
<span id="cb2-721"><a href="#cb2-721"></a>  <span class="fu">filter</span>(wave <span class="sc">%in%</span> <span class="fu">c</span>(baseline_wave)) <span class="sc">|&gt;</span></span>
<span id="cb2-722"><a href="#cb2-722"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-723"><a href="#cb2-723"></a>    <span class="at">male_binary =</span> <span class="fu">factor</span>(male_binary),</span>
<span id="cb2-724"><a href="#cb2-724"></a>    <span class="at">parent_binary =</span> <span class="fu">factor</span>(parent_binary),</span>
<span id="cb2-725"><a href="#cb2-725"></a>    <span class="at">smoker_binary =</span> <span class="fu">factor</span>(smoker_binary),</span>
<span id="cb2-726"><a href="#cb2-726"></a>    <span class="at">born_nz_binary =</span> <span class="fu">factor</span>(born_nz_binary),</span>
<span id="cb2-727"><a href="#cb2-727"></a>    <span class="at">employed_binary =</span> <span class="fu">factor</span>(employed_binary),</span>
<span id="cb2-728"><a href="#cb2-728"></a>    <span class="at">not_heterosexual_binary =</span> <span class="fu">factor</span>(not_heterosexual_binary),</span>
<span id="cb2-729"><a href="#cb2-729"></a>    <span class="at">sample_frame_opt_in_binary =</span> <span class="fu">factor</span>(sample_frame_opt_in_binary)</span>
<span id="cb2-730"><a href="#cb2-730"></a>  )</span>
<span id="cb2-731"><a href="#cb2-731"></a></span>
<span id="cb2-732"><a href="#cb2-732"></a></span>
<span id="cb2-733"><a href="#cb2-733"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-734"><a href="#cb2-734"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb2-735"><a href="#cb2-735"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-736"><a href="#cb2-736"></a></span>
<span id="cb2-737"><a href="#cb2-737"></a><span class="co"># save sample weights from baseline wave</span></span>
<span id="cb2-738"><a href="#cb2-738"></a><span class="co"># save sample weights</span></span>
<span id="cb2-739"><a href="#cb2-739"></a>t0_sample_weights <span class="ot">&lt;-</span> dat_baseline<span class="sc">$</span>sample_weights</span>
<span id="cb2-740"><a href="#cb2-740"></a><span class="fu">here_save</span>(t0_sample_weights, <span class="st">"t0_sample_weights"</span>)</span>
<span id="cb2-741"><a href="#cb2-741"></a></span>
<span id="cb2-742"><a href="#cb2-742"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-743"><a href="#cb2-743"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb2-744"><a href="#cb2-744"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-745"><a href="#cb2-745"></a></span>
<span id="cb2-746"><a href="#cb2-746"></a></span>
<span id="cb2-747"><a href="#cb2-747"></a><span class="co"># make baseline table -----------------------------------------------------</span></span>
<span id="cb2-748"><a href="#cb2-748"></a></span>
<span id="cb2-749"><a href="#cb2-749"></a>baseline_table <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_make_tables</span>(</span>
<span id="cb2-750"><a href="#cb2-750"></a>  <span class="at">data =</span> dat_baseline,</span>
<span id="cb2-751"><a href="#cb2-751"></a>  <span class="at">vars =</span> baseline_vars,</span>
<span id="cb2-752"><a href="#cb2-752"></a>  <span class="at">by =</span> <span class="st">"wave"</span>,</span>
<span id="cb2-753"><a href="#cb2-753"></a>  <span class="at">labels =</span> var_labels_baseline,</span>
<span id="cb2-754"><a href="#cb2-754"></a>  <span class="at">table1_opts =</span> <span class="fu">list</span>(<span class="at">overall =</span> <span class="cn">FALSE</span>, <span class="at">transpose =</span> <span class="cn">FALSE</span>),</span>
<span id="cb2-755"><a href="#cb2-755"></a>  <span class="at">format =</span> <span class="st">"markdown"</span></span>
<span id="cb2-756"><a href="#cb2-756"></a>)</span>
<span id="cb2-757"><a href="#cb2-757"></a><span class="fu">print</span>(baseline_table)</span>
<span id="cb2-758"><a href="#cb2-758"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(baseline_table, <span class="st">"baseline_table"</span>, push_mods)</span>
<span id="cb2-759"><a href="#cb2-759"></a></span>
<span id="cb2-760"><a href="#cb2-760"></a><span class="co"># create exposure table by wave</span></span>
<span id="cb2-761"><a href="#cb2-761"></a>exposure_table <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_make_tables</span>(</span>
<span id="cb2-762"><a href="#cb2-762"></a>  <span class="at">data =</span> dat_long_final <span class="sc">|&gt;</span> <span class="fu">filter</span>(wave <span class="sc">%in%</span> <span class="fu">c</span>(baseline_wave, exposure_waves)),</span>
<span id="cb2-763"><a href="#cb2-763"></a>  <span class="at">vars =</span> exposure_var,</span>
<span id="cb2-764"><a href="#cb2-764"></a>  <span class="at">by =</span> <span class="st">"wave"</span>,</span>
<span id="cb2-765"><a href="#cb2-765"></a>  <span class="at">labels =</span> var_labels_exposure,</span>
<span id="cb2-766"><a href="#cb2-766"></a>  <span class="at">factor_vars =</span> exposure_var_binary,</span>
<span id="cb2-767"><a href="#cb2-767"></a>  <span class="at">table1_opts =</span> <span class="fu">list</span>(<span class="at">overall =</span> <span class="cn">FALSE</span>, <span class="at">transpose =</span> <span class="cn">FALSE</span>),</span>
<span id="cb2-768"><a href="#cb2-768"></a>  <span class="at">format =</span> <span class="st">"markdown"</span></span>
<span id="cb2-769"><a href="#cb2-769"></a>)</span>
<span id="cb2-770"><a href="#cb2-770"></a><span class="fu">print</span>(exposure_table)</span>
<span id="cb2-771"><a href="#cb2-771"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(exposure_table, <span class="st">"exposure_table"</span>, push_mods)</span>
<span id="cb2-772"><a href="#cb2-772"></a></span>
<span id="cb2-773"><a href="#cb2-773"></a><span class="co"># create outcomes table by wave</span></span>
<span id="cb2-774"><a href="#cb2-774"></a>outcomes_table <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_make_tables</span>(</span>
<span id="cb2-775"><a href="#cb2-775"></a>  <span class="at">data =</span> dat_long_final <span class="sc">|&gt;</span> <span class="fu">filter</span>(wave <span class="sc">%in%</span> <span class="fu">c</span>(baseline_wave, outcome_wave)),</span>
<span id="cb2-776"><a href="#cb2-776"></a>  <span class="at">vars =</span> outcome_vars,</span>
<span id="cb2-777"><a href="#cb2-777"></a>  <span class="at">by =</span> <span class="st">"wave"</span>,</span>
<span id="cb2-778"><a href="#cb2-778"></a>  <span class="at">labels =</span> var_labels_outcomes,</span>
<span id="cb2-779"><a href="#cb2-779"></a>  <span class="at">format =</span> <span class="st">"markdown"</span></span>
<span id="cb2-780"><a href="#cb2-780"></a>)</span>
<span id="cb2-781"><a href="#cb2-781"></a><span class="fu">print</span>(outcomes_table)</span>
<span id="cb2-782"><a href="#cb2-782"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(outcomes_table, <span class="st">"outcomes_table"</span>, push_mods)</span>
<span id="cb2-783"><a href="#cb2-783"></a></span>
<span id="cb2-784"><a href="#cb2-784"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-785"><a href="#cb2-785"></a><span class="co"># |     </span><span class="re">END</span><span class="co"> DO NOT ALTER     |</span></span>
<span id="cb2-786"><a href="#cb2-786"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-787"><a href="#cb2-787"></a></span>
<span id="cb2-788"><a href="#cb2-788"></a></span>
<span id="cb2-789"><a href="#cb2-789"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-790"><a href="#cb2-790"></a><span class="co"># |     </span><span class="re">END</span><span class="co">                  |</span></span>
<span id="cb2-791"><a href="#cb2-791"></a><span class="co"># +--------------------------+</span></span>
<span id="cb2-792"><a href="#cb2-792"></a></span>
<span id="cb2-793"><a href="#cb2-793"></a></span>
<span id="cb2-794"><a href="#cb2-794"></a><span class="co"># note: completed data preparation step -------------------------------------</span></span>
<span id="cb2-795"><a href="#cb2-795"></a><span class="co"># you're now ready for the next steps:</span></span>
<span id="cb2-796"><a href="#cb2-796"></a><span class="co"># 1. creating wide-format dataset for analysis </span></span>
<span id="cb2-797"><a href="#cb2-797"></a><span class="co"># 2. applying causal inference methods</span></span>
<span id="cb2-798"><a href="#cb2-798"></a><span class="co"># 3. conducting sensitivity analyses</span></span>
<span id="cb2-799"><a href="#cb2-799"></a></span>
<span id="cb2-800"><a href="#cb2-800"></a><span class="co"># key decisions summary:</span></span>
<span id="cb2-801"><a href="#cb2-801"></a><span class="co"># exposure variable: extraversion</span></span>
<span id="cb2-802"><a href="#cb2-802"></a><span class="co"># study waves: baseline (2018), exposure (2019), outcome (2020)</span></span>
<span id="cb2-803"><a href="#cb2-803"></a><span class="co"># baseline covariates: demographics, traits, health measures (excluding exposure)</span></span>
<span id="cb2-804"><a href="#cb2-804"></a><span class="co"># outcomes: health, psychological, wellbeing, and social variables</span></span>
<span id="cb2-805"><a href="#cb2-805"></a><span class="co"># binary cutpoint for exposure: here, 4 on the extraversion scale</span></span>
<span id="cb2-806"><a href="#cb2-806"></a><span class="co"># label names for tables</span></span>
<span id="cb2-807"><a href="#cb2-807"></a></span>
<span id="cb2-808"><a href="#cb2-808"></a></span>
<span id="cb2-809"><a href="#cb2-809"></a></span>
<span id="cb2-810"><a href="#cb2-810"></a></span>
<span id="cb2-811"><a href="#cb2-811"></a><span class="co"># THIS IS FOR INTEREST ONLY ----------------------------------------------------</span></span>
<span id="cb2-812"><a href="#cb2-812"></a><span class="co"># uncomment to view random chang in individuals</span></span>
<span id="cb2-813"><a href="#cb2-813"></a><span class="co"># visualise individual changes in exposure over time ------------------------</span></span>
<span id="cb2-814"><a href="#cb2-814"></a><span class="co"># useful for understanding exposure dynamics</span></span>
<span id="cb2-815"><a href="#cb2-815"></a><span class="co"># individual_plot &lt;- margot_plot_individual_responses(</span></span>
<span id="cb2-816"><a href="#cb2-816"></a><span class="co">#   dat_long_1,</span></span>
<span id="cb2-817"><a href="#cb2-817"></a><span class="co">#   y_vars = name_exposure,</span></span>
<span id="cb2-818"><a href="#cb2-818"></a><span class="co">#   id_col = "id",</span></span>
<span id="cb2-819"><a href="#cb2-819"></a><span class="co">#   waves = c(2018:2019),</span></span>
<span id="cb2-820"><a href="#cb2-820"></a><span class="co">#   random_draws = 56,  # number of randomly selected individuals to show</span></span>
<span id="cb2-821"><a href="#cb2-821"></a><span class="co">#   theme = theme_classic(),</span></span>
<span id="cb2-822"><a href="#cb2-822"></a><span class="co">#   scale_range = c(1, 7),  # range of the exposure variable</span></span>
<span id="cb2-823"><a href="#cb2-823"></a><span class="co">#   full_response_scale = TRUE,</span></span>
<span id="cb2-824"><a href="#cb2-824"></a><span class="co">#   seed = 123</span></span>
<span id="cb2-825"><a href="#cb2-825"></a><span class="co"># )</span></span>
<span id="cb2-826"><a href="#cb2-826"></a><span class="co"># print(individual_plot)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="script-2-make-wide-data-format-with-censoring-weights" class="level2">
<h2 class="anchored" data-anchor-id="script-2-make-wide-data-format-with-censoring-weights">Script 2: Make Wide Data Format With Censoring Weights</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># script 2: causal workflow for estimating average treatment effects using margot</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="co"># may 2025</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="co"># questions: joseph.bulbulia@vuw.ac.nz</span></span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="co"># +--------------------------+</span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="co"># |       DO NOT ALTER       |</span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co"># +--------------------------+</span></span>
<span id="cb3-8"><a href="#cb3-8"></a></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="co"># restart fresh session for a clean workspace</span></span>
<span id="cb3-10"><a href="#cb3-10"></a>rstudioapi<span class="sc">::</span><span class="fu">restartSession</span>()</span>
<span id="cb3-11"><a href="#cb3-11"></a></span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="co"># set seed for reproducibility</span></span>
<span id="cb3-13"><a href="#cb3-13"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb3-14"><a href="#cb3-14"></a></span>
<span id="cb3-15"><a href="#cb3-15"></a><span class="co"># libraries ---------------------------------------------------------------</span></span>
<span id="cb3-16"><a href="#cb3-16"></a><span class="co"># essential library ---------------------------------------------------------</span></span>
<span id="cb3-17"><a href="#cb3-17"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(margot, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb3-18"><a href="#cb3-18"></a>  devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"go-bayes/margot"</span>)</span>
<span id="cb3-19"><a href="#cb3-19"></a>}</span>
<span id="cb3-20"><a href="#cb3-20"></a></span>
<span id="cb3-21"><a href="#cb3-21"></a></span>
<span id="cb3-22"><a href="#cb3-22"></a><span class="cf">if</span> (<span class="fu">packageVersion</span>(<span class="st">"margot"</span>) <span class="sc">&lt;</span> <span class="st">"1.0.47"</span>) {</span>
<span id="cb3-23"><a href="#cb3-23"></a>  <span class="fu">stop</span>(<span class="st">"please install margot &gt;= 1.0.47 for this workflow</span><span class="sc">\n</span></span>
<span id="cb3-24"><a href="#cb3-24"></a><span class="st">       run: devtools::install_github(</span><span class="sc">\"</span><span class="st">go-bayes/margot</span><span class="sc">\"</span><span class="st">)</span></span>
<span id="cb3-25"><a href="#cb3-25"></a><span class="st">"</span>)</span>
<span id="cb3-26"><a href="#cb3-26"></a>}</span>
<span id="cb3-27"><a href="#cb3-27"></a></span>
<span id="cb3-28"><a href="#cb3-28"></a><span class="fu">library</span>(margot)</span>
<span id="cb3-29"><a href="#cb3-29"></a></span>
<span id="cb3-30"><a href="#cb3-30"></a><span class="co"># load packages -------------------------------------------------------------</span></span>
<span id="cb3-31"><a href="#cb3-31"></a><span class="co"># pacman will install missing packages automatically</span></span>
<span id="cb3-32"><a href="#cb3-32"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"pacman"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"pacman"</span>)</span>
<span id="cb3-33"><a href="#cb3-33"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb3-34"><a href="#cb3-34"></a>  tidyverse,       <span class="co"># data wrangling + plotting</span></span>
<span id="cb3-35"><a href="#cb3-35"></a>  qs,              <span class="co"># fast data i/o</span></span>
<span id="cb3-36"><a href="#cb3-36"></a>  here,            <span class="co"># project-relative file paths</span></span>
<span id="cb3-37"><a href="#cb3-37"></a>  data.table,      <span class="co"># fast data manipulation</span></span>
<span id="cb3-38"><a href="#cb3-38"></a>  fastDummies,     <span class="co"># dummy variable creation</span></span>
<span id="cb3-39"><a href="#cb3-39"></a>  naniar,          <span class="co"># missing data handling</span></span>
<span id="cb3-40"><a href="#cb3-40"></a>  skimr,           <span class="co"># summary statistics</span></span>
<span id="cb3-41"><a href="#cb3-41"></a>  grf,             <span class="co"># machine learning forests</span></span>
<span id="cb3-42"><a href="#cb3-42"></a>  kableExtra,      <span class="co"># tables</span></span>
<span id="cb3-43"><a href="#cb3-43"></a>  ggplot2,         <span class="co"># graphs</span></span>
<span id="cb3-44"><a href="#cb3-44"></a>  doParallel,      <span class="co"># parallel processing</span></span>
<span id="cb3-45"><a href="#cb3-45"></a>  grf,             <span class="co"># causal forests</span></span>
<span id="cb3-46"><a href="#cb3-46"></a>  janitor,         <span class="co"># variables names</span></span>
<span id="cb3-47"><a href="#cb3-47"></a>  stringr,         <span class="co"># variable names</span></span>
<span id="cb3-48"><a href="#cb3-48"></a>  patchwork,       <span class="co"># graphs</span></span>
<span id="cb3-49"><a href="#cb3-49"></a>  table1,           <span class="co"># tables</span></span>
<span id="cb3-50"><a href="#cb3-50"></a>  cli</span>
<span id="cb3-51"><a href="#cb3-51"></a>)</span>
<span id="cb3-52"><a href="#cb3-52"></a></span>
<span id="cb3-53"><a href="#cb3-53"></a><span class="co"># save paths -------------------------------------------------------------------</span></span>
<span id="cb3-54"><a href="#cb3-54"></a>push_mods <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"save_directory"</span>) </span>
<span id="cb3-55"><a href="#cb3-55"></a></span>
<span id="cb3-56"><a href="#cb3-56"></a><span class="co"># read data</span></span>
<span id="cb3-57"><a href="#cb3-57"></a>dat_long_final <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"dat_long_final"</span>)</span>
<span id="cb3-58"><a href="#cb3-58"></a></span>
<span id="cb3-59"><a href="#cb3-59"></a><span class="co"># read baseline sample weights</span></span>
<span id="cb3-60"><a href="#cb3-60"></a>t0_sample_weights <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"t0_sample_weights"</span>)</span>
<span id="cb3-61"><a href="#cb3-61"></a></span>
<span id="cb3-62"><a href="#cb3-62"></a><span class="co"># read exposure</span></span>
<span id="cb3-63"><a href="#cb3-63"></a>name_exposure <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"name_exposure"</span>)</span>
<span id="cb3-64"><a href="#cb3-64"></a>name_exposure_binary <span class="ot">=</span> <span class="fu">paste0</span>(name_exposure, <span class="st">"_binary"</span>)</span>
<span id="cb3-65"><a href="#cb3-65"></a>name_exposure_continuous <span class="ot">=</span> name_exposure</span>
<span id="cb3-66"><a href="#cb3-66"></a></span>
<span id="cb3-67"><a href="#cb3-67"></a><span class="co"># read variables</span></span>
<span id="cb3-68"><a href="#cb3-68"></a>baseline_vars <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"baseline_vars"</span>)</span>
<span id="cb3-69"><a href="#cb3-69"></a>exposure_var <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"exposure_var"</span>)</span>
<span id="cb3-70"><a href="#cb3-70"></a>outcome_vars <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"outcome_vars"</span>)</span>
<span id="cb3-71"><a href="#cb3-71"></a>baseline_wave <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"baseline_wave"</span>)</span>
<span id="cb3-72"><a href="#cb3-72"></a>exposure_waves <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"exposure_waves"</span>)</span>
<span id="cb3-73"><a href="#cb3-73"></a>outcome_wave <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"outcome_wave"</span>)</span>
<span id="cb3-74"><a href="#cb3-74"></a></span>
<span id="cb3-75"><a href="#cb3-75"></a><span class="co"># define continuous columns to keep</span></span>
<span id="cb3-76"><a href="#cb3-76"></a>continuous_columns_keep <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"t0_sample_weights"</span>)</span>
<span id="cb3-77"><a href="#cb3-77"></a></span>
<span id="cb3-78"><a href="#cb3-78"></a><span class="co"># check is this the exposure variable that you want? </span></span>
<span id="cb3-79"><a href="#cb3-79"></a>name_exposure_binary</span>
<span id="cb3-80"><a href="#cb3-80"></a>name_exposure_continuous</span>
<span id="cb3-81"><a href="#cb3-81"></a></span>
<span id="cb3-82"><a href="#cb3-82"></a><span class="co"># ordinal use</span></span>
<span id="cb3-83"><a href="#cb3-83"></a>ordinal_columns <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb3-84"><a href="#cb3-84"></a>  <span class="st">"t0_education_level_coarsen"</span>,</span>
<span id="cb3-85"><a href="#cb3-85"></a>  <span class="st">"t0_eth_cat"</span>,</span>
<span id="cb3-86"><a href="#cb3-86"></a>  <span class="st">"t0_rural_gch_2018_l"</span>,</span>
<span id="cb3-87"><a href="#cb3-87"></a>  <span class="st">"t0_gen_cohort"</span>,</span>
<span id="cb3-88"><a href="#cb3-88"></a>  <span class="st">"t0_religion_bigger_denominations"</span> <span class="co"># &lt;- added for demonstration (optional)</span></span>
<span id="cb3-89"><a href="#cb3-89"></a>)</span>
<span id="cb3-90"><a href="#cb3-90"></a></span>
<span id="cb3-91"><a href="#cb3-91"></a></span>
<span id="cb3-92"><a href="#cb3-92"></a><span class="co"># define wide variable names</span></span>
<span id="cb3-93"><a href="#cb3-93"></a>t0_name_exposure_binary <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t0_"</span>, name_exposure_binary)</span>
<span id="cb3-94"><a href="#cb3-94"></a>t0_name_exposure_binary</span>
<span id="cb3-95"><a href="#cb3-95"></a></span>
<span id="cb3-96"><a href="#cb3-96"></a><span class="co"># make exposure names (continuous not genreally used)</span></span>
<span id="cb3-97"><a href="#cb3-97"></a>t1_name_exposure_binary <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t1_"</span>, name_exposure_binary)</span>
<span id="cb3-98"><a href="#cb3-98"></a>t1_name_exposure_binary</span>
<span id="cb3-99"><a href="#cb3-99"></a></span>
<span id="cb3-100"><a href="#cb3-100"></a><span class="co"># treatments (continuous verion)</span></span>
<span id="cb3-101"><a href="#cb3-101"></a>t0_name_exposure <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t0_"</span>, name_exposure_continuous)</span>
<span id="cb3-102"><a href="#cb3-102"></a>t1_name_exposure <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t1_"</span>, name_exposure_continuous)</span>
<span id="cb3-103"><a href="#cb3-103"></a>t0_name_exposure_continuous <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t0_"</span>, name_exposure)</span>
<span id="cb3-104"><a href="#cb3-104"></a>t1_name_exposure_continuous <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t1_"</span>, name_exposure)</span>
<span id="cb3-105"><a href="#cb3-105"></a></span>
<span id="cb3-106"><a href="#cb3-106"></a><span class="co"># raw outcomes</span></span>
<span id="cb3-107"><a href="#cb3-107"></a><span class="co"># read health outcomes</span></span>
<span id="cb3-108"><a href="#cb3-108"></a>outcome_vars <span class="ot">&lt;-</span> <span class="fu">here_read</span>(<span class="st">"outcome_vars"</span>)</span>
<span id="cb3-109"><a href="#cb3-109"></a>t2_outcome_z <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t2_"</span>, outcome_vars, <span class="st">"_z"</span>)</span>
<span id="cb3-110"><a href="#cb3-110"></a></span>
<span id="cb3-111"><a href="#cb3-111"></a><span class="co"># view</span></span>
<span id="cb3-112"><a href="#cb3-112"></a>t2_outcome_z</span>
<span id="cb3-113"><a href="#cb3-113"></a></span>
<span id="cb3-114"><a href="#cb3-114"></a><span class="co"># check</span></span>
<span id="cb3-115"><a href="#cb3-115"></a><span class="fu">str</span>(dat_long_final)</span>
<span id="cb3-116"><a href="#cb3-116"></a></span>
<span id="cb3-117"><a href="#cb3-117"></a><span class="co"># check</span></span>
<span id="cb3-118"><a href="#cb3-118"></a>naniar<span class="sc">::</span><span class="fu">gg_miss_var</span>(dat_long_final)</span>
<span id="cb3-119"><a href="#cb3-119"></a></span>
<span id="cb3-120"><a href="#cb3-120"></a><span class="co"># impute data --------------------------------------------------------------</span></span>
<span id="cb3-121"><a href="#cb3-121"></a></span>
<span id="cb3-122"><a href="#cb3-122"></a><span class="co"># define cols we will not standardise</span></span>
<span id="cb3-123"><a href="#cb3-123"></a>continuous_columns_keep <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"t0_sample_weights"</span>)</span>
<span id="cb3-124"><a href="#cb3-124"></a></span>
<span id="cb3-125"><a href="#cb3-125"></a><span class="co"># remove sample weights</span></span>
<span id="cb3-126"><a href="#cb3-126"></a>dat_long_final_2 <span class="ot">&lt;-</span> dat_long_final <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>sample_weights)</span>
<span id="cb3-127"><a href="#cb3-127"></a></span>
<span id="cb3-128"><a href="#cb3-128"></a><span class="co"># prepare data for analysis ----------------------</span></span>
<span id="cb3-129"><a href="#cb3-129"></a>dat_long_final_2 <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">remove_numeric_attributes</span>(dat_long_final_2)</span>
<span id="cb3-130"><a href="#cb3-130"></a><span class="co"># wide data</span></span>
<span id="cb3-131"><a href="#cb3-131"></a>df_wide <span class="ot">&lt;-</span> <span class="fu">margot_wide_machine</span>(</span>
<span id="cb3-132"><a href="#cb3-132"></a>  dat_long_final,</span>
<span id="cb3-133"><a href="#cb3-133"></a>  <span class="at">id =</span> <span class="st">"id"</span>,</span>
<span id="cb3-134"><a href="#cb3-134"></a>  <span class="at">wave =</span> <span class="st">"wave"</span>,</span>
<span id="cb3-135"><a href="#cb3-135"></a>  baseline_vars,</span>
<span id="cb3-136"><a href="#cb3-136"></a>  <span class="at">exposure_var =</span> exposure_var,</span>
<span id="cb3-137"><a href="#cb3-137"></a>  outcome_vars,</span>
<span id="cb3-138"><a href="#cb3-138"></a>  <span class="at">confounder_vars =</span> <span class="cn">NULL</span>,</span>
<span id="cb3-139"><a href="#cb3-139"></a>  <span class="at">imputation_method =</span> <span class="st">"none"</span>,</span>
<span id="cb3-140"><a href="#cb3-140"></a>  <span class="at">include_exposure_var_baseline =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-141"><a href="#cb3-141"></a>  <span class="at">include_outcome_vars_baseline =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-142"><a href="#cb3-142"></a>  <span class="at">extend_baseline =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-143"><a href="#cb3-143"></a>  <span class="at">include_na_indicators =</span> <span class="cn">FALSE</span></span>
<span id="cb3-144"><a href="#cb3-144"></a>)</span>
<span id="cb3-145"><a href="#cb3-145"></a></span>
<span id="cb3-146"><a href="#cb3-146"></a><span class="co"># check</span></span>
<span id="cb3-147"><a href="#cb3-147"></a><span class="fu">colnames</span>(df_wide)</span>
<span id="cb3-148"><a href="#cb3-148"></a></span>
<span id="cb3-149"><a href="#cb3-149"></a><span class="co"># return sample weights</span></span>
<span id="cb3-150"><a href="#cb3-150"></a>df_wide<span class="sc">$</span>t0_sample_weights <span class="ot">&lt;-</span>  t0_sample_weights</span>
<span id="cb3-151"><a href="#cb3-151"></a></span>
<span id="cb3-152"><a href="#cb3-152"></a><span class="co"># save</span></span>
<span id="cb3-153"><a href="#cb3-153"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(df_wide, <span class="st">"df_wide"</span>)</span>
<span id="cb3-154"><a href="#cb3-154"></a></span>
<span id="cb3-155"><a href="#cb3-155"></a><span class="co">#df_wide &lt;- margot::here_read("df_wide")</span></span>
<span id="cb3-156"><a href="#cb3-156"></a>naniar<span class="sc">::</span><span class="fu">vis_miss</span>(df_wide, <span class="at">warn_large_data =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-157"><a href="#cb3-157"></a></span>
<span id="cb3-158"><a href="#cb3-158"></a><span class="co"># view</span></span>
<span id="cb3-159"><a href="#cb3-159"></a><span class="fu">glimpse</span>(df_wide)</span>
<span id="cb3-160"><a href="#cb3-160"></a></span>
<span id="cb3-161"><a href="#cb3-161"></a></span>
<span id="cb3-162"><a href="#cb3-162"></a><span class="co"># order data with missingness assigned to work with grf and lmtp</span></span>
<span id="cb3-163"><a href="#cb3-163"></a><span class="co"># if any outcome is censored all are censored</span></span>
<span id="cb3-164"><a href="#cb3-164"></a><span class="co"># create version for model reports</span></span>
<span id="cb3-165"><a href="#cb3-165"></a></span>
<span id="cb3-166"><a href="#cb3-166"></a><span class="co"># check</span></span>
<span id="cb3-167"><a href="#cb3-167"></a><span class="fu">colnames</span>(df_wide)</span>
<span id="cb3-168"><a href="#cb3-168"></a></span>
<span id="cb3-169"><a href="#cb3-169"></a></span>
<span id="cb3-170"><a href="#cb3-170"></a><span class="co"># made data wide in correct format</span></span>
<span id="cb3-171"><a href="#cb3-171"></a><span class="co"># ** ignore warning *** </span></span>
<span id="cb3-172"><a href="#cb3-172"></a>df_wide_encoded  <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_process_longitudinal_data_wider</span>(</span>
<span id="cb3-173"><a href="#cb3-173"></a>  df_wide,</span>
<span id="cb3-174"><a href="#cb3-174"></a>  <span class="at">ordinal_columns =</span> ordinal_columns, <span class="co">#&lt;- make sure all ordinal columns have been identified</span></span>
<span id="cb3-175"><a href="#cb3-175"></a>  <span class="at">continuous_columns_keep =</span> continuous_columns_keep,</span>
<span id="cb3-176"><a href="#cb3-176"></a>  <span class="at">not_lost_in_following_wave =</span> <span class="st">"not_lost_following_wave"</span>,</span>
<span id="cb3-177"><a href="#cb3-177"></a>  <span class="at">lost_in_following_wave =</span> <span class="st">"lost_following_wave"</span>,</span>
<span id="cb3-178"><a href="#cb3-178"></a>  <span class="at">remove_selected_columns =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-179"><a href="#cb3-179"></a>  <span class="at">exposure_var =</span> exposure_var,</span>
<span id="cb3-180"><a href="#cb3-180"></a>  <span class="at">scale_continuous =</span> <span class="cn">TRUE</span></span>
<span id="cb3-181"><a href="#cb3-181"></a>)</span>
<span id="cb3-182"><a href="#cb3-182"></a></span>
<span id="cb3-183"><a href="#cb3-183"></a></span>
<span id="cb3-184"><a href="#cb3-184"></a><span class="co"># check</span></span>
<span id="cb3-185"><a href="#cb3-185"></a><span class="fu">colnames</span>(df_wide_encoded)</span>
<span id="cb3-186"><a href="#cb3-186"></a></span>
<span id="cb3-187"><a href="#cb3-187"></a><span class="co"># check</span></span>
<span id="cb3-188"><a href="#cb3-188"></a><span class="fu">table</span>(df_wide_encoded<span class="sc">$</span>t0_not_lost_following_wave)</span>
<span id="cb3-189"><a href="#cb3-189"></a></span>
<span id="cb3-190"><a href="#cb3-190"></a><span class="co"># make the binary variable numeric</span></span>
<span id="cb3-191"><a href="#cb3-191"></a>df_wide_encoded[[t0_name_exposure_binary]] <span class="ot">&lt;-</span></span>
<span id="cb3-192"><a href="#cb3-192"></a>  <span class="fu">as.numeric</span>(df_wide_encoded[[t0_name_exposure_binary]]) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb3-193"><a href="#cb3-193"></a>df_wide_encoded[[t1_name_exposure_binary]] <span class="ot">&lt;-</span></span>
<span id="cb3-194"><a href="#cb3-194"></a>  <span class="fu">as.numeric</span>(df_wide_encoded[[t1_name_exposure_binary]]) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb3-195"><a href="#cb3-195"></a></span>
<span id="cb3-196"><a href="#cb3-196"></a><span class="co"># view</span></span>
<span id="cb3-197"><a href="#cb3-197"></a>df_wide_encoded[[t0_name_exposure_binary]]</span>
<span id="cb3-198"><a href="#cb3-198"></a>df_wide_encoded[[t1_name_exposure_binary]]</span>
<span id="cb3-199"><a href="#cb3-199"></a></span>
<span id="cb3-200"><a href="#cb3-200"></a><span class="co"># 1. ensure both binaries only take values 0 or 1 (ignore NA)</span></span>
<span id="cb3-201"><a href="#cb3-201"></a><span class="fu">stopifnot</span>(<span class="fu">all</span>(df_wide_encoded[[t0_name_exposure_binary]][<span class="sc">!</span><span class="fu">is.na</span>(df_wide_encoded[[t0_name_exposure_binary]])] <span class="sc">%in%</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>),</span>
<span id="cb3-202"><a href="#cb3-202"></a>          <span class="fu">all</span>(df_wide_encoded[[t1_name_exposure_binary]][<span class="sc">!</span><span class="fu">is.na</span>(df_wide_encoded[[t1_name_exposure_binary]])] <span class="sc">%in%</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>))</span>
<span id="cb3-203"><a href="#cb3-203"></a></span>
<span id="cb3-204"><a href="#cb3-204"></a><span class="co"># 2. ensure NA‐patterns match between t1_exposure and t0_lost flag</span></span>
<span id="cb3-205"><a href="#cb3-205"></a><span class="co"># count n-as in t1 exposure</span></span>
<span id="cb3-206"><a href="#cb3-206"></a>n_na_t1 <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(df_wide_encoded[[t1_name_exposure_binary]]))</span>
<span id="cb3-207"><a href="#cb3-207"></a></span>
<span id="cb3-208"><a href="#cb3-208"></a><span class="co"># count how many were lost at t0</span></span>
<span id="cb3-209"><a href="#cb3-209"></a>n_lost_t0 <span class="ot">&lt;-</span> <span class="fu">sum</span>(df_wide_encoded<span class="sc">$</span>t0_lost_following_wave <span class="sc">==</span> <span class="dv">1</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-210"><a href="#cb3-210"></a></span>
<span id="cb3-211"><a href="#cb3-211"></a><span class="co"># print them for inspection</span></span>
<span id="cb3-212"><a href="#cb3-212"></a><span class="fu">message</span>(<span class="st">"NAs in "</span>, t1_name_exposure_binary, <span class="st">": "</span>, n_na_t1)</span>
<span id="cb3-213"><a href="#cb3-213"></a><span class="fu">message</span>(<span class="st">"t0_lost_following_wave == 1: "</span>, n_lost_t0)</span>
<span id="cb3-214"><a href="#cb3-214"></a></span>
<span id="cb3-215"><a href="#cb3-215"></a><span class="co"># stop if they don’t match</span></span>
<span id="cb3-216"><a href="#cb3-216"></a><span class="fu">stopifnot</span>(n_na_t1 <span class="sc">==</span> n_lost_t0)</span>
<span id="cb3-217"><a href="#cb3-217"></a></span>
<span id="cb3-218"><a href="#cb3-218"></a><span class="co"># 3. ensure if t1 is non‐NA then subject was not lost at t0</span></span>
<span id="cb3-219"><a href="#cb3-219"></a><span class="fu">stopifnot</span>(<span class="fu">all</span>(<span class="fu">is.na</span>(df_wide_encoded[[t1_name_exposure_binary]]) <span class="sc">|</span></span>
<span id="cb3-220"><a href="#cb3-220"></a>                df_wide_encoded[[<span class="st">"t0_not_lost_following_wave"</span>]] <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb3-221"><a href="#cb3-221"></a></span>
<span id="cb3-222"><a href="#cb3-222"></a><span class="co"># view</span></span>
<span id="cb3-223"><a href="#cb3-223"></a><span class="fu">glimpse</span>(df_wide_encoded)</span>
<span id="cb3-224"><a href="#cb3-224"></a></span>
<span id="cb3-225"><a href="#cb3-225"></a><span class="co">#naniar::vis_miss(df_wide_encoded, warn_large_data = FALSE)</span></span>
<span id="cb3-226"><a href="#cb3-226"></a>naniar<span class="sc">::</span><span class="fu">gg_miss_var</span>(df_wide_encoded)</span>
<span id="cb3-227"><a href="#cb3-227"></a></span>
<span id="cb3-228"><a href="#cb3-228"></a></span>
<span id="cb3-229"><a href="#cb3-229"></a><span class="co">#save data</span></span>
<span id="cb3-230"><a href="#cb3-230"></a><span class="fu">here_save</span>(df_wide_encoded, <span class="st">"df_wide_encoded"</span>)</span>
<span id="cb3-231"><a href="#cb3-231"></a></span>
<span id="cb3-232"><a href="#cb3-232"></a><span class="co"># new weights approach ---------------------------------------------------------</span></span>
<span id="cb3-233"><a href="#cb3-233"></a></span>
<span id="cb3-234"><a href="#cb3-234"></a></span>
<span id="cb3-235"><a href="#cb3-235"></a><span class="co"># panel attrition workflow using grf (two-stage IPCW + design weights)</span></span>
<span id="cb3-236"><a href="#cb3-236"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-237"><a href="#cb3-237"></a><span class="co"># builds weights in two stages:</span></span>
<span id="cb3-238"><a href="#cb3-238"></a><span class="co">#   w0 : baseline -&gt; t1  (baseline covariates)</span></span>
<span id="cb3-239"><a href="#cb3-239"></a><span class="co">#   w1 : t1 survivors -&gt; t2  (baseline + time-1 exposure)</span></span>
<span id="cb3-240"><a href="#cb3-240"></a><span class="co"># final weight = t0_sample_weights × w0 × w1, then trimmed &amp; normalised.</span></span>
<span id="cb3-241"><a href="#cb3-241"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-242"><a href="#cb3-242"></a></span>
<span id="cb3-243"><a href="#cb3-243"></a><span class="co"># ── 0 setup ───────────────────────────────────────────────────────────────────</span></span>
<span id="cb3-244"><a href="#cb3-244"></a></span>
<span id="cb3-245"><a href="#cb3-245"></a><span class="fu">library</span>(tidyverse)        <span class="co"># wrangling</span></span>
<span id="cb3-246"><a href="#cb3-246"></a><span class="fu">library</span>(glue)             <span class="co"># strings</span></span>
<span id="cb3-247"><a href="#cb3-247"></a><span class="fu">library</span>(grf)              <span class="co"># forests</span></span>
<span id="cb3-248"><a href="#cb3-248"></a><span class="fu">library</span>(cli)              <span class="co"># progress</span></span>
<span id="cb3-249"><a href="#cb3-249"></a></span>
<span id="cb3-250"><a href="#cb3-250"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb3-251"><a href="#cb3-251"></a></span>
<span id="cb3-252"><a href="#cb3-252"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-253"><a href="#cb3-253"></a><span class="co"># 1 import full, unfiltered baseline file</span></span>
<span id="cb3-254"><a href="#cb3-254"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-255"><a href="#cb3-255"></a></span>
<span id="cb3-256"><a href="#cb3-256"></a>df <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"df_wide_encoded"</span>)</span>
<span id="cb3-257"><a href="#cb3-257"></a>cli<span class="sc">::</span><span class="fu">cli_alert_info</span>(<span class="fu">glue</span>(<span class="st">"{nrow(df)} rows × {ncol(df)} columns loaded"</span>))</span>
<span id="cb3-258"><a href="#cb3-258"></a></span>
<span id="cb3-259"><a href="#cb3-259"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-260"><a href="#cb3-260"></a><span class="co"># 2 stage‑0 censoring: dropout between t0 → t1</span></span>
<span id="cb3-261"><a href="#cb3-261"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-262"><a href="#cb3-262"></a></span>
<span id="cb3-263"><a href="#cb3-263"></a>baseline_covars <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb3-264"><a href="#cb3-264"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"t0_"</span>), <span class="sc">-</span><span class="fu">ends_with</span>(<span class="st">"_lost"</span>), <span class="sc">-</span><span class="fu">ends_with</span>(<span class="st">"lost_following_wave"</span>), <span class="sc">-</span><span class="fu">ends_with</span>(<span class="st">"_weights"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb3-265"><a href="#cb3-265"></a>  <span class="fu">colnames</span>() <span class="sc">%&gt;%</span> <span class="fu">sort</span>()</span>
<span id="cb3-266"><a href="#cb3-266"></a></span>
<span id="cb3-267"><a href="#cb3-267"></a><span class="co"># select your baseline vars and coerce to numeric</span></span>
<span id="cb3-268"><a href="#cb3-268"></a>num_dat <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb3-269"><a href="#cb3-269"></a>  <span class="fu">select</span>(<span class="fu">all_of</span>(baseline_covars)) <span class="sc">%&gt;%</span></span>
<span id="cb3-270"><a href="#cb3-270"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), as.numeric))</span>
<span id="cb3-271"><a href="#cb3-271"></a></span>
<span id="cb3-272"><a href="#cb3-272"></a><span class="co"># build a true numeric matrix</span></span>
<span id="cb3-273"><a href="#cb3-273"></a>X0 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(num_dat)</span>
<span id="cb3-274"><a href="#cb3-274"></a></span>
<span id="cb3-275"><a href="#cb3-275"></a><span class="co"># make factor</span></span>
<span id="cb3-276"><a href="#cb3-276"></a>D0 <span class="ot">&lt;-</span> <span class="fu">factor</span>(df<span class="sc">$</span>t0_lost_following_wave, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))   <span class="co"># 0 = stayed, 1 = lost</span></span>
<span id="cb3-277"><a href="#cb3-277"></a></span>
<span id="cb3-278"><a href="#cb3-278"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"stage 0: probability forest for baseline dropout …"</span>)</span>
<span id="cb3-279"><a href="#cb3-279"></a></span>
<span id="cb3-280"><a href="#cb3-280"></a><span class="co"># then fit</span></span>
<span id="cb3-281"><a href="#cb3-281"></a>pf0 <span class="ot">&lt;-</span> <span class="fu">probability_forest</span>(X0, D0)</span>
<span id="cb3-282"><a href="#cb3-282"></a>P0  <span class="ot">&lt;-</span> <span class="fu">predict</span>(pf0, X0)<span class="sc">$</span>pred[, <span class="dv">2</span>]               <span class="co"># P(dropout by t1)</span></span>
<span id="cb3-283"><a href="#cb3-283"></a>w0  <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(D0 <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> P0))         <span class="co"># IPCW for stage 0</span></span>
<span id="cb3-284"><a href="#cb3-284"></a>df<span class="sc">$</span>w0 <span class="ot">&lt;-</span> w0</span>
<span id="cb3-285"><a href="#cb3-285"></a></span>
<span id="cb3-286"><a href="#cb3-286"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-287"><a href="#cb3-287"></a><span class="co"># 3 stage‑1 censoring: dropout between t1 → t2 (baseline + exposure)</span></span>
<span id="cb3-288"><a href="#cb3-288"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-289"><a href="#cb3-289"></a></span>
<span id="cb3-290"><a href="#cb3-290"></a>exposure_var <span class="ot">&lt;-</span> t1_name_exposure_binary       <span class="co"># ← binary exposure variable name</span></span>
<span id="cb3-291"><a href="#cb3-291"></a></span>
<span id="cb3-292"><a href="#cb3-292"></a><span class="co"># filter out those lost (already weighted for censoring)</span></span>
<span id="cb3-293"><a href="#cb3-293"></a>df1 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(t0_lost_following_wave <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb3-294"><a href="#cb3-294"></a></span>
<span id="cb3-295"><a href="#cb3-295"></a><span class="co"># filter to those at risk in stage-1</span></span>
<span id="cb3-296"><a href="#cb3-296"></a>cen1_data <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb3-297"><a href="#cb3-297"></a>  <span class="fu">filter</span>(t0_lost_following_wave <span class="sc">==</span> <span class="dv">0</span>,</span>
<span id="cb3-298"><a href="#cb3-298"></a>         <span class="sc">!</span><span class="fu">is.na</span>(.data[[exposure_var]]))</span>
<span id="cb3-299"><a href="#cb3-299"></a></span>
<span id="cb3-300"><a href="#cb3-300"></a><span class="co"># coerce baseline covars + exposure all at once</span></span>
<span id="cb3-301"><a href="#cb3-301"></a>X1_num <span class="ot">&lt;-</span> cen1_data <span class="sc">%&gt;%</span></span>
<span id="cb3-302"><a href="#cb3-302"></a>  <span class="co"># convert every t0_… and the exposure to numeric</span></span>
<span id="cb3-303"><a href="#cb3-303"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">all_of</span>(<span class="fu">c</span>(baseline_covars, exposure_var)), as.numeric)) <span class="sc">%&gt;%</span></span>
<span id="cb3-304"><a href="#cb3-304"></a>  <span class="co"># now select in the order you want</span></span>
<span id="cb3-305"><a href="#cb3-305"></a>  <span class="fu">select</span>(<span class="fu">all_of</span>(baseline_covars), <span class="fu">all_of</span>(exposure_var))</span>
<span id="cb3-306"><a href="#cb3-306"></a></span>
<span id="cb3-307"><a href="#cb3-307"></a><span class="co"># build numeric matrix</span></span>
<span id="cb3-308"><a href="#cb3-308"></a>X1 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(X1_num)</span>
<span id="cb3-309"><a href="#cb3-309"></a><span class="fu">colnames</span>(X1)[<span class="fu">ncol</span>(X1)] <span class="ot">&lt;-</span> exposure_var</span>
<span id="cb3-310"><a href="#cb3-310"></a></span>
<span id="cb3-311"><a href="#cb3-311"></a>D1 <span class="ot">&lt;-</span> <span class="fu">factor</span>(cen1_data<span class="sc">$</span>t1_lost_following_wave, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb3-312"><a href="#cb3-312"></a></span>
<span id="cb3-313"><a href="#cb3-313"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"stage 1: probability forest for second-wave dropout …"</span>)</span>
<span id="cb3-314"><a href="#cb3-314"></a>pf1 <span class="ot">&lt;-</span> <span class="fu">probability_forest</span>(X1, D1)</span>
<span id="cb3-315"><a href="#cb3-315"></a>P1  <span class="ot">&lt;-</span> <span class="fu">predict</span>(pf1, X1)<span class="sc">$</span>pred[, <span class="dv">2</span>]</span>
<span id="cb3-316"><a href="#cb3-316"></a>w1  <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(D1 <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> P1))</span>
<span id="cb3-317"><a href="#cb3-317"></a></span>
<span id="cb3-318"><a href="#cb3-318"></a><span class="co"># map w1 back to df1 (rows with NA exposure get weight 0)</span></span>
<span id="cb3-319"><a href="#cb3-319"></a>df1<span class="sc">$</span>w1 <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb3-320"><a href="#cb3-320"></a>df1<span class="sc">$</span>w1[<span class="fu">match</span>(cen1_data<span class="sc">$</span>id, df1<span class="sc">$</span>id)] <span class="ot">&lt;-</span> w1</span>
<span id="cb3-321"><a href="#cb3-321"></a></span>
<span id="cb3-322"><a href="#cb3-322"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-323"><a href="#cb3-323"></a><span class="co"># 4 combine design × IPCW weights</span></span>
<span id="cb3-324"><a href="#cb3-324"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-325"><a href="#cb3-325"></a></span>
<span id="cb3-326"><a href="#cb3-326"></a><span class="co"># bring forward w0 for the matching rows (safe join)</span></span>
<span id="cb3-327"><a href="#cb3-327"></a>w0_vec <span class="ot">&lt;-</span> df<span class="sc">$</span>w0[<span class="fu">match</span>(df1<span class="sc">$</span>id, df<span class="sc">$</span>id)]</span>
<span id="cb3-328"><a href="#cb3-328"></a></span>
<span id="cb3-329"><a href="#cb3-329"></a><span class="co"># combined weight before trim / normalise</span></span>
<span id="cb3-330"><a href="#cb3-330"></a>raw_w <span class="ot">&lt;-</span> df1<span class="sc">$</span>t0_sample_weights <span class="sc">*</span> w0_vec <span class="sc">*</span> df1<span class="sc">$</span>w1</span>
<span id="cb3-331"><a href="#cb3-331"></a></span>
<span id="cb3-332"><a href="#cb3-332"></a>df1<span class="sc">$</span>raw_weight <span class="ot">&lt;-</span> raw_w</span>
<span id="cb3-333"><a href="#cb3-333"></a></span>
<span id="cb3-334"><a href="#cb3-334"></a><span class="co"># trim + normalise (exclude NA &amp; zeros)</span></span>
<span id="cb3-335"><a href="#cb3-335"></a>pos <span class="ot">&lt;-</span> raw_w[<span class="sc">!</span><span class="fu">is.na</span>(raw_w) <span class="sc">&amp;</span> raw_w <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb3-336"><a href="#cb3-336"></a></span>
<span id="cb3-337"><a href="#cb3-337"></a>lb  <span class="ot">&lt;-</span> <span class="fu">quantile</span>(pos, <span class="fl">0.00</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-338"><a href="#cb3-338"></a>ub  <span class="ot">&lt;-</span> <span class="fu">quantile</span>(pos, <span class="fl">0.99</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-339"><a href="#cb3-339"></a></span>
<span id="cb3-340"><a href="#cb3-340"></a>trimmed <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(raw_w, lb), ub)</span>
<span id="cb3-341"><a href="#cb3-341"></a>normalised <span class="ot">&lt;-</span> trimmed <span class="sc">/</span> <span class="fu">mean</span>(trimmed, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-342"><a href="#cb3-342"></a></span>
<span id="cb3-343"><a href="#cb3-343"></a>df1<span class="sc">$</span>combo_weights <span class="ot">&lt;-</span> normalised <span class="ot">&lt;-</span> trimmed <span class="sc">/</span> <span class="fu">mean</span>(trimmed)</span>
<span id="cb3-344"><a href="#cb3-344"></a></span>
<span id="cb3-345"><a href="#cb3-345"></a>df1<span class="sc">$</span>combo_weights <span class="ot">&lt;-</span> normalised</span>
<span id="cb3-346"><a href="#cb3-346"></a></span>
<span id="cb3-347"><a href="#cb3-347"></a><span class="fu">hist</span>(df1<span class="sc">$</span>combo_weights[df1<span class="sc">$</span>t1_lost_following_wave <span class="sc">==</span> <span class="dv">0</span>],</span>
<span id="cb3-348"><a href="#cb3-348"></a>     <span class="at">main =</span> <span class="st">"combined weights (observed)"</span>, <span class="at">xlab =</span> <span class="st">"weight"</span>)</span>
<span id="cb3-349"><a href="#cb3-349"></a></span>
<span id="cb3-350"><a href="#cb3-350"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-351"><a href="#cb3-351"></a><span class="co"># 5 analysis set: observed through t2 (not censored at either stage)</span></span>
<span id="cb3-352"><a href="#cb3-352"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-353"><a href="#cb3-353"></a></span>
<span id="cb3-354"><a href="#cb3-354"></a>df_analysis <span class="ot">&lt;-</span> df1 <span class="sc">%&gt;%</span></span>
<span id="cb3-355"><a href="#cb3-355"></a>  <span class="fu">filter</span>(t1_lost_following_wave <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-356"><a href="#cb3-356"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb3-357"><a href="#cb3-357"></a></span>
<span id="cb3-358"><a href="#cb3-358"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(df_analysis, <span class="st">"df_analysis_weighted_two_stage"</span>)</span>
<span id="cb3-359"><a href="#cb3-359"></a></span>
<span id="cb3-360"><a href="#cb3-360"></a>cli<span class="sc">::</span><span class="fu">cli_alert_success</span>(<span class="fu">glue</span>(<span class="st">"analysis sample: {nrow(df_analysis)} obs"</span>))</span>
<span id="cb3-361"><a href="#cb3-361"></a></span>
<span id="cb3-362"><a href="#cb3-362"></a><span class="co"># </span><span class="al">TEST</span><span class="co"> DO NOT UNCOMMENT</span></span>
<span id="cb3-363"><a href="#cb3-363"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-364"><a href="#cb3-364"></a><span class="co"># 6 causal forest (edit outcome var if needed)</span></span>
<span id="cb3-365"><a href="#cb3-365"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-366"><a href="#cb3-366"></a><span class="co"># </span></span>
<span id="cb3-367"><a href="#cb3-367"></a><span class="co"># outcome_var &lt;- "t2_kessler_latent_depression_z"   # ← edit</span></span>
<span id="cb3-368"><a href="#cb3-368"></a><span class="co"># </span></span>
<span id="cb3-369"><a href="#cb3-369"></a><span class="co"># Y &lt;- df_analysis[[outcome_var]]</span></span>
<span id="cb3-370"><a href="#cb3-370"></a><span class="co"># W &lt;- df_analysis[[exposure_var]]</span></span>
<span id="cb3-371"><a href="#cb3-371"></a><span class="co"># X &lt;- as.matrix(df_analysis[, baseline_covars])</span></span>
<span id="cb3-372"><a href="#cb3-372"></a><span class="co"># </span></span>
<span id="cb3-373"><a href="#cb3-373"></a><span class="co"># cf &lt;- causal_forest(</span></span>
<span id="cb3-374"><a href="#cb3-374"></a><span class="co">#   X, Y, W,</span></span>
<span id="cb3-375"><a href="#cb3-375"></a><span class="co">#   sample.weights = df_analysis$combo_weights,</span></span>
<span id="cb3-376"><a href="#cb3-376"></a><span class="co">#   num.trees      = 2000</span></span>
<span id="cb3-377"><a href="#cb3-377"></a><span class="co"># )</span></span>
<span id="cb3-378"><a href="#cb3-378"></a><span class="co"># </span></span>
<span id="cb3-379"><a href="#cb3-379"></a><span class="co"># print(average_treatment_effect(cf))</span></span>
<span id="cb3-380"><a href="#cb3-380"></a><span class="co"># margot::here_save(cf,          "cf_ipcw_two_stage")</span></span>
<span id="cb3-381"><a href="#cb3-381"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-382"><a href="#cb3-382"></a><span class="co"># 7 save objects</span></span>
<span id="cb3-383"><a href="#cb3-383"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb3-384"><a href="#cb3-384"></a></span>
<span id="cb3-385"><a href="#cb3-385"></a></span>
<span id="cb3-386"><a href="#cb3-386"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"two-stage IPCW workflow complete ✔"</span>)</span>
<span id="cb3-387"><a href="#cb3-387"></a></span>
<span id="cb3-388"><a href="#cb3-388"></a></span>
<span id="cb3-389"><a href="#cb3-389"></a><span class="co"># # maintain workflow </span></span>
<span id="cb3-390"><a href="#cb3-390"></a>E <span class="ot">&lt;-</span> baseline_covars</span>
<span id="cb3-391"><a href="#cb3-391"></a><span class="fu">here_save</span>(E, <span class="st">"E"</span>)</span>
<span id="cb3-392"><a href="#cb3-392"></a><span class="fu">length</span>(E)</span>
<span id="cb3-393"><a href="#cb3-393"></a><span class="fu">colnames</span>(df_analysis)</span>
<span id="cb3-394"><a href="#cb3-394"></a></span>
<span id="cb3-395"><a href="#cb3-395"></a></span>
<span id="cb3-396"><a href="#cb3-396"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"naming convention matcheds `grf` ✔"</span>)</span>
<span id="cb3-397"><a href="#cb3-397"></a></span>
<span id="cb3-398"><a href="#cb3-398"></a></span>
<span id="cb3-399"><a href="#cb3-399"></a><span class="co"># arrange</span></span>
<span id="cb3-400"><a href="#cb3-400"></a>df_grf <span class="ot">&lt;-</span> df_analysis <span class="sc">|&gt;</span></span>
<span id="cb3-401"><a href="#cb3-401"></a>  <span class="fu">relocate</span>(<span class="fu">ends_with</span>(<span class="st">"_weights"</span>), <span class="at">.before =</span> <span class="fu">starts_with</span>(<span class="st">"t0_"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb3-402"><a href="#cb3-402"></a>  <span class="fu">relocate</span>(<span class="fu">ends_with</span>(<span class="st">"_weight"</span>), <span class="at">.before =</span> <span class="fu">ends_with</span>(<span class="st">"_weights"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb3-403"><a href="#cb3-403"></a>  <span class="fu">relocate</span>(<span class="fu">starts_with</span>(<span class="st">"t0_"</span>), <span class="at">.before =</span> <span class="fu">starts_with</span>(<span class="st">"t1_"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb3-404"><a href="#cb3-404"></a>  <span class="fu">relocate</span>(<span class="fu">starts_with</span>(<span class="st">"t1_"</span>), <span class="at">.before =</span> <span class="fu">starts_with</span>(<span class="st">"t2_"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb3-405"><a href="#cb3-405"></a>  <span class="fu">relocate</span>(<span class="st">"t0_not_lost_following_wave"</span>, <span class="at">.before =</span> <span class="fu">starts_with</span>(<span class="st">"t1_"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb3-406"><a href="#cb3-406"></a>  <span class="fu">relocate</span>(<span class="fu">all_of</span>(t1_name_exposure_binary), <span class="at">.before =</span> <span class="fu">starts_with</span>(<span class="st">"t2_"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb3-407"><a href="#cb3-407"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb3-408"><a href="#cb3-408"></a></span>
<span id="cb3-409"><a href="#cb3-409"></a><span class="fu">colnames</span>(df_grf)</span>
<span id="cb3-410"><a href="#cb3-410"></a></span>
<span id="cb3-411"><a href="#cb3-411"></a></span>
<span id="cb3-412"><a href="#cb3-412"></a><span class="co"># +--------------------------+</span></span>
<span id="cb3-413"><a href="#cb3-413"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb3-414"><a href="#cb3-414"></a><span class="co"># +--------------------------+</span></span>
<span id="cb3-415"><a href="#cb3-415"></a><span class="co"># make sure to do this</span></span>
<span id="cb3-416"><a href="#cb3-416"></a><span class="co"># save final data</span></span>
<span id="cb3-417"><a href="#cb3-417"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(df_grf, <span class="st">"df_grf"</span>)</span>
<span id="cb3-418"><a href="#cb3-418"></a></span>
<span id="cb3-419"><a href="#cb3-419"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"saved data `df_grf` for models ✔"</span>)</span>
<span id="cb3-420"><a href="#cb3-420"></a></span>
<span id="cb3-421"><a href="#cb3-421"></a></span>
<span id="cb3-422"><a href="#cb3-422"></a><span class="co"># +--------------------------+</span></span>
<span id="cb3-423"><a href="#cb3-423"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb3-424"><a href="#cb3-424"></a><span class="co"># +--------------------------+</span></span>
<span id="cb3-425"><a href="#cb3-425"></a></span>
<span id="cb3-426"><a href="#cb3-426"></a></span>
<span id="cb3-427"><a href="#cb3-427"></a><span class="co"># check final dataset</span></span>
<span id="cb3-428"><a href="#cb3-428"></a><span class="fu">colnames</span>(df_grf)</span>
<span id="cb3-429"><a href="#cb3-429"></a></span>
<span id="cb3-430"><a href="#cb3-430"></a><span class="co"># visualise missing</span></span>
<span id="cb3-431"><a href="#cb3-431"></a><span class="co"># should have no missing in t1 and t2 variables</span></span>
<span id="cb3-432"><a href="#cb3-432"></a><span class="co"># handled by IPCW</span></span>
<span id="cb3-433"><a href="#cb3-433"></a><span class="co"># make final missing data graph</span></span>
<span id="cb3-434"><a href="#cb3-434"></a>missing_final_data_plot <span class="ot">&lt;-</span> naniar<span class="sc">::</span><span class="fu">vis_miss</span>(df_grf, <span class="at">warn_large_data =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-435"><a href="#cb3-435"></a>missing_final_data_plot</span>
<span id="cb3-436"><a href="#cb3-436"></a></span>
<span id="cb3-437"><a href="#cb3-437"></a><span class="co"># save plot</span></span>
<span id="cb3-438"><a href="#cb3-438"></a><span class="fu">margot_save_png</span>(missing_final_data_plot, <span class="at">prefix =</span> <span class="st">"missing_final_data"</span>)</span>
<span id="cb3-439"><a href="#cb3-439"></a></span>
<span id="cb3-440"><a href="#cb3-440"></a><span class="co"># checks</span></span>
<span id="cb3-441"><a href="#cb3-441"></a><span class="fu">colnames</span>(df_grf)</span>
<span id="cb3-442"><a href="#cb3-442"></a><span class="fu">str</span>(df_grf)</span>
<span id="cb3-443"><a href="#cb3-443"></a></span>
<span id="cb3-444"><a href="#cb3-444"></a><span class="co"># check exposures</span></span>
<span id="cb3-445"><a href="#cb3-445"></a><span class="fu">table</span>(df_grf[[t1_name_exposure_binary]])</span>
<span id="cb3-446"><a href="#cb3-446"></a></span>
<span id="cb3-447"><a href="#cb3-447"></a><span class="co"># check</span></span>
<span id="cb3-448"><a href="#cb3-448"></a><span class="fu">hist</span>(df_grf<span class="sc">$</span>combo_weights)</span>
<span id="cb3-449"><a href="#cb3-449"></a></span>
<span id="cb3-450"><a href="#cb3-450"></a><span class="co"># calculate summary statistics</span></span>
<span id="cb3-451"><a href="#cb3-451"></a>t0_weight_summary <span class="ot">&lt;-</span> <span class="fu">summary</span>(df_wide_encoded)</span>
<span id="cb3-452"><a href="#cb3-452"></a></span>
<span id="cb3-453"><a href="#cb3-453"></a><span class="co"># check</span></span>
<span id="cb3-454"><a href="#cb3-454"></a><span class="fu">glimpse</span>(df_grf<span class="sc">$</span>combo_weights)</span>
<span id="cb3-455"><a href="#cb3-455"></a></span>
<span id="cb3-456"><a href="#cb3-456"></a><span class="co"># visualise weight distributions</span></span>
<span id="cb3-457"><a href="#cb3-457"></a><span class="fu">hist</span>(df_grf<span class="sc">$</span>combo_weights, <span class="at">main =</span> <span class="st">"t0_stabalised weights"</span>, <span class="at">xlab =</span> <span class="st">"Weight"</span>)</span>
<span id="cb3-458"><a href="#cb3-458"></a></span>
<span id="cb3-459"><a href="#cb3-459"></a><span class="co"># check n</span></span>
<span id="cb3-460"><a href="#cb3-460"></a>n_observed_grf <span class="ot">&lt;-</span> <span class="fu">nrow</span>(df_grf)</span>
<span id="cb3-461"><a href="#cb3-461"></a></span>
<span id="cb3-462"><a href="#cb3-462"></a><span class="co"># view</span></span>
<span id="cb3-463"><a href="#cb3-463"></a>n_observed_grf</span>
<span id="cb3-464"><a href="#cb3-464"></a></span>
<span id="cb3-465"><a href="#cb3-465"></a><span class="co"># save</span></span>
<span id="cb3-466"><a href="#cb3-466"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(n_observed_grf, <span class="st">"n_observed_grf"</span>)</span>
<span id="cb3-467"><a href="#cb3-467"></a></span>
<span id="cb3-468"><a href="#cb3-468"></a></span>
<span id="cb3-469"><a href="#cb3-469"></a></span>
<span id="cb3-470"><a href="#cb3-470"></a><span class="co"># +--------------------------+</span></span>
<span id="cb3-471"><a href="#cb3-471"></a><span class="co"># |     </span><span class="re">END</span><span class="co"> DO NOT ALTER     |</span></span>
<span id="cb3-472"><a href="#cb3-472"></a><span class="co"># +--------------------------+</span></span>
<span id="cb3-473"><a href="#cb3-473"></a></span>
<span id="cb3-474"><a href="#cb3-474"></a></span>
<span id="cb3-475"><a href="#cb3-475"></a><span class="co"># +--------------------------+</span></span>
<span id="cb3-476"><a href="#cb3-476"></a><span class="co"># |     </span><span class="re">END</span><span class="co">                  |</span></span>
<span id="cb3-477"><a href="#cb3-477"></a><span class="co"># +--------------------------+</span></span>
<span id="cb3-478"><a href="#cb3-478"></a></span>
<span id="cb3-479"><a href="#cb3-479"></a><span class="co"># this is just for your interest ------------------------------------------</span></span>
<span id="cb3-480"><a href="#cb3-480"></a><span class="co"># not used in final manuscript</span></span>
<span id="cb3-481"><a href="#cb3-481"></a><span class="co"># FOR INTEREESTS</span></span>
<span id="cb3-482"><a href="#cb3-482"></a><span class="co"># inspect propensity scores -----------------------------------------------</span></span>
<span id="cb3-483"><a href="#cb3-483"></a><span class="co"># get data</span></span>
<span id="cb3-484"><a href="#cb3-484"></a><span class="co"># df_grf &lt;- here_read('df_grf')</span></span>
<span id="cb3-485"><a href="#cb3-485"></a><span class="co"># </span></span>
<span id="cb3-486"><a href="#cb3-486"></a><span class="co"># # assign weights var name</span></span>
<span id="cb3-487"><a href="#cb3-487"></a><span class="co"># weights_var_name = "t0_adjusted_weights"</span></span>
<span id="cb3-488"><a href="#cb3-488"></a><span class="co"># </span></span>
<span id="cb3-489"><a href="#cb3-489"></a><span class="co"># # baseline covariates  # E already exists and is defined</span></span>
<span id="cb3-490"><a href="#cb3-490"></a><span class="co"># E</span></span>
<span id="cb3-491"><a href="#cb3-491"></a><span class="co"># </span></span>
<span id="cb3-492"><a href="#cb3-492"></a><span class="co"># # must be a data frame, no NA in exposure</span></span>
<span id="cb3-493"><a href="#cb3-493"></a><span class="co"># </span></span>
<span id="cb3-494"><a href="#cb3-494"></a><span class="co"># # df_grf is a data frame - we must process this data frame in several steps</span></span>
<span id="cb3-495"><a href="#cb3-495"></a><span class="co"># # user to specify which columns are outcomes, default to 'starts_with("t2_")'</span></span>
<span id="cb3-496"><a href="#cb3-496"></a><span class="co"># df_propensity_org &lt;- df_grf |&gt; select(!starts_with("t2_"))</span></span>
<span id="cb3-497"><a href="#cb3-497"></a><span class="co"># </span></span>
<span id="cb3-498"><a href="#cb3-498"></a><span class="co"># # Remove NAs and print message that this has been done</span></span>
<span id="cb3-499"><a href="#cb3-499"></a><span class="co"># df_propensity &lt;- df_propensity_org |&gt; drop_na() |&gt; droplevels()</span></span>
<span id="cb3-500"><a href="#cb3-500"></a><span class="co"># </span></span>
<span id="cb3-501"><a href="#cb3-501"></a><span class="co"># # E_propensity_names</span></span>
<span id="cb3-502"><a href="#cb3-502"></a><span class="co"># # first run model for baseline propensity if this is selected.  The default should be to not select it.</span></span>
<span id="cb3-503"><a href="#cb3-503"></a><span class="co"># propensity_model_and_plots &lt;- margot_propensity_model_and_plots(</span></span>
<span id="cb3-504"><a href="#cb3-504"></a><span class="co">#   df_propensity = df_propensity,</span></span>
<span id="cb3-505"><a href="#cb3-505"></a><span class="co">#   exposure_variable = t1_name_exposure_binary,</span></span>
<span id="cb3-506"><a href="#cb3-506"></a><span class="co">#   baseline_vars = E,</span></span>
<span id="cb3-507"><a href="#cb3-507"></a><span class="co">#   weights_var_name = weights_var_name,</span></span>
<span id="cb3-508"><a href="#cb3-508"></a><span class="co">#   estimand = "ATE",</span></span>
<span id="cb3-509"><a href="#cb3-509"></a><span class="co">#   method = "ebal",</span></span>
<span id="cb3-510"><a href="#cb3-510"></a><span class="co">#   focal = NULL</span></span>
<span id="cb3-511"><a href="#cb3-511"></a><span class="co"># )</span></span>
<span id="cb3-512"><a href="#cb3-512"></a><span class="co"># </span></span>
<span id="cb3-513"><a href="#cb3-513"></a><span class="co"># # visualise</span></span>
<span id="cb3-514"><a href="#cb3-514"></a><span class="co"># summary(propensity_model_and_plots$match_propensity)</span></span>
<span id="cb3-515"><a href="#cb3-515"></a><span class="co"># </span></span>
<span id="cb3-516"><a href="#cb3-516"></a><span class="co"># # key plot</span></span>
<span id="cb3-517"><a href="#cb3-517"></a><span class="co"># propensity_model_and_plots$love_plot</span></span>
<span id="cb3-518"><a href="#cb3-518"></a><span class="co"># </span></span>
<span id="cb3-519"><a href="#cb3-519"></a><span class="co"># # other plots</span></span>
<span id="cb3-520"><a href="#cb3-520"></a><span class="co"># propensity_model_and_plots$summary_plot</span></span>
<span id="cb3-521"><a href="#cb3-521"></a><span class="co"># propensity_model_and_plots$balance_table</span></span>
<span id="cb3-522"><a href="#cb3-522"></a><span class="co"># propensity_model_and_plots$diagnostics</span></span>
<span id="cb3-523"><a href="#cb3-523"></a><span class="co"># </span></span>
<span id="cb3-524"><a href="#cb3-524"></a><span class="co"># </span></span>
<span id="cb3-525"><a href="#cb3-525"></a><span class="co"># # check size</span></span>
<span id="cb3-526"><a href="#cb3-526"></a><span class="co"># size_bytes &lt;- object.size(propensity_model_and_plots)</span></span>
<span id="cb3-527"><a href="#cb3-527"></a><span class="co"># print(size_bytes, units = "auto") # Mb</span></span>
<span id="cb3-528"><a href="#cb3-528"></a><span class="co"># </span></span>
<span id="cb3-529"><a href="#cb3-529"></a><span class="co"># # use qs to save only if you have space</span></span>
<span id="cb3-530"><a href="#cb3-530"></a><span class="co"># here_save_qs(propensity_model_and_plots,</span></span>
<span id="cb3-531"><a href="#cb3-531"></a><span class="co">#              "propensity_model_and_plots",</span></span>
<span id="cb3-532"><a href="#cb3-532"></a><span class="co">#              push_mods)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="script-3-models-graphs" class="level2">
<h2 class="anchored" data-anchor-id="script-3-models-graphs">Script 3: Models &amp; Graphs</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># script 3: causal workflow for estimating average treatment effects using margot</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="co"># may 2025</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="co"># questions: joseph.bulbulia@vuw.ac.nz</span></span>
<span id="cb4-4"><a href="#cb4-4"></a></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co"># |       DO NOT ALTER       |</span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-8"><a href="#cb4-8"></a></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="co"># restart fresh session</span></span>
<span id="cb4-10"><a href="#cb4-10"></a></span>
<span id="cb4-11"><a href="#cb4-11"></a>rstudioapi<span class="sc">::</span><span class="fu">restartSession</span>()</span>
<span id="cb4-12"><a href="#cb4-12"></a></span>
<span id="cb4-13"><a href="#cb4-13"></a></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="co"># reproducibility ---------------------------------------------------------</span></span>
<span id="cb4-15"><a href="#cb4-15"></a></span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="co"># choose number</span></span>
<span id="cb4-17"><a href="#cb4-17"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb4-18"><a href="#cb4-18"></a>seed <span class="ot">=</span> <span class="dv">123</span></span>
<span id="cb4-19"><a href="#cb4-19"></a></span>
<span id="cb4-20"><a href="#cb4-20"></a><span class="co"># essential library ---------------------------------------------------------</span></span>
<span id="cb4-21"><a href="#cb4-21"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(margot, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb4-22"><a href="#cb4-22"></a>  devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"go-bayes/margot"</span>)</span>
<span id="cb4-23"><a href="#cb4-23"></a>  <span class="fu">library</span>(margot)</span>
<span id="cb4-24"><a href="#cb4-24"></a>}</span>
<span id="cb4-25"><a href="#cb4-25"></a></span>
<span id="cb4-26"><a href="#cb4-26"></a><span class="co"># min version of margot</span></span>
<span id="cb4-27"><a href="#cb4-27"></a><span class="cf">if</span> (<span class="fu">packageVersion</span>(<span class="st">"margot"</span>) <span class="sc">&lt;</span> <span class="st">"1.0.47"</span>) {</span>
<span id="cb4-28"><a href="#cb4-28"></a>  <span class="fu">stop</span>(<span class="st">"please install margot &gt;= 1.0.47 for this workflow</span><span class="sc">\n</span></span>
<span id="cb4-29"><a href="#cb4-29"></a><span class="st">       run: devtools::install_github(</span><span class="sc">\"</span><span class="st">go-bayes/margot</span><span class="sc">\"</span><span class="st">)</span></span>
<span id="cb4-30"><a href="#cb4-30"></a><span class="st">"</span>)</span>
<span id="cb4-31"><a href="#cb4-31"></a>}</span>
<span id="cb4-32"><a href="#cb4-32"></a></span>
<span id="cb4-33"><a href="#cb4-33"></a><span class="co"># call library</span></span>
<span id="cb4-34"><a href="#cb4-34"></a><span class="fu">library</span>(<span class="st">"margot"</span>)</span>
<span id="cb4-35"><a href="#cb4-35"></a></span>
<span id="cb4-36"><a href="#cb4-36"></a><span class="co"># check package version</span></span>
<span id="cb4-37"><a href="#cb4-37"></a><span class="fu">packageVersion</span>(<span class="at">pkg =</span> <span class="st">"margot"</span>)</span>
<span id="cb4-38"><a href="#cb4-38"></a></span>
<span id="cb4-39"><a href="#cb4-39"></a></span>
<span id="cb4-40"><a href="#cb4-40"></a></span>
<span id="cb4-41"><a href="#cb4-41"></a><span class="co"># load libraries ----------------------------------------------------------</span></span>
<span id="cb4-42"><a href="#cb4-42"></a><span class="co"># pacman will install missing packages automatically</span></span>
<span id="cb4-43"><a href="#cb4-43"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"pacman"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"pacman"</span>)</span>
<span id="cb4-44"><a href="#cb4-44"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb4-45"><a href="#cb4-45"></a>  tidyverse,       <span class="co"># data wrangling + plotting</span></span>
<span id="cb4-46"><a href="#cb4-46"></a>  qs,              <span class="co"># fast data i/o</span></span>
<span id="cb4-47"><a href="#cb4-47"></a>  here,            <span class="co"># project-relative file paths</span></span>
<span id="cb4-48"><a href="#cb4-48"></a>  data.table,      <span class="co"># fast data manipulation</span></span>
<span id="cb4-49"><a href="#cb4-49"></a>  fastDummies,     <span class="co"># dummy variable creation</span></span>
<span id="cb4-50"><a href="#cb4-50"></a>  naniar,          <span class="co"># missing data handling</span></span>
<span id="cb4-51"><a href="#cb4-51"></a>  skimr,           <span class="co"># summary statistics</span></span>
<span id="cb4-52"><a href="#cb4-52"></a>  grf, ranger,     <span class="co"># machine learning forests</span></span>
<span id="cb4-53"><a href="#cb4-53"></a>  doParallel,      <span class="co"># parallel processing,</span></span>
<span id="cb4-54"><a href="#cb4-54"></a>  kableExtra,</span>
<span id="cb4-55"><a href="#cb4-55"></a>  ggplot2 ,        <span class="co"># graphs</span></span>
<span id="cb4-56"><a href="#cb4-56"></a>  rlang ,          <span class="co"># functions for base types/Core R/ 'Tidyverse'</span></span>
<span id="cb4-57"><a href="#cb4-57"></a>  purrr ,          <span class="co"># functional programming tools.</span></span>
<span id="cb4-58"><a href="#cb4-58"></a>  patchwork,      <span class="co"># nice graph placement</span></span>
<span id="cb4-59"><a href="#cb4-59"></a>  janitor,         <span class="co"># nice labels</span></span>
<span id="cb4-60"><a href="#cb4-60"></a>  glue,            <span class="co"># format/ interpolate a string</span></span>
<span id="cb4-61"><a href="#cb4-61"></a>  cli,</span>
<span id="cb4-62"><a href="#cb4-62"></a>  future,</span>
<span id="cb4-63"><a href="#cb4-63"></a>  crayon,</span>
<span id="cb4-64"><a href="#cb4-64"></a>  glue,</span>
<span id="cb4-65"><a href="#cb4-65"></a>  stringr, </span>
<span id="cb4-66"><a href="#cb4-66"></a>  future,</span>
<span id="cb4-67"><a href="#cb4-67"></a>  furrr</span>
<span id="cb4-68"><a href="#cb4-68"></a>)</span>
<span id="cb4-69"><a href="#cb4-69"></a></span>
<span id="cb4-70"><a href="#cb4-70"></a></span>
<span id="cb4-71"><a href="#cb4-71"></a></span>
<span id="cb4-72"><a href="#cb4-72"></a><span class="co"># directory path configuration -----------------------------------------------</span></span>
<span id="cb4-73"><a href="#cb4-73"></a><span class="co"># save path (customise for your own computer) ----------------------------</span></span>
<span id="cb4-74"><a href="#cb4-74"></a>push_mods <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"save_directory"</span>) </span>
<span id="cb4-75"><a href="#cb4-75"></a></span>
<span id="cb4-76"><a href="#cb4-76"></a><span class="co"># read original data (for plots) ------------------------------------------</span></span>
<span id="cb4-77"><a href="#cb4-77"></a>original_df <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"df_wide"</span>, push_mods)</span>
<span id="cb4-78"><a href="#cb4-78"></a></span>
<span id="cb4-79"><a href="#cb4-79"></a><span class="co"># plot title --------------------------------------------------------------</span></span>
<span id="cb4-80"><a href="#cb4-80"></a>title_binary <span class="ot">=</span> <span class="st">"Effects of {{name_exposure}} on {{name_outcomes}}"</span></span>
<span id="cb4-81"><a href="#cb4-81"></a>filename_prefix <span class="ot">=</span> <span class="st">"grf_extraversion_wb"</span></span>
<span id="cb4-82"><a href="#cb4-82"></a></span>
<span id="cb4-83"><a href="#cb4-83"></a><span class="co"># for manuscript later</span></span>
<span id="cb4-84"><a href="#cb4-84"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(title_binary,<span class="st">"title_binary"</span>)</span>
<span id="cb4-85"><a href="#cb4-85"></a></span>
<span id="cb4-86"><a href="#cb4-86"></a><span class="co"># import names ------------------------------------------------------------</span></span>
<span id="cb4-87"><a href="#cb4-87"></a>name_exposure <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"name_exposure"</span>)</span>
<span id="cb4-88"><a href="#cb4-88"></a>name_exposure</span>
<span id="cb4-89"><a href="#cb4-89"></a></span>
<span id="cb4-90"><a href="#cb4-90"></a><span class="co"># make exposure names</span></span>
<span id="cb4-91"><a href="#cb4-91"></a>t1_name_exposure_binary <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t1_"</span>, name_exposure, <span class="st">"_binary"</span>)</span>
<span id="cb4-92"><a href="#cb4-92"></a></span>
<span id="cb4-93"><a href="#cb4-93"></a><span class="co"># check exposure name</span></span>
<span id="cb4-94"><a href="#cb4-94"></a>t1_name_exposure_binary</span>
<span id="cb4-95"><a href="#cb4-95"></a></span>
<span id="cb4-96"><a href="#cb4-96"></a><span class="co"># read outcome vars</span></span>
<span id="cb4-97"><a href="#cb4-97"></a>outcome_vars <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"outcome_vars"</span>)</span>
<span id="cb4-98"><a href="#cb4-98"></a></span>
<span id="cb4-99"><a href="#cb4-99"></a><span class="co"># read and sort outcome variables -----------------------------------------</span></span>
<span id="cb4-100"><a href="#cb4-100"></a><span class="co"># we do this by domain: health, psych, present, life, social</span></span>
<span id="cb4-101"><a href="#cb4-101"></a>read_and_sort <span class="ot">&lt;-</span> <span class="cf">function</span>(key) {</span>
<span id="cb4-102"><a href="#cb4-102"></a>  raw  <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(key, push_mods)</span>
<span id="cb4-103"><a href="#cb4-103"></a>  vars <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t2_"</span>, raw, <span class="st">"_z"</span>)</span>
<span id="cb4-104"><a href="#cb4-104"></a>  <span class="fu">sort</span>(vars)</span>
<span id="cb4-105"><a href="#cb4-105"></a>}</span>
<span id="cb4-106"><a href="#cb4-106"></a>t2_outcome_z  <span class="ot">&lt;-</span> <span class="fu">read_and_sort</span>(<span class="st">"outcome_vars"</span>)</span>
<span id="cb4-107"><a href="#cb4-107"></a></span>
<span id="cb4-108"><a href="#cb4-108"></a><span class="co"># view</span></span>
<span id="cb4-109"><a href="#cb4-109"></a>t2_outcome_z</span>
<span id="cb4-110"><a href="#cb4-110"></a></span>
<span id="cb4-111"><a href="#cb4-111"></a></span>
<span id="cb4-112"><a href="#cb4-112"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-113"><a href="#cb4-113"></a><span class="co"># |     </span><span class="re">END</span><span class="co"> DO NOT ALTER     |</span></span>
<span id="cb4-114"><a href="#cb4-114"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-115"><a href="#cb4-115"></a></span>
<span id="cb4-116"><a href="#cb4-116"></a></span>
<span id="cb4-117"><a href="#cb4-117"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-118"><a href="#cb4-118"></a><span class="co"># |    MODIFY THIS SECTION   |</span></span>
<span id="cb4-119"><a href="#cb4-119"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-120"><a href="#cb4-120"></a></span>
<span id="cb4-121"><a href="#cb4-121"></a></span>
<span id="cb4-122"><a href="#cb4-122"></a><span class="co"># define names for titles -------------------------------------------------</span></span>
<span id="cb4-123"><a href="#cb4-123"></a></span>
<span id="cb4-124"><a href="#cb4-124"></a>nice_exposure_name <span class="ot">=</span>  stringr<span class="sc">::</span><span class="fu">str_to_sentence</span>(name_exposure)</span>
<span id="cb4-125"><a href="#cb4-125"></a>nice_outcome_name <span class="ot">=</span> <span class="st">"Wellbeing"</span></span>
<span id="cb4-126"><a href="#cb4-126"></a>title <span class="ot">=</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Effect of {nice_exposure_name} on {nice_outcome_name}"</span>)</span>
<span id="cb4-127"><a href="#cb4-127"></a>title</span>
<span id="cb4-128"><a href="#cb4-128"></a><span class="co"># save for final rport</span></span>
<span id="cb4-129"><a href="#cb4-129"></a><span class="fu">here_save</span>(title, <span class="st">"title"</span>)</span>
<span id="cb4-130"><a href="#cb4-130"></a></span>
<span id="cb4-131"><a href="#cb4-131"></a><span class="co"># combine outcomes ---------------------------------------------------------</span></span>
<span id="cb4-132"><a href="#cb4-132"></a><span class="co"># check outcome vars and make labels for graphs/tables</span></span>
<span id="cb4-133"><a href="#cb4-133"></a>outcome_vars</span>
<span id="cb4-134"><a href="#cb4-134"></a></span>
<span id="cb4-135"><a href="#cb4-135"></a>label_mapping_all <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-136"><a href="#cb4-136"></a>  <span class="co">#"t2_alcohol_frequency_weekly_z" = "Alcohol Frequency",</span></span>
<span id="cb4-137"><a href="#cb4-137"></a>  <span class="co">#"t2_alcohol_intensity_weekly_z" = "Alcohol Intensity",</span></span>
<span id="cb4-138"><a href="#cb4-138"></a>  <span class="co">#"t2_hlth_bmi_z" = "BMI",</span></span>
<span id="cb4-139"><a href="#cb4-139"></a>  <span class="co">#"t2_hlth_sleep_hours_z" = "Sleep",</span></span>
<span id="cb4-140"><a href="#cb4-140"></a>  <span class="st">"t2_log_hours_exercise_z"</span> <span class="ot">=</span> <span class="st">"Hours of Exercise (log)"</span>,</span>
<span id="cb4-141"><a href="#cb4-141"></a>  <span class="co">#"t2_short_form_health_z" = "Short Form Health"</span></span>
<span id="cb4-142"><a href="#cb4-142"></a>  <span class="st">"t2_hlth_fatigue_z"</span> <span class="ot">=</span> <span class="st">"Fatigue"</span>,</span>
<span id="cb4-143"><a href="#cb4-143"></a>  <span class="st">"t2_kessler_latent_anxiety_z"</span> <span class="ot">=</span> <span class="st">"Anxiety"</span>,</span>
<span id="cb4-144"><a href="#cb4-144"></a>  <span class="st">"t2_kessler_latent_depression_z"</span> <span class="ot">=</span> <span class="st">"Depression"</span>,</span>
<span id="cb4-145"><a href="#cb4-145"></a>  <span class="st">"t2_rumination_z"</span> <span class="ot">=</span> <span class="st">"Rumination"</span>,</span>
<span id="cb4-146"><a href="#cb4-146"></a>  <span class="co"># "t2_bodysat_z" = "Body Satisfaction",</span></span>
<span id="cb4-147"><a href="#cb4-147"></a>  <span class="st">"t2_foregiveness_z"</span> <span class="ot">=</span> <span class="st">"Forgiveness"</span>,</span>
<span id="cb4-148"><a href="#cb4-148"></a>  <span class="st">"t2_perfectionism_z"</span> <span class="ot">=</span> <span class="st">"Perfectionism"</span>, </span>
<span id="cb4-149"><a href="#cb4-149"></a>  <span class="st">"t2_self_esteem_z"</span> <span class="ot">=</span> <span class="st">"Self Esteem"</span>,</span>
<span id="cb4-150"><a href="#cb4-150"></a>  <span class="co"># "t2_self_control_z" = "Self Control",</span></span>
<span id="cb4-151"><a href="#cb4-151"></a>  <span class="co"># "t2_sexual_satisfaction_z" = "Sexual Satisfaction".</span></span>
<span id="cb4-152"><a href="#cb4-152"></a>  <span class="st">"t2_gratitude_z"</span> <span class="ot">=</span> <span class="st">"Gratitude"</span>,</span>
<span id="cb4-153"><a href="#cb4-153"></a>  <span class="st">"t2_lifesat_z"</span> <span class="ot">=</span> <span class="st">"Life Satisfaction"</span>,</span>
<span id="cb4-154"><a href="#cb4-154"></a>  <span class="st">"t2_meaning_purpose_z"</span> <span class="ot">=</span> <span class="st">"Meaning: Purpose"</span>,</span>
<span id="cb4-155"><a href="#cb4-155"></a>  <span class="st">"t2_meaning_sense_z"</span> <span class="ot">=</span> <span class="st">"Meaning: Sense"</span>,</span>
<span id="cb4-156"><a href="#cb4-156"></a>  <span class="st">"t2_pwi_z"</span> <span class="ot">=</span> <span class="st">"Personal Well-being Index"</span>,</span>
<span id="cb4-157"><a href="#cb4-157"></a>  <span class="st">"t2_belong_z"</span> <span class="ot">=</span> <span class="st">"Social Belonging"</span>,</span>
<span id="cb4-158"><a href="#cb4-158"></a>  <span class="st">"t2_neighbourhood_community_z"</span> <span class="ot">=</span> <span class="st">"Neighbourhood Community"</span>,</span>
<span id="cb4-159"><a href="#cb4-159"></a>  <span class="st">"t2_support_z"</span> <span class="ot">=</span> <span class="st">"Social Support"</span></span>
<span id="cb4-160"><a href="#cb4-160"></a>)</span>
<span id="cb4-161"><a href="#cb4-161"></a></span>
<span id="cb4-162"><a href="#cb4-162"></a></span>
<span id="cb4-163"><a href="#cb4-163"></a><span class="co"># save</span></span>
<span id="cb4-164"><a href="#cb4-164"></a><span class="fu">here_save</span>(label_mapping_all, <span class="st">"label_mapping_all"</span>)</span>
<span id="cb4-165"><a href="#cb4-165"></a></span>
<span id="cb4-166"><a href="#cb4-166"></a><span class="co"># check</span></span>
<span id="cb4-167"><a href="#cb4-167"></a>label_mapping_all</span>
<span id="cb4-168"><a href="#cb4-168"></a></span>
<span id="cb4-169"><a href="#cb4-169"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"created and saved label_mapping for use in graphs/tables ✔"</span>)</span>
<span id="cb4-170"><a href="#cb4-170"></a></span>
<span id="cb4-171"><a href="#cb4-171"></a></span>
<span id="cb4-172"><a href="#cb4-172"></a><span class="co"># make options -------------------------------------------------------------</span></span>
<span id="cb4-173"><a href="#cb4-173"></a><span class="co"># titles</span></span>
<span id="cb4-174"><a href="#cb4-174"></a>ate_title <span class="ot">=</span> <span class="st">"ATE Effects of {{nice_name_exposure}} on {{nice_name_outcome}}"</span></span>
<span id="cb4-175"><a href="#cb4-175"></a>subtitle <span class="ot">=</span> <span class="st">""</span></span>
<span id="cb4-176"><a href="#cb4-176"></a>filename_prefix <span class="ot">=</span> <span class="st">"final_report"</span></span>
<span id="cb4-177"><a href="#cb4-177"></a><span class="co">#</span></span>
<span id="cb4-178"><a href="#cb4-178"></a><span class="fu">here_save</span>(ate_title, <span class="st">"ate_title"</span>)</span>
<span id="cb4-179"><a href="#cb4-179"></a><span class="fu">here_save</span>(filename_prefix, <span class="st">"filename_prefix"</span>)</span>
<span id="cb4-180"><a href="#cb4-180"></a></span>
<span id="cb4-181"><a href="#cb4-181"></a><span class="co"># settings</span></span>
<span id="cb4-182"><a href="#cb4-182"></a>x_offset <span class="ot">=</span> <span class="sc">-</span>.<span class="dv">25</span></span>
<span id="cb4-183"><a href="#cb4-183"></a>x_lim_lo <span class="ot">=</span> <span class="sc">-</span>.<span class="dv">25</span></span>
<span id="cb4-184"><a href="#cb4-184"></a>x_lim_hi <span class="ot">=</span> .<span class="dv">25</span></span>
<span id="cb4-185"><a href="#cb4-185"></a></span>
<span id="cb4-186"><a href="#cb4-186"></a></span>
<span id="cb4-187"><a href="#cb4-187"></a><span class="co"># defaults for ate plots</span></span>
<span id="cb4-188"><a href="#cb4-188"></a>base_defaults_binary <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-189"><a href="#cb4-189"></a>  <span class="at">type =</span> <span class="st">"RD"</span>,</span>
<span id="cb4-190"><a href="#cb4-190"></a>  <span class="at">title =</span> ate_title,</span>
<span id="cb4-191"><a href="#cb4-191"></a>  <span class="at">e_val_bound_threshold =</span> <span class="fl">1.2</span>,</span>
<span id="cb4-192"><a href="#cb4-192"></a>  <span class="at">colors =</span> <span class="fu">c</span>(</span>
<span id="cb4-193"><a href="#cb4-193"></a>    <span class="st">"positive"</span> <span class="ot">=</span> <span class="st">"#E69F00"</span>,</span>
<span id="cb4-194"><a href="#cb4-194"></a>    <span class="st">"not reliable"</span> <span class="ot">=</span> <span class="st">"grey50"</span>,</span>
<span id="cb4-195"><a href="#cb4-195"></a>    <span class="st">"negative"</span> <span class="ot">=</span> <span class="st">"#56B4E9"</span></span>
<span id="cb4-196"><a href="#cb4-196"></a>  ),</span>
<span id="cb4-197"><a href="#cb4-197"></a>  <span class="at">x_offset =</span> x_offset,</span>
<span id="cb4-198"><a href="#cb4-198"></a>  <span class="co"># will be set based on type</span></span>
<span id="cb4-199"><a href="#cb4-199"></a>  <span class="at">x_lim_lo =</span> x_lim_lo,</span>
<span id="cb4-200"><a href="#cb4-200"></a>  <span class="co"># will be set based on type</span></span>
<span id="cb4-201"><a href="#cb4-201"></a>  <span class="at">x_lim_hi =</span> x_lim_hi,</span>
<span id="cb4-202"><a href="#cb4-202"></a>  <span class="at">text_size =</span> <span class="dv">8</span>,</span>
<span id="cb4-203"><a href="#cb4-203"></a>  <span class="at">linewidth =</span> <span class="fl">0.75</span>,</span>
<span id="cb4-204"><a href="#cb4-204"></a>  <span class="at">estimate_scale =</span> <span class="dv">1</span>,</span>
<span id="cb4-205"><a href="#cb4-205"></a>  <span class="at">base_size =</span> <span class="dv">18</span>,</span>
<span id="cb4-206"><a href="#cb4-206"></a>  <span class="at">point_size =</span> <span class="dv">4</span>,</span>
<span id="cb4-207"><a href="#cb4-207"></a>  <span class="at">title_size =</span> <span class="dv">19</span>,</span>
<span id="cb4-208"><a href="#cb4-208"></a>  <span class="at">subtitle_size =</span> <span class="dv">16</span>,</span>
<span id="cb4-209"><a href="#cb4-209"></a>  <span class="at">legend_text_size =</span> <span class="dv">10</span>,</span>
<span id="cb4-210"><a href="#cb4-210"></a>  <span class="at">legend_title_size =</span> <span class="dv">10</span>,</span>
<span id="cb4-211"><a href="#cb4-211"></a>  <span class="at">include_coefficients =</span> <span class="cn">FALSE</span></span>
<span id="cb4-212"><a href="#cb4-212"></a>)</span>
<span id="cb4-213"><a href="#cb4-213"></a></span>
<span id="cb4-214"><a href="#cb4-214"></a><span class="co"># save</span></span>
<span id="cb4-215"><a href="#cb4-215"></a></span>
<span id="cb4-216"><a href="#cb4-216"></a><span class="co"># health graph options</span></span>
<span id="cb4-217"><a href="#cb4-217"></a>outcomes_options_all <span class="ot">&lt;-</span> <span class="fu">margot_plot_create_options</span>(</span>
<span id="cb4-218"><a href="#cb4-218"></a>  <span class="at">title =</span> subtitle,</span>
<span id="cb4-219"><a href="#cb4-219"></a>  <span class="at">base_defaults =</span> base_defaults_binary,</span>
<span id="cb4-220"><a href="#cb4-220"></a>  <span class="at">subtitle =</span> subtitle,</span>
<span id="cb4-221"><a href="#cb4-221"></a>  <span class="at">filename_prefix =</span> filename_prefix</span>
<span id="cb4-222"><a href="#cb4-222"></a>)</span>
<span id="cb4-223"><a href="#cb4-223"></a></span>
<span id="cb4-224"><a href="#cb4-224"></a></span>
<span id="cb4-225"><a href="#cb4-225"></a><span class="co"># policy tree graph settings ----------------------------------------------</span></span>
<span id="cb4-226"><a href="#cb4-226"></a>decision_tree_defaults <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-227"><a href="#cb4-227"></a>  <span class="at">span_ratio       =</span> .<span class="dv">3</span>,</span>
<span id="cb4-228"><a href="#cb4-228"></a>  <span class="at">text_size        =</span> <span class="fl">3.8</span>,</span>
<span id="cb4-229"><a href="#cb4-229"></a>  <span class="at">y_padding        =</span> <span class="fl">0.25</span>,</span>
<span id="cb4-230"><a href="#cb4-230"></a>  <span class="at">edge_label_offset =</span> .<span class="dv">002</span>,</span>
<span id="cb4-231"><a href="#cb4-231"></a>  <span class="at">border_size      =</span> .<span class="dv">05</span></span>
<span id="cb4-232"><a href="#cb4-232"></a>)</span>
<span id="cb4-233"><a href="#cb4-233"></a>policy_tree_defaults <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-234"><a href="#cb4-234"></a>  <span class="at">point_alpha       =</span> .<span class="dv">5</span>,</span>
<span id="cb4-235"><a href="#cb4-235"></a>  <span class="at">title_size        =</span> <span class="dv">12</span>,</span>
<span id="cb4-236"><a href="#cb4-236"></a>  <span class="at">subtitle_size     =</span> <span class="dv">12</span>,</span>
<span id="cb4-237"><a href="#cb4-237"></a>  <span class="at">axis_title_size   =</span> <span class="dv">12</span>,</span>
<span id="cb4-238"><a href="#cb4-238"></a>  <span class="at">legend_title_size =</span> <span class="dv">12</span>,</span>
<span id="cb4-239"><a href="#cb4-239"></a>  <span class="at">split_line_color  =</span> <span class="st">"red"</span>,</span>
<span id="cb4-240"><a href="#cb4-240"></a>  <span class="at">split_line_alpha  =</span> .<span class="dv">8</span>,</span>
<span id="cb4-241"><a href="#cb4-241"></a>  <span class="at">split_label_color =</span> <span class="st">"red"</span>,</span>
<span id="cb4-242"><a href="#cb4-242"></a>  <span class="fu">list</span>(<span class="at">split_label_nudge_factor =</span> <span class="fl">0.007</span>)</span>
<span id="cb4-243"><a href="#cb4-243"></a>)</span>
<span id="cb4-244"><a href="#cb4-244"></a></span>
<span id="cb4-245"><a href="#cb4-245"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-246"><a href="#cb4-246"></a><span class="co"># |   </span><span class="re">END</span><span class="co"> MODIFY SECTION     |</span></span>
<span id="cb4-247"><a href="#cb4-247"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-248"><a href="#cb4-248"></a></span>
<span id="cb4-249"><a href="#cb4-249"></a><span class="co"># +----------------------------------------------+</span></span>
<span id="cb4-250"><a href="#cb4-250"></a><span class="co"># |       DO NOT ALTER  (except where noted)     |</span></span>
<span id="cb4-251"><a href="#cb4-251"></a><span class="co"># +----------------------------------------------+</span></span>
<span id="cb4-252"><a href="#cb4-252"></a><span class="fu">str</span>(df_grf)</span>
<span id="cb4-253"><a href="#cb4-253"></a><span class="co"># load GRF data and prepare inputs ----------------------------------------</span></span>
<span id="cb4-254"><a href="#cb4-254"></a>df_grf <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">'df_grf'</span>, push_mods)</span>
<span id="cb4-255"><a href="#cb4-255"></a>E      <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">'E'</span>,      push_mods)</span>
<span id="cb4-256"><a href="#cb4-256"></a></span>
<span id="cb4-257"><a href="#cb4-257"></a><span class="co"># check exposure binary</span></span>
<span id="cb4-258"><a href="#cb4-258"></a><span class="fu">stopifnot</span>(<span class="fu">all</span>(df_grf[[t1_name_exposure_binary]][<span class="sc">!</span><span class="fu">is.na</span>(df_grf[[t1_name_exposure_binary]])] <span class="sc">%in%</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>))</span>
<span id="cb4-259"><a href="#cb4-259"></a><span class="co"># set exposure and weights</span></span>
<span id="cb4-260"><a href="#cb4-260"></a></span>
<span id="cb4-261"><a href="#cb4-261"></a>W       <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(df_grf[[t1_name_exposure_binary]]) <span class="co"># note it is the processed weights for attrition "t1"</span></span>
<span id="cb4-262"><a href="#cb4-262"></a></span>
<span id="cb4-263"><a href="#cb4-263"></a><span class="co"># old workflow</span></span>
<span id="cb4-264"><a href="#cb4-264"></a><span class="co"># weights &lt;- df_grf$t1_adjusted_weights</span></span>
<span id="cb4-265"><a href="#cb4-265"></a></span>
<span id="cb4-266"><a href="#cb4-266"></a><span class="co"># new weights workflow, use "combo_weights" -- see revised script 2</span></span>
<span id="cb4-267"><a href="#cb4-267"></a>weights<span class="ot">&lt;-</span> df_grf<span class="sc">$</span>combo_weights</span>
<span id="cb4-268"><a href="#cb4-268"></a></span>
<span id="cb4-269"><a href="#cb4-269"></a><span class="fu">hist</span>(weights) <span class="co"># quick check for extreme weights</span></span>
<span id="cb4-270"><a href="#cb4-270"></a><span class="co"># select covariates and drop numeric attributes</span></span>
<span id="cb4-271"><a href="#cb4-271"></a>X <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">remove_numeric_attributes</span>(df_grf[E])</span>
<span id="cb4-272"><a href="#cb4-272"></a></span>
<span id="cb4-273"><a href="#cb4-273"></a><span class="co"># set model defaults -----------------------------------------------------</span></span>
<span id="cb4-274"><a href="#cb4-274"></a>grf_defaults <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">seed =</span> <span class="dv">123</span>, <span class="at">stabilize.splits =</span> <span class="cn">TRUE</span>, <span class="at">num.trees =</span> <span class="dv">2000</span>)</span>
<span id="cb4-275"><a href="#cb4-275"></a></span>
<span id="cb4-276"><a href="#cb4-276"></a></span>
<span id="cb4-277"><a href="#cb4-277"></a><span class="co"># causal forest model -----------------------------------------------------------</span></span>
<span id="cb4-278"><a href="#cb4-278"></a></span>
<span id="cb4-279"><a href="#cb4-279"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-280"><a href="#cb4-280"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb4-281"><a href="#cb4-281"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-282"><a href="#cb4-282"></a></span>
<span id="cb4-283"><a href="#cb4-283"></a></span>
<span id="cb4-284"><a href="#cb4-284"></a></span>
<span id="cb4-285"><a href="#cb4-285"></a></span>
<span id="cb4-286"><a href="#cb4-286"></a></span>
<span id="cb4-287"><a href="#cb4-287"></a></span>
<span id="cb4-288"><a href="#cb4-288"></a><span class="co"># !!!! THIS WILL TAKE TIME  !!!!!</span></span>
<span id="cb4-289"><a href="#cb4-289"></a><span class="co"># **----- COMMENT OUT AFTER YOU RUN TO AVOID RUNNING MORE THAN ONCE -----** </span></span>
<span id="cb4-290"><a href="#cb4-290"></a></span>
<span id="cb4-291"><a href="#cb4-291"></a></span>
<span id="cb4-292"><a href="#cb4-292"></a>models_binary <span class="ot">&lt;-</span> <span class="fu">margot_causal_forest_parallel</span>(</span>
<span id="cb4-293"><a href="#cb4-293"></a>  <span class="at">data =</span> df_grf,</span>
<span id="cb4-294"><a href="#cb4-294"></a>  <span class="at">outcome_vars =</span> t2_outcome_z,</span>
<span id="cb4-295"><a href="#cb4-295"></a>  <span class="at">covariates =</span> X,</span>
<span id="cb4-296"><a href="#cb4-296"></a>  <span class="at">W =</span> W,</span>
<span id="cb4-297"><a href="#cb4-297"></a>  <span class="at">weights =</span> weights,</span>
<span id="cb4-298"><a href="#cb4-298"></a>  <span class="at">grf_defaults =</span> grf_defaults,</span>
<span id="cb4-299"><a href="#cb4-299"></a>  <span class="at">top_n_vars =</span> <span class="dv">15</span>,</span>
<span id="cb4-300"><a href="#cb4-300"></a>  <span class="at">save_models =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-301"><a href="#cb4-301"></a>  <span class="at">save_data =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-302"><a href="#cb4-302"></a>  <span class="at">train_proportion =</span> <span class="fl">0.7</span></span>
<span id="cb4-303"><a href="#cb4-303"></a>)</span>
<span id="cb4-304"><a href="#cb4-304"></a></span>
<span id="cb4-305"><a href="#cb4-305"></a></span>
<span id="cb4-306"><a href="#cb4-306"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-307"><a href="#cb4-307"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb4-308"><a href="#cb4-308"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-309"><a href="#cb4-309"></a><span class="co"># !!!! THIS WILL TAKE TIME  !!!!!</span></span>
<span id="cb4-310"><a href="#cb4-310"></a><span class="co"># save model</span></span>
<span id="cb4-311"><a href="#cb4-311"></a>margot<span class="sc">::</span><span class="fu">here_save_qs</span>(models_binary, <span class="st">"models_binary"</span>, push_mods)</span>
<span id="cb4-312"><a href="#cb4-312"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-313"><a href="#cb4-313"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb4-314"><a href="#cb4-314"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-315"><a href="#cb4-315"></a></span>
<span id="cb4-316"><a href="#cb4-316"></a></span>
<span id="cb4-317"><a href="#cb4-317"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"causal forest model completed and saved ✔"</span>)</span>
<span id="cb4-318"><a href="#cb4-318"></a></span>
<span id="cb4-319"><a href="#cb4-319"></a></span>
<span id="cb4-320"><a href="#cb4-320"></a><span class="co"># read results ------------------------------------------------------------</span></span>
<span id="cb4-321"><a href="#cb4-321"></a><span class="co"># if you save models you do not need to re-run them</span></span>
<span id="cb4-322"><a href="#cb4-322"></a></span>
<span id="cb4-323"><a href="#cb4-323"></a></span>
<span id="cb4-324"><a href="#cb4-324"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-325"><a href="#cb4-325"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb4-326"><a href="#cb4-326"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-327"><a href="#cb4-327"></a><span class="co"># !!!! THIS WILL TAKE TIME  !!!!!</span></span>
<span id="cb4-328"><a href="#cb4-328"></a>models_binary <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read_qs</span>(<span class="st">"models_binary"</span>, push_mods)</span>
<span id="cb4-329"><a href="#cb4-329"></a></span>
<span id="cb4-330"><a href="#cb4-330"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-331"><a href="#cb4-331"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb4-332"><a href="#cb4-332"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-333"><a href="#cb4-333"></a></span>
<span id="cb4-334"><a href="#cb4-334"></a><span class="co"># count models by category</span></span>
<span id="cb4-335"><a href="#cb4-335"></a><span class="co"># just a check</span></span>
<span id="cb4-336"><a href="#cb4-336"></a><span class="fu">cat</span>(<span class="st">"Number of original models:</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">length</span>(models_binary<span class="sc">$</span>results), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-337"><a href="#cb4-337"></a></span>
<span id="cb4-338"><a href="#cb4-338"></a><span class="co"># make ate plots ----------------------------------------------------------</span></span>
<span id="cb4-339"><a href="#cb4-339"></a><span class="co">#   ************* NEW - CORRECTION FOR FAMILY-WISE ERROR **********</span></span>
<span id="cb4-340"><a href="#cb4-340"></a><span class="co"># then pass to the results</span></span>
<span id="cb4-341"><a href="#cb4-341"></a>ate_results <span class="ot">&lt;-</span> <span class="fu">margot_plot</span>(</span>
<span id="cb4-342"><a href="#cb4-342"></a>  models_binary<span class="sc">$</span>combined_table, <span class="co"># &lt;- now pass the corrected results.</span></span>
<span id="cb4-343"><a href="#cb4-343"></a>  <span class="at">options =</span> outcomes_options_all,</span>
<span id="cb4-344"><a href="#cb4-344"></a>  <span class="at">label_mapping =</span> label_mapping_all,</span>
<span id="cb4-345"><a href="#cb4-345"></a>  <span class="at">include_coefficients =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-346"><a href="#cb4-346"></a>  <span class="at">save_output =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-347"><a href="#cb4-347"></a>  <span class="at">order =</span> <span class="st">"evaluebound_asc"</span>,</span>
<span id="cb4-348"><a href="#cb4-348"></a>  <span class="at">original_df =</span> original_df,</span>
<span id="cb4-349"><a href="#cb4-349"></a>  <span class="at">e_val_bound_threshold =</span> <span class="fl">1.2</span>,</span>
<span id="cb4-350"><a href="#cb4-350"></a>  <span class="at">rename_ate =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-351"><a href="#cb4-351"></a>  <span class="at">adjust =</span> <span class="st">"bonferroni"</span>, <span class="co">#&lt;- new </span></span>
<span id="cb4-352"><a href="#cb4-352"></a>  <span class="at">alpha =</span> <span class="fl">0.05</span> <span class="co"># &lt;- new </span></span>
<span id="cb4-353"><a href="#cb4-353"></a>)</span>
<span id="cb4-354"><a href="#cb4-354"></a></span>
<span id="cb4-355"><a href="#cb4-355"></a></span>
<span id="cb4-356"><a href="#cb4-356"></a><span class="co"># view</span></span>
<span id="cb4-357"><a href="#cb4-357"></a><span class="fu">cat</span>(ate_results<span class="sc">$</span>interpretation)</span>
<span id="cb4-358"><a href="#cb4-358"></a></span>
<span id="cb4-359"><a href="#cb4-359"></a><span class="co"># check</span></span>
<span id="cb4-360"><a href="#cb4-360"></a>ate_results<span class="sc">$</span>plot</span>
<span id="cb4-361"><a href="#cb4-361"></a></span>
<span id="cb4-362"><a href="#cb4-362"></a><span class="co"># interpretation</span></span>
<span id="cb4-363"><a href="#cb4-363"></a><span class="fu">cat</span>(ate_results<span class="sc">$</span>interpretation)</span>
<span id="cb4-364"><a href="#cb4-364"></a></span>
<span id="cb4-365"><a href="#cb4-365"></a><span class="co"># save</span></span>
<span id="cb4-366"><a href="#cb4-366"></a><span class="fu">here_save_qs</span>(ate_results, <span class="st">"ate_results"</span>, push_mods)</span>
<span id="cb4-367"><a href="#cb4-367"></a></span>
<span id="cb4-368"><a href="#cb4-368"></a></span>
<span id="cb4-369"><a href="#cb4-369"></a><span class="co"># make markdown tables (to be imported into the manuscript)</span></span>
<span id="cb4-370"><a href="#cb4-370"></a>margot_bind_tables_markdown <span class="ot">&lt;-</span> <span class="fu">margot_bind_tables</span>(</span>
<span id="cb4-371"><a href="#cb4-371"></a>  ate_results<span class="sc">$</span>transformed_table,</span>
<span id="cb4-372"><a href="#cb4-372"></a>  <span class="co">#list(all_models$combined_table),</span></span>
<span id="cb4-373"><a href="#cb4-373"></a>  <span class="at">sort_E_val_bound =</span> <span class="st">"desc"</span>,</span>
<span id="cb4-374"><a href="#cb4-374"></a>  <span class="at">e_val_bound_threshold =</span> <span class="fl">1.2</span>,</span>
<span id="cb4-375"><a href="#cb4-375"></a>  <span class="co"># ← choose threshold</span></span>
<span id="cb4-376"><a href="#cb4-376"></a>  <span class="at">highlight_color =</span> <span class="cn">NULL</span>,</span>
<span id="cb4-377"><a href="#cb4-377"></a>  <span class="at">bold =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-378"><a href="#cb4-378"></a>  <span class="at">rename_cols =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-379"><a href="#cb4-379"></a>  <span class="at">col_renames =</span> <span class="fu">list</span>(<span class="st">"E-Value"</span> <span class="ot">=</span> <span class="st">"E_Value"</span>, <span class="st">"E-Value bound"</span> <span class="ot">=</span> <span class="st">"E_Val_bound"</span>),</span>
<span id="cb4-380"><a href="#cb4-380"></a>  <span class="at">rename_ate =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-381"><a href="#cb4-381"></a>  <span class="at">threshold_col =</span> <span class="st">"E_Val_bound"</span>,</span>
<span id="cb4-382"><a href="#cb4-382"></a>  <span class="at">output_format =</span> <span class="st">"markdown"</span>,</span>
<span id="cb4-383"><a href="#cb4-383"></a>  <span class="at">kbl_args =</span> <span class="fu">list</span>(</span>
<span id="cb4-384"><a href="#cb4-384"></a>    <span class="at">booktabs =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-385"><a href="#cb4-385"></a>    <span class="at">caption =</span> <span class="cn">NULL</span>,</span>
<span id="cb4-386"><a href="#cb4-386"></a>    <span class="at">align =</span> <span class="cn">NULL</span></span>
<span id="cb4-387"><a href="#cb4-387"></a>  )</span>
<span id="cb4-388"><a href="#cb4-388"></a>)</span>
<span id="cb4-389"><a href="#cb4-389"></a></span>
<span id="cb4-390"><a href="#cb4-390"></a><span class="co"># view markdown table</span></span>
<span id="cb4-391"><a href="#cb4-391"></a>margot_bind_tables_markdown</span>
<span id="cb4-392"><a href="#cb4-392"></a></span>
<span id="cb4-393"><a href="#cb4-393"></a><span class="co"># save for publication</span></span>
<span id="cb4-394"><a href="#cb4-394"></a><span class="fu">here_save</span>(margot_bind_tables_markdown, <span class="st">"margot_bind_tables_markdown"</span>)</span>
<span id="cb4-395"><a href="#cb4-395"></a></span>
<span id="cb4-396"><a href="#cb4-396"></a></span>
<span id="cb4-397"><a href="#cb4-397"></a><span class="co"># evaluate models ---------------------------------------------------------</span></span>
<span id="cb4-398"><a href="#cb4-398"></a><span class="co"># trim models if extreme propensity scores dominate</span></span>
<span id="cb4-399"><a href="#cb4-399"></a><span class="co"># diag_tbl_98 &lt;- margot_inspect_qini(models_binary,</span></span>
<span id="cb4-400"><a href="#cb4-400"></a><span class="co">#                                        propensity_bounds = c(0.01, 0.99))</span></span>
<span id="cb4-401"><a href="#cb4-401"></a></span>
<span id="cb4-402"><a href="#cb4-402"></a></span>
<span id="cb4-403"><a href="#cb4-403"></a></span>
<span id="cb4-404"><a href="#cb4-404"></a></span>
<span id="cb4-405"><a href="#cb4-405"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-406"><a href="#cb4-406"></a><span class="co"># |     </span><span class="re">END</span><span class="co"> DO NOT ALTER     |</span></span>
<span id="cb4-407"><a href="#cb4-407"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-408"><a href="#cb4-408"></a></span>
<span id="cb4-409"><a href="#cb4-409"></a></span>
<span id="cb4-410"><a href="#cb4-410"></a></span>
<span id="cb4-411"><a href="#cb4-411"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-412"><a href="#cb4-412"></a><span class="co"># |    MODIFY THIS SECTION   |</span></span>
<span id="cb4-413"><a href="#cb4-413"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-414"><a href="#cb4-414"></a></span>
<span id="cb4-415"><a href="#cb4-415"></a></span>
<span id="cb4-416"><a href="#cb4-416"></a><span class="co"># FLIPPING OUTCOMES  ------------------------------------------------------</span></span>
<span id="cb4-417"><a href="#cb4-417"></a></span>
<span id="cb4-418"><a href="#cb4-418"></a><span class="co"># note that the meaning of a heterogeneity will vary depending on our interests.</span></span>
<span id="cb4-419"><a href="#cb4-419"></a><span class="co"># typically we are interested in whether an exposure improves life, and whether there is variability (aka HTE) in degrees of improvement.</span></span>
<span id="cb4-420"><a href="#cb4-420"></a><span class="co"># in this case we must take negative outcomes and "flip" them -- recalculating the policy trees and qini curves for each</span></span>
<span id="cb4-421"><a href="#cb4-421"></a><span class="co"># for example if the outcome is depression, then by flipping depression we better understand how the exposure *reduces* depression. </span></span>
<span id="cb4-422"><a href="#cb4-422"></a><span class="co"># what if the exposure is harmful? say what if we are interested in the effect of depression on wellbeing? In that case, we might</span></span>
<span id="cb4-423"><a href="#cb4-423"></a><span class="co"># want to "flip" the positive outcomes. That is, we might want to understand for whom a negative exposure is extra harmful. </span></span>
<span id="cb4-424"><a href="#cb4-424"></a><span class="co"># here we imagine that extroversion is generally positive in its effects, and so we "flip" the negative outcomes. </span></span>
<span id="cb4-425"><a href="#cb4-425"></a><span class="co"># if you were interested in a negative exposure, say "neuroticism" then you would probably want to flip the positive outcomes. </span></span>
<span id="cb4-426"><a href="#cb4-426"></a><span class="co"># note there are further questions we might ask. We might consider who responds more 'weakly" to a negative exposure (or perhaps to a positive exposure).</span></span>
<span id="cb4-427"><a href="#cb4-427"></a><span class="co"># Such a question could make sense if we had an exposure that was generally very strong. </span></span>
<span id="cb4-428"><a href="#cb4-428"></a><span class="co"># however, let's stay focussed on evaluating evaluating strong responders. We will flip the negative outcomes if we expect the exposure is positive,</span></span>
<span id="cb4-429"><a href="#cb4-429"></a><span class="co"># and flip the positive outcomes if we expect the exposure to be generally negative. </span></span>
<span id="cb4-430"><a href="#cb4-430"></a><span class="co"># if there is no natural "positive" or negative, then just make sure the valence of the outcomes aligns, so that all are oriented in the same </span></span>
<span id="cb4-431"><a href="#cb4-431"></a><span class="co"># direction if they have a valence.  if unsure, just ask for help!</span></span>
<span id="cb4-432"><a href="#cb4-432"></a></span>
<span id="cb4-433"><a href="#cb4-433"></a><span class="co"># flipping models: outcomes we want to minimise given the exposure --------</span></span>
<span id="cb4-434"><a href="#cb4-434"></a><span class="co"># standard negative outcomes/  not used in this example</span></span>
<span id="cb4-435"><a href="#cb4-435"></a><span class="co"># flipping models: outcomes we want to minimise given the exposure --------</span></span>
<span id="cb4-436"><a href="#cb4-436"></a><span class="co"># standard negative outcomes/  not used in this example</span></span>
<span id="cb4-437"><a href="#cb4-437"></a></span>
<span id="cb4-438"><a href="#cb4-438"></a></span>
<span id="cb4-439"><a href="#cb4-439"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-440"><a href="#cb4-440"></a><span class="co"># |    MODIFY THIS           |</span></span>
<span id="cb4-441"><a href="#cb4-441"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-442"><a href="#cb4-442"></a></span>
<span id="cb4-443"><a href="#cb4-443"></a><span class="co"># WHICH OUTCOMES -- if any ARE UNDESIREABLE? </span></span>
<span id="cb4-444"><a href="#cb4-444"></a>flip_outcomes_standard <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb4-445"><a href="#cb4-445"></a>  <span class="co">#"t2_alcohol_frequency_weekly_z",</span></span>
<span id="cb4-446"><a href="#cb4-446"></a>  <span class="co">#"t2_alcohol_intensity_z",</span></span>
<span id="cb4-447"><a href="#cb4-447"></a>  <span class="co">#"t2_hlth_bmi_z",</span></span>
<span id="cb4-448"><a href="#cb4-448"></a>  <span class="co">#"t2_hlth_fatigue_z",</span></span>
<span id="cb4-449"><a href="#cb4-449"></a>  <span class="st">"t2_kessler_latent_anxiety_z"</span>, <span class="co">#  ← select</span></span>
<span id="cb4-450"><a href="#cb4-450"></a>  <span class="st">"t2_kessler_latent_depression_z"</span>,<span class="co">#  ← select</span></span>
<span id="cb4-451"><a href="#cb4-451"></a>  <span class="st">"t2_rumination_z"</span> <span class="co">#  ← select</span></span>
<span id="cb4-452"><a href="#cb4-452"></a>  <span class="co">#"t2_perfectionism_z" # the exposure variable was not investigated</span></span>
<span id="cb4-453"><a href="#cb4-453"></a>)</span>
<span id="cb4-454"><a href="#cb4-454"></a></span>
<span id="cb4-455"><a href="#cb4-455"></a><span class="co"># when exposure is negative and you want to focus on how much worse off</span></span>
<span id="cb4-456"><a href="#cb4-456"></a></span>
<span id="cb4-457"><a href="#cb4-457"></a><span class="co"># </span><span class="al">NOTE</span><span class="co"> IF THE EXPOSURE IS NEGATIVE, FOCUS ON WHICH OUTCOMES, if any, ARE POSITIVE AND FLIP THESE?</span></span>
<span id="cb4-458"><a href="#cb4-458"></a><span class="co"># flip_outcomes&lt;- c( setdiff(t2_outcomes_all, flip_outcomes_standard) )</span></span>
<span id="cb4-459"><a href="#cb4-459"></a></span>
<span id="cb4-460"><a href="#cb4-460"></a><span class="co"># our example has the exposure as positive</span></span>
<span id="cb4-461"><a href="#cb4-461"></a>flip_outcomes <span class="ot">&lt;-</span> flip_outcomes_standard</span>
<span id="cb4-462"><a href="#cb4-462"></a></span>
<span id="cb4-463"><a href="#cb4-463"></a><span class="co"># check</span></span>
<span id="cb4-464"><a href="#cb4-464"></a>flip_outcomes</span>
<span id="cb4-465"><a href="#cb4-465"></a></span>
<span id="cb4-466"><a href="#cb4-466"></a></span>
<span id="cb4-467"><a href="#cb4-467"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-468"><a href="#cb4-468"></a><span class="co"># |   </span><span class="re">END</span><span class="co"> MODIFY             |</span></span>
<span id="cb4-469"><a href="#cb4-469"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-470"><a href="#cb4-470"></a></span>
<span id="cb4-471"><a href="#cb4-471"></a><span class="co"># get labels</span></span>
<span id="cb4-472"><a href="#cb4-472"></a>flipped_names <span class="ot">&lt;-</span> <span class="fu">margot_get_labels</span>(flip_outcomes, label_mapping_all)</span>
<span id="cb4-473"><a href="#cb4-473"></a></span>
<span id="cb4-474"><a href="#cb4-474"></a><span class="co"># check</span></span>
<span id="cb4-475"><a href="#cb4-475"></a>flipped_names</span>
<span id="cb4-476"><a href="#cb4-476"></a></span>
<span id="cb4-477"><a href="#cb4-477"></a><span class="co"># save for publication</span></span>
<span id="cb4-478"><a href="#cb4-478"></a><span class="fu">here_save</span>(flipped_names, <span class="st">"flipped_names"</span>)</span>
<span id="cb4-479"><a href="#cb4-479"></a></span>
<span id="cb4-480"><a href="#cb4-480"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"flipped outcomes identified and names saved ✔"</span>)</span>
<span id="cb4-481"><a href="#cb4-481"></a></span>
<span id="cb4-482"><a href="#cb4-482"></a></span>
<span id="cb4-483"><a href="#cb4-483"></a><span class="co"># flip negatively oriented outcomes --------------------------------------</span></span>
<span id="cb4-484"><a href="#cb4-484"></a></span>
<span id="cb4-485"><a href="#cb4-485"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-486"><a href="#cb4-486"></a><span class="co"># |       DO NOT ALTER       |</span></span>
<span id="cb4-487"><a href="#cb4-487"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-488"><a href="#cb4-488"></a></span>
<span id="cb4-489"><a href="#cb4-489"></a></span>
<span id="cb4-490"><a href="#cb4-490"></a><span class="co"># flip models using margot's function</span></span>
<span id="cb4-491"><a href="#cb4-491"></a></span>
<span id="cb4-492"><a href="#cb4-492"></a><span class="co">#  *** this will take some time ***</span></span>
<span id="cb4-493"><a href="#cb4-493"></a></span>
<span id="cb4-494"><a href="#cb4-494"></a><span class="co"># ** give it time **</span></span>
<span id="cb4-495"><a href="#cb4-495"></a><span class="co"># ** once run/ comment out **</span></span>
<span id="cb4-496"><a href="#cb4-496"></a></span>
<span id="cb4-497"><a href="#cb4-497"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-498"><a href="#cb4-498"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb4-499"><a href="#cb4-499"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-500"><a href="#cb4-500"></a><span class="co"># !!!! THIS WILL TAKE TIME  !!!!!</span></span>
<span id="cb4-501"><a href="#cb4-501"></a>models_binary_flipped_all <span class="ot">&lt;-</span> <span class="fu">margot_flip_forests_parallel</span>(models_binary,</span>
<span id="cb4-502"><a href="#cb4-502"></a>                                                 <span class="at">flip_outcomes =</span> flip_outcomes_standard,</span>
<span id="cb4-503"><a href="#cb4-503"></a>                                                 <span class="at">recalc_policy =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-504"><a href="#cb4-504"></a>                                                 <span class="at">max_size_GB =</span> <span class="dv">32</span>)</span>
<span id="cb4-505"><a href="#cb4-505"></a></span>
<span id="cb4-506"><a href="#cb4-506"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"flipped forest models completed ✔"</span>)</span>
<span id="cb4-507"><a href="#cb4-507"></a><span class="co"># !!!! THIS WILL TAKE TIME  !!!!!</span></span>
<span id="cb4-508"><a href="#cb4-508"></a><span class="co"># save</span></span>
<span id="cb4-509"><a href="#cb4-509"></a><span class="fu">here_save_qs</span>(models_binary_flipped_all, <span class="st">"models_binary_flipped_all"</span>, push_mods)</span>
<span id="cb4-510"><a href="#cb4-510"></a></span>
<span id="cb4-511"><a href="#cb4-511"></a></span>
<span id="cb4-512"><a href="#cb4-512"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-513"><a href="#cb4-513"></a><span class="co"># |          </span><span class="al">ALERT</span><span class="co">           |</span></span>
<span id="cb4-514"><a href="#cb4-514"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-515"><a href="#cb4-515"></a><span class="co"># !!!! THIS WILL TAKE TIME  !!!!!</span></span>
<span id="cb4-516"><a href="#cb4-516"></a><span class="co"># read back if needed</span></span>
<span id="cb4-517"><a href="#cb4-517"></a>models_binary_flipped_all <span class="ot">&lt;-</span> <span class="fu">here_read_qs</span>(<span class="st">"models_binary_flipped_all"</span>, push_mods)</span>
<span id="cb4-518"><a href="#cb4-518"></a></span>
<span id="cb4-519"><a href="#cb4-519"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-520"><a href="#cb4-520"></a><span class="co"># |        </span><span class="re">END</span><span class="co"> </span><span class="al">ALERT</span><span class="co">         |</span></span>
<span id="cb4-521"><a href="#cb4-521"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-522"><a href="#cb4-522"></a></span>
<span id="cb4-523"><a href="#cb4-523"></a></span>
<span id="cb4-524"><a href="#cb4-524"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-525"><a href="#cb4-525"></a><span class="co"># |       DO NOT ALTER       |</span></span>
<span id="cb4-526"><a href="#cb4-526"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-527"><a href="#cb4-527"></a><span class="co"># HTE analysis ------------------------------------------------------------</span></span>
<span id="cb4-528"><a href="#cb4-528"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb4-529"><a href="#cb4-529"></a><span class="co"># heterogeneity‐driven policy analysis – annotated workflow (depth = 2)</span></span>
<span id="cb4-530"><a href="#cb4-530"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb4-531"><a href="#cb4-531"></a><span class="co"># this script shows the **minimal** end‑to‑end path from a fitted set of</span></span>
<span id="cb4-532"><a href="#cb4-532"></a><span class="co"># causal‑forest models to depth‑2 policy trees, *when our main aim is to</span></span>
<span id="cb4-533"><a href="#cb4-533"></a><span class="co"># explore treatment heterogeneity* (not necessarily to beat the ate).</span></span>
<span id="cb4-534"><a href="#cb4-534"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb4-535"><a href="#cb4-535"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb4-536"><a href="#cb4-536"></a><span class="co"># 1. screen outcomes for evidence of heterogeneity </span></span>
<span id="cb4-537"><a href="#cb4-537"></a><span class="co"># ––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––-</span></span>
<span id="cb4-538"><a href="#cb4-538"></a><span class="co"># calculate rate-autoc and rate-qini tables</span></span>
<span id="cb4-539"><a href="#cb4-539"></a><span class="co"># note: RATE-AUTOC asks: 'If I only treat the top k\% by τ(x), do I maximise average gain?' </span></span>
<span id="cb4-540"><a href="#cb4-540"></a><span class="co"># it rewards extreme uplift but can be volatile.</span></span>
<span id="cb4-541"><a href="#cb4-541"></a><span class="co"># RATE-Qini asks: 'if i treat more broadly, do I still improve aggregate outcome?' it trades intensity for coverage.</span></span>
<span id="cb4-542"><a href="#cb4-542"></a>rate_results <span class="ot">&lt;-</span></span>
<span id="cb4-543"><a href="#cb4-543"></a>  <span class="fu">margot_rate</span>(</span>
<span id="cb4-544"><a href="#cb4-544"></a>    <span class="at">models   =</span> models_binary_flipped_all,</span>
<span id="cb4-545"><a href="#cb4-545"></a>    <span class="co">#  model_names        = model_keep,     # only models that survived bh</span></span>
<span id="cb4-546"><a href="#cb4-546"></a>    <span class="at">policy   =</span> <span class="st">"treat_best"</span>,</span>
<span id="cb4-547"><a href="#cb4-547"></a>    <span class="at">alpha  =</span> <span class="fl">0.20</span>,             <span class="co"># raw p &lt; 0.20 is enough to keep</span></span>
<span id="cb4-548"><a href="#cb4-548"></a>    <span class="at">adjust =</span> <span class="st">"fdr"</span>,              <span class="co"># &lt;‑‑correction</span></span>
<span id="cb4-549"><a href="#cb4-549"></a>    <span class="at">label_mapping =</span> label_mapping_all</span>
<span id="cb4-550"><a href="#cb4-550"></a>  )</span>
<span id="cb4-551"><a href="#cb4-551"></a></span>
<span id="cb4-552"><a href="#cb4-552"></a><span class="co"># show rate tables</span></span>
<span id="cb4-553"><a href="#cb4-553"></a>rate_results<span class="sc">$</span>rate_autoc <span class="sc">%&gt;%</span> <span class="fu">kbl</span>(<span class="st">"markdown"</span>)</span>
<span id="cb4-554"><a href="#cb4-554"></a>rate_results<span class="sc">$</span>rate_qini <span class="sc">%&gt;%</span> <span class="fu">kbl</span>(<span class="st">"markdown"</span>)</span>
<span id="cb4-555"><a href="#cb4-555"></a></span>
<span id="cb4-556"><a href="#cb4-556"></a><span class="co"># save rate results</span></span>
<span id="cb4-557"><a href="#cb4-557"></a><span class="fu">here_save</span>(rate_results, <span class="st">"rate_results"</span>)</span>
<span id="cb4-558"><a href="#cb4-558"></a></span>
<span id="cb4-559"><a href="#cb4-559"></a><span class="co"># generate textual interpretations for rate metrics</span></span>
<span id="cb4-560"><a href="#cb4-560"></a>rate_interp <span class="ot">&lt;-</span></span>
<span id="cb4-561"><a href="#cb4-561"></a>  <span class="fu">margot_interpret_rate</span>(</span>
<span id="cb4-562"><a href="#cb4-562"></a>    rate_results,</span>
<span id="cb4-563"><a href="#cb4-563"></a>    <span class="at">flipped_outcomes =</span> flipped_names</span>
<span id="cb4-564"><a href="#cb4-564"></a>  )</span>
<span id="cb4-565"><a href="#cb4-565"></a><span class="fu">cat</span>(rate_interp<span class="sc">$</span>autoc_results, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-566"><a href="#cb4-566"></a><span class="fu">cat</span>(rate_interp<span class="sc">$</span>qini_results, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-567"><a href="#cb4-567"></a><span class="fu">cat</span>(rate_interp<span class="sc">$</span>comparison, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-568"><a href="#cb4-568"></a><span class="fu">here_save</span>(rate_interp, <span class="st">"rate_interpretation"</span>)</span>
<span id="cb4-569"><a href="#cb4-569"></a></span>
<span id="cb4-570"><a href="#cb4-570"></a><span class="co"># organise model groups by heterogeneity evidence</span></span>
<span id="cb4-571"><a href="#cb4-571"></a>model_groups <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-572"><a href="#cb4-572"></a>  <span class="at">autoc  =</span> rate_interp<span class="sc">$</span>autoc_model_names,</span>
<span id="cb4-573"><a href="#cb4-573"></a>  <span class="at">qini   =</span> rate_interp<span class="sc">$</span>qini_model_names,</span>
<span id="cb4-574"><a href="#cb4-574"></a>  <span class="at">either =</span> rate_interp<span class="sc">$</span>either_model_names</span>
<span id="cb4-575"><a href="#cb4-575"></a>)</span>
<span id="cb4-576"><a href="#cb4-576"></a></span>
<span id="cb4-577"><a href="#cb4-577"></a><span class="co"># save</span></span>
<span id="cb4-578"><a href="#cb4-578"></a><span class="fu">here_save</span>(model_groups, <span class="st">"model_groups"</span>)</span>
<span id="cb4-579"><a href="#cb4-579"></a></span>
<span id="cb4-580"><a href="#cb4-580"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"rate metrics and interpretations complete ✔"</span>)</span>
<span id="cb4-581"><a href="#cb4-581"></a></span>
<span id="cb4-582"><a href="#cb4-582"></a></span>
<span id="cb4-583"><a href="#cb4-583"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb4-584"><a href="#cb4-584"></a><span class="co"># 2. get model names after correction</span></span>
<span id="cb4-585"><a href="#cb4-585"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb4-586"><a href="#cb4-586"></a>model_keep <span class="ot">&lt;-</span> model_groups<span class="sc">$</span>either</span>
<span id="cb4-587"><a href="#cb4-587"></a>model_keep_autoc <span class="ot">&lt;-</span>  model_groups<span class="sc">$</span>autoc</span>
<span id="cb4-588"><a href="#cb4-588"></a>model_keep_qini <span class="ot">&lt;-</span> model_groups<span class="sc">$</span>qini</span>
<span id="cb4-589"><a href="#cb4-589"></a></span>
<span id="cb4-590"><a href="#cb4-590"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb4-591"><a href="#cb4-591"></a><span class="co"># 3. fit + plot depth‑2 policy trees for kept models ------------------</span></span>
<span id="cb4-592"><a href="#cb4-592"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb4-593"><a href="#cb4-593"></a>policy_2L_corrected <span class="ot">&lt;-</span> <span class="fu">margot_policy</span>(</span>
<span id="cb4-594"><a href="#cb4-594"></a>  models_binary_flipped_all,</span>
<span id="cb4-595"><a href="#cb4-595"></a>  <span class="at">save_plots         =</span> <span class="cn">FALSE</span>,          <span class="co"># plots kept in memory</span></span>
<span id="cb4-596"><a href="#cb4-596"></a>  <span class="at">output_dir         =</span> <span class="fu">here</span>(push_mods),</span>
<span id="cb4-597"><a href="#cb4-597"></a>  <span class="at">decision_tree_args =</span> decision_tree_defaults, <span class="co"># layout tweaks</span></span>
<span id="cb4-598"><a href="#cb4-598"></a>  <span class="at">policy_tree_args   =</span> policy_tree_defaults,   <span class="co"># tuning for policytree</span></span>
<span id="cb4-599"><a href="#cb4-599"></a>  <span class="at">model_names        =</span> model_keep,     <span class="co"># only models that survived bh</span></span>
<span id="cb4-600"><a href="#cb4-600"></a>  <span class="at">original_df        =</span> original_df,    <span class="co"># raw test‑fold data for labels</span></span>
<span id="cb4-601"><a href="#cb4-601"></a>  <span class="at">label_mapping      =</span> label_mapping_all,</span>
<span id="cb4-602"><a href="#cb4-602"></a>  <span class="at">max_depth          =</span> <span class="dv">2</span>L,</span>
<span id="cb4-603"><a href="#cb4-603"></a>  <span class="at">output_objects     =</span> <span class="st">"combined_plot"</span> <span class="co"># returns ggplot object</span></span>
<span id="cb4-604"><a href="#cb4-604"></a>)</span>
<span id="cb4-605"><a href="#cb4-605"></a><span class="co"># quick display  ----------------------------------------------------</span></span>
<span id="cb4-606"><a href="#cb4-606"></a>plots_2L_corrected <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(policy_2L_corrected, <span class="sc">~</span> .x[[<span class="dv">1</span>]])</span>
<span id="cb4-607"><a href="#cb4-607"></a>purrr<span class="sc">::</span><span class="fu">walk</span>(plots_2L_corrected, print)   <span class="co"># print each to the plot panel</span></span>
<span id="cb4-608"><a href="#cb4-608"></a></span>
<span id="cb4-609"><a href="#cb4-609"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb4-610"><a href="#cb4-610"></a><span class="co"># 4. interpretation ----------------------------------</span></span>
<span id="cb4-611"><a href="#cb4-611"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb4-612"><a href="#cb4-612"></a><span class="co"># generates a short paragraph per outcome explaining the splits and     </span></span>
<span id="cb4-613"><a href="#cb4-613"></a><span class="co"># their implied treatment rule.                                         </span></span>
<span id="cb4-614"><a href="#cb4-614"></a>interp_all_2L <span class="ot">&lt;-</span> <span class="fu">margot_interpret_policy_batch</span>(</span>
<span id="cb4-615"><a href="#cb4-615"></a>  models_binary_flipped_all,  <span class="co"># use the *flipped* master object for labels</span></span>
<span id="cb4-616"><a href="#cb4-616"></a>  <span class="at">model_names =</span> model_keep,</span>
<span id="cb4-617"><a href="#cb4-617"></a>  <span class="at">original_df =</span> original_df <span class="co"># include original data for better interpretation</span></span>
<span id="cb4-618"><a href="#cb4-618"></a>)</span>
<span id="cb4-619"><a href="#cb4-619"></a></span>
<span id="cb4-620"><a href="#cb4-620"></a><span class="fu">cat</span>(interp_all_2L, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb4-621"><a href="#cb4-621"></a></span>
<span id="cb4-622"><a href="#cb4-622"></a><span class="co"># end‑of‑workflow -----------------------------</span></span>
<span id="cb4-623"><a href="#cb4-623"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"main 2l policy trees analysed ✔"</span>)</span>
<span id="cb4-624"><a href="#cb4-624"></a></span>
<span id="cb4-625"><a href="#cb4-625"></a></span>
<span id="cb4-626"><a href="#cb4-626"></a><span class="co"># PLANNED COMPARISONS -----------------------------------------------------</span></span>
<span id="cb4-627"><a href="#cb4-627"></a></span>
<span id="cb4-628"><a href="#cb4-628"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-629"><a href="#cb4-629"></a><span class="co"># |    MODIFY THIS SECTION   |</span></span>
<span id="cb4-630"><a href="#cb4-630"></a><span class="co"># +--------------------------+</span></span>
<span id="cb4-631"><a href="#cb4-631"></a></span>
<span id="cb4-632"><a href="#cb4-632"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb4-633"><a href="#cb4-633"></a><span class="co"># planned subgroup analysis + theoretical comparisons ---------------</span></span>
<span id="cb4-634"><a href="#cb4-634"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb4-635"><a href="#cb4-635"></a><span class="co"># this block asks: “do the causal‑forest estimates differ meaningfully</span></span>
<span id="cb4-636"><a href="#cb4-636"></a><span class="co"># across researcher‑defined demographic strata such as wealth, age,</span></span>
<span id="cb4-637"><a href="#cb4-637"></a><span class="co"># gender, ethnicity, and political orientation?”  the analysis is</span></span>
<span id="cb4-638"><a href="#cb4-638"></a><span class="co"># descriptive: we are *exploring* effect heterogeneity, not optimising a</span></span>
<span id="cb4-639"><a href="#cb4-639"></a><span class="co"># policy rule.</span></span>
<span id="cb4-640"><a href="#cb4-640"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb4-641"><a href="#cb4-641"></a></span>
<span id="cb4-642"><a href="#cb4-642"></a><span class="co"># 0. back‑transform helper -------------------------------------------</span></span>
<span id="cb4-643"><a href="#cb4-643"></a><span class="co"># margot stores income as z‑scored log dollars.  to write interpretable</span></span>
<span id="cb4-644"><a href="#cb4-644"></a><span class="co"># subtitles we convert ±1 sd back to the raw scale.  the helper simply</span></span>
<span id="cb4-645"><a href="#cb4-645"></a><span class="co"># inverts the: log → z transformation.</span></span>
<span id="cb4-646"><a href="#cb4-646"></a>log_mean_inc <span class="ot">&lt;-</span> <span class="fu">mean</span>(original_df<span class="sc">$</span>t0_log_household_inc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-647"><a href="#cb4-647"></a>log_sd_inc   <span class="ot">&lt;-</span> <span class="fu">sd</span>  (original_df<span class="sc">$</span>t0_log_household_inc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-648"><a href="#cb4-648"></a></span>
<span id="cb4-649"><a href="#cb4-649"></a><span class="fu">margot_back_transform_log_z</span>(</span>
<span id="cb4-650"><a href="#cb4-650"></a>  <span class="at">log_mean =</span> log_mean_inc,</span>
<span id="cb4-651"><a href="#cb4-651"></a>  <span class="at">log_sd   =</span> log_sd_inc,</span>
<span id="cb4-652"><a href="#cb4-652"></a>  <span class="at">z_scores =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb4-653"><a href="#cb4-653"></a>  <span class="at">label    =</span> <span class="st">"data_scale"</span>   <span class="co"># prints nz$ values ≈ 41k,…</span></span>
<span id="cb4-654"><a href="#cb4-654"></a>)</span>
<span id="cb4-655"><a href="#cb4-655"></a></span>
<span id="cb4-656"><a href="#cb4-656"></a><span class="co"># 1. define strata via logical vectors -------------------------------</span></span>
<span id="cb4-657"><a href="#cb4-657"></a><span class="co"># we treat ±1sd as the default cut for “low / mid / high”.  students</span></span>
<span id="cb4-658"><a href="#cb4-658"></a><span class="co"># can change the thresholds or supply any logical `subset_condition`.</span></span>
<span id="cb4-659"><a href="#cb4-659"></a>complex_condition_political <span class="ot">&lt;-</span> <span class="fu">between</span>(X[,<span class="st">"t0_political_conservative_z"</span>], <span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb4-660"><a href="#cb4-660"></a>complex_condition_wealth    <span class="ot">&lt;-</span> <span class="fu">between</span>(X[,<span class="st">"t0_log_household_inc_z"</span>],    <span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb4-661"><a href="#cb4-661"></a>complex_condition_age       <span class="ot">&lt;-</span> <span class="fu">between</span>(X[,<span class="st">"t0_age_z"</span>],                   <span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb4-662"><a href="#cb4-662"></a></span>
<span id="cb4-663"><a href="#cb4-663"></a><span class="co"># sanity‑check age bounds on the raw scale</span></span>
<span id="cb4-664"><a href="#cb4-664"></a><span class="fu">mean</span>(original_df<span class="sc">$</span>t0_age) <span class="sc">+</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>) <span class="sc">*</span> <span class="fu">sd</span>(original_df<span class="sc">$</span>t0_age)</span>
<span id="cb4-665"><a href="#cb4-665"></a></span>
<span id="cb4-666"><a href="#cb4-666"></a><span class="co"># 2. wrap strata in named lists --------------------------------------</span></span>
<span id="cb4-667"><a href="#cb4-667"></a><span class="co"># each entry is consumed by `margot_planned_subgroups_batch()`.  fields:</span></span>
<span id="cb4-668"><a href="#cb4-668"></a><span class="co">#   *  var / value / operator – simple threshold OR</span></span>
<span id="cb4-669"><a href="#cb4-669"></a><span class="co">#   * subset_condition       – pre‑computed logical</span></span>
<span id="cb4-670"><a href="#cb4-670"></a><span class="co">#   * description            – shown in plots</span></span>
<span id="cb4-671"><a href="#cb4-671"></a><span class="co">#   * label                  – used as facet name</span></span>
<span id="cb4-672"><a href="#cb4-672"></a>subsets_standard_wealth <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-673"><a href="#cb4-673"></a>  <span class="at">Poor   =</span> <span class="fu">list</span>(<span class="at">var=</span><span class="st">"t0_log_household_inc_z"</span>, <span class="at">value=</span><span class="sc">-</span><span class="dv">1</span>, <span class="at">operator=</span><span class="st">"&lt;"</span>,</span>
<span id="cb4-674"><a href="#cb4-674"></a>                <span class="at">description=</span><span class="st">"income &lt; −1sd (≈ NZ$41k)"</span>, <span class="at">label=</span><span class="st">"Poor"</span>),</span>
<span id="cb4-675"><a href="#cb4-675"></a>  <span class="at">MiddleIncome =</span> <span class="fu">list</span>(<span class="at">subset_condition =</span> complex_condition_wealth,</span>
<span id="cb4-676"><a href="#cb4-676"></a>                      <span class="at">description =</span> <span class="st">"income within ±1sd (≈ NZ$41‑191k)"</span>),</span>
<span id="cb4-677"><a href="#cb4-677"></a>  <span class="at">Rich   =</span> <span class="fu">list</span>(<span class="at">var=</span><span class="st">"t0_log_household_inc_z"</span>, <span class="at">value=</span> <span class="dv">1</span>, <span class="at">operator=</span><span class="st">"&gt;"</span>,</span>
<span id="cb4-678"><a href="#cb4-678"></a>                <span class="at">description=</span><span class="st">"income &gt; +1sd (≈ NZ$191k)"</span>, <span class="at">label=</span><span class="st">"Rich"</span>)</span>
<span id="cb4-679"><a href="#cb4-679"></a>)</span>
<span id="cb4-680"><a href="#cb4-680"></a></span>
<span id="cb4-681"><a href="#cb4-681"></a></span>
<span id="cb4-682"><a href="#cb4-682"></a><span class="co"># define complex political orientation</span></span>
<span id="cb4-683"><a href="#cb4-683"></a>complex_condition_political <span class="ot">&lt;-</span> X[, <span class="st">"t0_political_conservative_z"</span>] <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">&amp;</span></span>
<span id="cb4-684"><a href="#cb4-684"></a>  X[, <span class="st">"t0_political_conservative_z"</span>] <span class="sc">&lt;</span> <span class="dv">1</span></span>
<span id="cb4-685"><a href="#cb4-685"></a></span>
<span id="cb4-686"><a href="#cb4-686"></a>complex_condition_wealth <span class="ot">&lt;-</span> X[, <span class="st">"t0_log_household_inc_z"</span>] <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">&amp;</span></span>
<span id="cb4-687"><a href="#cb4-687"></a>  X[, <span class="st">"t0_log_household_inc_z"</span>] <span class="sc">&lt;</span> <span class="dv">1</span></span>
<span id="cb4-688"><a href="#cb4-688"></a></span>
<span id="cb4-689"><a href="#cb4-689"></a>complex_condition_age <span class="ot">&lt;-</span> X[, <span class="st">"t0_age_z"</span>] <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">&amp;</span></span>
<span id="cb4-690"><a href="#cb4-690"></a>  X[, <span class="st">"t0_age_z"</span>] <span class="sc">&lt;</span> <span class="dv">1</span></span>
<span id="cb4-691"><a href="#cb4-691"></a></span>
<span id="cb4-692"><a href="#cb4-692"></a><span class="co"># # if we have specific groups to compare</span></span>
<span id="cb4-693"><a href="#cb4-693"></a><span class="co"># complex_condition_age_under_neg_1_sd  &lt;- X[, "t0_age_z"] &lt; -1</span></span>
<span id="cb4-694"><a href="#cb4-694"></a><span class="co"># complex_condition_age_gr_eq_neg_1_sd  &lt;- X[, "t0_age_z"] &gt; -1</span></span>
<span id="cb4-695"><a href="#cb4-695"></a></span>
<span id="cb4-696"><a href="#cb4-696"></a><span class="co"># check ages to get number</span></span>
<span id="cb4-697"><a href="#cb4-697"></a><span class="fu">mean</span>(original_df<span class="sc">$</span>t0_age) <span class="sc">-</span> <span class="fu">sd</span>(original_df<span class="sc">$</span>t0_age)</span>
<span id="cb4-698"><a href="#cb4-698"></a><span class="fu">mean</span>(original_df<span class="sc">$</span>t0_age) <span class="sc">+</span> <span class="fu">sd</span>(original_df<span class="sc">$</span>t0_age)</span>
<span id="cb4-699"><a href="#cb4-699"></a></span>
<span id="cb4-700"><a href="#cb4-700"></a></span>
<span id="cb4-701"><a href="#cb4-701"></a><span class="co"># wealth subsets</span></span>
<span id="cb4-702"><a href="#cb4-702"></a>subsets_standard_wealth <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-703"><a href="#cb4-703"></a>  <span class="at">Poor =</span> <span class="fu">list</span>(</span>
<span id="cb4-704"><a href="#cb4-704"></a>    <span class="at">var =</span> <span class="st">"t0_log_household_inc_z"</span>,</span>
<span id="cb4-705"><a href="#cb4-705"></a>    <span class="at">value =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb4-706"><a href="#cb4-706"></a>    <span class="at">operator =</span> <span class="st">"&lt;"</span>,</span>
<span id="cb4-707"><a href="#cb4-707"></a>    <span class="at">description =</span> <span class="st">"Effects among those HShold income &lt; -1 SD (NZD ~41k)"</span>,</span>
<span id="cb4-708"><a href="#cb4-708"></a>    <span class="at">label =</span> <span class="st">"Poor"</span>  <span class="co"># label remains as is, but could be changed if desired</span></span>
<span id="cb4-709"><a href="#cb4-709"></a>  ),</span>
<span id="cb4-710"><a href="#cb4-710"></a>  <span class="at">MiddleIncome =</span> <span class="fu">list</span>(<span class="at">subset_condition =</span> complex_condition_wealth, <span class="at">description =</span> <span class="st">"Effects among those HS_hold income within +/-1SD (&gt; NZD 41k &lt; NZD 191k)"</span>, </span>
<span id="cb4-711"><a href="#cb4-711"></a>                      <span class="at">label =</span> <span class="st">"Middle Income"</span>),</span>
<span id="cb4-712"><a href="#cb4-712"></a>  <span class="at">Rich =</span> <span class="fu">list</span>(</span>
<span id="cb4-713"><a href="#cb4-713"></a>    <span class="at">var =</span> <span class="st">"t0_log_household_inc_z"</span>,</span>
<span id="cb4-714"><a href="#cb4-714"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb4-715"><a href="#cb4-715"></a>    <span class="at">operator =</span> <span class="st">"&gt;"</span>,</span>
<span id="cb4-716"><a href="#cb4-716"></a>    <span class="at">description =</span> <span class="st">"Effects among those HS_hold income &gt; +1 SD (NZD 191k)"</span>,</span>
<span id="cb4-717"><a href="#cb4-717"></a>    <span class="at">label =</span> <span class="st">"Rich"</span></span>
<span id="cb4-718"><a href="#cb4-718"></a>  )</span>
<span id="cb4-719"><a href="#cb4-719"></a>)</span>
<span id="cb4-720"><a href="#cb4-720"></a></span>
<span id="cb4-721"><a href="#cb4-721"></a><span class="co"># political subsets</span></span>
<span id="cb4-722"><a href="#cb4-722"></a>subsets_standard_political <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-723"><a href="#cb4-723"></a>  <span class="at">Liberal =</span> <span class="fu">list</span>(</span>
<span id="cb4-724"><a href="#cb4-724"></a>    <span class="at">var =</span> <span class="st">"t0_political_conservative_z"</span>,</span>
<span id="cb4-725"><a href="#cb4-725"></a>    <span class="at">value =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb4-726"><a href="#cb4-726"></a>    <span class="at">operator =</span> <span class="st">"&lt;"</span>,</span>
<span id="cb4-727"><a href="#cb4-727"></a>    <span class="at">description =</span> <span class="st">"Effects among those &lt; -1 SD in political conservativism"</span>,</span>
<span id="cb4-728"><a href="#cb4-728"></a>    <span class="at">label =</span> <span class="st">"Liberal"</span></span>
<span id="cb4-729"><a href="#cb4-729"></a>  ),</span>
<span id="cb4-730"><a href="#cb4-730"></a>  <span class="at">Centrist =</span> <span class="fu">list</span>(</span>
<span id="cb4-731"><a href="#cb4-731"></a>    <span class="at">var =</span> <span class="st">"t0_political_conservative_z"</span>,</span>
<span id="cb4-732"><a href="#cb4-732"></a>    <span class="co"># operator = "&lt;",</span></span>
<span id="cb4-733"><a href="#cb4-733"></a>    <span class="at">subset_condition =</span> complex_condition_political,</span>
<span id="cb4-734"><a href="#cb4-734"></a>    <span class="at">description =</span> <span class="st">"Effects among those &gt; -1 SD and &lt; +1 in political conservativism"</span>,</span>
<span id="cb4-735"><a href="#cb4-735"></a>    <span class="at">label =</span> <span class="st">"Centrist"</span></span>
<span id="cb4-736"><a href="#cb4-736"></a>  ),</span>
<span id="cb4-737"><a href="#cb4-737"></a>  <span class="at">Conservative =</span> <span class="fu">list</span>(</span>
<span id="cb4-738"><a href="#cb4-738"></a>    <span class="at">var =</span> <span class="st">"t0_political_conservative_z"</span>,</span>
<span id="cb4-739"><a href="#cb4-739"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb4-740"><a href="#cb4-740"></a>    <span class="at">operator =</span> <span class="st">"&gt;"</span>,</span>
<span id="cb4-741"><a href="#cb4-741"></a>    <span class="at">description =</span> <span class="st">"Effects among those &gt; +1 SD in political conservativism"</span>,</span>
<span id="cb4-742"><a href="#cb4-742"></a>    <span class="at">label =</span> <span class="st">"Conservative"</span></span>
<span id="cb4-743"><a href="#cb4-743"></a>  )</span>
<span id="cb4-744"><a href="#cb4-744"></a>)</span>
<span id="cb4-745"><a href="#cb4-745"></a></span>
<span id="cb4-746"><a href="#cb4-746"></a></span>
<span id="cb4-747"><a href="#cb4-747"></a><span class="co"># age subsets</span></span>
<span id="cb4-748"><a href="#cb4-748"></a>subsets_standard_age <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-749"><a href="#cb4-749"></a>  <span class="at">Younger =</span> <span class="fu">list</span>(</span>
<span id="cb4-750"><a href="#cb4-750"></a>    <span class="at">var =</span> <span class="st">"t0_age_z"</span>,</span>
<span id="cb4-751"><a href="#cb4-751"></a>    <span class="at">value =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb4-752"><a href="#cb4-752"></a>    <span class="at">operator =</span> <span class="st">"&lt;"</span>,</span>
<span id="cb4-753"><a href="#cb4-753"></a>    <span class="at">label =</span> <span class="st">"Age &lt; 35"</span></span>
<span id="cb4-754"><a href="#cb4-754"></a>  ),</span>
<span id="cb4-755"><a href="#cb4-755"></a>  <span class="at">Middle =</span> <span class="fu">list</span>(</span>
<span id="cb4-756"><a href="#cb4-756"></a>    <span class="at">var =</span> <span class="st">"t0_age_z"</span>,</span>
<span id="cb4-757"><a href="#cb4-757"></a>    <span class="co"># operator = "&lt;",</span></span>
<span id="cb4-758"><a href="#cb4-758"></a>    <span class="at">subset_condition =</span> complex_condition_age,</span>
<span id="cb4-759"><a href="#cb4-759"></a>    <span class="at">label =</span> <span class="st">"Age 35-62"</span></span>
<span id="cb4-760"><a href="#cb4-760"></a>  ),</span>
<span id="cb4-761"><a href="#cb4-761"></a>  <span class="at">Older =</span> <span class="fu">list</span>(</span>
<span id="cb4-762"><a href="#cb4-762"></a>    <span class="at">var =</span> <span class="st">"t0_age_z"</span>,</span>
<span id="cb4-763"><a href="#cb4-763"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb4-764"><a href="#cb4-764"></a>    <span class="at">operator =</span> <span class="st">"&gt;"</span>,</span>
<span id="cb4-765"><a href="#cb4-765"></a>    <span class="at">label =</span> <span class="st">"Age &gt; 62"</span></span>
<span id="cb4-766"><a href="#cb4-766"></a>  )</span>
<span id="cb4-767"><a href="#cb4-767"></a>)</span>
<span id="cb4-768"><a href="#cb4-768"></a></span>
<span id="cb4-769"><a href="#cb4-769"></a></span>
<span id="cb4-770"><a href="#cb4-770"></a><span class="co"># gender subsets</span></span>
<span id="cb4-771"><a href="#cb4-771"></a>subsets_standard_gender <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-772"><a href="#cb4-772"></a>  <span class="at">Female =</span> <span class="fu">list</span>(</span>
<span id="cb4-773"><a href="#cb4-773"></a>    <span class="at">var =</span> <span class="st">"t0_male_binary"</span>,</span>
<span id="cb4-774"><a href="#cb4-774"></a>    <span class="at">value =</span> <span class="dv">0</span>,</span>
<span id="cb4-775"><a href="#cb4-775"></a>    <span class="at">description =</span> <span class="st">"Females"</span></span>
<span id="cb4-776"><a href="#cb4-776"></a>  ),</span>
<span id="cb4-777"><a href="#cb4-777"></a>  <span class="at">Male =</span> <span class="fu">list</span>(</span>
<span id="cb4-778"><a href="#cb4-778"></a>    <span class="at">var =</span> <span class="st">"t0_male_binary"</span>,</span>
<span id="cb4-779"><a href="#cb4-779"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb4-780"><a href="#cb4-780"></a>    <span class="at">description =</span> <span class="st">"Males"</span></span>
<span id="cb4-781"><a href="#cb4-781"></a>  )</span>
<span id="cb4-782"><a href="#cb4-782"></a>)</span>
<span id="cb4-783"><a href="#cb4-783"></a></span>
<span id="cb4-784"><a href="#cb4-784"></a><span class="co"># ethnicity subsets</span></span>
<span id="cb4-785"><a href="#cb4-785"></a>subsets_standard_ethnicity <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-786"><a href="#cb4-786"></a>  <span class="at">Asian =</span> <span class="fu">list</span>(</span>
<span id="cb4-787"><a href="#cb4-787"></a>    <span class="at">var =</span> <span class="st">"t0_eth_cat_asian_binary"</span>,</span>
<span id="cb4-788"><a href="#cb4-788"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb4-789"><a href="#cb4-789"></a>    <span class="at">label =</span> <span class="st">"Asians"</span>,</span>
<span id="cb4-790"><a href="#cb4-790"></a>    <span class="at">description =</span> <span class="st">"Asians"</span></span>
<span id="cb4-791"><a href="#cb4-791"></a>    </span>
<span id="cb4-792"><a href="#cb4-792"></a>  ),</span>
<span id="cb4-793"><a href="#cb4-793"></a>  <span class="at">Euro =</span> <span class="fu">list</span>(</span>
<span id="cb4-794"><a href="#cb4-794"></a>    <span class="at">var =</span> <span class="st">"t0_eth_cat_euro_binary"</span>,</span>
<span id="cb4-795"><a href="#cb4-795"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb4-796"><a href="#cb4-796"></a>    <span class="at">label =</span> <span class="st">"NZ Europeans "</span>,</span>
<span id="cb4-797"><a href="#cb4-797"></a>    <span class="at">description =</span> <span class="st">"NZ Europeans"</span></span>
<span id="cb4-798"><a href="#cb4-798"></a>    </span>
<span id="cb4-799"><a href="#cb4-799"></a>  ),</span>
<span id="cb4-800"><a href="#cb4-800"></a>  <span class="at">Pacific =</span> <span class="fu">list</span>(</span>
<span id="cb4-801"><a href="#cb4-801"></a>    <span class="at">var =</span> <span class="st">"t0_eth_cat_pacific_binary"</span>,</span>
<span id="cb4-802"><a href="#cb4-802"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb4-803"><a href="#cb4-803"></a>    <span class="at">label =</span> <span class="st">"Pacific Peoples"</span>,</span>
<span id="cb4-804"><a href="#cb4-804"></a>    <span class="at">description =</span>  <span class="st">"Pacific Peoples"</span></span>
<span id="cb4-805"><a href="#cb4-805"></a>  ),</span>
<span id="cb4-806"><a href="#cb4-806"></a>  <span class="at">Maori =</span> <span class="fu">list</span>(</span>
<span id="cb4-807"><a href="#cb4-807"></a>    <span class="at">var =</span> <span class="st">"t0_eth_cat_maori_binary"</span>,</span>
<span id="cb4-808"><a href="#cb4-808"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb4-809"><a href="#cb4-809"></a>    <span class="at">label =</span> <span class="st">"Māori"</span>,</span>
<span id="cb4-810"><a href="#cb4-810"></a>    <span class="at">description =</span> <span class="st">'Māori'</span></span>
<span id="cb4-811"><a href="#cb4-811"></a>  )</span>
<span id="cb4-812"><a href="#cb4-812"></a>)</span>
<span id="cb4-813"><a href="#cb4-813"></a></span>
<span id="cb4-814"><a href="#cb4-814"></a><span class="co"># religious denominations</span></span>
<span id="cb4-815"><a href="#cb4-815"></a>subsets_standard_secular_vs_religious <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-816"><a href="#cb4-816"></a>  <span class="at">Not_Religious =</span> <span class="fu">list</span>(</span>
<span id="cb4-817"><a href="#cb4-817"></a>    <span class="at">var =</span> <span class="st">"t0_religion_bigger_denominations_not_rel_binary"</span>,</span>
<span id="cb4-818"><a href="#cb4-818"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb4-819"><a href="#cb4-819"></a>    <span class="at">label =</span> <span class="st">"Not Religious"</span></span>
<span id="cb4-820"><a href="#cb4-820"></a>  ),</span>
<span id="cb4-821"><a href="#cb4-821"></a>  <span class="at">Religious =</span> <span class="fu">list</span>(</span>
<span id="cb4-822"><a href="#cb4-822"></a>    <span class="at">var =</span> <span class="st">"t0_religion_bigger_denominations_not_rel_binary"</span>,</span>
<span id="cb4-823"><a href="#cb4-823"></a>    <span class="at">value =</span> <span class="dv">0</span>,</span>
<span id="cb4-824"><a href="#cb4-824"></a>    <span class="at">label =</span> <span class="st">"Religious"</span></span>
<span id="cb4-825"><a href="#cb4-825"></a>  )</span>
<span id="cb4-826"><a href="#cb4-826"></a>)</span>
<span id="cb4-827"><a href="#cb4-827"></a></span>
<span id="cb4-828"><a href="#cb4-828"></a><span class="co"># batch planned subgroup analysis -----------------------------------------</span></span>
<span id="cb4-829"><a href="#cb4-829"></a><span class="co"># set up domain names</span></span>
<span id="cb4-830"><a href="#cb4-830"></a><span class="fu">detach</span>(<span class="st">"package:margot"</span>, <span class="at">unload =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-831"><a href="#cb4-831"></a>devtools<span class="sc">::</span><span class="fu">load_all</span>(<span class="st">"/Users/joseph/GIT/margot/"</span>)</span>
<span id="cb4-832"><a href="#cb4-832"></a></span>
<span id="cb4-833"><a href="#cb4-833"></a>domain_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"wellbeing"</span>)</span>
<span id="cb4-834"><a href="#cb4-834"></a></span>
<span id="cb4-835"><a href="#cb4-835"></a><span class="co"># set up subtitles</span></span>
<span id="cb4-836"><a href="#cb4-836"></a>subtitles <span class="ot">&lt;-</span> <span class="st">""</span></span>
<span id="cb4-837"><a href="#cb4-837"></a></span>
<span id="cb4-838"><a href="#cb4-838"></a><span class="co"># new base defaults that work for your comparisons</span></span>
<span id="cb4-839"><a href="#cb4-839"></a><span class="co"># defaults for ate plots</span></span>
<span id="cb4-840"><a href="#cb4-840"></a></span>
<span id="cb4-841"><a href="#cb4-841"></a><span class="co"># play around with these values</span></span>
<span id="cb4-842"><a href="#cb4-842"></a>x_offset_comp <span class="ot">&lt;-</span> <span class="fl">1.0</span></span>
<span id="cb4-843"><a href="#cb4-843"></a>x_lim_lo_comp <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">1.0</span></span>
<span id="cb4-844"><a href="#cb4-844"></a>x_lim_hi_comp <span class="ot">&lt;-</span> <span class="fl">1.0</span> </span>
<span id="cb4-845"><a href="#cb4-845"></a></span>
<span id="cb4-846"><a href="#cb4-846"></a>label_mapping_all</span>
<span id="cb4-847"><a href="#cb4-847"></a>base_defaults_comparisons <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-848"><a href="#cb4-848"></a>  <span class="at">type =</span> <span class="st">"RD"</span>,</span>
<span id="cb4-849"><a href="#cb4-849"></a>  <span class="at">title =</span> ate_title,</span>
<span id="cb4-850"><a href="#cb4-850"></a>  <span class="at">e_val_bound_threshold =</span> <span class="fl">1.2</span>,</span>
<span id="cb4-851"><a href="#cb4-851"></a>  <span class="at">label_mapping =</span> <span class="st">"label_mapping_all"</span>,</span>
<span id="cb4-852"><a href="#cb4-852"></a>  <span class="at">adjust =</span> <span class="st">"bonferroni"</span>, <span class="co">#&lt;- new</span></span>
<span id="cb4-853"><a href="#cb4-853"></a>  <span class="at">alpha =</span> <span class="fl">0.05</span>, <span class="co"># &lt;- new</span></span>
<span id="cb4-854"><a href="#cb4-854"></a>  <span class="at">colors =</span> <span class="fu">c</span>(</span>
<span id="cb4-855"><a href="#cb4-855"></a>    <span class="st">"positive"</span> <span class="ot">=</span> <span class="st">"#E69F00"</span>,</span>
<span id="cb4-856"><a href="#cb4-856"></a>    <span class="st">"not reliable"</span> <span class="ot">=</span> <span class="st">"grey50"</span>,</span>
<span id="cb4-857"><a href="#cb4-857"></a>    <span class="st">"negative"</span> <span class="ot">=</span> <span class="st">"#56B4E9"</span></span>
<span id="cb4-858"><a href="#cb4-858"></a>  ),</span>
<span id="cb4-859"><a href="#cb4-859"></a>  <span class="at">x_offset =</span> x_offset_comp,</span>
<span id="cb4-860"><a href="#cb4-860"></a>  <span class="co"># will be set based on type</span></span>
<span id="cb4-861"><a href="#cb4-861"></a>  <span class="at">x_lim_lo =</span> x_lim_lo_comp,</span>
<span id="cb4-862"><a href="#cb4-862"></a>  <span class="co"># will be set based on type</span></span>
<span id="cb4-863"><a href="#cb4-863"></a>  <span class="at">x_lim_hi =</span> x_lim_hi_comp,</span>
<span id="cb4-864"><a href="#cb4-864"></a>  <span class="at">text_size =</span> <span class="dv">8</span>,</span>
<span id="cb4-865"><a href="#cb4-865"></a>  <span class="at">linewidth =</span> <span class="fl">0.75</span>,</span>
<span id="cb4-866"><a href="#cb4-866"></a>  <span class="at">estimate_scale =</span> <span class="dv">1</span>,</span>
<span id="cb4-867"><a href="#cb4-867"></a>  <span class="at">base_size =</span> <span class="dv">18</span>,</span>
<span id="cb4-868"><a href="#cb4-868"></a>  <span class="at">point_size =</span> <span class="fl">2.5</span>,</span>
<span id="cb4-869"><a href="#cb4-869"></a>  <span class="at">title_size =</span> <span class="dv">19</span>,</span>
<span id="cb4-870"><a href="#cb4-870"></a>  <span class="at">subtitle_size =</span> <span class="dv">16</span>,</span>
<span id="cb4-871"><a href="#cb4-871"></a>  <span class="at">legend_text_size =</span> <span class="dv">10</span>,</span>
<span id="cb4-872"><a href="#cb4-872"></a>  <span class="at">legend_title_size =</span> <span class="dv">10</span>,</span>
<span id="cb4-873"><a href="#cb4-873"></a>  <span class="at">include_coefficients =</span> <span class="cn">FALSE</span></span>
<span id="cb4-874"><a href="#cb4-874"></a>)</span>
<span id="cb4-875"><a href="#cb4-875"></a></span>
<span id="cb4-876"><a href="#cb4-876"></a><span class="co"># 3. batch subgroup analysis -----------------------------------------</span></span>
<span id="cb4-877"><a href="#cb4-877"></a>planned_subset_results <span class="ot">&lt;-</span> <span class="fu">margot_planned_subgroups_batch</span>(</span>
<span id="cb4-878"><a href="#cb4-878"></a>  <span class="at">domain_models  =</span> <span class="fu">list</span>(models_binary),</span>
<span id="cb4-879"><a href="#cb4-879"></a>  <span class="at">X              =</span> X,</span>
<span id="cb4-880"><a href="#cb4-880"></a>  <span class="at">base_defaults  =</span> base_defaults_comparisons,</span>
<span id="cb4-881"><a href="#cb4-881"></a>  <span class="at">subset_types   =</span> <span class="fu">list</span>(<span class="at">religions =</span> subsets_standard_religion,</span>
<span id="cb4-882"><a href="#cb4-882"></a>                        <span class="at">religions_secular =</span> subsets_standard_secular_vs_religious, <span class="co"># only compare one group with others</span></span>
<span id="cb4-883"><a href="#cb4-883"></a>                        <span class="at">ethnicity =</span> subsets_standard_ethnicity,</span>
<span id="cb4-884"><a href="#cb4-884"></a>                        <span class="at">wealth =</span> subsets_standard_wealth, </span>
<span id="cb4-885"><a href="#cb4-885"></a>                        <span class="at">gender =</span> subsets_standard_gender, </span>
<span id="cb4-886"><a href="#cb4-886"></a>                        <span class="at">cohort =</span> subsets_standard_age),</span>
<span id="cb4-887"><a href="#cb4-887"></a>  <span class="at">original_df    =</span> original_df,</span>
<span id="cb4-888"><a href="#cb4-888"></a>  <span class="at">label_mapping  =</span> label_mapping_all,          <span class="co"># ← supply it here</span></span>
<span id="cb4-889"><a href="#cb4-889"></a>  <span class="at">domain_names   =</span> <span class="st">"wellbeing"</span>,</span>
<span id="cb4-890"><a href="#cb4-890"></a>  <span class="at">subtitles      =</span> <span class="st">""</span>,</span>
<span id="cb4-891"><a href="#cb4-891"></a>  <span class="at">adjust         =</span> <span class="st">"bonferroni"</span>,  <span class="co"># ← here</span></span>
<span id="cb4-892"><a href="#cb4-892"></a>  <span class="at">alpha          =</span> <span class="fl">0.05</span>           <span class="co"># ← and here</span></span>
<span id="cb4-893"><a href="#cb4-893"></a>)</span>
<span id="cb4-894"><a href="#cb4-894"></a></span>
<span id="cb4-895"><a href="#cb4-895"></a></span>
<span id="cb4-896"><a href="#cb4-896"></a></span>
<span id="cb4-897"><a href="#cb4-897"></a><span class="co"># the function:                                                        </span></span>
<span id="cb4-898"><a href="#cb4-898"></a><span class="co">#   1. filters the test fold to each stratum,                           </span></span>
<span id="cb4-899"><a href="#cb4-899"></a><span class="co">#   2. re‑computes the doubly‑robust ate for every outcome,             </span></span>
<span id="cb4-900"><a href="#cb4-900"></a><span class="co">#   3. wraps results in a tidy list → $domain → $subset → $plot/table.</span></span>
<span id="cb4-901"><a href="#cb4-901"></a></span>
<span id="cb4-902"><a href="#cb4-902"></a><span class="co"># 4. text summaries ---------------------------------------------------</span></span>
<span id="cb4-903"><a href="#cb4-903"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>wealth<span class="sc">$</span>explanation)</span>
<span id="cb4-904"><a href="#cb4-904"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>religions<span class="sc">$</span>explanation)</span>
<span id="cb4-905"><a href="#cb4-905"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>ethnicity<span class="sc">$</span>explanation)</span>
<span id="cb4-906"><a href="#cb4-906"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>religions_secular<span class="sc">$</span>explanation)</span>
<span id="cb4-907"><a href="#cb4-907"></a></span>
<span id="cb4-908"><a href="#cb4-908"></a></span>
<span id="cb4-909"><a href="#cb4-909"></a><span class="co"># (political, gender, cohort idem)</span></span>
<span id="cb4-910"><a href="#cb4-910"></a></span>
<span id="cb4-911"><a href="#cb4-911"></a><span class="co"># 5. assemble quick facet plots --------------------------------------</span></span>
<span id="cb4-912"><a href="#cb4-912"></a><span class="co"># patchwork stacks the ggplots vertically (ncol = 1) or in a grid.  the</span></span>
<span id="cb4-913"><a href="#cb4-913"></a><span class="co"># helper `wrap_plots()` is from patchwork.  here we show wealth strata.</span></span>
<span id="cb4-914"><a href="#cb4-914"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb4-915"><a href="#cb4-915"></a><span class="co"># example 1 – stack three wealth strata vertically -------------------</span></span>
<span id="cb4-916"><a href="#cb4-916"></a>plots_subgroup_wealth <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb4-917"><a href="#cb4-917"></a>  <span class="fu">list</span>(</span>
<span id="cb4-918"><a href="#cb4-918"></a>    planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>Poor<span class="sc">$</span>plot,</span>
<span id="cb4-919"><a href="#cb4-919"></a>    planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span><span class="st">`</span><span class="at">Middle Income</span><span class="st">`</span><span class="sc">$</span>plot,</span>
<span id="cb4-920"><a href="#cb4-920"></a>    planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>Rich<span class="sc">$</span>plot</span>
<span id="cb4-921"><a href="#cb4-921"></a>  ), <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb4-922"><a href="#cb4-922"></a>  <span class="fu">plot_annotation</span>(</span>
<span id="cb4-923"><a href="#cb4-923"></a>    <span class="at">title =</span> <span class="st">"Wealth"</span>,</span>
<span id="cb4-924"><a href="#cb4-924"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>, <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb4-925"><a href="#cb4-925"></a>  )</span>
<span id="cb4-926"><a href="#cb4-926"></a><span class="fu">print</span>(plots_subgroup_wealth)</span>
<span id="cb4-927"><a href="#cb4-927"></a></span>
<span id="cb4-928"><a href="#cb4-928"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb4-929"><a href="#cb4-929"></a><span class="co"># example 2 – 2×2 grid for ethnicity (space-saving) ------------------</span></span>
<span id="cb4-930"><a href="#cb4-930"></a>plots_subgroup_ethnicity <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb4-931"><a href="#cb4-931"></a>  <span class="fu">list</span>(</span>
<span id="cb4-932"><a href="#cb4-932"></a>    planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Asians<span class="sc">$</span>plot,</span>
<span id="cb4-933"><a href="#cb4-933"></a>    planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>ethnicity<span class="sc">$</span>result<span class="sc">$</span><span class="st">`</span><span class="at">NZ Europeans </span><span class="st">`</span><span class="sc">$</span>plot,</span>
<span id="cb4-934"><a href="#cb4-934"></a>    planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span><span class="st">`</span><span class="at">Pacific Peoples</span><span class="st">`</span><span class="sc">$</span>plot,</span>
<span id="cb4-935"><a href="#cb4-935"></a>    planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Māori<span class="sc">$</span>plot</span>
<span id="cb4-936"><a href="#cb4-936"></a>  ), <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb4-937"><a href="#cb4-937"></a>  <span class="fu">plot_annotation</span>(</span>
<span id="cb4-938"><a href="#cb4-938"></a>    <span class="at">title =</span> <span class="st">"Ethnicity"</span>,</span>
<span id="cb4-939"><a href="#cb4-939"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>, <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb4-940"><a href="#cb4-940"></a>  )</span>
<span id="cb4-941"><a href="#cb4-941"></a><span class="fu">print</span>(plots_subgroup_ethnicity)</span>
<span id="cb4-942"><a href="#cb4-942"></a>planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Asians<span class="sc">$</span>plot</span>
<span id="cb4-943"><a href="#cb4-943"></a><span class="co"># -------------------------------------------------------------------</span></span>
<span id="cb4-944"><a href="#cb4-944"></a><span class="co"># example 3 – horizontal strip for gender ----------------------------</span></span>
<span id="cb4-945"><a href="#cb4-945"></a>plots_subgroup_gender <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb4-946"><a href="#cb4-946"></a>  <span class="fu">list</span>(</span>
<span id="cb4-947"><a href="#cb4-947"></a>    planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>gender<span class="sc">$</span>results<span class="sc">$</span>Female<span class="sc">$</span>plot,</span>
<span id="cb4-948"><a href="#cb4-948"></a>    planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>gender<span class="sc">$</span>results<span class="sc">$</span>Male<span class="sc">$</span>plot</span>
<span id="cb4-949"><a href="#cb4-949"></a>  ), <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb4-950"><a href="#cb4-950"></a>  <span class="fu">plot_annotation</span>(</span>
<span id="cb4-951"><a href="#cb4-951"></a>    <span class="at">title =</span> <span class="st">"Gender"</span>,</span>
<span id="cb4-952"><a href="#cb4-952"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>, <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb4-953"><a href="#cb4-953"></a>  )</span>
<span id="cb4-954"><a href="#cb4-954"></a><span class="fu">print</span>(plots_subgroup_gender)</span>
<span id="cb4-955"><a href="#cb4-955"></a></span>
<span id="cb4-956"><a href="#cb4-956"></a></span>
<span id="cb4-957"><a href="#cb4-957"></a><span class="co"># example 4 – Religious vs Secular -------------------</span></span>
<span id="cb4-958"><a href="#cb4-958"></a>plots_subgroup_secular <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb4-959"><a href="#cb4-959"></a>  <span class="fu">list</span>(</span>
<span id="cb4-960"><a href="#cb4-960"></a>    planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>religions_secular<span class="sc">$</span>results<span class="sc">$</span><span class="st">`</span><span class="at">Not Religious</span><span class="st">`</span><span class="sc">$</span>plot,</span>
<span id="cb4-961"><a href="#cb4-961"></a>    planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>religions_secular<span class="sc">$</span>results<span class="sc">$</span><span class="st">`</span><span class="at">Religious</span><span class="st">`</span><span class="sc">$</span>plot</span>
<span id="cb4-962"><a href="#cb4-962"></a>  ), <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb4-963"><a href="#cb4-963"></a>  <span class="fu">plot_annotation</span>(</span>
<span id="cb4-964"><a href="#cb4-964"></a>    <span class="at">title =</span> <span class="st">"Secular vs Religious"</span>,</span>
<span id="cb4-965"><a href="#cb4-965"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>, <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb4-966"><a href="#cb4-966"></a>  )</span>
<span id="cb4-967"><a href="#cb4-967"></a><span class="fu">print</span>(plots_subgroup_secular)</span>
<span id="cb4-968"><a href="#cb4-968"></a></span>
<span id="cb4-969"><a href="#cb4-969"></a></span>
<span id="cb4-970"><a href="#cb4-970"></a></span>
<span id="cb4-971"><a href="#cb4-971"></a><span class="co"># 6. group‑vs‑group comparisons --------------------------------------</span></span>
<span id="cb4-972"><a href="#cb4-972"></a><span class="co">#   • `margot_compare_groups()` takes two transformed tables (risk‑diff)</span></span>
<span id="cb4-973"><a href="#cb4-973"></a><span class="co">#   • returns a *difference in differences* tibble + plain‑text interp.</span></span>
<span id="cb4-974"><a href="#cb4-974"></a></span>
<span id="cb4-975"><a href="#cb4-975"></a><span class="co"># example: young (&lt;35) vs older (&gt;62)</span></span>
<span id="cb4-976"><a href="#cb4-976"></a>group_comparison_age_young_old <span class="ot">&lt;-</span> <span class="fu">margot_compare_groups</span>(</span>
<span id="cb4-977"><a href="#cb4-977"></a>  <span class="at">group1_name =</span> <span class="st">"People Under 35 Years Old"</span>,</span>
<span id="cb4-978"><a href="#cb4-978"></a>  <span class="at">group2_name =</span> <span class="st">"People Over 62 Years Old"</span>, </span>
<span id="cb4-979"><a href="#cb4-979"></a>  planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span><span class="st">`</span><span class="at">Age &lt; 35</span><span class="st">`</span><span class="sc">$</span>transformed_table, <span class="co"># reference</span></span>
<span id="cb4-980"><a href="#cb4-980"></a>  planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span><span class="st">`</span><span class="at">Age &gt; 62</span><span class="st">`</span><span class="sc">$</span>transformed_table, <span class="co"># comparison</span></span>
<span id="cb4-981"><a href="#cb4-981"></a>  <span class="at">type            =</span> <span class="st">"RD"</span>,          <span class="co"># risk‑difference scale</span></span>
<span id="cb4-982"><a href="#cb4-982"></a>  <span class="at">decimal_places  =</span> <span class="dv">4</span></span>
<span id="cb4-983"><a href="#cb4-983"></a>)</span>
<span id="cb4-984"><a href="#cb4-984"></a><span class="fu">print</span>(group_comparison_age_young_old<span class="sc">$</span>results <span class="sc">|&gt;</span> <span class="fu">kbl</span>(<span class="st">"markdown"</span>, <span class="at">digits =</span> <span class="dv">2</span>))</span>
<span id="cb4-985"><a href="#cb4-985"></a><span class="fu">cat</span>(group_comparison_age_young_old<span class="sc">$</span>interpretation)</span>
<span id="cb4-986"><a href="#cb4-986"></a></span>
<span id="cb4-987"><a href="#cb4-987"></a></span>
<span id="cb4-988"><a href="#cb4-988"></a><span class="co"># 7. group‑vs‑group comparisons --------------------------------------</span></span>
<span id="cb4-989"><a href="#cb4-989"></a><span class="co">#   • `margot_compare_groups()` takes two transformed tables (risk‑diff)</span></span>
<span id="cb4-990"><a href="#cb4-990"></a><span class="co">#   • returns a *difference in differences* tibble + plain‑text interp.</span></span>
<span id="cb4-991"><a href="#cb4-991"></a></span>
<span id="cb4-992"><a href="#cb4-992"></a><span class="co"># example: young (&lt;35) vs older (&gt;62)</span></span>
<span id="cb4-993"><a href="#cb4-993"></a>group_comparison_secular_religious <span class="ot">&lt;-</span> <span class="fu">margot_compare_groups</span>(</span>
<span id="cb4-994"><a href="#cb4-994"></a>  <span class="at">group1_name =</span> <span class="st">"Secular People"</span>,</span>
<span id="cb4-995"><a href="#cb4-995"></a>  <span class="at">group2_name =</span> <span class="st">"People Who Identify With Religion"</span>, </span>
<span id="cb4-996"><a href="#cb4-996"></a>  planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>religions_secular<span class="sc">$</span>results<span class="sc">$</span><span class="st">`</span><span class="at">Not Religious</span><span class="st">`</span><span class="sc">$</span>transformed_table, <span class="co"># reference</span></span>
<span id="cb4-997"><a href="#cb4-997"></a>  planned_subset_results<span class="sc">$</span>wellbeing<span class="sc">$</span>religions_secular<span class="sc">$</span>results<span class="sc">$</span>Religious<span class="sc">$</span>transformed_table, <span class="co"># reference</span></span>
<span id="cb4-998"><a href="#cb4-998"></a>  <span class="at">type            =</span> <span class="st">"RD"</span>,          <span class="co"># risk‑difference scale</span></span>
<span id="cb4-999"><a href="#cb4-999"></a>  <span class="at">decimal_places  =</span> <span class="dv">3</span></span>
<span id="cb4-1000"><a href="#cb4-1000"></a>)</span>
<span id="cb4-1001"><a href="#cb4-1001"></a><span class="fu">print</span>(group_comparison_secular_religious<span class="sc">$</span>results <span class="sc">|&gt;</span> <span class="fu">kbl</span>(<span class="st">"markdown"</span>, <span class="at">digits =</span> <span class="dv">2</span>))</span>
<span id="cb4-1002"><a href="#cb4-1002"></a><span class="fu">cat</span>(group_comparison_secular_religious<span class="sc">$</span>interpretation)</span>
<span id="cb4-1003"><a href="#cb4-1003"></a></span>
<span id="cb4-1004"><a href="#cb4-1004"></a></span>
<span id="cb4-1005"><a href="#cb4-1005"></a></span>
<span id="cb4-1006"><a href="#cb4-1006"></a><span class="co"># note comparisons should be specified a priori, and you can save results as you</span></span>
<span id="cb4-1007"><a href="#cb4-1007"></a><span class="co"># for your manuscript</span></span>
<span id="cb4-1008"><a href="#cb4-1008"></a></span>
<span id="cb4-1009"><a href="#cb4-1009"></a></span>
<span id="cb4-1010"><a href="#cb4-1010"></a><span class="co"># end of theoretical comparisons block ---------------------------------</span></span>
<span id="cb4-1011"><a href="#cb4-1011"></a></span>
<span id="cb4-1012"><a href="#cb4-1012"></a></span>
<span id="cb4-1013"><a href="#cb4-1013"></a></span>
<span id="cb4-1014"><a href="#cb4-1014"></a><span class="co"># FOR APPENDIX IF DESIRED -------------------------------------------------</span></span>
<span id="cb4-1015"><a href="#cb4-1015"></a></span>
<span id="cb4-1016"><a href="#cb4-1016"></a></span>
<span id="cb4-1017"><a href="#cb4-1017"></a><span class="co"># helper: combine and save ggplot objects ---------------------------------</span></span>
<span id="cb4-1018"><a href="#cb4-1018"></a>combine_and_save <span class="ot">&lt;-</span> <span class="cf">function</span>(plots, prefix) {</span>
<span id="cb4-1019"><a href="#cb4-1019"></a>  <span class="cf">if</span> (<span class="fu">length</span>(plots) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb4-1020"><a href="#cb4-1020"></a>    <span class="fu">message</span>(<span class="st">"no "</span>, prefix, <span class="st">" plots to combine"</span>)</span>
<span id="cb4-1021"><a href="#cb4-1021"></a>    <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb4-1022"><a href="#cb4-1022"></a>  }</span>
<span id="cb4-1023"><a href="#cb4-1023"></a>  cols     <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">length</span>(plots) <span class="sc">&gt;</span> <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb4-1024"><a href="#cb4-1024"></a>  combined <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">reduce</span>(plots, <span class="st">`</span><span class="at">+</span><span class="st">`</span>) <span class="sc">+</span></span>
<span id="cb4-1025"><a href="#cb4-1025"></a>    patchwork<span class="sc">::</span><span class="fu">plot_layout</span>(<span class="at">ncol =</span> cols) <span class="sc">&amp;</span></span>
<span id="cb4-1026"><a href="#cb4-1026"></a>    patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb4-1027"><a href="#cb4-1027"></a>      <span class="at">title    =</span> <span class="fu">toupper</span>(prefix),</span>
<span id="cb4-1028"><a href="#cb4-1028"></a>      <span class="at">subtitle =</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{length(plots)} models"</span>),</span>
<span id="cb4-1029"><a href="#cb4-1029"></a>      <span class="at">tag_levels =</span> <span class="st">"A"</span></span>
<span id="cb4-1030"><a href="#cb4-1030"></a>    )</span>
<span id="cb4-1031"><a href="#cb4-1031"></a>  <span class="fu">print</span>(combined)</span>
<span id="cb4-1032"><a href="#cb4-1032"></a>  <span class="fu">ggsave</span>(</span>
<span id="cb4-1033"><a href="#cb4-1033"></a>    here<span class="sc">::</span><span class="fu">here</span>(push_mods, <span class="fu">paste0</span>(<span class="st">"combined_"</span>, prefix, <span class="st">".pdf"</span>)),</span>
<span id="cb4-1034"><a href="#cb4-1034"></a>    combined,</span>
<span id="cb4-1035"><a href="#cb4-1035"></a>    <span class="at">width  =</span> <span class="fu">ifelse</span>(cols <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">8</span>, <span class="dv">12</span>),</span>
<span id="cb4-1036"><a href="#cb4-1036"></a>    <span class="at">height =</span> <span class="dv">6</span> <span class="sc">*</span> <span class="fu">ceiling</span>(<span class="fu">length</span>(plots) <span class="sc">/</span> cols)</span>
<span id="cb4-1037"><a href="#cb4-1037"></a>  )</span>
<span id="cb4-1038"><a href="#cb4-1038"></a>  combined</span>
<span id="cb4-1039"><a href="#cb4-1039"></a>}</span>
<span id="cb4-1040"><a href="#cb4-1040"></a></span>
<span id="cb4-1041"><a href="#cb4-1041"></a><span class="co"># step 3: plot rate curves -----------------------------------------------</span></span>
<span id="cb4-1042"><a href="#cb4-1042"></a>autoc_plots <span class="ot">&lt;-</span></span>
<span id="cb4-1043"><a href="#cb4-1043"></a>  <span class="fu">margot_plot_rate_batch</span>(</span>
<span id="cb4-1044"><a href="#cb4-1044"></a>    <span class="at">models      =</span> models_binary_flipped_all,</span>
<span id="cb4-1045"><a href="#cb4-1045"></a>    <span class="at">save_plots  =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-1046"><a href="#cb4-1046"></a>    <span class="at">label_mapping      =</span> label_mapping_all,</span>
<span id="cb4-1047"><a href="#cb4-1047"></a>    <span class="at">model_names =</span> model_groups<span class="sc">$</span>autoc</span>
<span id="cb4-1048"><a href="#cb4-1048"></a>  )</span>
<span id="cb4-1049"><a href="#cb4-1049"></a>autoc_plots<span class="sc">$</span>model_t2_log_hours_exercise_z</span>
<span id="cb4-1050"><a href="#cb4-1050"></a></span>
<span id="cb4-1051"><a href="#cb4-1051"></a>combined_autoc <span class="ot">&lt;-</span> <span class="fu">combine_and_save</span>(autoc_plots, <span class="st">"rate_autoc"</span>)</span>
<span id="cb4-1052"><a href="#cb4-1052"></a></span>
<span id="cb4-1053"><a href="#cb4-1053"></a>qini_rate_plots <span class="ot">&lt;-</span></span>
<span id="cb4-1054"><a href="#cb4-1054"></a>  <span class="fu">margot_plot_rate_batch</span>(</span>
<span id="cb4-1055"><a href="#cb4-1055"></a>    <span class="at">models      =</span> models_binary_flipped_all,</span>
<span id="cb4-1056"><a href="#cb4-1056"></a>    <span class="at">save_plots  =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-1057"><a href="#cb4-1057"></a>    <span class="at">model_names =</span> model_groups<span class="sc">$</span>qini,</span>
<span id="cb4-1058"><a href="#cb4-1058"></a>    <span class="at">label_mapping      =</span> label_mapping_all</span>
<span id="cb4-1059"><a href="#cb4-1059"></a>  )</span>
<span id="cb4-1060"><a href="#cb4-1060"></a></span>
<span id="cb4-1061"><a href="#cb4-1061"></a>qini_rate_plots<span class="sc">$</span>model_t2_meaning_sense_z</span>
<span id="cb4-1062"><a href="#cb4-1062"></a></span>
<span id="cb4-1063"><a href="#cb4-1063"></a>combined_qini_rate <span class="ot">&lt;-</span> <span class="fu">combine_and_save</span>(qini_rate_plots, <span class="st">"rate_qini"</span>)</span>
<span id="cb4-1064"><a href="#cb4-1064"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"rate curves plotted ✔"</span>)</span>
<span id="cb4-1065"><a href="#cb4-1065"></a></span>
<span id="cb4-1066"><a href="#cb4-1066"></a><span class="co"># view </span></span>
<span id="cb4-1067"><a href="#cb4-1067"></a>autoc_plots<span class="sc">$</span>model_t2_log_hours_exercise_z</span>
<span id="cb4-1068"><a href="#cb4-1068"></a></span>
<span id="cb4-1069"><a href="#cb4-1069"></a><span class="co"># step 4: Qini model curves --------------------------------------------</span></span>
<span id="cb4-1070"><a href="#cb4-1070"></a>qini_policy_results <span class="ot">&lt;-</span></span>
<span id="cb4-1071"><a href="#cb4-1071"></a>  <span class="fu">margot_policy</span>(</span>
<span id="cb4-1072"><a href="#cb4-1072"></a>    models_binary_flipped_all,</span>
<span id="cb4-1073"><a href="#cb4-1073"></a>    <span class="at">save_plots         =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-1074"><a href="#cb4-1074"></a>    <span class="at">output_dir         =</span> here<span class="sc">::</span><span class="fu">here</span>(push_mods),</span>
<span id="cb4-1075"><a href="#cb4-1075"></a>    <span class="at">decision_tree_args =</span> <span class="fu">list</span>(),</span>
<span id="cb4-1076"><a href="#cb4-1076"></a>    <span class="at">policy_tree_args   =</span> <span class="fu">list</span>(),</span>
<span id="cb4-1077"><a href="#cb4-1077"></a>    <span class="at">model_names        =</span> model_groups<span class="sc">$</span>qini,</span>
<span id="cb4-1078"><a href="#cb4-1078"></a>    <span class="at">original_df        =</span> original_df,</span>
<span id="cb4-1079"><a href="#cb4-1079"></a>    <span class="at">label_mapping      =</span> label_mapping_all,</span>
<span id="cb4-1080"><a href="#cb4-1080"></a>    <span class="at">max_depth          =</span> <span class="dv">2</span>L,</span>
<span id="cb4-1081"><a href="#cb4-1081"></a>    <span class="at">output_objects     =</span> <span class="fu">c</span>(<span class="st">"qini_plot"</span>, <span class="st">"diff_gain_summaries"</span>)</span>
<span id="cb4-1082"><a href="#cb4-1082"></a>  )</span>
<span id="cb4-1083"><a href="#cb4-1083"></a></span>
<span id="cb4-1084"><a href="#cb4-1084"></a><span class="co"># view qini plots</span></span>
<span id="cb4-1085"><a href="#cb4-1085"></a>qini_plots <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(qini_policy_results, <span class="sc">~</span> .x<span class="sc">$</span>qini_plot)</span>
<span id="cb4-1086"><a href="#cb4-1086"></a>qini_plots</span>
<span id="cb4-1087"><a href="#cb4-1087"></a></span>
<span id="cb4-1088"><a href="#cb4-1088"></a>cli<span class="sc">::</span><span class="fu">cli_h1</span>(<span class="st">"Qini model curves plotted ✔"</span>)</span>
<span id="cb4-1089"><a href="#cb4-1089"></a></span>
<span id="cb4-1090"><a href="#cb4-1090"></a></span>
<span id="cb4-1091"><a href="#cb4-1091"></a><span class="co"># ILLLUSTRATIONS OF SETTINGS</span></span>
<span id="cb4-1092"><a href="#cb4-1092"></a><span class="co"># OPTIONS FOR DECISION TREES ----------------------------------------------</span></span>
<span id="cb4-1093"><a href="#cb4-1093"></a><span class="co"># plot options: showcased ---------------------------------------------</span></span>
<span id="cb4-1094"><a href="#cb4-1094"></a><span class="co"># default</span></span>
<span id="cb4-1095"><a href="#cb4-1095"></a><span class="fu">margot_plot_decision_tree</span>(models_binary, <span class="st">"model_t2_support_z"</span>, )</span>
<span id="cb4-1096"><a href="#cb4-1096"></a><span class="co"># tighten branches for easier viewing in single graphs</span></span>
<span id="cb4-1097"><a href="#cb4-1097"></a>margot<span class="sc">::</span><span class="fu">margot_plot_decision_tree</span>(</span>
<span id="cb4-1098"><a href="#cb4-1098"></a>  models_binary,</span>
<span id="cb4-1099"><a href="#cb4-1099"></a>  <span class="st">"model_t2_support_z"</span>,</span>
<span id="cb4-1100"><a href="#cb4-1100"></a>  <span class="at">span_ratio =</span> .<span class="dv">30</span>,</span>
<span id="cb4-1101"><a href="#cb4-1101"></a>  <span class="at">text_size =</span> <span class="fl">3.8</span>,</span>
<span id="cb4-1102"><a href="#cb4-1102"></a>  <span class="at">border_size =</span> .<span class="dv">1</span>,</span>
<span id="cb4-1103"><a href="#cb4-1103"></a>  <span class="co">#  title = "none",</span></span>
<span id="cb4-1104"><a href="#cb4-1104"></a>  <span class="at">original_df =</span> original_df</span>
<span id="cb4-1105"><a href="#cb4-1105"></a>)</span>
<span id="cb4-1106"><a href="#cb4-1106"></a><span class="co"># colour decision node</span></span>
<span id="cb4-1107"><a href="#cb4-1107"></a>margot<span class="sc">::</span><span class="fu">margot_plot_decision_tree</span>(</span>
<span id="cb4-1108"><a href="#cb4-1108"></a>  models_binary,</span>
<span id="cb4-1109"><a href="#cb4-1109"></a>  <span class="st">"model_t2_support_z"</span>,</span>
<span id="cb4-1110"><a href="#cb4-1110"></a>  <span class="at">span_ratio =</span> .<span class="dv">3</span>,</span>
<span id="cb4-1111"><a href="#cb4-1111"></a>  <span class="at">text_size =</span> <span class="dv">4</span>,</span>
<span id="cb4-1112"><a href="#cb4-1112"></a>  <span class="at">title =</span> <span class="st">"New Title"</span>,</span>
<span id="cb4-1113"><a href="#cb4-1113"></a>  <span class="at">non_leaf_fill =</span>  <span class="st">"violet"</span>,</span>
<span id="cb4-1114"><a href="#cb4-1114"></a>  <span class="at">original_df =</span> original_df</span>
<span id="cb4-1115"><a href="#cb4-1115"></a>)</span>
<span id="cb4-1116"><a href="#cb4-1116"></a><span class="co"># make new title</span></span>
<span id="cb4-1117"><a href="#cb4-1117"></a>margot<span class="sc">::</span><span class="fu">margot_plot_decision_tree</span>(</span>
<span id="cb4-1118"><a href="#cb4-1118"></a>  models_binary,</span>
<span id="cb4-1119"><a href="#cb4-1119"></a>  <span class="st">"model_t2_support_z"</span>,</span>
<span id="cb4-1120"><a href="#cb4-1120"></a>  <span class="at">span_ratio =</span> .<span class="dv">2</span>,</span>
<span id="cb4-1121"><a href="#cb4-1121"></a>  <span class="at">text_size =</span> <span class="dv">3</span>,</span>
<span id="cb4-1122"><a href="#cb4-1122"></a>  <span class="at">title =</span> <span class="st">"New Title"</span>,</span>
<span id="cb4-1123"><a href="#cb4-1123"></a>  <span class="at">non_leaf_fill =</span>  <span class="st">"white"</span>,</span>
<span id="cb4-1124"><a href="#cb4-1124"></a>  <span class="at">original_df =</span> original_df</span>
<span id="cb4-1125"><a href="#cb4-1125"></a>)</span>
<span id="cb4-1126"><a href="#cb4-1126"></a></span>
<span id="cb4-1127"><a href="#cb4-1127"></a><span class="co"># remove title</span></span>
<span id="cb4-1128"><a href="#cb4-1128"></a>margot<span class="sc">::</span><span class="fu">margot_plot_decision_tree</span>(</span>
<span id="cb4-1129"><a href="#cb4-1129"></a>  models_binary,</span>
<span id="cb4-1130"><a href="#cb4-1130"></a>  <span class="st">"model_t2_support_z"</span>,</span>
<span id="cb4-1131"><a href="#cb4-1131"></a>  <span class="at">text_size =</span> <span class="dv">5</span>,</span>
<span id="cb4-1132"><a href="#cb4-1132"></a>  <span class="at">title =</span> <span class="st">'none'</span>,</span>
<span id="cb4-1133"><a href="#cb4-1133"></a>  <span class="co"># set title to none</span></span>
<span id="cb4-1134"><a href="#cb4-1134"></a>  <span class="at">original_df =</span> original_df</span>
<span id="cb4-1135"><a href="#cb4-1135"></a>)</span>
<span id="cb4-1136"><a href="#cb4-1136"></a></span>
<span id="cb4-1137"><a href="#cb4-1137"></a></span>
<span id="cb4-1138"><a href="#cb4-1138"></a><span class="co"># adjust only the alpha</span></span>
<span id="cb4-1139"><a href="#cb4-1139"></a>margot<span class="sc">::</span><span class="fu">margot_plot_policy_tree</span>(models_binary, <span class="st">"model_t2_support_z"</span>, <span class="at">point_alpha =</span> .<span class="dv">1</span>)</span>
<span id="cb4-1140"><a href="#cb4-1140"></a>margot<span class="sc">::</span><span class="fu">margot_plot_policy_tree</span>(models_binary, <span class="st">"model_t2_support_z"</span>, <span class="at">point_alpha =</span> .<span class="dv">9</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="homework-prepare-a-fresh-set-of-analysis-scripts-using-a-different-exposure" class="level2">
<h2 class="anchored" data-anchor-id="homework-prepare-a-fresh-set-of-analysis-scripts-using-a-different-exposure">HOMEWORK: Prepare a fresh set of analysis scripts using a different exposure</h2>
<ul>
<li>E.g. Ask: what are the effects of a shift in religious service <code>religion_church</code> on multi-dimensional well-being.</li>
<li>Consider what variables you need for confounding control at baseline.</li>
<li>Think about how to make the exposure variable binary.</li>
<li>You may consider different outcome(s) as well as a different exposure.</li>
</ul>
<section id="packages" class="level3">
<h3 class="anchored" data-anchor-id="packages">Packages</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>report<span class="sc">::</span><span class="fu">cite_packages</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  - Bulbulia J (2024). _boilerplate_. doi:10.5281/zenodo.13370825 &lt;https://doi.org/10.5281/zenodo.13370825&gt;, R package version 1.0.43, &lt;https://go-bayes.github.io/biolerplate/&gt;.
  - Bulbulia J (2024). _margot: MARGinal Observational Treatment-effects_. doi:10.5281/zenodo.10907724 &lt;https://doi.org/10.5281/zenodo.10907724&gt;, R package version 1.0.47 Functions to obtain MARGinal Observational Treatment-effects from observational data., &lt;https://go-bayes.github.io/margot/&gt;.
  - Chang W (2023). _extrafont: Tools for Using Fonts_. doi:10.32614/CRAN.package.extrafont &lt;https://doi.org/10.32614/CRAN.package.extrafont&gt;, R package version 0.19, &lt;https://CRAN.R-project.org/package=extrafont&gt;.
  - Grolemund G, Wickham H (2011). "Dates and Times Made Easy with lubridate." _Journal of Statistical Software_, *40*(3), 1-25. &lt;https://www.jstatsoft.org/v40/i03/&gt;.
  - Müller K (2020). _here: A Simpler Way to Find Your Files_. doi:10.32614/CRAN.package.here &lt;https://doi.org/10.32614/CRAN.package.here&gt;, R package version 1.0.1, &lt;https://CRAN.R-project.org/package=here&gt;.
  - Müller K, Wickham H (2023). _tibble: Simple Data Frames_. doi:10.32614/CRAN.package.tibble &lt;https://doi.org/10.32614/CRAN.package.tibble&gt;, R package version 3.2.1, &lt;https://CRAN.R-project.org/package=tibble&gt;.
  - Pedersen T (2024). _patchwork: The Composer of Plots_. doi:10.32614/CRAN.package.patchwork &lt;https://doi.org/10.32614/CRAN.package.patchwork&gt;, R package version 1.3.0, &lt;https://CRAN.R-project.org/package=patchwork&gt;.
  - R Core Team (2025). _R: A Language and Environment for Statistical Computing_. R Foundation for Statistical Computing, Vienna, Austria. &lt;https://www.R-project.org/&gt;.
  - Wickham H (2016). _ggplot2: Elegant Graphics for Data Analysis_. Springer-Verlag New York. ISBN 978-3-319-24277-4, &lt;https://ggplot2.tidyverse.org&gt;.
  - Wickham H (2023). _forcats: Tools for Working with Categorical Variables (Factors)_. doi:10.32614/CRAN.package.forcats &lt;https://doi.org/10.32614/CRAN.package.forcats&gt;, R package version 1.0.0, &lt;https://CRAN.R-project.org/package=forcats&gt;.
  - Wickham H (2023). _stringr: Simple, Consistent Wrappers for Common String Operations_. doi:10.32614/CRAN.package.stringr &lt;https://doi.org/10.32614/CRAN.package.stringr&gt;, R package version 1.5.1, &lt;https://CRAN.R-project.org/package=stringr&gt;.
  - Wickham H, Averick M, Bryan J, Chang W, McGowan LD, François R, Grolemund G, Hayes A, Henry L, Hester J, Kuhn M, Pedersen TL, Miller E, Bache SM, Müller K, Ooms J, Robinson D, Seidel DP, Spinu V, Takahashi K, Vaughan D, Wilke C, Woo K, Yutani H (2019). "Welcome to the tidyverse." _Journal of Open Source Software_, *4*(43), 1686. doi:10.21105/joss.01686 &lt;https://doi.org/10.21105/joss.01686&gt;.
  - Wickham H, François R, Henry L, Müller K, Vaughan D (2023). _dplyr: A Grammar of Data Manipulation_. doi:10.32614/CRAN.package.dplyr &lt;https://doi.org/10.32614/CRAN.package.dplyr&gt;, R package version 1.1.4, &lt;https://CRAN.R-project.org/package=dplyr&gt;.
  - Wickham H, Henry L (2025). _purrr: Functional Programming Tools_. doi:10.32614/CRAN.package.purrr &lt;https://doi.org/10.32614/CRAN.package.purrr&gt;, R package version 1.0.4, &lt;https://CRAN.R-project.org/package=purrr&gt;.
  - Wickham H, Hester J, Bryan J (2024). _readr: Read Rectangular Text Data_. doi:10.32614/CRAN.package.readr &lt;https://doi.org/10.32614/CRAN.package.readr&gt;, R package version 2.1.5, &lt;https://CRAN.R-project.org/package=readr&gt;.
  - Wickham H, Vaughan D, Girlich M (2024). _tidyr: Tidy Messy Data_. doi:10.32614/CRAN.package.tidyr &lt;https://doi.org/10.32614/CRAN.package.tidyr&gt;, R package version 1.3.1, &lt;https://CRAN.R-project.org/package=tidyr&gt;.
  - Xie Y (2025). _tinytex: Helper Functions to Install and Maintain TeX Live, and Compile LaTeX Documents_. R package version 0.57, &lt;https://github.com/rstudio/tinytex&gt;. Xie Y (2019). "TinyTeX: A lightweight, cross-platform, and easy-to-maintain LaTeX distribution based on TeX Live." _TUGboat_, *40*(1), 30-32. &lt;https://tug.org/TUGboat/Contents/contents40-1.html&gt;.
  - Zhu H (2024). _kableExtra: Construct Complex Table with 'kable' and Pipe Syntax_. doi:10.32614/CRAN.package.kableExtra &lt;https://doi.org/10.32614/CRAN.package.kableExtra&gt;, R package version 1.4.0, &lt;https://CRAN.R-project.org/package=kableExtra&gt;.</code></pre>
</div>
</div>
</section>
</section>
<section id="appendix" class="level2">
<h2 class="anchored" data-anchor-id="appendix">Appendix</h2>
</section>
<section id="review-the-fundamental-problem-of-causal-inference-as-a-missing-data-problem" class="level2">
<h2 class="anchored" data-anchor-id="review-the-fundamental-problem-of-causal-inference-as-a-missing-data-problem">Review: The Fundamental Problem of Causal Inference as a Missing Data Problem</h2>
<p>Recall the fundamental problem of causal inference, returning to the question of whether bilingualism improves cognitive abilities:</p>
<ul>
<li><span class="math inline">Y_i^{a = 1}</span>: The cognitive ability of child <span class="math inline">i</span> if they were bilingual. This is the counterfactual outcome when A = 1.</li>
<li><span class="math inline">Y_i^{a = 0}</span>:: The cognitive ability of child <span class="math inline">i</span> if they were monolingual. This is the counterfactual outcome when A = 0.</li>
</ul>
<p>The causal effect of bilingualism on cognitive ability for individual <span class="math inline">i</span> is then defined as the difference between these potential outcomes:</p>
<p><span class="math display">
\text{Causal Effect}_i = Y_i^{a=1} - Y_i^{a=0}
</span></p>
<p>We say there is a causal effect if:</p>
<p><span class="math display">
Y_i^{a=1} - Y_i^{a=0}  \neq 0
</span></p>
<p>However, we only observe one of the potential outcomes for each child. The other outcome is not observed because physics prevents a child from both receiving and not receiving bilingual exposure.</p>
<p>The fact that causal contrasts are not observed in individuals is called “The fundamental problem of causal inference.”</p>
<p>Although we typically cannot observe individual causal effects, we can obtain average causal effects when certain assumptions are satisfied.</p>
<span class="math display">\begin{align}
E(\delta) = E(Y^{a=1} - Y^{a=0})\\
          ~  = E(Y^{a=1}) - E(Y^{a=0}) \\
          ~  = ATE
\end{align}</span>
<p>We may identify average causal effects from the data when the following assumptions are met:</p>
<ul>
<li><strong>Causal Consistency:</strong> The exposure values under comparisons correspond to well-defined interventions that, in turn, correspond to the treatment versions in the data.[]</li>
<li><strong>Positivity:</strong> The probability of receiving every value of the exposure within all strata of co-variates is greater than zero []</li>
<li><strong>Exchangeability:</strong> The conditional probability of receiving every value of an exposure level, though not decided by the investigators, depends only on the measured covariates []</li>
</ul>
<p>Further assumptions:</p>
<ul>
<li><strong>No Interference,</strong> also known as the <strong>Stable Unit Treatment Value Assumption</strong> (SUTVA), requires that the treatment given to one unit (e.g., person, group, organization) does not interfere with the potential outcomes of another unit. Put differently, there are no “spillover” effects. Note: this assumption may be thought to be part of causal consistency, namely individual has only one potential outcome under each treatment condition.</li>
<li><strong>Correctly specified model</strong>: the requirement that the underlying statistical model used to estimate causal effects accurately represents the true relationships between the variables of interest. We say the model should be able to capture “the functional form” of the relationship between the treatment, the outcome, and any covariates. The model’s functional form should be flexible enough to capture the true underlying relationship. The estimated causal effects may be biased if the model’s functional form is incorrect. Additionally, the model must handle omitted variable bias by including all relevant confounders and should correctly handle missing data from non-response or loss-to follow up. We will return to the bias arising from missing data in the weeks ahead. For now, it is important to note that causal inference assumes that our model is correctly specified.</li>
</ul>
</section>
<section id="subgroup-analysis" class="level2">
<h2 class="anchored" data-anchor-id="subgroup-analysis">Subgroup analysis</h2>
<p>Redcall, <strong>Effect Modification</strong> (also known as “heterogeneity of treatment effects”, and “Effect-measure modification”) occurs when the causal effect of intervention <span class="math inline">A</span> varies across different levels of another variable <span class="math inline">R</span>:</p>
<p><span class="math display">E(Y^{a=1}|G=g_1, L=l) - E(Y^{a=0}|G=g_1, L=l) \neq E(Y^{a=1}|G=g_2, L=l) - E(Y^{a=0}|G=g_2, L=l)</span></p>
<p>Effect modification indicates that the magnitude of the causal effect of intervention <span class="math inline">A</span> is related to the modifier variable <span class="math inline">G</span> level. As discussed last week, effect modification can be observed even when there is no direct causal interaction between the treatment and the modifier variable. We noted that <strong>interaction in causal inference refers to a situation where the combined effect of two interventions is not equal to the sum of their individual effects</strong>. <strong>Effect modification, on the other hand, occurs when the causal effect of one intervention varies across different levels of another variable.</strong></p>
<p>We also noted that</p>
<blockquote class="blockquote">
<p><strong>For comparative research, we are typically interested in effect-modification, which requires subgroup analysis.</strong></p>
</blockquote>
<section id="causal-estimand-statistical-estimand-statistical-estimator" class="level3">
<h3 class="anchored" data-anchor-id="causal-estimand-statistical-estimand-statistical-estimator">Causal Estimand, Statistical Estimand, Statistical Estimator</h3>
<p>Let’s set subgroup analysis to the side for a moment and begin focussing on statistical estimation.</p>
<p>Suppose a researcher wants to understand the causal effect of marriage on individual happiness. Participants in the study are surveyed for their marital status (“married” or “not married”) and their self-reported happiness on a scale from 1 to 10.</p>
<section id="causal-estimand" class="level4">
<h4 class="anchored" data-anchor-id="causal-estimand">Causal Estimand</h4>
<ul>
<li><p><strong>Definition</strong>: The causal estimand is the specific quantity or parameter that we aim to estimate to understand the causal effect of an intervention or treatment on an outcome.</p></li>
<li><p><strong>Example</strong>: Here, the <strong>Causal Estimand</strong> would be the Average Treatment Effect (ATE) of being married on happiness. Specifically, we define the ATE as the difference in the potential outcomes of happiness if all individuals were married versus if no individuals were married:</p>
<p><span class="math display">
\text{ATE} = E[Y^{a=1} - Y^{a=0}]
</span></p>
<p>Here, <span class="math inline">Y^{a=1}</span> represents the potential happiness score if an individual is married, and <span class="math inline">Y^{a=0}</span> if they are not married.</p></li>
</ul>
</section>
<section id="next-step-are-causal-assumptions-met" class="level4">
<h4 class="anchored" data-anchor-id="next-step-are-causal-assumptions-met">Next step: Are Causal Assumptions Met?</h4>
<ul>
<li><p>Identification (Exchangeability): balance in the confounders across the treatments to be compared</p></li>
<li><p>Consistency: well-defined interventions</p></li>
<li><p>Positivity: treatments occur within levels of covariates <span class="math inline">L</span></p></li>
</ul>
</section>
<section id="statistical-estimand-next-step" class="level4">
<h4 class="anchored" data-anchor-id="statistical-estimand-next-step">Statistical Estimand (next step)</h4>
<ul>
<li><p><strong>The problem</strong>: how do we bridge the gap between potential outcomes and data?</p></li>
<li><p><strong>Definition</strong>: the statistical estimand is the parameter or function that summarises the relationship between variables as described by a statistical model applied to data.</p></li>
<li><p><strong>Example</strong>: for our study, the <strong>Statistical Estimand</strong> might be the mean difference in happiness scores between individuals who are married and those who are not, as derived from a linear regression model:</p>
<p><span class="math display">
\text{Happiness} = \beta_0 + \beta_1 \times \text{Married} + \epsilon
</span></p>
<p>In this equation, <span class="math inline">\beta_1</span> represents the estimated difference in happiness scores between the married and non-married groups.</p></li>
</ul>
</section>
<section id="statistical-estimator" class="level4">
<h4 class="anchored" data-anchor-id="statistical-estimator">Statistical Estimator</h4>
<ul>
<li><p><strong>Definition</strong>: a statistical estimator is a rule or method by which a numerical estimate of a statistical estimand is calculated from the data.</p></li>
<li><p><strong>Example</strong>: in our marriage study, the <strong>Statistical Estimator</strong> for <span class="math inline">\beta_1</span> is the ordinary least squares (OLS) estimator. This estimator is used to calculate <span class="math inline">\beta_1</span> from the sample data provided by the survey. It provides an estimate of the impact of being married on happiness, calculated using: <span class="math display">
\hat{\beta}_1 = \frac{\sum_{i=1}^n (X_i - \bar{X})(Y_i - \bar{Y})}{\sum_{i=1}^n (X_i - \bar{X})^2}
</span> where <span class="math inline">X_i</span> is a binary indicator for being married (1 for married, 0 for not married), <span class="math inline">Y_i</span> is the observed happiness score, and <span class="math inline">\bar{X}</span>, <span class="math inline">\bar{Y}</span> are the sample means of <span class="math inline">X</span> and <span class="math inline">Y</span>, respectively.</p></li>
</ul>
<p>The upshot, we anchor our causal inquiries within a multi-step framework of data analysis. This involves:</p>
<ol type="1">
<li>clearly defining our causal estimand within a specified <em>target population,</em></li>
<li>clarifying assumptions, &amp; especially identification assumptions,</li>
<li>describing a statistical strategy for extracting this estimand from the data, and then</li>
<li>applying an algorithm that embodies this statistical method.</li>
</ol>
<!-- ## Methods for Statistical Estimation in Causal Inference: Inverse Probability of Treatment Weights Using Propensity Scores -->
<!-- Last week, we discussed confounding control using regression adjustment. Recall the formula for the average treatment effect (ATE) when conditioning on a set of covariates $L$: -->
<!-- $$ -->
<!-- \begin{aligned} -->
<!-- \text{ATE} = E[Y^{a=1} \mid L = l] - E[Y^{a=0} \mid L = l] \quad \text{for any value of } l -->
<!-- \end{aligned} -->
<!-- $$ -->
<!-- > "We say that a set $L$ of measured non-descendants of $L$ is a sufficient set for confounding adjustment when conditioning on $L$ blocks all backdoor paths—that is, the treated and the untreated are exchangeable within levels of $L$" (Hernán & Robins, *Causal Inference*, p. 86). -->
<!-- This formula calculates the expected outcome difference between treated ($a=1$) and untreated ($a=0$) groups, given a specific value of the covariates $l$. -->
<!-- Inverse Probability of Treatment Weighting (IPTW) takes a different approach. We create a pseudo-population where the treatment assignment is independent of the observed covariates by assigning weights to each individual based on their propensity scores. -->
<!-- **We do this by modelling the treatment** -->
<!-- Denote the treatment indicator by $A$, where $A = 1$ if an individual receives treatment and $A = 0$ otherwise. $L$ represents the vector of observed covariates, and $Y^a$ the potential outcomes. The propensity score, $e(L)$, is defined as the probability of receiving the treatment given the observed covariates: -->
<!-- $$ -->
<!-- \hat{e}(L) = P(A = 1 \mid L) -->
<!-- $$ -->
<!-- To obtain IPTW weights, compute the inverse probability of treatment: -->
<!-- $$ -->
<!-- v_i = \frac{A_i}{\hat{e}(L_i)} + \frac{1 - A_i}{1 - \hat{e}(L_i)} -->
<!-- $$ -->
<!-- Which simplifies to  -->
<!-- $$ -->
<!-- v_i =  -->
<!-- \begin{cases}  -->
<!-- \frac{1}{\hat{e}} & \text{if } A_i = 1 \\ -->
<!-- \frac{1}{1-\hat{e}} & \text{if } A_i = 0  -->
<!-- \end{cases} -->
<!-- $$ -->
<!-- where $v_i$ is the IPTW weight for individual $i$, $A_i$ is the treatment indicator for individual $i$, and $\hat{e}(L_i)$ is the estimated propensity score for individual $i$.    -->
<!-- How might we use these weights to obtain causal effect estimates? -->
<!-- ## Marginal Structural Models (MSMs) -->
<!-- Marginal Structural Models (MSMs) estimate causal effects without requiring an "outcome model" that stratifies on covariates. Rather, MSMs employ weights derived from the inverse probability of treatment weighting (IPTW) to create a pseudo-population in which the distribution of covariates is independent of treatment assignment over time. -->
<!-- The general form of an MSM can be expressed as follows: -->
<!-- $$ -->
<!-- E[Y^a] = \beta_0 + \beta_1a -->
<!-- $$ -->
<!-- where $E[Y^a]$ is the expected outcome under treatment $a$  and $\beta_0$ and $\beta_1$ are parameters estimated by fitting the weighted model. Again, the weights used in the MSM, typically derived from the IPTW (or another treatment model), adjust for the confounding, allowing the model to estimate the unbiased effect of the treatment on the outcome without requiring covariates in the model. -->
<!-- Where do weights fit in?   Note, we have $E[Y^a]$ in please of $E[Y|A=a]$.  When applying propensity score weights in the linear regression model $E[Y^a] = \beta_0 + \beta_1a$, each observation is weighted by $v_i$, such that $v_i(\beta_0 + \beta_1a)$. This changes the estimation process to focus on a weighted sum of outcomes, where each individual's contribution is adjusted to reflect their probability of receiving the treatment, given their covariates. -->
<!-- ## Interpretation of $\beta_0$ and $\beta_1$  in a Marginal Structural Model -->
<!-- ### Binary Treatment -->
<!-- In models where the treatment $a$ is binary (e.g., $a = 0$ or $a = 1$), such as in many causal inference studies: -->
<!-- - **$\beta_0$**: the expected value of the outcome $Y$ when the treatment is not applied ($a = 0$). This is the baseline level of the outcome in the absence of treatment. -->
<!-- - **$\beta_1$**: the change in the expected outcome when the treatment status changes from 0 to 1. In logistic regression, $\beta_1$ represents the log-odds ratio of the outcome for the treatment group relative to the control group. In linear regression, $\beta_1$ quantifies the difference in the average outcome between the treated and untreated groups. -->
<!-- ### Continuous Treatment -->
<!-- When the treatment $a$ is continuous, the interpretation of $\beta_0$ and $\beta_1$ adjusts slightly: -->
<!-- - **$\beta_0$**: represents the expected value of the outcome $Y$ when the treatment $a$ is at its reference value (often zero).  -->
<!-- - **$\beta_1$**: represents the expected change in the outcome for each unit increase in the treatment. In this case, $\beta_1$ measures the gradient or slope of the relationship between the treatment and the outcome. For every one-unit increase in treatment, the outcome changes by $\beta_1$ units, assuming all other factors remain constant. -->
<!-- ###  How can we apply marginal structural models in subgroups?  -->
<!-- ### Assumptions -->
<!-- - **Model assumptions**: the treatment model is correctly specified. -->
<!-- - **Causal assumptions**: all confounders are appropriately controlled, positivity and consistency assumptions hold. -->
<!-- ### Calculating Treatment Weights (Propensity Scores) and Confounding Control in Subgroups -->
<!-- We may often achieve greater balance when conducting weighted analyses in subgroups by estimating propensity scores *within* these subgroups. The propensity score $ e(L, G) $ is the conditional probability of receiving the exposure $ A = 1 $, given the covariates $ L $ and subgroup indicator $ G $. This is often modelled using logistic regression or other methods that ensure covariate balance -->
<!-- We define the estimated propensity score as follows: -->
<!-- $$ -->
<!-- \hat{e} = P(A = 1 \mid L, G) = f_A(L, G; \theta_A) -->
<!-- $$ -->
<!-- Here, $ f_A(L, G; \theta_A) $ is the statistical model estimating the probability of exposure $A = 1$ given covariates $L$ and subgroup $G$. We then calculate the weights for each individual, denoted $v$, using the estimated propensity score: -->
<!-- $\theta_A$ encapsulates all the coefficients (parameters) in this model, including intercepts, slopes, and potentially other parameters depending on the model complexity (e.g., interaction terms, non-linear effects...etc). -->
<!-- These weights $v$ depend on $A$ and are calculated as the inverse of the propensity score for exposed individuals and as the inverse of $ 1-\hat{e} $ for unexposed individuals. -->
<!-- Propensity scores are estimated *separately* within strata of the subgroup to control for potential confounding tailored to each subgroup. These weights $v$ are specific to each individual in subgroup $G$. In the lab, we will clarify how to fit models to estimate contrasts for the causal effects within groups $\hat{\delta}_{g}, \hat{\delta}_{g'}$, etc., and how to obtain estimates for group-wise differences: -->
<!-- $$ -->
<!-- \hat{\gamma} = \overbrace{\big( \hat{E}[Y^a \mid G=g] - \hat{E}[Y^{a'} \mid G=g] \big)}^{\hat{\delta}_g} - \overbrace{\big( \hat{E}[Y^{a'} \mid G=g'] - \hat{E}[Y^a \mid G=g'] \big)}^{\hat{\delta}_{g'}} -->
<!-- $$ -->
<!-- - **$\hat{E}[Y^a \mid G=g]$**: Estimated expected outcome when treatment $a$ is applied to subgroup $G=g$. -->
<!-- - **$\hat{E}[Y^{a'} \mid G=g]$**: Estimated expected outcome when a different treatment or control $a'$ is applied to the same subgroup $G=g$. -->
<!-- - **$\hat{\delta}_g$**: Represents the estimated treatment effect within subgroup $G=g$, computed as the difference in expected outcomes between treatment $a$ and $a'$ within this subgroup. -->
<!-- - **$\hat{E}[Y^{a'} \mid G=g']$**: Estimated expected outcome when treatment $a'$ is applied to a different subgroup $G=g'$. -->
<!-- - **$\hat{E}[Y^a \mid G=g']$**: Estimated expected outcome when treatment $a$ is applied to subgroup $G=g'$. -->
<!-- - **$\hat{\delta}_{g'}$**: Represents the estimated treatment effect within subgroup $G=g'$, computed as the difference in expected outcomes between treatment $a'$ and $a$ within this subgroup. -->
<!-- - **$\hat{\gamma}$**: The overall measure calculated from your formula represents the difference in treatment effects between two subgroups, $G=g$ and $G=g'$. It quantifies how the effect of switching between treatments $a$ and $a'$ differs across the two subgroups. -->
<!-- ### Considerations -->
<!-- - **Estimation**: to estimate the expected outcomes $\hat{E}[Y^a \mid G]$ and $\hat{E}[Y^{a'} \mid G]$, we require statistical models. If we use regression, we include interaction terms between treatment and subgroup indicators to directly estimate subgroup-specific treatment effects. Our use depends on correct model specification. -->
<!-- - **Confidence intervals**: we may compute confidence intervals for $\hat{\gamma}$ using bootstrap, the delta method, or -- in our excercises -- simulation based methods. -->
<!-- - **Causal assumptions**: again, a causal interpretation of $\hat{\gamma}$ relies on satisfying both causal assumptions and modelling assumptions.  Here, we have described estimation using propensity scores. -->
<!-- ## Doubly Robust Estimation -->
<!-- We can combine regression-based estimation with propensity score estimation to obtain *doubly robust* estimation. I will walk you through the steps in the lab. The TL;DR is this: doubly robust estimation reduces reliance on correct model specification. If either the PS model or the regression model is correctly specified, the model will be unbiased -- if the other causal inference assumptions are met. -->
<!-- We cannot know whether these assumptions are met, we will need to do a sensitivity analysis, the topic of next week. -->
<!-- I'll show you in lab how to employ simulation-based inference methods to compute standard errors and confidence intervals, following the approaches suggested by Greifer (2023)[]. -->
<!-- ## Extra Readings n on Propensity Scores: -->
<!-- Noah Griefer's Software and Blogs: [https://ngreifer.github.io/blog/subgroup-analysis-psm/](https://ngreifer.github.io/blog/) -->


<!-- -->


</section>
</section>
</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb7" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb7-1"><a href="#cb7-1"></a><span class="co">---</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="an">title:</span><span class="co"> "Estimation of ATE and CATE Using Machine Learning"</span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="an">date:</span><span class="co"> "2025-APR-29"</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="an">format:</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="co">  html:</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="co">    warnings: false</span></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="co">    error: false</span></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="co">    messages: false</span></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="co">    code-overflow: scroll</span></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="co">    highlight-style: Ayu</span></span>
<span id="cb7-11"><a href="#cb7-11"></a><span class="co">    code-line-numbers: true</span></span>
<span id="cb7-12"><a href="#cb7-12"></a><span class="co">    code-fold: false</span></span>
<span id="cb7-13"><a href="#cb7-13"></a><span class="co">    code-tools:</span></span>
<span id="cb7-14"><a href="#cb7-14"></a><span class="co">      source: true</span></span>
<span id="cb7-15"><a href="#cb7-15"></a><span class="co">      toggle: false</span></span>
<span id="cb7-16"><a href="#cb7-16"></a><span class="an">html-math-method:</span><span class="co"> katex</span></span>
<span id="cb7-17"><a href="#cb7-17"></a><span class="an">reference-location:</span><span class="co"> margin</span></span>
<span id="cb7-18"><a href="#cb7-18"></a><span class="an">citation-location:</span><span class="co"> margin</span></span>
<span id="cb7-19"><a href="#cb7-19"></a><span class="an">cap-location:</span><span class="co"> margin</span></span>
<span id="cb7-20"><a href="#cb7-20"></a><span class="an">code-block-border-left:</span><span class="co"> true</span></span>
<span id="cb7-21"><a href="#cb7-21"></a><span class="an">bibliography:</span><span class="co"> /Users/joseph/GIT/templates/bib/references.bib</span></span>
<span id="cb7-22"><a href="#cb7-22"></a><span class="an">editor_options:</span><span class="co"> </span></span>
<span id="cb7-23"><a href="#cb7-23"></a><span class="co">  chunk_output_type: console</span></span>
<span id="cb7-24"><a href="#cb7-24"></a><span class="co">---</span></span>
<span id="cb7-25"><a href="#cb7-25"></a></span>
<span id="cb7-28"><a href="#cb7-28"></a><span class="in">```{r}</span></span>
<span id="cb7-29"><a href="#cb7-29"></a><span class="co">#| eval: true</span></span>
<span id="cb7-30"><a href="#cb7-30"></a><span class="co">#| include: false</span></span>
<span id="cb7-31"><a href="#cb7-31"></a><span class="co">#| echo: false</span></span>
<span id="cb7-32"><a href="#cb7-32"></a><span class="co"># libraries</span></span>
<span id="cb7-33"><a href="#cb7-33"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(margot, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb7-34"><a href="#cb7-34"></a>  devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"go-bayes/margot"</span>) <span class="co"># ensure version is at least 1.0.45</span></span>
<span id="cb7-35"><a href="#cb7-35"></a>  <span class="fu">library</span>(<span class="st">"margot"</span>)</span>
<span id="cb7-36"><a href="#cb7-36"></a>}</span>
<span id="cb7-37"><a href="#cb7-37"></a></span>
<span id="cb7-38"><a href="#cb7-38"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(boilerplate, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb7-39"><a href="#cb7-39"></a>  devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"go-bayes/boilerplate"</span>) <span class="co"># </span></span>
<span id="cb7-40"><a href="#cb7-40"></a>}</span>
<span id="cb7-41"><a href="#cb7-41"></a></span>
<span id="cb7-42"><a href="#cb7-42"></a><span class="fu">library</span>(<span class="st">"tinytex"</span>)</span>
<span id="cb7-43"><a href="#cb7-43"></a><span class="fu">library</span>(extrafont)</span>
<span id="cb7-44"><a href="#cb7-44"></a><span class="fu">loadfonts</span>(<span class="at">device =</span> <span class="st">"win"</span>)</span>
<span id="cb7-45"><a href="#cb7-45"></a><span class="fu">library</span>(margot)</span>
<span id="cb7-46"><a href="#cb7-46"></a><span class="fu">library</span>(here)</span>
<span id="cb7-47"><a href="#cb7-47"></a><span class="co"># library(boilerplate)</span></span>
<span id="cb7-48"><a href="#cb7-48"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb7-49"><a href="#cb7-49"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb7-50"><a href="#cb7-50"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb7-51"><a href="#cb7-51"></a></span>
<span id="cb7-52"><a href="#cb7-52"></a><span class="co"># set save path</span></span>
<span id="cb7-53"><a href="#cb7-53"></a>push_mods <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">'/Users/joseph/v-project\ Dropbox/data/courses/25-psych-434'</span>)</span>
<span id="cb7-54"><a href="#cb7-54"></a></span>
<span id="cb7-55"><a href="#cb7-55"></a><span class="co"># read (large file)</span></span>
<span id="cb7-56"><a href="#cb7-56"></a>models_binary_flipped_all <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read_qs</span>(<span class="st">"models_binary_flipped_all"</span>, push_mods)</span>
<span id="cb7-57"><a href="#cb7-57"></a></span>
<span id="cb7-58"><a href="#cb7-58"></a><span class="co"># models_binary_flipped_all &lt;- here_read_qs("models_binary_flipped_all", here::here("data"))</span></span>
<span id="cb7-59"><a href="#cb7-59"></a></span>
<span id="cb7-60"><a href="#cb7-60"></a><span class="co"># names</span></span>
<span id="cb7-61"><a href="#cb7-61"></a>flipped_names <span class="ot">&lt;-</span> <span class="fu">here_read</span>(<span class="st">"flipped_names"</span>, push_mods)</span>
<span id="cb7-62"><a href="#cb7-62"></a></span>
<span id="cb7-63"><a href="#cb7-63"></a><span class="co"># read labels</span></span>
<span id="cb7-64"><a href="#cb7-64"></a>label_mapping_all <span class="ot">&lt;-</span> <span class="fu">here_read</span>(<span class="st">"label_mapping_all"</span>)</span>
<span id="cb7-65"><a href="#cb7-65"></a></span>
<span id="cb7-66"><a href="#cb7-66"></a><span class="co"># set boilerplate path (set to your own machine)</span></span>
<span id="cb7-67"><a href="#cb7-67"></a><span class="co"># master_path &lt;- "/Users/joseph/GIT/templates/boilerplate_data"</span></span>
<span id="cb7-68"><a href="#cb7-68"></a></span>
<span id="cb7-69"><a href="#cb7-69"></a><span class="co"># set directory database path</span></span>
<span id="cb7-70"><a href="#cb7-70"></a>here_data_path <span class="ot">=</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>)</span>
<span id="cb7-71"><a href="#cb7-71"></a></span>
<span id="cb7-72"><a href="#cb7-72"></a><span class="co"># data</span></span>
<span id="cb7-73"><a href="#cb7-73"></a>original_df <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"df_wide"</span>, push_mods)</span>
<span id="cb7-74"><a href="#cb7-74"></a></span>
<span id="cb7-75"><a href="#cb7-75"></a><span class="co"># # import</span></span>
<span id="cb7-76"><a href="#cb7-76"></a><span class="co"># master_unified_db &lt;- boilerplate_import(data_path = master_path)</span></span>
<span id="cb7-77"><a href="#cb7-77"></a></span>
<span id="cb7-78"><a href="#cb7-78"></a><span class="co"># boilerplate_save(master_unified_db, output_file = "unified_db", data_path  = here_data_path, create_backup = FALSE)</span></span>
<span id="cb7-79"><a href="#cb7-79"></a></span>
<span id="cb7-80"><a href="#cb7-80"></a><span class="co"># unified_db &lt;- boilerplate_import(data_path = here_data_path)</span></span>
<span id="cb7-81"><a href="#cb7-81"></a></span>
<span id="cb7-82"><a href="#cb7-82"></a><span class="co"># cat(unified_db$appendix$explain$grf)</span></span>
<span id="cb7-83"><a href="#cb7-83"></a><span class="co"># set model defaults -----------------------------------------------------</span></span>
<span id="cb7-84"><a href="#cb7-84"></a>grf_defaults <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb7-85"><a href="#cb7-85"></a>                     <span class="co"># reproduce results</span></span>
<span id="cb7-86"><a href="#cb7-86"></a>                     <span class="at">stabilize.splits =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-87"><a href="#cb7-87"></a>                     <span class="at">num.trees =</span> <span class="dv">2000</span> )</span>
<span id="cb7-88"><a href="#cb7-88"></a>                     </span>
<span id="cb7-89"><a href="#cb7-89"></a></span>
<span id="cb7-90"><a href="#cb7-90"></a><span class="co"># set defaults for graphs (see bottom of script for options)</span></span>
<span id="cb7-91"><a href="#cb7-91"></a>decision_tree_defaults <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">span_ratio =</span> .<span class="dv">3</span>,</span>
<span id="cb7-92"><a href="#cb7-92"></a>                               <span class="at">text_size =</span> <span class="fl">3.8</span>,</span>
<span id="cb7-93"><a href="#cb7-93"></a>                               <span class="at">y_padding =</span> <span class="fl">0.25</span>)  </span>
<span id="cb7-94"><a href="#cb7-94"></a></span>
<span id="cb7-95"><a href="#cb7-95"></a><span class="co"># set defaults for graphs (see bottom of script for options)</span></span>
<span id="cb7-96"><a href="#cb7-96"></a><span class="co"># set policy tree defaults</span></span>
<span id="cb7-97"><a href="#cb7-97"></a>policy_tree_defaults <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb7-98"><a href="#cb7-98"></a>  <span class="at">point_alpha =</span> .<span class="dv">5</span>,</span>
<span id="cb7-99"><a href="#cb7-99"></a>  <span class="at">title_size =</span> <span class="dv">12</span>,</span>
<span id="cb7-100"><a href="#cb7-100"></a>  <span class="at">subtitle_size =</span> <span class="dv">14</span>,</span>
<span id="cb7-101"><a href="#cb7-101"></a>  <span class="at">axis_title_size =</span> <span class="dv">14</span>,</span>
<span id="cb7-102"><a href="#cb7-102"></a>  <span class="at">legend_title_size =</span> <span class="dv">14</span>,</span>
<span id="cb7-103"><a href="#cb7-103"></a>  <span class="at">split_line_color =</span> <span class="st">"red"</span>,</span>
<span id="cb7-104"><a href="#cb7-104"></a>  <span class="at">split_line_alpha =</span> <span class="fl">0.8</span>,</span>
<span id="cb7-105"><a href="#cb7-105"></a>  <span class="at">split_label_color =</span> <span class="st">"red"</span></span>
<span id="cb7-106"><a href="#cb7-106"></a>)</span>
<span id="cb7-107"><a href="#cb7-107"></a></span>
<span id="cb7-108"><a href="#cb7-108"></a><span class="co"># rate table</span></span>
<span id="cb7-109"><a href="#cb7-109"></a>rate_table_all <span class="ot">&lt;-</span> <span class="fu">margot_rate</span>(</span>
<span id="cb7-110"><a href="#cb7-110"></a>  models_binary_flipped_all, </span>
<span id="cb7-111"><a href="#cb7-111"></a>  <span class="at">label_mapping =</span> label_mapping_all, </span>
<span id="cb7-112"><a href="#cb7-112"></a>  <span class="at">highlight_significant =</span> <span class="cn">TRUE</span></span>
<span id="cb7-113"><a href="#cb7-113"></a>)</span>
<span id="cb7-114"><a href="#cb7-114"></a></span>
<span id="cb7-115"><a href="#cb7-115"></a><span class="co"># view</span></span>
<span id="cb7-116"><a href="#cb7-116"></a><span class="co"># rate_table_all$rate_autoc |&gt; kbl("markdown")</span></span>
<span id="cb7-117"><a href="#cb7-117"></a><span class="co"># rate_table_all$rate_qini |&gt; kbl("markdown")</span></span>
<span id="cb7-118"><a href="#cb7-118"></a></span>
<span id="cb7-119"><a href="#cb7-119"></a><span class="co"># generate interpretation</span></span>
<span id="cb7-120"><a href="#cb7-120"></a>rate_interpretation_all <span class="ot">&lt;-</span> <span class="fu">margot_interpret_rate</span>(</span>
<span id="cb7-121"><a href="#cb7-121"></a>  rate_table_all, </span>
<span id="cb7-122"><a href="#cb7-122"></a>  <span class="at">flipped_outcomes =</span> flipped_names</span>
<span id="cb7-123"><a href="#cb7-123"></a>)</span>
<span id="cb7-124"><a href="#cb7-124"></a></span>
<span id="cb7-125"><a href="#cb7-125"></a><span class="co"># view interpretations</span></span>
<span id="cb7-126"><a href="#cb7-126"></a><span class="fu">cat</span>(rate_interpretation_all<span class="sc">$</span>autoc_results)</span>
<span id="cb7-127"><a href="#cb7-127"></a><span class="fu">cat</span>(rate_interpretation_all<span class="sc">$</span>qini_results)</span>
<span id="cb7-128"><a href="#cb7-128"></a><span class="fu">cat</span>(rate_interpretation_all<span class="sc">$</span>comparison)</span>
<span id="cb7-129"><a href="#cb7-129"></a></span>
<span id="cb7-130"><a href="#cb7-130"></a><span class="co"># # check out model names</span></span>
<span id="cb7-131"><a href="#cb7-131"></a><span class="co"># rate_interpretation_all$either_model_names</span></span>
<span id="cb7-132"><a href="#cb7-132"></a><span class="co"># rate_interpretation_all$qini_model_names</span></span>
<span id="cb7-133"><a href="#cb7-133"></a><span class="co"># rate_interpretation_all$both_model_names</span></span>
<span id="cb7-134"><a href="#cb7-134"></a><span class="co"># rate_interpretation_all$autoc_model_names</span></span>
<span id="cb7-135"><a href="#cb7-135"></a></span>
<span id="cb7-136"><a href="#cb7-136"></a><span class="co"># define autoc model names for batch processing</span></span>
<span id="cb7-137"><a href="#cb7-137"></a><span class="co"># autoc plots ------------------------------------------------------------</span></span>
<span id="cb7-138"><a href="#cb7-138"></a><span class="co"># generate batch rate plots</span></span>
<span id="cb7-139"><a href="#cb7-139"></a>batch_rate_autoc_plots <span class="ot">&lt;-</span> <span class="fu">margot_plot_rate_batch</span>(</span>
<span id="cb7-140"><a href="#cb7-140"></a>  models_binary_flipped_all, </span>
<span id="cb7-141"><a href="#cb7-141"></a>  <span class="at">save_plots =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-142"><a href="#cb7-142"></a>  <span class="co"># just use rate autoc</span></span>
<span id="cb7-143"><a href="#cb7-143"></a>  <span class="at">model_names =</span> rate_interpretation_all<span class="sc">$</span>autoc_model_names  </span>
<span id="cb7-144"><a href="#cb7-144"></a>)</span>
<span id="cb7-145"><a href="#cb7-145"></a></span>
<span id="cb7-146"><a href="#cb7-146"></a><span class="co"># batch_rate_autoc_plots$model_t2_hlth_fatigue_z</span></span>
<span id="cb7-147"><a href="#cb7-147"></a><span class="co"># view selected autoc plots</span></span>
<span id="cb7-148"><a href="#cb7-148"></a><span class="co"># batch_rate_autoc_plots$model_t2_log_hours_exercise_z</span></span>
<span id="cb7-149"><a href="#cb7-149"></a><span class="co"># batch_rate_autoc_plots$model_t2_hlth_fatigue_z</span></span>
<span id="cb7-150"><a href="#cb7-150"></a><span class="co"># batch_rate_autoc_plots$model_t2_self_control_z</span></span>
<span id="cb7-151"><a href="#cb7-151"></a></span>
<span id="cb7-152"><a href="#cb7-152"></a><span class="co"># QINI --------------------------------------------------------------------</span></span>
<span id="cb7-153"><a href="#cb7-153"></a><span class="co"># batch process heterogeneity results for qini</span></span>
<span id="cb7-154"><a href="#cb7-154"></a>models_binary_batch_qini <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_policy</span>(</span>
<span id="cb7-155"><a href="#cb7-155"></a>  models_binary_flipped_all,</span>
<span id="cb7-156"><a href="#cb7-156"></a>  <span class="at">save_plots =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-157"><a href="#cb7-157"></a>  <span class="at">decision_tree_args =</span> decision_tree_defaults,</span>
<span id="cb7-158"><a href="#cb7-158"></a>  <span class="at">policy_tree_args =</span> policy_tree_defaults,</span>
<span id="cb7-159"><a href="#cb7-159"></a>  <span class="at">model_names =</span> rate_interpretation_all<span class="sc">$</span>qini_model_names,</span>
<span id="cb7-160"><a href="#cb7-160"></a>  <span class="at">original_df =</span> original_df,</span>
<span id="cb7-161"><a href="#cb7-161"></a>  <span class="at">label_mapping =</span> label_mapping_all</span>
<span id="cb7-162"><a href="#cb7-162"></a>)</span>
<span id="cb7-163"><a href="#cb7-163"></a></span>
<span id="cb7-164"><a href="#cb7-164"></a><span class="co"># view models</span></span>
<span id="cb7-165"><a href="#cb7-165"></a><span class="co"># first make graphs</span></span>
<span id="cb7-166"><a href="#cb7-166"></a>plot_qini_exercise <span class="ot">&lt;-</span>models_binary_batch_qini<span class="sc">$</span>model_t2_log_hours_exercise_z<span class="sc">$</span>qini_plot</span>
<span id="cb7-167"><a href="#cb7-167"></a>plot_qini_fatigue <span class="ot">&lt;-</span> models_binary_batch_qini<span class="sc">$</span>model_t2_hlth_fatigue_z<span class="sc">$</span>qini_plot</span>
<span id="cb7-168"><a href="#cb7-168"></a>plot_qini_bodysat <span class="ot">&lt;-</span> models_binary_batch_qini<span class="sc">$</span>model_t2_bodysat_z<span class="sc">$</span>qini_plot</span>
<span id="cb7-169"><a href="#cb7-169"></a>plot_qini_self_control <span class="ot">&lt;-</span> models_binary_batch_qini<span class="sc">$</span>model_t2_self_control_z<span class="sc">$</span>qini_plot</span>
<span id="cb7-170"><a href="#cb7-170"></a>plot_qini_self_esteem <span class="ot">&lt;-</span> models_binary_batch_qini<span class="sc">$</span>model_t2_self_esteem_z<span class="sc">$</span>qini_plot</span>
<span id="cb7-171"><a href="#cb7-171"></a>plot_qini_belong <span class="ot">&lt;-</span> models_binary_batch_qini<span class="sc">$</span>model_t2_belong_z<span class="sc">$</span>qini_plot</span>
<span id="cb7-172"><a href="#cb7-172"></a></span>
<span id="cb7-173"><a href="#cb7-173"></a><span class="co"># recall the ate</span></span>
<span id="cb7-174"><a href="#cb7-174"></a><span class="co"># plot_all_models$plot</span></span>
<span id="cb7-175"><a href="#cb7-175"></a></span>
<span id="cb7-176"><a href="#cb7-176"></a><span class="co"># patchwork allows us to group graphs together</span></span>
<span id="cb7-177"><a href="#cb7-177"></a></span>
<span id="cb7-178"><a href="#cb7-178"></a><span class="co"># view plots</span></span>
<span id="cb7-179"><a href="#cb7-179"></a><span class="co"># (plot_qini_exercise / plot_qini_fatigue / plot_qini_bodysat) </span></span>
<span id="cb7-180"><a href="#cb7-180"></a><span class="co"># </span></span>
<span id="cb7-181"><a href="#cb7-181"></a><span class="co"># (plot_qini_self_control /plot_qini_self_esteem / plot_qini_t2_belong)</span></span>
<span id="cb7-182"><a href="#cb7-182"></a><span class="co"># (plot_qini_exercise / plot_qini_fatigue / plot_qini_bodysat) </span></span>
<span id="cb7-183"><a href="#cb7-183"></a></span>
<span id="cb7-184"><a href="#cb7-184"></a><span class="co"># (plot_qini_self_control /plot_qini_self_esteem / plot_qini_t2_belong)</span></span>
<span id="cb7-185"><a href="#cb7-185"></a></span>
<span id="cb7-186"><a href="#cb7-186"></a><span class="co"># extract plots for models without reliable heterogeneity</span></span>
<span id="cb7-187"><a href="#cb7-187"></a></span>
<span id="cb7-188"><a href="#cb7-188"></a><span class="co"># interpret qini curves</span></span>
<span id="cb7-189"><a href="#cb7-189"></a>interpretation_qini_curves <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_interpret_qini</span>(</span>
<span id="cb7-190"><a href="#cb7-190"></a>  models_binary_batch_qini,</span>
<span id="cb7-191"><a href="#cb7-191"></a>  <span class="at">model_names =</span> rate_interpretation_all<span class="sc">$</span>qini_model_names,</span>
<span id="cb7-192"><a href="#cb7-192"></a>  <span class="at">label_mapping =</span> label_mapping_all</span>
<span id="cb7-193"><a href="#cb7-193"></a>)</span>
<span id="cb7-194"><a href="#cb7-194"></a></span>
<span id="cb7-195"><a href="#cb7-195"></a><span class="co"># view qini interpretation</span></span>
<span id="cb7-196"><a href="#cb7-196"></a><span class="fu">cat</span>(interpretation_qini_curves<span class="sc">$</span>qini_explanation)</span>
<span id="cb7-197"><a href="#cb7-197"></a></span>
<span id="cb7-198"><a href="#cb7-198"></a><span class="co"># view summary table</span></span>
<span id="cb7-199"><a href="#cb7-199"></a>interpretation_qini_curves<span class="sc">$</span>summary_table <span class="sc">|&gt;</span> <span class="fu">kbl</span>(<span class="st">"markdown"</span>)</span>
<span id="cb7-200"><a href="#cb7-200"></a></span>
<span id="cb7-201"><a href="#cb7-201"></a><span class="co"># others</span></span>
<span id="cb7-202"><a href="#cb7-202"></a><span class="co"># combine qini plots</span></span>
<span id="cb7-203"><a href="#cb7-203"></a><span class="co"># qini_plots_combined &lt;- </span></span>
<span id="cb7-204"><a href="#cb7-204"></a><span class="co">#   (plot_qini_exercise + plot_qini_fatigue +  plot_qini_bodysat) / (plot_qini_self_control + plot_qini_self_esteem + plot_qini_t2_belong) + </span></span>
<span id="cb7-205"><a href="#cb7-205"></a><span class="co">#   plot_annotation(</span></span>
<span id="cb7-206"><a href="#cb7-206"></a><span class="co">#     title = "Qini Plots: Reliable Priority 'Spending' at Fractional Budgets",</span></span>
<span id="cb7-207"><a href="#cb7-207"></a><span class="co">#     tag_levels = "A",</span></span>
<span id="cb7-208"><a href="#cb7-208"></a><span class="co">#     theme = theme(legend.position = "top")</span></span>
<span id="cb7-209"><a href="#cb7-209"></a><span class="co">#   ) +</span></span>
<span id="cb7-210"><a href="#cb7-210"></a><span class="co">#   plot_layout(guides = "collect")</span></span>
<span id="cb7-211"><a href="#cb7-211"></a><span class="co"># </span></span>
<span id="cb7-212"><a href="#cb7-212"></a><span class="co"># # view combined qini plots</span></span>
<span id="cb7-213"><a href="#cb7-213"></a><span class="co"># qini_plots_combined</span></span>
<span id="cb7-214"><a href="#cb7-214"></a></span>
<span id="cb7-215"><a href="#cb7-215"></a><span class="co"># again compare with ate</span></span>
<span id="cb7-216"><a href="#cb7-216"></a><span class="co"># plot_all_models$plot </span></span>
<span id="cb7-217"><a href="#cb7-217"></a></span>
<span id="cb7-218"><a href="#cb7-218"></a></span>
<span id="cb7-219"><a href="#cb7-219"></a><span class="co"># policy tree analysis ---------------------------------------------------</span></span>
<span id="cb7-220"><a href="#cb7-220"></a><span class="co"># model_names_subset &lt;- c(</span></span>
<span id="cb7-221"><a href="#cb7-221"></a><span class="co">#   "model_t2_log_hours_exercise_z",</span></span>
<span id="cb7-222"><a href="#cb7-222"></a><span class="co">#   "model_t2_self_control_z", </span></span>
<span id="cb7-223"><a href="#cb7-223"></a><span class="co">#   "model_t2_sexual_satisfaction_z",</span></span>
<span id="cb7-224"><a href="#cb7-224"></a><span class="co">#   "model_t2_belong_z",</span></span>
<span id="cb7-225"><a href="#cb7-225"></a><span class="co">#   "model_t2_support_z"</span></span>
<span id="cb7-226"><a href="#cb7-226"></a><span class="co"># )</span></span>
<span id="cb7-227"><a href="#cb7-227"></a></span>
<span id="cb7-228"><a href="#cb7-228"></a></span>
<span id="cb7-229"><a href="#cb7-229"></a>plots_policy_trees <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_policy</span>(</span>
<span id="cb7-230"><a href="#cb7-230"></a>  models_binary_flipped_all,</span>
<span id="cb7-231"><a href="#cb7-231"></a>  <span class="at">save_plots =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-232"><a href="#cb7-232"></a>  <span class="at">output_dir =</span> here<span class="sc">::</span><span class="fu">here</span>(push_mods),</span>
<span id="cb7-233"><a href="#cb7-233"></a>  <span class="at">decision_tree_args =</span> decision_tree_defaults,</span>
<span id="cb7-234"><a href="#cb7-234"></a>  <span class="at">policy_tree_args =</span> policy_tree_defaults,</span>
<span id="cb7-235"><a href="#cb7-235"></a>  <span class="at">model_names =</span> rate_interpretation_all<span class="sc">$</span>either_model_names, <span class="co"># defined above</span></span>
<span id="cb7-236"><a href="#cb7-236"></a>  <span class="at">original_df =</span> original_df,</span>
<span id="cb7-237"><a href="#cb7-237"></a>  <span class="at">label_mapping =</span> label_mapping_all</span>
<span id="cb7-238"><a href="#cb7-238"></a>)</span>
<span id="cb7-239"><a href="#cb7-239"></a></span>
<span id="cb7-240"><a href="#cb7-240"></a><span class="co"># generate policy tree interpretations</span></span>
<span id="cb7-241"><a href="#cb7-241"></a>interpretation_policy_trees <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_interpret_policy_batch</span>(</span>
<span id="cb7-242"><a href="#cb7-242"></a>  models_binary_flipped_all,</span>
<span id="cb7-243"><a href="#cb7-243"></a>  <span class="co"># use eithre model</span></span>
<span id="cb7-244"><a href="#cb7-244"></a>  <span class="at">model_names =</span> rate_interpretation_all<span class="sc">$</span>either_model_names, <span class="co"># defined above</span></span>
<span id="cb7-245"><a href="#cb7-245"></a>  <span class="at">train_proportion =</span> <span class="fl">0.8</span>,</span>
<span id="cb7-246"><a href="#cb7-246"></a>  <span class="at">original_df =</span> original_df,</span>
<span id="cb7-247"><a href="#cb7-247"></a>  <span class="at">label_mapping =</span> label_mapping_all</span>
<span id="cb7-248"><a href="#cb7-248"></a>)</span>
<span id="cb7-249"><a href="#cb7-249"></a></span>
<span id="cb7-250"><a href="#cb7-250"></a><span class="co"># this will give you results</span></span>
<span id="cb7-251"><a href="#cb7-251"></a><span class="co"># cat(interpretation_policy_trees)</span></span>
<span id="cb7-252"><a href="#cb7-252"></a></span>
<span id="cb7-253"><a href="#cb7-253"></a><span class="co"># # plots</span></span>
<span id="cb7-254"><a href="#cb7-254"></a><span class="co"># plots_policy_trees$model_t2_log_hours_exercise_z$decision_tree</span></span>
<span id="cb7-255"><a href="#cb7-255"></a><span class="co"># plots_policy_trees$model_t2_log_hours_exercise_z$policy_tree</span></span>
<span id="cb7-256"><a href="#cb7-256"></a><span class="co"># plots_policy_trees$model_t2_log_hours_exercise_z$combined_plot</span></span>
<span id="cb7-257"><a href="#cb7-257"></a><span class="co"># # </span></span>
<span id="cb7-258"><a href="#cb7-258"></a><span class="co"># plots_policy_trees$model_t2_hlth_fatigue_z$decision_tree</span></span>
<span id="cb7-259"><a href="#cb7-259"></a><span class="co"># plots_policy_trees$model_t2_hlth_fatigue_z$policy_tree</span></span>
<span id="cb7-260"><a href="#cb7-260"></a><span class="co"># plots_policy_trees$model_t2_hlth_fatigue_z$combined_plot</span></span>
<span id="cb7-261"><a href="#cb7-261"></a><span class="co"># # </span></span>
<span id="cb7-262"><a href="#cb7-262"></a><span class="co"># plots_policy_trees$model_t2_self_control_z$decision_tree</span></span>
<span id="cb7-263"><a href="#cb7-263"></a><span class="co"># plots_policy_trees$model_t2_self_control_z$policy_tree</span></span>
<span id="cb7-264"><a href="#cb7-264"></a><span class="co"># plots_policy_trees$model_t2_self_control_z$combined_plot</span></span>
<span id="cb7-265"><a href="#cb7-265"></a></span>
<span id="cb7-266"><a href="#cb7-266"></a><span class="co"># plots_policy_trees$model_t2_meaning_sense_z$decision_tree</span></span>
<span id="cb7-267"><a href="#cb7-267"></a><span class="co"># plots_policy_trees$model_t2_meaning_sense_z$policy_tree</span></span>
<span id="cb7-268"><a href="#cb7-268"></a><span class="co"># plots_policy_trees$model_t2_meaning_sense_z$combined_plot</span></span>
<span id="cb7-269"><a href="#cb7-269"></a><span class="co"># </span></span>
<span id="cb7-270"><a href="#cb7-270"></a><span class="co"># plots_policy_trees$model_t2_bodysat_z$decision_tree</span></span>
<span id="cb7-271"><a href="#cb7-271"></a><span class="co"># plots_policy_trees$model_t2_bodysat_z$policy_tree</span></span>
<span id="cb7-272"><a href="#cb7-272"></a><span class="co"># plots_policy_trees$model_t2_bodysat_z$combined_plot</span></span>
<span id="cb7-273"><a href="#cb7-273"></a><span class="co"># # </span></span>
<span id="cb7-274"><a href="#cb7-274"></a><span class="co"># </span></span>
<span id="cb7-275"><a href="#cb7-275"></a><span class="co"># plots_policy_trees$model_t2_self_esteem_z$decision_tree</span></span>
<span id="cb7-276"><a href="#cb7-276"></a><span class="co"># plots_policy_trees$model_t2_self_esteem_z$policy_tree</span></span>
<span id="cb7-277"><a href="#cb7-277"></a><span class="co"># plots_policy_trees$model_t2_self_esteem_z$combined_plot</span></span>
<span id="cb7-278"><a href="#cb7-278"></a></span>
<span id="cb7-279"><a href="#cb7-279"></a><span class="co"># plots_policy_trees$model_t2_belong_z$decision_tree</span></span>
<span id="cb7-280"><a href="#cb7-280"></a><span class="co"># plots_policy_trees$model_t2_belong_z$policy_tree</span></span>
<span id="cb7-281"><a href="#cb7-281"></a><span class="co"># plots_policy_trees$model_t2_belong_z$combined_plot</span></span>
<span id="cb7-282"><a href="#cb7-282"></a></span>
<span id="cb7-283"><a href="#cb7-283"></a><span class="co"># batch_rate_autoc_plots$model_t2_meaning_sense_z</span></span>
<span id="cb7-284"><a href="#cb7-284"></a><span class="co"># models_binary_batch_qini$model_t2_belong_z$qini_plot</span></span>
<span id="cb7-285"><a href="#cb7-285"></a></span>
<span id="cb7-286"><a href="#cb7-286"></a><span class="in">```</span></span>
<span id="cb7-287"><a href="#cb7-287"></a></span>
<span id="cb7-288"><a href="#cb7-288"></a></span>
<span id="cb7-289"><a href="#cb7-289"></a>::: {.callout-note}</span>
<span id="cb7-290"><a href="#cb7-290"></a>**Required**</span>
<span id="cb7-291"><a href="#cb7-291"></a><span class="ss">- </span><span class="co">[</span><span class="ot">https://grf-labs.github.io/grf/</span><span class="co">](https://grf-labs.github.io/grf/)</span></span>
<span id="cb7-292"><a href="#cb7-292"></a></span>
<span id="cb7-293"><a href="#cb7-293"></a></span>
<span id="cb7-294"><a href="#cb7-294"></a></span>
<span id="cb7-295"><a href="#cb7-295"></a>**Optional**</span>
<span id="cb7-296"><a href="#cb7-296"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@vanderweele2020</span><span class="co">] [link]</span>(https://www.dropbox.com/scl/fi/srpynr0dvjcndveplcydn/OutcomeWide_StatisticalScience.pdf?rlkey=h4fv32oyjegdfl3jq9u1fifc3&amp;dl=0)</span>
<span id="cb7-297"><a href="#cb7-297"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@suzuki2020</span><span class="co">] [link]</span>(https://www.dropbox.com/scl/fi/4midxwr9ltg9oce02e0ss/suzuki-causal-diagrams.pdf?rlkey=uktzf3nurtgpbj8m4h0xz82dn&amp;dl=0)</span>
<span id="cb7-298"><a href="#cb7-298"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@Bulbulia2024PracticalGuide</span><span class="co">] [link]</span>(https://osf.io/preprints/psyarxiv/uyg3d)</span>
<span id="cb7-299"><a href="#cb7-299"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@hoffman2023</span><span class="co">] [link]</span>(https://arxiv.org/pdf/2304.09460.pdf)</span>
<span id="cb7-300"><a href="#cb7-300"></a>:::</span>
<span id="cb7-301"><a href="#cb7-301"></a></span>
<span id="cb7-302"><a href="#cb7-302"></a></span>
<span id="cb7-303"><a href="#cb7-303"></a>::: {.callout-important}</span>
<span id="cb7-304"><a href="#cb7-304"></a><span class="fu">### Key concepts  </span></span>
<span id="cb7-305"><a href="#cb7-305"></a></span>
<span id="cb7-306"><a href="#cb7-306"></a>The workflow below introduces **heterogeneous-treatment-effect (HTE) analysis** with *causal forests*. By the end of the lecture you should understand six technical ideas:</span>
<span id="cb7-307"><a href="#cb7-307"></a>(1) ATE (lectures 1-5)</span>
<span id="cb7-308"><a href="#cb7-308"></a>(2) CATE (lecture 6)</span>
<span id="cb7-309"><a href="#cb7-309"></a>(3) The estimator $\widehat{\tau}(x)$, (lecture 6)</span>
<span id="cb7-310"><a href="#cb7-310"></a>(4) the RATE statistics drawn from a **Targeting-Operator Characteristic** (TOC) curve (new)</span>
<span id="cb7-311"><a href="#cb7-311"></a>(5) Qini Curves (new)</span>
<span id="cb7-312"><a href="#cb7-312"></a>(6) **policy trees**—and know how each fits into an applied research pipelin (new)</span>
<span id="cb7-313"><a href="#cb7-313"></a>:::</span>
<span id="cb7-314"><a href="#cb7-314"></a></span>
<span id="cb7-315"><a href="#cb7-315"></a></span>
<span id="cb7-316"><a href="#cb7-316"></a><span class="fu"># PART 1 Heterogeneous-Treatment-Effect Analysis with **causal forests**</span></span>
<span id="cb7-317"><a href="#cb7-317"></a></span>
<span id="cb7-318"><a href="#cb7-318"></a><span class="fu">### Why worry about heterogeneity?  </span></span>
<span id="cb7-319"><a href="#cb7-319"></a></span>
<span id="cb7-320"><a href="#cb7-320"></a></span>
<span id="cb7-321"><a href="#cb7-321"></a>Relying on the average treatment effect (ATE) is a bit like handing out size-nine shoes to an entire student body: on *average* they might fit, but watch the tall students hobble and the small ones trip.  </span>
<span id="cb7-322"><a href="#cb7-322"></a></span>
<span id="cb7-323"><a href="#cb7-323"></a>Today we will focus on the causal question: "What would be the effects on multi-dimensional well-being if everyone spent at least one hour a week socialising with their community?"</span>
<span id="cb7-324"><a href="#cb7-324"></a></span>
<span id="cb7-325"><a href="#cb7-325"></a>Note that a one-hour boost in weekly community socialising could send some students' sense of belonging soaring while leaving others desolated.  Spotting that spread, measuring how big it really is, and deciding whether it is worth tailoring an exposure to individual 'shoe sizes' are the three practical goals of Heterogeneous Treatment Effects analysis.</span>
<span id="cb7-326"><a href="#cb7-326"></a></span>
<span id="cb7-327"><a href="#cb7-327"></a></span>
<span id="cb7-328"><a href="#cb7-328"></a>---</span>
<span id="cb7-329"><a href="#cb7-329"></a></span>
<span id="cb7-330"><a href="#cb7-330"></a><span class="fu">### 1 Start with estimating the average treatment effect (ATE)  </span></span>
<span id="cb7-331"><a href="#cb7-331"></a></span>
<span id="cb7-332"><a href="#cb7-332"></a>Assume the <span class="co">[</span><span class="ot">Three Fundamental Assumptions of Causal Inference here</span><span class="co">](https://go-bayes.github.io/psych-434-2025/content/05-content.html#how-can-we-make-contrasts-between-counterfactual-potential-outcomes)</span> are met. Suppose we wish to estimate the average treatment effect for socialising with one's community. </span>
<span id="cb7-333"><a href="#cb7-333"></a></span>
<span id="cb7-334"><a href="#cb7-334"></a>We begin with the most straightforward (and secretly impossible) counterfactual: *run two parallel universes—one where **everyone** gets the treatment, another where **no-one** does—and compare the final scores.  The resulting difference is the **average treatment effect**:  </span>
<span id="cb7-335"><a href="#cb7-335"></a></span>
<span id="cb7-336"><a href="#cb7-336"></a></span>
<span id="cb7-337"><a href="#cb7-337"></a>$$</span>
<span id="cb7-338"><a href="#cb7-338"></a>\text{ATE}=E<span class="sc">\!</span>\bigl<span class="co">[</span><span class="ot">Y(1)-Y(0)\bigr</span><span class="co">]</span>.</span>
<span id="cb7-339"><a href="#cb7-339"></a>$$</span>
<span id="cb7-340"><a href="#cb7-340"></a></span>
<span id="cb7-341"><a href="#cb7-341"></a>This gives us the average response -- the shoe size... You've seen this before.</span>
<span id="cb7-342"><a href="#cb7-342"></a></span>
<span id="cb7-343"><a href="#cb7-343"></a></span>
<span id="cb7-344"><a href="#cb7-344"></a>---</span>
<span id="cb7-345"><a href="#cb7-345"></a></span>
<span id="cb7-346"><a href="#cb7-346"></a><span class="fu">### 2 Do effects differ across people?  </span></span>
<span id="cb7-347"><a href="#cb7-347"></a></span>
<span id="cb7-348"><a href="#cb7-348"></a>Variation is captured by the **conditional average treatment effect (CATE)**,  </span>
<span id="cb7-349"><a href="#cb7-349"></a></span>
<span id="cb7-350"><a href="#cb7-350"></a>$$</span>
<span id="cb7-351"><a href="#cb7-351"></a>\tau(x)=E<span class="sc">\!</span>\bigl<span class="co">[</span><span class="ot">Y(1)-Y(0)\mid X=x\bigr</span><span class="co">]</span>,</span>
<span id="cb7-352"><a href="#cb7-352"></a>$$</span>
<span id="cb7-353"><a href="#cb7-353"></a></span>
<span id="cb7-354"><a href="#cb7-354"></a>where $X$ gathers pre-treatment covariates -- age, baseline wellbeing, personality, whatever we have measured and included in our model. Normally these will be our *baseline confounders.* </span>
<span id="cb7-355"><a href="#cb7-355"></a></span>
<span id="cb7-356"><a href="#cb7-356"></a>If $\tau(x)$ turns out to be flat, we say there is no evidence for heterogeneity worth targeting. </span>
<span id="cb7-357"><a href="#cb7-357"></a></span>
<span id="cb7-358"><a href="#cb7-358"></a>People differ in countless, overlapping ways. Think of age, baseline wellbeing, personality traits, study habits, and more. </span>
<span id="cb7-359"><a href="#cb7-359"></a></span>
<span id="cb7-360"><a href="#cb7-360"></a>A linear interaction model tests whether the treatment works differently along one straight dimension, such as gender, by fitting a straight line. </span>
<span id="cb7-361"><a href="#cb7-361"></a></span>
<span id="cb7-362"><a href="#cb7-362"></a>But real‐world data often twist and turn. If the true relationship bends like a garden hose, a straight line will miss the curve. </span>
<span id="cb7-363"><a href="#cb7-363"></a></span>
<span id="cb7-364"><a href="#cb7-364"></a>Regression forests fix this by letting the data place splits wherever the shape changes, so they can follow any bends that appear <span class="co">[</span><span class="ot">@wager2018</span><span class="co">]</span>.  </span>
<span id="cb7-365"><a href="#cb7-365"></a></span>
<span id="cb7-366"><a href="#cb7-366"></a>Straight-line models are fine for simple patterns, but regression forests can trace the curves that simple lines overlook.</span>
<span id="cb7-367"><a href="#cb7-367"></a></span>
<span id="cb7-368"><a href="#cb7-368"></a>Causal forests are based on regression forests, where the splitting attempts to maximise differences in causal effect estimates. What this means will soon be clear. </span>
<span id="cb7-369"><a href="#cb7-369"></a></span>
<span id="cb7-370"><a href="#cb7-370"></a></span>
<span id="cb7-371"><a href="#cb7-371"></a><span class="fu">### 3. From straight lines to trees  </span></span>
<span id="cb7-372"><a href="#cb7-372"></a></span>
<span id="cb7-373"><a href="#cb7-373"></a>Traditional 'parametric' models (like simple regression) guess a single functional shape -- often a straight line -- before seeing the data.  A **non-parametric** model, by contrast, lets the data decide the shape.  A *regression tree* is the simplest non-parametric learner we will use.  </span>
<span id="cb7-374"><a href="#cb7-374"></a></span>
<span id="cb7-375"><a href="#cb7-375"></a><span class="ss">1. </span>**Regression tree**  </span>
<span id="cb7-376"><a href="#cb7-376"></a></span>
<span id="cb7-377"><a href="#cb7-377"></a>*Idea*: split the covariate space by asking yes/no questions— 'Age ≤ 20?', 'Baseline wellbeing &gt; 0.3?' — until each terminal **leaf** is fairly homogeneous.  Inside a leaf the predicted outcome is just the sample mean, so the tree builds a *piece-wise constant* surface instead of a global line.    </span>
<span id="cb7-378"><a href="#cb7-378"></a>*Analogy*: think of tiling a garden with stepping-stones: each stone is flat, but taken together they follow the ground’s contours.</span>
<span id="cb7-379"><a href="#cb7-379"></a></span>
<span id="cb7-380"><a href="#cb7-380"></a><span class="ss">2. </span>**Regression forest**  </span>
<span id="cb7-381"><a href="#cb7-381"></a>   A single tree is quick and interpretable but unstable: small changes in the data can move the splits and shift predictions.  A **random forest** grows many trees on bootstrap samples and averages their outputs.  Averaging cancels much of the noise <span class="co">[</span><span class="ot">@breiman2001random</span><span class="co">]</span>.  </span>
<span id="cb7-382"><a href="#cb7-382"></a></span>
<span id="cb7-383"><a href="#cb7-383"></a><span class="ss">3. </span>**Causal Forests**  </span>
<span id="cb7-384"><a href="#cb7-384"></a>   To estimate treatment effects rather than outcomes, each tree plays a two-step 'honest' game <span class="co">[</span><span class="ot">@wager2018</span><span class="co">]</span>:  </span>
<span id="cb7-385"><a href="#cb7-385"></a><span class="ss">   - </span>use one half of its sample to choose splits that separate treated from control units;  </span>
<span id="cb7-386"><a href="#cb7-386"></a><span class="ss">   - </span>use the other half to compute treatment-control differences within every leaf.  </span>
<span id="cb7-387"><a href="#cb7-387"></a></span>
<span id="cb7-388"><a href="#cb7-388"></a>   For a new individual with covariates $x_i$ each tree supplies a noisy leaf-level effect; the forest reports the **average**, written  </span>
<span id="cb7-389"><a href="#cb7-389"></a></span>
<span id="cb7-390"><a href="#cb7-390"></a>$$</span>
<span id="cb7-391"><a href="#cb7-391"></a>  \widehat{\tau}(x)=E<span class="co">[</span><span class="ot">Y(1)-Y(0)\mid X=x</span><span class="co">]</span>.</span>
<span id="cb7-392"><a href="#cb7-392"></a>$$</span>
<span id="cb7-393"><a href="#cb7-393"></a></span>
<span id="cb7-394"><a href="#cb7-394"></a>Because the noisy estimates point in many directions, their average is markedly less variable -- *the wisdom of trees is a wisdom of crowds*.</span>
<span id="cb7-395"><a href="#cb7-395"></a></span>
<span id="cb7-396"><a href="#cb7-396"></a>Straight‑line models suit simple patterns; regression forests flex to any bends; causal forests add a third dimension -- variation in treatment responses. We'll see this in action/</span>
<span id="cb7-397"><a href="#cb7-397"></a></span>
<span id="cb7-398"><a href="#cb7-398"></a></span>
<span id="cb7-399"><a href="#cb7-399"></a>For more about causal forests see (~18mins in...)</span>
<span id="cb7-400"><a href="#cb7-400"></a></span>
<span id="cb7-401"><a href="#cb7-401"></a>{{&lt; video https://www.youtube.com/watch?v=YBbnCDRCcAI &gt;}}</span>
<span id="cb7-402"><a href="#cb7-402"></a></span>
<span id="cb7-403"><a href="#cb7-403"></a></span>
<span id="cb7-404"><a href="#cb7-404"></a><span class="co">&lt;!-- So, a regression tree chops the data into locally flat chunks; a regression forest averages many such trees to smooth away chance idiosyncrasies; a causal forest adds honesty so that its averaged differences, though never directly observable for any one person, give our best data-driven forecast of individual treatment effects. --&gt;</span></span>
<span id="cb7-405"><a href="#cb7-405"></a></span>
<span id="cb7-406"><a href="#cb7-406"></a>---</span>
<span id="cb7-407"><a href="#cb7-407"></a></span>
<span id="cb7-408"><a href="#cb7-408"></a><span class="fu">### 4 Building Honest Trees: Avoiding Over-Fitting  </span></span>
<span id="cb7-409"><a href="#cb7-409"></a></span>
<span id="cb7-410"><a href="#cb7-410"></a>Sample splitting meanings partitioning your data into training and testing sets. This avoids overfittign the model to observations (remember we seek to estimate parameters for an entire population under two different exposures, at most, only one of which is observed on any individual.) Sample splitting is a feature of estimation in cauasal forests -- we separate model selection from estimation. Moreover, the forest adds a second safeguard: **out-of-bag (OOB) prediction**. Each $\widehat{\tau}(x_i)$ is averaged only over trees that never used $i$ in their split phase.  Together, honesty and OOB prediction deliver reliable uncertainty estimates even in high-dimensional settings (i.e. settings with *many* covariates.)</span>
<span id="cb7-411"><a href="#cb7-411"></a></span>
<span id="cb7-412"><a href="#cb7-412"></a>---</span>
<span id="cb7-413"><a href="#cb7-413"></a></span>
<span id="cb7-414"><a href="#cb7-414"></a><span class="fu">### 5 Handling missing data  </span></span>
<span id="cb7-415"><a href="#cb7-415"></a></span>
<span id="cb7-416"><a href="#cb7-416"></a>The <span class="in">`grf`</span> package adopts **Missing Incorporated in Attributes (MIA)** splitting.  'Missing' can itself become a branch, so cases are neither discarded nor randomly imputed.  This pragmatic approach keeps all observations in play while preserving the forest’s interpretability. </span>
<span id="cb7-417"><a href="#cb7-417"></a></span>
<span id="cb7-418"><a href="#cb7-418"></a>---</span>
<span id="cb7-419"><a href="#cb7-419"></a></span>
<span id="cb7-420"><a href="#cb7-420"></a><span class="fu">### 6 Is the heterogeneity *actionable*? — RATE statistics  </span></span>
<span id="cb7-421"><a href="#cb7-421"></a></span>
<span id="cb7-422"><a href="#cb7-422"></a>Once we have a personalised score $\widehat{\tau}(x)$ for every unit, the practical question is whether *targeting* high scorers delivers a benefit large enough to justify the extra effort.  The tool of choice is the **Targeting-Operator Characteristic (TOC)** curve:</span>
<span id="cb7-423"><a href="#cb7-423"></a></span>
<span id="cb7-424"><a href="#cb7-424"></a>$$</span>
<span id="cb7-425"><a href="#cb7-425"></a>G(q)=\frac{1}{n}\sum_{i=1}^{\lfloor qn\rfloor}\widehat{\tau}_{(i)}, \qquad 0\le q\le1,</span>
<span id="cb7-426"><a href="#cb7-426"></a>$$</span>
<span id="cb7-427"><a href="#cb7-427"></a></span>
<span id="cb7-428"><a href="#cb7-428"></a>where $\widehat{\tau}_{(1)}\ge\widehat{\tau}_{(2)}\ge\cdots$ are the estimated effects sorted from largest to smallest.  The horizontal axis $q$ is the fraction of the population we would treat; the vertical axis $G(q)$ is the cumulative gain we expect from treating that top slice.</span>
<span id="cb7-429"><a href="#cb7-429"></a></span>
<span id="cb7-430"><a href="#cb7-430"></a>Two integrals of the TOC curve summarise how lucrative targeting could be:</span>
<span id="cb7-431"><a href="#cb7-431"></a></span>
<span id="cb7-432"><a href="#cb7-432"></a><span class="ss">* </span>**RATE AUTOC** (Area *Under* the TOC) puts equal weight on every $q$.  This answers: *If benefits are concentrated among the very best prospects, how much can we harvest by cherry-picking them?*  </span>
<span id="cb7-433"><a href="#cb7-433"></a></span>
<span id="cb7-434"><a href="#cb7-434"></a><span class="ss">* </span>**RATE Qini** applies heavier weight to the mid-range of $q$.  This is the go-to metric when investigators face a fixed, moderate-sized budget—say, "we can afford to treat 40 % of individuals; will targeting help?"  <span class="co">[</span><span class="ot">@yadlowsky2021evaluating</span><span class="co">]</span>. We will evaluate the curve at treatment of 20% and 50% of the population.</span>
<span id="cb7-435"><a href="#cb7-435"></a></span>
<span id="cb7-436"><a href="#cb7-436"></a></span>
<span id="cb7-437"><a href="#cb7-437"></a>To quantify the economic or policy value of heterogeneity, rank units by $\widehat{\tau}(x)$ and draw a **Targeting-Operator Characteristic (TOC)** curve that plots cumulative gain against the fraction $q$ of the population treated.  </span>
<span id="cb7-438"><a href="#cb7-438"></a></span>
<span id="cb7-439"><a href="#cb7-439"></a>---</span>
<span id="cb7-440"><a href="#cb7-440"></a></span>
<span id="cb7-441"><a href="#cb7-441"></a><span class="fu">### 7 RATE AUTOC EXAMPLE</span></span>
<span id="cb7-442"><a href="#cb7-442"></a></span>
<span id="cb7-443"><a href="#cb7-443"></a>Although OOB predictions are 'out-of-sample' for individual trees, the full forest still reuses information.  A simple remedy when estimating the RATE AUTOC and Qini is to split the data, **training** the forest on one fold and **testing** RATE/Qini on the other.  Again, this explicit splitting blocks optimistic bias and yields honest test statistics (such as confidence intervals) <span class="co">[</span><span class="ot">@grf2024</span><span class="co">]</span>.</span>
<span id="cb7-444"><a href="#cb7-444"></a></span>
<span id="cb7-445"><a href="#cb7-445"></a><span class="in">```{r, results='asis'}</span></span>
<span id="cb7-446"><a href="#cb7-446"></a><span class="co">#| label: fig-rate-example</span></span>
<span id="cb7-447"><a href="#cb7-447"></a><span class="co">#| fig-cap: "RATE AUTOC: Hours Socialising → Sense of Meaning"</span></span>
<span id="cb7-448"><a href="#cb7-448"></a><span class="co">#| echo: false</span></span>
<span id="cb7-449"><a href="#cb7-449"></a><span class="co">#| column: screen</span></span>
<span id="cb7-450"><a href="#cb7-450"></a>batch_rate_autoc_plots<span class="sc">$</span>model_t2_meaning_sense_z</span>
<span id="cb7-451"><a href="#cb7-451"></a><span class="in">```</span></span>
<span id="cb7-452"><a href="#cb7-452"></a></span>
<span id="cb7-453"><a href="#cb7-453"></a>@fig-rate-example depicts a typical RATE AUTOC curve with sample splitting.  A steep initial rise indicates that a small, correctly targeted programme could deliver large gains. Note that the curve begins dipping below zero past about 30% of the sample. At that point we might be doing worse than the ATE by targeting the CATE -- at least for some.</span>
<span id="cb7-454"><a href="#cb7-454"></a></span>
<span id="cb7-455"><a href="#cb7-455"></a>**Remember -- figuring out who will benefit from a treatment is a difficult statistical problem [@grf2024].**</span>
<span id="cb7-456"><a href="#cb7-456"></a></span>
<span id="cb7-457"><a href="#cb7-457"></a>---</span>
<span id="cb7-458"><a href="#cb7-458"></a></span>
<span id="cb7-459"><a href="#cb7-459"></a><span class="fu">### 8 Visualising policy value: the Qini curve  </span></span>
<span id="cb7-460"><a href="#cb7-460"></a></span>
<span id="cb7-461"><a href="#cb7-461"></a>A **Qini curve** displays cumulative benefit on the vertical axis and treatment coverage (% of the population treated) on the horizontal.  As with the AUTOC curve we are using a held-out test fold to validate the response curve.</span>
<span id="cb7-462"><a href="#cb7-462"></a></span>
<span id="cb7-463"><a href="#cb7-463"></a><span class="in">```{r, results='asis'}</span></span>
<span id="cb7-464"><a href="#cb7-464"></a><span class="co">#| label: fig-qini-example</span></span>
<span id="cb7-465"><a href="#cb7-465"></a><span class="co">#| fig-cap: "Qini Curve: Hours Socialising → Social Belonging"</span></span>
<span id="cb7-466"><a href="#cb7-466"></a><span class="co">#| echo: false</span></span>
<span id="cb7-467"><a href="#cb7-467"></a><span class="co">#| column: screen</span></span>
<span id="cb7-468"><a href="#cb7-468"></a>plot_qini_belong</span>
<span id="cb7-469"><a href="#cb7-469"></a><span class="in">```</span></span>
<span id="cb7-470"><a href="#cb7-470"></a></span>
<span id="cb7-471"><a href="#cb7-471"></a></span>
<span id="cb7-472"><a href="#cb7-472"></a></span>
<span id="cb7-473"><a href="#cb7-473"></a>@fig-qini-example: we find that focussing on the top 20 % of individuals nets a gain of 0.08 units (95 % CI 0.04–0.12).  Widening the net to 50 % bumps the haul to 0.13 units (95 % CI 0.07–0.19).  After that the curve flattens -- once we’ve treated everyone who offers a decent return, there are no more 'big fish' left to catch.</span>
<span id="cb7-474"><a href="#cb7-474"></a></span>
<span id="cb7-475"><a href="#cb7-475"></a>---</span>
<span id="cb7-476"><a href="#cb7-476"></a></span>
<span id="cb7-477"><a href="#cb7-477"></a></span>
<span id="cb7-478"><a href="#cb7-478"></a><span class="fu">### 9 From 'a black box' to simple rules: policy trees  </span></span>
<span id="cb7-479"><a href="#cb7-479"></a></span>
<span id="cb7-480"><a href="#cb7-480"></a>The causal forest hands us a personalised CATE for every individual, mapping a **high-dimensional** covariate vector $X$ to a number $\widehat{\tau}(X)$.  Helpful as that forecast may be, it stops short of telling us *what to do*: the function itself is too tangled --- thousands of overlapping splits -- to translate directly into a policy.  </span>
<span id="cb7-481"><a href="#cb7-481"></a></span>
<span id="cb7-482"><a href="#cb7-482"></a>The **policytree** algorithm bridges that gap by collapsing the forest's many $\widehat{\tau}(X)$ values into a single, shallow decision tree whose depth you choose; each split is chosen to maximise expected benefit [@policytree_package_2024].  In this course we cap the depth at **two** for a practical balance, specifially:</span>
<span id="cb7-483"><a href="#cb7-483"></a></span>
<span id="cb7-484"><a href="#cb7-484"></a><span class="ss">- </span>At most three yes/no questions per rule, so the logic fits on a slide you can present to policy-makers</span>
<span id="cb7-485"><a href="#cb7-485"></a><span class="ss">- </span>Each leaf still contains enough observations to yield a stable effect estimate;  </span>
<span id="cb7-486"><a href="#cb7-486"></a><span class="ss">- </span>Deeper trees increase computational complexity faster than they improve payoffs.</span>
<span id="cb7-487"><a href="#cb7-487"></a></span>
<span id="cb7-488"><a href="#cb7-488"></a><span class="in">```{r, results='asis'}</span></span>
<span id="cb7-489"><a href="#cb7-489"></a><span class="co">#| label: fig-decision-tree</span></span>
<span id="cb7-490"><a href="#cb7-490"></a><span class="co">#| fig-cap: "Decision tree for Social Belonging"</span></span>
<span id="cb7-491"><a href="#cb7-491"></a><span class="co">#| echo: false</span></span>
<span id="cb7-492"><a href="#cb7-492"></a><span class="co">#| column: screen</span></span>
<span id="cb7-493"><a href="#cb7-493"></a>plots_policy_trees<span class="sc">$</span>model_t2_belong_z<span class="sc">$</span>decision_tree</span>
<span id="cb7-494"><a href="#cb7-494"></a><span class="in">```</span></span>
<span id="cb7-495"><a href="#cb7-495"></a></span>
<span id="cb7-496"><a href="#cb7-496"></a> </span>
<span id="cb7-497"><a href="#cb7-497"></a>**Policy Tree Findings for Effect of Hour Socialising on Social Belonging:**</span>
<span id="cb7-498"><a href="#cb7-498"></a></span>
<span id="cb7-499"><a href="#cb7-499"></a>Participants are first split by Self Esteem at -0.925 (original scale: 3.958). For those with Self Esteem $&lt;=$ this threshold, the next split is by Neuroticism at 0.642 (original scale: 4.228). Within that subgroup, individuals with Neuroticism $&lt;=$ the threshold are recommended **control**, while those with Neuroticism $&gt;$ the threshold are recommended **treated**.</span>
<span id="cb7-500"><a href="#cb7-500"></a></span>
<span id="cb7-501"><a href="#cb7-501"></a>For participants with Self Esteem $&gt;$ -0.925 (original scale: 3.958), the second split is by Social Belonging at 0.776 (original scale: 5.972). In this subgroup, individuals with Social Belonging $&lt;=$ the threshold are recommended **treated**, while those with Social Belonging $&gt;$ the threshold are recommended **control**.</span>
<span id="cb7-502"><a href="#cb7-502"></a></span>
<span id="cb7-503"><a href="#cb7-503"></a></span>
<span id="cb7-504"><a href="#cb7-504"></a><span class="in">```{r, results='asis'}</span></span>
<span id="cb7-505"><a href="#cb7-505"></a><span class="co">#| label: fig-policy-map</span></span>
<span id="cb7-506"><a href="#cb7-506"></a><span class="co">#| fig-cap: "Predicted treatment assignment (predictions out of training sample)"</span></span>
<span id="cb7-507"><a href="#cb7-507"></a><span class="co">#| fig-height: 14   # adjust</span></span>
<span id="cb7-508"><a href="#cb7-508"></a><span class="co">#| fig-width: 16  # adjust</span></span>
<span id="cb7-509"><a href="#cb7-509"></a><span class="co">#| echo: false</span></span>
<span id="cb7-510"><a href="#cb7-510"></a>plots_policy_trees<span class="sc">$</span>model_t2_belong_z<span class="sc">$</span>policy_tree</span>
<span id="cb7-511"><a href="#cb7-511"></a><span class="in">```</span></span>
<span id="cb7-512"><a href="#cb7-512"></a></span>
<span id="cb7-513"><a href="#cb7-513"></a></span>
<span id="cb7-514"><a href="#cb7-514"></a></span>
<span id="cb7-515"><a href="#cb7-515"></a>---</span>
<span id="cb7-516"><a href="#cb7-516"></a></span>
<span id="cb7-517"><a href="#cb7-517"></a><span class="fu">### 10 Ethical and practical considerations  </span></span>
<span id="cb7-518"><a href="#cb7-518"></a></span>
<span id="cb7-519"><a href="#cb7-519"></a>There is no guarantee that statistical optimality will line up with social optimality. A rule that maximises expected health gains might still be **unaffordable** for a public agency, **unfair** to a protected group, or **opaque** to those asked to trust it.  We all have our notions of fairness, and we can't be expected to ignore them. Moreover, the estimation of CATE is always senstive to which variables we include in our model (see the caveats in <span class="co">[</span><span class="ot">Lecture 6</span><span class="co">](https://go-bayes.github.io/psych-434-2025/content/06-content.html#appendix-b-evidence-for-effect-modification-is-relative-to-inclusion-of-other-variables-in-the-model)</span>).  </span>
<span id="cb7-520"><a href="#cb7-520"></a></span>
<span id="cb7-521"><a href="#cb7-521"></a>So, we should not consider CATE an absolute guide to practice. We should be cautious. </span>
<span id="cb7-522"><a href="#cb7-522"></a></span>
<span id="cb7-523"><a href="#cb7-523"></a>Yet the very same CATE machinery that powers targeting also helps science move past a *one-size-fits-all* mindset.  By mapping treatment effects across a high-dimensional covariate space, we can test whether our favourite categories -- gender, age group, clinical severity -- actually capture the differences that matter.  Sometimes they do; often they don't, revealing that nature is not carved at the joints of our folk classifications.  Discovering *where* the forest finds meaningful splits can generate fresh psychological hypotheses about who responds, why, and under what circumstances, even when no policy decision is on the table. Over the next several weeks, we shall return to this point with examples.</span>
<span id="cb7-524"><a href="#cb7-524"></a></span>
<span id="cb7-525"><a href="#cb7-525"></a></span>
<span id="cb7-526"><a href="#cb7-526"></a><span class="co">&lt;!-- Before deployment we therefore need three extra layers of scrutiny: --&gt;</span></span>
<span id="cb7-527"><a href="#cb7-527"></a></span>
<span id="cb7-528"><a href="#cb7-528"></a><span class="co">&lt;!-- 1. **Cost realism**   Will the programme's administrative and opportunity costs erase the forecast benefit?  A cost–effectiveness analysis can reveal when a simpler, less 'optimal' rule actually delivers better value.   --&gt;</span></span>
<span id="cb7-529"><a href="#cb7-529"></a><span class="co">&lt;!-- 2. **Fairness auditing**  check whether error rates or treatment probabilities differ by gender, ethnicity, or socioeconomic status.  If gaps appear, consider adjusting the loss function or adding fairness constraints [@mitchell2021algorithmic].   --&gt;</span></span>
<span id="cb7-530"><a href="#cb7-530"></a><span class="co">&lt;!-- 3. **Transparency and consent**   Publish the rule, document data sources, and secure stakeholder buy-in.  Transparent governance limits the risk of political backlash and encourages external replication. --&gt;</span></span>
<span id="cb7-531"><a href="#cb7-531"></a></span>
<span id="cb7-532"><a href="#cb7-532"></a>---</span>
<span id="cb7-533"><a href="#cb7-533"></a></span>
<span id="cb7-534"><a href="#cb7-534"></a><span class="fu">### Summary/next steps  </span></span>
<span id="cb7-535"><a href="#cb7-535"></a></span>
<span id="cb7-536"><a href="#cb7-536"></a>Our workflow answers three questions in sequence:</span>
<span id="cb7-537"><a href="#cb7-537"></a></span>
<span id="cb7-538"><a href="#cb7-538"></a><span class="ss">1. </span>**Is there substantial heterogeneity?**  Reject $H_0{:}\tau(x)$ constant if RATE AUTOC or RATE Qini is positive and statistically reliable  </span>
<span id="cb7-539"><a href="#cb7-539"></a><span class="ss">2. </span>**Does targeting pay at realistic budgets?**  Inspect the slope of the Qini curve around plausible coverage levels.</span>
<span id="cb7-540"><a href="#cb7-540"></a><span class="ss">3. </span>**Can we express the targeting rule in a few defensible steps?**  fit and validate a shallow policy tree.</span>
<span id="cb7-541"><a href="#cb7-541"></a></span>
<span id="cb7-542"><a href="#cb7-542"></a>In the lab section you will reproduce each stage on a simulated dataset.</span>
<span id="cb7-543"><a href="#cb7-543"></a></span>
<span id="cb7-544"><a href="#cb7-544"></a>---</span>
<span id="cb7-545"><a href="#cb7-545"></a></span>
<span id="cb7-546"><a href="#cb7-546"></a></span>
<span id="cb7-547"><a href="#cb7-547"></a><span class="fu"># PART 1 Laboratory: Data Preparation and Analysis Scripts</span></span>
<span id="cb7-548"><a href="#cb7-548"></a></span>
<span id="cb7-549"><a href="#cb7-549"></a></span>
<span id="cb7-550"><a href="#cb7-550"></a><span class="fu">### Link to data dictionary</span></span>
<span id="cb7-551"><a href="#cb7-551"></a></span>
<span id="cb7-552"><a href="#cb7-552"></a>::: {.callout-note}</span>
<span id="cb7-553"><a href="#cb7-553"></a>For information about the variables in the synthetic data, download the New Zealand Attitudes and Values Data Dictionary here under "Primary Resources"</span>
<span id="cb7-554"><a href="#cb7-554"></a></span>
<span id="cb7-555"><a href="#cb7-555"></a><span class="co">[</span><span class="ot">https://osf.io/75snb/</span><span class="co">](https://osf.io/75snb/)</span></span>
<span id="cb7-556"><a href="#cb7-556"></a></span>
<span id="cb7-557"><a href="#cb7-557"></a>:::</span>
<span id="cb7-558"><a href="#cb7-558"></a></span>
<span id="cb7-559"><a href="#cb7-559"></a><span class="fu">## Script 0: Synthetic Data Fetch</span></span>
<span id="cb7-560"><a href="#cb7-560"></a></span>
<span id="cb7-561"><a href="#cb7-561"></a></span>
<span id="cb7-562"><a href="#cb7-562"></a></span>
<span id="cb7-565"><a href="#cb7-565"></a><span class="in">```{r}</span></span>
<span id="cb7-566"><a href="#cb7-566"></a><span class="co">#| include: true</span></span>
<span id="cb7-567"><a href="#cb7-567"></a><span class="co">#| eval: false</span></span>
<span id="cb7-568"><a href="#cb7-568"></a><span class="co">#| file: ../laboratory/lab-10/00-setup-L10.R</span></span>
<span id="cb7-569"><a href="#cb7-569"></a><span class="in">```</span></span>
<span id="cb7-570"><a href="#cb7-570"></a></span>
<span id="cb7-571"><a href="#cb7-571"></a></span>
<span id="cb7-572"><a href="#cb7-572"></a></span>
<span id="cb7-573"><a href="#cb7-573"></a></span>
<span id="cb7-574"><a href="#cb7-574"></a></span>
<span id="cb7-575"><a href="#cb7-575"></a><span class="fu">## Script 1: Initial Data Wrangling</span></span>
<span id="cb7-576"><a href="#cb7-576"></a></span>
<span id="cb7-579"><a href="#cb7-579"></a><span class="in">```{r}</span></span>
<span id="cb7-580"><a href="#cb7-580"></a><span class="co">#| include: true</span></span>
<span id="cb7-581"><a href="#cb7-581"></a><span class="co">#| eval: false</span></span>
<span id="cb7-582"><a href="#cb7-582"></a><span class="co">#| file: ../laboratory/lab-10/01-init-L10.R</span></span>
<span id="cb7-583"><a href="#cb7-583"></a></span>
<span id="cb7-584"><a href="#cb7-584"></a><span class="in">```</span></span>
<span id="cb7-585"><a href="#cb7-585"></a></span>
<span id="cb7-586"><a href="#cb7-586"></a></span>
<span id="cb7-587"><a href="#cb7-587"></a></span>
<span id="cb7-588"><a href="#cb7-588"></a></span>
<span id="cb7-589"><a href="#cb7-589"></a><span class="fu">## Script 2: Make Wide Data Format With Censoring Weights</span></span>
<span id="cb7-590"><a href="#cb7-590"></a></span>
<span id="cb7-593"><a href="#cb7-593"></a><span class="in">```{r}</span></span>
<span id="cb7-594"><a href="#cb7-594"></a><span class="co">#| include: true</span></span>
<span id="cb7-595"><a href="#cb7-595"></a><span class="co">#| eval: false</span></span>
<span id="cb7-596"><a href="#cb7-596"></a><span class="co">#| file: ../laboratory/lab-10/02-make-wide-L10.R</span></span>
<span id="cb7-597"><a href="#cb7-597"></a></span>
<span id="cb7-598"><a href="#cb7-598"></a><span class="in">```</span></span>
<span id="cb7-599"><a href="#cb7-599"></a></span>
<span id="cb7-600"><a href="#cb7-600"></a></span>
<span id="cb7-601"><a href="#cb7-601"></a><span class="fu">## Script 3: Models &amp; Graphs</span></span>
<span id="cb7-602"><a href="#cb7-602"></a></span>
<span id="cb7-605"><a href="#cb7-605"></a><span class="in">```{r}</span></span>
<span id="cb7-606"><a href="#cb7-606"></a><span class="co">#| include: true</span></span>
<span id="cb7-607"><a href="#cb7-607"></a><span class="co">#| eval: false</span></span>
<span id="cb7-608"><a href="#cb7-608"></a><span class="co">#| file: ../laboratory/lab-10/03-models-L10-v3.R</span></span>
<span id="cb7-609"><a href="#cb7-609"></a></span>
<span id="cb7-610"><a href="#cb7-610"></a><span class="in">```</span></span>
<span id="cb7-611"><a href="#cb7-611"></a></span>
<span id="cb7-612"><a href="#cb7-612"></a></span>
<span id="cb7-613"><a href="#cb7-613"></a></span>
<span id="cb7-614"><a href="#cb7-614"></a><span class="fu">## HOMEWORK: Prepare a fresh set of analysis scripts using a different exposure</span></span>
<span id="cb7-615"><a href="#cb7-615"></a></span>
<span id="cb7-616"><a href="#cb7-616"></a><span class="ss">- </span>E.g. Ask: what are the effects of a shift in religious service <span class="in">`religion_church`</span> on multi-dimensional well-being. </span>
<span id="cb7-617"><a href="#cb7-617"></a><span class="ss">- </span>Consider what variables you need for confounding control at baseline. </span>
<span id="cb7-618"><a href="#cb7-618"></a><span class="ss">- </span>Think about how to make the exposure variable binary.</span>
<span id="cb7-619"><a href="#cb7-619"></a><span class="ss">- </span>You may consider different outcome(s) as well as a different exposure. </span>
<span id="cb7-620"><a href="#cb7-620"></a></span>
<span id="cb7-621"><a href="#cb7-621"></a></span>
<span id="cb7-622"><a href="#cb7-622"></a></span>
<span id="cb7-623"><a href="#cb7-623"></a></span>
<span id="cb7-624"><a href="#cb7-624"></a><span class="fu">### Packages</span></span>
<span id="cb7-625"><a href="#cb7-625"></a></span>
<span id="cb7-628"><a href="#cb7-628"></a><span class="in">```{r}</span></span>
<span id="cb7-629"><a href="#cb7-629"></a>report<span class="sc">::</span><span class="fu">cite_packages</span>()</span>
<span id="cb7-630"><a href="#cb7-630"></a><span class="in">```</span></span>
<span id="cb7-631"><a href="#cb7-631"></a></span>
<span id="cb7-632"><a href="#cb7-632"></a></span>
<span id="cb7-633"><a href="#cb7-633"></a></span>
<span id="cb7-634"><a href="#cb7-634"></a><span class="fu">## Appendix </span></span>
<span id="cb7-635"><a href="#cb7-635"></a></span>
<span id="cb7-636"><a href="#cb7-636"></a><span class="fu">## Review: The Fundamental Problem of Causal Inference as a Missing Data Problem</span></span>
<span id="cb7-637"><a href="#cb7-637"></a></span>
<span id="cb7-638"><a href="#cb7-638"></a>Recall the fundamental problem of causal inference, returning to the question of whether bilingualism improves cognitive abilities:</span>
<span id="cb7-639"><a href="#cb7-639"></a></span>
<span id="cb7-640"><a href="#cb7-640"></a><span class="ss">-   </span>$Y_i^{a = 1}$: The cognitive ability of child $i$ if they were bilingual. This is the counterfactual outcome when A = 1.</span>
<span id="cb7-641"><a href="#cb7-641"></a><span class="ss">-   </span>$Y_i^{a = 0}$:: The cognitive ability of child $i$ if they were monolingual. This is the counterfactual outcome when A = 0.</span>
<span id="cb7-642"><a href="#cb7-642"></a></span>
<span id="cb7-643"><a href="#cb7-643"></a>The causal effect of bilingualism on cognitive ability for individual $i$ is then defined as the difference between these potential outcomes:</span>
<span id="cb7-644"><a href="#cb7-644"></a></span>
<span id="cb7-645"><a href="#cb7-645"></a>$$</span>
<span id="cb7-646"><a href="#cb7-646"></a>\text{Causal Effect}_i = Y_i^{a=1} - Y_i^{a=0} </span>
<span id="cb7-647"><a href="#cb7-647"></a>$$</span>
<span id="cb7-648"><a href="#cb7-648"></a></span>
<span id="cb7-649"><a href="#cb7-649"></a>We say there is a causal effect if:</span>
<span id="cb7-650"><a href="#cb7-650"></a></span>
<span id="cb7-651"><a href="#cb7-651"></a>$$</span>
<span id="cb7-652"><a href="#cb7-652"></a>Y_i^{a=1} - Y_i^{a=0}  \neq 0</span>
<span id="cb7-653"><a href="#cb7-653"></a>$$</span>
<span id="cb7-654"><a href="#cb7-654"></a></span>
<span id="cb7-655"><a href="#cb7-655"></a>However, we only observe one of the potential outcomes for each child. The other outcome is not observed because physics prevents a child from both receiving and not receiving bilingual exposure.</span>
<span id="cb7-656"><a href="#cb7-656"></a></span>
<span id="cb7-657"><a href="#cb7-657"></a>The fact that causal contrasts are not observed in individuals is called "The fundamental problem of causal inference."</span>
<span id="cb7-658"><a href="#cb7-658"></a></span>
<span id="cb7-659"><a href="#cb7-659"></a>Although we typically cannot observe individual causal effects, we can obtain average causal effects when certain assumptions are satisfied.</span>
<span id="cb7-660"><a href="#cb7-660"></a></span>
<span id="cb7-661"><a href="#cb7-661"></a><span class="in">```{=tex}</span></span>
<span id="cb7-662"><a href="#cb7-662"></a><span class="in">\begin{align}</span></span>
<span id="cb7-663"><a href="#cb7-663"></a><span class="in">E(\delta) = E(Y^{a=1} - Y^{a=0})\\</span></span>
<span id="cb7-664"><a href="#cb7-664"></a><span class="in">          ~  = E(Y^{a=1}) - E(Y^{a=0}) \\</span></span>
<span id="cb7-665"><a href="#cb7-665"></a><span class="in">          ~  = ATE</span></span>
<span id="cb7-666"><a href="#cb7-666"></a><span class="in">\end{align}</span></span>
<span id="cb7-667"><a href="#cb7-667"></a><span class="in">```</span></span>
<span id="cb7-668"><a href="#cb7-668"></a>We may identify average causal effects from the data when the following assumptions are met:</span>
<span id="cb7-669"><a href="#cb7-669"></a></span>
<span id="cb7-670"><a href="#cb7-670"></a><span class="ss">-   </span>**Causal Consistency:** The exposure values under comparisons correspond to well-defined interventions that, in turn, correspond to the treatment versions in the data.[]</span>
<span id="cb7-671"><a href="#cb7-671"></a><span class="ss">-   </span>**Positivity:** The probability of receiving every value of the exposure within all strata of co-variates is greater than zero []</span>
<span id="cb7-672"><a href="#cb7-672"></a><span class="ss">-   </span>**Exchangeability:** The conditional probability of receiving every value of an exposure level, though not decided by the investigators, depends only on the measured covariates []</span>
<span id="cb7-673"><a href="#cb7-673"></a></span>
<span id="cb7-674"><a href="#cb7-674"></a>Further assumptions:</span>
<span id="cb7-675"><a href="#cb7-675"></a></span>
<span id="cb7-676"><a href="#cb7-676"></a><span class="ss">-   </span>**No Interference,** also known as the **Stable Unit Treatment Value Assumption** (SUTVA), requires that the treatment given to one unit (e.g., person, group, organization) does not interfere with the potential outcomes of another unit. Put differently, there are no "spillover" effects. Note: this assumption may be thought to be part of causal consistency, namely individual has only one potential outcome under each treatment condition.</span>
<span id="cb7-677"><a href="#cb7-677"></a><span class="ss">-   </span>**Correctly specified model**: the requirement that the underlying statistical model used to estimate causal effects accurately represents the true relationships between the variables of interest. We say the model should be able to capture "the functional form" of the relationship between the treatment, the outcome, and any covariates. The model's functional form should be flexible enough to capture the true underlying relationship. The estimated causal effects may be biased if the model's functional form is incorrect. Additionally, the model must handle omitted variable bias by including all relevant confounders and should correctly handle missing data from non-response or loss-to follow up. We will return to the bias arising from missing data in the weeks ahead. For now, it is important to note that causal inference assumes that our model is correctly specified.</span>
<span id="cb7-678"><a href="#cb7-678"></a></span>
<span id="cb7-679"><a href="#cb7-679"></a></span>
<span id="cb7-680"><a href="#cb7-680"></a><span class="fu">## Subgroup analysis</span></span>
<span id="cb7-681"><a href="#cb7-681"></a></span>
<span id="cb7-682"><a href="#cb7-682"></a>Redcall, **Effect Modification** (also known as "heterogeneity of treatment effects", and "Effect-measure modification") occurs when the causal effect of intervention $A$ varies across different levels of another variable $R$:</span>
<span id="cb7-683"><a href="#cb7-683"></a></span>
<span id="cb7-684"><a href="#cb7-684"></a>$$E(Y^{a=1}|G=g_1, L=l) - E(Y^{a=0}|G=g_1, L=l) \neq E(Y^{a=1}|G=g_2, L=l) - E(Y^{a=0}|G=g_2, L=l)$$</span>
<span id="cb7-685"><a href="#cb7-685"></a></span>
<span id="cb7-686"><a href="#cb7-686"></a>Effect modification indicates that the magnitude of the causal effect of intervention $A$ is related to the modifier variable $G$ level. As discussed last week, effect modification can be observed even when there is no direct causal interaction between the treatment and the modifier variable. We noted that **interaction in causal inference refers to a situation where the combined effect of two interventions is not equal to the sum of their individual effects**. **Effect modification, on the other hand, occurs when the causal effect of one intervention varies across different levels of another variable.**</span>
<span id="cb7-687"><a href="#cb7-687"></a></span>
<span id="cb7-688"><a href="#cb7-688"></a></span>
<span id="cb7-689"><a href="#cb7-689"></a>We also noted that </span>
<span id="cb7-690"><a href="#cb7-690"></a></span>
<span id="cb7-691"><a href="#cb7-691"></a><span class="at">&gt; **For comparative research, we are typically interested in effect-modification, which requires subgroup analysis.**</span></span>
<span id="cb7-692"><a href="#cb7-692"></a></span>
<span id="cb7-693"><a href="#cb7-693"></a></span>
<span id="cb7-694"><a href="#cb7-694"></a><span class="fu">### Causal Estimand, Statistical Estimand, Statistical Estimator</span></span>
<span id="cb7-695"><a href="#cb7-695"></a></span>
<span id="cb7-696"><a href="#cb7-696"></a>Let's set subgroup analysis to the side for a moment and begin focussing on statistical estimation.  </span>
<span id="cb7-697"><a href="#cb7-697"></a></span>
<span id="cb7-698"><a href="#cb7-698"></a>Suppose a researcher wants to understand the causal effect of marriage on individual happiness. Participants in the study are surveyed for their marital status ("married" or "not married") and their self-reported happiness on a scale from 1 to 10.</span>
<span id="cb7-699"><a href="#cb7-699"></a></span>
<span id="cb7-700"><a href="#cb7-700"></a><span class="fu">#### Causal Estimand</span></span>
<span id="cb7-701"><a href="#cb7-701"></a></span>
<span id="cb7-702"><a href="#cb7-702"></a><span class="ss">- </span>**Definition**: The causal estimand is the specific quantity or parameter that we aim to estimate to understand the causal effect of an intervention or treatment on an outcome.</span>
<span id="cb7-703"><a href="#cb7-703"></a></span>
<span id="cb7-704"><a href="#cb7-704"></a><span class="ss">- </span>**Example**: Here, the **Causal Estimand** would be the Average Treatment Effect (ATE) of being married on happiness. Specifically, we define the ATE as the difference in the potential outcomes of happiness if all individuals were married versus if no individuals were married:</span>
<span id="cb7-705"><a href="#cb7-705"></a></span>
<span id="cb7-706"><a href="#cb7-706"></a>  $$</span>
<span id="cb7-707"><a href="#cb7-707"></a>  \text{ATE} = E<span class="co">[</span><span class="ot">Y^{a=1} - Y^{a=0}</span><span class="co">]</span></span>
<span id="cb7-708"><a href="#cb7-708"></a>  $$</span>
<span id="cb7-709"><a href="#cb7-709"></a></span>
<span id="cb7-710"><a href="#cb7-710"></a></span>
<span id="cb7-711"><a href="#cb7-711"></a>  Here, $Y^{a=1}$ represents the potential happiness score if an individual is married, and $Y^{a=0}$ if they are not married.</span>
<span id="cb7-712"><a href="#cb7-712"></a></span>
<span id="cb7-713"><a href="#cb7-713"></a></span>
<span id="cb7-714"><a href="#cb7-714"></a><span class="fu">#### Next step: Are Causal Assumptions Met? </span></span>
<span id="cb7-715"><a href="#cb7-715"></a></span>
<span id="cb7-716"><a href="#cb7-716"></a><span class="ss">- </span>Identification (Exchangeability): balance in the confounders across the treatments to be compared</span>
<span id="cb7-717"><a href="#cb7-717"></a></span>
<span id="cb7-718"><a href="#cb7-718"></a><span class="ss">- </span>Consistency: well-defined interventions</span>
<span id="cb7-719"><a href="#cb7-719"></a></span>
<span id="cb7-720"><a href="#cb7-720"></a><span class="ss">- </span>Positivity: treatments occur within levels of covariates $L$</span>
<span id="cb7-721"><a href="#cb7-721"></a></span>
<span id="cb7-722"><a href="#cb7-722"></a></span>
<span id="cb7-723"><a href="#cb7-723"></a><span class="fu">#### Statistical Estimand (next step)</span></span>
<span id="cb7-724"><a href="#cb7-724"></a></span>
<span id="cb7-725"><a href="#cb7-725"></a><span class="ss">- </span>**The problem**: how do we bridge the gap between potential outcomes and data? </span>
<span id="cb7-726"><a href="#cb7-726"></a></span>
<span id="cb7-727"><a href="#cb7-727"></a><span class="ss">- </span>**Definition**: the statistical estimand is the parameter or function that summarises the relationship between variables as described by a statistical model applied to data. </span>
<span id="cb7-728"><a href="#cb7-728"></a></span>
<span id="cb7-729"><a href="#cb7-729"></a><span class="ss">- </span>**Example**: for our study, the **Statistical Estimand** might be the mean difference in happiness scores between individuals who are married and those who are not, as derived from a linear regression model:</span>
<span id="cb7-730"><a href="#cb7-730"></a></span>
<span id="cb7-731"><a href="#cb7-731"></a>  $$</span>
<span id="cb7-732"><a href="#cb7-732"></a>  \text{Happiness} = \beta_0 + \beta_1 \times \text{Married} + \epsilon</span>
<span id="cb7-733"><a href="#cb7-733"></a>  $$</span>
<span id="cb7-734"><a href="#cb7-734"></a></span>
<span id="cb7-735"><a href="#cb7-735"></a>  In this equation, $\beta_1$ represents the estimated difference in happiness scores between the married and non-married groups.</span>
<span id="cb7-736"><a href="#cb7-736"></a></span>
<span id="cb7-737"><a href="#cb7-737"></a><span class="fu">#### Statistical Estimator</span></span>
<span id="cb7-738"><a href="#cb7-738"></a></span>
<span id="cb7-739"><a href="#cb7-739"></a><span class="ss">- </span>**Definition**: a statistical estimator is a rule or method by which a numerical estimate of a statistical estimand is calculated from the data.</span>
<span id="cb7-740"><a href="#cb7-740"></a></span>
<span id="cb7-741"><a href="#cb7-741"></a><span class="ss">- </span>**Example**: in our marriage study, the **Statistical Estimator** for $\beta_1$ is the ordinary least squares (OLS) estimator. This estimator is used to calculate $\beta_1$ from the sample data provided by the survey. It provides an estimate of the impact of being married on happiness, calculated using:</span>
<span id="cb7-742"><a href="#cb7-742"></a>  $$</span>
<span id="cb7-743"><a href="#cb7-743"></a>  \hat{\beta}_1 = \frac{\sum_{i=1}^n (X_i - \bar{X})(Y_i - \bar{Y})}{\sum_{i=1}^n (X_i - \bar{X})^2}</span>
<span id="cb7-744"><a href="#cb7-744"></a>  $$</span>
<span id="cb7-745"><a href="#cb7-745"></a>  where $X_i$ is a binary indicator for being married (1 for married, 0 for not married), $Y_i$ is the observed happiness score, and $\bar{X}$, $\bar{Y}$ are the sample means of $X$ and $Y$, respectively.</span>
<span id="cb7-746"><a href="#cb7-746"></a></span>
<span id="cb7-747"><a href="#cb7-747"></a>The upshot, we anchor our causal inquiries within a multi-step framework of data analysis. This involves: </span>
<span id="cb7-748"><a href="#cb7-748"></a></span>
<span id="cb7-749"><a href="#cb7-749"></a><span class="ss">1. </span>clearly defining our causal estimand within a specified *target population,*</span>
<span id="cb7-750"><a href="#cb7-750"></a><span class="ss">2. </span>clarifying assumptions, &amp; especially identification assumptions, </span>
<span id="cb7-751"><a href="#cb7-751"></a><span class="ss">3. </span>describing a statistical strategy for extracting this estimand from the data, and then </span>
<span id="cb7-752"><a href="#cb7-752"></a><span class="ss">4. </span>applying an algorithm that embodies this statistical method.</span>
<span id="cb7-753"><a href="#cb7-753"></a></span>
<span id="cb7-754"><a href="#cb7-754"></a></span>
<span id="cb7-755"><a href="#cb7-755"></a><span class="co">&lt;!-- ## Methods for Statistical Estimation in Causal Inference: Inverse Probability of Treatment Weights Using Propensity Scores --&gt;</span></span>
<span id="cb7-756"><a href="#cb7-756"></a></span>
<span id="cb7-757"><a href="#cb7-757"></a><span class="co">&lt;!-- Last week, we discussed confounding control using regression adjustment. Recall the formula for the average treatment effect (ATE) when conditioning on a set of covariates $L$: --&gt;</span></span>
<span id="cb7-758"><a href="#cb7-758"></a></span>
<span id="cb7-759"><a href="#cb7-759"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb7-760"><a href="#cb7-760"></a><span class="co">&lt;!-- \begin{aligned} --&gt;</span></span>
<span id="cb7-761"><a href="#cb7-761"></a><span class="co">&lt;!-- \text{ATE} = E[Y^{a=1} \mid L = l] - E[Y^{a=0} \mid L = l] \quad \text{for any value of } l --&gt;</span></span>
<span id="cb7-762"><a href="#cb7-762"></a><span class="co">&lt;!-- \end{aligned} --&gt;</span></span>
<span id="cb7-763"><a href="#cb7-763"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb7-764"><a href="#cb7-764"></a></span>
<span id="cb7-765"><a href="#cb7-765"></a><span class="co">&lt;!-- &gt; "We say that a set $L$ of measured non-descendants of $L$ is a sufficient set for confounding adjustment when conditioning on $L$ blocks all backdoor paths—that is, the treated and the untreated are exchangeable within levels of $L$" (Hernán &amp; Robins, *Causal Inference*, p. 86). --&gt;</span></span>
<span id="cb7-766"><a href="#cb7-766"></a></span>
<span id="cb7-767"><a href="#cb7-767"></a><span class="co">&lt;!-- This formula calculates the expected outcome difference between treated ($a=1$) and untreated ($a=0$) groups, given a specific value of the covariates $l$. --&gt;</span></span>
<span id="cb7-768"><a href="#cb7-768"></a></span>
<span id="cb7-769"><a href="#cb7-769"></a><span class="co">&lt;!-- Inverse Probability of Treatment Weighting (IPTW) takes a different approach. We create a pseudo-population where the treatment assignment is independent of the observed covariates by assigning weights to each individual based on their propensity scores. --&gt;</span></span>
<span id="cb7-770"><a href="#cb7-770"></a></span>
<span id="cb7-771"><a href="#cb7-771"></a><span class="co">&lt;!-- **We do this by modelling the treatment** --&gt;</span></span>
<span id="cb7-772"><a href="#cb7-772"></a></span>
<span id="cb7-773"><a href="#cb7-773"></a><span class="co">&lt;!-- Denote the treatment indicator by $A$, where $A = 1$ if an individual receives treatment and $A = 0$ otherwise. $L$ represents the vector of observed covariates, and $Y^a$ the potential outcomes. The propensity score, $e(L)$, is defined as the probability of receiving the treatment given the observed covariates: --&gt;</span></span>
<span id="cb7-774"><a href="#cb7-774"></a></span>
<span id="cb7-775"><a href="#cb7-775"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb7-776"><a href="#cb7-776"></a><span class="co">&lt;!-- \hat{e}(L) = P(A = 1 \mid L) --&gt;</span></span>
<span id="cb7-777"><a href="#cb7-777"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb7-778"><a href="#cb7-778"></a></span>
<span id="cb7-779"><a href="#cb7-779"></a><span class="co">&lt;!-- To obtain IPTW weights, compute the inverse probability of treatment: --&gt;</span></span>
<span id="cb7-780"><a href="#cb7-780"></a></span>
<span id="cb7-781"><a href="#cb7-781"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb7-782"><a href="#cb7-782"></a><span class="co">&lt;!-- v_i = \frac{A_i}{\hat{e}(L_i)} + \frac{1 - A_i}{1 - \hat{e}(L_i)} --&gt;</span></span>
<span id="cb7-783"><a href="#cb7-783"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb7-784"><a href="#cb7-784"></a></span>
<span id="cb7-785"><a href="#cb7-785"></a><span class="co">&lt;!-- Which simplifies to  --&gt;</span></span>
<span id="cb7-786"><a href="#cb7-786"></a></span>
<span id="cb7-787"><a href="#cb7-787"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb7-788"><a href="#cb7-788"></a><span class="co">&lt;!-- v_i =  --&gt;</span></span>
<span id="cb7-789"><a href="#cb7-789"></a><span class="co">&lt;!-- \begin{cases}  --&gt;</span></span>
<span id="cb7-790"><a href="#cb7-790"></a><span class="co">&lt;!-- \frac{1}{\hat{e}} &amp; \text{if } A_i = 1 \\ --&gt;</span></span>
<span id="cb7-791"><a href="#cb7-791"></a><span class="co">&lt;!-- \frac{1}{1-\hat{e}} &amp; \text{if } A_i = 0  --&gt;</span></span>
<span id="cb7-792"><a href="#cb7-792"></a><span class="co">&lt;!-- \end{cases} --&gt;</span></span>
<span id="cb7-793"><a href="#cb7-793"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb7-794"><a href="#cb7-794"></a></span>
<span id="cb7-795"><a href="#cb7-795"></a><span class="co">&lt;!-- where $v_i$ is the IPTW weight for individual $i$, $A_i$ is the treatment indicator for individual $i$, and $\hat{e}(L_i)$ is the estimated propensity score for individual $i$.    --&gt;</span></span>
<span id="cb7-796"><a href="#cb7-796"></a></span>
<span id="cb7-797"><a href="#cb7-797"></a><span class="co">&lt;!-- How might we use these weights to obtain causal effect estimates? --&gt;</span></span>
<span id="cb7-798"><a href="#cb7-798"></a></span>
<span id="cb7-799"><a href="#cb7-799"></a></span>
<span id="cb7-800"><a href="#cb7-800"></a></span>
<span id="cb7-801"><a href="#cb7-801"></a><span class="co">&lt;!-- ## Marginal Structural Models (MSMs) --&gt;</span></span>
<span id="cb7-802"><a href="#cb7-802"></a></span>
<span id="cb7-803"><a href="#cb7-803"></a><span class="co">&lt;!-- Marginal Structural Models (MSMs) estimate causal effects without requiring an "outcome model" that stratifies on covariates. Rather, MSMs employ weights derived from the inverse probability of treatment weighting (IPTW) to create a pseudo-population in which the distribution of covariates is independent of treatment assignment over time. --&gt;</span></span>
<span id="cb7-804"><a href="#cb7-804"></a></span>
<span id="cb7-805"><a href="#cb7-805"></a><span class="co">&lt;!-- The general form of an MSM can be expressed as follows: --&gt;</span></span>
<span id="cb7-806"><a href="#cb7-806"></a></span>
<span id="cb7-807"><a href="#cb7-807"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb7-808"><a href="#cb7-808"></a><span class="co">&lt;!-- E[Y^a] = \beta_0 + \beta_1a --&gt;</span></span>
<span id="cb7-809"><a href="#cb7-809"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb7-810"><a href="#cb7-810"></a></span>
<span id="cb7-811"><a href="#cb7-811"></a><span class="co">&lt;!-- where $E[Y^a]$ is the expected outcome under treatment $a$  and $\beta_0$ and $\beta_1$ are parameters estimated by fitting the weighted model. Again, the weights used in the MSM, typically derived from the IPTW (or another treatment model), adjust for the confounding, allowing the model to estimate the unbiased effect of the treatment on the outcome without requiring covariates in the model. --&gt;</span></span>
<span id="cb7-812"><a href="#cb7-812"></a></span>
<span id="cb7-813"><a href="#cb7-813"></a><span class="co">&lt;!-- Where do weights fit in?   Note, we have $E[Y^a]$ in please of $E[Y|A=a]$.  When applying propensity score weights in the linear regression model $E[Y^a] = \beta_0 + \beta_1a$, each observation is weighted by $v_i$, such that $v_i(\beta_0 + \beta_1a)$. This changes the estimation process to focus on a weighted sum of outcomes, where each individual's contribution is adjusted to reflect their probability of receiving the treatment, given their covariates. --&gt;</span></span>
<span id="cb7-814"><a href="#cb7-814"></a></span>
<span id="cb7-815"><a href="#cb7-815"></a></span>
<span id="cb7-816"><a href="#cb7-816"></a><span class="co">&lt;!-- ## Interpretation of $\beta_0$ and $\beta_1$  in a Marginal Structural Model --&gt;</span></span>
<span id="cb7-817"><a href="#cb7-817"></a></span>
<span id="cb7-818"><a href="#cb7-818"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Binary Treatment --&gt;</span></span>
<span id="cb7-819"><a href="#cb7-819"></a></span>
<span id="cb7-820"><a href="#cb7-820"></a><span class="co">&lt;!-- In models where the treatment $a$ is binary (e.g., $a = 0$ or $a = 1$), such as in many causal inference studies: --&gt;</span></span>
<span id="cb7-821"><a href="#cb7-821"></a></span>
<span id="cb7-822"><a href="#cb7-822"></a><span class="co">&lt;!-- - **$\beta_0$**: the expected value of the outcome $Y$ when the treatment is not applied ($a = 0$). This is the baseline level of the outcome in the absence of treatment. --&gt;</span></span>
<span id="cb7-823"><a href="#cb7-823"></a><span class="co">&lt;!-- - **$\beta_1$**: the change in the expected outcome when the treatment status changes from 0 to 1. In logistic regression, $\beta_1$ represents the log-odds ratio of the outcome for the treatment group relative to the control group. In linear regression, $\beta_1$ quantifies the difference in the average outcome between the treated and untreated groups. --&gt;</span></span>
<span id="cb7-824"><a href="#cb7-824"></a></span>
<span id="cb7-825"><a href="#cb7-825"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Continuous Treatment --&gt;</span></span>
<span id="cb7-826"><a href="#cb7-826"></a></span>
<span id="cb7-827"><a href="#cb7-827"></a><span class="co">&lt;!-- When the treatment $a$ is continuous, the interpretation of $\beta_0$ and $\beta_1$ adjusts slightly: --&gt;</span></span>
<span id="cb7-828"><a href="#cb7-828"></a></span>
<span id="cb7-829"><a href="#cb7-829"></a><span class="co">&lt;!-- - **$\beta_0$**: represents the expected value of the outcome $Y$ when the treatment $a$ is at its reference value (often zero).  --&gt;</span></span>
<span id="cb7-830"><a href="#cb7-830"></a><span class="co">&lt;!-- - **$\beta_1$**: represents the expected change in the outcome for each unit increase in the treatment. In this case, $\beta_1$ measures the gradient or slope of the relationship between the treatment and the outcome. For every one-unit increase in treatment, the outcome changes by $\beta_1$ units, assuming all other factors remain constant. --&gt;</span></span>
<span id="cb7-831"><a href="#cb7-831"></a></span>
<span id="cb7-832"><a href="#cb7-832"></a></span>
<span id="cb7-833"><a href="#cb7-833"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co">  How can we apply marginal structural models in subgroups?  --&gt;</span></span>
<span id="cb7-834"><a href="#cb7-834"></a></span>
<span id="cb7-835"><a href="#cb7-835"></a></span>
<span id="cb7-836"><a href="#cb7-836"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Assumptions --&gt;</span></span>
<span id="cb7-837"><a href="#cb7-837"></a></span>
<span id="cb7-838"><a href="#cb7-838"></a><span class="co">&lt;!-- - **Model assumptions**: the treatment model is correctly specified. --&gt;</span></span>
<span id="cb7-839"><a href="#cb7-839"></a><span class="co">&lt;!-- - **Causal assumptions**: all confounders are appropriately controlled, positivity and consistency assumptions hold. --&gt;</span></span>
<span id="cb7-840"><a href="#cb7-840"></a></span>
<span id="cb7-841"><a href="#cb7-841"></a></span>
<span id="cb7-842"><a href="#cb7-842"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Calculating Treatment Weights (Propensity Scores) and Confounding Control in Subgroups --&gt;</span></span>
<span id="cb7-843"><a href="#cb7-843"></a></span>
<span id="cb7-844"><a href="#cb7-844"></a><span class="co">&lt;!-- We may often achieve greater balance when conducting weighted analyses in subgroups by estimating propensity scores *within* these subgroups. The propensity score $ e(L, G) $ is the conditional probability of receiving the exposure $ A = 1 $, given the covariates $ L $ and subgroup indicator $ G $. This is often modelled using logistic regression or other methods that ensure covariate balance --&gt;</span></span>
<span id="cb7-845"><a href="#cb7-845"></a><span class="co">&lt;!-- We define the estimated propensity score as follows: --&gt;</span></span>
<span id="cb7-846"><a href="#cb7-846"></a></span>
<span id="cb7-847"><a href="#cb7-847"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb7-848"><a href="#cb7-848"></a><span class="co">&lt;!-- \hat{e} = P(A = 1 \mid L, G) = f_A(L, G; \theta_A) --&gt;</span></span>
<span id="cb7-849"><a href="#cb7-849"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb7-850"><a href="#cb7-850"></a></span>
<span id="cb7-851"><a href="#cb7-851"></a><span class="co">&lt;!-- Here, $ f_A(L, G; \theta_A) $ is the statistical model estimating the probability of exposure $A = 1$ given covariates $L$ and subgroup $G$. We then calculate the weights for each individual, denoted $v$, using the estimated propensity score: --&gt;</span></span>
<span id="cb7-852"><a href="#cb7-852"></a></span>
<span id="cb7-853"><a href="#cb7-853"></a><span class="co">&lt;!-- $\theta_A$ encapsulates all the coefficients (parameters) in this model, including intercepts, slopes, and potentially other parameters depending on the model complexity (e.g., interaction terms, non-linear effects...etc). --&gt;</span></span>
<span id="cb7-854"><a href="#cb7-854"></a></span>
<span id="cb7-855"><a href="#cb7-855"></a><span class="co">&lt;!-- These weights $v$ depend on $A$ and are calculated as the inverse of the propensity score for exposed individuals and as the inverse of $ 1-\hat{e} $ for unexposed individuals. --&gt;</span></span>
<span id="cb7-856"><a href="#cb7-856"></a></span>
<span id="cb7-857"><a href="#cb7-857"></a><span class="co">&lt;!-- Propensity scores are estimated *separately* within strata of the subgroup to control for potential confounding tailored to each subgroup. These weights $v$ are specific to each individual in subgroup $G$. In the lab, we will clarify how to fit models to estimate contrasts for the causal effects within groups $\hat{\delta}_{g}, \hat{\delta}_{g'}$, etc., and how to obtain estimates for group-wise differences: --&gt;</span></span>
<span id="cb7-858"><a href="#cb7-858"></a></span>
<span id="cb7-859"><a href="#cb7-859"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb7-860"><a href="#cb7-860"></a><span class="co">&lt;!-- \hat{\gamma} = \overbrace{\big( \hat{E}[Y^a \mid G=g] - \hat{E}[Y^{a'} \mid G=g] \big)}^{\hat{\delta}_g} - \overbrace{\big( \hat{E}[Y^{a'} \mid G=g'] - \hat{E}[Y^a \mid G=g'] \big)}^{\hat{\delta}_{g'}} --&gt;</span></span>
<span id="cb7-861"><a href="#cb7-861"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb7-862"><a href="#cb7-862"></a></span>
<span id="cb7-863"><a href="#cb7-863"></a></span>
<span id="cb7-864"><a href="#cb7-864"></a><span class="co">&lt;!-- - **$\hat{E}[Y^a \mid G=g]$**: Estimated expected outcome when treatment $a$ is applied to subgroup $G=g$. --&gt;</span></span>
<span id="cb7-865"><a href="#cb7-865"></a><span class="co">&lt;!-- - **$\hat{E}[Y^{a'} \mid G=g]$**: Estimated expected outcome when a different treatment or control $a'$ is applied to the same subgroup $G=g$. --&gt;</span></span>
<span id="cb7-866"><a href="#cb7-866"></a><span class="co">&lt;!-- - **$\hat{\delta}_g$**: Represents the estimated treatment effect within subgroup $G=g$, computed as the difference in expected outcomes between treatment $a$ and $a'$ within this subgroup. --&gt;</span></span>
<span id="cb7-867"><a href="#cb7-867"></a></span>
<span id="cb7-868"><a href="#cb7-868"></a><span class="co">&lt;!-- - **$\hat{E}[Y^{a'} \mid G=g']$**: Estimated expected outcome when treatment $a'$ is applied to a different subgroup $G=g'$. --&gt;</span></span>
<span id="cb7-869"><a href="#cb7-869"></a><span class="co">&lt;!-- - **$\hat{E}[Y^a \mid G=g']$**: Estimated expected outcome when treatment $a$ is applied to subgroup $G=g'$. --&gt;</span></span>
<span id="cb7-870"><a href="#cb7-870"></a><span class="co">&lt;!-- - **$\hat{\delta}_{g'}$**: Represents the estimated treatment effect within subgroup $G=g'$, computed as the difference in expected outcomes between treatment $a'$ and $a$ within this subgroup. --&gt;</span></span>
<span id="cb7-871"><a href="#cb7-871"></a></span>
<span id="cb7-872"><a href="#cb7-872"></a><span class="co">&lt;!-- - **$\hat{\gamma}$**: The overall measure calculated from your formula represents the difference in treatment effects between two subgroups, $G=g$ and $G=g'$. It quantifies how the effect of switching between treatments $a$ and $a'$ differs across the two subgroups. --&gt;</span></span>
<span id="cb7-873"><a href="#cb7-873"></a></span>
<span id="cb7-874"><a href="#cb7-874"></a></span>
<span id="cb7-875"><a href="#cb7-875"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Considerations --&gt;</span></span>
<span id="cb7-876"><a href="#cb7-876"></a></span>
<span id="cb7-877"><a href="#cb7-877"></a><span class="co">&lt;!-- - **Estimation**: to estimate the expected outcomes $\hat{E}[Y^a \mid G]$ and $\hat{E}[Y^{a'} \mid G]$, we require statistical models. If we use regression, we include interaction terms between treatment and subgroup indicators to directly estimate subgroup-specific treatment effects. Our use depends on correct model specification. --&gt;</span></span>
<span id="cb7-878"><a href="#cb7-878"></a><span class="co">&lt;!-- - **Confidence intervals**: we may compute confidence intervals for $\hat{\gamma}$ using bootstrap, the delta method, or -- in our excercises -- simulation based methods. --&gt;</span></span>
<span id="cb7-879"><a href="#cb7-879"></a><span class="co">&lt;!-- - **Causal assumptions**: again, a causal interpretation of $\hat{\gamma}$ relies on satisfying both causal assumptions and modelling assumptions.  Here, we have described estimation using propensity scores. --&gt;</span></span>
<span id="cb7-880"><a href="#cb7-880"></a></span>
<span id="cb7-881"><a href="#cb7-881"></a></span>
<span id="cb7-882"><a href="#cb7-882"></a><span class="co">&lt;!-- ## Doubly Robust Estimation --&gt;</span></span>
<span id="cb7-883"><a href="#cb7-883"></a></span>
<span id="cb7-884"><a href="#cb7-884"></a><span class="co">&lt;!-- We can combine regression-based estimation with propensity score estimation to obtain *doubly robust* estimation. I will walk you through the steps in the lab. The TL;DR is this: doubly robust estimation reduces reliance on correct model specification. If either the PS model or the regression model is correctly specified, the model will be unbiased -- if the other causal inference assumptions are met. --&gt;</span></span>
<span id="cb7-885"><a href="#cb7-885"></a></span>
<span id="cb7-886"><a href="#cb7-886"></a><span class="co">&lt;!-- We cannot know whether these assumptions are met, we will need to do a sensitivity analysis, the topic of next week. --&gt;</span></span>
<span id="cb7-887"><a href="#cb7-887"></a></span>
<span id="cb7-888"><a href="#cb7-888"></a><span class="co">&lt;!-- I'll show you in lab how to employ simulation-based inference methods to compute standard errors and confidence intervals, following the approaches suggested by Greifer (2023)[]. --&gt;</span></span>
<span id="cb7-889"><a href="#cb7-889"></a></span>
<span id="cb7-890"><a href="#cb7-890"></a><span class="co">&lt;!-- ## Extra Readings n on Propensity Scores: --&gt;</span></span>
<span id="cb7-891"><a href="#cb7-891"></a></span>
<span id="cb7-892"><a href="#cb7-892"></a><span class="co">&lt;!-- Noah Griefer's Software and Blogs: [https://ngreifer.github.io/blog/subgroup-analysis-psm/](https://ngreifer.github.io/blog/) --&gt;</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>