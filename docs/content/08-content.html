<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.20">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Joseph Bulbulia">
<meta name="dcterms.date" content="2025-04-29">

<title>Causal Inference: Estimation of ATE and CATE – PSYC 434 Conducting Research Across Cultures: Trimester 1, 2025</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-94df807a54b4aea56b59f6b1a3567e79.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-d5a3029baa3e394e88f18ffb9b51a21b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css">

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">PSYC 434 Conducting Research Across Cultures: Trimester 1, 2025</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../content/course-outline.html"> 
<span class="menu-text">Course Outline</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-content" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Content</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-content">    
        <li>
    <a class="dropdown-item" href="../content/glossary.pdf">
 <span class="dropdown-text">Glossary</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/course-outline.html">
 <span class="dropdown-text">Course Outline</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/01-content.html">
 <span class="dropdown-text">Week 1: Course Introduction - R (installing packages)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/02-content.html">
 <span class="dropdown-text">Week 2: Causal Diagrams - Elementary Structures and Rules - R (using the interface)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/03-content.html">
 <span class="dropdown-text">Week 3: Causal Diagrams - Confounding Bias - R (regression/simulation)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/04-content.html">
 <span class="dropdown-text">Week 4: Causal Diagrams - Interaction, Measurement Bias, Selection Bias - R (regression/simulation)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/05-content.html">
 <span class="dropdown-text">Week 5: Causal Inference - Average Treatment Effects - R (regression/simulation: ATE)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/06-content.html">
 <span class="dropdown-text">Week 6: Conditional Average Treatment Effects (CATE) - R (regression/simulation: ATE)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/07-quiz.html">
 <span class="dropdown-text">Week 7: In Class Test</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/08-content.html">
 <span class="dropdown-text">Week 8: Causal Inference - Estimation of ATE and CATE - R and LaTeX</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/09-content.html">
 <span class="dropdown-text">Week 9: Hands On: A Full Study Analysis in R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/10-content.html">
 <span class="dropdown-text">Week 10: Hands On: Writing Up Your Analysis: Quarto Documents</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/11-content.html">
 <span class="dropdown-text">Week 11: Measurement: Factor Analysis, CFA, MultiGroup CFA, Partial Invariance/ And How These Approaches Fail</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/12-content.html">
 <span class="dropdown-text">Week 12: Student Presentations</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Causal Inference: Estimation of ATE and CATE</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
                      </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-heading">Affiliation</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author">Joseph Bulbulia <a href="mailto:joseph.bulbulia@vuw.ac.nz" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0000-0002-5861-2056" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              Victoria University of Wellington, New Zealand
            </p>
        </div>
    </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">April 29, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#seminar" id="toc-seminar" class="nav-link active" data-scroll-target="#seminar">Seminar</a>
  <ul class="collapse">
  <li><a href="#learning-outcomes" id="toc-learning-outcomes" class="nav-link" data-scroll-target="#learning-outcomes">Learning Outcomes</a>
  <ul class="collapse">
  <li><a href="#why-is-this-lesson-important" id="toc-why-is-this-lesson-important" class="nav-link" data-scroll-target="#why-is-this-lesson-important">Why is this lesson important?</a></li>
  </ul></li>
  <li><a href="#review-the-fundamental-problem-of-causal-inference-as-a-missing-data-problem" id="toc-review-the-fundamental-problem-of-causal-inference-as-a-missing-data-problem" class="nav-link" data-scroll-target="#review-the-fundamental-problem-of-causal-inference-as-a-missing-data-problem">Review: The Fundamental Problem of Causal Inference as a Missing Data Problem</a></li>
  <li><a href="#subgroup-analysis" id="toc-subgroup-analysis" class="nav-link" data-scroll-target="#subgroup-analysis">Subgroup analysis</a>
  <ul class="collapse">
  <li><a href="#causal-estimand-statistical-estimand-statistical-estimator" id="toc-causal-estimand-statistical-estimand-statistical-estimator" class="nav-link" data-scroll-target="#causal-estimand-statistical-estimand-statistical-estimator">Causal Estimand, Statistical Estimand, Statistical Estimator</a></li>
  </ul></li>
  <li><a href="#methods-for-statistical-estimation-in-causal-inference-inverse-probability-of-treatment-weights-using-propensity-scores" id="toc-methods-for-statistical-estimation-in-causal-inference-inverse-probability-of-treatment-weights-using-propensity-scores" class="nav-link" data-scroll-target="#methods-for-statistical-estimation-in-causal-inference-inverse-probability-of-treatment-weights-using-propensity-scores">Methods for Statistical Estimation in Causal Inference: Inverse Probability of Treatment Weights Using Propensity Scores</a></li>
  <li><a href="#marginal-structural-models-msms" id="toc-marginal-structural-models-msms" class="nav-link" data-scroll-target="#marginal-structural-models-msms">Marginal Structural Models (MSMs)</a></li>
  <li><a href="#interpretation-of-beta_0-and-beta_1-in-a-marginal-structural-model" id="toc-interpretation-of-beta_0-and-beta_1-in-a-marginal-structural-model" class="nav-link" data-scroll-target="#interpretation-of-beta_0-and-beta_1-in-a-marginal-structural-model">Interpretation of <span class="math inline">\beta_0</span> and <span class="math inline">\beta_1</span> in a Marginal Structural Model</a>
  <ul class="collapse">
  <li><a href="#binary-treatment" id="toc-binary-treatment" class="nav-link" data-scroll-target="#binary-treatment">Binary Treatment</a></li>
  <li><a href="#continuous-treatment" id="toc-continuous-treatment" class="nav-link" data-scroll-target="#continuous-treatment">Continuous Treatment</a></li>
  <li><a href="#how-can-we-apply-marginal-structural-models-in-subgroups" id="toc-how-can-we-apply-marginal-structural-models-in-subgroups" class="nav-link" data-scroll-target="#how-can-we-apply-marginal-structural-models-in-subgroups">How can we apply marginal structural models in subgroups?</a></li>
  <li><a href="#assumptions" id="toc-assumptions" class="nav-link" data-scroll-target="#assumptions">Assumptions</a></li>
  <li><a href="#calculating-treatment-weights-propensity-scores-and-confounding-control-in-subgroups" id="toc-calculating-treatment-weights-propensity-scores-and-confounding-control-in-subgroups" class="nav-link" data-scroll-target="#calculating-treatment-weights-propensity-scores-and-confounding-control-in-subgroups">Calculating Treatment Weights (Propensity Scores) and Confounding Control in Subgroups</a></li>
  <li><a href="#considerations" id="toc-considerations" class="nav-link" data-scroll-target="#considerations">Considerations</a></li>
  </ul></li>
  <li><a href="#doubly-robust-estimation" id="toc-doubly-robust-estimation" class="nav-link" data-scroll-target="#doubly-robust-estimation">Doubly Robust Estimation</a></li>
  <li><a href="#readings" id="toc-readings" class="nav-link" data-scroll-target="#readings">Readings:</a></li>
  </ul></li>
  <li><a href="#lab" id="toc-lab" class="nav-link" data-scroll-target="#lab">Lab</a>
  <ul class="collapse">
  <li><a href="#consider-where-the-quantiles-break" id="toc-consider-where-the-quantiles-break" class="nav-link" data-scroll-target="#consider-where-the-quantiles-break">Consider where the quantiles break</a></li>
  <li><a href="#consider-mean" id="toc-consider-mean" class="nav-link" data-scroll-target="#consider-mean">Consider mean</a></li>
  <li><a href="#set-variables" id="toc-set-variables" class="nav-link" data-scroll-target="#set-variables">Set variables</a></li>
  <li><a href="#muliply-impute-missing-values" id="toc-muliply-impute-missing-values" class="nav-link" data-scroll-target="#muliply-impute-missing-values">Muliply impute missing values</a></li>
  <li><a href="#visualise-missing-values" id="toc-visualise-missing-values" class="nav-link" data-scroll-target="#visualise-missing-values">Visualise missing values</a></li>
  <li><a href="#imputations" id="toc-imputations" class="nav-link" data-scroll-target="#imputations">Imputations</a></li>
  <li><a href="#wrangling" id="toc-wrangling" class="nav-link" data-scroll-target="#wrangling">Wrangling</a></li>
  <li><a href="#compute-propensity-scores-for-iptw-using-machine-learning" id="toc-compute-propensity-scores-for-iptw-using-machine-learning" class="nav-link" data-scroll-target="#compute-propensity-scores-for-iptw-using-machine-learning">Compute propensity scores for IPTW using machine learning</a></li>
  <li><a href="#visualise-imbalance" id="toc-visualise-imbalance" class="nav-link" data-scroll-target="#visualise-imbalance">Visualise imbalance</a></li>
  <li><a href="#estimation" id="toc-estimation" class="nav-link" data-scroll-target="#estimation">Estimation</a></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">Results</a></li>
  <li><a href="#packages" id="toc-packages" class="nav-link" data-scroll-target="#packages">Packages</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Required</strong> - <span class="citation" data-cites="vanderweele2020">(<a href="#ref-vanderweele2020" role="doc-biblioref">VanderWeele, Mathur, and Chen 2020</a>)</span> <a href="https://www.dropbox.com/scl/fi/srpynr0dvjcndveplcydn/OutcomeWide_StatisticalScience.pdf?rlkey=h4fv32oyjegdfl3jq9u1fifc3&amp;dl=0">link</a></p>
<p><strong>Optional</strong> - <span class="citation" data-cites="suzuki2020">(<a href="#ref-suzuki2020" role="doc-biblioref">Suzuki, Shinozaki, and Yamamoto 2020</a>)</span> <a href="https://www.dropbox.com/scl/fi/4midxwr9ltg9oce02e0ss/suzuki-causal-diagrams.pdf?rlkey=uktzf3nurtgpbj8m4h0xz82dn&amp;dl=0">link</a> - <span class="citation" data-cites="Bulbulia2024PracticalGuide">(<a href="#ref-Bulbulia2024PracticalGuide" role="doc-biblioref">Bulbulia 2024</a>)</span> <a href="https://osf.io/preprints/psyarxiv/uyg3d">link</a> - <span class="citation" data-cites="hoffman2023">(<a href="#ref-hoffman2023" role="doc-biblioref">Hoffman et al. 2023</a>)</span> <a href="https://arxiv.org/pdf/2304.09460.pdf">link</a></p>
</div>
</div>
<div class="no-row-height column-margin column-container"><div id="ref-hoffman2023" class="csl-entry" role="listitem">
Hoffman, Katherine L., Diego Salazar-Barreto, Kara E. Rudolph, and Iván Díaz. 2023. <span>“Introducing Longitudinal Modified Treatment Policies: A Unified Framework for Studying Complex Exposures,”</span> April. <a href="https://doi.org/10.48550/arXiv.2304.09460">https://doi.org/10.48550/arXiv.2304.09460</a>.
</div></div><div class="no-row-height column-margin column-container"><div id="ref-Bulbulia2024PracticalGuide" class="csl-entry" role="listitem">
Bulbulia, J. A. 2024. <span>“A Practical Guide to Causal Inference in Three-Wave Panel Studies.”</span> OSF. <a href="https://doi.org/10.31234/osf.io/uyg3d">https://doi.org/10.31234/osf.io/uyg3d</a>.
</div></div><div class="no-row-height column-margin column-container"><div id="ref-suzuki2020" class="csl-entry" role="listitem">
Suzuki, Etsuji, Tomohiro Shinozaki, and Eiji Yamamoto. 2020. <span>“Causal Diagrams: Pitfalls and Tips.”</span> <em>Journal of Epidemiology</em> 30 (4): 153–62. <a href="https://doi.org/10.2188/jea.JE20190192">https://doi.org/10.2188/jea.JE20190192</a>.
</div></div><div class="no-row-height column-margin column-container"><div id="ref-vanderweele2020" class="csl-entry" role="listitem">
VanderWeele, Tyler J, Maya B Mathur, and Ying Chen. 2020. <span>“Outcome-Wide Longitudinal Designs for Causal Inference: A New Template for Empirical Studies.”</span> <em>Statistical Science</em> 35 (3): 437–66.
</div></div><div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Key concepts for the test(s):
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>Counfounding vs Confounder</strong></li>
<li><strong>Causal Estimand, Statistical Estimand, Statistical Estimator</strong></li>
<li><strong>Inverse probabilitiy of treatment weights using propensity scores: modelling the exposure or treatment, not the outcome.</strong></li>
<li><strong>Subgroup analysis using propensity scores</strong></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
For the lab, copy and paste code chunks following the “LAB” section.
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
<section id="seminar" class="level1">
<h1>Seminar</h1>
<section id="learning-outcomes" class="level2">
<h2 class="anchored" data-anchor-id="learning-outcomes">Learning Outcomes</h2>
<ul>
<li>You will learn how to state a causal question in a three-wave panel</li>
<li>You will learn how to identify causal effects in a three-waves of panel data.</li>
<li>How to do Propensity-score weighting: modelling the exposure or treatment, not the outcome. <!-- - Outcome modelling: modelling the outcome, with the treatment included in the model --> <!-- - Doubly robust estimation: model both the treatment and the outcome.** --></li>
<li>Subgroup analysis by doubly-robust estimation</li>
</ul>
<!-- - You will learn how to write a report statement that formulates a causal question, names a population of interest, and constructs a causal diagram that explains whether and how to identify a causal effect from data.  -->
<section id="why-is-this-lesson-important" class="level3">
<h3 class="anchored" data-anchor-id="why-is-this-lesson-important">Why is this lesson important?</h3>
<!-- Recall that in psychology, our task is to answer some questions about how people think and behave. In cross-cultural psychology, these questions are typically comparative. -->
<!-- Our first task is clearly define that question. Our second task is to answer that question. -->
<p>The methods you will learn today will help you to define and answer comparative questions in psychology.</p>
</section>
</section>
<section id="review-the-fundamental-problem-of-causal-inference-as-a-missing-data-problem" class="level2">
<h2 class="anchored" data-anchor-id="review-the-fundamental-problem-of-causal-inference-as-a-missing-data-problem">Review: The Fundamental Problem of Causal Inference as a Missing Data Problem</h2>
<p>Recall the fundamental problem of causal inference, returning to the question of whether bilingualism improves cognitive abilities:</p>
<ul>
<li><span class="math inline">Y_i^{a = 1}</span>: The cognitive ability of child <span class="math inline">i</span> if they were bilingual. This is the counterfactual outcome when A = 1.</li>
<li><span class="math inline">Y_i^{a = 0}</span>:: The cognitive ability of child <span class="math inline">i</span> if they were monolingual. This is the counterfactual outcome when A = 0.</li>
</ul>
<p>The causal effect of bilingualism on cognitive ability for individual <span class="math inline">i</span> is then defined as the difference between these potential outcomes:</p>
<p><span class="math display">
\text{Causal Effect}_i = Y_i^{a=1} - Y_i^{a=0}
</span></p>
<p>We say there is a causal effect if:</p>
<p><span class="math display">
Y_i^{a=1} - Y_i^{a=0}  \neq 0
</span></p>
<p>However, we only observe one of the potential outcomes for each child. The other outcome is not observed because physics prevents a child from both receiving and not receiving bilingual exposure.</p>
<p>The fact that causal contrasts are not observed in individuals is called “The fundamental problem of causal inference.”</p>
<p>Although we typically cannot observe individual causal effects, we can obtain average causal effects when certain assumptions are satisfied.</p>
<span class="math display">\begin{align}
E(\delta) = E(Y^{a=1} - Y^{a=0})\\
          ~  = E(Y^{a=1}) - E(Y^{a=0}) \\
          ~  = ATE
\end{align}</span>
<p>We may identify average causal effects from the data when the following assumptions are met:</p>
<ul>
<li><strong>Causal Consistency:</strong> The exposure values under comparisons correspond to well-defined interventions that, in turn, correspond to the treatment versions in the data.[]</li>
<li><strong>Positivity:</strong> The probability of receiving every value of the exposure within all strata of co-variates is greater than zero []</li>
<li><strong>Exchangeability:</strong> The conditional probability of receiving every value of an exposure level, though not decided by the investigators, depends only on the measured covariates []</li>
</ul>
<p>Further assumptions:</p>
<ul>
<li><strong>No Interference,</strong> also known as the <strong>Stable Unit Treatment Value Assumption</strong> (SUTVA), requires that the treatment given to one unit (e.g., person, group, organization) does not interfere with the potential outcomes of another unit. Put differently, there are no “spillover” effects. Note: this assumption may be thought to be part of causal consistency, namely individual has only one potential outcome under each treatment condition.</li>
<li><strong>Correctly specified model</strong>: the requirement that the underlying statistical model used to estimate causal effects accurately represents the true relationships between the variables of interest. We say the model should be able to capture “the functional form” of the relationship between the treatment, the outcome, and any covariates. The model’s functional form should be flexible enough to capture the true underlying relationship. The estimated causal effects may be biased if the model’s functional form is incorrect. Additionally, the model must handle omitted variable bias by including all relevant confounders and should correctly handle missing data from non-response or loss-to follow up. We will return to the bias arising from missing data in the weeks ahead. For now, it is important to note that causal inference assumes that our model is correctly specified.</li>
</ul>
</section>
<section id="subgroup-analysis" class="level2">
<h2 class="anchored" data-anchor-id="subgroup-analysis">Subgroup analysis</h2>
<!-- In causal inference, these two concepts are related but have distinct meanings. -->
<!-- Let $Y_{a}$ denote the counterfactual outcome Y when the experimental intervention $A$ is set to level $a$. Let $Y_{r}$ denote the counterfactual outcome $Y$ when another experimental intervention $R$ is set to level $r$. Following VanderWeele (2009), we can define interaction and effect modification as follows: -->
<!-- 1.  Interaction (causal interaction) on the difference scale, conditional on confounders $L$, occurs when: -->
<!-- $$E(Y^{a1,r1}|L=l) - E(Y^{a0,r1}|L=l) \neq E(Y^{a1,r0}|L=l) - E(Y^{a0,r0}|L=l)$$ -->
<!-- In this case, we are considering a double intervention, and interaction occurs when the combined effect of interventions $A$ and $R$ is not equal to the sum of their individual effects. -->
<p>Redcall, <strong>Effect Modification</strong> (also known as “heterogeneity of treatment effects”, and “Effect-measure modification”) occurs when the causal effect of intervention <span class="math inline">A</span> varies across different levels of another variable <span class="math inline">R</span>:</p>
<p><span class="math display">E(Y^{a=1}|G=g_1, L=l) - E(Y^{a=0}|G=g_1, L=l) \neq E(Y^{a=1}|G=g_2, L=l) - E(Y^{a=0}|G=g_2, L=l)</span></p>
<p>Effect modification indicates that the magnitude of the causal effect of intervention <span class="math inline">A</span> is related to the modifier variable <span class="math inline">G</span> level. As discussed last week, effect modification can be observed even when there is no direct causal interaction between the treatment and the modifier variable. We noted that <strong>interaction in causal inference refers to a situation where the combined effect of two interventions is not equal to the sum of their individual effects</strong>. <strong>Effect modification, on the other hand, occurs when the causal effect of one intervention varies across different levels of another variable.</strong></p>
<p>We also noted that</p>
<blockquote class="blockquote">
<p><strong>For comparative research, we are typically interested in effect-modification, which requires subgroup analysis.</strong></p>
</blockquote>
<section id="causal-estimand-statistical-estimand-statistical-estimator" class="level3">
<h3 class="anchored" data-anchor-id="causal-estimand-statistical-estimand-statistical-estimator">Causal Estimand, Statistical Estimand, Statistical Estimator</h3>
<p>Let’s set subgroup analysis to the side for a moment and begin focussing on statistical estimation.</p>
<p>Suppose a researcher wants to understand the causal effect of marriage on individual happiness. Participants in the study are surveyed for their marital status (“married” or “not married”) and their self-reported happiness on a scale from 1 to 10.</p>
<section id="causal-estimand" class="level4">
<h4 class="anchored" data-anchor-id="causal-estimand">Causal Estimand</h4>
<ul>
<li><p><strong>Definition</strong>: The causal estimand is the specific quantity or parameter that we aim to estimate to understand the causal effect of an intervention or treatment on an outcome.</p></li>
<li><p><strong>Example</strong>: Here, the <strong>Causal Estimand</strong> would be the Average Treatment Effect (ATE) of being married on happiness. Specifically, we define the ATE as the difference in the potential outcomes of happiness if all individuals were married versus if no individuals were married:</p>
<p><span class="math display">
\text{ATE} = E[Y^{a=1} - Y^{a=0}]
</span></p>
<p>Here, <span class="math inline">Y^{a=1}</span> represents the potential happiness score if an individual is married, and <span class="math inline">Y^{a=0}</span> if they are not married.</p></li>
</ul>
</section>
<section id="next-step-are-causal-assumptions-met" class="level4">
<h4 class="anchored" data-anchor-id="next-step-are-causal-assumptions-met">Next step: Are Causal Assumptions Met?</h4>
<ul>
<li><p>Identification (Exchangeability): balance in the confounders across the treatments to be compared</p></li>
<li><p>Consistency: well-defined interventions</p></li>
<li><p>Positivity: treatments occur within levels of covariates <span class="math inline">L</span></p></li>
</ul>
</section>
<section id="statistical-estimand-next-step" class="level4">
<h4 class="anchored" data-anchor-id="statistical-estimand-next-step">Statistical Estimand (next step)</h4>
<ul>
<li><p><strong>The problem</strong>: how do we bridge the gap between potential outcomes and data?</p></li>
<li><p><strong>Definition</strong>: the statistical estimand is the parameter or function that summarises the relationship between variables as described by a statistical model applied to data.</p></li>
<li><p><strong>Example</strong>: for our study, the <strong>Statistical Estimand</strong> might be the mean difference in happiness scores between individuals who are married and those who are not, as derived from a linear regression model:</p>
<p><span class="math display">
\text{Happiness} = \beta_0 + \beta_1 \times \text{Married} + \epsilon
</span></p>
<p>In this equation, <span class="math inline">\beta_1</span> represents the estimated difference in happiness scores between the married and non-married groups.</p></li>
</ul>
</section>
<section id="statistical-estimator" class="level4">
<h4 class="anchored" data-anchor-id="statistical-estimator">Statistical Estimator</h4>
<ul>
<li><p><strong>Definition</strong>: a statistical estimator is a rule or method by which a numerical estimate of a statistical estimand is calculated from the data.</p></li>
<li><p><strong>Example</strong>: in our marriage study, the <strong>Statistical Estimator</strong> for <span class="math inline">\beta_1</span> is the ordinary least squares (OLS) estimator. This estimator is used to calculate <span class="math inline">\beta_1</span> from the sample data provided by the survey. It provides an estimate of the impact of being married on happiness, calculated using: <span class="math display">
\hat{\beta}_1 = \frac{\sum_{i=1}^n (X_i - \bar{X})(Y_i - \bar{Y})}{\sum_{i=1}^n (X_i - \bar{X})^2}
</span> where <span class="math inline">X_i</span> is a binary indicator for being married (1 for married, 0 for not married), <span class="math inline">Y_i</span> is the observed happiness score, and <span class="math inline">\bar{X}</span>, <span class="math inline">\bar{Y}</span> are the sample means of <span class="math inline">X</span> and <span class="math inline">Y</span>, respectively.</p></li>
</ul>
<p>(Note: you will not need to know this equation for the quiz)</p>
<p>The upshot, we anchor our causal inquiries within a mult-step framework of data analysis. This involves:</p>
<ol type="1">
<li>clearly defining our causal estimand within a specified <em>target population,</em></li>
<li>clarifying assumptions, &amp; especially identification assumptions,</li>
<li>describing a statistical strategy for extracting this estimand from the data, and then</li>
<li>applying an algorithm that embodies this statistical method.</li>
</ol>
</section>
</section>
</section>
<section id="methods-for-statistical-estimation-in-causal-inference-inverse-probability-of-treatment-weights-using-propensity-scores" class="level2">
<h2 class="anchored" data-anchor-id="methods-for-statistical-estimation-in-causal-inference-inverse-probability-of-treatment-weights-using-propensity-scores">Methods for Statistical Estimation in Causal Inference: Inverse Probability of Treatment Weights Using Propensity Scores</h2>
<p>Last week, we discussed confounding control using regression adjustment. Recall the formula for the average treatment effect (ATE) when conditioning on a set of covariates <span class="math inline">L</span>:</p>
<p><span class="math display">
\begin{aligned}
\text{ATE} = E[Y^{a=1} \mid L = l] - E[Y^{a=0} \mid L = l] \quad \text{for any value of } l
\end{aligned}
</span></p>
<blockquote class="blockquote">
<p>“We say that a set <span class="math inline">L</span> of measured non-descendants of <span class="math inline">L</span> is a sufficient set for confounding adjustment when conditioning on <span class="math inline">L</span> blocks all backdoor paths—that is, the treated and the untreated are exchangeable within levels of <span class="math inline">L</span>” (Hernán &amp; Robins, <em>Causal Inference</em>, p.&nbsp;86).</p>
</blockquote>
<p>This formula calculates the expected outcome difference between treated (<span class="math inline">a=1</span>) and untreated (<span class="math inline">a=0</span>) groups, given a specific value of the covariates <span class="math inline">l</span>.</p>
<p>Inverse Probability of Treatment Weighting (IPTW) takes a different approach. We create a pseudo-population where the treatment assignment is independent of the observed covariates by assigning weights to each individual based on their propensity scores.</p>
<p><strong>We do this by modelling the treatment</strong></p>
<p>Denote the treatment indicator by <span class="math inline">A</span>, where <span class="math inline">A = 1</span> if an individual receives treatment and <span class="math inline">A = 0</span> otherwise. <span class="math inline">L</span> represents the vector of observed covariates, and <span class="math inline">Y^a</span> the potential outcomes. The propensity score, <span class="math inline">e(L)</span>, is defined as the probability of receiving the treatment given the observed covariates:</p>
<p><span class="math display">
\hat{e}(L) = P(A = 1 \mid L)
</span></p>
<p>To obtain IPTW weights, compute the inverse probability of treatment:</p>
<p><span class="math display">
v_i = \frac{A_i}{\hat{e}(L_i)} + \frac{1 - A_i}{1 - \hat{e}(L_i)}
</span></p>
<p>Which simplifies to</p>
<p><span class="math display">
v_i =
\begin{cases}
\frac{1}{\hat{e}} &amp; \text{if } A_i = 1 \\
\frac{1}{1-\hat{e}} &amp; \text{if } A_i = 0
\end{cases}
</span></p>
<p>where <span class="math inline">v_i</span> is the IPTW weight for individual <span class="math inline">i</span>, <span class="math inline">A_i</span> is the treatment indicator for individual <span class="math inline">i</span>, and <span class="math inline">\hat{e}(L_i)</span> is the estimated propensity score for individual <span class="math inline">i</span>.</p>
<p>How might we use these weights to obtain causal effect estimates?</p>
</section>
<section id="marginal-structural-models-msms" class="level2">
<h2 class="anchored" data-anchor-id="marginal-structural-models-msms">Marginal Structural Models (MSMs)</h2>
<p>Marginal Structural Models (MSMs) estimate causal effects without requiring an “outcome model” that stratifies on covariates. Rather, MSMs employ weights derived from the inverse probability of treatment weighting (IPTW) to create a pseudo-population in which the distribution of covariates is independent of treatment assignment over time.</p>
<p>The general form of an MSM can be expressed as follows:</p>
<p><span class="math display">
E[Y^a] = \beta_0 + \beta_1a
</span></p>
<p>where <span class="math inline">E[Y^a]</span> is the expected outcome under treatment <span class="math inline">a</span> and <span class="math inline">\beta_0</span> and <span class="math inline">\beta_1</span> are parameters estimated by fitting the weighted model. Again, the weights used in the MSM, typically derived from the IPTW (or another treatment model), adjust for the confounding, allowing the model to estimate the unbiased effect of the treatment on the outcome without requiring covariates in the model.</p>
<p>Where do weights fit in? Note, we have <span class="math inline">E[Y^a]</span> in please of <span class="math inline">E[Y|A=a]</span>. When applying propensity score weights in the linear regression model <span class="math inline">E[Y^a] = \beta_0 + \beta_1a</span>, each observation is weighted by <span class="math inline">v_i</span>, such that <span class="math inline">v_i(\beta_0 + \beta_1a)</span>. This changes the estimation process to focus on a weighted sum of outcomes, where each individual’s contribution is adjusted to reflect their probability of receiving the treatment, given their covariates.</p>
</section>
<section id="interpretation-of-beta_0-and-beta_1-in-a-marginal-structural-model" class="level2">
<h2 class="anchored" data-anchor-id="interpretation-of-beta_0-and-beta_1-in-a-marginal-structural-model">Interpretation of <span class="math inline">\beta_0</span> and <span class="math inline">\beta_1</span> in a Marginal Structural Model</h2>
<section id="binary-treatment" class="level3">
<h3 class="anchored" data-anchor-id="binary-treatment">Binary Treatment</h3>
<p>In models where the treatment <span class="math inline">a</span> is binary (e.g., <span class="math inline">a = 0</span> or <span class="math inline">a = 1</span>), such as in many causal inference studies:</p>
<ul>
<li><strong><span class="math inline">\beta_0</span></strong>: the expected value of the outcome <span class="math inline">Y</span> when the treatment is not applied (<span class="math inline">a = 0</span>). This is the baseline level of the outcome in the absence of treatment.</li>
<li><strong><span class="math inline">\beta_1</span></strong>: the change in the expected outcome when the treatment status changes from 0 to 1. In logistic regression, <span class="math inline">\beta_1</span> represents the log-odds ratio of the outcome for the treatment group relative to the control group. In linear regression, <span class="math inline">\beta_1</span> quantifies the difference in the average outcome between the treated and untreated groups.</li>
</ul>
</section>
<section id="continuous-treatment" class="level3">
<h3 class="anchored" data-anchor-id="continuous-treatment">Continuous Treatment</h3>
<p>When the treatment <span class="math inline">a</span> is continuous, the interpretation of <span class="math inline">\beta_0</span> and <span class="math inline">\beta_1</span> adjusts slightly:</p>
<ul>
<li><strong><span class="math inline">\beta_0</span></strong>: represents the expected value of the outcome <span class="math inline">Y</span> when the treatment <span class="math inline">a</span> is at its reference value (often zero).</li>
<li><strong><span class="math inline">\beta_1</span></strong>: represents the expected change in the outcome for each unit increase in the treatment. In this case, <span class="math inline">\beta_1</span> measures the gradient or slope of the relationship between the treatment and the outcome. For every one-unit increase in treatment, the outcome changes by <span class="math inline">\beta_1</span> units, assuming all other factors remain constant.</li>
</ul>
<!-- ### Example: Binary treatment, Binary outcome -->
<!-- ### Logistic Regression Model -->
<!-- In the logistic regression (binary outcomes), the Marginal Structural Model (MSM) model is specified as: -->
<!-- $$ -->
<!-- \text{Logit}(E[Y^a]) = \beta_0 + \beta_1 a, -->
<!-- $$ -->
<!-- where $a$ is the treatment indicator (0 for no treatment, 1 for treatment). -->
<!-- ### Calculation for$Y^{a=0}$(No Treatment) -->
<!-- - **Model Simplification**: when$a = 0$(no treatment), the logit model simplifies to: -->
<!--  $$ -->
<!--   \text{Logit}(E[Y^{a=0}]) = \beta_0. -->
<!--  $$ -->
<!-- - **Expected Outcome**: To find$E[Y^{a=0}]$, convert the logit back to probability: -->
<!--  $$ -->
<!--   E[Y^{a=0}] = \frac{e^{\beta_0}}{1 + e^{\beta_0}} -->
<!--  $$ -->
<!--   This formula gives the predicted probability of the outcome occurring when there is no treatment. -->
<!-- ### Calculation for$Y^{a=1}$(Treatment Given) -->
<!-- - **Model Specification**: when$a = 1$(treatment given), the logit model is: -->
<!--  $$ -->
<!--   \text{Logit}(E[Y^{a=1}]) = \beta_0 + \beta_1. -->
<!--  $$ -->
<!-- - **Expected Outcome**: To find$E[Y^{a=1}]$, similarly convert the logit to probability: -->
<!--  $$ -->
<!--   E[Y^{a=1}] = \frac{e^{\beta_0 + \beta_1}}{1 + e^{\beta_0 + \beta_1}}. -->
<!--  $$ -->
<!--   This is the predicted probability of the outcome occurring when the treatment is applied. -->
<!-- ### Example of MSM -->
<!-- Suppose$\beta_0 = -0.5$and$\beta_1 = 0.8$. Then: -->
<!-- - **No Treatment**:  -->
<!--  $$ -->
<!--   E[Y^{a=0}] = \frac{e^{-0.5}}{1 + e^{-0.5}} \approx \frac{0.607}{1.607} \approx 0.378, -->
<!--  $$ -->
<!-- indicating a 37.8% probability of the outcome occurring without treatment. -->
<!-- - **With Treatment**: -->
<!--  $$ -->
<!--   E[Y^{a=1}] = \frac{e^{-0.5 + 0.8}}{1 + e^{-0.5 + 0.8}} = \frac{e^{0.3}}{1 + e^{0.3}} \approx \frac{1.35}{2.35} \approx 0.574, -->
<!--  $$ -->
<!-- indicating a 57.4% probability of the outcome occurring with treatment. -->
</section>
<section id="how-can-we-apply-marginal-structural-models-in-subgroups" class="level3">
<h3 class="anchored" data-anchor-id="how-can-we-apply-marginal-structural-models-in-subgroups">How can we apply marginal structural models in subgroups?</h3>
</section>
<section id="assumptions" class="level3">
<h3 class="anchored" data-anchor-id="assumptions">Assumptions</h3>
<ul>
<li><strong>Model assumptions</strong>: the treatment model is correctly specified.</li>
<li><strong>Causal assumptions</strong>: all confounders are appropriately controlled, positivity and consistency assumptions hold.</li>
</ul>
</section>
<section id="calculating-treatment-weights-propensity-scores-and-confounding-control-in-subgroups" class="level3">
<h3 class="anchored" data-anchor-id="calculating-treatment-weights-propensity-scores-and-confounding-control-in-subgroups">Calculating Treatment Weights (Propensity Scores) and Confounding Control in Subgroups</h3>
<p>We may often achieve greater balance when conducting weighted analyses in subgroups by estimating propensity scores <em>within</em> these subgroups. The propensity score $ e(L, G) $ is the conditional probability of receiving the exposure $ A = 1 $, given the covariates $ L $ and subgroup indicator $ G $. This is often modelled using logistic regression or other methods that ensure covariate balance We define the estimated propensity score as follows:</p>
<p><span class="math display">
\hat{e} = P(A = 1 \mid L, G) = f_A(L, G; \theta_A)
</span></p>
<p>Here, $ f_A(L, G; _A) $ is the statistical model estimating the probability of exposure <span class="math inline">A = 1</span> given covariates <span class="math inline">L</span> and subgroup <span class="math inline">G</span>. We then calculate the weights for each individual, denoted <span class="math inline">v</span>, using the estimated propensity score:</p>
<p><span class="math inline">\theta_A</span> encapsulates all the coefficients (parameters) in this model, including intercepts, slopes, and potentially other parameters depending on the model complexity (e.g., interaction terms, non-linear effects…etc).</p>
<p>These weights <span class="math inline">v</span> depend on <span class="math inline">A</span> and are calculated as the inverse of the propensity score for exposed individuals and as the inverse of $ 1- $ for unexposed individuals.</p>
<p>Propensity scores are estimated <em>separately</em> within strata of the subgroup to control for potential confounding tailored to each subgroup. These weights <span class="math inline">v</span> are specific to each individual in subgroup <span class="math inline">G</span>. In the lab, we will clarify how to fit models to estimate contrasts for the causal effects within groups <span class="math inline">\hat{\delta}_{g}, \hat{\delta}_{g'}</span>, etc., and how to obtain estimates for group-wise differences:</p>
<p><span class="math display">
\hat{\gamma} = \overbrace{\big( \hat{E}[Y^a \mid G=g] - \hat{E}[Y^{a'} \mid G=g] \big)}^{\hat{\delta}_g} - \overbrace{\big( \hat{E}[Y^{a'} \mid G=g'] - \hat{E}[Y^a \mid G=g'] \big)}^{\hat{\delta}_{g'}}
</span></p>
<ul>
<li><p><strong><span class="math inline">\hat{E}[Y^a \mid G=g]</span></strong>: Estimated expected outcome when treatment <span class="math inline">a</span> is applied to subgroup <span class="math inline">G=g</span>.</p></li>
<li><p><strong><span class="math inline">\hat{E}[Y^{a'} \mid G=g]</span></strong>: Estimated expected outcome when a different treatment or control <span class="math inline">a'</span> is applied to the same subgroup <span class="math inline">G=g</span>.</p></li>
<li><p><strong><span class="math inline">\hat{\delta}_g</span></strong>: Represents the estimated treatment effect within subgroup <span class="math inline">G=g</span>, computed as the difference in expected outcomes between treatment <span class="math inline">a</span> and <span class="math inline">a'</span> within this subgroup.</p></li>
<li><p><strong><span class="math inline">\hat{E}[Y^{a'} \mid G=g']</span></strong>: Estimated expected outcome when treatment <span class="math inline">a'</span> is applied to a different subgroup <span class="math inline">G=g'</span>.</p></li>
<li><p><strong><span class="math inline">\hat{E}[Y^a \mid G=g']</span></strong>: Estimated expected outcome when treatment <span class="math inline">a</span> is applied to subgroup <span class="math inline">G=g'</span>.</p></li>
<li><p><strong><span class="math inline">\hat{\delta}_{g'}</span></strong>: Represents the estimated treatment effect within subgroup <span class="math inline">G=g'</span>, computed as the difference in expected outcomes between treatment <span class="math inline">a'</span> and <span class="math inline">a</span> within this subgroup.</p></li>
<li><p><strong><span class="math inline">\hat{\gamma}</span></strong>: The overall measure calculated from your formula represents the difference in treatment effects between two subgroups, <span class="math inline">G=g</span> and <span class="math inline">G=g'</span>. It quantifies how the effect of switching between treatments <span class="math inline">a</span> and <span class="math inline">a'</span> differs across the two subgroups.</p></li>
</ul>
</section>
<section id="considerations" class="level3">
<h3 class="anchored" data-anchor-id="considerations">Considerations</h3>
<ul>
<li><strong>Estimation</strong>: to estimate the expected outcomes <span class="math inline">\hat{E}[Y^a \mid G]</span> and <span class="math inline">\hat{E}[Y^{a'} \mid G]</span>, we require statistical models. If we use regression, we include interaction terms between treatment and subgroup indicators to directly estimate subgroup-specific treatment effects. Our use depends on correct model specification.</li>
<li><strong>Confidence intervals</strong>: we may compute confidence intervals for <span class="math inline">\hat{\gamma}</span> using bootstrap, the delta method, or – in our excercises – simulation based methods.</li>
<li><strong>Causal assumptions</strong>: again, a causal interpretation of <span class="math inline">\hat{\gamma}</span> relies on satisfying both causal assumptions and modelling assumptions. Here, we have described estimation using propensity scores.</li>
</ul>
</section>
</section>
<section id="doubly-robust-estimation" class="level2">
<h2 class="anchored" data-anchor-id="doubly-robust-estimation">Doubly Robust Estimation</h2>
<p>We can combine regression-based estimation with propensity score estimation to obtain <em>doubly robust</em> estimation. I will walk you through the steps in the lab. The TL;DR is this: doubly robust estimation reduces reliance on correct model specification. If either the PS model or the regression model is correctly specified, the model will be unbiased – if the other causal inference assumptions are met.</p>
<p>We cannot know whether these assumptions are met, we will need to do a sensitivity analysis, the topic of next week.</p>
<p>I’ll show you in lab how to employ simulation-based inference methods to compute standard errors and confidence intervals, following the approaches suggested by Greifer (2023)[].</p>
</section>
<section id="readings" class="level2">
<h2 class="anchored" data-anchor-id="readings">Readings:</h2>
<p>Noah Griefer’s Software and Blogs: <a href="https://ngreifer.github.io/blog/">https://ngreifer.github.io/blog/subgroup-analysis-psm/</a></p>
</section>
</section>
<section id="lab" class="level1 page-columns page-full">
<h1>Lab</h1>
<p>Today we estimate causal effects</p>
<div class="cell page-columns page-full">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># uncomment, update the margot package</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># devtools::install_github("go-bayes/margot")</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># load packages</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(margot)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(skimr)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(naniar)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(WeightIt)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(clarify)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MatchThem)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cobalt)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MatchIt)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmtp)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SuperLearner)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ranger)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xgboost)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nnls)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mice)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"doParallel"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"doParallel"</span>)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"foreach"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"foreach"</span>)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doParallel)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreach)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co"># createmiceadds# create a folder names saved (you should have done this last week).</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co"># set your path to this folder</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="co"># save in cloud if using github</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>push_mods <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">'/Users/joseph/Library/CloudStorage/Dropbox-v-project/data/saved'</span>)</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="co"># check it is correct</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="co"># uncomment, check</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="co">#push_mods</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="co"># set seed for reproducability</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="co"># eliminate haven labels</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>df_nz <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(df_nz)</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>df_nz <span class="ot">&lt;-</span> haven<span class="sc">::</span><span class="fu">zap_formats</span>(df_nz)</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>df_nz <span class="ot">&lt;-</span> haven<span class="sc">::</span><span class="fu">zap_label</span>(df_nz)</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>df_nz <span class="ot">&lt;-</span> haven<span class="sc">::</span><span class="fu">zap_widths</span>(df_nz)</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a><span class="co"># read functions</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a><span class="co"># source("/Users/joseph/GIT/templates/functions/funs.R")</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a><span class="co"># experimental functions (more functions)</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a><span class="co"># source(</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a><span class="co">#   "https://raw.githubusercontent.com/go-bayes/templates/main/functions/experimental_funs.R"</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a><span class="co"># # set exposure name</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>name_exposure <span class="ot">&lt;-</span>  <span class="st">"perfectionism"</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a><span class="co"># check missing values</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>skimr<span class="sc">::</span><span class="fu">skim</span>(df_nz) <span class="sc">|&gt;</span> <span class="fu">arrange</span>(n_missing)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display page-columns page-full">
<table class="table table-sm table-striped small">

<tbody>
<tr class="odd">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">df_nz</td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of rows</td>
<td style="text-align: left;">60000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Number of columns</td>
<td style="text-align: left;">130</td>
</tr>
<tr class="even">
<td style="text-align: left;">_______________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Column type frequency:</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">factor</td>
<td style="text-align: left;">6</td>
</tr>
<tr class="odd">
<td style="text-align: left;">numeric</td>
<td style="text-align: left;">124</td>
</tr>
<tr class="even">
<td style="text-align: left;">________________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Group variables</td>
<td style="text-align: left;">None</td>
</tr>
</tbody>
</table>
<div class="quarto-table-caption margin-caption">Data summary</div><p><strong>Variable type: factor</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 25%">
<col style="width: 8%">
<col style="width: 11%">
<col style="width: 6%">
<col style="width: 7%">
<col style="width: 39%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: left;">ordered</th>
<th style="text-align: right;">n_unique</th>
<th style="text-align: left;">top_counts</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">id</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">20000</td>
<td style="text-align: left;">1: 3, 2: 3, 3: 3, 4: 3</td>
</tr>
<tr class="even">
<td style="text-align: left;">wave</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">201: 20000, 201: 20000, 202: 20000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">gen_cohort</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">gen: 24828, gen: 19965, gen: 11664, gen: 2280</td>
</tr>
<tr class="even">
<td style="text-align: left;">eth_cat</td>
<td style="text-align: right;">786</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">4</td>
<td style="text-align: left;">eur: 47556, mao: 6843, asi: 3321, pac: 1494</td>
</tr>
<tr class="odd">
<td style="text-align: left;">religion_bigger_denominations</td>
<td style="text-align: right;">12562</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">11</td>
<td style="text-align: left;">not: 30926, chr: 5557, cat: 3632, ang: 2274</td>
</tr>
<tr class="even">
<td style="text-align: left;">alert_level_combined_lead</td>
<td style="text-align: right;">20784</td>
<td style="text-align: right;">0.65</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">6</td>
<td style="text-align: left;">no_: 35035, ear: 1618, ale: 1274, ale: 670</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 32%">
<col style="width: 7%">
<col style="width: 10%">
<col style="width: 7%">
<col style="width: 6%">
<col style="width: 4%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 4%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">p0</th>
<th style="text-align: right;">p25</th>
<th style="text-align: right;">p50</th>
<th style="text-align: right;">p75</th>
<th style="text-align: right;">p100</th>
<th style="text-align: left;">hist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">male</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.37</td>
<td style="text-align: right;">0.48</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">▇▁▁▁▅</td>
</tr>
<tr class="even">
<td style="text-align: left;">sample_frame</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">8.26</td>
<td style="text-align: right;">2.86</td>
<td style="text-align: right;">1.10</td>
<td style="text-align: right;">6.90</td>
<td style="text-align: right;">10.10</td>
<td style="text-align: right;">10.10</td>
<td style="text-align: right;">10.90</td>
<td style="text-align: left;">▁▁▁▂▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sample_frame_opt_in</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.03</td>
<td style="text-align: right;">0.16</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">year_measured</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">0.42</td>
<td style="text-align: right;">-1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">▁▁▂▁▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">rural_gch_2018_l</td>
<td style="text-align: right;">578</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">1.66</td>
<td style="text-align: right;">0.98</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">2.00</td>
<td style="text-align: right;">5.00</td>
<td style="text-align: left;">▇▂▂▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">regc_2022_l</td>
<td style="text-align: right;">593</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">7.16</td>
<td style="text-align: right;">5.07</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">2.00</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: right;">13.00</td>
<td style="text-align: right;">99.00</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">nz_dep2018</td>
<td style="text-align: right;">596</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">4.79</td>
<td style="text-align: right;">2.74</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">2.04</td>
<td style="text-align: right;">4.95</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: right;">10.00</td>
<td style="text-align: left;">▇▇▆▅▃</td>
</tr>
<tr class="even">
<td style="text-align: left;">born_nz</td>
<td style="text-align: right;">702</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">0.41</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">▂▁▁▁▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">edu</td>
<td style="text-align: right;">1523</td>
<td style="text-align: right;">0.97</td>
<td style="text-align: right;">5.42</td>
<td style="text-align: right;">2.69</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">3.00</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: right;">10.00</td>
<td style="text-align: left;">▃▃▃▇▂</td>
</tr>
<tr class="even">
<td style="text-align: left;">nzsei_13_l</td>
<td style="text-align: right;">4500</td>
<td style="text-align: right;">0.92</td>
<td style="text-align: right;">54.57</td>
<td style="text-align: right;">16.64</td>
<td style="text-align: right;">10.00</td>
<td style="text-align: right;">42.00</td>
<td style="text-align: right;">56.00</td>
<td style="text-align: right;">69.00</td>
<td style="text-align: right;">90.00</td>
<td style="text-align: left;">▁▃▅▇▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">age</td>
<td style="text-align: right;">12229</td>
<td style="text-align: right;">0.80</td>
<td style="text-align: right;">50.96</td>
<td style="text-align: right;">13.76</td>
<td style="text-align: right;">18.12</td>
<td style="text-align: right;">41.19</td>
<td style="text-align: right;">53.35</td>
<td style="text-align: right;">61.56</td>
<td style="text-align: right;">97.90</td>
<td style="text-align: left;">▂▅▇▂▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">sample_weights</td>
<td style="text-align: right;">12229</td>
<td style="text-align: right;">0.80</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.27</td>
<td style="text-align: right;">0.30</td>
<td style="text-align: right;">0.48</td>
<td style="text-align: right;">0.65</td>
<td style="text-align: right;">0.93</td>
<td style="text-align: right;">19.96</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sfhealth</td>
<td style="text-align: right;">12242</td>
<td style="text-align: right;">0.80</td>
<td style="text-align: right;">5.04</td>
<td style="text-align: right;">1.17</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.34</td>
<td style="text-align: right;">5.04</td>
<td style="text-align: right;">5.96</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▂▃▇▅</td>
</tr>
<tr class="even">
<td style="text-align: left;">perfectionism</td>
<td style="text-align: right;">12247</td>
<td style="text-align: right;">0.80</td>
<td style="text-align: right;">3.12</td>
<td style="text-align: right;">1.37</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">2.01</td>
<td style="text-align: right;">3.00</td>
<td style="text-align: right;">4.03</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▇▇▅▃▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">gratitude</td>
<td style="text-align: right;">12248</td>
<td style="text-align: right;">0.80</td>
<td style="text-align: right;">5.90</td>
<td style="text-align: right;">0.88</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">5.34</td>
<td style="text-align: right;">6.01</td>
<td style="text-align: right;">6.65</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▁▅▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">forgiveness</td>
<td style="text-align: right;">12255</td>
<td style="text-align: right;">0.80</td>
<td style="text-align: right;">5.08</td>
<td style="text-align: right;">1.27</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.31</td>
<td style="text-align: right;">5.32</td>
<td style="text-align: right;">6.02</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▂▃▇▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">vengeful_rumin</td>
<td style="text-align: right;">12255</td>
<td style="text-align: right;">0.80</td>
<td style="text-align: right;">2.92</td>
<td style="text-align: right;">1.27</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.98</td>
<td style="text-align: right;">2.68</td>
<td style="text-align: right;">3.68</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▇▇▃▂▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">lifemeaning</td>
<td style="text-align: right;">12261</td>
<td style="text-align: right;">0.80</td>
<td style="text-align: right;">5.45</td>
<td style="text-align: right;">1.18</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.96</td>
<td style="text-align: right;">5.53</td>
<td style="text-align: right;">6.46</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▃▅▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">support</td>
<td style="text-align: right;">12268</td>
<td style="text-align: right;">0.80</td>
<td style="text-align: right;">5.94</td>
<td style="text-align: right;">1.12</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">5.35</td>
<td style="text-align: right;">6.29</td>
<td style="text-align: right;">6.96</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▁▃▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">nwi</td>
<td style="text-align: right;">12306</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.30</td>
<td style="text-align: right;">1.67</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">4.30</td>
<td style="text-align: right;">5.33</td>
<td style="text-align: right;">6.38</td>
<td style="text-align: right;">10.00</td>
<td style="text-align: left;">▁▃▇▆▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sfhealth_get_sick_easier_reversed</td>
<td style="text-align: right;">12344</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.67</td>
<td style="text-align: right;">1.62</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.99</td>
<td style="text-align: right;">6.02</td>
<td style="text-align: right;">6.99</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▁▁▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">meaning_sense</td>
<td style="text-align: right;">12380</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.72</td>
<td style="text-align: right;">1.20</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">5.01</td>
<td style="text-align: right;">5.99</td>
<td style="text-align: right;">6.96</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▁▂▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">parent</td>
<td style="text-align: right;">12398</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">0.73</td>
<td style="text-align: right;">0.45</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">▃▁▁▁▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">self_control_wish_more_reversed</td>
<td style="text-align: right;">12398</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">3.73</td>
<td style="text-align: right;">1.82</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">2.03</td>
<td style="text-align: right;">3.04</td>
<td style="text-align: right;">5.03</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▇▆▅▃▆</td>
</tr>
<tr class="odd">
<td style="text-align: left;">pwb_your_future_security</td>
<td style="text-align: right;">12403</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">6.32</td>
<td style="text-align: right;">2.35</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">4.98</td>
<td style="text-align: right;">6.98</td>
<td style="text-align: right;">8.01</td>
<td style="text-align: right;">10.00</td>
<td style="text-align: left;">▂▃▆▇▆</td>
</tr>
<tr class="even">
<td style="text-align: left;">emotion_regulation_hide_neg_emotions</td>
<td style="text-align: right;">12408</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">4.19</td>
<td style="text-align: right;">1.66</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">2.99</td>
<td style="text-align: right;">4.04</td>
<td style="text-align: right;">5.05</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▆▅▆▇▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">pwb_your_health</td>
<td style="text-align: right;">12442</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">6.68</td>
<td style="text-align: right;">2.33</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">5.02</td>
<td style="text-align: right;">7.02</td>
<td style="text-align: right;">8.04</td>
<td style="text-align: right;">10.00</td>
<td style="text-align: left;">▁▂▅▇▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">pwb_standard_living</td>
<td style="text-align: right;">12457</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">7.68</td>
<td style="text-align: right;">2.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">6.97</td>
<td style="text-align: right;">8.00</td>
<td style="text-align: right;">9.02</td>
<td style="text-align: right;">10.00</td>
<td style="text-align: left;">▁▁▂▅▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">pwb_your_relationships</td>
<td style="text-align: right;">12460</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">7.71</td>
<td style="text-align: right;">2.26</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">6.97</td>
<td style="text-align: right;">8.03</td>
<td style="text-align: right;">9.03</td>
<td style="text-align: right;">10.00</td>
<td style="text-align: left;">▁▁▂▃▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">neighbourhood_community</td>
<td style="text-align: right;">12461</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">4.27</td>
<td style="text-align: right;">1.63</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">3.00</td>
<td style="text-align: right;">4.04</td>
<td style="text-align: right;">5.95</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▆▅▆▇▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">power_no_control_composite</td>
<td style="text-align: right;">12469</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">2.92</td>
<td style="text-align: right;">1.41</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.96</td>
<td style="text-align: right;">2.55</td>
<td style="text-align: right;">3.99</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▇▅▆▂▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">power_no_control_composite_reversed</td>
<td style="text-align: right;">12469</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.08</td>
<td style="text-align: right;">1.41</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.01</td>
<td style="text-align: right;">5.45</td>
<td style="text-align: right;">6.04</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▂▆▅▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sfhealth_expect_worse_health_reversed</td>
<td style="text-align: right;">12478</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">4.12</td>
<td style="text-align: right;">1.73</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">2.98</td>
<td style="text-align: right;">4.00</td>
<td style="text-align: right;">5.96</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▆▆▆▃▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">employed</td>
<td style="text-align: right;">12558</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">0.41</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">▂▁▁▁▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">religion_religious</td>
<td style="text-align: right;">12561</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">0.35</td>
<td style="text-align: right;">0.48</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">▇▁▁▁▅</td>
</tr>
<tr class="even">
<td style="text-align: left;">conscientiousness</td>
<td style="text-align: right;">12616</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.12</td>
<td style="text-align: right;">1.05</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.47</td>
<td style="text-align: right;">5.24</td>
<td style="text-align: right;">5.96</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▅▇▅</td>
</tr>
<tr class="odd">
<td style="text-align: left;">extraversion</td>
<td style="text-align: right;">12618</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">3.86</td>
<td style="text-align: right;">1.19</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">3.01</td>
<td style="text-align: right;">3.80</td>
<td style="text-align: right;">4.72</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▂▆▇▅▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">openness</td>
<td style="text-align: right;">12622</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">4.96</td>
<td style="text-align: right;">1.11</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.22</td>
<td style="text-align: right;">5.00</td>
<td style="text-align: right;">5.77</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▂▆▇▅</td>
</tr>
<tr class="odd">
<td style="text-align: left;">agreeableness</td>
<td style="text-align: right;">12626</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.36</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.74</td>
<td style="text-align: right;">5.48</td>
<td style="text-align: right;">6.03</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▃▇▆</td>
</tr>
<tr class="even">
<td style="text-align: left;">belong</td>
<td style="text-align: right;">12626</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.11</td>
<td style="text-align: right;">1.08</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.36</td>
<td style="text-align: right;">5.30</td>
<td style="text-align: right;">5.98</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▃▇▅</td>
</tr>
<tr class="odd">
<td style="text-align: left;">honesty_humility</td>
<td style="text-align: right;">12627</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.50</td>
<td style="text-align: right;">1.16</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.75</td>
<td style="text-align: right;">5.72</td>
<td style="text-align: right;">6.47</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▃▆▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">neuroticism</td>
<td style="text-align: right;">12628</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">3.48</td>
<td style="text-align: right;">1.15</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">2.71</td>
<td style="text-align: right;">3.47</td>
<td style="text-align: right;">4.25</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▃▇▇▃▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">self_esteem</td>
<td style="text-align: right;">12633</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.14</td>
<td style="text-align: right;">1.29</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.32</td>
<td style="text-align: right;">5.34</td>
<td style="text-align: right;">6.04</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▂▃▇▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">power_self_nocontrol</td>
<td style="text-align: right;">12642</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">2.96</td>
<td style="text-align: right;">1.64</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.96</td>
<td style="text-align: right;">2.95</td>
<td style="text-align: right;">4.02</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▇▂▂▂▂</td>
</tr>
<tr class="odd">
<td style="text-align: left;">kessler6_sum</td>
<td style="text-align: right;">12650</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.31</td>
<td style="text-align: right;">4.11</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">2.03</td>
<td style="text-align: right;">4.04</td>
<td style="text-align: right;">7.04</td>
<td style="text-align: right;">24.00</td>
<td style="text-align: left;">▇▆▂▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">kessler_latent_depression</td>
<td style="text-align: right;">12654</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">0.58</td>
<td style="text-align: right;">0.74</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.01</td>
<td style="text-align: right;">0.32</td>
<td style="text-align: right;">0.98</td>
<td style="text-align: right;">4.00</td>
<td style="text-align: left;">▇▂▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">kessler_latent_anxiety</td>
<td style="text-align: right;">12656</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">1.20</td>
<td style="text-align: right;">0.77</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.66</td>
<td style="text-align: right;">1.04</td>
<td style="text-align: right;">1.68</td>
<td style="text-align: right;">4.00</td>
<td style="text-align: left;">▇▇▆▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">lifesat</td>
<td style="text-align: right;">12666</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.29</td>
<td style="text-align: right;">1.21</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.53</td>
<td style="text-align: right;">5.50</td>
<td style="text-align: right;">6.03</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▃▆▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">support_turnto</td>
<td style="text-align: right;">12688</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.88</td>
<td style="text-align: right;">1.28</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">5.03</td>
<td style="text-align: right;">6.02</td>
<td style="text-align: right;">6.99</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▁▂▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">emotion_regulation_out_control</td>
<td style="text-align: right;">12701</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">2.81</td>
<td style="text-align: right;">1.66</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.04</td>
<td style="text-align: right;">2.03</td>
<td style="text-align: right;">4.01</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▇▂▂▂▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">modesty</td>
<td style="text-align: right;">12709</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">6.04</td>
<td style="text-align: right;">0.92</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">5.50</td>
<td style="text-align: right;">6.24</td>
<td style="text-align: right;">6.79</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▁▃▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">pers_honestyhumility_seen_expensivecar</td>
<td style="text-align: right;">12737</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.66</td>
<td style="text-align: right;">1.56</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.97</td>
<td style="text-align: right;">6.02</td>
<td style="text-align: right;">6.99</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▁▂▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">belong_beliefs</td>
<td style="text-align: right;">12741</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">4.77</td>
<td style="text-align: right;">1.28</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">3.99</td>
<td style="text-align: right;">4.99</td>
<td style="text-align: right;">5.98</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▂▂▆▇▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">hlth_weight</td>
<td style="text-align: right;">12742</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">79.29</td>
<td style="text-align: right;">18.55</td>
<td style="text-align: right;">35.03</td>
<td style="text-align: right;">65.04</td>
<td style="text-align: right;">77.00</td>
<td style="text-align: right;">89.99</td>
<td style="text-align: right;">209.99</td>
<td style="text-align: left;">▅▇▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">pers_honestyhumility_deserve_more</td>
<td style="text-align: right;">12743</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.30</td>
<td style="text-align: right;">1.53</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.02</td>
<td style="text-align: right;">5.97</td>
<td style="text-align: right;">6.96</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▂▂▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">hlth_fatigue</td>
<td style="text-align: right;">12756</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">1.64</td>
<td style="text-align: right;">1.07</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.98</td>
<td style="text-align: right;">1.96</td>
<td style="text-align: right;">2.04</td>
<td style="text-align: right;">4.00</td>
<td style="text-align: left;">▃▇▇▃▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">kessler_depressed</td>
<td style="text-align: right;">12765</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">0.47</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.02</td>
<td style="text-align: right;">0.98</td>
<td style="text-align: right;">4.00</td>
<td style="text-align: left;">▇▂▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">belong_routside_reversed</td>
<td style="text-align: right;">12767</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.04</td>
<td style="text-align: right;">1.74</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">3.97</td>
<td style="text-align: right;">5.95</td>
<td style="text-align: right;">6.96</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▂▂▂▂▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">pers_agreeable_sympathise_others</td>
<td style="text-align: right;">12767</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.64</td>
<td style="text-align: right;">1.16</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">5.00</td>
<td style="text-align: right;">5.98</td>
<td style="text-align: right;">6.05</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▁▃▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">pers_honestyhumility_pleasure_expensivegoods</td>
<td style="text-align: right;">12767</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.32</td>
<td style="text-align: right;">1.66</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.01</td>
<td style="text-align: right;">5.98</td>
<td style="text-align: right;">6.97</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▂▂▂▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">bodysat</td>
<td style="text-align: right;">12768</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">4.23</td>
<td style="text-align: right;">1.70</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">2.99</td>
<td style="text-align: right;">4.04</td>
<td style="text-align: right;">5.97</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▅▅▅▆▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">rumination</td>
<td style="text-align: right;">12768</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">0.83</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.95</td>
<td style="text-align: right;">1.04</td>
<td style="text-align: right;">4.00</td>
<td style="text-align: left;">▇▅▂▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">kessler_restless</td>
<td style="text-align: right;">12779</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">1.22</td>
<td style="text-align: right;">0.94</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.95</td>
<td style="text-align: right;">1.02</td>
<td style="text-align: right;">1.99</td>
<td style="text-align: right;">4.00</td>
<td style="text-align: left;">▅▇▆▂▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">kessler_nervous</td>
<td style="text-align: right;">12785</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">1.16</td>
<td style="text-align: right;">0.94</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.04</td>
<td style="text-align: right;">1.01</td>
<td style="text-align: right;">1.98</td>
<td style="text-align: right;">4.00</td>
<td style="text-align: left;">▆▇▅▂▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">kessler_worthless</td>
<td style="text-align: right;">12788</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">0.50</td>
<td style="text-align: right;">0.84</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.02</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">4.00</td>
<td style="text-align: left;">▇▂▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">selfesteem_failure_reversed</td>
<td style="text-align: right;">12791</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.23</td>
<td style="text-align: right;">1.63</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.01</td>
<td style="text-align: right;">5.97</td>
<td style="text-align: right;">6.96</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▂▂▂▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">kessler_effort</td>
<td style="text-align: right;">12794</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">1.23</td>
<td style="text-align: right;">0.98</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">1.01</td>
<td style="text-align: right;">1.99</td>
<td style="text-align: right;">4.00</td>
<td style="text-align: left;">▅▇▅▂▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">hlth_height</td>
<td style="text-align: right;">12795</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">1.70</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">1.26</td>
<td style="text-align: right;">1.63</td>
<td style="text-align: right;">1.69</td>
<td style="text-align: right;">1.77</td>
<td style="text-align: right;">2.10</td>
<td style="text-align: left;">▁▂▇▃▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">kessler_hopeless</td>
<td style="text-align: right;">12797</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">0.88</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.96</td>
<td style="text-align: right;">1.04</td>
<td style="text-align: right;">4.00</td>
<td style="text-align: left;">▇▅▃▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">selfesteem_satself</td>
<td style="text-align: right;">12797</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.13</td>
<td style="text-align: right;">1.45</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.03</td>
<td style="text-align: right;">5.95</td>
<td style="text-align: right;">6.02</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▂▃▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">pers_conscientious_chores_done</td>
<td style="text-align: right;">12808</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">4.67</td>
<td style="text-align: right;">1.50</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">3.96</td>
<td style="text-align: right;">4.98</td>
<td style="text-align: right;">5.99</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▂▃▅▆▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">pers_conscientious_forget_putback</td>
<td style="text-align: right;">12812</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.15</td>
<td style="text-align: right;">1.65</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.00</td>
<td style="text-align: right;">5.96</td>
<td style="text-align: right;">6.04</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▂▂▂▂▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">belong_accept</td>
<td style="text-align: right;">12814</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.52</td>
<td style="text-align: right;">1.27</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.98</td>
<td style="text-align: right;">5.98</td>
<td style="text-align: right;">6.04</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▁▃▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">pers_agreeable_no_interest_others</td>
<td style="text-align: right;">12819</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.39</td>
<td style="text-align: right;">1.36</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.96</td>
<td style="text-align: right;">5.97</td>
<td style="text-align: right;">6.04</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▂▃▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">pers_extraversion_talk_peopleparties</td>
<td style="text-align: right;">12820</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">3.81</td>
<td style="text-align: right;">1.72</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">2.04</td>
<td style="text-align: right;">3.98</td>
<td style="text-align: right;">5.02</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▇▅▆▅▆</td>
</tr>
<tr class="even">
<td style="text-align: left;">pers_extraversion_life_party</td>
<td style="text-align: right;">12828</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">3.42</td>
<td style="text-align: right;">1.44</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">2.03</td>
<td style="text-align: right;">3.05</td>
<td style="text-align: right;">4.04</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▇▆▇▅▂</td>
</tr>
<tr class="odd">
<td style="text-align: left;">selfesteem_postiveself</td>
<td style="text-align: right;">12830</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.06</td>
<td style="text-align: right;">1.41</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.02</td>
<td style="text-align: right;">5.03</td>
<td style="text-align: right;">6.01</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▂▃▅▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">pers_neuroticism_upset_easily</td>
<td style="text-align: right;">12843</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">3.47</td>
<td style="text-align: right;">1.52</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">2.02</td>
<td style="text-align: right;">3.03</td>
<td style="text-align: right;">4.96</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▇▅▅▃▂</td>
</tr>
<tr class="odd">
<td style="text-align: left;">pers_neuroticism_mostly_relaxed</td>
<td style="text-align: right;">12844</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">3.43</td>
<td style="text-align: right;">1.42</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">2.03</td>
<td style="text-align: right;">3.03</td>
<td style="text-align: right;">4.04</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▇▇▆▃▂</td>
</tr>
<tr class="even">
<td style="text-align: left;">pers_neuroticism_mood_swings</td>
<td style="text-align: right;">12847</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">3.15</td>
<td style="text-align: right;">1.59</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.98</td>
<td style="text-align: right;">2.99</td>
<td style="text-align: right;">4.03</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▇▃▃▂▂</td>
</tr>
<tr class="odd">
<td style="text-align: left;">pers_neuroticism_seldom_blue</td>
<td style="text-align: right;">12851</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">3.86</td>
<td style="text-align: right;">1.66</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">2.04</td>
<td style="text-align: right;">3.99</td>
<td style="text-align: right;">5.02</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▇▅▆▆▆</td>
</tr>
<tr class="even">
<td style="text-align: left;">pers_conscientious_like_order</td>
<td style="text-align: right;">12853</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.41</td>
<td style="text-align: right;">1.29</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.96</td>
<td style="text-align: right;">5.96</td>
<td style="text-align: right;">6.04</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▂▃▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">pers_extraversion_keepbackground</td>
<td style="text-align: right;">12854</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">3.92</td>
<td style="text-align: right;">1.49</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">2.98</td>
<td style="text-align: right;">3.99</td>
<td style="text-align: right;">5.00</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▆▆▇▆▅</td>
</tr>
<tr class="even">
<td style="text-align: left;">pers_agreeable_feel_others_emotions</td>
<td style="text-align: right;">12859</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.32</td>
<td style="text-align: right;">1.31</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.96</td>
<td style="text-align: right;">5.96</td>
<td style="text-align: right;">6.03</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▂▃▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">pers_agreeable_no_interest_others_probs</td>
<td style="text-align: right;">12870</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.07</td>
<td style="text-align: right;">1.48</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.01</td>
<td style="text-align: right;">5.04</td>
<td style="text-align: right;">6.02</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▂▂▃▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">pers_honestyhumility_feel_entitled</td>
<td style="text-align: right;">12873</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.69</td>
<td style="text-align: right;">1.32</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.99</td>
<td style="text-align: right;">6.00</td>
<td style="text-align: right;">6.97</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▁▂▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">pers_openness_vivid_imagination</td>
<td style="text-align: right;">12882</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">4.67</td>
<td style="text-align: right;">1.52</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">3.96</td>
<td style="text-align: right;">4.98</td>
<td style="text-align: right;">5.99</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▂▃▅▆▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">pers_extraversion_dont_talkalot</td>
<td style="text-align: right;">12894</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">4.31</td>
<td style="text-align: right;">1.59</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">3.01</td>
<td style="text-align: right;">4.03</td>
<td style="text-align: right;">5.96</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▅▅▇▆▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">pers_conscientious_make_mess</td>
<td style="text-align: right;">12897</td>
<td style="text-align: right;">0.79</td>
<td style="text-align: right;">5.26</td>
<td style="text-align: right;">1.37</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.03</td>
<td style="text-align: right;">5.96</td>
<td style="text-align: right;">6.03</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▂▃▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">pers_openness_good_imagination</td>
<td style="text-align: right;">12904</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">5.22</td>
<td style="text-align: right;">1.55</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.02</td>
<td style="text-align: right;">5.96</td>
<td style="text-align: right;">6.04</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▂▂▃▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lifesat_satlife</td>
<td style="text-align: right;">12917</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">5.67</td>
<td style="text-align: right;">1.23</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">5.00</td>
<td style="text-align: right;">5.99</td>
<td style="text-align: right;">6.95</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▁▂▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">pers_openness_difficult_abstraction</td>
<td style="text-align: right;">12918</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">4.95</td>
<td style="text-align: right;">1.54</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">3.98</td>
<td style="text-align: right;">5.02</td>
<td style="text-align: right;">6.02</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▂▂▃▃▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">pers_openness_interested_abstraction</td>
<td style="text-align: right;">13013</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">5.00</td>
<td style="text-align: right;">1.50</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">3.99</td>
<td style="text-align: right;">5.02</td>
<td style="text-align: right;">6.02</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▂▃▃▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">hlth_bmi</td>
<td style="text-align: right;">13016</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">27.41</td>
<td style="text-align: right;">5.93</td>
<td style="text-align: right;">12.35</td>
<td style="text-align: right;">23.39</td>
<td style="text-align: right;">26.26</td>
<td style="text-align: right;">30.18</td>
<td style="text-align: right;">75.56</td>
<td style="text-align: left;">▆▇▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">smoker</td>
<td style="text-align: right;">13077</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">0.06</td>
<td style="text-align: right;">0.24</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">self_control_have_lots</td>
<td style="text-align: right;">13107</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">5.04</td>
<td style="text-align: right;">1.43</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.02</td>
<td style="text-align: right;">5.03</td>
<td style="text-align: right;">6.01</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▂▂▅▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">religion_identification_level</td>
<td style="text-align: right;">13120</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">2.33</td>
<td style="text-align: right;">2.17</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.00</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▇▁▁▁▂</td>
</tr>
<tr class="even">
<td style="text-align: left;">meaning_purpose</td>
<td style="text-align: right;">13302</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">5.18</td>
<td style="text-align: right;">1.43</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.04</td>
<td style="text-align: right;">5.04</td>
<td style="text-align: right;">6.03</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▂▅▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">support_help</td>
<td style="text-align: right;">13303</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">6.07</td>
<td style="text-align: right;">1.16</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">5.96</td>
<td style="text-align: right;">6.04</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▁▁▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">partner</td>
<td style="text-align: right;">13333</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">0.76</td>
<td style="text-align: right;">0.43</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">▂▁▁▁▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">permeability_individual</td>
<td style="text-align: right;">13371</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">5.20</td>
<td style="text-align: right;">1.24</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.05</td>
<td style="text-align: right;">5.03</td>
<td style="text-align: right;">6.01</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▃▆▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">support_noguidance_reversed</td>
<td style="text-align: right;">13373</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">5.88</td>
<td style="text-align: right;">1.47</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">5.04</td>
<td style="text-align: right;">6.04</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▁▁▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">impermeability_group</td>
<td style="text-align: right;">13408</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">3.67</td>
<td style="text-align: right;">1.58</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">2.04</td>
<td style="text-align: right;">3.97</td>
<td style="text-align: right;">4.99</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▇▆▇▆▃</td>
</tr>
<tr class="even">
<td style="text-align: left;">alcohol_frequency</td>
<td style="text-align: right;">13462</td>
<td style="text-align: right;">0.78</td>
<td style="text-align: right;">2.17</td>
<td style="text-align: right;">1.35</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">2.02</td>
<td style="text-align: right;">3.03</td>
<td style="text-align: right;">5.00</td>
<td style="text-align: left;">▇▇▇▇▃</td>
</tr>
<tr class="odd">
<td style="text-align: left;">hours_charity</td>
<td style="text-align: right;">13563</td>
<td style="text-align: right;">0.77</td>
<td style="text-align: right;">1.42</td>
<td style="text-align: right;">4.18</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.02</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">168.00</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">hours_exercise</td>
<td style="text-align: right;">13565</td>
<td style="text-align: right;">0.77</td>
<td style="text-align: right;">6.02</td>
<td style="text-align: right;">7.80</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">2.00</td>
<td style="text-align: right;">4.03</td>
<td style="text-align: right;">7.02</td>
<td style="text-align: right;">168.00</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">religion_believe_god</td>
<td style="text-align: right;">13809</td>
<td style="text-align: right;">0.77</td>
<td style="text-align: right;">0.44</td>
<td style="text-align: right;">0.50</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">▇▁▁▁▆</td>
</tr>
<tr class="even">
<td style="text-align: left;">religion_believe_spirit</td>
<td style="text-align: right;">13809</td>
<td style="text-align: right;">0.77</td>
<td style="text-align: right;">0.67</td>
<td style="text-align: right;">0.47</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">▃▁▁▁▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sfhealth_your_health</td>
<td style="text-align: right;">13942</td>
<td style="text-align: right;">0.77</td>
<td style="text-align: right;">5.33</td>
<td style="text-align: right;">1.26</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.96</td>
<td style="text-align: right;">5.96</td>
<td style="text-align: right;">6.02</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▂▃▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">power_others_control</td>
<td style="text-align: right;">14051</td>
<td style="text-align: right;">0.77</td>
<td style="text-align: right;">2.87</td>
<td style="text-align: right;">1.61</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.95</td>
<td style="text-align: right;">2.05</td>
<td style="text-align: right;">4.01</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▇▂▂▂▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">emotion_regulation_change_thinking_to_calm</td>
<td style="text-align: right;">14177</td>
<td style="text-align: right;">0.76</td>
<td style="text-align: right;">4.81</td>
<td style="text-align: right;">1.45</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">3.99</td>
<td style="text-align: right;">5.00</td>
<td style="text-align: right;">5.99</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▂▂▅▇▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">lifesat_ideal</td>
<td style="text-align: right;">14186</td>
<td style="text-align: right;">0.76</td>
<td style="text-align: right;">4.89</td>
<td style="text-align: right;">1.43</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.00</td>
<td style="text-align: right;">5.01</td>
<td style="text-align: right;">6.00</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▂▂▃▆▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">religion_perceive_religious_discrim</td>
<td style="text-align: right;">14198</td>
<td style="text-align: right;">0.76</td>
<td style="text-align: right;">1.96</td>
<td style="text-align: right;">1.40</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.04</td>
<td style="text-align: right;">2.04</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">hlth_sleep_hours</td>
<td style="text-align: right;">14277</td>
<td style="text-align: right;">0.76</td>
<td style="text-align: right;">6.94</td>
<td style="text-align: right;">1.12</td>
<td style="text-align: right;">2.00</td>
<td style="text-align: right;">6.02</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: right;">7.97</td>
<td style="text-align: right;">20.00</td>
<td style="text-align: left;">▁▇▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">charity_donate</td>
<td style="text-align: right;">14501</td>
<td style="text-align: right;">0.76</td>
<td style="text-align: right;">1013.80</td>
<td style="text-align: right;">6682.04</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">20.03</td>
<td style="text-align: right;">149.97</td>
<td style="text-align: right;">500.02</td>
<td style="text-align: right;">650000.00</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">alcohol_intensity</td>
<td style="text-align: right;">14605</td>
<td style="text-align: right;">0.76</td>
<td style="text-align: right;">2.08</td>
<td style="text-align: right;">2.08</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.98</td>
<td style="text-align: right;">1.97</td>
<td style="text-align: right;">2.96</td>
<td style="text-align: right;">36.00</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">political_conservative</td>
<td style="text-align: right;">14644</td>
<td style="text-align: right;">0.76</td>
<td style="text-align: right;">3.57</td>
<td style="text-align: right;">1.37</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">2.05</td>
<td style="text-align: right;">3.96</td>
<td style="text-align: right;">4.04</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▆▅▇▃▂</td>
</tr>
<tr class="even">
<td style="text-align: left;">household_inc</td>
<td style="text-align: right;">14744</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">117927.50</td>
<td style="text-align: right;">97598.66</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">59999.96</td>
<td style="text-align: right;">99999.98</td>
<td style="text-align: right;">150000.02</td>
<td style="text-align: right;">3000000.00</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">pol_wing</td>
<td style="text-align: right;">15139</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">3.71</td>
<td style="text-align: right;">1.30</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">2.97</td>
<td style="text-align: right;">3.98</td>
<td style="text-align: right;">4.05</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▅▅▇▃▂</td>
</tr>
<tr class="even">
<td style="text-align: left;">sexual_satisfaction</td>
<td style="text-align: right;">15680</td>
<td style="text-align: right;">0.74</td>
<td style="text-align: right;">4.51</td>
<td style="text-align: right;">1.77</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">3.04</td>
<td style="text-align: right;">4.97</td>
<td style="text-align: right;">6.00</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▃▂▅▅▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">emp_job_sat</td>
<td style="text-align: right;">23630</td>
<td style="text-align: right;">0.61</td>
<td style="text-align: right;">5.31</td>
<td style="text-align: right;">1.45</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.96</td>
<td style="text-align: right;">5.96</td>
<td style="text-align: right;">6.04</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▂▃▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">emp_job_secure</td>
<td style="text-align: right;">23677</td>
<td style="text-align: right;">0.61</td>
<td style="text-align: right;">5.49</td>
<td style="text-align: right;">1.55</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.97</td>
<td style="text-align: right;">5.99</td>
<td style="text-align: right;">6.97</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▁▁▁▂▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">emp_job_valued</td>
<td style="text-align: right;">23912</td>
<td style="text-align: right;">0.60</td>
<td style="text-align: right;">5.18</td>
<td style="text-align: right;">1.65</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4.02</td>
<td style="text-align: right;">5.96</td>
<td style="text-align: right;">6.05</td>
<td style="text-align: right;">7.00</td>
<td style="text-align: left;">▂▁▂▃▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">home_owner</td>
<td style="text-align: right;">27754</td>
<td style="text-align: right;">0.54</td>
<td style="text-align: right;">0.76</td>
<td style="text-align: right;">0.43</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">▂▁▁▁▇</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain ids for individuals who participated in 2018 and have no missing baseline exposure</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>ids_2018 <span class="ot">&lt;-</span> df_nz <span class="sc">|&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(year_measured <span class="sc">==</span> <span class="dv">1</span>, wave <span class="sc">==</span> <span class="dv">2018</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_exposure))) <span class="sc">|&gt;</span> <span class="co"># criteria, no missing</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(eth_cat)) <span class="sc">|&gt;</span> <span class="co"># criteria, no missing</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(id)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain ids for individuals who participated in 2019</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>ids_2019 <span class="ot">&lt;-</span> df_nz <span class="sc">|&gt;</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(year_measured <span class="sc">==</span> <span class="dv">1</span>, wave <span class="sc">==</span> <span class="dv">2019</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_exposure))) <span class="sc">|&gt;</span> <span class="co"># criteria, no missing</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(id)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co"># intersect IDs from 2018 and 2019 to ensure participation in both years</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>ids_2018_2019 <span class="ot">&lt;-</span> <span class="fu">intersect</span>(ids_2018, ids_2019)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co"># data wrangling</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>dat_long <span class="ot">&lt;-</span> df_nz <span class="sc">|&gt;</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(id <span class="sc">%in%</span> ids_2018_2019 <span class="sc">&amp;</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>                  wave <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2018</span>, <span class="dv">2019</span>, <span class="dv">2020</span>)) <span class="sc">|&gt;</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id, wave) <span class="sc">|&gt;</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"id"</span>,</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"wave"</span>,</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"year_measured"</span>,</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"age"</span>,</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"male"</span>,</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"born_nz"</span>,</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"eth_cat"</span>,</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">#factor(EthCat, labels = c("Euro", "Maori", "Pacific", "Asian")),</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"employed"</span>,</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># are you currently employed? (this includes self-employment or casual work)</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"edu"</span>,</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># "gen_cohort",</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"household_inc"</span>,</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"partner"</span>,</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 0 = no, 1 = yes</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">"parent"</span>,</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">#"alert_level_combined_lead", # see bibliography</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 0 = no, 1 = yes</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">"political_conservative"</span>, <span class="co"># see nzavs sheet</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hours_exercise"</span>, <span class="co"># see nzavs sheet</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">"agreeableness"</span>, </span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mini-IPIP6 Agreeableness (also modelled as empathy facet)</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sympathize with others' feelings.</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Am not interested in other people's problems.</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Feel others' emotions.</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Am not really interested in others.</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">"conscientiousness"</span>,</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># see mini ipip6</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get chores done right away.</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Like order.</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make a mess of things.</span></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Often forget to put things back in their proper place.</span></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">"extraversion"</span>,</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mini-IPIP6 Extraversion</span></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Am the life of the party.</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Don't talk a lot.</span></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keep in the background.</span></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Talk to a lot of different people at parties.</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>    <span class="st">"honesty_humility"</span>,</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># see mini ipip6</span></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Would like to be seen driving around in a very expensive car.</span></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Would get a lot of pleasure from owning expensive luxury goods.</span></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Feel entitled to more of everything.</span></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Deserve more things in life.</span></span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>    <span class="st">"openness"</span>,</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># see mini ipip6</span></span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Have a vivid imagination.</span></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Have difficulty understanding abstract ideas.</span></span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Do not have a good imagination.</span></span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Am not interested in abstract ideas.</span></span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>    <span class="st">"neuroticism"</span>,</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># see mini ipip6</span></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Have frequent mood swings.</span></span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Am relaxed most of the time.</span></span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get upset easily.</span></span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Seldom feel blue.</span></span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>    <span class="st">"modesty"</span>,</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # see mini ipip6</span></span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # I want people to know that I am an important person of high status,</span></span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # I am an ordinary person who is no better than others.</span></span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # I wouldn’t want people to treat me as though I were superior to them.</span></span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # I think that I am entitled to more respect than the average person is</span></span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>    <span class="co">#"w_gend_age_ethnic",</span></span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>    <span class="st">"neighbourhood_community"</span>,</span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># #I feel a sense of community with others in my local neighbourhood.</span></span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>    <span class="st">"belong"</span>, <span class="co"># see nzavs sheet</span></span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rural_gch_2018_l"</span>,<span class="co"># see nzavs sheet</span></span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>    <span class="st">"support"</span>,</span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># "support_help",</span></span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # 'There are people I can depend on to help me if I really need it.</span></span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># "support_turnto",</span></span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # There is no one I can turn to for guidance in times of stress.</span></span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># "support_rnoguidance",</span></span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>    <span class="co">#There is no one I can turn to for guidance in times of stress.</span></span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>    <span class="st">"perfectionism"</span>,</span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>    <span class="st">"religion_religious"</span>,</span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a>    <span class="st">"kessler_latent_depression"</span>,</span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a>    <span class="st">"kessler_latent_anxiety"</span></span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>    <span class="co">#initialize 'censored'</span></span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">censored =</span> <span class="fu">ifelse</span>(<span class="fu">lead</span>(year_measured) <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a>    <span class="co"># modify 'censored' based on the condition; no need to check for NA here as 'censored' is already defined in the previous step</span></span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a>    <span class="at">censored =</span>  <span class="fu">ifelse</span>(<span class="fu">is.na</span>(censored) <span class="sc">&amp;</span></span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a>                         year_measured <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, censored),</span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create urban binary variable</span></span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a>    <span class="at">urban =</span> <span class="fu">ifelse</span>(rural_gch_2018_l <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(year_measured, rural_gch_2018_l) )<span class="sc">|&gt;</span></span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb2-117"><a href="#cb2-117" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rescale these variables, to get all variables on a similar scale</span></span>
<span id="cb2-118"><a href="#cb2-118" aria-hidden="true" tabindex="-1"></a>    <span class="co"># otherwise your models can blow up, or become uninterpretable. </span></span>
<span id="cb2-119"><a href="#cb2-119" aria-hidden="true" tabindex="-1"></a>    <span class="at">household_inc_log =</span> <span class="fu">log</span>(household_inc <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb2-120"><a href="#cb2-120" aria-hidden="true" tabindex="-1"></a>    <span class="at">hours_exercise_log =</span> <span class="fu">log</span>(hours_exercise <span class="sc">+</span> <span class="dv">1</span>)  ) <span class="sc">|&gt;</span></span>
<span id="cb2-121"><a href="#cb2-121" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb2-122"><a href="#cb2-122" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span><span class="fu">c</span>(</span>
<span id="cb2-123"><a href="#cb2-123" aria-hidden="true" tabindex="-1"></a>      household_inc,</span>
<span id="cb2-124"><a href="#cb2-124" aria-hidden="true" tabindex="-1"></a>      hours_exercise)</span>
<span id="cb2-125"><a href="#cb2-125" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb2-126"><a href="#cb2-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">droplevels</span>() <span class="sc">|&gt;</span></span>
<span id="cb2-127"><a href="#cb2-127" aria-hidden="true" tabindex="-1"></a>  <span class="co"># dplyr::rename(sample_weights = w_gend_age_ethnic,</span></span>
<span id="cb2-128"><a href="#cb2-128" aria-hidden="true" tabindex="-1"></a>  <span class="co">#               sample_origin =  sample_origin_names_combined) |&gt;</span></span>
<span id="cb2-129"><a href="#cb2-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id, wave) <span class="sc">|&gt;</span></span>
<span id="cb2-130"><a href="#cb2-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-131"><a href="#cb2-131" aria-hidden="true" tabindex="-1"></a>    <span class="at">urban =</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(urban)),</span>
<span id="cb2-132"><a href="#cb2-132" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   parent = as.numeric(as.character(parent)),</span></span>
<span id="cb2-133"><a href="#cb2-133" aria-hidden="true" tabindex="-1"></a>    <span class="at">partner =</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(partner)),</span>
<span id="cb2-134"><a href="#cb2-134" aria-hidden="true" tabindex="-1"></a>    <span class="at">born_nz =</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(born_nz)),</span>
<span id="cb2-135"><a href="#cb2-135" aria-hidden="true" tabindex="-1"></a>    <span class="at">censored =</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(censored)),</span>
<span id="cb2-136"><a href="#cb2-136" aria-hidden="true" tabindex="-1"></a>    <span class="at">employed =</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(employed))</span>
<span id="cb2-137"><a href="#cb2-137" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb2-138"><a href="#cb2-138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">droplevels</span>() <span class="sc">|&gt;</span></span>
<span id="cb2-139"><a href="#cb2-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id, wave) <span class="sc">|&gt;</span></span>
<span id="cb2-140"><a href="#cb2-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>()</span>
<span id="cb2-141"><a href="#cb2-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-142"><a href="#cb2-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-143"><a href="#cb2-143" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect data</span></span>
<span id="cb2-144"><a href="#cb2-144" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(dat_long)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 42,990
Columns: 29
$ id                        &lt;fct&gt; 1, 1, 1, 3, 3, 3, 4, 4, 4, 5, 5, 5, 6, 6, 6,…
$ wave                      &lt;fct&gt; 2018, 2019, 2020, 2018, 2019, 2020, 2018, 20…
$ age                       &lt;dbl&gt; 40.31341, 41.33449, 42.24450, 47.14449, 47.9…
$ male                      &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ born_nz                   &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ eth_cat                   &lt;fct&gt; euro, euro, euro, maori, maori, maori, euro,…
$ employed                  &lt;dbl&gt; 1, 1, 1, 0, 1, NA, 0, 0, 0, 1, 1, 0, 0, 1, 1…
$ edu                       &lt;dbl&gt; 8, 8, 8, 3, 3, 3, 6, 6, 6, 6, 6, 6, 7, 7, 7,…
$ partner                   &lt;dbl&gt; 1, 1, 1, 1, 1, NA, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ parent                    &lt;dbl&gt; 1, 1, 1, 1, 1, NA, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ political_conservative    &lt;dbl&gt; 1.000000, 1.022343, 1.042282, 3.021098, 3.02…
$ agreeableness             &lt;dbl&gt; 6.235760, 6.216993, 6.539885, 4.997000, 4.54…
$ conscientiousness         &lt;dbl&gt; 5.781907, 6.004211, 4.719577, 5.281236, 4.73…
$ extraversion              &lt;dbl&gt; 4.740896, 4.737648, 4.724690, 2.752063, 3.23…
$ honesty_humility          &lt;dbl&gt; 5.954770, 3.970874, 4.988354, 2.249136, 2.75…
$ openness                  &lt;dbl&gt; 6.502722, 6.469405, 6.237941, 7.000000, 6.52…
$ neuroticism               &lt;dbl&gt; 2.543777, 3.049655, 2.960180, 2.455489, 2.24…
$ modesty                   &lt;dbl&gt; 6.786189, 6.002267, 5.702049, 5.239746, 4.74…
$ neighbourhood_community   &lt;dbl&gt; 6.951882, 6.005449, 5.986452, 4.994146, 3.97…
$ belong                    &lt;dbl&gt; 4.958810, 6.039168, 5.382137, 6.332741, 5.68…
$ support                   &lt;dbl&gt; 7.000000, 6.959343, 6.967418, 6.983696, 7.00…
$ perfectionism             &lt;dbl&gt; 4.303349, 3.670650, 3.337095, 2.660515, 3.33…
$ religion_religious        &lt;int&gt; 0, 0, 0, 0, 0, NA, 1, 1, 1, 0, 0, 0, 0, 0, 0…
$ kessler_latent_depression &lt;dbl&gt; 0.037011885, 0.000000000, 0.006337577, 0.000…
$ kessler_latent_anxiety    &lt;dbl&gt; 0.96853714, 0.98302076, 1.71493734, 1.029461…
$ censored                  &lt;dbl&gt; 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ urban                     &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ household_inc_log         &lt;dbl&gt; 12.206078, 12.206078, 11.849405, 11.532738, …
$ hours_exercise_log        &lt;dbl&gt; 0.41844130, 0.01955105, 0.00000000, 3.219609…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># more thorough view</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">#skimr::skim(dat_long)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next let’s insure that we obtain 50/50 representation of gender within our estimation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># balance on gender weights</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate gender weights assuming male is coded as 1 and female as 0</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>prop_male_population <span class="ot">&lt;-</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.5</span>  <span class="co"># target proportion of males in the population</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>prop_female_population <span class="ot">&lt;-</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.5</span>  <span class="co"># target proportion of females in the population</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>prop_male_sample <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat_long<span class="sc">$</span>male)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>prop_female_sample <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> prop_male_sample</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>gender_weight_male <span class="ot">&lt;-</span> prop_male_population <span class="sc">/</span> prop_male_sample</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>gender_weight_female <span class="ot">&lt;-</span> prop_female_population <span class="sc">/</span> prop_female_sample</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>dat_long<span class="sc">$</span>sample_weights <span class="ot">&lt;-</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ifelse</span>(dat_long<span class="sc">$</span>male <span class="sc">==</span> <span class="dv">1</span>, gender_weight_male, gender_weight_female)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co"># we will upweight males and down weight non-males to obtain a balance of gender in the *target* population</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(dat_long<span class="sc">$</span>sample_weights)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
0.783745351126667  1.38107170393216 
            27426             15564 </code></pre>
</div>
</div>
<p>Next let’s get our data into shape. Today we’re going to consider a ‘treatment’ of perfectionism in which we shift people by different quantiles of perfectionism:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>dat_long <span class="ot">&lt;-</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  margot<span class="sc">::</span><span class="fu">create_ordered_variable</span>(dat_long, <span class="st">"perfectionism"</span>, <span class="at">n_divisions =</span> <span class="dv">4</span>) <span class="co">#</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
=== Creating Ordered Variable ===
Note: ties.method set to last based on cutpoint_inclusive.

Variable Summary:
  Min value: 1 
  Max value: 7 
  Number of NA values: 2795 

Using quantile breaks:
  Number of divisions: 4 
  Breaks:


|    Break|
|--------:|
| 1.000000|
| 1.997943|
| 2.986456|
| 4.016010|
| 7.000000|

New Variable Summary:
  New column name: perfectionism_cat 
  Category distribution:


|Category  | Count|
|:---------|-----:|
|[1.0,2.0] | 10049|
|(2.0,3.0] | 10049|
|(3.0,4.0] | 10049|
|(4.0,7.0] | 10048|
|NA        |  2795|

Ordered variable created successfully 👍 
================================================================================</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># view scale</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># uncommentto see break points</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># print(quantile(dat_long$perfectionism, probs = seq(0, 1, 1/4), na.rm = TRUE))</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># n by groups</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(dat_long<span class="sc">$</span>perfectionism_cat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
[1.0,2.0] (2.0,3.0] (3.0,4.0] (4.0,7.0] 
    10049     10049     10049     10048 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain labels if useful later</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>labels <span class="ot">&lt;-</span> <span class="fu">levels</span>(dat_long<span class="sc">$</span>perfectionism_cat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="consider-where-the-quantiles-break" class="level3">
<h3 class="anchored" data-anchor-id="consider-where-the-quantiles-break">Consider where the quantiles break</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>dt_19 <span class="ot">&lt;-</span> dat_long <span class="sc">|&gt;</span> <span class="fu">filter</span>(wave <span class="sc">==</span> <span class="dv">2019</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>margot<span class="sc">::</span><span class="fu">margot_plot_categorical</span>(<span class="at">col_name =</span> <span class="st">"perfectionism"</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="co"># custom_breaks = c(1,1.9,3.9,7),</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">n_divisions =</span> <span class="dv">4</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">cutpoint_inclusive =</span> <span class="st">"upper"</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">binwidth =</span> .<span class="dv">5</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>                                     dt_19)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
=== Creating Ordered Variable ===
Note: ties.method set to last based on cutpoint_inclusive.

Variable Summary:
  Min value: 1 
  Max value: 7 
  Number of NA values: 0 

Using quantile breaks:
  Number of divisions: 4 
  Breaks:


|    Break|
|--------:|
| 1.000000|
| 1.996297|
| 2.985367|
| 4.017218|
| 7.000000|

New Variable Summary:
  New column name: perfectionism_cat 
  Category distribution:


|Category  | Count|
|:---------|-----:|
|[1.0,2.0] |  3583|
|(2.0,3.0] |  3582|
|(3.0,4.0] |  3583|
|(4.0,7.0] |  3582|

Ordered variable created successfully 👍 
================================================================================</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08-content_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="consider-mean" class="level3">
<h3 class="anchored" data-anchor-id="consider-mean">Consider mean</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>dt_19 <span class="ot">&lt;-</span> dat_long <span class="sc">|&gt;</span> <span class="fu">filter</span>(wave <span class="sc">==</span> <span class="dv">2019</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>margot<span class="sc">::</span><span class="fu">coloured_histogram_sd</span>(<span class="at">col_name =</span> <span class="st">"perfectionism"</span>, <span class="at">binwidth =</span> .<span class="dv">5</span>, dt_19)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08-content_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>margot<span class="sc">::</span><span class="fu">margot_plot_shift</span>(<span class="at">col_name =</span> <span class="st">"perfectionism"</span>, <span class="at">binwidth =</span> .<span class="dv">1</span>, </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">shift =</span> <span class="st">"down"</span>,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">range_highlight =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>),</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                                 dt_19)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08-content_files/figure-html/unnamed-chunk-6-2.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="set-variables" class="level3">
<h3 class="anchored" data-anchor-id="set-variables">Set variables</h3>
<p>Next lets set our baseline variables</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>baseline_vars <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"male"</span>, <span class="st">"edu"</span>, <span class="st">"eth_cat"</span>, <span class="st">"partner"</span>, <span class="st">"employed"</span>, <span class="st">"born_nz"</span>, <span class="st">"neighbourhood_community"</span>, <span class="st">"household_inc_log"</span>, <span class="st">"parent"</span>, <span class="st">"religion_religious"</span>, <span class="st">"urban"</span>, <span class="st">"employed"</span>, <span class="st">"sample_weights"</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co"># treatment</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>exposure_vars <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"perfectionism_cat"</span>) </span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co"># outcome, can be many</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>outcome_vars <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"kessler_latent_anxiety"</span>, <span class="st">"kessler_latent_depression"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="muliply-impute-missing-values" class="level3">
<h3 class="anchored" data-anchor-id="muliply-impute-missing-values">Muliply impute missing values</h3>
<p>In our first analysis we will not merely impute baseline values. Rather we will impute baseline and outcome values within quantiles of the exposure. Consider, why should we impute within the treatments to be compared? What are the lingering dangers of this approach?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make long data wide</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"># remove sample weights, return them later</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>prep_dat_wide <span class="ot">&lt;-</span> <span class="fu">margot_wide</span>(dat_long, </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>                             <span class="at">baseline_vars =</span> baseline_vars, </span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>                             <span class="at">exposure_var =</span> exposure_vars,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>                             <span class="at">outcome_vars =</span> outcome_vars)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co"># filter data, so that we impute within quartiles</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>list_filtered_df <span class="ot">&lt;-</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  margot<span class="sc">::</span><span class="fu">margot_filter</span>(prep_dat_wide, <span class="at">exposure_vars =</span> <span class="st">"t1_perfectionism_cat"</span>, <span class="at">sort_var =</span> <span class="st">"id"</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co"># check that these add up to the total data set</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">nrow</span>( list_filtered_df<span class="sc">$</span>tile_1)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">nrow</span>( list_filtered_df<span class="sc">$</span>tile_2)</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>c <span class="ot">&lt;-</span> <span class="fu">nrow</span>( list_filtered_df<span class="sc">$</span>tile_3)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span><span class="fu">nrow</span>( list_filtered_df<span class="sc">$</span>tile_4)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="co"># must sum to equal</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>a <span class="sc">+</span> b <span class="sc">+</span> c <span class="sc">+</span> d <span class="sc">==</span> <span class="fu">nrow</span>(prep_dat_wide)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>logical(0)</code></pre>
</div>
</div>
</section>
<section id="visualise-missing-values" class="level3">
<h3 class="anchored" data-anchor-id="visualise-missing-values">Visualise missing values</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># visually inspect missingness</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>naniar<span class="sc">::</span><span class="fu">vis_miss</span>(prep_dat_wide, <span class="at">warn_large_data =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="08-content_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check for collinear vars</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>mice<span class="sc">:::</span><span class="fu">find.collinear</span>(prep_dat_wide) <span class="co"># note sample weights is collinear</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "t0_sample_weights"</code></pre>
</div>
</div>
</section>
<section id="imputations" class="level3">
<h3 class="anchored" data-anchor-id="imputations">Imputations</h3>
<p>Next we impute by quartile. Save this output in your folder.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># impute by quartile</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>mice_health <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">impute_and_combine</span>(list_filtered_df,  <span class="at">m =</span> <span class="dv">5</span> )</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(mice_health, <span class="st">"mice_health"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="wrangling" class="level3">
<h3 class="anchored" data-anchor-id="wrangling">Wrangling</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read data if you are not running the imputation again</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>mice_health <span class="ot">&lt;-</span> <span class="fu">here_read</span>(<span class="st">"mice_health"</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># post-imputation arrange</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>mice_health_mids <span class="ot">&lt;-</span> mice_health <span class="sc">|&gt;</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(.imp, id) <span class="sc">|&gt;</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">sample_weights =</span> t0_sample_weights) <span class="sc">|&gt;</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">across</span>(</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">where</span>(is.numeric) <span class="sc">&amp;</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span>sample_weights,</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span> <span class="fu">scale</span>(.x),</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">.names =</span> <span class="st">"{col}_z"</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>.imp_z, <span class="sc">-</span>.id_z) <span class="sc">|&gt;</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">where</span>(is.factor),</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>         sample_weights,</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>         <span class="fu">ends_with</span>(<span class="st">"_z"</span>),</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>         .imp,</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>         .id) <span class="sc">|&gt;</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(sample_weights, <span class="at">.before =</span> <span class="fu">starts_with</span>(<span class="st">"t1_"</span>))  <span class="sc">|&gt;</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(id, <span class="at">.before =</span> sample_weights)  <span class="sc">|&gt;</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(<span class="fu">starts_with</span>(<span class="st">"t0_"</span>), <span class="at">.before =</span> <span class="fu">starts_with</span>(<span class="st">"t1_"</span>))  <span class="sc">|&gt;</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(<span class="fu">starts_with</span>(<span class="st">"t2_"</span>), <span class="at">.after =</span> <span class="fu">starts_with</span>(<span class="st">"t1_"</span>))  <span class="sc">|&gt;</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(.imp, id) <span class="sc">|&gt;</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">droplevels</span>() <span class="sc">|&gt;</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.matrix, as.vector) <span class="sc">|&gt;</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.mids</span>()</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a><span class="co"># make long</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>mice_health_long <span class="ot">&lt;-</span> mice<span class="sc">::</span><span class="fu">complete</span>(mice_health_mids, <span class="st">"long"</span>, <span class="at">inc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a><span class="co">#Save</span></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a><span class="fu">here_save</span>(mice_health_mids, <span class="st">"mice_health_mids"</span>)</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a><span class="fu">here_save</span>(mice_health_long, <span class="st">"mice_health_long"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="compute-propensity-scores-for-iptw-using-machine-learning" class="level3">
<h3 class="anchored" data-anchor-id="compute-propensity-scores-for-iptw-using-machine-learning">Compute propensity scores for IPTW using machine learning</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this is how you read saved files without the margot package</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>mice_health_mids <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(here<span class="sc">::</span><span class="fu">here</span>(push_mods, <span class="st">"mice_health_mids"</span>))</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>mice_health_long <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(here<span class="sc">::</span><span class="fu">here</span>(push_mods, <span class="st">"mice_health_long"</span>))</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co"># propensity scors --------------------------------------------------------</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co"># set exposure</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>X <span class="ot">=</span> <span class="st">"t1_perfectionism_cat"</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co"># set estimand</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>estimand <span class="ot">=</span> <span class="st">"ATE"</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="co"># set baseline variables</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>baseline_vars_models <span class="ot">=</span> mice_health_long <span class="sc">|&gt;</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"t0"</span>))<span class="sc">|&gt;</span> <span class="fu">colnames</span>() <span class="co"># note, we earlier change name of `t0_sample_weights` to `sample weights`</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>baseline_vars_models</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain propensity scores</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>match_ebal_ate <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">match_mi_general</span>(<span class="at">data =</span> mice_health_mids, </span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">X =</span> X, </span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">baseline_vars =</span> baseline_vars_models, </span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">estimand =</span> <span class="st">"ATE"</span>,  </span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>                                   <span class="co">#   focal = "tile_3", #for ATT</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">method =</span> <span class="st">"ebal"</span>, </span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">sample_weights =</span> <span class="st">"sample_weights"</span>)</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="co"># save output</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(match_ebal_ate, <span class="st">"match_ebal_ate"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read output</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>match_ebal_ate <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"match_ebal_ate"</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co"># check balance</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co">#bal.tab(match_ebal_ate)</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co"># visualise imbalance</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="fu">love.plot</span>(match_ebal_ate, <span class="at">binary =</span> <span class="st">"std"</span>, <span class="at">thresholds =</span> <span class="fu">c</span>(<span class="at">m =</span> .<span class="dv">1</span>),</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">wrap =</span> <span class="dv">50</span>, <span class="at">position =</span> <span class="st">"bottom"</span>, <span class="at">size =</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualise-imbalance" class="level3">
<h3 class="anchored" data-anchor-id="visualise-imbalance">Visualise imbalance</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># consider results </span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>sum_ebal_match_ebal_ate <span class="ot">&lt;-</span> <span class="fu">summary</span>(match_ebal_ate)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co"># summarise</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>sum_ebal_match_ebal_ate</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co"># visualise</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(sum_ebal_match_ebal_ate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Some extreme weights. We can trim weights as follows. (Note there is no hard and fast rule about how much to trim weights by, here we trim by 1%.)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># trimmed weights</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>match_ebal_ate_trim <span class="ot">&lt;-</span> WeightIt<span class="sc">::</span><span class="fu">trim</span>(match_ebal_ate, <span class="at">at =</span> .<span class="dv">99</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"># check balance</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co"># bal.tab(match_ebal_ate_trim)</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co"># summary</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>summary_match_ebal_ate_trim <span class="ot">&lt;-</span> <span class="fu">summary</span>(match_ebal_ate_trim)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="co"># check - extreme weights gone</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(summary_match_ebal_ate_trim)</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="co"># plot for balance</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="fu">love.plot</span>(match_ebal_ate_trim, <span class="at">binary =</span> <span class="st">"std"</span>, <span class="at">thresholds =</span> <span class="fu">c</span>(<span class="at">m =</span> .<span class="dv">1</span>),</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>          <span class="at">wrap =</span> <span class="dv">50</span>, <span class="at">position =</span> <span class="st">"bottom"</span>, <span class="at">size =</span><span class="dv">2</span>, <span class="at">limits =</span> <span class="fu">list</span>(<span class="at">m =</span> <span class="fu">c</span>(<span class="sc">-</span>.<span class="dv">5</span>, .<span class="dv">5</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="estimation" class="level3">
<h3 class="anchored" data-anchor-id="estimation">Estimation</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># here_save(match_ebal_ate_trim, "match_ebal_ate_trim")</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co"># match_ebal_ate_trim &lt;- here_read( "match_ebal_ate_trim")</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co"># set data frame; output of match_mi_general model</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>df_ate <span class="ot">=</span> match_ebal_ate_trim</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(df_ate)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(match_ebal_ate_trim)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="co"># remind self of levels if needed</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="co"># levels(mice_health_long$t1_perfectionism_4tile)</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="co"># set treatment level</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>treat_0 <span class="ot">=</span> <span class="st">"[1.0,2.0]"</span> <span class="co"># lowest quartile</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>treat_1 <span class="ot">=</span> <span class="st">"(4.0,7.0]"</span> <span class="co"># third quartile</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="co"># bootstrap simulations ( generally use 1000)</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>nsims <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="co"># cores</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">=</span>  parallel<span class="sc">::</span><span class="fu">detectCores</span> () </span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>estimand <span class="ot">=</span> <span class="st">"ATE"</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a><span class="co"># as specified</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>vcov <span class="ot">=</span> <span class="st">"HC2"</span> <span class="co"># robust standard errors. </span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a><span class="co"># cores</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>cores <span class="ot">=</span> parallel<span class="sc">::</span><span class="fu">detectCores</span> () <span class="co"># use all course</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Example call to the function</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a><span class="co"># propensity score only model</span></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a><span class="co"># code review: these are the functions 'under the hood'</span></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a><span class="co"># this function is defined outside of both main functions</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a><span class="co"># build_formula_str &lt;- function(Y, X, continuous_X, splines, baseline_vars) {</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a><span class="co">#   baseline_part &lt;- if (!(length(baseline_vars) == 1 &amp;&amp; baseline_vars == "1")) {</span></span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a><span class="co">#     paste(baseline_vars, collapse = "+")</span></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a><span class="co">#   } else {</span></span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a><span class="co">#     "1"</span></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a><span class="co">#   if (continuous_X &amp;&amp; splines) {</span></span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a><span class="co">#     paste(Y, "~ bs(", X, ")", "*", "(", baseline_part, ")")</span></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a><span class="co">#   } else {</span></span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a><span class="co">#     paste(Y, "~", X, "*", "(", baseline_part, ")")</span></span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a><span class="co"># causal_contrast_marginal &lt;- function(df, Y, X, baseline_vars = "1", treat_0, treat_1,</span></span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a><span class="co">#                                      estimand = c("ATE", "ATT"), type = c("RR", "RD"),</span></span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a><span class="co">#                                      nsims = 200, cores = parallel::detectCores(), family = "gaussian",</span></span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a><span class="co">#                                      weights = NULL, continuous_X = FALSE, splines = FALSE, vcov = "HC2",</span></span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a><span class="co">#                                      verbose = FALSE) {</span></span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a><span class="co">#   # validate the type argument</span></span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a><span class="co">#   type &lt;- match.arg(type, choices = c("RR", "RD"))</span></span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a><span class="co">#   # validate the family argument</span></span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a><span class="co">#   if (is.character(family)) {</span></span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (!family %in% c("gaussian", "binomial", "Gamma", "inverse.gaussian", "poisson", "quasibinomial", "quasipoisson", "quasi")) {</span></span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a><span class="co">#       stop("Invalid 'family' argument. Please specify a valid family function.")</span></span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a><span class="co">#     family_fun &lt;- get(family, mode = "function", envir = parent.frame())</span></span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a><span class="co">#   } else if (inherits(family, "family")) {</span></span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a><span class="co">#     family_fun &lt;- family</span></span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a><span class="co">#   } else {</span></span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a><span class="co">#     stop("Invalid 'family' argument. Please specify a valid family function or character string.")</span></span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a><span class="co">#   # use the updated causal_contrast_engine function</span></span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a><span class="co">#   results &lt;- causal_contrast_engine(</span></span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a><span class="co">#     df = df,</span></span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a><span class="co">#     Y = Y,</span></span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a><span class="co">#     X = X,</span></span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a><span class="co">#     baseline_vars = baseline_vars,</span></span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a><span class="co">#     treat_0 = treat_0,</span></span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a><span class="co">#     treat_1 = treat_1,</span></span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a><span class="co">#     estimand = estimand,</span></span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a><span class="co">#     type = type,</span></span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a><span class="co">#     nsims = nsims,</span></span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a><span class="co">#     cores = cores,</span></span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a><span class="co">#     family = family,</span></span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a><span class="co">#     weights = weights,</span></span>
<span id="cb28-83"><a href="#cb28-83" aria-hidden="true" tabindex="-1"></a><span class="co">#     continuous_X = continuous_X,</span></span>
<span id="cb28-84"><a href="#cb28-84" aria-hidden="true" tabindex="-1"></a><span class="co">#     splines = splines,</span></span>
<span id="cb28-85"><a href="#cb28-85" aria-hidden="true" tabindex="-1"></a><span class="co">#     vcov = vcov,</span></span>
<span id="cb28-86"><a href="#cb28-86" aria-hidden="true" tabindex="-1"></a><span class="co">#     verbose = verbose</span></span>
<span id="cb28-87"><a href="#cb28-87" aria-hidden="true" tabindex="-1"></a><span class="co">#   )</span></span>
<span id="cb28-88"><a href="#cb28-88" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-89"><a href="#cb28-89" aria-hidden="true" tabindex="-1"></a><span class="co">#   return(results)</span></span>
<span id="cb28-90"><a href="#cb28-90" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb28-91"><a href="#cb28-91" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-92"><a href="#cb28-92" aria-hidden="true" tabindex="-1"></a><span class="co"># causal_contrast_engine &lt;- function(df, Y, X, baseline_vars, treat_0, treat_1,</span></span>
<span id="cb28-93"><a href="#cb28-93" aria-hidden="true" tabindex="-1"></a><span class="co">#                                    estimand = c("ATE", "ATT"), type = c("RR", "RD"),</span></span>
<span id="cb28-94"><a href="#cb28-94" aria-hidden="true" tabindex="-1"></a><span class="co">#                                    nsims = 200, cores = parallel::detectCores(),</span></span>
<span id="cb28-95"><a href="#cb28-95" aria-hidden="true" tabindex="-1"></a><span class="co">#                                    family = "gaussian", weights = TRUE,</span></span>
<span id="cb28-96"><a href="#cb28-96" aria-hidden="true" tabindex="-1"></a><span class="co">#                                    continuous_X = FALSE, splines = FALSE,</span></span>
<span id="cb28-97"><a href="#cb28-97" aria-hidden="true" tabindex="-1"></a><span class="co">#                                    vcov = "HC2", verbose = FALSE) {</span></span>
<span id="cb28-98"><a href="#cb28-98" aria-hidden="true" tabindex="-1"></a><span class="co">#   # check if required packages are installed</span></span>
<span id="cb28-99"><a href="#cb28-99" aria-hidden="true" tabindex="-1"></a><span class="co">#   required_packages &lt;- c("clarify", "rlang", "glue", "parallel", "mice")</span></span>
<span id="cb28-100"><a href="#cb28-100" aria-hidden="true" tabindex="-1"></a><span class="co">#   for (pkg in required_packages) {</span></span>
<span id="cb28-101"><a href="#cb28-101" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (!requireNamespace(pkg, quietly = TRUE)) {</span></span>
<span id="cb28-102"><a href="#cb28-102" aria-hidden="true" tabindex="-1"></a><span class="co">#       stop(paste0("Package '", pkg, "' is needed for this function but is not installed"))</span></span>
<span id="cb28-103"><a href="#cb28-103" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb28-104"><a href="#cb28-104" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb28-105"><a href="#cb28-105" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-106"><a href="#cb28-106" aria-hidden="true" tabindex="-1"></a><span class="co">#   # helper function to process a single imputed dataset</span></span>
<span id="cb28-107"><a href="#cb28-107" aria-hidden="true" tabindex="-1"></a><span class="co">#   process_imputation &lt;- function(imputed_data, weights) {</span></span>
<span id="cb28-108"><a href="#cb28-108" aria-hidden="true" tabindex="-1"></a><span class="co">#     # build formula</span></span>
<span id="cb28-109"><a href="#cb28-109" aria-hidden="true" tabindex="-1"></a><span class="co">#     formula_str &lt;- build_formula_str(Y, X, continuous_X, splines, baseline_vars)</span></span>
<span id="cb28-110"><a href="#cb28-110" aria-hidden="true" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb28-111"><a href="#cb28-111" aria-hidden="true" tabindex="-1"></a><span class="co">#     # apply model</span></span>
<span id="cb28-112"><a href="#cb28-112" aria-hidden="true" tabindex="-1"></a><span class="co">#     fit &lt;- glm(</span></span>
<span id="cb28-113"><a href="#cb28-113" aria-hidden="true" tabindex="-1"></a><span class="co">#       as.formula(formula_str),</span></span>
<span id="cb28-114"><a href="#cb28-114" aria-hidden="true" tabindex="-1"></a><span class="co">#       weights = weights,</span></span>
<span id="cb28-115"><a href="#cb28-115" aria-hidden="true" tabindex="-1"></a><span class="co">#       family = get(family, mode = "function", envir = parent.frame()),</span></span>
<span id="cb28-116"><a href="#cb28-116" aria-hidden="true" tabindex="-1"></a><span class="co">#       data = imputed_data</span></span>
<span id="cb28-117"><a href="#cb28-117" aria-hidden="true" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb28-118"><a href="#cb28-118" aria-hidden="true" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb28-119"><a href="#cb28-119" aria-hidden="true" tabindex="-1"></a><span class="co">#     return(fit)</span></span>
<span id="cb28-120"><a href="#cb28-120" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb28-121"><a href="#cb28-121" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-122"><a href="#cb28-122" aria-hidden="true" tabindex="-1"></a><span class="co">#   # check if df is a wimids object</span></span>
<span id="cb28-123"><a href="#cb28-123" aria-hidden="true" tabindex="-1"></a><span class="co">#   if (inherits(df, "wimids")) {</span></span>
<span id="cb28-124"><a href="#cb28-124" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Extract the mids object and weights</span></span>
<span id="cb28-125"><a href="#cb28-125" aria-hidden="true" tabindex="-1"></a><span class="co">#     mids_obj &lt;- df$object</span></span>
<span id="cb28-126"><a href="#cb28-126" aria-hidden="true" tabindex="-1"></a><span class="co">#     weights_list &lt;- lapply(df$models, function(m) m$weights)</span></span>
<span id="cb28-127"><a href="#cb28-127" aria-hidden="true" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb28-128"><a href="#cb28-128" aria-hidden="true" tabindex="-1"></a><span class="co">#     # process each imputed dataset</span></span>
<span id="cb28-129"><a href="#cb28-129" aria-hidden="true" tabindex="-1"></a><span class="co">#     fits &lt;- lapply(1:mids_obj$m, function(i) {</span></span>
<span id="cb28-130"><a href="#cb28-130" aria-hidden="true" tabindex="-1"></a><span class="co">#       imputed_data &lt;- mice::complete(mids_obj, i)</span></span>
<span id="cb28-131"><a href="#cb28-131" aria-hidden="true" tabindex="-1"></a><span class="co">#       process_imputation(imputed_data, weights_list[[i]])</span></span>
<span id="cb28-132"><a href="#cb28-132" aria-hidden="true" tabindex="-1"></a><span class="co">#     })</span></span>
<span id="cb28-133"><a href="#cb28-133" aria-hidden="true" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb28-134"><a href="#cb28-134" aria-hidden="true" tabindex="-1"></a><span class="co">#     # create a misim object</span></span>
<span id="cb28-135"><a href="#cb28-135" aria-hidden="true" tabindex="-1"></a><span class="co">#     sim.imp &lt;- clarify::misim(fits, n = nsims, vcov = vcov)</span></span>
<span id="cb28-136"><a href="#cb28-136" aria-hidden="true" tabindex="-1"></a><span class="co">#   } else {</span></span>
<span id="cb28-137"><a href="#cb28-137" aria-hidden="true" tabindex="-1"></a><span class="co">#     # If df is not a wimids object, process it as before</span></span>
<span id="cb28-138"><a href="#cb28-138" aria-hidden="true" tabindex="-1"></a><span class="co">#     weight_var &lt;- if (!is.null(weights) &amp;&amp; weights %in% names(df)) df[[weights]] else NULL</span></span>
<span id="cb28-139"><a href="#cb28-139" aria-hidden="true" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb28-140"><a href="#cb28-140" aria-hidden="true" tabindex="-1"></a><span class="co">#     fit &lt;- process_imputation(df, weight_var)</span></span>
<span id="cb28-141"><a href="#cb28-141" aria-hidden="true" tabindex="-1"></a><span class="co">#     sim.imp &lt;- clarify::sim(fit, n = nsims, vcov = vcov)</span></span>
<span id="cb28-142"><a href="#cb28-142" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb28-143"><a href="#cb28-143" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-144"><a href="#cb28-144" aria-hidden="true" tabindex="-1"></a><span class="co">#   if (continuous_X) {</span></span>
<span id="cb28-145"><a href="#cb28-145" aria-hidden="true" tabindex="-1"></a><span class="co">#     estimand &lt;- "ATE"</span></span>
<span id="cb28-146"><a href="#cb28-146" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb28-147"><a href="#cb28-147" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-148"><a href="#cb28-148" aria-hidden="true" tabindex="-1"></a><span class="co">#   # compute the average marginal effects</span></span>
<span id="cb28-149"><a href="#cb28-149" aria-hidden="true" tabindex="-1"></a><span class="co">#   if (!continuous_X &amp;&amp; estimand == "ATT") {</span></span>
<span id="cb28-150"><a href="#cb28-150" aria-hidden="true" tabindex="-1"></a><span class="co">#     subset_expr &lt;- rlang::expr(!!rlang::sym(X) == !!treat_1)</span></span>
<span id="cb28-151"><a href="#cb28-151" aria-hidden="true" tabindex="-1"></a><span class="co">#     sim_estimand &lt;- clarify::sim_ame(</span></span>
<span id="cb28-152"><a href="#cb28-152" aria-hidden="true" tabindex="-1"></a><span class="co">#       sim.imp,</span></span>
<span id="cb28-153"><a href="#cb28-153" aria-hidden="true" tabindex="-1"></a><span class="co">#       var = X,</span></span>
<span id="cb28-154"><a href="#cb28-154" aria-hidden="true" tabindex="-1"></a><span class="co">#       subset = eval(subset_expr),</span></span>
<span id="cb28-155"><a href="#cb28-155" aria-hidden="true" tabindex="-1"></a><span class="co">#       cl = cores,</span></span>
<span id="cb28-156"><a href="#cb28-156" aria-hidden="true" tabindex="-1"></a><span class="co">#       verbose = FALSE</span></span>
<span id="cb28-157"><a href="#cb28-157" aria-hidden="true" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb28-158"><a href="#cb28-158" aria-hidden="true" tabindex="-1"></a><span class="co">#   } else {</span></span>
<span id="cb28-159"><a href="#cb28-159" aria-hidden="true" tabindex="-1"></a><span class="co">#     sim_estimand &lt;- clarify::sim_ame(sim.imp,</span></span>
<span id="cb28-160"><a href="#cb28-160" aria-hidden="true" tabindex="-1"></a><span class="co">#       var = X,</span></span>
<span id="cb28-161"><a href="#cb28-161" aria-hidden="true" tabindex="-1"></a><span class="co">#       cl = cores,</span></span>
<span id="cb28-162"><a href="#cb28-162" aria-hidden="true" tabindex="-1"></a><span class="co">#       verbose = FALSE</span></span>
<span id="cb28-163"><a href="#cb28-163" aria-hidden="true" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb28-164"><a href="#cb28-164" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-165"><a href="#cb28-165" aria-hidden="true" tabindex="-1"></a><span class="co">#     treat_0_name &lt;- paste0("`E[Y(", treat_0, ")]`")</span></span>
<span id="cb28-166"><a href="#cb28-166" aria-hidden="true" tabindex="-1"></a><span class="co">#     treat_1_name &lt;- paste0("`E[Y(", treat_1, ")]`")</span></span>
<span id="cb28-167"><a href="#cb28-167" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-168"><a href="#cb28-168" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (type == "RR") {</span></span>
<span id="cb28-169"><a href="#cb28-169" aria-hidden="true" tabindex="-1"></a><span class="co">#       rr_expression_str &lt;- glue::glue("{treat_1_name}/{treat_0_name}")</span></span>
<span id="cb28-170"><a href="#cb28-170" aria-hidden="true" tabindex="-1"></a><span class="co">#       rr_expression &lt;- rlang::parse_expr(rr_expression_str)</span></span>
<span id="cb28-171"><a href="#cb28-171" aria-hidden="true" tabindex="-1"></a><span class="co">#       sim_estimand &lt;- transform(sim_estimand, RR = eval(rr_expression))</span></span>
<span id="cb28-172"><a href="#cb28-172" aria-hidden="true" tabindex="-1"></a><span class="co">#       return(summary(sim_estimand))</span></span>
<span id="cb28-173"><a href="#cb28-173" aria-hidden="true" tabindex="-1"></a><span class="co">#     } else if (type == "RD") {</span></span>
<span id="cb28-174"><a href="#cb28-174" aria-hidden="true" tabindex="-1"></a><span class="co">#       rd_expression_str &lt;- glue::glue("{treat_1_name} - {treat_0_name}")</span></span>
<span id="cb28-175"><a href="#cb28-175" aria-hidden="true" tabindex="-1"></a><span class="co">#       rd_expression &lt;- rlang::parse_expr(rd_expression_str)</span></span>
<span id="cb28-176"><a href="#cb28-176" aria-hidden="true" tabindex="-1"></a><span class="co">#       sim_estimand &lt;- transform(sim_estimand, RD = eval(rd_expression))</span></span>
<span id="cb28-177"><a href="#cb28-177" aria-hidden="true" tabindex="-1"></a><span class="co">#       return(summary(sim_estimand))</span></span>
<span id="cb28-178"><a href="#cb28-178" aria-hidden="true" tabindex="-1"></a><span class="co">#     } else {</span></span>
<span id="cb28-179"><a href="#cb28-179" aria-hidden="true" tabindex="-1"></a><span class="co">#       stop("Invalid type. Please choose 'RR' or 'RD'")</span></span>
<span id="cb28-180"><a href="#cb28-180" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb28-181"><a href="#cb28-181" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb28-182"><a href="#cb28-182" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb28-183"><a href="#cb28-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-184"><a href="#cb28-184" aria-hidden="true" tabindex="-1"></a>propensity_mod_fit_t2_kessler_latent_anxiety_z <span class="ot">&lt;-</span><span class="fu">double_robust_marginal</span>(</span>
<span id="cb28-185"><a href="#cb28-185" aria-hidden="true" tabindex="-1"></a>  <span class="at">df =</span> df_ate,</span>
<span id="cb28-186"><a href="#cb28-186" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> <span class="st">"t2_kessler_latent_anxiety_z"</span>,</span>
<span id="cb28-187"><a href="#cb28-187" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X, </span>
<span id="cb28-188"><a href="#cb28-188" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline_vars =</span> <span class="dv">1</span>, <span class="co"># we are not regressing with any covariates</span></span>
<span id="cb28-189"><a href="#cb28-189" aria-hidden="true" tabindex="-1"></a>  <span class="at">treat_1 =</span> treat_1,</span>
<span id="cb28-190"><a href="#cb28-190" aria-hidden="true" tabindex="-1"></a>  <span class="at">treat_0 =</span> treat_0,</span>
<span id="cb28-191"><a href="#cb28-191" aria-hidden="true" tabindex="-1"></a>  <span class="at">nsims =</span> <span class="dv">1000</span>,</span>
<span id="cb28-192"><a href="#cb28-192" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> cores,</span>
<span id="cb28-193"><a href="#cb28-193" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb28-194"><a href="#cb28-194" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> <span class="cn">TRUE</span>,</span>
<span id="cb28-195"><a href="#cb28-195" aria-hidden="true" tabindex="-1"></a>  <span class="at">continuous_X =</span> <span class="cn">FALSE</span>,</span>
<span id="cb28-196"><a href="#cb28-196" aria-hidden="true" tabindex="-1"></a>  <span class="at">splines =</span> <span class="cn">FALSE</span>,</span>
<span id="cb28-197"><a href="#cb28-197" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATE"</span>,</span>
<span id="cb28-198"><a href="#cb28-198" aria-hidden="true" tabindex="-1"></a>  <span class="at">type_causal =</span> <span class="st">"RD"</span>,  </span>
<span id="cb28-199"><a href="#cb28-199" aria-hidden="true" tabindex="-1"></a>  <span class="at">type_tab =</span> <span class="st">"RD"</span>,    </span>
<span id="cb28-200"><a href="#cb28-200" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> vcov,         </span>
<span id="cb28-201"><a href="#cb28-201" aria-hidden="true" tabindex="-1"></a>  <span class="at">new_name =</span> <span class="st">"Kessler Anxiety (PR)"</span>,</span>
<span id="cb28-202"><a href="#cb28-202" aria-hidden="true" tabindex="-1"></a>  <span class="at">delta =</span> <span class="dv">1</span>,</span>
<span id="cb28-203"><a href="#cb28-203" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd =</span> <span class="dv">1</span></span>
<span id="cb28-204"><a href="#cb28-204" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-205"><a href="#cb28-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-206"><a href="#cb28-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-207"><a href="#cb28-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-208"><a href="#cb28-208" aria-hidden="true" tabindex="-1"></a><span class="co"># save</span></span>
<span id="cb28-209"><a href="#cb28-209" aria-hidden="true" tabindex="-1"></a><span class="fu">here_save</span>(propensity_mod_fit_t2_kessler_latent_anxiety_z, <span class="st">"propensity_mod_fit_t2_kessler_latent_anxiety_z"</span>)</span>
<span id="cb28-210"><a href="#cb28-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-211"><a href="#cb28-211" aria-hidden="true" tabindex="-1"></a>propensity_mod_fit_t2_kessler_latent_depression_z <span class="ot">&lt;-</span>margot<span class="sc">::</span><span class="fu">double_robust_marginal</span>(</span>
<span id="cb28-212"><a href="#cb28-212" aria-hidden="true" tabindex="-1"></a>  <span class="at">df =</span> df_ate,</span>
<span id="cb28-213"><a href="#cb28-213" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> <span class="st">"t2_kessler_latent_depression_z"</span>,</span>
<span id="cb28-214"><a href="#cb28-214" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X,  </span>
<span id="cb28-215"><a href="#cb28-215" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline_vars =</span> <span class="dv">1</span>, <span class="co">#no covariates, only the propensity scores</span></span>
<span id="cb28-216"><a href="#cb28-216" aria-hidden="true" tabindex="-1"></a>  <span class="at">treat_1 =</span> treat_1,</span>
<span id="cb28-217"><a href="#cb28-217" aria-hidden="true" tabindex="-1"></a>  <span class="at">treat_0 =</span> treat_0,</span>
<span id="cb28-218"><a href="#cb28-218" aria-hidden="true" tabindex="-1"></a>  <span class="at">nsims =</span> <span class="dv">1000</span>,</span>
<span id="cb28-219"><a href="#cb28-219" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> cores,</span>
<span id="cb28-220"><a href="#cb28-220" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb28-221"><a href="#cb28-221" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> <span class="cn">TRUE</span>,</span>
<span id="cb28-222"><a href="#cb28-222" aria-hidden="true" tabindex="-1"></a>  <span class="at">continuous_X =</span> <span class="cn">FALSE</span>,</span>
<span id="cb28-223"><a href="#cb28-223" aria-hidden="true" tabindex="-1"></a>  <span class="at">splines =</span> <span class="cn">FALSE</span>,</span>
<span id="cb28-224"><a href="#cb28-224" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATE"</span>,</span>
<span id="cb28-225"><a href="#cb28-225" aria-hidden="true" tabindex="-1"></a>  <span class="at">type_causal =</span> <span class="st">"RD"</span>,  </span>
<span id="cb28-226"><a href="#cb28-226" aria-hidden="true" tabindex="-1"></a>  <span class="at">type_tab =</span> <span class="st">"RD"</span>,    </span>
<span id="cb28-227"><a href="#cb28-227" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> vcov,         </span>
<span id="cb28-228"><a href="#cb28-228" aria-hidden="true" tabindex="-1"></a>  <span class="at">new_name =</span> <span class="st">"Kessler Depression (PR)"</span>,</span>
<span id="cb28-229"><a href="#cb28-229" aria-hidden="true" tabindex="-1"></a>  <span class="at">delta =</span> <span class="dv">1</span>,</span>
<span id="cb28-230"><a href="#cb28-230" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd =</span> <span class="dv">1</span></span>
<span id="cb28-231"><a href="#cb28-231" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-232"><a href="#cb28-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-233"><a href="#cb28-233" aria-hidden="true" tabindex="-1"></a><span class="co"># save</span></span>
<span id="cb28-234"><a href="#cb28-234" aria-hidden="true" tabindex="-1"></a><span class="fu">here_save</span>(propensity_mod_fit_t2_kessler_latent_depression_z, <span class="st">"propensity_mod_fit_t2_kessler_latent_depression_z"</span>)</span>
<span id="cb28-235"><a href="#cb28-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-236"><a href="#cb28-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-237"><a href="#cb28-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-238"><a href="#cb28-238" aria-hidden="true" tabindex="-1"></a><span class="do">## Doubly robust</span></span>
<span id="cb28-239"><a href="#cb28-239" aria-hidden="true" tabindex="-1"></a>mod_fit_t2_kessler_latent_anxiety_z <span class="ot">&lt;-</span>margot<span class="sc">::</span><span class="fu">double_robust_marginal</span>(</span>
<span id="cb28-240"><a href="#cb28-240" aria-hidden="true" tabindex="-1"></a>  <span class="at">df =</span> df_ate,</span>
<span id="cb28-241"><a href="#cb28-241" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> <span class="st">"t2_kessler_latent_anxiety_z"</span>,</span>
<span id="cb28-242"><a href="#cb28-242" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X,</span>
<span id="cb28-243"><a href="#cb28-243" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline_vars =</span> baseline_vars_models, <span class="co"># no covariates, only the propensity scores</span></span>
<span id="cb28-244"><a href="#cb28-244" aria-hidden="true" tabindex="-1"></a>  <span class="at">treat_1 =</span> treat_1,</span>
<span id="cb28-245"><a href="#cb28-245" aria-hidden="true" tabindex="-1"></a>  <span class="at">treat_0 =</span> treat_0,</span>
<span id="cb28-246"><a href="#cb28-246" aria-hidden="true" tabindex="-1"></a>  <span class="at">nsims =</span> <span class="dv">1000</span>,</span>
<span id="cb28-247"><a href="#cb28-247" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> cores,</span>
<span id="cb28-248"><a href="#cb28-248" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb28-249"><a href="#cb28-249" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> <span class="cn">TRUE</span>,</span>
<span id="cb28-250"><a href="#cb28-250" aria-hidden="true" tabindex="-1"></a>  <span class="at">continuous_X =</span> <span class="cn">FALSE</span>,</span>
<span id="cb28-251"><a href="#cb28-251" aria-hidden="true" tabindex="-1"></a>  <span class="at">splines =</span> <span class="cn">FALSE</span>,</span>
<span id="cb28-252"><a href="#cb28-252" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATE"</span>,</span>
<span id="cb28-253"><a href="#cb28-253" aria-hidden="true" tabindex="-1"></a>  <span class="at">type_causal =</span> <span class="st">"RD"</span>,  </span>
<span id="cb28-254"><a href="#cb28-254" aria-hidden="true" tabindex="-1"></a>  <span class="at">type_tab =</span> <span class="st">"RD"</span>,    </span>
<span id="cb28-255"><a href="#cb28-255" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> vcov,         </span>
<span id="cb28-256"><a href="#cb28-256" aria-hidden="true" tabindex="-1"></a>  <span class="at">new_name =</span> <span class="st">"Kessler Anxiety (DR)"</span>,</span>
<span id="cb28-257"><a href="#cb28-257" aria-hidden="true" tabindex="-1"></a>  <span class="at">delta =</span> <span class="dv">1</span>,</span>
<span id="cb28-258"><a href="#cb28-258" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd =</span> <span class="dv">1</span></span>
<span id="cb28-259"><a href="#cb28-259" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-260"><a href="#cb28-260" aria-hidden="true" tabindex="-1"></a><span class="co"># save</span></span>
<span id="cb28-261"><a href="#cb28-261" aria-hidden="true" tabindex="-1"></a><span class="fu">here_save</span>(mod_fit_t2_kessler_latent_anxiety_z, <span class="st">"mod_fit_t2_kessler_latent_anxiety_z"</span>)</span>
<span id="cb28-262"><a href="#cb28-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-263"><a href="#cb28-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-264"><a href="#cb28-264" aria-hidden="true" tabindex="-1"></a><span class="co"># model 2</span></span>
<span id="cb28-265"><a href="#cb28-265" aria-hidden="true" tabindex="-1"></a>mod_fit_t2_kessler_latent_depression_z <span class="ot">&lt;-</span>margot<span class="sc">::</span><span class="fu">double_robust_marginal</span>(</span>
<span id="cb28-266"><a href="#cb28-266" aria-hidden="true" tabindex="-1"></a>  <span class="at">df =</span> df_ate,</span>
<span id="cb28-267"><a href="#cb28-267" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> <span class="st">"t2_kessler_latent_depression_z"</span>,</span>
<span id="cb28-268"><a href="#cb28-268" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X,</span>
<span id="cb28-269"><a href="#cb28-269" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline_vars =</span> baseline_vars_models,</span>
<span id="cb28-270"><a href="#cb28-270" aria-hidden="true" tabindex="-1"></a>  <span class="at">treat_1 =</span> treat_1,</span>
<span id="cb28-271"><a href="#cb28-271" aria-hidden="true" tabindex="-1"></a>  <span class="at">treat_0 =</span> treat_0,</span>
<span id="cb28-272"><a href="#cb28-272" aria-hidden="true" tabindex="-1"></a>  <span class="at">nsims =</span> <span class="dv">1000</span>,</span>
<span id="cb28-273"><a href="#cb28-273" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> cores,</span>
<span id="cb28-274"><a href="#cb28-274" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb28-275"><a href="#cb28-275" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> <span class="cn">TRUE</span>,</span>
<span id="cb28-276"><a href="#cb28-276" aria-hidden="true" tabindex="-1"></a>  <span class="at">continuous_X =</span> <span class="cn">FALSE</span>,</span>
<span id="cb28-277"><a href="#cb28-277" aria-hidden="true" tabindex="-1"></a>  <span class="at">splines =</span> <span class="cn">FALSE</span>,</span>
<span id="cb28-278"><a href="#cb28-278" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATE"</span>,</span>
<span id="cb28-279"><a href="#cb28-279" aria-hidden="true" tabindex="-1"></a>  <span class="at">type_causal =</span> <span class="st">"RD"</span>,  </span>
<span id="cb28-280"><a href="#cb28-280" aria-hidden="true" tabindex="-1"></a>  <span class="at">type_tab =</span> <span class="st">"RD"</span>,    </span>
<span id="cb28-281"><a href="#cb28-281" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> vcov,         </span>
<span id="cb28-282"><a href="#cb28-282" aria-hidden="true" tabindex="-1"></a>  <span class="at">new_name =</span> <span class="st">"Kessler Depression (DR)"</span>,</span>
<span id="cb28-283"><a href="#cb28-283" aria-hidden="true" tabindex="-1"></a>  <span class="at">delta =</span> <span class="dv">1</span>,</span>
<span id="cb28-284"><a href="#cb28-284" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd =</span> <span class="dv">1</span></span>
<span id="cb28-285"><a href="#cb28-285" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-286"><a href="#cb28-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-287"><a href="#cb28-287" aria-hidden="true" tabindex="-1"></a><span class="co"># save</span></span>
<span id="cb28-288"><a href="#cb28-288" aria-hidden="true" tabindex="-1"></a><span class="fu">here_save</span>(mod_fit_t2_kessler_latent_depression_z, <span class="st">"mod_fit_t2_kessler_latent_depression_z"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="results" class="level3">
<h3 class="anchored" data-anchor-id="results">Results</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># to save time, we do not run the models</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co"># recover saved models </span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co"># propensity score  models</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>propensity_mod_fit_t2_kessler_latent_depression_z<span class="ot">&lt;-</span> <span class="fu">here_read</span>(<span class="st">"propensity_mod_fit_t2_kessler_latent_depression_z"</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>propensity_mod_fit_t2_kessler_latent_anxiety_z<span class="ot">&lt;-</span> <span class="fu">here_read</span>(<span class="st">"propensity_mod_fit_t2_kessler_latent_anxiety_z"</span>)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="co"># doubly robust models</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>mod_fit_t2_kessler_latent_depression_z<span class="ot">&lt;-</span> <span class="fu">here_read</span>(<span class="st">"mod_fit_t2_kessler_latent_depression_z"</span>)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>mod_fit_t2_kessler_latent_anxiety_z<span class="ot">&lt;-</span> <span class="fu">here_read</span>(<span class="st">"mod_fit_t2_kessler_latent_anxiety_z"</span>)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="co"># tables</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="co"># proprensity only </span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>tab_double_pr <span class="ot">&lt;-</span> <span class="fu">rbind</span>(propensity_mod_fit_t2_kessler_latent_depression_z<span class="sc">$</span>tab_results,</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>      propensity_mod_fit_t2_kessler_latent_anxiety_z<span class="sc">$</span>tab_results)</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="co"># bind results in a table</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>tab_double_robust <span class="ot">&lt;-</span> <span class="fu">rbind</span>(mod_fit_t2_kessler_latent_depression_z<span class="sc">$</span>tab_results,</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>      mod_fit_t2_kessler_latent_anxiety_z<span class="sc">$</span>tab_results)</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a><span class="co"># combine the individual results</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>tab_combo <span class="ot">&lt;-</span> <span class="fu">rbind</span>(tab_double_pr,tab_double_robust)</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a><span class="co"># table</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>tab_combo <span class="sc">|&gt;</span> </span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">format =</span> <span class="st">"markdown"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We see that the doubly robust estimator leads to lower overall effect sizes.</p>
<!-- ## Sugroup Estimation Using Machine Learning -->
<!-- ### impute baseline values only -->
<!-- ```{r} -->
<!-- #| eval: false -->
<!-- #| echo: true -->
<!-- #| label: impute_subgroup_baseline -->
<!-- # let's take a different approach -->
<!-- # this time we include the censored variable  -->
<!-- exposure_vars <- c("perfectionism_cat", "censored") -->
<!-- baseline_vars<-setdiff(baseline_vars, "sample_weights") -->
<!-- # here we imput the baseline  -->
<!-- df_impute_base<- margot_wide_impute_baseline(dat_long, baseline_vars = baseline_vars,  -->
<!--                                              exposure_var = exposure_vars, outcome_vars = outcome_vars) -->
<!-- # save -->
<!-- # get sample weights -->
<!-- dt_18 <- dat_long |> filter(wave == 2018) -->
<!-- # add sample weights -->
<!-- df_impute_base$t0_sample_weights = dt_18$sample_weights -->
<!-- # save -->
<!-- here_save(df_impute_base, "df_impute_base") -->
<!-- ``` -->
<!-- ### Obtain censoring weights -->
<!-- ```{r} -->
<!-- #| eval: false -->
<!-- #| echo: true -->
<!-- df_impute_base <- here_read("df_impute_base") -->
<!-- #  -->
<!-- # # is.factor(df_impute_base$t0_perfectionism_cat) -->
<!-- # # get correct censoring  -->
<!-- # t0_na_condition <- -->
<!-- #   rowSums(is.na(select(df_impute_base, starts_with("t1_")))) > 0 -->
<!-- # t1_na_condition <- -->
<!-- #   rowSums(is.na(select(df_impute_base, starts_with("t2_")))) > 0 -->
<!-- #  -->
<!-- # str(df_impute_base$t1_perfectionism_cat) -->
<!-- #  -->
<!-- #  -->
<!-- #  -->
<!-- # # Revised data cleaning code -->
<!-- # df_clean <- df_impute_base |> -->
<!-- #   mutate(t0_censored = ifelse(t0_na_condition, 0, t0_censored)) |> -->
<!-- #   mutate(t1_censored = ifelse(t1_na_condition, 0, t1_censored)) |> -->
<!-- #   mutate(across(starts_with("t1_"), ~ ifelse(t0_censored == 0, NA, .)), -->
<!-- #          across(starts_with("t2_"), ~ ifelse(t0_censored == 0, NA, .))) |> -->
<!-- #   mutate(across(starts_with("t2_"), ~ ifelse(t1_censored == 0, NA, .))) |> -->
<!-- #   # Scale numeric variables, excluding t1_perfectionism_cat -->
<!-- #   mutate(across(where(is.numeric) &  -->
<!-- #                 !any_of(c("t0_censored", "t0_sample_weights", "t1_censored", "t1_perfectionism_cat")),  -->
<!-- #                 ~ scale(.),  -->
<!-- #                 .names = "{.col}_z")) |> -->
<!-- #   # Ensure t1_perfectionism_cat remains a factor -->
<!-- #   mutate(t1_perfectionism_cat = factor(t1_perfectionism_cat,  -->
<!-- #                                        levels = levels(df_impute_base$t1_perfectionism_cat), -->
<!-- #                                        ordered = TRUE)) |> -->
<!-- #   select( -->
<!-- #     where(is.factor), -->
<!-- #     t0_sample_weights, -->
<!-- #     t0_censored, -->
<!-- #     t1_perfectionism_cat, -->
<!-- #     t1_censored, -->
<!-- #     ends_with("_z") -->
<!-- #   ) |> -->
<!-- #   mutate(t0_lost = 1 - t1_censored, -->
<!-- #          t1_lost = 1 - t1_censored) |>  -->
<!-- #   relocate(starts_with("t0_"), .before = starts_with("t1_")) |> -->
<!-- #   relocate("t0_censored", .before = starts_with("t1_")) |> -->
<!-- #   relocate("t1_censored", .before = starts_with("t2_")) -->
<!-- #  -->
<!-- # # Check the result -->
<!-- # print(str(df_clean$t1_perfectionism_cat)) -->
<!-- # print(levels(df_clean$t1_perfectionism_cat)) -->
<!-- # str(df_clean$t1_perfectionism_cat) -->
<!-- # Get correct not_censored conditions -->
<!-- t0_na_condition <- rowSums(is.na(select(df_impute_base, starts_with("t1_")))) > 0 -->
<!-- t1_na_condition <- rowSums(is.na(select(df_impute_base, starts_with("t2_")))) > 0 -->
<!-- # Revised data cleaning code -->
<!-- df_clean <- df_impute_base |> -->
<!--   mutate(t0_not_censored = ifelse(t0_na_condition, 0, 1), -->
<!--          t1_not_censored = ifelse(t1_na_condition, 0, 1)) -->
<!-- print("t0_not_censored and t1_not_censored after initial mutation:") -->
<!-- print(table(df_clean$t0_not_censored, df_clean$t1_not_censored)) -->
<!-- df_clean <- df_clean |> -->
<!--   # Apply NA conditions while preserving factor structure -->
<!--   mutate(across(starts_with("t1_") & !all_of("t1_perfectionism_cat"),  -->
<!--                 ~ ifelse(t0_not_censored == 0, NA, .))) |> -->
<!--   mutate(across(starts_with("t2_"),  -->
<!--                 ~ ifelse(t1_not_censored == 0, NA, .))) |> -->
<!--   # Scale numeric variables, excluding t1_perfectionism_cat -->
<!--   mutate(across(where(is.numeric) &  -->
<!--                 !any_of(c("t0_not_censored", "t0_sample_weights", "t1_not_censored", "t1_perfectionism_cat")),  -->
<!--                 ~ scale(.),  -->
<!--                 .names = "{.col}_z")) |> -->
<!--   # Ensure t1_perfectionism_cat remains a factor and apply t1_not_censored condition -->
<!--   mutate(t1_perfectionism_cat = factor(t1_perfectionism_cat,  -->
<!--                                        levels = levels(df_impute_base$t1_perfectionism_cat), -->
<!--                                        ordered = TRUE), -->
<!--          t1_perfectionism_cat = if_else(t1_not_censored == 0, NA_character_, as.character(t1_perfectionism_cat)), -->
<!--          t1_perfectionism_cat = factor(t1_perfectionism_cat,  -->
<!--                                        levels = levels(df_impute_base$t1_perfectionism_cat), -->
<!--                                        ordered = TRUE)) -->
<!-- print("t1_perfectionism_cat after applying conditions:") -->
<!-- print(table(df_clean$t1_perfectionism_cat, useNA = "ifany")) -->
<!-- df_clean <- df_clean |> -->
<!--   select( -->
<!--     where(is.factor), -->
<!--     t0_sample_weights, -->
<!--     t0_not_censored, -->
<!--     t1_perfectionism_cat, -->
<!--     t1_not_censored, -->
<!--     ends_with("_z") -->
<!--   ) |> -->
<!--   mutate(t0_lost = 1 - t1_not_censored, -->
<!--          t1_lost = 1 - t1_not_censored) |>  -->
<!--   relocate(starts_with("t0_"), .before = starts_with("t1_")) |> -->
<!--   relocate("t0_not_censored", .before = starts_with("t1_")) |> -->
<!--   relocate("t1_not_censored", .before = starts_with("t2_")) -->
<!-- # final checks -->
<!-- print("Final t0_not_censored and t1_not_censored:") -->
<!-- print(table(df_clean$t0_not_censored, df_clean$t1_not_censored)) -->
<!-- print("Final t1_perfectionism_cat:") -->
<!-- print(table(df_clean$t1_perfectionism_cat, useNA = "ifany")) -->
<!-- print("Relationship between t1_not_censored and t1_perfectionism_cat:") -->
<!-- print(table(df_clean$t1_not_censored, is.na(df_clean$t1_perfectionism_cat))) -->
<!-- # get rid of attributes -->
<!-- df_clean <- margot::remove_numeric_attributes(df_clean) -->
<!-- # censoring --------------------------------------------------------------- -->
<!-- baseline_vars_models_ml = df_clean |>  # post process of impute and combine -->
<!--   dplyr::select(starts_with("t0"), -t0_not_censored, -t0_lost, -t0_sample_weights)|> colnames() # note, we ear -->
<!-- baseline_vars_models_ml -->
<!-- # fit proponsity score model  -->
<!-- # match_censoring <- margot::match_mi_general(data = df_clean,  -->
<!-- #                                       X = "t1_lost",  -->
<!-- #                                       baseline_vars = baseline_vars_models,  -->
<!-- #                                       estimand = "ATE",   -->
<!-- #                                       # focal = "< >", for ATT -->
<!-- #                                       method = "cbps",  -->
<!-- #                                       sample_weights = "sample_weights") -->
<!-- #  -->
<!-- # # save output -->
<!-- # here_save( match_censoring, "match_censoring")  # another approach -->
<!-- df_clean_pre <- df_clean[baseline_vars_models_ml] -->
<!-- # colnames(df_clean_pre) -->
<!-- # Perform one-hot encoding using model.matrix -->
<!-- encoded_vars <- model.matrix(~  t0_perfectionism_cat + t0_eth_cat - 1, data = df_clean_pre) -->
<!-- # convert matrix to data frame -->
<!-- encoded_df <- as.data.frame(encoded_vars) -->
<!-- # make better names (if needed) -->
<!-- encoded_df <- encoded_df |> -->
<!--   janitor::clean_names() -->
<!-- # View the first few rows to confirm structure -->
<!-- head(encoded_df) -->
<!-- # bind the new one-hot encoded variables back to the original dataframe -->
<!-- # ensure to remove original categorical variables to avoid duplication -->
<!-- df_clean_hot <- df_clean |> -->
<!--   select(-c(t0_eth_cat,t0_perfectionism_cat)) |> -->
<!--   bind_cols(encoded_df) -->
<!-- # extract and print the new column names for encoded variables -->
<!-- new_encoded_colnames <- colnames(encoded_df) -->
<!-- print(new_encoded_colnames) -->
<!-- new_encoded_colnames -->
<!-- colnames(df_clean_pre) -->
<!-- # assuming you have a base list of predictors -->
<!-- baseline_vars_set <- setdiff(names(df_clean_pre), c("t0_lost", "t0_eth_cat", "t0_perfectionism_cat")) -->
<!-- baseline_vars_set -->
<!-- # Add the new encoded column names -->
<!-- full_predictor_vars <- c(baseline_vars_set, new_encoded_colnames) -->
<!-- # check -->
<!-- full_predictor_vars -->
<!-- # cross validated sets -->
<!-- cv_control <- list(V = 10, stratifyCV = TRUE)  # 10-fold CV with stratification -->
<!-- # use super learner -->
<!-- library(SuperLearner) -->
<!-- library(ranger) -->
<!-- # Multi core -->
<!-- library(doParallel) -->
<!-- library(SuperLearner) -->
<!-- # check predictors -->
<!-- str(df_clean_hot[full_predictor_vars]) -->
<!-- # make library e.g. simple library -->
<!-- # list learners -->
<!-- listWrappers() -->
<!-- match_lib = c("SL.glmnet", "SL.ranger") -->
<!-- # Set up parallel backend -->
<!-- no_cores <- detectCores() -->
<!-- cl <- makeCluster(no_cores - 1) -->
<!-- # start parrallel -->
<!-- registerDoParallel(cl) -->
<!-- # propensity scores for censoring -->
<!-- sl <- SuperLearner( -->
<!--   Y = df_clean_hot$t1_lost,  -->
<!--   X = df_clean_hot[full_predictor_vars],  # Use all specified predictors -->
<!--   SL.library = match_lib, -->
<!--   family = binomial(),  -->
<!--   method = "method.NNloglik",  -->
<!--   cvControl = list(V = 10) -->
<!-- ) -->
<!-- # save your model -->
<!-- here_save(sl, "sl") -->
<!-- # stop your cluster -->
<!-- stopCluster(cl) -->
<!-- # checks  -->
<!-- print(sl)                  # prints the summary of the SuperLearner output -->
<!-- summary(sl)                # provides a detailed summary, including cross-validated risks -->
<!-- # detailed examination of cross-validated performance -->
<!-- sl$cvRisk                  # cross-validated risks for each learner -->
<!-- sl$coef                    # weights assigned to each learner in the final ensemble -->
<!-- # generate predictions from the model -->
<!-- predictions <- predict(sl, newdata = df_clean_hot[full_predictor_vars], type = "response") -->
<!-- # extract predictions from the 'pred' component and ensure it's a vector -->
<!-- df_clean_hot$pscore <- predictions$pred[, 1] -->
<!-- # Check the structure of the predictions -->
<!-- str(predictions) -->
<!-- df_clean$cens_weights <- ifelse(df_clean_hot$t0_lost == 1, 1 / df_clean_hot$pscore, 1 / (1 - df_clean_hot$pscore)) -->
<!-- # check  -->
<!-- hist(df_clean$cens_weights) -->
<!-- mean(df_clean$cens_weights) -->
<!-- max(df_clean$cens_weights) -->
<!-- min(df_clean$cens_weights) -->
<!-- ### Stabalise weights -->
<!-- marginal_censored<- mean(df_clean$t0_lost) -->
<!-- # stabalised weights -->
<!-- df_clean$weights_stabilised <- ifelse(df_clean_hot$t0_lost == 1, -->
<!--                                   marginal_censored / df_clean_hot$pscore, -->
<!--                                   (1 - marginal_censored) / (1 - df_clean_hot$pscore)) -->
<!-- hist(df_clean$weights_stabilised ) -->
<!-- min(df_clean$weights_stabilised ) -->
<!-- max(df_clean$weights_stabilised ) -->
<!-- # new weights -->
<!-- df_clean$t0_combo_weights = df_clean$weights_stabilised * df_clean$t0_sample_weights -->
<!-- min( df_clean$t0_combo_weights) -->
<!-- max( df_clean$t0_combo_weights) -->
<!-- hist( df_clean$t0_combo_weights) -->
<!-- here_save(df_clean, "df_clean") -->
<!-- # save the censored sample  -->
<!-- df_clean_t2 <- df_clean |> -->
<!--   filter(!is.na(t1_lost)) |>  -->
<!--  select(-cens_weights, -marginal_censored) |>  -->
<!--   select(-all_of(c("t0_lost", "t1_lost"))) |>  -->
<!--   relocate(starts_with("t0_"), .before = starts_with("t1_")) |> -->
<!--   relocate("t0_censored", .before = starts_with("t1_"))  |> -->
<!--   relocate("t1_censored", .before = starts_with("t2_")) |>  -->
<!--   relocate("weights_stabilised", .before = starts_with("t0_")) -->
<!-- colnames(df_clean_t2) -->
<!-- here_save(df_clean_t2, "df_clean_t2") -->
<!-- # Diagnostic steps -->
<!-- print("Original data:") -->
<!-- print(str(df_impute_base$t1_perfectionism_cat)) -->
<!-- print(table(df_impute_base$t1_perfectionism_cat, useNA = "ifany")) -->
<!-- # Revised data cleaning code -->
<!-- df_clean <- df_impute_base |> -->
<!--   mutate(t0_censored = ifelse(t0_na_condition, 0, t0_censored)) |> -->
<!--   mutate(t1_censored = ifelse(t1_na_condition, 0, t1_censored)) |> -->
<!--   # Remove the lines that might be introducing NAs -->
<!--   # mutate(across(starts_with("t1_"), ~ ifelse(t0_censored == 0, NA, .)), -->
<!--   #        across(starts_with("t2_"), ~ ifelse(t0_censored == 0, NA, .))) |> -->
<!--   # mutate(across(starts_with("t2_"), ~ ifelse(t1_censored == 0, NA, .))) |> -->
<!--   # Scale numeric variables, excluding t1_perfectionism_cat -->
<!--   mutate(across(where(is.numeric) &  -->
<!--                 !any_of(c("t0_censored", "t0_sample_weights", "t1_censored", "t1_perfectionism_cat")),  -->
<!--                 ~ scale(.),  -->
<!--                 .names = "{.col}_z")) |> -->
<!--   # Ensure t1_perfectionism_cat remains a factor -->
<!--   mutate(t1_perfectionism_cat = factor(t1_perfectionism_cat,  -->
<!--                                        levels = levels(df_impute_base$t1_perfectionism_cat), -->
<!--                                        ordered = TRUE)) |> -->
<!--   select( -->
<!--     where(is.factor), -->
<!--     t0_sample_weights, -->
<!--     t0_censored, -->
<!--     t1_perfectionism_cat, -->
<!--     t1_censored, -->
<!--     ends_with("_z") -->
<!--   ) |> -->
<!--   mutate(t0_lost = 1 - t1_censored, -->
<!--          t1_lost = 1 - t1_censored) |>  -->
<!--   relocate(starts_with("t0_"), .before = starts_with("t1_")) |> -->
<!--   relocate("t0_censored", .before = starts_with("t1_")) |> -->
<!--   relocate("t1_censored", .before = starts_with("t2_")) -->
<!-- # Check the result -->
<!-- print("Cleaned data:") -->
<!-- print(str(df_clean$t1_perfectionism_cat)) -->
<!-- print(table(df_clean$t1_perfectionism_cat, useNA = "ifany")) -->
<!-- print(levels(df_clean$t1_perfectionism_cat)) -->
<!-- # If NAs are still present, investigate which rows have NAs -->
<!-- if(any(is.na(df_clean$t1_perfectionism_cat))) { -->
<!--   print("Rows with NAs in t1_perfectionism_cat:") -->
<!--   print(df_clean[is.na(df_clean$t1_perfectionism_cat),  -->
<!--                  c("t0_censored", "t1_censored", "t1_perfectionism_cat")]) -->
<!-- } -->
<!-- ``` -->
<!-- ### Matching in subgroups -->
<!-- ### Subgroup analysis  -->
<!-- ```{r} -->
<!-- #| label: subgroup_weights -->
<!-- #| eval: false -->
<!-- #| echo: true -->
<!-- hist(df_clean_filtered$sample_weights) -->
<!-- # next propensity scores by groups  -->
<!-- levels(df_clean_t2$t0_eth_cat) -->
<!-- levels(df_clean_t2$t1_perfectionism_4tile) -->
<!-- #  -->
<!-- df_subgroup <-df_clean_t2 |> filter(t0_eth_cat == "maori" | t0_eth_cat == "euro") |> droplevels() -->
<!-- # save -->
<!-- here_save(df_subgroup, "df_subgroup") -->
<!-- # check -->
<!-- table(df_subgroup$t0_eth_cat) -->
<!-- baseline_vars_models_sans_eth <- setdiff(baseline_vars_models, "t0_eth_cat") -->
<!-- # save -->
<!-- here_save(baseline_vars_models_sans_eth, "baseline_vars_models_sans_eth") -->
<!-- ##  -->
<!-- string <- formula_str <- as.formula(paste("t1_perfectionism_4tile", "~", paste(baseline_vars_models, collapse = "+"))) -->
<!-- string_sans <- formula_str <- as.formula(paste("t1_perfectionism_4tile", "~", paste(baseline_vars_models_sans_eth, collapse = "+"))) -->
<!-- W1 <- weightit( -->
<!--   string, -->
<!--   method = "ipt", -->
<!--   estimand = "ATT", -->
<!--   weights = "weights_stabilised", -->
<!--   focal = "tile_3", -->
<!--   # super = TRUE, -->
<!--   #SL.library = c("SL.ranger", "SL.glmnet", "SL.polymars", "SL.xgboost"), -->
<!--   #super = TRUE, -->
<!--   data = df_subgroup -->
<!-- ) -->
<!-- summary(W1) -->
<!-- # save model -->
<!-- here_save(W1, "W1") -->
<!-- W2 <- weightit( -->
<!--   string_sans, -->
<!--   method = "ipt", -->
<!--   estimand = "ATT", -->
<!--   weights = "sample_weights", -->
<!--   by = "t0_eth_cat", -->
<!--   weights = "sample_weights", -->
<!--   focal = "tile_3", -->
<!-- #  super = TRUE, -->
<!-- #  SL.library = c("SL.ranger", "SL.glmnet", "SL.polymars", "SL.xgboost"), -->
<!--   data = df_subgroup -->
<!-- ) -->
<!-- summary(W2) -->
<!-- # save model -->
<!-- here_save(W2, "W2") -->
<!-- # test diff -->
<!-- #S <- sbps(W1, W2) -->
<!-- # warnings() -->
<!-- # S -->
<!-- ``` -->
<!-- ### Evaluate subgroup weighting model -->
<!-- ```{r} -->
<!-- #| fig-width: 12 -->
<!-- #| fig-height: 12 -->
<!-- W1 <- here_read("W1") -->
<!-- W2 <- here_read("W2") -->
<!-- # read -->
<!-- df_subgroup <- margot::here_read("df_subgroup") -->
<!-- # this method has better effective samples -->
<!-- #bal.tab(W1) -->
<!-- # this method has better balance -->
<!-- # bal.tab(W2, cluster = "t0_eth_cat") -->
<!-- # bal.tab(W1, cluster = "t0_eth_cat") -->
<!-- # graph by cluster -->
<!-- # W2 obtains better balance -->
<!-- love.plot(W1,  cluster = "t0_eth_cat", binary = "std", thresholds = c(m = .1), -->
<!--           wrap = 50, position = "bottom", size =2) -->
<!-- love.plot(W2,  cluster = "t0_eth_cat", binary = "std", thresholds = c(m = .1), -->
<!--           wrap = 50, position = "bottom", size =2) -->
<!-- # check marginal too -->
<!-- love.plot(W2,   binary = "std", thresholds = c(m = .1), -->
<!--           wrap = 50, position = "bottom", size =2) -->
<!-- ``` -->
<!-- ### Parametric estimation of subgroup model -->
<!-- ```{r} -->
<!-- # prepare data -->
<!-- # read vars -->
<!-- baseline_vars_models_sans_eth <- margot::here_read("baseline_vars_models_sans_eth") -->
<!-- # make combo weights -->
<!-- df_subgroup$combo_weights = W2$weights * df_subgroup$t0_combo_weights -->
<!-- # set dataframe -->
<!-- df = df_subgroup -->
<!-- ### SUBGROUP analysis -->
<!-- Y_anxiety = "t2_kessler_latent_anxiety_z" -->
<!-- Y_depression = "t2_kessler_latent_depression_z" -->
<!-- X = "t1_perfectionism_4tile" -->
<!-- treat_0 = "tile_1" -->
<!-- treat_1 = "tile_3" -->
<!-- estimand = "ATT" -->
<!-- scale = "RD" -->
<!-- nsims = 1000 -->
<!-- family = "gaussian" -->
<!-- continuous_X = FALSE -->
<!-- splines = FALSE -->
<!-- cores = parallel::detectCores() -->
<!-- S = "t0_eth_cat" -->
<!-- # not we interact the subclass X treatment X covariates -->
<!-- formula_str_anxiety <- -->
<!--   paste( -->
<!--     Y_anxiety, -->
<!--     "~", -->
<!--     S, -->
<!--     "*", -->
<!--     "(", -->
<!--     X , -->
<!--     "*", -->
<!--     "(", -->
<!--     paste(baseline_vars_models_sans_eth, collapse = "+"), -->
<!--     ")", -->
<!--     ")" -->
<!--   ) -->
<!-- formula_str_depression <- -->
<!--   paste( -->
<!--     Y_depression, -->
<!--     "~", -->
<!--     S, -->
<!--     "*", -->
<!--     "(", -->
<!--     X , -->
<!--     "*", -->
<!--     "(", -->
<!--     paste(baseline_vars_models_sans_eth, collapse = "+"), -->
<!--     ")", -->
<!--     ")" -->
<!--   ) -->
<!-- formula_str_anxiety -->
<!-- formula_str_depression -->
<!-- # fit model -->
<!-- fit_all_all_anxiety  <- glm( -->
<!--   as.formula(formula_str_anxiety), -->
<!--   weights = combo_weights, -->
<!--   # weights = if (!is.null(weight_var)) weight_var else NULL, -->
<!--   family = family, -->
<!--   data = df -->
<!-- ) -->
<!-- #summary(fit_all_all_anxiety) -->
<!-- fit_all_all_depression  <- glm( -->
<!--   as.formula(formula_str_depression), -->
<!--   weights = combo_weights, -->
<!--   # weights = if (!is.null(weight_var)) weight_var else NULL, -->
<!--   family = family, -->
<!--   data = df -->
<!-- ) -->
<!-- # coefs <- coef(fit_all_all_anxiety) -->
<!-- # table(is.na(coefs))#     t0_eth_catmāori:t1_perfectionism_coarsen.Q:t0_gen_cohort.C -->
<!-- # #FALSE  TRUE -->
<!-- # 344     4 -->
<!-- #  -->
<!-- # insight::get_varcov(fit_all_all_anxiety) -->
<!-- ``` -->
<!-- ### Subgroup Results  -->
<!-- ```{r} -->
<!-- #| label: sim_subgroup -->
<!-- #| eval: false -->
<!-- #| echo: true -->
<!-- # simulate coefficients -->
<!-- sim_model_all <- sim(fit_all_all_anxiety, n = nsims, vcov = "HC2") -->
<!-- # simulate effect as modified in europeans -->
<!-- sim_estimand_all <- sim_ame( -->
<!--   sim_model_all, -->
<!--   var = X, -->
<!--   cl = cores, -->
<!--   by = "t0_eth_cat", -->
<!--   verbose = FALSE -->
<!-- ) -->
<!-- # summary(sim_estimand_all) -->
<!-- # make table -->
<!-- sim_estimand_all_tab <- -->
<!--   transform(sim_estimand_all, RD_euro = `E[Y(tile_3)|euro]` - `E[Y(tile_1)|euro]`, -->
<!--             RD_maori =  `E[Y(tile_3)|maori]` - `E[Y(tile_1)|maori]`, -->
<!--             gamma_hat = (`E[Y(tile_3)|euro]` - `E[Y(tile_1)|euro]`) - (`E[Y(tile_3)|maori]` - `E[Y(tile_1)|maori]`)) -->
<!-- sim_estimand_all_tab -->
<!-- # save table -->
<!-- here_save(sim_estimand_all_tab, "sim_estimand_all_tab") -->
<!-- ``` -->
<!-- Summary of model -->
<!-- ```{r} -->
<!-- # read table -->
<!-- sim_estimand_all_tab <- margot::here_read("sim_estimand_all_tab") -->
<!-- # print table -->
<!-- summary(sim_estimand_all_tab) -->
<!-- ``` -->
<!-- ### Machine learning estimation: subgroups -->
<!-- ```{r} -->
<!-- #| label: lmtp_subgroup -->
<!-- #| eval: false -->
<!-- #| echo: true -->
<!-- # lmtp -->
<!-- library("lmtp") -->
<!-- # set number of folds for ML here. use a minimum of 5 and a max of 10 -->
<!-- SL_folds = 5 -->
<!-- #this will allow you to track progress -->
<!-- progressr::handlers(global = TRUE) -->
<!-- # set seed for reproducing results -->
<!-- set.seed(0112358) -->
<!-- # set cores for estimation -->
<!-- library(future) -->
<!-- plan(multisession) -->
<!-- n_cores <- parallel::detectCores() - 2 # save two cores for other work while these models run -->
<!-- # check -->
<!-- n_cores -->
<!-- # super learner libraries -->
<!-- # these are useful for high-dimensional data -->
<!-- df_clean_t2 <- here_read('df_clean_t2') -->
<!-- df_maori <-df_clean_t2 |> dplyr::filter(t0_eth_cat == "maori") |> droplevels() -->
<!-- df_euro <-df_clean_t2 |> dplyr::filter(t0_eth_cat == "euro")  |> droplevels() -->
<!-- nrow(df_maori) -->
<!-- nrow(df_euro) -->
<!-- colnames(df_euro) -->
<!-- colnames(df_clean_t2) -->
<!-- A<- "t1_perfectionism_4tile" -->
<!-- # note lmtp's unconventional use of "censored" -->
<!-- C <- c("t1_censored") -->
<!-- df_clean_t2$t0_combo_weights -->
<!-- names_base <- -->
<!--   df_clean_t2 |> select(starts_with("t0"), -->
<!--                      -t0_combo_weights,  -->
<!--                      -t0_censored, -->
<!--                      -t0_eth_cat) |> colnames() -->
<!-- names_base -->
<!-- C <- c("t1_censored") -->
<!-- shift_all_tile_3 <- function(data, trt) { -->
<!--   ifelse(data[[trt]] != "tile_3", "tile_3",  data[[trt]]) -->
<!-- } -->
<!-- shift_all_tile_1 <- function(data, trt) { -->
<!--   ifelse(data[[trt]] != "tile_1", "tile_1",  data[[trt]]) -->
<!-- } -->
<!-- C -->
<!-- # for faster estimation use fewer -->
<!-- sl_lib <- c(#"SL.glmnet", -->
<!--             "SL.ranger", # forests -->
<!--           #  "SL.rpart",#  -->
<!--             "SL.xgboost" -->
<!--             )  -->
<!-- ## no parametric estimation  -->
<!-- maori_tile_3_t2_kessler_latent_anxiety_z <- lmtp_tmle( -->
<!--     data = df_maori, -->
<!--     trt = A, -->
<!--     baseline = names_base, -->
<!--     outcome = "t2_kessler_latent_anxiety_z", -->
<!--     cens = C, -->
<!--     shift = shift_all_tile_3, -->
<!--     mtp = TRUE, -->
<!--     folds = 5, -->
<!--     # trim = 0.99, # if needed -->
<!--     # time_vary = NULL, -->
<!--     outcome_type = "continuous", -->
<!--     weights = df_maori$weights_stabilised, -->
<!--     learners_trt = sl_lib, -->
<!--     learners_outcome =sl_lib, -->
<!--     parallel = n_cores -->
<!--   ) -->
<!-- maori_tile_3_t2_kessler_latent_anxiety_z -->
<!-- here_save(maori_tile_3_t2_kessler_latent_anxiety_z, "maori_tile_3_t2_kessler_latent_anxiety_z") -->
<!-- # learners for the exposure -->
<!-- maori_tile_3_t2_kessler_latent_anxiety_z$fits_m -->
<!-- # learners for the  outcome -->
<!-- maori_tile_3_t2_kessler_latent_anxiety_z$fits_r -->
<!-- maori_tile_1_t2_kessler_latent_anxiety_z <- lmtp_tmle( -->
<!--     data = df_maori, -->
<!--     trt = A, -->
<!--     baseline = names_base, -->
<!--     outcome = "t2_kessler_latent_anxiety_z", -->
<!--     cens = C, -->
<!--     shift = shift_all_tile_1, -->
<!--     mtp = TRUE, -->
<!--     folds = 5, -->
<!--     # trim = 0.99, # if needed -->
<!--     # time_vary = NULL, -->
<!--     outcome_type = "continuous", -->
<!--     weights = df_maori$weights_stabilised, -->
<!--     learners_trt = sl_lib, -->
<!--     learners_outcome =sl_lib, -->
<!--     parallel = n_cores -->
<!--   ) -->
<!-- maori_tile_1_t2_kessler_latent_anxiety_z -->
<!-- here_save(maori_tile_1_t2_kessler_latent_anxiety_z, "maori_tile_1_t2_kessler_latent_anxiety_z") -->
<!-- # higher anxiety  -->
<!-- maori_results <-lmtp_contrast(maori_tile_3_t2_kessler_latent_anxiety_z, ref = maori_tile_1_t2_kessler_latent_anxiety_z) -->
<!-- # maori_results -->
<!-- here_save(maori_results, "maori_results") -->
<!-- euro_tile_3_t2_kessler_latent_anxiety_z <- lmtp_tmle( -->
<!--     data = df_euro, -->
<!--     trt = A, -->
<!--     baseline = names_base, -->
<!--     outcome = "t2_kessler_latent_anxiety_z", -->
<!--     cens = C, -->
<!--     shift = shift_all_tile_3, -->
<!--     mtp = TRUE, -->
<!--     folds = 5, -->
<!--     # trim = 0.99, # if needed -->
<!--     # time_vary = NULL, -->
<!--     outcome_type = "continuous", -->
<!--     weights = df_euro$weights_stabilised, -->
<!--     learners_trt = sl_lib, -->
<!--     learners_outcome =sl_lib, -->
<!--     parallel = n_cores -->
<!--   ) -->
<!-- euro_tile_3_t2_kessler_latent_anxiety_z -->
<!-- here_save(euro_tile_3_t2_kessler_latent_anxiety_z, "euro_tile_3_t2_kessler_latent_anxiety_z") -->
<!-- euro_tile_1_t2_kessler_latent_anxiety_z <- lmtp_tmle( -->
<!--     data = df_euro, -->
<!--     trt = A, -->
<!--     baseline = names_base, -->
<!--     outcome = "t2_kessler_latent_anxiety_z", -->
<!--     cens = C, -->
<!--     shift = shift_all_tile_1, -->
<!--     mtp = TRUE, -->
<!--     folds = 5, -->
<!--     # trim = 0.99, # if needed -->
<!--     # time_vary = NULL, -->
<!--     outcome_type = "continuous", -->
<!--     weights = df_euro$weights_stabilised, -->
<!--     learners_trt = sl_lib, -->
<!--     learners_outcome =sl_lib, -->
<!--     parallel = n_cores -->
<!--   ) -->
<!-- euro_tile_1_t2_kessler_latent_anxiety_z -->
<!-- here_save(euro_tile_1_t2_kessler_latent_anxiety_z, "euro_tile_1_t2_kessler_latent_anxiety_z") -->
<!-- euro_results <- lmtp_contrast(euro_tile_3_t2_kessler_latent_anxiety_z, ref = euro_tile_1_t2_kessler_latent_anxiety_z) -->
<!-- here_save(euro_results, "euro_results") -->
<!-- ``` -->
<!-- ### Machine learning: results -->
<!-- No difference between groups.  -->
<!-- ```{r} -->
<!-- euro_results <- margot::here_read("euro_results") -->
<!-- maori_results<- margot::here_read("maori_results") -->
<!-- euro_results -->
<!-- maori_results -->
<!-- g_hat_theta= euro_results$vals$theta - maori_results$vals$theta  -->
<!-- g_hat_theta # difference of means -->
<!-- euro_results$vals$std.error -->
<!-- # difference  -->
<!-- se_diff = sqrt( (euro_results$vals$std.error^2) + (maori_results$vals$std.error^2) ) -->
<!-- diff_conf.low = g_hat_theta - (1.97 * se_diff) -->
<!-- diff_conf.high = g_hat_theta + (1.97 * se_diff) -->
<!-- g_hat_anxiety <- cbind.data.frame(g_hat_theta, se_diff, diff_conf.low, diff_conf.high) -->
<!-- # result -->
<!-- g_hat_anxiety -->
<!-- ``` -->
<!-- Note, however that the invevention increases anxiety for both groups equally -->
<!-- ### Europeans results -->
<!-- ```{r} -->
<!-- euro_results <- margot::here_read("euro_results") -->
<!-- round( euro_results$vals, 3) -->
<!-- ``` -->
<!-- ### Maori results -->
<!-- ```{r} -->
<!-- maori_results<- margot::here_read("maori_results") -->
<!-- round(maori_results$vals, 3) -->
<!-- ``` -->
<!-- ### Graph results -->
<!-- ```{r} -->
<!-- tab_euro_results <- margot::margot_lmtp_evalue( -->
<!--   euro_results, -->
<!--   scale = "RD", -->
<!--   new_name = "Euro: 1_tile to 3_tile" -->
<!-- ) -->
<!-- tab_maori_results <- margot::margot_lmtp_evalue( -->
<!--   maori_results, -->
<!--   scale = "RD", -->
<!--   new_name = "Māori: 1_tile to 3_tile" -->
<!-- ) -->
<!-- bind_results_anxiety <- rbind(tab_euro_results, tab_maori_results) -->
<!-- here_save(bind_results_anxiety, "bind_results_anxiety") -->
<!-- ``` -->
<!-- ```{r} -->
<!-- #| fig-width: 10 -->
<!-- #| fig-height: 12 -->
<!-- bind_results_anxiety <- here_read("bind_results_anxiety") -->
<!-- group_tab_anxiety <- margot::group_tab(bind_results_anxiety, type = "RD") -->
<!-- conflicted::conflicts_prefer(ggplot2::margin) -->
<!-- # graph results -->
<!--  margot_plot( -->
<!--   group_tab_anxiety, -->
<!--   type = "RD", -->
<!--   title = "Perfectionism: shift all to 3_tile, contrast with 1_tile", -->
<!--   subtitle = "Outcome = Anxiety", -->
<!--   estimate_scale = 1, -->
<!--   base_size = 18, -->
<!--   text_size = 4.5, -->
<!--   point_size = 3.5, -->
<!--   title_size = 20, -->
<!--   subtitle_size = 16, -->
<!--   legend_text_size = 10, -->
<!--   legend_title_size = 10, -->
<!--   x_offset = -.5, -->
<!--   x_lim_lo = -.5, -->
<!--   x_lim_hi =  .5 -->
<!-- ) -->
<!-- ``` -->
<!-- Interpret Results -->
<!-- ```{r} -->
<!-- margot_interpret_table(group_tab_anxiety, estimand = "ATT", causal_scale = "causal_difference") -->
<!-- ``` -->
<!-- ## Take Home Message -->
<!-- Machine learning with cross validation recovers nearly identical estimates for the effect of a shift in perfectionism on anxiety among Māori and Europeans.  -->
<!-- Which results are correct?  We don't know. With more time, we would add more learners to the model, including parametric learners.  -->
<!-- Generally, I suggest using machine learning algorithms, because they can include parametric estimators.  -->
</section>
<section id="packages" class="level3">
<h3 class="anchored" data-anchor-id="packages">Packages</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>report<span class="sc">::</span><span class="fu">cite_packages</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  - Analytics R, Weston S (2022). _iterators: Provides Iterator Construct_. R package version 1.0.14, &lt;https://CRAN.R-project.org/package=iterators&gt;.
  - Bulbulia J (2024). _margot: MARGinal Observational Treatment-effects_. doi:10.5281/zenodo.10907724 &lt;https://doi.org/10.5281/zenodo.10907724&gt;, R package version 0.3.1.0 Functions to obtain MARGinal Observational Treatment-effects from observational data., &lt;https://go-bayes.github.io/margot/&gt;.
  - Chang W (2023). _extrafont: Tools for Using Fonts_. R package version 0.19, &lt;https://CRAN.R-project.org/package=extrafont&gt;.
  - Chen T, He T, Benesty M, Khotilovich V, Tang Y, Cho H, Chen K, Mitchell R, Cano I, Zhou T, Li M, Xie J, Lin M, Geng Y, Li Y, Yuan J (2024). _xgboost: Extreme Gradient Boosting_. R package version 1.7.8.1, &lt;https://CRAN.R-project.org/package=xgboost&gt;.
  - Corporation M, Weston S (2022). _doParallel: Foreach Parallel Adaptor for the 'parallel' Package_. R package version 1.0.17, &lt;https://CRAN.R-project.org/package=doParallel&gt;.
  - Csárdi G (2024). _crayon: Colored Terminal Output_. R package version 1.5.3, &lt;https://CRAN.R-project.org/package=crayon&gt;.
  - Csárdi G (2025). _cli: Helpers for Developing Command Line Interfaces_. R package version 3.6.3.9002, commit 8320914f110ddaa5f3004f2a4421535661b18ea1, &lt;https://github.com/r-lib/cli&gt;.
  - Greifer N (2024). _cobalt: Covariate Balance Tables and Plots_. R package version 4.5.5, &lt;https://CRAN.R-project.org/package=cobalt&gt;.
  - Greifer N (2024). _WeightIt: Weighting for Covariate Balance in Observational Studies_. R package version 1.3.2, &lt;https://CRAN.R-project.org/package=WeightIt&gt;.
  - Greifer N, Worthington S, Iacus S, King G (2024). _clarify: Simulation-Based Inference for Regression Models_. R package version 0.2.1, &lt;https://CRAN.R-project.org/package=clarify&gt;.
  - Grolemund G, Wickham H (2011). "Dates and Times Made Easy with lubridate." _Journal of Statistical Software_, *40*(3), 1-25. &lt;https://www.jstatsoft.org/v40/i03/&gt;.
  - Hastie T (2024). _gam: Generalized Additive Models_. R package version 1.22-5, &lt;https://CRAN.R-project.org/package=gam&gt;.
  - Ho D, Imai K, King G, Stuart E (2011). "MatchIt: Nonparametric Preprocessing for Parametric Causal Inference." _Journal of Statistical Software_, *42*(8), 1-28. doi:10.18637/jss.v042.i08 &lt;https://doi.org/10.18637/jss.v042.i08&gt;.
  - Microsoft, Weston S (2022). _foreach: Provides Foreach Looping Construct_. R package version 1.5.2, &lt;https://CRAN.R-project.org/package=foreach&gt;.
  - Mullen KM, van Stokkum IHM (2024). _nnls: The Lawson-Hanson Algorithm for Non-Negative Least Squares (NNLS)_. R package version 1.6, &lt;https://CRAN.R-project.org/package=nnls&gt;.
  - Müller K, Wickham H (2023). _tibble: Simple Data Frames_. R package version 3.2.1, &lt;https://CRAN.R-project.org/package=tibble&gt;.
  - Pishgar F, Greifer N, Leyrat C, Stuart E (2021). "MatchThem:: Matching and Weighting after Multiple Imputation." _The R Journal_. doi:10.32614/RJ-2021-073 &lt;https://doi.org/10.32614/RJ-2021-073&gt;, &lt;https://journal.r-project.org/archive/2021/RJ-2021-073/&gt;.
  - Polley E, LeDell E, Kennedy C, van der Laan M (2024). _SuperLearner: Super Learner Prediction_. R package version 2.0-29, &lt;https://CRAN.R-project.org/package=SuperLearner&gt;.
  - R Core Team (2024). _R: A Language and Environment for Statistical Computing_. R Foundation for Statistical Computing, Vienna, Austria. &lt;https://www.R-project.org/&gt;.
  - Tierney N, Cook D (2023). "Expanding Tidy Data Principles to Facilitate Missing Data Exploration, Visualization and Assessment of Imputations." _Journal of Statistical Software_, *105*(7), 1-31. doi:10.18637/jss.v105.i07 &lt;https://doi.org/10.18637/jss.v105.i07&gt;.
  - van Buuren S, Groothuis-Oudshoorn K (2011). "mice: Multivariate Imputation by Chained Equations in R." _Journal of Statistical Software_, *45*(3), 1-67. doi:10.18637/jss.v045.i03 &lt;https://doi.org/10.18637/jss.v045.i03&gt;.
  - Waring E, Quinn M, McNamara A, Arino de la Rubia E, Zhu H, Ellis S (2022). _skimr: Compact and Flexible Summaries of Data_. R package version 2.1.5, &lt;https://CRAN.R-project.org/package=skimr&gt;.
  - Wickham H (2016). _ggplot2: Elegant Graphics for Data Analysis_. Springer-Verlag New York. ISBN 978-3-319-24277-4, &lt;https://ggplot2.tidyverse.org&gt;.
  - Wickham H (2023). _forcats: Tools for Working with Categorical Variables (Factors)_. R package version 1.0.0, &lt;https://CRAN.R-project.org/package=forcats&gt;.
  - Wickham H (2023). _stringr: Simple, Consistent Wrappers for Common String Operations_. R package version 1.5.1, &lt;https://CRAN.R-project.org/package=stringr&gt;.
  - Wickham H, Averick M, Bryan J, Chang W, McGowan LD, François R, Grolemund G, Hayes A, Henry L, Hester J, Kuhn M, Pedersen TL, Miller E, Bache SM, Müller K, Ooms J, Robinson D, Seidel DP, Spinu V, Takahashi K, Vaughan D, Wilke C, Woo K, Yutani H (2019). "Welcome to the tidyverse." _Journal of Open Source Software_, *4*(43), 1686. doi:10.21105/joss.01686 &lt;https://doi.org/10.21105/joss.01686&gt;.
  - Wickham H, François R, Henry L, Müller K, Vaughan D (2023). _dplyr: A Grammar of Data Manipulation_. R package version 1.1.4, &lt;https://CRAN.R-project.org/package=dplyr&gt;.
  - Wickham H, Henry L (2023). _purrr: Functional Programming Tools_. R package version 1.0.2, &lt;https://CRAN.R-project.org/package=purrr&gt;.
  - Wickham H, Hester J, Bryan J (2024). _readr: Read Rectangular Text Data_. R package version 2.1.5, &lt;https://CRAN.R-project.org/package=readr&gt;.
  - Wickham H, Vaughan D, Girlich M (2024). _tidyr: Tidy Messy Data_. R package version 1.3.1, &lt;https://CRAN.R-project.org/package=tidyr&gt;.
  - Williams N, Díaz I (2023). "lmtp: An R package for estimating the causal effects of modified treatment policies." _Observational Studies_. &lt;https://muse.jhu.edu/article/883479&gt;. Díaz I, Williams N, Hoffman K, Schneck E (2021). "Non-parametric causal effects based on longitudinal modified treatment policies." _Journal of the American Statistical Association_. doi:10.1080/01621459.2021.1955691 &lt;https://doi.org/10.1080/01621459.2021.1955691&gt;.
  - Wright MN, Ziegler A (2017). "ranger: A Fast Implementation of Random Forests for High Dimensional Data in C++ and R." _Journal of Statistical Software_, *77*(1), 1-17. doi:10.18637/jss.v077.i01 &lt;https://doi.org/10.18637/jss.v077.i01&gt;.
  - Xie Y (2024). _knitr: A General-Purpose Package for Dynamic Report Generation in R_. R package version 1.49, &lt;https://yihui.org/knitr/&gt;. Xie Y (2015). _Dynamic Documents with R and knitr_, 2nd edition. Chapman and Hall/CRC, Boca Raton, Florida. ISBN 978-1498716963, &lt;https://yihui.org/knitr/&gt;. Xie Y (2014). "knitr: A Comprehensive Tool for Reproducible Research in R." In Stodden V, Leisch F, Peng RD (eds.), _Implementing Reproducible Computational Research_. Chapman and Hall/CRC. ISBN 978-1466561595.
  - Xie Y (2024). _tinytex: Helper Functions to Install and Maintain TeX Live, and Compile LaTeX Documents_. R package version 0.54, &lt;https://github.com/rstudio/tinytex&gt;. Xie Y (2019). "TinyTeX: A lightweight, cross-platform, and easy-to-maintain LaTeX distribution based on TeX Live." _TUGboat_, *40*(1), 30-32. &lt;https://tug.org/TUGboat/Contents/contents40-1.html&gt;.
  - Zhu H (2024). _kableExtra: Construct Complex Table with 'kable' and Pipe Syntax_. R package version 1.4.0, &lt;https://CRAN.R-project.org/package=kableExtra&gt;.</code></pre>
</div>
</div>


<!-- -->


</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb32" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Causal Inference: Estimation of ATE and CATE"</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "2025-APR-29"</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co">    warnings: FALSE</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co">    error: FALSE</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co">    messages: FALSE</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-overflow: scroll</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co">    highlight-style: kate</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools:</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="co">      source: true</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="co">      toggle: FALSE</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="an">html-math-method:</span><span class="co"> katex</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="an">reference-location:</span><span class="co"> margin</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="an">citation-location:</span><span class="co"> margin</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="an">cap-location:</span><span class="co"> margin</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="an">code-block-border-left:</span><span class="co"> true</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a><span class="co"># for information about this template: https://github.com/mikemahoney218/quarto-arxiv/blob/main/template.qmd</span></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a><span class="co">#libraries and functions</span></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a><span class="co"># read libraries</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"tinytex"</span>)</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(extrafont)</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a><span class="fu">loadfonts</span>(<span class="at">device =</span> <span class="st">"win"</span>)</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a><span class="co"># read functions</span></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a><span class="co">#source("/Users/joseph/GIT/templates/functions/funs.R")</span></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>**Required**</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@vanderweele2020</span><span class="co">] [link]</span>(https://www.dropbox.com/scl/fi/srpynr0dvjcndveplcydn/OutcomeWide_StatisticalScience.pdf?rlkey=h4fv32oyjegdfl3jq9u1fifc3&amp;dl=0)</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>**Optional**</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@suzuki2020</span><span class="co">] [link]</span>(https://www.dropbox.com/scl/fi/4midxwr9ltg9oce02e0ss/suzuki-causal-diagrams.pdf?rlkey=uktzf3nurtgpbj8m4h0xz82dn&amp;dl=0)</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@Bulbulia2024PracticalGuide</span><span class="co">] [link]</span>(https://osf.io/preprints/psyarxiv/uyg3d)</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@hoffman2023</span><span class="co">] [link]</span>(https://arxiv.org/pdf/2304.09460.pdf)</span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>::: {.callout-important}</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a><span class="fu">## Key concepts for the test(s):</span></span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>**Counfounding vs Confounder**</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>**Causal Estimand, Statistical Estimand, Statistical Estimator**</span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>**Inverse probabilitiy of treatment weights using propensity scores: modelling the exposure or treatment, not the outcome.**</span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>**Subgroup analysis using propensity scores**</span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>::: {.callout-important}</span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a><span class="fu">## For the lab, copy and paste code chunks following the "LAB" section.</span></span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a><span class="fu"># Seminar</span></span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a><span class="fu">## Learning Outcomes</span></span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You will learn how to state a causal question in a three-wave panel</span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You will learn how to identify causal effects in a three-waves of panel data.</span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>How to do Propensity-score weighting: modelling the exposure or treatment, not the outcome.</span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- - Outcome modelling: modelling the outcome, with the treatment included in the model --&gt;</span></span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- - Doubly robust estimation: model both the treatment and the outcome.** --&gt;</span></span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Subgroup analysis by doubly-robust estimation</span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- - You will learn how to write a report statement that formulates a causal question, names a population of interest, and constructs a causal diagram that explains whether and how to identify a causal effect from data.  --&gt;</span></span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a><span class="fu">### Why is this lesson important?</span></span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Recall that in psychology, our task is to answer some questions about how people think and behave. In cross-cultural psychology, these questions are typically comparative. --&gt;</span></span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Our first task is clearly define that question. Our second task is to answer that question. --&gt;</span></span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a>The methods you will learn today will help you to define and answer comparative questions in psychology. </span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a><span class="fu">## Review: The Fundamental Problem of Causal Inference as a Missing Data Problem</span></span>
<span id="cb32-86"><a href="#cb32-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a>Recall the fundamental problem of causal inference, returning to the question of whether bilingualism improves cognitive abilities:</span>
<span id="cb32-88"><a href="#cb32-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-89"><a href="#cb32-89" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>$Y_i^{a = 1}$: The cognitive ability of child $i$ if they were bilingual. This is the counterfactual outcome when A = 1.</span>
<span id="cb32-90"><a href="#cb32-90" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>$Y_i^{a = 0}$:: The cognitive ability of child $i$ if they were monolingual. This is the counterfactual outcome when A = 0.</span>
<span id="cb32-91"><a href="#cb32-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-92"><a href="#cb32-92" aria-hidden="true" tabindex="-1"></a>The causal effect of bilingualism on cognitive ability for individual $i$ is then defined as the difference between these potential outcomes:</span>
<span id="cb32-93"><a href="#cb32-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-94"><a href="#cb32-94" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-95"><a href="#cb32-95" aria-hidden="true" tabindex="-1"></a>\text{Causal Effect}_i = Y_i^{a=1} - Y_i^{a=0} </span>
<span id="cb32-96"><a href="#cb32-96" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-97"><a href="#cb32-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-98"><a href="#cb32-98" aria-hidden="true" tabindex="-1"></a>We say there is a causal effect if:</span>
<span id="cb32-99"><a href="#cb32-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-100"><a href="#cb32-100" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-101"><a href="#cb32-101" aria-hidden="true" tabindex="-1"></a>Y_i^{a=1} - Y_i^{a=0}  \neq 0</span>
<span id="cb32-102"><a href="#cb32-102" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-103"><a href="#cb32-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-104"><a href="#cb32-104" aria-hidden="true" tabindex="-1"></a>However, we only observe one of the potential outcomes for each child. The other outcome is not observed because physics prevents a child from both receiving and not receiving bilingual exposure.</span>
<span id="cb32-105"><a href="#cb32-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-106"><a href="#cb32-106" aria-hidden="true" tabindex="-1"></a>The fact that causal contrasts are not observed in individuals is called "The fundamental problem of causal inference."</span>
<span id="cb32-107"><a href="#cb32-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-108"><a href="#cb32-108" aria-hidden="true" tabindex="-1"></a>Although we typically cannot observe individual causal effects, we can obtain average causal effects when certain assumptions are satisfied.</span>
<span id="cb32-109"><a href="#cb32-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-110"><a href="#cb32-110" aria-hidden="true" tabindex="-1"></a><span class="in">```{=tex}</span></span>
<span id="cb32-111"><a href="#cb32-111" aria-hidden="true" tabindex="-1"></a><span class="in">\begin{align}</span></span>
<span id="cb32-112"><a href="#cb32-112" aria-hidden="true" tabindex="-1"></a><span class="in">E(\delta) = E(Y^{a=1} - Y^{a=0})\\</span></span>
<span id="cb32-113"><a href="#cb32-113" aria-hidden="true" tabindex="-1"></a><span class="in">          ~  = E(Y^{a=1}) - E(Y^{a=0}) \\</span></span>
<span id="cb32-114"><a href="#cb32-114" aria-hidden="true" tabindex="-1"></a><span class="in">          ~  = ATE</span></span>
<span id="cb32-115"><a href="#cb32-115" aria-hidden="true" tabindex="-1"></a><span class="in">\end{align}</span></span>
<span id="cb32-116"><a href="#cb32-116" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-117"><a href="#cb32-117" aria-hidden="true" tabindex="-1"></a>We may identify average causal effects from the data when the following assumptions are met:</span>
<span id="cb32-118"><a href="#cb32-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-119"><a href="#cb32-119" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Causal Consistency:** The exposure values under comparisons correspond to well-defined interventions that, in turn, correspond to the treatment versions in the data.[]</span>
<span id="cb32-120"><a href="#cb32-120" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Positivity:** The probability of receiving every value of the exposure within all strata of co-variates is greater than zero []</span>
<span id="cb32-121"><a href="#cb32-121" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Exchangeability:** The conditional probability of receiving every value of an exposure level, though not decided by the investigators, depends only on the measured covariates []</span>
<span id="cb32-122"><a href="#cb32-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-123"><a href="#cb32-123" aria-hidden="true" tabindex="-1"></a>Further assumptions:</span>
<span id="cb32-124"><a href="#cb32-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-125"><a href="#cb32-125" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**No Interference,** also known as the **Stable Unit Treatment Value Assumption** (SUTVA), requires that the treatment given to one unit (e.g., person, group, organization) does not interfere with the potential outcomes of another unit. Put differently, there are no "spillover" effects. Note: this assumption may be thought to be part of causal consistency, namely individual has only one potential outcome under each treatment condition.</span>
<span id="cb32-126"><a href="#cb32-126" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Correctly specified model**: the requirement that the underlying statistical model used to estimate causal effects accurately represents the true relationships between the variables of interest. We say the model should be able to capture "the functional form" of the relationship between the treatment, the outcome, and any covariates. The model's functional form should be flexible enough to capture the true underlying relationship. The estimated causal effects may be biased if the model's functional form is incorrect. Additionally, the model must handle omitted variable bias by including all relevant confounders and should correctly handle missing data from non-response or loss-to follow up. We will return to the bias arising from missing data in the weeks ahead. For now, it is important to note that causal inference assumes that our model is correctly specified.</span>
<span id="cb32-127"><a href="#cb32-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-128"><a href="#cb32-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-129"><a href="#cb32-129" aria-hidden="true" tabindex="-1"></a><span class="fu">## Subgroup analysis</span></span>
<span id="cb32-130"><a href="#cb32-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-131"><a href="#cb32-131" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- In causal inference, these two concepts are related but have distinct meanings. --&gt;</span></span>
<span id="cb32-132"><a href="#cb32-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-133"><a href="#cb32-133" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Let $Y_{a}$ denote the counterfactual outcome Y when the experimental intervention $A$ is set to level $a$. Let $Y_{r}$ denote the counterfactual outcome $Y$ when another experimental intervention $R$ is set to level $r$. Following VanderWeele (2009), we can define interaction and effect modification as follows: --&gt;</span></span>
<span id="cb32-134"><a href="#cb32-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-135"><a href="#cb32-135" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 1.  Interaction (causal interaction) on the difference scale, conditional on confounders $L$, occurs when: --&gt;</span></span>
<span id="cb32-136"><a href="#cb32-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-137"><a href="#cb32-137" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$E(Y^{a1,r1}|L=l) - E(Y^{a0,r1}|L=l) \neq E(Y^{a1,r0}|L=l) - E(Y^{a0,r0}|L=l)$$ --&gt;</span></span>
<span id="cb32-138"><a href="#cb32-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-139"><a href="#cb32-139" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- In this case, we are considering a double intervention, and interaction occurs when the combined effect of interventions $A$ and $R$ is not equal to the sum of their individual effects. --&gt;</span></span>
<span id="cb32-140"><a href="#cb32-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-141"><a href="#cb32-141" aria-hidden="true" tabindex="-1"></a>Redcall, **Effect Modification** (also known as "heterogeneity of treatment effects", and "Effect-measure modification") occurs when the causal effect of intervention $A$ varies across different levels of another variable $R$:</span>
<span id="cb32-142"><a href="#cb32-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-143"><a href="#cb32-143" aria-hidden="true" tabindex="-1"></a>$$E(Y^{a=1}|G=g_1, L=l) - E(Y^{a=0}|G=g_1, L=l) \neq E(Y^{a=1}|G=g_2, L=l) - E(Y^{a=0}|G=g_2, L=l)$$</span>
<span id="cb32-144"><a href="#cb32-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-145"><a href="#cb32-145" aria-hidden="true" tabindex="-1"></a>Effect modification indicates that the magnitude of the causal effect of intervention $A$ is related to the modifier variable $G$ level. As discussed last week, effect modification can be observed even when there is no direct causal interaction between the treatment and the modifier variable. We noted that **interaction in causal inference refers to a situation where the combined effect of two interventions is not equal to the sum of their individual effects**. **Effect modification, on the other hand, occurs when the causal effect of one intervention varies across different levels of another variable.**</span>
<span id="cb32-146"><a href="#cb32-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-147"><a href="#cb32-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-148"><a href="#cb32-148" aria-hidden="true" tabindex="-1"></a>We also noted that </span>
<span id="cb32-149"><a href="#cb32-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-150"><a href="#cb32-150" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **For comparative research, we are typically interested in effect-modification, which requires subgroup analysis.**</span></span>
<span id="cb32-151"><a href="#cb32-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-152"><a href="#cb32-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-153"><a href="#cb32-153" aria-hidden="true" tabindex="-1"></a><span class="fu">### Causal Estimand, Statistical Estimand, Statistical Estimator</span></span>
<span id="cb32-154"><a href="#cb32-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-155"><a href="#cb32-155" aria-hidden="true" tabindex="-1"></a>Let's set subgroup analysis to the side for a moment and begin focussing on statistical estimation.  </span>
<span id="cb32-156"><a href="#cb32-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-157"><a href="#cb32-157" aria-hidden="true" tabindex="-1"></a>Suppose a researcher wants to understand the causal effect of marriage on individual happiness. Participants in the study are surveyed for their marital status ("married" or "not married") and their self-reported happiness on a scale from 1 to 10.</span>
<span id="cb32-158"><a href="#cb32-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-159"><a href="#cb32-159" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Causal Estimand</span></span>
<span id="cb32-160"><a href="#cb32-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-161"><a href="#cb32-161" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Definition**: The causal estimand is the specific quantity or parameter that we aim to estimate to understand the causal effect of an intervention or treatment on an outcome.</span>
<span id="cb32-162"><a href="#cb32-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-163"><a href="#cb32-163" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Example**: Here, the **Causal Estimand** would be the Average Treatment Effect (ATE) of being married on happiness. Specifically, we define the ATE as the difference in the potential outcomes of happiness if all individuals were married versus if no individuals were married:</span>
<span id="cb32-164"><a href="#cb32-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-165"><a href="#cb32-165" aria-hidden="true" tabindex="-1"></a>  $$</span>
<span id="cb32-166"><a href="#cb32-166" aria-hidden="true" tabindex="-1"></a>  \text{ATE} = E<span class="co">[</span><span class="ot">Y^{a=1} - Y^{a=0}</span><span class="co">]</span></span>
<span id="cb32-167"><a href="#cb32-167" aria-hidden="true" tabindex="-1"></a>  $$</span>
<span id="cb32-168"><a href="#cb32-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-169"><a href="#cb32-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-170"><a href="#cb32-170" aria-hidden="true" tabindex="-1"></a>  Here, $Y^{a=1}$ represents the potential happiness score if an individual is married, and $Y^{a=0}$ if they are not married.</span>
<span id="cb32-171"><a href="#cb32-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-172"><a href="#cb32-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-173"><a href="#cb32-173" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Next step: Are Causal Assumptions Met? </span></span>
<span id="cb32-174"><a href="#cb32-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-175"><a href="#cb32-175" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Identification (Exchangeability): balance in the confounders across the treatments to be compared</span>
<span id="cb32-176"><a href="#cb32-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-177"><a href="#cb32-177" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Consistency: well-defined interventions</span>
<span id="cb32-178"><a href="#cb32-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-179"><a href="#cb32-179" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Positivity: treatments occur within levels of covariates $L$</span>
<span id="cb32-180"><a href="#cb32-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-181"><a href="#cb32-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-182"><a href="#cb32-182" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Statistical Estimand (next step)</span></span>
<span id="cb32-183"><a href="#cb32-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-184"><a href="#cb32-184" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**The problem**: how do we bridge the gap between potential outcomes and data? </span>
<span id="cb32-185"><a href="#cb32-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-186"><a href="#cb32-186" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Definition**: the statistical estimand is the parameter or function that summarises the relationship between variables as described by a statistical model applied to data. </span>
<span id="cb32-187"><a href="#cb32-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-188"><a href="#cb32-188" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Example**: for our study, the **Statistical Estimand** might be the mean difference in happiness scores between individuals who are married and those who are not, as derived from a linear regression model:</span>
<span id="cb32-189"><a href="#cb32-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-190"><a href="#cb32-190" aria-hidden="true" tabindex="-1"></a>  $$</span>
<span id="cb32-191"><a href="#cb32-191" aria-hidden="true" tabindex="-1"></a>  \text{Happiness} = \beta_0 + \beta_1 \times \text{Married} + \epsilon</span>
<span id="cb32-192"><a href="#cb32-192" aria-hidden="true" tabindex="-1"></a>  $$</span>
<span id="cb32-193"><a href="#cb32-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-194"><a href="#cb32-194" aria-hidden="true" tabindex="-1"></a>  In this equation, $\beta_1$ represents the estimated difference in happiness scores between the married and non-married groups.</span>
<span id="cb32-195"><a href="#cb32-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-196"><a href="#cb32-196" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Statistical Estimator</span></span>
<span id="cb32-197"><a href="#cb32-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-198"><a href="#cb32-198" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Definition**: a statistical estimator is a rule or method by which a numerical estimate of a statistical estimand is calculated from the data.</span>
<span id="cb32-199"><a href="#cb32-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-200"><a href="#cb32-200" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Example**: in our marriage study, the **Statistical Estimator** for $\beta_1$ is the ordinary least squares (OLS) estimator. This estimator is used to calculate $\beta_1$ from the sample data provided by the survey. It provides an estimate of the impact of being married on happiness, calculated using:</span>
<span id="cb32-201"><a href="#cb32-201" aria-hidden="true" tabindex="-1"></a>  $$</span>
<span id="cb32-202"><a href="#cb32-202" aria-hidden="true" tabindex="-1"></a>  \hat{\beta}_1 = \frac{\sum_{i=1}^n (X_i - \bar{X})(Y_i - \bar{Y})}{\sum_{i=1}^n (X_i - \bar{X})^2}</span>
<span id="cb32-203"><a href="#cb32-203" aria-hidden="true" tabindex="-1"></a>  $$</span>
<span id="cb32-204"><a href="#cb32-204" aria-hidden="true" tabindex="-1"></a>  where $X_i$ is a binary indicator for being married (1 for married, 0 for not married), $Y_i$ is the observed happiness score, and $\bar{X}$, $\bar{Y}$ are the sample means of $X$ and $Y$, respectively.</span>
<span id="cb32-205"><a href="#cb32-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-206"><a href="#cb32-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-207"><a href="#cb32-207" aria-hidden="true" tabindex="-1"></a>(Note: you will not need to know this equation for the quiz)</span>
<span id="cb32-208"><a href="#cb32-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-209"><a href="#cb32-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-210"><a href="#cb32-210" aria-hidden="true" tabindex="-1"></a>The upshot, we anchor our causal inquiries within a mult-step framework of data analysis. This involves: </span>
<span id="cb32-211"><a href="#cb32-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-212"><a href="#cb32-212" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>clearly defining our causal estimand within a specified *target population,*</span>
<span id="cb32-213"><a href="#cb32-213" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>clarifying assumptions, &amp; especially identification assumptions, </span>
<span id="cb32-214"><a href="#cb32-214" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>describing a statistical strategy for extracting this estimand from the data, and then </span>
<span id="cb32-215"><a href="#cb32-215" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>applying an algorithm that embodies this statistical method.</span>
<span id="cb32-216"><a href="#cb32-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-217"><a href="#cb32-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-218"><a href="#cb32-218" aria-hidden="true" tabindex="-1"></a><span class="fu">## Methods for Statistical Estimation in Causal Inference: Inverse Probability of Treatment Weights Using Propensity Scores</span></span>
<span id="cb32-219"><a href="#cb32-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-220"><a href="#cb32-220" aria-hidden="true" tabindex="-1"></a>Last week, we discussed confounding control using regression adjustment. Recall the formula for the average treatment effect (ATE) when conditioning on a set of covariates $L$:</span>
<span id="cb32-221"><a href="#cb32-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-222"><a href="#cb32-222" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-223"><a href="#cb32-223" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb32-224"><a href="#cb32-224" aria-hidden="true" tabindex="-1"></a>\text{ATE} = E<span class="co">[</span><span class="ot">Y^{a=1} \mid L = l</span><span class="co">]</span> - E<span class="co">[</span><span class="ot">Y^{a=0} \mid L = l</span><span class="co">]</span> \quad \text{for any value of } l</span>
<span id="cb32-225"><a href="#cb32-225" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb32-226"><a href="#cb32-226" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-227"><a href="#cb32-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-228"><a href="#cb32-228" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; "We say that a set $L$ of measured non-descendants of $L$ is a sufficient set for confounding adjustment when conditioning on $L$ blocks all backdoor paths—that is, the treated and the untreated are exchangeable within levels of $L$" (Hernán &amp; Robins, *Causal Inference*, p. 86).</span></span>
<span id="cb32-229"><a href="#cb32-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-230"><a href="#cb32-230" aria-hidden="true" tabindex="-1"></a>This formula calculates the expected outcome difference between treated ($a=1$) and untreated ($a=0$) groups, given a specific value of the covariates $l$.</span>
<span id="cb32-231"><a href="#cb32-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-232"><a href="#cb32-232" aria-hidden="true" tabindex="-1"></a>Inverse Probability of Treatment Weighting (IPTW) takes a different approach. We create a pseudo-population where the treatment assignment is independent of the observed covariates by assigning weights to each individual based on their propensity scores.</span>
<span id="cb32-233"><a href="#cb32-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-234"><a href="#cb32-234" aria-hidden="true" tabindex="-1"></a>**We do this by modelling the treatment**</span>
<span id="cb32-235"><a href="#cb32-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-236"><a href="#cb32-236" aria-hidden="true" tabindex="-1"></a>Denote the treatment indicator by $A$, where $A = 1$ if an individual receives treatment and $A = 0$ otherwise. $L$ represents the vector of observed covariates, and $Y^a$ the potential outcomes. The propensity score, $e(L)$, is defined as the probability of receiving the treatment given the observed covariates:</span>
<span id="cb32-237"><a href="#cb32-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-238"><a href="#cb32-238" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-239"><a href="#cb32-239" aria-hidden="true" tabindex="-1"></a>\hat{e}(L) = P(A = 1 \mid L)</span>
<span id="cb32-240"><a href="#cb32-240" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-241"><a href="#cb32-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-242"><a href="#cb32-242" aria-hidden="true" tabindex="-1"></a>To obtain IPTW weights, compute the inverse probability of treatment:</span>
<span id="cb32-243"><a href="#cb32-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-244"><a href="#cb32-244" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-245"><a href="#cb32-245" aria-hidden="true" tabindex="-1"></a>v_i = \frac{A_i}{\hat{e}(L_i)} + \frac{1 - A_i}{1 - \hat{e}(L_i)}</span>
<span id="cb32-246"><a href="#cb32-246" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-247"><a href="#cb32-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-248"><a href="#cb32-248" aria-hidden="true" tabindex="-1"></a>Which simplifies to </span>
<span id="cb32-249"><a href="#cb32-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-250"><a href="#cb32-250" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-251"><a href="#cb32-251" aria-hidden="true" tabindex="-1"></a>v_i = </span>
<span id="cb32-252"><a href="#cb32-252" aria-hidden="true" tabindex="-1"></a>\begin{cases} </span>
<span id="cb32-253"><a href="#cb32-253" aria-hidden="true" tabindex="-1"></a>\frac{1}{\hat{e}} &amp; \text{if } A_i = 1 <span class="sc">\\</span></span>
<span id="cb32-254"><a href="#cb32-254" aria-hidden="true" tabindex="-1"></a>\frac{1}{1-\hat{e}} &amp; \text{if } A_i = 0 </span>
<span id="cb32-255"><a href="#cb32-255" aria-hidden="true" tabindex="-1"></a>\end{cases}</span>
<span id="cb32-256"><a href="#cb32-256" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-257"><a href="#cb32-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-258"><a href="#cb32-258" aria-hidden="true" tabindex="-1"></a>where $v_i$ is the IPTW weight for individual $i$, $A_i$ is the treatment indicator for individual $i$, and $\hat{e}(L_i)$ is the estimated propensity score for individual $i$.   </span>
<span id="cb32-259"><a href="#cb32-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-260"><a href="#cb32-260" aria-hidden="true" tabindex="-1"></a>How might we use these weights to obtain causal effect estimates?</span>
<span id="cb32-261"><a href="#cb32-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-262"><a href="#cb32-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-263"><a href="#cb32-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-264"><a href="#cb32-264" aria-hidden="true" tabindex="-1"></a><span class="fu">## Marginal Structural Models (MSMs)</span></span>
<span id="cb32-265"><a href="#cb32-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-266"><a href="#cb32-266" aria-hidden="true" tabindex="-1"></a>Marginal Structural Models (MSMs) estimate causal effects without requiring an "outcome model" that stratifies on covariates. Rather, MSMs employ weights derived from the inverse probability of treatment weighting (IPTW) to create a pseudo-population in which the distribution of covariates is independent of treatment assignment over time.</span>
<span id="cb32-267"><a href="#cb32-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-268"><a href="#cb32-268" aria-hidden="true" tabindex="-1"></a>The general form of an MSM can be expressed as follows:</span>
<span id="cb32-269"><a href="#cb32-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-270"><a href="#cb32-270" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-271"><a href="#cb32-271" aria-hidden="true" tabindex="-1"></a>E<span class="co">[</span><span class="ot">Y^a</span><span class="co">]</span> = \beta_0 + \beta_1a</span>
<span id="cb32-272"><a href="#cb32-272" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-273"><a href="#cb32-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-274"><a href="#cb32-274" aria-hidden="true" tabindex="-1"></a>where $E<span class="co">[</span><span class="ot">Y^a</span><span class="co">]</span>$ is the expected outcome under treatment $a$  and $\beta_0$ and $\beta_1$ are parameters estimated by fitting the weighted model. Again, the weights used in the MSM, typically derived from the IPTW (or another treatment model), adjust for the confounding, allowing the model to estimate the unbiased effect of the treatment on the outcome without requiring covariates in the model.</span>
<span id="cb32-275"><a href="#cb32-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-276"><a href="#cb32-276" aria-hidden="true" tabindex="-1"></a>Where do weights fit in?   Note, we have $E<span class="co">[</span><span class="ot">Y^a</span><span class="co">]</span>$ in please of $E<span class="co">[</span><span class="ot">Y|A=a</span><span class="co">]</span>$.  When applying propensity score weights in the linear regression model $E<span class="co">[</span><span class="ot">Y^a</span><span class="co">]</span> = \beta_0 + \beta_1a$, each observation is weighted by $v_i$, such that $v_i(\beta_0 + \beta_1a)$. This changes the estimation process to focus on a weighted sum of outcomes, where each individual's contribution is adjusted to reflect their probability of receiving the treatment, given their covariates.</span>
<span id="cb32-277"><a href="#cb32-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-278"><a href="#cb32-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-279"><a href="#cb32-279" aria-hidden="true" tabindex="-1"></a><span class="fu">## Interpretation of $\beta_0$ and $\beta_1$  in a Marginal Structural Model</span></span>
<span id="cb32-280"><a href="#cb32-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-281"><a href="#cb32-281" aria-hidden="true" tabindex="-1"></a><span class="fu">### Binary Treatment</span></span>
<span id="cb32-282"><a href="#cb32-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-283"><a href="#cb32-283" aria-hidden="true" tabindex="-1"></a>In models where the treatment $a$ is binary (e.g., $a = 0$ or $a = 1$), such as in many causal inference studies:</span>
<span id="cb32-284"><a href="#cb32-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-285"><a href="#cb32-285" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**$\beta_0$**: the expected value of the outcome $Y$ when the treatment is not applied ($a = 0$). This is the baseline level of the outcome in the absence of treatment.</span>
<span id="cb32-286"><a href="#cb32-286" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**$\beta_1$**: the change in the expected outcome when the treatment status changes from 0 to 1. In logistic regression, $\beta_1$ represents the log-odds ratio of the outcome for the treatment group relative to the control group. In linear regression, $\beta_1$ quantifies the difference in the average outcome between the treated and untreated groups.</span>
<span id="cb32-287"><a href="#cb32-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-288"><a href="#cb32-288" aria-hidden="true" tabindex="-1"></a><span class="fu">### Continuous Treatment</span></span>
<span id="cb32-289"><a href="#cb32-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-290"><a href="#cb32-290" aria-hidden="true" tabindex="-1"></a>When the treatment $a$ is continuous, the interpretation of $\beta_0$ and $\beta_1$ adjusts slightly:</span>
<span id="cb32-291"><a href="#cb32-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-292"><a href="#cb32-292" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**$\beta_0$**: represents the expected value of the outcome $Y$ when the treatment $a$ is at its reference value (often zero). </span>
<span id="cb32-293"><a href="#cb32-293" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**$\beta_1$**: represents the expected change in the outcome for each unit increase in the treatment. In this case, $\beta_1$ measures the gradient or slope of the relationship between the treatment and the outcome. For every one-unit increase in treatment, the outcome changes by $\beta_1$ units, assuming all other factors remain constant.</span>
<span id="cb32-294"><a href="#cb32-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-295"><a href="#cb32-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-296"><a href="#cb32-296" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Example: Binary treatment, Binary outcome --&gt;</span></span>
<span id="cb32-297"><a href="#cb32-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-298"><a href="#cb32-298" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Logistic Regression Model --&gt;</span></span>
<span id="cb32-299"><a href="#cb32-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-300"><a href="#cb32-300" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- In the logistic regression (binary outcomes), the Marginal Structural Model (MSM) model is specified as: --&gt;</span></span>
<span id="cb32-301"><a href="#cb32-301" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb32-302"><a href="#cb32-302" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \text{Logit}(E[Y^a]) = \beta_0 + \beta_1 a, --&gt;</span></span>
<span id="cb32-303"><a href="#cb32-303" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb32-304"><a href="#cb32-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-305"><a href="#cb32-305" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- where $a$ is the treatment indicator (0 for no treatment, 1 for treatment). --&gt;</span></span>
<span id="cb32-306"><a href="#cb32-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-307"><a href="#cb32-307" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Calculation for$Y^{a=0}$(No Treatment) --&gt;</span></span>
<span id="cb32-308"><a href="#cb32-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-309"><a href="#cb32-309" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- - **Model Simplification**: when$a = 0$(no treatment), the logit model simplifies to: --&gt;</span></span>
<span id="cb32-310"><a href="#cb32-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-311"><a href="#cb32-311" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--  $$ --&gt;</span></span>
<span id="cb32-312"><a href="#cb32-312" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   \text{Logit}(E[Y^{a=0}]) = \beta_0. --&gt;</span></span>
<span id="cb32-313"><a href="#cb32-313" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--  $$ --&gt;</span></span>
<span id="cb32-314"><a href="#cb32-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-315"><a href="#cb32-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-316"><a href="#cb32-316" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- - **Expected Outcome**: To find$E[Y^{a=0}]$, convert the logit back to probability: --&gt;</span></span>
<span id="cb32-317"><a href="#cb32-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-318"><a href="#cb32-318" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--  $$ --&gt;</span></span>
<span id="cb32-319"><a href="#cb32-319" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   E[Y^{a=0}] = \frac{e^{\beta_0}}{1 + e^{\beta_0}} --&gt;</span></span>
<span id="cb32-320"><a href="#cb32-320" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--  $$ --&gt;</span></span>
<span id="cb32-321"><a href="#cb32-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-322"><a href="#cb32-322" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   This formula gives the predicted probability of the outcome occurring when there is no treatment. --&gt;</span></span>
<span id="cb32-323"><a href="#cb32-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-324"><a href="#cb32-324" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Calculation for$Y^{a=1}$(Treatment Given) --&gt;</span></span>
<span id="cb32-325"><a href="#cb32-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-326"><a href="#cb32-326" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- - **Model Specification**: when$a = 1$(treatment given), the logit model is: --&gt;</span></span>
<span id="cb32-327"><a href="#cb32-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-328"><a href="#cb32-328" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--  $$ --&gt;</span></span>
<span id="cb32-329"><a href="#cb32-329" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   \text{Logit}(E[Y^{a=1}]) = \beta_0 + \beta_1. --&gt;</span></span>
<span id="cb32-330"><a href="#cb32-330" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--  $$ --&gt;</span></span>
<span id="cb32-331"><a href="#cb32-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-332"><a href="#cb32-332" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- - **Expected Outcome**: To find$E[Y^{a=1}]$, similarly convert the logit to probability: --&gt;</span></span>
<span id="cb32-333"><a href="#cb32-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-334"><a href="#cb32-334" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--  $$ --&gt;</span></span>
<span id="cb32-335"><a href="#cb32-335" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   E[Y^{a=1}] = \frac{e^{\beta_0 + \beta_1}}{1 + e^{\beta_0 + \beta_1}}. --&gt;</span></span>
<span id="cb32-336"><a href="#cb32-336" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--  $$ --&gt;</span></span>
<span id="cb32-337"><a href="#cb32-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-338"><a href="#cb32-338" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   This is the predicted probability of the outcome occurring when the treatment is applied. --&gt;</span></span>
<span id="cb32-339"><a href="#cb32-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-340"><a href="#cb32-340" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Example of MSM --&gt;</span></span>
<span id="cb32-341"><a href="#cb32-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-342"><a href="#cb32-342" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Suppose$\beta_0 = -0.5$and$\beta_1 = 0.8$. Then: --&gt;</span></span>
<span id="cb32-343"><a href="#cb32-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-344"><a href="#cb32-344" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- - **No Treatment**:  --&gt;</span></span>
<span id="cb32-345"><a href="#cb32-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-346"><a href="#cb32-346" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--  $$ --&gt;</span></span>
<span id="cb32-347"><a href="#cb32-347" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   E[Y^{a=0}] = \frac{e^{-0.5}}{1 + e^{-0.5}} \approx \frac{0.607}{1.607} \approx 0.378, --&gt;</span></span>
<span id="cb32-348"><a href="#cb32-348" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--  $$ --&gt;</span></span>
<span id="cb32-349"><a href="#cb32-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-350"><a href="#cb32-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-351"><a href="#cb32-351" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- indicating a 37.8% probability of the outcome occurring without treatment. --&gt;</span></span>
<span id="cb32-352"><a href="#cb32-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-353"><a href="#cb32-353" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- - **With Treatment**: --&gt;</span></span>
<span id="cb32-354"><a href="#cb32-354" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--  $$ --&gt;</span></span>
<span id="cb32-355"><a href="#cb32-355" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   E[Y^{a=1}] = \frac{e^{-0.5 + 0.8}}{1 + e^{-0.5 + 0.8}} = \frac{e^{0.3}}{1 + e^{0.3}} \approx \frac{1.35}{2.35} \approx 0.574, --&gt;</span></span>
<span id="cb32-356"><a href="#cb32-356" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--  $$ --&gt;</span></span>
<span id="cb32-357"><a href="#cb32-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-358"><a href="#cb32-358" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- indicating a 57.4% probability of the outcome occurring with treatment. --&gt;</span></span>
<span id="cb32-359"><a href="#cb32-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-360"><a href="#cb32-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-361"><a href="#cb32-361" aria-hidden="true" tabindex="-1"></a><span class="fu">###  How can we apply marginal structural models in subgroups? </span></span>
<span id="cb32-362"><a href="#cb32-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-363"><a href="#cb32-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-364"><a href="#cb32-364" aria-hidden="true" tabindex="-1"></a><span class="fu">### Assumptions</span></span>
<span id="cb32-365"><a href="#cb32-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-366"><a href="#cb32-366" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Model assumptions**: the treatment model is correctly specified.</span>
<span id="cb32-367"><a href="#cb32-367" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Causal assumptions**: all confounders are appropriately controlled, positivity and consistency assumptions hold.</span>
<span id="cb32-368"><a href="#cb32-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-369"><a href="#cb32-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-370"><a href="#cb32-370" aria-hidden="true" tabindex="-1"></a><span class="fu">### Calculating Treatment Weights (Propensity Scores) and Confounding Control in Subgroups</span></span>
<span id="cb32-371"><a href="#cb32-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-372"><a href="#cb32-372" aria-hidden="true" tabindex="-1"></a>We may often achieve greater balance when conducting weighted analyses in subgroups by estimating propensity scores *within* these subgroups. The propensity score $ e(L, G) $ is the conditional probability of receiving the exposure $ A = 1 $, given the covariates $ L $ and subgroup indicator $ G $. This is often modelled using logistic regression or other methods that ensure covariate balance</span>
<span id="cb32-373"><a href="#cb32-373" aria-hidden="true" tabindex="-1"></a>We define the estimated propensity score as follows:</span>
<span id="cb32-374"><a href="#cb32-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-375"><a href="#cb32-375" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-376"><a href="#cb32-376" aria-hidden="true" tabindex="-1"></a>\hat{e} = P(A = 1 \mid L, G) = f_A(L, G; \theta_A)</span>
<span id="cb32-377"><a href="#cb32-377" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-378"><a href="#cb32-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-379"><a href="#cb32-379" aria-hidden="true" tabindex="-1"></a>Here, $ f_A(L, G; \theta_A) $ is the statistical model estimating the probability of exposure $A = 1$ given covariates $L$ and subgroup $G$. We then calculate the weights for each individual, denoted $v$, using the estimated propensity score:</span>
<span id="cb32-380"><a href="#cb32-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-381"><a href="#cb32-381" aria-hidden="true" tabindex="-1"></a>$\theta_A$ encapsulates all the coefficients (parameters) in this model, including intercepts, slopes, and potentially other parameters depending on the model complexity (e.g., interaction terms, non-linear effects...etc).</span>
<span id="cb32-382"><a href="#cb32-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-383"><a href="#cb32-383" aria-hidden="true" tabindex="-1"></a>These weights $v$ depend on $A$ and are calculated as the inverse of the propensity score for exposed individuals and as the inverse of $ 1-\hat{e} $ for unexposed individuals.</span>
<span id="cb32-384"><a href="#cb32-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-385"><a href="#cb32-385" aria-hidden="true" tabindex="-1"></a>Propensity scores are estimated *separately* within strata of the subgroup to control for potential confounding tailored to each subgroup. These weights $v$ are specific to each individual in subgroup $G$. In the lab, we will clarify how to fit models to estimate contrasts for the causal effects within groups $\hat{\delta}_{g}, \hat{\delta}_{g'}$, etc., and how to obtain estimates for group-wise differences:</span>
<span id="cb32-386"><a href="#cb32-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-387"><a href="#cb32-387" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-388"><a href="#cb32-388" aria-hidden="true" tabindex="-1"></a>\hat{\gamma} = \overbrace{\big( \hat{E}<span class="co">[</span><span class="ot">Y^a \mid G=g</span><span class="co">]</span> - \hat{E}<span class="co">[</span><span class="ot">Y^{a'} \mid G=g</span><span class="co">]</span> \big)}^{\hat{\delta}_g} - \overbrace{\big( \hat{E}[Y^{a'} \mid G=g'] - \hat{E}[Y^a \mid G=g'] \big)}^{\hat{\delta}_{g'}}</span>
<span id="cb32-389"><a href="#cb32-389" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-390"><a href="#cb32-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-391"><a href="#cb32-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-392"><a href="#cb32-392" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**$\hat{E}[Y^a \mid G=g]$**: Estimated expected outcome when treatment $a$ is applied to subgroup $G=g$.</span>
<span id="cb32-393"><a href="#cb32-393" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**$\hat{E}[Y^{a'} \mid G=g]$**: Estimated expected outcome when a different treatment or control $a'$ is applied to the same subgroup $G=g$.</span>
<span id="cb32-394"><a href="#cb32-394" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**$\hat{\delta}_g$**: Represents the estimated treatment effect within subgroup $G=g$, computed as the difference in expected outcomes between treatment $a$ and $a'$ within this subgroup.</span>
<span id="cb32-395"><a href="#cb32-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-396"><a href="#cb32-396" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**$\hat{E}[Y^{a'} \mid G=g']$**: Estimated expected outcome when treatment $a'$ is applied to a different subgroup $G=g'$.</span>
<span id="cb32-397"><a href="#cb32-397" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**$\hat{E}[Y^a \mid G=g']$**: Estimated expected outcome when treatment $a$ is applied to subgroup $G=g'$.</span>
<span id="cb32-398"><a href="#cb32-398" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**$\hat{\delta}_{g'}$**: Represents the estimated treatment effect within subgroup $G=g'$, computed as the difference in expected outcomes between treatment $a'$ and $a$ within this subgroup.</span>
<span id="cb32-399"><a href="#cb32-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-400"><a href="#cb32-400" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**$\hat{\gamma}$**: The overall measure calculated from your formula represents the difference in treatment effects between two subgroups, $G=g$ and $G=g'$. It quantifies how the effect of switching between treatments $a$ and $a'$ differs across the two subgroups.</span>
<span id="cb32-401"><a href="#cb32-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-402"><a href="#cb32-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-403"><a href="#cb32-403" aria-hidden="true" tabindex="-1"></a><span class="fu">### Considerations</span></span>
<span id="cb32-404"><a href="#cb32-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-405"><a href="#cb32-405" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Estimation**: to estimate the expected outcomes $\hat{E}<span class="co">[</span><span class="ot">Y^a \mid G</span><span class="co">]</span>$ and $\hat{E}<span class="co">[</span><span class="ot">Y^{a'} \mid G</span><span class="co">]</span>$, we require statistical models. If we use regression, we include interaction terms between treatment and subgroup indicators to directly estimate subgroup-specific treatment effects. Our use depends on correct model specification.</span>
<span id="cb32-406"><a href="#cb32-406" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Confidence intervals**: we may compute confidence intervals for $\hat{\gamma}$ using bootstrap, the delta method, or -- in our excercises -- simulation based methods.</span>
<span id="cb32-407"><a href="#cb32-407" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Causal assumptions**: again, a causal interpretation of $\hat{\gamma}$ relies on satisfying both causal assumptions and modelling assumptions.  Here, we have described estimation using propensity scores.</span>
<span id="cb32-408"><a href="#cb32-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-409"><a href="#cb32-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-410"><a href="#cb32-410" aria-hidden="true" tabindex="-1"></a><span class="fu">## Doubly Robust Estimation</span></span>
<span id="cb32-411"><a href="#cb32-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-412"><a href="#cb32-412" aria-hidden="true" tabindex="-1"></a>We can combine regression-based estimation with propensity score estimation to obtain *doubly robust* estimation. I will walk you through the steps in the lab. The TL;DR is this: doubly robust estimation reduces reliance on correct model specification. If either the PS model or the regression model is correctly specified, the model will be unbiased -- if the other causal inference assumptions are met.</span>
<span id="cb32-413"><a href="#cb32-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-414"><a href="#cb32-414" aria-hidden="true" tabindex="-1"></a>We cannot know whether these assumptions are met, we will need to do a sensitivity analysis, the topic of next week.</span>
<span id="cb32-415"><a href="#cb32-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-416"><a href="#cb32-416" aria-hidden="true" tabindex="-1"></a>I'll show you in lab how to employ simulation-based inference methods to compute standard errors and confidence intervals, following the approaches suggested by Greifer (2023)[].</span>
<span id="cb32-417"><a href="#cb32-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-418"><a href="#cb32-418" aria-hidden="true" tabindex="-1"></a><span class="fu">## Readings:</span></span>
<span id="cb32-419"><a href="#cb32-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-420"><a href="#cb32-420" aria-hidden="true" tabindex="-1"></a>Noah Griefer's Software and Blogs: <span class="co">[</span><span class="ot">https://ngreifer.github.io/blog/subgroup-analysis-psm/</span><span class="co">](https://ngreifer.github.io/blog/)</span></span>
<span id="cb32-421"><a href="#cb32-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-422"><a href="#cb32-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-423"><a href="#cb32-423" aria-hidden="true" tabindex="-1"></a><span class="fu"># Lab</span></span>
<span id="cb32-424"><a href="#cb32-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-425"><a href="#cb32-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-426"><a href="#cb32-426" aria-hidden="true" tabindex="-1"></a>Today we estimate causal effects</span>
<span id="cb32-427"><a href="#cb32-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-430"><a href="#cb32-430" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-431"><a href="#cb32-431" aria-hidden="true" tabindex="-1"></a><span class="co"># uncomment, update the margot package</span></span>
<span id="cb32-432"><a href="#cb32-432" aria-hidden="true" tabindex="-1"></a><span class="co"># devtools::install_github("go-bayes/margot")</span></span>
<span id="cb32-433"><a href="#cb32-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-434"><a href="#cb32-434" aria-hidden="true" tabindex="-1"></a><span class="co"># load packages</span></span>
<span id="cb32-435"><a href="#cb32-435" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb32-436"><a href="#cb32-436" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(margot)</span>
<span id="cb32-437"><a href="#cb32-437" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(skimr)</span>
<span id="cb32-438"><a href="#cb32-438" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(naniar)</span>
<span id="cb32-439"><a href="#cb32-439" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(WeightIt)</span>
<span id="cb32-440"><a href="#cb32-440" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(clarify)</span>
<span id="cb32-441"><a href="#cb32-441" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MatchThem)</span>
<span id="cb32-442"><a href="#cb32-442" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cobalt)</span>
<span id="cb32-443"><a href="#cb32-443" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MatchIt)</span>
<span id="cb32-444"><a href="#cb32-444" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb32-445"><a href="#cb32-445" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmtp)</span>
<span id="cb32-446"><a href="#cb32-446" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SuperLearner)</span>
<span id="cb32-447"><a href="#cb32-447" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ranger)</span>
<span id="cb32-448"><a href="#cb32-448" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(xgboost)</span>
<span id="cb32-449"><a href="#cb32-449" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nnls)</span>
<span id="cb32-450"><a href="#cb32-450" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mice)</span>
<span id="cb32-451"><a href="#cb32-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-452"><a href="#cb32-452" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"doParallel"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb32-453"><a href="#cb32-453" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"doParallel"</span>)</span>
<span id="cb32-454"><a href="#cb32-454" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-455"><a href="#cb32-455" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"foreach"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb32-456"><a href="#cb32-456" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"foreach"</span>)</span>
<span id="cb32-457"><a href="#cb32-457" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-458"><a href="#cb32-458" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doParallel)</span>
<span id="cb32-459"><a href="#cb32-459" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreach)</span>
<span id="cb32-460"><a href="#cb32-460" aria-hidden="true" tabindex="-1"></a><span class="co"># createmiceadds# create a folder names saved (you should have done this last week).</span></span>
<span id="cb32-461"><a href="#cb32-461" aria-hidden="true" tabindex="-1"></a><span class="co"># set your path to this folder</span></span>
<span id="cb32-462"><a href="#cb32-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-463"><a href="#cb32-463" aria-hidden="true" tabindex="-1"></a><span class="co"># save in cloud if using github</span></span>
<span id="cb32-464"><a href="#cb32-464" aria-hidden="true" tabindex="-1"></a>push_mods <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">'/Users/joseph/Library/CloudStorage/Dropbox-v-project/data/saved'</span>)</span>
<span id="cb32-465"><a href="#cb32-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-466"><a href="#cb32-466" aria-hidden="true" tabindex="-1"></a><span class="co"># check it is correct</span></span>
<span id="cb32-467"><a href="#cb32-467" aria-hidden="true" tabindex="-1"></a><span class="co"># uncomment, check</span></span>
<span id="cb32-468"><a href="#cb32-468" aria-hidden="true" tabindex="-1"></a><span class="co">#push_mods</span></span>
<span id="cb32-469"><a href="#cb32-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-470"><a href="#cb32-470" aria-hidden="true" tabindex="-1"></a><span class="co"># set seed for reproducability</span></span>
<span id="cb32-471"><a href="#cb32-471" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb32-472"><a href="#cb32-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-473"><a href="#cb32-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-474"><a href="#cb32-474" aria-hidden="true" tabindex="-1"></a><span class="co"># eliminate haven labels</span></span>
<span id="cb32-475"><a href="#cb32-475" aria-hidden="true" tabindex="-1"></a>df_nz <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(df_nz)</span>
<span id="cb32-476"><a href="#cb32-476" aria-hidden="true" tabindex="-1"></a>df_nz <span class="ot">&lt;-</span> haven<span class="sc">::</span><span class="fu">zap_formats</span>(df_nz)</span>
<span id="cb32-477"><a href="#cb32-477" aria-hidden="true" tabindex="-1"></a>df_nz <span class="ot">&lt;-</span> haven<span class="sc">::</span><span class="fu">zap_label</span>(df_nz)</span>
<span id="cb32-478"><a href="#cb32-478" aria-hidden="true" tabindex="-1"></a>df_nz <span class="ot">&lt;-</span> haven<span class="sc">::</span><span class="fu">zap_widths</span>(df_nz)</span>
<span id="cb32-479"><a href="#cb32-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-480"><a href="#cb32-480" aria-hidden="true" tabindex="-1"></a><span class="co"># read functions</span></span>
<span id="cb32-481"><a href="#cb32-481" aria-hidden="true" tabindex="-1"></a><span class="co"># source("/Users/joseph/GIT/templates/functions/funs.R")</span></span>
<span id="cb32-482"><a href="#cb32-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-483"><a href="#cb32-483" aria-hidden="true" tabindex="-1"></a><span class="co"># experimental functions (more functions)</span></span>
<span id="cb32-484"><a href="#cb32-484" aria-hidden="true" tabindex="-1"></a><span class="co"># source(</span></span>
<span id="cb32-485"><a href="#cb32-485" aria-hidden="true" tabindex="-1"></a><span class="co">#   "https://raw.githubusercontent.com/go-bayes/templates/main/functions/experimental_funs.R"</span></span>
<span id="cb32-486"><a href="#cb32-486" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb32-487"><a href="#cb32-487" aria-hidden="true" tabindex="-1"></a><span class="co"># # set exposure name</span></span>
<span id="cb32-488"><a href="#cb32-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-489"><a href="#cb32-489" aria-hidden="true" tabindex="-1"></a>name_exposure <span class="ot">&lt;-</span>  <span class="st">"perfectionism"</span></span>
<span id="cb32-490"><a href="#cb32-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-491"><a href="#cb32-491" aria-hidden="true" tabindex="-1"></a><span class="co"># check missing values</span></span>
<span id="cb32-492"><a href="#cb32-492" aria-hidden="true" tabindex="-1"></a>skimr<span class="sc">::</span><span class="fu">skim</span>(df_nz) <span class="sc">|&gt;</span> <span class="fu">arrange</span>(n_missing)</span>
<span id="cb32-493"><a href="#cb32-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-494"><a href="#cb32-494" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain ids for individuals who participated in 2018 and have no missing baseline exposure</span></span>
<span id="cb32-495"><a href="#cb32-495" aria-hidden="true" tabindex="-1"></a>ids_2018 <span class="ot">&lt;-</span> df_nz <span class="sc">|&gt;</span></span>
<span id="cb32-496"><a href="#cb32-496" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(year_measured <span class="sc">==</span> <span class="dv">1</span>, wave <span class="sc">==</span> <span class="dv">2018</span>) <span class="sc">|&gt;</span></span>
<span id="cb32-497"><a href="#cb32-497" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_exposure))) <span class="sc">|&gt;</span> <span class="co"># criteria, no missing</span></span>
<span id="cb32-498"><a href="#cb32-498" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(eth_cat)) <span class="sc">|&gt;</span> <span class="co"># criteria, no missing</span></span>
<span id="cb32-499"><a href="#cb32-499" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(id)</span>
<span id="cb32-500"><a href="#cb32-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-501"><a href="#cb32-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-502"><a href="#cb32-502" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain ids for individuals who participated in 2019</span></span>
<span id="cb32-503"><a href="#cb32-503" aria-hidden="true" tabindex="-1"></a>ids_2019 <span class="ot">&lt;-</span> df_nz <span class="sc">|&gt;</span></span>
<span id="cb32-504"><a href="#cb32-504" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(year_measured <span class="sc">==</span> <span class="dv">1</span>, wave <span class="sc">==</span> <span class="dv">2019</span>) <span class="sc">|&gt;</span></span>
<span id="cb32-505"><a href="#cb32-505" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_exposure))) <span class="sc">|&gt;</span> <span class="co"># criteria, no missing</span></span>
<span id="cb32-506"><a href="#cb32-506" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(id)</span>
<span id="cb32-507"><a href="#cb32-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-508"><a href="#cb32-508" aria-hidden="true" tabindex="-1"></a><span class="co"># intersect IDs from 2018 and 2019 to ensure participation in both years</span></span>
<span id="cb32-509"><a href="#cb32-509" aria-hidden="true" tabindex="-1"></a>ids_2018_2019 <span class="ot">&lt;-</span> <span class="fu">intersect</span>(ids_2018, ids_2019)</span>
<span id="cb32-510"><a href="#cb32-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-511"><a href="#cb32-511" aria-hidden="true" tabindex="-1"></a><span class="co"># data wrangling</span></span>
<span id="cb32-512"><a href="#cb32-512" aria-hidden="true" tabindex="-1"></a>dat_long <span class="ot">&lt;-</span> df_nz <span class="sc">|&gt;</span></span>
<span id="cb32-513"><a href="#cb32-513" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(id <span class="sc">%in%</span> ids_2018_2019 <span class="sc">&amp;</span></span>
<span id="cb32-514"><a href="#cb32-514" aria-hidden="true" tabindex="-1"></a>                  wave <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2018</span>, <span class="dv">2019</span>, <span class="dv">2020</span>)) <span class="sc">|&gt;</span></span>
<span id="cb32-515"><a href="#cb32-515" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id, wave) <span class="sc">|&gt;</span></span>
<span id="cb32-516"><a href="#cb32-516" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb32-517"><a href="#cb32-517" aria-hidden="true" tabindex="-1"></a>    <span class="st">"id"</span>,</span>
<span id="cb32-518"><a href="#cb32-518" aria-hidden="true" tabindex="-1"></a>    <span class="st">"wave"</span>,</span>
<span id="cb32-519"><a href="#cb32-519" aria-hidden="true" tabindex="-1"></a>    <span class="st">"year_measured"</span>,</span>
<span id="cb32-520"><a href="#cb32-520" aria-hidden="true" tabindex="-1"></a>    <span class="st">"age"</span>,</span>
<span id="cb32-521"><a href="#cb32-521" aria-hidden="true" tabindex="-1"></a>    <span class="st">"male"</span>,</span>
<span id="cb32-522"><a href="#cb32-522" aria-hidden="true" tabindex="-1"></a>    <span class="st">"born_nz"</span>,</span>
<span id="cb32-523"><a href="#cb32-523" aria-hidden="true" tabindex="-1"></a>    <span class="st">"eth_cat"</span>,</span>
<span id="cb32-524"><a href="#cb32-524" aria-hidden="true" tabindex="-1"></a>    <span class="co">#factor(EthCat, labels = c("Euro", "Maori", "Pacific", "Asian")),</span></span>
<span id="cb32-525"><a href="#cb32-525" aria-hidden="true" tabindex="-1"></a>    <span class="st">"employed"</span>,</span>
<span id="cb32-526"><a href="#cb32-526" aria-hidden="true" tabindex="-1"></a>    <span class="co"># are you currently employed? (this includes self-employment or casual work)</span></span>
<span id="cb32-527"><a href="#cb32-527" aria-hidden="true" tabindex="-1"></a>    <span class="st">"edu"</span>,</span>
<span id="cb32-528"><a href="#cb32-528" aria-hidden="true" tabindex="-1"></a>    <span class="co"># "gen_cohort",</span></span>
<span id="cb32-529"><a href="#cb32-529" aria-hidden="true" tabindex="-1"></a>    <span class="st">"household_inc"</span>,</span>
<span id="cb32-530"><a href="#cb32-530" aria-hidden="true" tabindex="-1"></a>    <span class="st">"partner"</span>,</span>
<span id="cb32-531"><a href="#cb32-531" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 0 = no, 1 = yes</span></span>
<span id="cb32-532"><a href="#cb32-532" aria-hidden="true" tabindex="-1"></a>    <span class="st">"parent"</span>,</span>
<span id="cb32-533"><a href="#cb32-533" aria-hidden="true" tabindex="-1"></a>    <span class="co">#"alert_level_combined_lead", # see bibliography</span></span>
<span id="cb32-534"><a href="#cb32-534" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 0 = no, 1 = yes</span></span>
<span id="cb32-535"><a href="#cb32-535" aria-hidden="true" tabindex="-1"></a>    <span class="st">"political_conservative"</span>, <span class="co"># see nzavs sheet</span></span>
<span id="cb32-536"><a href="#cb32-536" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hours_exercise"</span>, <span class="co"># see nzavs sheet</span></span>
<span id="cb32-537"><a href="#cb32-537" aria-hidden="true" tabindex="-1"></a>    <span class="st">"agreeableness"</span>, </span>
<span id="cb32-538"><a href="#cb32-538" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mini-IPIP6 Agreeableness (also modelled as empathy facet)</span></span>
<span id="cb32-539"><a href="#cb32-539" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sympathize with others' feelings.</span></span>
<span id="cb32-540"><a href="#cb32-540" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Am not interested in other people's problems.</span></span>
<span id="cb32-541"><a href="#cb32-541" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Feel others' emotions.</span></span>
<span id="cb32-542"><a href="#cb32-542" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Am not really interested in others.</span></span>
<span id="cb32-543"><a href="#cb32-543" aria-hidden="true" tabindex="-1"></a>    <span class="st">"conscientiousness"</span>,</span>
<span id="cb32-544"><a href="#cb32-544" aria-hidden="true" tabindex="-1"></a>    <span class="co"># see mini ipip6</span></span>
<span id="cb32-545"><a href="#cb32-545" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get chores done right away.</span></span>
<span id="cb32-546"><a href="#cb32-546" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Like order.</span></span>
<span id="cb32-547"><a href="#cb32-547" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make a mess of things.</span></span>
<span id="cb32-548"><a href="#cb32-548" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Often forget to put things back in their proper place.</span></span>
<span id="cb32-549"><a href="#cb32-549" aria-hidden="true" tabindex="-1"></a>    <span class="st">"extraversion"</span>,</span>
<span id="cb32-550"><a href="#cb32-550" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mini-IPIP6 Extraversion</span></span>
<span id="cb32-551"><a href="#cb32-551" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Am the life of the party.</span></span>
<span id="cb32-552"><a href="#cb32-552" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Don't talk a lot.</span></span>
<span id="cb32-553"><a href="#cb32-553" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keep in the background.</span></span>
<span id="cb32-554"><a href="#cb32-554" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Talk to a lot of different people at parties.</span></span>
<span id="cb32-555"><a href="#cb32-555" aria-hidden="true" tabindex="-1"></a>    <span class="st">"honesty_humility"</span>,</span>
<span id="cb32-556"><a href="#cb32-556" aria-hidden="true" tabindex="-1"></a>    <span class="co"># see mini ipip6</span></span>
<span id="cb32-557"><a href="#cb32-557" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Would like to be seen driving around in a very expensive car.</span></span>
<span id="cb32-558"><a href="#cb32-558" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Would get a lot of pleasure from owning expensive luxury goods.</span></span>
<span id="cb32-559"><a href="#cb32-559" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Feel entitled to more of everything.</span></span>
<span id="cb32-560"><a href="#cb32-560" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Deserve more things in life.</span></span>
<span id="cb32-561"><a href="#cb32-561" aria-hidden="true" tabindex="-1"></a>    <span class="st">"openness"</span>,</span>
<span id="cb32-562"><a href="#cb32-562" aria-hidden="true" tabindex="-1"></a>    <span class="co"># see mini ipip6</span></span>
<span id="cb32-563"><a href="#cb32-563" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Have a vivid imagination.</span></span>
<span id="cb32-564"><a href="#cb32-564" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Have difficulty understanding abstract ideas.</span></span>
<span id="cb32-565"><a href="#cb32-565" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Do not have a good imagination.</span></span>
<span id="cb32-566"><a href="#cb32-566" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Am not interested in abstract ideas.</span></span>
<span id="cb32-567"><a href="#cb32-567" aria-hidden="true" tabindex="-1"></a>    <span class="st">"neuroticism"</span>,</span>
<span id="cb32-568"><a href="#cb32-568" aria-hidden="true" tabindex="-1"></a>    <span class="co"># see mini ipip6</span></span>
<span id="cb32-569"><a href="#cb32-569" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Have frequent mood swings.</span></span>
<span id="cb32-570"><a href="#cb32-570" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Am relaxed most of the time.</span></span>
<span id="cb32-571"><a href="#cb32-571" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get upset easily.</span></span>
<span id="cb32-572"><a href="#cb32-572" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Seldom feel blue.</span></span>
<span id="cb32-573"><a href="#cb32-573" aria-hidden="true" tabindex="-1"></a>    <span class="st">"modesty"</span>,</span>
<span id="cb32-574"><a href="#cb32-574" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # see mini ipip6</span></span>
<span id="cb32-575"><a href="#cb32-575" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # I want people to know that I am an important person of high status,</span></span>
<span id="cb32-576"><a href="#cb32-576" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # I am an ordinary person who is no better than others.</span></span>
<span id="cb32-577"><a href="#cb32-577" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # I wouldn’t want people to treat me as though I were superior to them.</span></span>
<span id="cb32-578"><a href="#cb32-578" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # I think that I am entitled to more respect than the average person is</span></span>
<span id="cb32-579"><a href="#cb32-579" aria-hidden="true" tabindex="-1"></a>    <span class="co">#"w_gend_age_ethnic",</span></span>
<span id="cb32-580"><a href="#cb32-580" aria-hidden="true" tabindex="-1"></a>    <span class="st">"neighbourhood_community"</span>,</span>
<span id="cb32-581"><a href="#cb32-581" aria-hidden="true" tabindex="-1"></a>    <span class="co"># #I feel a sense of community with others in my local neighbourhood.</span></span>
<span id="cb32-582"><a href="#cb32-582" aria-hidden="true" tabindex="-1"></a>    <span class="st">"belong"</span>, <span class="co"># see nzavs sheet</span></span>
<span id="cb32-583"><a href="#cb32-583" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rural_gch_2018_l"</span>,<span class="co"># see nzavs sheet</span></span>
<span id="cb32-584"><a href="#cb32-584" aria-hidden="true" tabindex="-1"></a>    <span class="st">"support"</span>,</span>
<span id="cb32-585"><a href="#cb32-585" aria-hidden="true" tabindex="-1"></a>    <span class="co"># "support_help",</span></span>
<span id="cb32-586"><a href="#cb32-586" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # 'There are people I can depend on to help me if I really need it.</span></span>
<span id="cb32-587"><a href="#cb32-587" aria-hidden="true" tabindex="-1"></a>    <span class="co"># "support_turnto",</span></span>
<span id="cb32-588"><a href="#cb32-588" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # There is no one I can turn to for guidance in times of stress.</span></span>
<span id="cb32-589"><a href="#cb32-589" aria-hidden="true" tabindex="-1"></a>    <span class="co"># "support_rnoguidance",</span></span>
<span id="cb32-590"><a href="#cb32-590" aria-hidden="true" tabindex="-1"></a>    <span class="co">#There is no one I can turn to for guidance in times of stress.</span></span>
<span id="cb32-591"><a href="#cb32-591" aria-hidden="true" tabindex="-1"></a>    <span class="st">"perfectionism"</span>,</span>
<span id="cb32-592"><a href="#cb32-592" aria-hidden="true" tabindex="-1"></a>    <span class="st">"religion_religious"</span>,</span>
<span id="cb32-593"><a href="#cb32-593" aria-hidden="true" tabindex="-1"></a>    <span class="st">"kessler_latent_depression"</span>,</span>
<span id="cb32-594"><a href="#cb32-594" aria-hidden="true" tabindex="-1"></a>    <span class="st">"kessler_latent_anxiety"</span></span>
<span id="cb32-595"><a href="#cb32-595" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb32-596"><a href="#cb32-596" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-597"><a href="#cb32-597" aria-hidden="true" tabindex="-1"></a>    <span class="co">#initialize 'censored'</span></span>
<span id="cb32-598"><a href="#cb32-598" aria-hidden="true" tabindex="-1"></a>    <span class="at">censored =</span> <span class="fu">ifelse</span>(<span class="fu">lead</span>(year_measured) <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb32-599"><a href="#cb32-599" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-600"><a href="#cb32-600" aria-hidden="true" tabindex="-1"></a>    <span class="co"># modify 'censored' based on the condition; no need to check for NA here as 'censored' is already defined in the previous step</span></span>
<span id="cb32-601"><a href="#cb32-601" aria-hidden="true" tabindex="-1"></a>    <span class="at">censored =</span>  <span class="fu">ifelse</span>(<span class="fu">is.na</span>(censored) <span class="sc">&amp;</span></span>
<span id="cb32-602"><a href="#cb32-602" aria-hidden="true" tabindex="-1"></a>                         year_measured <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, censored),</span>
<span id="cb32-603"><a href="#cb32-603" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create urban binary variable</span></span>
<span id="cb32-604"><a href="#cb32-604" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-605"><a href="#cb32-605" aria-hidden="true" tabindex="-1"></a>    <span class="at">urban =</span> <span class="fu">ifelse</span>(rural_gch_2018_l <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb32-606"><a href="#cb32-606" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-607"><a href="#cb32-607" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb32-608"><a href="#cb32-608" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(year_measured, rural_gch_2018_l) )<span class="sc">|&gt;</span></span>
<span id="cb32-609"><a href="#cb32-609" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb32-610"><a href="#cb32-610" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rescale these variables, to get all variables on a similar scale</span></span>
<span id="cb32-611"><a href="#cb32-611" aria-hidden="true" tabindex="-1"></a>    <span class="co"># otherwise your models can blow up, or become uninterpretable. </span></span>
<span id="cb32-612"><a href="#cb32-612" aria-hidden="true" tabindex="-1"></a>    <span class="at">household_inc_log =</span> <span class="fu">log</span>(household_inc <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb32-613"><a href="#cb32-613" aria-hidden="true" tabindex="-1"></a>    <span class="at">hours_exercise_log =</span> <span class="fu">log</span>(hours_exercise <span class="sc">+</span> <span class="dv">1</span>)  ) <span class="sc">|&gt;</span></span>
<span id="cb32-614"><a href="#cb32-614" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb32-615"><a href="#cb32-615" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span><span class="fu">c</span>(</span>
<span id="cb32-616"><a href="#cb32-616" aria-hidden="true" tabindex="-1"></a>      household_inc,</span>
<span id="cb32-617"><a href="#cb32-617" aria-hidden="true" tabindex="-1"></a>      hours_exercise)</span>
<span id="cb32-618"><a href="#cb32-618" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb32-619"><a href="#cb32-619" aria-hidden="true" tabindex="-1"></a>  <span class="fu">droplevels</span>() <span class="sc">|&gt;</span></span>
<span id="cb32-620"><a href="#cb32-620" aria-hidden="true" tabindex="-1"></a>  <span class="co"># dplyr::rename(sample_weights = w_gend_age_ethnic,</span></span>
<span id="cb32-621"><a href="#cb32-621" aria-hidden="true" tabindex="-1"></a>  <span class="co">#               sample_origin =  sample_origin_names_combined) |&gt;</span></span>
<span id="cb32-622"><a href="#cb32-622" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id, wave) <span class="sc">|&gt;</span></span>
<span id="cb32-623"><a href="#cb32-623" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-624"><a href="#cb32-624" aria-hidden="true" tabindex="-1"></a>    <span class="at">urban =</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(urban)),</span>
<span id="cb32-625"><a href="#cb32-625" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   parent = as.numeric(as.character(parent)),</span></span>
<span id="cb32-626"><a href="#cb32-626" aria-hidden="true" tabindex="-1"></a>    <span class="at">partner =</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(partner)),</span>
<span id="cb32-627"><a href="#cb32-627" aria-hidden="true" tabindex="-1"></a>    <span class="at">born_nz =</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(born_nz)),</span>
<span id="cb32-628"><a href="#cb32-628" aria-hidden="true" tabindex="-1"></a>    <span class="at">censored =</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(censored)),</span>
<span id="cb32-629"><a href="#cb32-629" aria-hidden="true" tabindex="-1"></a>    <span class="at">employed =</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(employed))</span>
<span id="cb32-630"><a href="#cb32-630" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb32-631"><a href="#cb32-631" aria-hidden="true" tabindex="-1"></a>  <span class="fu">droplevels</span>() <span class="sc">|&gt;</span></span>
<span id="cb32-632"><a href="#cb32-632" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id, wave) <span class="sc">|&gt;</span></span>
<span id="cb32-633"><a href="#cb32-633" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>()</span>
<span id="cb32-634"><a href="#cb32-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-635"><a href="#cb32-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-636"><a href="#cb32-636" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect data</span></span>
<span id="cb32-637"><a href="#cb32-637" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(dat_long)</span>
<span id="cb32-638"><a href="#cb32-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-639"><a href="#cb32-639" aria-hidden="true" tabindex="-1"></a><span class="co"># more thorough view</span></span>
<span id="cb32-640"><a href="#cb32-640" aria-hidden="true" tabindex="-1"></a><span class="co">#skimr::skim(dat_long)</span></span>
<span id="cb32-641"><a href="#cb32-641" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-642"><a href="#cb32-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-643"><a href="#cb32-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-644"><a href="#cb32-644" aria-hidden="true" tabindex="-1"></a>Next let's insure that we obtain 50/50 representation of gender within our estimation.  </span>
<span id="cb32-645"><a href="#cb32-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-646"><a href="#cb32-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-649"><a href="#cb32-649" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-650"><a href="#cb32-650" aria-hidden="true" tabindex="-1"></a><span class="co"># balance on gender weights</span></span>
<span id="cb32-651"><a href="#cb32-651" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate gender weights assuming male is coded as 1 and female as 0</span></span>
<span id="cb32-652"><a href="#cb32-652" aria-hidden="true" tabindex="-1"></a>prop_male_population <span class="ot">&lt;-</span></span>
<span id="cb32-653"><a href="#cb32-653" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.5</span>  <span class="co"># target proportion of males in the population</span></span>
<span id="cb32-654"><a href="#cb32-654" aria-hidden="true" tabindex="-1"></a>prop_female_population <span class="ot">&lt;-</span></span>
<span id="cb32-655"><a href="#cb32-655" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.5</span>  <span class="co"># target proportion of females in the population</span></span>
<span id="cb32-656"><a href="#cb32-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-657"><a href="#cb32-657" aria-hidden="true" tabindex="-1"></a>prop_male_sample <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat_long<span class="sc">$</span>male)</span>
<span id="cb32-658"><a href="#cb32-658" aria-hidden="true" tabindex="-1"></a>prop_female_sample <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> prop_male_sample</span>
<span id="cb32-659"><a href="#cb32-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-660"><a href="#cb32-660" aria-hidden="true" tabindex="-1"></a>gender_weight_male <span class="ot">&lt;-</span> prop_male_population <span class="sc">/</span> prop_male_sample</span>
<span id="cb32-661"><a href="#cb32-661" aria-hidden="true" tabindex="-1"></a>gender_weight_female <span class="ot">&lt;-</span> prop_female_population <span class="sc">/</span> prop_female_sample</span>
<span id="cb32-662"><a href="#cb32-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-663"><a href="#cb32-663" aria-hidden="true" tabindex="-1"></a>dat_long<span class="sc">$</span>sample_weights <span class="ot">&lt;-</span></span>
<span id="cb32-664"><a href="#cb32-664" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ifelse</span>(dat_long<span class="sc">$</span>male <span class="sc">==</span> <span class="dv">1</span>, gender_weight_male, gender_weight_female)</span>
<span id="cb32-665"><a href="#cb32-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-666"><a href="#cb32-666" aria-hidden="true" tabindex="-1"></a><span class="co"># we will upweight males and down weight non-males to obtain a balance of gender in the *target* population</span></span>
<span id="cb32-667"><a href="#cb32-667" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(dat_long<span class="sc">$</span>sample_weights)</span>
<span id="cb32-668"><a href="#cb32-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-669"><a href="#cb32-669" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-670"><a href="#cb32-670" aria-hidden="true" tabindex="-1"></a>Next let's get our data into shape.  Today we're going to consider a 'treatment' of perfectionism in which we shift people by different quantiles of perfectionism: </span>
<span id="cb32-671"><a href="#cb32-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-672"><a href="#cb32-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-673"><a href="#cb32-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-674"><a href="#cb32-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-677"><a href="#cb32-677" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-678"><a href="#cb32-678" aria-hidden="true" tabindex="-1"></a>dat_long <span class="ot">&lt;-</span></span>
<span id="cb32-679"><a href="#cb32-679" aria-hidden="true" tabindex="-1"></a>  margot<span class="sc">::</span><span class="fu">create_ordered_variable</span>(dat_long, <span class="st">"perfectionism"</span>, <span class="at">n_divisions =</span> <span class="dv">4</span>) <span class="co">#</span></span>
<span id="cb32-680"><a href="#cb32-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-681"><a href="#cb32-681" aria-hidden="true" tabindex="-1"></a><span class="co"># view scale</span></span>
<span id="cb32-682"><a href="#cb32-682" aria-hidden="true" tabindex="-1"></a><span class="co"># uncommentto see break points</span></span>
<span id="cb32-683"><a href="#cb32-683" aria-hidden="true" tabindex="-1"></a><span class="co"># print(quantile(dat_long$perfectionism, probs = seq(0, 1, 1/4), na.rm = TRUE))</span></span>
<span id="cb32-684"><a href="#cb32-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-685"><a href="#cb32-685" aria-hidden="true" tabindex="-1"></a><span class="co"># n by groups</span></span>
<span id="cb32-686"><a href="#cb32-686" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(dat_long<span class="sc">$</span>perfectionism_cat)</span>
<span id="cb32-687"><a href="#cb32-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-688"><a href="#cb32-688" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain labels if useful later</span></span>
<span id="cb32-689"><a href="#cb32-689" aria-hidden="true" tabindex="-1"></a>labels <span class="ot">&lt;-</span> <span class="fu">levels</span>(dat_long<span class="sc">$</span>perfectionism_cat)</span>
<span id="cb32-690"><a href="#cb32-690" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-691"><a href="#cb32-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-692"><a href="#cb32-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-693"><a href="#cb32-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-694"><a href="#cb32-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-695"><a href="#cb32-695" aria-hidden="true" tabindex="-1"></a><span class="fu">### Consider where the quantiles break</span></span>
<span id="cb32-696"><a href="#cb32-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-699"><a href="#cb32-699" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-700"><a href="#cb32-700" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 12</span></span>
<span id="cb32-701"><a href="#cb32-701" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 12</span></span>
<span id="cb32-702"><a href="#cb32-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-703"><a href="#cb32-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-704"><a href="#cb32-704" aria-hidden="true" tabindex="-1"></a>dt_19 <span class="ot">&lt;-</span> dat_long <span class="sc">|&gt;</span> <span class="fu">filter</span>(wave <span class="sc">==</span> <span class="dv">2019</span>)</span>
<span id="cb32-705"><a href="#cb32-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-706"><a href="#cb32-706" aria-hidden="true" tabindex="-1"></a>margot<span class="sc">::</span><span class="fu">margot_plot_categorical</span>(<span class="at">col_name =</span> <span class="st">"perfectionism"</span>,</span>
<span id="cb32-707"><a href="#cb32-707" aria-hidden="true" tabindex="-1"></a>                                    <span class="co"># custom_breaks = c(1,1.9,3.9,7),</span></span>
<span id="cb32-708"><a href="#cb32-708" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">n_divisions =</span> <span class="dv">4</span>,</span>
<span id="cb32-709"><a href="#cb32-709" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">cutpoint_inclusive =</span> <span class="st">"upper"</span>,</span>
<span id="cb32-710"><a href="#cb32-710" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">binwidth =</span> .<span class="dv">5</span>,</span>
<span id="cb32-711"><a href="#cb32-711" aria-hidden="true" tabindex="-1"></a>                                     dt_19)</span>
<span id="cb32-712"><a href="#cb32-712" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-713"><a href="#cb32-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-714"><a href="#cb32-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-715"><a href="#cb32-715" aria-hidden="true" tabindex="-1"></a><span class="fu">### Consider mean</span></span>
<span id="cb32-716"><a href="#cb32-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-719"><a href="#cb32-719" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-720"><a href="#cb32-720" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 12</span></span>
<span id="cb32-721"><a href="#cb32-721" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 12</span></span>
<span id="cb32-722"><a href="#cb32-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-723"><a href="#cb32-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-724"><a href="#cb32-724" aria-hidden="true" tabindex="-1"></a>dt_19 <span class="ot">&lt;-</span> dat_long <span class="sc">|&gt;</span> <span class="fu">filter</span>(wave <span class="sc">==</span> <span class="dv">2019</span>)</span>
<span id="cb32-725"><a href="#cb32-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-726"><a href="#cb32-726" aria-hidden="true" tabindex="-1"></a>margot<span class="sc">::</span><span class="fu">coloured_histogram_sd</span>(<span class="at">col_name =</span> <span class="st">"perfectionism"</span>, <span class="at">binwidth =</span> .<span class="dv">5</span>, dt_19)</span>
<span id="cb32-727"><a href="#cb32-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-728"><a href="#cb32-728" aria-hidden="true" tabindex="-1"></a>margot<span class="sc">::</span><span class="fu">margot_plot_shift</span>(<span class="at">col_name =</span> <span class="st">"perfectionism"</span>, <span class="at">binwidth =</span> .<span class="dv">1</span>, </span>
<span id="cb32-729"><a href="#cb32-729" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">shift =</span> <span class="st">"down"</span>,</span>
<span id="cb32-730"><a href="#cb32-730" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">range_highlight =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>),</span>
<span id="cb32-731"><a href="#cb32-731" aria-hidden="true" tabindex="-1"></a>                                 dt_19)</span>
<span id="cb32-732"><a href="#cb32-732" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-733"><a href="#cb32-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-734"><a href="#cb32-734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-735"><a href="#cb32-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-736"><a href="#cb32-736" aria-hidden="true" tabindex="-1"></a><span class="fu">### Set variables</span></span>
<span id="cb32-737"><a href="#cb32-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-738"><a href="#cb32-738" aria-hidden="true" tabindex="-1"></a>Next lets set our baseline variables</span>
<span id="cb32-739"><a href="#cb32-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-742"><a href="#cb32-742" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-743"><a href="#cb32-743" aria-hidden="true" tabindex="-1"></a>baseline_vars <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"male"</span>, <span class="st">"edu"</span>, <span class="st">"eth_cat"</span>, <span class="st">"partner"</span>, <span class="st">"employed"</span>, <span class="st">"born_nz"</span>, <span class="st">"neighbourhood_community"</span>, <span class="st">"household_inc_log"</span>, <span class="st">"parent"</span>, <span class="st">"religion_religious"</span>, <span class="st">"urban"</span>, <span class="st">"employed"</span>, <span class="st">"sample_weights"</span>)</span>
<span id="cb32-744"><a href="#cb32-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-745"><a href="#cb32-745" aria-hidden="true" tabindex="-1"></a><span class="co"># treatment</span></span>
<span id="cb32-746"><a href="#cb32-746" aria-hidden="true" tabindex="-1"></a>exposure_vars <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"perfectionism_cat"</span>) </span>
<span id="cb32-747"><a href="#cb32-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-748"><a href="#cb32-748" aria-hidden="true" tabindex="-1"></a><span class="co"># outcome, can be many</span></span>
<span id="cb32-749"><a href="#cb32-749" aria-hidden="true" tabindex="-1"></a>outcome_vars <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"kessler_latent_anxiety"</span>, <span class="st">"kessler_latent_depression"</span>)</span>
<span id="cb32-750"><a href="#cb32-750" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-751"><a href="#cb32-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-752"><a href="#cb32-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-753"><a href="#cb32-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-754"><a href="#cb32-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-755"><a href="#cb32-755" aria-hidden="true" tabindex="-1"></a><span class="fu">### Muliply impute missing values</span></span>
<span id="cb32-756"><a href="#cb32-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-757"><a href="#cb32-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-758"><a href="#cb32-758" aria-hidden="true" tabindex="-1"></a>In our first analysis we will not merely impute baseline values. Rather we will impute baseline and outcome values within quantiles of the exposure.  Consider, why should we impute within the treatments to be compared?  What are the lingering dangers of this approach? </span>
<span id="cb32-759"><a href="#cb32-759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-760"><a href="#cb32-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-761"><a href="#cb32-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-762"><a href="#cb32-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-765"><a href="#cb32-765" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-766"><a href="#cb32-766" aria-hidden="true" tabindex="-1"></a><span class="co"># make long data wide</span></span>
<span id="cb32-767"><a href="#cb32-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-768"><a href="#cb32-768" aria-hidden="true" tabindex="-1"></a><span class="co"># remove sample weights, return them later</span></span>
<span id="cb32-769"><a href="#cb32-769" aria-hidden="true" tabindex="-1"></a>prep_dat_wide <span class="ot">&lt;-</span> <span class="fu">margot_wide</span>(dat_long, </span>
<span id="cb32-770"><a href="#cb32-770" aria-hidden="true" tabindex="-1"></a>                             <span class="at">baseline_vars =</span> baseline_vars, </span>
<span id="cb32-771"><a href="#cb32-771" aria-hidden="true" tabindex="-1"></a>                             <span class="at">exposure_var =</span> exposure_vars,</span>
<span id="cb32-772"><a href="#cb32-772" aria-hidden="true" tabindex="-1"></a>                             <span class="at">outcome_vars =</span> outcome_vars)</span>
<span id="cb32-773"><a href="#cb32-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-774"><a href="#cb32-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-775"><a href="#cb32-775" aria-hidden="true" tabindex="-1"></a><span class="co"># filter data, so that we impute within quartiles</span></span>
<span id="cb32-776"><a href="#cb32-776" aria-hidden="true" tabindex="-1"></a>list_filtered_df <span class="ot">&lt;-</span></span>
<span id="cb32-777"><a href="#cb32-777" aria-hidden="true" tabindex="-1"></a>  margot<span class="sc">::</span><span class="fu">margot_filter</span>(prep_dat_wide, <span class="at">exposure_vars =</span> <span class="st">"t1_perfectionism_cat"</span>, <span class="at">sort_var =</span> <span class="st">"id"</span>)</span>
<span id="cb32-778"><a href="#cb32-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-779"><a href="#cb32-779" aria-hidden="true" tabindex="-1"></a><span class="co"># check that these add up to the total data set</span></span>
<span id="cb32-780"><a href="#cb32-780" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">nrow</span>( list_filtered_df<span class="sc">$</span>tile_1)</span>
<span id="cb32-781"><a href="#cb32-781" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">nrow</span>( list_filtered_df<span class="sc">$</span>tile_2)</span>
<span id="cb32-782"><a href="#cb32-782" aria-hidden="true" tabindex="-1"></a>c <span class="ot">&lt;-</span> <span class="fu">nrow</span>( list_filtered_df<span class="sc">$</span>tile_3)</span>
<span id="cb32-783"><a href="#cb32-783" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span><span class="fu">nrow</span>( list_filtered_df<span class="sc">$</span>tile_4)</span>
<span id="cb32-784"><a href="#cb32-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-785"><a href="#cb32-785" aria-hidden="true" tabindex="-1"></a><span class="co"># must sum to equal</span></span>
<span id="cb32-786"><a href="#cb32-786" aria-hidden="true" tabindex="-1"></a>a <span class="sc">+</span> b <span class="sc">+</span> c <span class="sc">+</span> d <span class="sc">==</span> <span class="fu">nrow</span>(prep_dat_wide)</span>
<span id="cb32-787"><a href="#cb32-787" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-788"><a href="#cb32-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-789"><a href="#cb32-789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-790"><a href="#cb32-790" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualise missing values</span></span>
<span id="cb32-791"><a href="#cb32-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-794"><a href="#cb32-794" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-795"><a href="#cb32-795" aria-hidden="true" tabindex="-1"></a><span class="co"># visually inspect missingness</span></span>
<span id="cb32-796"><a href="#cb32-796" aria-hidden="true" tabindex="-1"></a>naniar<span class="sc">::</span><span class="fu">vis_miss</span>(prep_dat_wide, <span class="at">warn_large_data =</span> <span class="cn">FALSE</span>)</span>
<span id="cb32-797"><a href="#cb32-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-798"><a href="#cb32-798" aria-hidden="true" tabindex="-1"></a><span class="co"># check for collinear vars</span></span>
<span id="cb32-799"><a href="#cb32-799" aria-hidden="true" tabindex="-1"></a>mice<span class="sc">:::</span><span class="fu">find.collinear</span>(prep_dat_wide) <span class="co"># note sample weights is collinear</span></span>
<span id="cb32-800"><a href="#cb32-800" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-801"><a href="#cb32-801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-802"><a href="#cb32-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-803"><a href="#cb32-803" aria-hidden="true" tabindex="-1"></a><span class="fu">### Imputations</span></span>
<span id="cb32-804"><a href="#cb32-804" aria-hidden="true" tabindex="-1"></a>Next we impute by quartile.  Save this output in your folder. </span>
<span id="cb32-805"><a href="#cb32-805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-808"><a href="#cb32-808" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-809"><a href="#cb32-809" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: imputation</span></span>
<span id="cb32-810"><a href="#cb32-810" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb32-811"><a href="#cb32-811" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb32-812"><a href="#cb32-812" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb32-813"><a href="#cb32-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-814"><a href="#cb32-814" aria-hidden="true" tabindex="-1"></a><span class="co"># impute by quartile</span></span>
<span id="cb32-815"><a href="#cb32-815" aria-hidden="true" tabindex="-1"></a>mice_health <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">impute_and_combine</span>(list_filtered_df,  <span class="at">m =</span> <span class="dv">5</span> )</span>
<span id="cb32-816"><a href="#cb32-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-817"><a href="#cb32-817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-818"><a href="#cb32-818" aria-hidden="true" tabindex="-1"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(mice_health, <span class="st">"mice_health"</span>)</span>
<span id="cb32-819"><a href="#cb32-819" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-820"><a href="#cb32-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-821"><a href="#cb32-821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-822"><a href="#cb32-822" aria-hidden="true" tabindex="-1"></a><span class="fu">### Wrangling</span></span>
<span id="cb32-823"><a href="#cb32-823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-826"><a href="#cb32-826" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-827"><a href="#cb32-827" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: read-imputation</span></span>
<span id="cb32-828"><a href="#cb32-828" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb32-829"><a href="#cb32-829" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb32-830"><a href="#cb32-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-831"><a href="#cb32-831" aria-hidden="true" tabindex="-1"></a><span class="co"># read data if you are not running the imputation again</span></span>
<span id="cb32-832"><a href="#cb32-832" aria-hidden="true" tabindex="-1"></a>mice_health <span class="ot">&lt;-</span> <span class="fu">here_read</span>(<span class="st">"mice_health"</span>)</span>
<span id="cb32-833"><a href="#cb32-833" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-834"><a href="#cb32-834" aria-hidden="true" tabindex="-1"></a><span class="co"># post-imputation arrange</span></span>
<span id="cb32-835"><a href="#cb32-835" aria-hidden="true" tabindex="-1"></a>mice_health_mids <span class="ot">&lt;-</span> mice_health <span class="sc">|&gt;</span></span>
<span id="cb32-836"><a href="#cb32-836" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(.imp, id) <span class="sc">|&gt;</span></span>
<span id="cb32-837"><a href="#cb32-837" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">sample_weights =</span> t0_sample_weights) <span class="sc">|&gt;</span></span>
<span id="cb32-838"><a href="#cb32-838" aria-hidden="true" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb32-839"><a href="#cb32-839" aria-hidden="true" tabindex="-1"></a>  <span class="fu">across</span>(</span>
<span id="cb32-840"><a href="#cb32-840" aria-hidden="true" tabindex="-1"></a>    <span class="fu">where</span>(is.numeric) <span class="sc">&amp;</span></span>
<span id="cb32-841"><a href="#cb32-841" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span>sample_weights,</span>
<span id="cb32-842"><a href="#cb32-842" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span> <span class="fu">scale</span>(.x),</span>
<span id="cb32-843"><a href="#cb32-843" aria-hidden="true" tabindex="-1"></a>    <span class="at">.names =</span> <span class="st">"{col}_z"</span></span>
<span id="cb32-844"><a href="#cb32-844" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-845"><a href="#cb32-845" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb32-846"><a href="#cb32-846" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>.imp_z, <span class="sc">-</span>.id_z) <span class="sc">|&gt;</span></span>
<span id="cb32-847"><a href="#cb32-847" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">where</span>(is.factor),</span>
<span id="cb32-848"><a href="#cb32-848" aria-hidden="true" tabindex="-1"></a>         sample_weights,</span>
<span id="cb32-849"><a href="#cb32-849" aria-hidden="true" tabindex="-1"></a>         <span class="fu">ends_with</span>(<span class="st">"_z"</span>),</span>
<span id="cb32-850"><a href="#cb32-850" aria-hidden="true" tabindex="-1"></a>         .imp,</span>
<span id="cb32-851"><a href="#cb32-851" aria-hidden="true" tabindex="-1"></a>         .id) <span class="sc">|&gt;</span></span>
<span id="cb32-852"><a href="#cb32-852" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(sample_weights, <span class="at">.before =</span> <span class="fu">starts_with</span>(<span class="st">"t1_"</span>))  <span class="sc">|&gt;</span></span>
<span id="cb32-853"><a href="#cb32-853" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(id, <span class="at">.before =</span> sample_weights)  <span class="sc">|&gt;</span></span>
<span id="cb32-854"><a href="#cb32-854" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(<span class="fu">starts_with</span>(<span class="st">"t0_"</span>), <span class="at">.before =</span> <span class="fu">starts_with</span>(<span class="st">"t1_"</span>))  <span class="sc">|&gt;</span></span>
<span id="cb32-855"><a href="#cb32-855" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(<span class="fu">starts_with</span>(<span class="st">"t2_"</span>), <span class="at">.after =</span> <span class="fu">starts_with</span>(<span class="st">"t1_"</span>))  <span class="sc">|&gt;</span></span>
<span id="cb32-856"><a href="#cb32-856" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(.imp, id) <span class="sc">|&gt;</span></span>
<span id="cb32-857"><a href="#cb32-857" aria-hidden="true" tabindex="-1"></a>  <span class="fu">droplevels</span>() <span class="sc">|&gt;</span></span>
<span id="cb32-858"><a href="#cb32-858" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.matrix, as.vector) <span class="sc">|&gt;</span></span>
<span id="cb32-859"><a href="#cb32-859" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.mids</span>()</span>
<span id="cb32-860"><a href="#cb32-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-861"><a href="#cb32-861" aria-hidden="true" tabindex="-1"></a><span class="co"># make long</span></span>
<span id="cb32-862"><a href="#cb32-862" aria-hidden="true" tabindex="-1"></a>mice_health_long <span class="ot">&lt;-</span> mice<span class="sc">::</span><span class="fu">complete</span>(mice_health_mids, <span class="st">"long"</span>, <span class="at">inc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-863"><a href="#cb32-863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-864"><a href="#cb32-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-865"><a href="#cb32-865" aria-hidden="true" tabindex="-1"></a><span class="co">#Save</span></span>
<span id="cb32-866"><a href="#cb32-866" aria-hidden="true" tabindex="-1"></a><span class="fu">here_save</span>(mice_health_mids, <span class="st">"mice_health_mids"</span>)</span>
<span id="cb32-867"><a href="#cb32-867" aria-hidden="true" tabindex="-1"></a><span class="fu">here_save</span>(mice_health_long, <span class="st">"mice_health_long"</span>)</span>
<span id="cb32-868"><a href="#cb32-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-869"><a href="#cb32-869" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-870"><a href="#cb32-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-871"><a href="#cb32-871" aria-hidden="true" tabindex="-1"></a><span class="fu">### Compute propensity scores for IPTW using machine learning</span></span>
<span id="cb32-872"><a href="#cb32-872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-873"><a href="#cb32-873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-876"><a href="#cb32-876" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-877"><a href="#cb32-877" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: propensity-scores</span></span>
<span id="cb32-878"><a href="#cb32-878" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb32-879"><a href="#cb32-879" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb32-880"><a href="#cb32-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-881"><a href="#cb32-881" aria-hidden="true" tabindex="-1"></a><span class="co"># this is how you read saved files without the margot package</span></span>
<span id="cb32-882"><a href="#cb32-882" aria-hidden="true" tabindex="-1"></a>mice_health_mids <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(here<span class="sc">::</span><span class="fu">here</span>(push_mods, <span class="st">"mice_health_mids"</span>))</span>
<span id="cb32-883"><a href="#cb32-883" aria-hidden="true" tabindex="-1"></a>mice_health_long <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(here<span class="sc">::</span><span class="fu">here</span>(push_mods, <span class="st">"mice_health_long"</span>))</span>
<span id="cb32-884"><a href="#cb32-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-885"><a href="#cb32-885" aria-hidden="true" tabindex="-1"></a><span class="co"># propensity scors --------------------------------------------------------</span></span>
<span id="cb32-886"><a href="#cb32-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-887"><a href="#cb32-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-888"><a href="#cb32-888" aria-hidden="true" tabindex="-1"></a><span class="co"># set exposure</span></span>
<span id="cb32-889"><a href="#cb32-889" aria-hidden="true" tabindex="-1"></a>X <span class="ot">=</span> <span class="st">"t1_perfectionism_cat"</span></span>
<span id="cb32-890"><a href="#cb32-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-891"><a href="#cb32-891" aria-hidden="true" tabindex="-1"></a><span class="co"># set estimand</span></span>
<span id="cb32-892"><a href="#cb32-892" aria-hidden="true" tabindex="-1"></a>estimand <span class="ot">=</span> <span class="st">"ATE"</span></span>
<span id="cb32-893"><a href="#cb32-893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-894"><a href="#cb32-894" aria-hidden="true" tabindex="-1"></a><span class="co"># set baseline variables</span></span>
<span id="cb32-895"><a href="#cb32-895" aria-hidden="true" tabindex="-1"></a>baseline_vars_models <span class="ot">=</span> mice_health_long <span class="sc">|&gt;</span></span>
<span id="cb32-896"><a href="#cb32-896" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"t0"</span>))<span class="sc">|&gt;</span> <span class="fu">colnames</span>() <span class="co"># note, we earlier change name of `t0_sample_weights` to `sample weights`</span></span>
<span id="cb32-897"><a href="#cb32-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-898"><a href="#cb32-898" aria-hidden="true" tabindex="-1"></a>baseline_vars_models</span>
<span id="cb32-899"><a href="#cb32-899" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain propensity scores</span></span>
<span id="cb32-900"><a href="#cb32-900" aria-hidden="true" tabindex="-1"></a>match_ebal_ate <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">match_mi_general</span>(<span class="at">data =</span> mice_health_mids, </span>
<span id="cb32-901"><a href="#cb32-901" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">X =</span> X, </span>
<span id="cb32-902"><a href="#cb32-902" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">baseline_vars =</span> baseline_vars_models, </span>
<span id="cb32-903"><a href="#cb32-903" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">estimand =</span> <span class="st">"ATE"</span>,  </span>
<span id="cb32-904"><a href="#cb32-904" aria-hidden="true" tabindex="-1"></a>                                   <span class="co">#   focal = "tile_3", #for ATT</span></span>
<span id="cb32-905"><a href="#cb32-905" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">method =</span> <span class="st">"ebal"</span>, </span>
<span id="cb32-906"><a href="#cb32-906" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">sample_weights =</span> <span class="st">"sample_weights"</span>)</span>
<span id="cb32-907"><a href="#cb32-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-908"><a href="#cb32-908" aria-hidden="true" tabindex="-1"></a><span class="co"># save output</span></span>
<span id="cb32-909"><a href="#cb32-909" aria-hidden="true" tabindex="-1"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(match_ebal_ate, <span class="st">"match_ebal_ate"</span>)</span>
<span id="cb32-910"><a href="#cb32-910" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-911"><a href="#cb32-911" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-912"><a href="#cb32-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-915"><a href="#cb32-915" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-916"><a href="#cb32-916" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: vis_matching_ate</span></span>
<span id="cb32-917"><a href="#cb32-917" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb32-918"><a href="#cb32-918" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb32-919"><a href="#cb32-919" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 12</span></span>
<span id="cb32-920"><a href="#cb32-920" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 12</span></span>
<span id="cb32-921"><a href="#cb32-921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-922"><a href="#cb32-922" aria-hidden="true" tabindex="-1"></a><span class="co"># read output</span></span>
<span id="cb32-923"><a href="#cb32-923" aria-hidden="true" tabindex="-1"></a>match_ebal_ate <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"match_ebal_ate"</span>)</span>
<span id="cb32-924"><a href="#cb32-924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-925"><a href="#cb32-925" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-926"><a href="#cb32-926" aria-hidden="true" tabindex="-1"></a><span class="co"># check balance</span></span>
<span id="cb32-927"><a href="#cb32-927" aria-hidden="true" tabindex="-1"></a><span class="co">#bal.tab(match_ebal_ate)</span></span>
<span id="cb32-928"><a href="#cb32-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-929"><a href="#cb32-929" aria-hidden="true" tabindex="-1"></a><span class="co"># visualise imbalance</span></span>
<span id="cb32-930"><a href="#cb32-930" aria-hidden="true" tabindex="-1"></a><span class="fu">love.plot</span>(match_ebal_ate, <span class="at">binary =</span> <span class="st">"std"</span>, <span class="at">thresholds =</span> <span class="fu">c</span>(<span class="at">m =</span> .<span class="dv">1</span>),</span>
<span id="cb32-931"><a href="#cb32-931" aria-hidden="true" tabindex="-1"></a>          <span class="at">wrap =</span> <span class="dv">50</span>, <span class="at">position =</span> <span class="st">"bottom"</span>, <span class="at">size =</span><span class="dv">3</span>)</span>
<span id="cb32-932"><a href="#cb32-932" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-933"><a href="#cb32-933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-934"><a href="#cb32-934" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualise imbalance</span></span>
<span id="cb32-935"><a href="#cb32-935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-936"><a href="#cb32-936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-939"><a href="#cb32-939" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-940"><a href="#cb32-940" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb32-941"><a href="#cb32-941" aria-hidden="true" tabindex="-1"></a><span class="co"># consider results </span></span>
<span id="cb32-942"><a href="#cb32-942" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-943"><a href="#cb32-943" aria-hidden="true" tabindex="-1"></a>sum_ebal_match_ebal_ate <span class="ot">&lt;-</span> <span class="fu">summary</span>(match_ebal_ate)</span>
<span id="cb32-944"><a href="#cb32-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-945"><a href="#cb32-945" aria-hidden="true" tabindex="-1"></a><span class="co"># summarise</span></span>
<span id="cb32-946"><a href="#cb32-946" aria-hidden="true" tabindex="-1"></a>sum_ebal_match_ebal_ate</span>
<span id="cb32-947"><a href="#cb32-947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-948"><a href="#cb32-948" aria-hidden="true" tabindex="-1"></a><span class="co"># visualise</span></span>
<span id="cb32-949"><a href="#cb32-949" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(sum_ebal_match_ebal_ate)</span>
<span id="cb32-950"><a href="#cb32-950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-951"><a href="#cb32-951" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-952"><a href="#cb32-952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-953"><a href="#cb32-953" aria-hidden="true" tabindex="-1"></a>Some extreme weights.  We can trim weights as follows. (Note there is no hard and fast rule about how much to trim weights by, here we trim by 1%.)</span>
<span id="cb32-954"><a href="#cb32-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-957"><a href="#cb32-957" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-958"><a href="#cb32-958" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 12</span></span>
<span id="cb32-959"><a href="#cb32-959" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 12</span></span>
<span id="cb32-960"><a href="#cb32-960" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb32-961"><a href="#cb32-961" aria-hidden="true" tabindex="-1"></a><span class="co"># trimmed weights</span></span>
<span id="cb32-962"><a href="#cb32-962" aria-hidden="true" tabindex="-1"></a>match_ebal_ate_trim <span class="ot">&lt;-</span> WeightIt<span class="sc">::</span><span class="fu">trim</span>(match_ebal_ate, <span class="at">at =</span> .<span class="dv">99</span>)</span>
<span id="cb32-963"><a href="#cb32-963" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-964"><a href="#cb32-964" aria-hidden="true" tabindex="-1"></a><span class="co"># check balance</span></span>
<span id="cb32-965"><a href="#cb32-965" aria-hidden="true" tabindex="-1"></a><span class="co"># bal.tab(match_ebal_ate_trim)</span></span>
<span id="cb32-966"><a href="#cb32-966" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-967"><a href="#cb32-967" aria-hidden="true" tabindex="-1"></a><span class="co"># summary</span></span>
<span id="cb32-968"><a href="#cb32-968" aria-hidden="true" tabindex="-1"></a>summary_match_ebal_ate_trim <span class="ot">&lt;-</span> <span class="fu">summary</span>(match_ebal_ate_trim)</span>
<span id="cb32-969"><a href="#cb32-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-970"><a href="#cb32-970" aria-hidden="true" tabindex="-1"></a><span class="co"># check - extreme weights gone</span></span>
<span id="cb32-971"><a href="#cb32-971" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(summary_match_ebal_ate_trim)</span>
<span id="cb32-972"><a href="#cb32-972" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-973"><a href="#cb32-973" aria-hidden="true" tabindex="-1"></a><span class="co"># plot for balance</span></span>
<span id="cb32-974"><a href="#cb32-974" aria-hidden="true" tabindex="-1"></a><span class="fu">love.plot</span>(match_ebal_ate_trim, <span class="at">binary =</span> <span class="st">"std"</span>, <span class="at">thresholds =</span> <span class="fu">c</span>(<span class="at">m =</span> .<span class="dv">1</span>),</span>
<span id="cb32-975"><a href="#cb32-975" aria-hidden="true" tabindex="-1"></a>          <span class="at">wrap =</span> <span class="dv">50</span>, <span class="at">position =</span> <span class="st">"bottom"</span>, <span class="at">size =</span><span class="dv">2</span>, <span class="at">limits =</span> <span class="fu">list</span>(<span class="at">m =</span> <span class="fu">c</span>(<span class="sc">-</span>.<span class="dv">5</span>, .<span class="dv">5</span>)))</span>
<span id="cb32-976"><a href="#cb32-976" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-977"><a href="#cb32-977" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-978"><a href="#cb32-978" aria-hidden="true" tabindex="-1"></a><span class="fu">### Estimation</span></span>
<span id="cb32-979"><a href="#cb32-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-982"><a href="#cb32-982" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-983"><a href="#cb32-983" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: estimate</span></span>
<span id="cb32-984"><a href="#cb32-984" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb32-985"><a href="#cb32-985" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb32-986"><a href="#cb32-986" aria-hidden="true" tabindex="-1"></a><span class="co"># here_save(match_ebal_ate_trim, "match_ebal_ate_trim")</span></span>
<span id="cb32-987"><a href="#cb32-987" aria-hidden="true" tabindex="-1"></a><span class="co"># match_ebal_ate_trim &lt;- here_read( "match_ebal_ate_trim")</span></span>
<span id="cb32-988"><a href="#cb32-988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-989"><a href="#cb32-989" aria-hidden="true" tabindex="-1"></a><span class="co"># set data frame; output of match_mi_general model</span></span>
<span id="cb32-990"><a href="#cb32-990" aria-hidden="true" tabindex="-1"></a>df_ate <span class="ot">=</span> match_ebal_ate_trim</span>
<span id="cb32-991"><a href="#cb32-991" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(df_ate)</span>
<span id="cb32-992"><a href="#cb32-992" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(match_ebal_ate_trim)</span>
<span id="cb32-993"><a href="#cb32-993" aria-hidden="true" tabindex="-1"></a><span class="co"># remind self of levels if needed</span></span>
<span id="cb32-994"><a href="#cb32-994" aria-hidden="true" tabindex="-1"></a><span class="co"># levels(mice_health_long$t1_perfectionism_4tile)</span></span>
<span id="cb32-995"><a href="#cb32-995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-996"><a href="#cb32-996" aria-hidden="true" tabindex="-1"></a><span class="co"># set treatment level</span></span>
<span id="cb32-997"><a href="#cb32-997" aria-hidden="true" tabindex="-1"></a>treat_0 <span class="ot">=</span> <span class="st">"[1.0,2.0]"</span> <span class="co"># lowest quartile</span></span>
<span id="cb32-998"><a href="#cb32-998" aria-hidden="true" tabindex="-1"></a>treat_1 <span class="ot">=</span> <span class="st">"(4.0,7.0]"</span> <span class="co"># third quartile</span></span>
<span id="cb32-999"><a href="#cb32-999" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1000"><a href="#cb32-1000" aria-hidden="true" tabindex="-1"></a><span class="co"># bootstrap simulations ( generally use 1000)</span></span>
<span id="cb32-1001"><a href="#cb32-1001" aria-hidden="true" tabindex="-1"></a>nsims <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb32-1002"><a href="#cb32-1002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1003"><a href="#cb32-1003" aria-hidden="true" tabindex="-1"></a><span class="co"># cores</span></span>
<span id="cb32-1004"><a href="#cb32-1004" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">=</span>  parallel<span class="sc">::</span><span class="fu">detectCores</span> () </span>
<span id="cb32-1005"><a href="#cb32-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1006"><a href="#cb32-1006" aria-hidden="true" tabindex="-1"></a>estimand <span class="ot">=</span> <span class="st">"ATE"</span></span>
<span id="cb32-1007"><a href="#cb32-1007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1008"><a href="#cb32-1008" aria-hidden="true" tabindex="-1"></a><span class="co"># as specified</span></span>
<span id="cb32-1009"><a href="#cb32-1009" aria-hidden="true" tabindex="-1"></a>vcov <span class="ot">=</span> <span class="st">"HC2"</span> <span class="co"># robust standard errors. </span></span>
<span id="cb32-1010"><a href="#cb32-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1011"><a href="#cb32-1011" aria-hidden="true" tabindex="-1"></a><span class="co"># cores</span></span>
<span id="cb32-1012"><a href="#cb32-1012" aria-hidden="true" tabindex="-1"></a>cores <span class="ot">=</span> parallel<span class="sc">::</span><span class="fu">detectCores</span> () <span class="co"># use all course</span></span>
<span id="cb32-1013"><a href="#cb32-1013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1014"><a href="#cb32-1014" aria-hidden="true" tabindex="-1"></a><span class="co"># Example call to the function</span></span>
<span id="cb32-1015"><a href="#cb32-1015" aria-hidden="true" tabindex="-1"></a><span class="co"># propensity score only model</span></span>
<span id="cb32-1016"><a href="#cb32-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1017"><a href="#cb32-1017" aria-hidden="true" tabindex="-1"></a><span class="co"># code review: these are the functions 'under the hood'</span></span>
<span id="cb32-1018"><a href="#cb32-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1019"><a href="#cb32-1019" aria-hidden="true" tabindex="-1"></a><span class="co"># this function is defined outside of both main functions</span></span>
<span id="cb32-1020"><a href="#cb32-1020" aria-hidden="true" tabindex="-1"></a><span class="co"># build_formula_str &lt;- function(Y, X, continuous_X, splines, baseline_vars) {</span></span>
<span id="cb32-1021"><a href="#cb32-1021" aria-hidden="true" tabindex="-1"></a><span class="co">#   baseline_part &lt;- if (!(length(baseline_vars) == 1 &amp;&amp; baseline_vars == "1")) {</span></span>
<span id="cb32-1022"><a href="#cb32-1022" aria-hidden="true" tabindex="-1"></a><span class="co">#     paste(baseline_vars, collapse = "+")</span></span>
<span id="cb32-1023"><a href="#cb32-1023" aria-hidden="true" tabindex="-1"></a><span class="co">#   } else {</span></span>
<span id="cb32-1024"><a href="#cb32-1024" aria-hidden="true" tabindex="-1"></a><span class="co">#     "1"</span></span>
<span id="cb32-1025"><a href="#cb32-1025" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb32-1026"><a href="#cb32-1026" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb32-1027"><a href="#cb32-1027" aria-hidden="true" tabindex="-1"></a><span class="co">#   if (continuous_X &amp;&amp; splines) {</span></span>
<span id="cb32-1028"><a href="#cb32-1028" aria-hidden="true" tabindex="-1"></a><span class="co">#     paste(Y, "~ bs(", X, ")", "*", "(", baseline_part, ")")</span></span>
<span id="cb32-1029"><a href="#cb32-1029" aria-hidden="true" tabindex="-1"></a><span class="co">#   } else {</span></span>
<span id="cb32-1030"><a href="#cb32-1030" aria-hidden="true" tabindex="-1"></a><span class="co">#     paste(Y, "~", X, "*", "(", baseline_part, ")")</span></span>
<span id="cb32-1031"><a href="#cb32-1031" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb32-1032"><a href="#cb32-1032" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb32-1033"><a href="#cb32-1033" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb32-1034"><a href="#cb32-1034" aria-hidden="true" tabindex="-1"></a><span class="co"># causal_contrast_marginal &lt;- function(df, Y, X, baseline_vars = "1", treat_0, treat_1,</span></span>
<span id="cb32-1035"><a href="#cb32-1035" aria-hidden="true" tabindex="-1"></a><span class="co">#                                      estimand = c("ATE", "ATT"), type = c("RR", "RD"),</span></span>
<span id="cb32-1036"><a href="#cb32-1036" aria-hidden="true" tabindex="-1"></a><span class="co">#                                      nsims = 200, cores = parallel::detectCores(), family = "gaussian",</span></span>
<span id="cb32-1037"><a href="#cb32-1037" aria-hidden="true" tabindex="-1"></a><span class="co">#                                      weights = NULL, continuous_X = FALSE, splines = FALSE, vcov = "HC2",</span></span>
<span id="cb32-1038"><a href="#cb32-1038" aria-hidden="true" tabindex="-1"></a><span class="co">#                                      verbose = FALSE) {</span></span>
<span id="cb32-1039"><a href="#cb32-1039" aria-hidden="true" tabindex="-1"></a><span class="co">#   # validate the type argument</span></span>
<span id="cb32-1040"><a href="#cb32-1040" aria-hidden="true" tabindex="-1"></a><span class="co">#   type &lt;- match.arg(type, choices = c("RR", "RD"))</span></span>
<span id="cb32-1041"><a href="#cb32-1041" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb32-1042"><a href="#cb32-1042" aria-hidden="true" tabindex="-1"></a><span class="co">#   # validate the family argument</span></span>
<span id="cb32-1043"><a href="#cb32-1043" aria-hidden="true" tabindex="-1"></a><span class="co">#   if (is.character(family)) {</span></span>
<span id="cb32-1044"><a href="#cb32-1044" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (!family %in% c("gaussian", "binomial", "Gamma", "inverse.gaussian", "poisson", "quasibinomial", "quasipoisson", "quasi")) {</span></span>
<span id="cb32-1045"><a href="#cb32-1045" aria-hidden="true" tabindex="-1"></a><span class="co">#       stop("Invalid 'family' argument. Please specify a valid family function.")</span></span>
<span id="cb32-1046"><a href="#cb32-1046" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb32-1047"><a href="#cb32-1047" aria-hidden="true" tabindex="-1"></a><span class="co">#     family_fun &lt;- get(family, mode = "function", envir = parent.frame())</span></span>
<span id="cb32-1048"><a href="#cb32-1048" aria-hidden="true" tabindex="-1"></a><span class="co">#   } else if (inherits(family, "family")) {</span></span>
<span id="cb32-1049"><a href="#cb32-1049" aria-hidden="true" tabindex="-1"></a><span class="co">#     family_fun &lt;- family</span></span>
<span id="cb32-1050"><a href="#cb32-1050" aria-hidden="true" tabindex="-1"></a><span class="co">#   } else {</span></span>
<span id="cb32-1051"><a href="#cb32-1051" aria-hidden="true" tabindex="-1"></a><span class="co">#     stop("Invalid 'family' argument. Please specify a valid family function or character string.")</span></span>
<span id="cb32-1052"><a href="#cb32-1052" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb32-1053"><a href="#cb32-1053" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb32-1054"><a href="#cb32-1054" aria-hidden="true" tabindex="-1"></a><span class="co">#   # use the updated causal_contrast_engine function</span></span>
<span id="cb32-1055"><a href="#cb32-1055" aria-hidden="true" tabindex="-1"></a><span class="co">#   results &lt;- causal_contrast_engine(</span></span>
<span id="cb32-1056"><a href="#cb32-1056" aria-hidden="true" tabindex="-1"></a><span class="co">#     df = df,</span></span>
<span id="cb32-1057"><a href="#cb32-1057" aria-hidden="true" tabindex="-1"></a><span class="co">#     Y = Y,</span></span>
<span id="cb32-1058"><a href="#cb32-1058" aria-hidden="true" tabindex="-1"></a><span class="co">#     X = X,</span></span>
<span id="cb32-1059"><a href="#cb32-1059" aria-hidden="true" tabindex="-1"></a><span class="co">#     baseline_vars = baseline_vars,</span></span>
<span id="cb32-1060"><a href="#cb32-1060" aria-hidden="true" tabindex="-1"></a><span class="co">#     treat_0 = treat_0,</span></span>
<span id="cb32-1061"><a href="#cb32-1061" aria-hidden="true" tabindex="-1"></a><span class="co">#     treat_1 = treat_1,</span></span>
<span id="cb32-1062"><a href="#cb32-1062" aria-hidden="true" tabindex="-1"></a><span class="co">#     estimand = estimand,</span></span>
<span id="cb32-1063"><a href="#cb32-1063" aria-hidden="true" tabindex="-1"></a><span class="co">#     type = type,</span></span>
<span id="cb32-1064"><a href="#cb32-1064" aria-hidden="true" tabindex="-1"></a><span class="co">#     nsims = nsims,</span></span>
<span id="cb32-1065"><a href="#cb32-1065" aria-hidden="true" tabindex="-1"></a><span class="co">#     cores = cores,</span></span>
<span id="cb32-1066"><a href="#cb32-1066" aria-hidden="true" tabindex="-1"></a><span class="co">#     family = family,</span></span>
<span id="cb32-1067"><a href="#cb32-1067" aria-hidden="true" tabindex="-1"></a><span class="co">#     weights = weights,</span></span>
<span id="cb32-1068"><a href="#cb32-1068" aria-hidden="true" tabindex="-1"></a><span class="co">#     continuous_X = continuous_X,</span></span>
<span id="cb32-1069"><a href="#cb32-1069" aria-hidden="true" tabindex="-1"></a><span class="co">#     splines = splines,</span></span>
<span id="cb32-1070"><a href="#cb32-1070" aria-hidden="true" tabindex="-1"></a><span class="co">#     vcov = vcov,</span></span>
<span id="cb32-1071"><a href="#cb32-1071" aria-hidden="true" tabindex="-1"></a><span class="co">#     verbose = verbose</span></span>
<span id="cb32-1072"><a href="#cb32-1072" aria-hidden="true" tabindex="-1"></a><span class="co">#   )</span></span>
<span id="cb32-1073"><a href="#cb32-1073" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb32-1074"><a href="#cb32-1074" aria-hidden="true" tabindex="-1"></a><span class="co">#   return(results)</span></span>
<span id="cb32-1075"><a href="#cb32-1075" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb32-1076"><a href="#cb32-1076" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb32-1077"><a href="#cb32-1077" aria-hidden="true" tabindex="-1"></a><span class="co"># causal_contrast_engine &lt;- function(df, Y, X, baseline_vars, treat_0, treat_1,</span></span>
<span id="cb32-1078"><a href="#cb32-1078" aria-hidden="true" tabindex="-1"></a><span class="co">#                                    estimand = c("ATE", "ATT"), type = c("RR", "RD"),</span></span>
<span id="cb32-1079"><a href="#cb32-1079" aria-hidden="true" tabindex="-1"></a><span class="co">#                                    nsims = 200, cores = parallel::detectCores(),</span></span>
<span id="cb32-1080"><a href="#cb32-1080" aria-hidden="true" tabindex="-1"></a><span class="co">#                                    family = "gaussian", weights = TRUE,</span></span>
<span id="cb32-1081"><a href="#cb32-1081" aria-hidden="true" tabindex="-1"></a><span class="co">#                                    continuous_X = FALSE, splines = FALSE,</span></span>
<span id="cb32-1082"><a href="#cb32-1082" aria-hidden="true" tabindex="-1"></a><span class="co">#                                    vcov = "HC2", verbose = FALSE) {</span></span>
<span id="cb32-1083"><a href="#cb32-1083" aria-hidden="true" tabindex="-1"></a><span class="co">#   # check if required packages are installed</span></span>
<span id="cb32-1084"><a href="#cb32-1084" aria-hidden="true" tabindex="-1"></a><span class="co">#   required_packages &lt;- c("clarify", "rlang", "glue", "parallel", "mice")</span></span>
<span id="cb32-1085"><a href="#cb32-1085" aria-hidden="true" tabindex="-1"></a><span class="co">#   for (pkg in required_packages) {</span></span>
<span id="cb32-1086"><a href="#cb32-1086" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (!requireNamespace(pkg, quietly = TRUE)) {</span></span>
<span id="cb32-1087"><a href="#cb32-1087" aria-hidden="true" tabindex="-1"></a><span class="co">#       stop(paste0("Package '", pkg, "' is needed for this function but is not installed"))</span></span>
<span id="cb32-1088"><a href="#cb32-1088" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb32-1089"><a href="#cb32-1089" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb32-1090"><a href="#cb32-1090" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb32-1091"><a href="#cb32-1091" aria-hidden="true" tabindex="-1"></a><span class="co">#   # helper function to process a single imputed dataset</span></span>
<span id="cb32-1092"><a href="#cb32-1092" aria-hidden="true" tabindex="-1"></a><span class="co">#   process_imputation &lt;- function(imputed_data, weights) {</span></span>
<span id="cb32-1093"><a href="#cb32-1093" aria-hidden="true" tabindex="-1"></a><span class="co">#     # build formula</span></span>
<span id="cb32-1094"><a href="#cb32-1094" aria-hidden="true" tabindex="-1"></a><span class="co">#     formula_str &lt;- build_formula_str(Y, X, continuous_X, splines, baseline_vars)</span></span>
<span id="cb32-1095"><a href="#cb32-1095" aria-hidden="true" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb32-1096"><a href="#cb32-1096" aria-hidden="true" tabindex="-1"></a><span class="co">#     # apply model</span></span>
<span id="cb32-1097"><a href="#cb32-1097" aria-hidden="true" tabindex="-1"></a><span class="co">#     fit &lt;- glm(</span></span>
<span id="cb32-1098"><a href="#cb32-1098" aria-hidden="true" tabindex="-1"></a><span class="co">#       as.formula(formula_str),</span></span>
<span id="cb32-1099"><a href="#cb32-1099" aria-hidden="true" tabindex="-1"></a><span class="co">#       weights = weights,</span></span>
<span id="cb32-1100"><a href="#cb32-1100" aria-hidden="true" tabindex="-1"></a><span class="co">#       family = get(family, mode = "function", envir = parent.frame()),</span></span>
<span id="cb32-1101"><a href="#cb32-1101" aria-hidden="true" tabindex="-1"></a><span class="co">#       data = imputed_data</span></span>
<span id="cb32-1102"><a href="#cb32-1102" aria-hidden="true" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb32-1103"><a href="#cb32-1103" aria-hidden="true" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb32-1104"><a href="#cb32-1104" aria-hidden="true" tabindex="-1"></a><span class="co">#     return(fit)</span></span>
<span id="cb32-1105"><a href="#cb32-1105" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb32-1106"><a href="#cb32-1106" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb32-1107"><a href="#cb32-1107" aria-hidden="true" tabindex="-1"></a><span class="co">#   # check if df is a wimids object</span></span>
<span id="cb32-1108"><a href="#cb32-1108" aria-hidden="true" tabindex="-1"></a><span class="co">#   if (inherits(df, "wimids")) {</span></span>
<span id="cb32-1109"><a href="#cb32-1109" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Extract the mids object and weights</span></span>
<span id="cb32-1110"><a href="#cb32-1110" aria-hidden="true" tabindex="-1"></a><span class="co">#     mids_obj &lt;- df$object</span></span>
<span id="cb32-1111"><a href="#cb32-1111" aria-hidden="true" tabindex="-1"></a><span class="co">#     weights_list &lt;- lapply(df$models, function(m) m$weights)</span></span>
<span id="cb32-1112"><a href="#cb32-1112" aria-hidden="true" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb32-1113"><a href="#cb32-1113" aria-hidden="true" tabindex="-1"></a><span class="co">#     # process each imputed dataset</span></span>
<span id="cb32-1114"><a href="#cb32-1114" aria-hidden="true" tabindex="-1"></a><span class="co">#     fits &lt;- lapply(1:mids_obj$m, function(i) {</span></span>
<span id="cb32-1115"><a href="#cb32-1115" aria-hidden="true" tabindex="-1"></a><span class="co">#       imputed_data &lt;- mice::complete(mids_obj, i)</span></span>
<span id="cb32-1116"><a href="#cb32-1116" aria-hidden="true" tabindex="-1"></a><span class="co">#       process_imputation(imputed_data, weights_list[[i]])</span></span>
<span id="cb32-1117"><a href="#cb32-1117" aria-hidden="true" tabindex="-1"></a><span class="co">#     })</span></span>
<span id="cb32-1118"><a href="#cb32-1118" aria-hidden="true" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb32-1119"><a href="#cb32-1119" aria-hidden="true" tabindex="-1"></a><span class="co">#     # create a misim object</span></span>
<span id="cb32-1120"><a href="#cb32-1120" aria-hidden="true" tabindex="-1"></a><span class="co">#     sim.imp &lt;- clarify::misim(fits, n = nsims, vcov = vcov)</span></span>
<span id="cb32-1121"><a href="#cb32-1121" aria-hidden="true" tabindex="-1"></a><span class="co">#   } else {</span></span>
<span id="cb32-1122"><a href="#cb32-1122" aria-hidden="true" tabindex="-1"></a><span class="co">#     # If df is not a wimids object, process it as before</span></span>
<span id="cb32-1123"><a href="#cb32-1123" aria-hidden="true" tabindex="-1"></a><span class="co">#     weight_var &lt;- if (!is.null(weights) &amp;&amp; weights %in% names(df)) df[[weights]] else NULL</span></span>
<span id="cb32-1124"><a href="#cb32-1124" aria-hidden="true" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb32-1125"><a href="#cb32-1125" aria-hidden="true" tabindex="-1"></a><span class="co">#     fit &lt;- process_imputation(df, weight_var)</span></span>
<span id="cb32-1126"><a href="#cb32-1126" aria-hidden="true" tabindex="-1"></a><span class="co">#     sim.imp &lt;- clarify::sim(fit, n = nsims, vcov = vcov)</span></span>
<span id="cb32-1127"><a href="#cb32-1127" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb32-1128"><a href="#cb32-1128" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb32-1129"><a href="#cb32-1129" aria-hidden="true" tabindex="-1"></a><span class="co">#   if (continuous_X) {</span></span>
<span id="cb32-1130"><a href="#cb32-1130" aria-hidden="true" tabindex="-1"></a><span class="co">#     estimand &lt;- "ATE"</span></span>
<span id="cb32-1131"><a href="#cb32-1131" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb32-1132"><a href="#cb32-1132" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb32-1133"><a href="#cb32-1133" aria-hidden="true" tabindex="-1"></a><span class="co">#   # compute the average marginal effects</span></span>
<span id="cb32-1134"><a href="#cb32-1134" aria-hidden="true" tabindex="-1"></a><span class="co">#   if (!continuous_X &amp;&amp; estimand == "ATT") {</span></span>
<span id="cb32-1135"><a href="#cb32-1135" aria-hidden="true" tabindex="-1"></a><span class="co">#     subset_expr &lt;- rlang::expr(!!rlang::sym(X) == !!treat_1)</span></span>
<span id="cb32-1136"><a href="#cb32-1136" aria-hidden="true" tabindex="-1"></a><span class="co">#     sim_estimand &lt;- clarify::sim_ame(</span></span>
<span id="cb32-1137"><a href="#cb32-1137" aria-hidden="true" tabindex="-1"></a><span class="co">#       sim.imp,</span></span>
<span id="cb32-1138"><a href="#cb32-1138" aria-hidden="true" tabindex="-1"></a><span class="co">#       var = X,</span></span>
<span id="cb32-1139"><a href="#cb32-1139" aria-hidden="true" tabindex="-1"></a><span class="co">#       subset = eval(subset_expr),</span></span>
<span id="cb32-1140"><a href="#cb32-1140" aria-hidden="true" tabindex="-1"></a><span class="co">#       cl = cores,</span></span>
<span id="cb32-1141"><a href="#cb32-1141" aria-hidden="true" tabindex="-1"></a><span class="co">#       verbose = FALSE</span></span>
<span id="cb32-1142"><a href="#cb32-1142" aria-hidden="true" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb32-1143"><a href="#cb32-1143" aria-hidden="true" tabindex="-1"></a><span class="co">#   } else {</span></span>
<span id="cb32-1144"><a href="#cb32-1144" aria-hidden="true" tabindex="-1"></a><span class="co">#     sim_estimand &lt;- clarify::sim_ame(sim.imp,</span></span>
<span id="cb32-1145"><a href="#cb32-1145" aria-hidden="true" tabindex="-1"></a><span class="co">#       var = X,</span></span>
<span id="cb32-1146"><a href="#cb32-1146" aria-hidden="true" tabindex="-1"></a><span class="co">#       cl = cores,</span></span>
<span id="cb32-1147"><a href="#cb32-1147" aria-hidden="true" tabindex="-1"></a><span class="co">#       verbose = FALSE</span></span>
<span id="cb32-1148"><a href="#cb32-1148" aria-hidden="true" tabindex="-1"></a><span class="co">#     )</span></span>
<span id="cb32-1149"><a href="#cb32-1149" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb32-1150"><a href="#cb32-1150" aria-hidden="true" tabindex="-1"></a><span class="co">#     treat_0_name &lt;- paste0("`E[Y(", treat_0, ")]`")</span></span>
<span id="cb32-1151"><a href="#cb32-1151" aria-hidden="true" tabindex="-1"></a><span class="co">#     treat_1_name &lt;- paste0("`E[Y(", treat_1, ")]`")</span></span>
<span id="cb32-1152"><a href="#cb32-1152" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb32-1153"><a href="#cb32-1153" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (type == "RR") {</span></span>
<span id="cb32-1154"><a href="#cb32-1154" aria-hidden="true" tabindex="-1"></a><span class="co">#       rr_expression_str &lt;- glue::glue("{treat_1_name}/{treat_0_name}")</span></span>
<span id="cb32-1155"><a href="#cb32-1155" aria-hidden="true" tabindex="-1"></a><span class="co">#       rr_expression &lt;- rlang::parse_expr(rr_expression_str)</span></span>
<span id="cb32-1156"><a href="#cb32-1156" aria-hidden="true" tabindex="-1"></a><span class="co">#       sim_estimand &lt;- transform(sim_estimand, RR = eval(rr_expression))</span></span>
<span id="cb32-1157"><a href="#cb32-1157" aria-hidden="true" tabindex="-1"></a><span class="co">#       return(summary(sim_estimand))</span></span>
<span id="cb32-1158"><a href="#cb32-1158" aria-hidden="true" tabindex="-1"></a><span class="co">#     } else if (type == "RD") {</span></span>
<span id="cb32-1159"><a href="#cb32-1159" aria-hidden="true" tabindex="-1"></a><span class="co">#       rd_expression_str &lt;- glue::glue("{treat_1_name} - {treat_0_name}")</span></span>
<span id="cb32-1160"><a href="#cb32-1160" aria-hidden="true" tabindex="-1"></a><span class="co">#       rd_expression &lt;- rlang::parse_expr(rd_expression_str)</span></span>
<span id="cb32-1161"><a href="#cb32-1161" aria-hidden="true" tabindex="-1"></a><span class="co">#       sim_estimand &lt;- transform(sim_estimand, RD = eval(rd_expression))</span></span>
<span id="cb32-1162"><a href="#cb32-1162" aria-hidden="true" tabindex="-1"></a><span class="co">#       return(summary(sim_estimand))</span></span>
<span id="cb32-1163"><a href="#cb32-1163" aria-hidden="true" tabindex="-1"></a><span class="co">#     } else {</span></span>
<span id="cb32-1164"><a href="#cb32-1164" aria-hidden="true" tabindex="-1"></a><span class="co">#       stop("Invalid type. Please choose 'RR' or 'RD'")</span></span>
<span id="cb32-1165"><a href="#cb32-1165" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb32-1166"><a href="#cb32-1166" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb32-1167"><a href="#cb32-1167" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb32-1168"><a href="#cb32-1168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1169"><a href="#cb32-1169" aria-hidden="true" tabindex="-1"></a>propensity_mod_fit_t2_kessler_latent_anxiety_z <span class="ot">&lt;-</span><span class="fu">double_robust_marginal</span>(</span>
<span id="cb32-1170"><a href="#cb32-1170" aria-hidden="true" tabindex="-1"></a>  <span class="at">df =</span> df_ate,</span>
<span id="cb32-1171"><a href="#cb32-1171" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> <span class="st">"t2_kessler_latent_anxiety_z"</span>,</span>
<span id="cb32-1172"><a href="#cb32-1172" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X, </span>
<span id="cb32-1173"><a href="#cb32-1173" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline_vars =</span> <span class="dv">1</span>, <span class="co"># we are not regressing with any covariates</span></span>
<span id="cb32-1174"><a href="#cb32-1174" aria-hidden="true" tabindex="-1"></a>  <span class="at">treat_1 =</span> treat_1,</span>
<span id="cb32-1175"><a href="#cb32-1175" aria-hidden="true" tabindex="-1"></a>  <span class="at">treat_0 =</span> treat_0,</span>
<span id="cb32-1176"><a href="#cb32-1176" aria-hidden="true" tabindex="-1"></a>  <span class="at">nsims =</span> <span class="dv">1000</span>,</span>
<span id="cb32-1177"><a href="#cb32-1177" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> cores,</span>
<span id="cb32-1178"><a href="#cb32-1178" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb32-1179"><a href="#cb32-1179" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> <span class="cn">TRUE</span>,</span>
<span id="cb32-1180"><a href="#cb32-1180" aria-hidden="true" tabindex="-1"></a>  <span class="at">continuous_X =</span> <span class="cn">FALSE</span>,</span>
<span id="cb32-1181"><a href="#cb32-1181" aria-hidden="true" tabindex="-1"></a>  <span class="at">splines =</span> <span class="cn">FALSE</span>,</span>
<span id="cb32-1182"><a href="#cb32-1182" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATE"</span>,</span>
<span id="cb32-1183"><a href="#cb32-1183" aria-hidden="true" tabindex="-1"></a>  <span class="at">type_causal =</span> <span class="st">"RD"</span>,  </span>
<span id="cb32-1184"><a href="#cb32-1184" aria-hidden="true" tabindex="-1"></a>  <span class="at">type_tab =</span> <span class="st">"RD"</span>,    </span>
<span id="cb32-1185"><a href="#cb32-1185" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> vcov,         </span>
<span id="cb32-1186"><a href="#cb32-1186" aria-hidden="true" tabindex="-1"></a>  <span class="at">new_name =</span> <span class="st">"Kessler Anxiety (PR)"</span>,</span>
<span id="cb32-1187"><a href="#cb32-1187" aria-hidden="true" tabindex="-1"></a>  <span class="at">delta =</span> <span class="dv">1</span>,</span>
<span id="cb32-1188"><a href="#cb32-1188" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd =</span> <span class="dv">1</span></span>
<span id="cb32-1189"><a href="#cb32-1189" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-1190"><a href="#cb32-1190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1191"><a href="#cb32-1191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1192"><a href="#cb32-1192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1193"><a href="#cb32-1193" aria-hidden="true" tabindex="-1"></a><span class="co"># save</span></span>
<span id="cb32-1194"><a href="#cb32-1194" aria-hidden="true" tabindex="-1"></a><span class="fu">here_save</span>(propensity_mod_fit_t2_kessler_latent_anxiety_z, <span class="st">"propensity_mod_fit_t2_kessler_latent_anxiety_z"</span>)</span>
<span id="cb32-1195"><a href="#cb32-1195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1196"><a href="#cb32-1196" aria-hidden="true" tabindex="-1"></a>propensity_mod_fit_t2_kessler_latent_depression_z <span class="ot">&lt;-</span>margot<span class="sc">::</span><span class="fu">double_robust_marginal</span>(</span>
<span id="cb32-1197"><a href="#cb32-1197" aria-hidden="true" tabindex="-1"></a>  <span class="at">df =</span> df_ate,</span>
<span id="cb32-1198"><a href="#cb32-1198" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> <span class="st">"t2_kessler_latent_depression_z"</span>,</span>
<span id="cb32-1199"><a href="#cb32-1199" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X,  </span>
<span id="cb32-1200"><a href="#cb32-1200" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline_vars =</span> <span class="dv">1</span>, <span class="co">#no covariates, only the propensity scores</span></span>
<span id="cb32-1201"><a href="#cb32-1201" aria-hidden="true" tabindex="-1"></a>  <span class="at">treat_1 =</span> treat_1,</span>
<span id="cb32-1202"><a href="#cb32-1202" aria-hidden="true" tabindex="-1"></a>  <span class="at">treat_0 =</span> treat_0,</span>
<span id="cb32-1203"><a href="#cb32-1203" aria-hidden="true" tabindex="-1"></a>  <span class="at">nsims =</span> <span class="dv">1000</span>,</span>
<span id="cb32-1204"><a href="#cb32-1204" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> cores,</span>
<span id="cb32-1205"><a href="#cb32-1205" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb32-1206"><a href="#cb32-1206" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> <span class="cn">TRUE</span>,</span>
<span id="cb32-1207"><a href="#cb32-1207" aria-hidden="true" tabindex="-1"></a>  <span class="at">continuous_X =</span> <span class="cn">FALSE</span>,</span>
<span id="cb32-1208"><a href="#cb32-1208" aria-hidden="true" tabindex="-1"></a>  <span class="at">splines =</span> <span class="cn">FALSE</span>,</span>
<span id="cb32-1209"><a href="#cb32-1209" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATE"</span>,</span>
<span id="cb32-1210"><a href="#cb32-1210" aria-hidden="true" tabindex="-1"></a>  <span class="at">type_causal =</span> <span class="st">"RD"</span>,  </span>
<span id="cb32-1211"><a href="#cb32-1211" aria-hidden="true" tabindex="-1"></a>  <span class="at">type_tab =</span> <span class="st">"RD"</span>,    </span>
<span id="cb32-1212"><a href="#cb32-1212" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> vcov,         </span>
<span id="cb32-1213"><a href="#cb32-1213" aria-hidden="true" tabindex="-1"></a>  <span class="at">new_name =</span> <span class="st">"Kessler Depression (PR)"</span>,</span>
<span id="cb32-1214"><a href="#cb32-1214" aria-hidden="true" tabindex="-1"></a>  <span class="at">delta =</span> <span class="dv">1</span>,</span>
<span id="cb32-1215"><a href="#cb32-1215" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd =</span> <span class="dv">1</span></span>
<span id="cb32-1216"><a href="#cb32-1216" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-1217"><a href="#cb32-1217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1218"><a href="#cb32-1218" aria-hidden="true" tabindex="-1"></a><span class="co"># save</span></span>
<span id="cb32-1219"><a href="#cb32-1219" aria-hidden="true" tabindex="-1"></a><span class="fu">here_save</span>(propensity_mod_fit_t2_kessler_latent_depression_z, <span class="st">"propensity_mod_fit_t2_kessler_latent_depression_z"</span>)</span>
<span id="cb32-1220"><a href="#cb32-1220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1221"><a href="#cb32-1221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1222"><a href="#cb32-1222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1223"><a href="#cb32-1223" aria-hidden="true" tabindex="-1"></a><span class="do">## Doubly robust</span></span>
<span id="cb32-1224"><a href="#cb32-1224" aria-hidden="true" tabindex="-1"></a>mod_fit_t2_kessler_latent_anxiety_z <span class="ot">&lt;-</span>margot<span class="sc">::</span><span class="fu">double_robust_marginal</span>(</span>
<span id="cb32-1225"><a href="#cb32-1225" aria-hidden="true" tabindex="-1"></a>  <span class="at">df =</span> df_ate,</span>
<span id="cb32-1226"><a href="#cb32-1226" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> <span class="st">"t2_kessler_latent_anxiety_z"</span>,</span>
<span id="cb32-1227"><a href="#cb32-1227" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X,</span>
<span id="cb32-1228"><a href="#cb32-1228" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline_vars =</span> baseline_vars_models, <span class="co"># no covariates, only the propensity scores</span></span>
<span id="cb32-1229"><a href="#cb32-1229" aria-hidden="true" tabindex="-1"></a>  <span class="at">treat_1 =</span> treat_1,</span>
<span id="cb32-1230"><a href="#cb32-1230" aria-hidden="true" tabindex="-1"></a>  <span class="at">treat_0 =</span> treat_0,</span>
<span id="cb32-1231"><a href="#cb32-1231" aria-hidden="true" tabindex="-1"></a>  <span class="at">nsims =</span> <span class="dv">1000</span>,</span>
<span id="cb32-1232"><a href="#cb32-1232" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> cores,</span>
<span id="cb32-1233"><a href="#cb32-1233" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb32-1234"><a href="#cb32-1234" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> <span class="cn">TRUE</span>,</span>
<span id="cb32-1235"><a href="#cb32-1235" aria-hidden="true" tabindex="-1"></a>  <span class="at">continuous_X =</span> <span class="cn">FALSE</span>,</span>
<span id="cb32-1236"><a href="#cb32-1236" aria-hidden="true" tabindex="-1"></a>  <span class="at">splines =</span> <span class="cn">FALSE</span>,</span>
<span id="cb32-1237"><a href="#cb32-1237" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATE"</span>,</span>
<span id="cb32-1238"><a href="#cb32-1238" aria-hidden="true" tabindex="-1"></a>  <span class="at">type_causal =</span> <span class="st">"RD"</span>,  </span>
<span id="cb32-1239"><a href="#cb32-1239" aria-hidden="true" tabindex="-1"></a>  <span class="at">type_tab =</span> <span class="st">"RD"</span>,    </span>
<span id="cb32-1240"><a href="#cb32-1240" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> vcov,         </span>
<span id="cb32-1241"><a href="#cb32-1241" aria-hidden="true" tabindex="-1"></a>  <span class="at">new_name =</span> <span class="st">"Kessler Anxiety (DR)"</span>,</span>
<span id="cb32-1242"><a href="#cb32-1242" aria-hidden="true" tabindex="-1"></a>  <span class="at">delta =</span> <span class="dv">1</span>,</span>
<span id="cb32-1243"><a href="#cb32-1243" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd =</span> <span class="dv">1</span></span>
<span id="cb32-1244"><a href="#cb32-1244" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-1245"><a href="#cb32-1245" aria-hidden="true" tabindex="-1"></a><span class="co"># save</span></span>
<span id="cb32-1246"><a href="#cb32-1246" aria-hidden="true" tabindex="-1"></a><span class="fu">here_save</span>(mod_fit_t2_kessler_latent_anxiety_z, <span class="st">"mod_fit_t2_kessler_latent_anxiety_z"</span>)</span>
<span id="cb32-1247"><a href="#cb32-1247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1248"><a href="#cb32-1248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1249"><a href="#cb32-1249" aria-hidden="true" tabindex="-1"></a><span class="co"># model 2</span></span>
<span id="cb32-1250"><a href="#cb32-1250" aria-hidden="true" tabindex="-1"></a>mod_fit_t2_kessler_latent_depression_z <span class="ot">&lt;-</span>margot<span class="sc">::</span><span class="fu">double_robust_marginal</span>(</span>
<span id="cb32-1251"><a href="#cb32-1251" aria-hidden="true" tabindex="-1"></a>  <span class="at">df =</span> df_ate,</span>
<span id="cb32-1252"><a href="#cb32-1252" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> <span class="st">"t2_kessler_latent_depression_z"</span>,</span>
<span id="cb32-1253"><a href="#cb32-1253" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> X,</span>
<span id="cb32-1254"><a href="#cb32-1254" aria-hidden="true" tabindex="-1"></a>  <span class="at">baseline_vars =</span> baseline_vars_models,</span>
<span id="cb32-1255"><a href="#cb32-1255" aria-hidden="true" tabindex="-1"></a>  <span class="at">treat_1 =</span> treat_1,</span>
<span id="cb32-1256"><a href="#cb32-1256" aria-hidden="true" tabindex="-1"></a>  <span class="at">treat_0 =</span> treat_0,</span>
<span id="cb32-1257"><a href="#cb32-1257" aria-hidden="true" tabindex="-1"></a>  <span class="at">nsims =</span> <span class="dv">1000</span>,</span>
<span id="cb32-1258"><a href="#cb32-1258" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> cores,</span>
<span id="cb32-1259"><a href="#cb32-1259" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb32-1260"><a href="#cb32-1260" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> <span class="cn">TRUE</span>,</span>
<span id="cb32-1261"><a href="#cb32-1261" aria-hidden="true" tabindex="-1"></a>  <span class="at">continuous_X =</span> <span class="cn">FALSE</span>,</span>
<span id="cb32-1262"><a href="#cb32-1262" aria-hidden="true" tabindex="-1"></a>  <span class="at">splines =</span> <span class="cn">FALSE</span>,</span>
<span id="cb32-1263"><a href="#cb32-1263" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimand =</span> <span class="st">"ATE"</span>,</span>
<span id="cb32-1264"><a href="#cb32-1264" aria-hidden="true" tabindex="-1"></a>  <span class="at">type_causal =</span> <span class="st">"RD"</span>,  </span>
<span id="cb32-1265"><a href="#cb32-1265" aria-hidden="true" tabindex="-1"></a>  <span class="at">type_tab =</span> <span class="st">"RD"</span>,    </span>
<span id="cb32-1266"><a href="#cb32-1266" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> vcov,         </span>
<span id="cb32-1267"><a href="#cb32-1267" aria-hidden="true" tabindex="-1"></a>  <span class="at">new_name =</span> <span class="st">"Kessler Depression (DR)"</span>,</span>
<span id="cb32-1268"><a href="#cb32-1268" aria-hidden="true" tabindex="-1"></a>  <span class="at">delta =</span> <span class="dv">1</span>,</span>
<span id="cb32-1269"><a href="#cb32-1269" aria-hidden="true" tabindex="-1"></a>  <span class="at">sd =</span> <span class="dv">1</span></span>
<span id="cb32-1270"><a href="#cb32-1270" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-1271"><a href="#cb32-1271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1272"><a href="#cb32-1272" aria-hidden="true" tabindex="-1"></a><span class="co"># save</span></span>
<span id="cb32-1273"><a href="#cb32-1273" aria-hidden="true" tabindex="-1"></a><span class="fu">here_save</span>(mod_fit_t2_kessler_latent_depression_z, <span class="st">"mod_fit_t2_kessler_latent_depression_z"</span>)</span>
<span id="cb32-1274"><a href="#cb32-1274" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1275"><a href="#cb32-1275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1276"><a href="#cb32-1276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1277"><a href="#cb32-1277" aria-hidden="true" tabindex="-1"></a><span class="fu">### Results</span></span>
<span id="cb32-1278"><a href="#cb32-1278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1281"><a href="#cb32-1281" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-1282"><a href="#cb32-1282" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb32-1283"><a href="#cb32-1283" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb32-1284"><a href="#cb32-1284" aria-hidden="true" tabindex="-1"></a><span class="co"># to save time, we do not run the models</span></span>
<span id="cb32-1285"><a href="#cb32-1285" aria-hidden="true" tabindex="-1"></a><span class="co"># recover saved models </span></span>
<span id="cb32-1286"><a href="#cb32-1286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1287"><a href="#cb32-1287" aria-hidden="true" tabindex="-1"></a><span class="co"># propensity score  models</span></span>
<span id="cb32-1288"><a href="#cb32-1288" aria-hidden="true" tabindex="-1"></a>propensity_mod_fit_t2_kessler_latent_depression_z<span class="ot">&lt;-</span> <span class="fu">here_read</span>(<span class="st">"propensity_mod_fit_t2_kessler_latent_depression_z"</span>)</span>
<span id="cb32-1289"><a href="#cb32-1289" aria-hidden="true" tabindex="-1"></a>propensity_mod_fit_t2_kessler_latent_anxiety_z<span class="ot">&lt;-</span> <span class="fu">here_read</span>(<span class="st">"propensity_mod_fit_t2_kessler_latent_anxiety_z"</span>)</span>
<span id="cb32-1290"><a href="#cb32-1290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1291"><a href="#cb32-1291" aria-hidden="true" tabindex="-1"></a><span class="co"># doubly robust models</span></span>
<span id="cb32-1292"><a href="#cb32-1292" aria-hidden="true" tabindex="-1"></a>mod_fit_t2_kessler_latent_depression_z<span class="ot">&lt;-</span> <span class="fu">here_read</span>(<span class="st">"mod_fit_t2_kessler_latent_depression_z"</span>)</span>
<span id="cb32-1293"><a href="#cb32-1293" aria-hidden="true" tabindex="-1"></a>mod_fit_t2_kessler_latent_anxiety_z<span class="ot">&lt;-</span> <span class="fu">here_read</span>(<span class="st">"mod_fit_t2_kessler_latent_anxiety_z"</span>)</span>
<span id="cb32-1294"><a href="#cb32-1294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1295"><a href="#cb32-1295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1296"><a href="#cb32-1296" aria-hidden="true" tabindex="-1"></a><span class="co"># tables</span></span>
<span id="cb32-1297"><a href="#cb32-1297" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb32-1298"><a href="#cb32-1298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1299"><a href="#cb32-1299" aria-hidden="true" tabindex="-1"></a><span class="co"># proprensity only </span></span>
<span id="cb32-1300"><a href="#cb32-1300" aria-hidden="true" tabindex="-1"></a>tab_double_pr <span class="ot">&lt;-</span> <span class="fu">rbind</span>(propensity_mod_fit_t2_kessler_latent_depression_z<span class="sc">$</span>tab_results,</span>
<span id="cb32-1301"><a href="#cb32-1301" aria-hidden="true" tabindex="-1"></a>      propensity_mod_fit_t2_kessler_latent_anxiety_z<span class="sc">$</span>tab_results)</span>
<span id="cb32-1302"><a href="#cb32-1302" aria-hidden="true" tabindex="-1"></a><span class="co"># bind results in a table</span></span>
<span id="cb32-1303"><a href="#cb32-1303" aria-hidden="true" tabindex="-1"></a>tab_double_robust <span class="ot">&lt;-</span> <span class="fu">rbind</span>(mod_fit_t2_kessler_latent_depression_z<span class="sc">$</span>tab_results,</span>
<span id="cb32-1304"><a href="#cb32-1304" aria-hidden="true" tabindex="-1"></a>      mod_fit_t2_kessler_latent_anxiety_z<span class="sc">$</span>tab_results)</span>
<span id="cb32-1305"><a href="#cb32-1305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1306"><a href="#cb32-1306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1307"><a href="#cb32-1307" aria-hidden="true" tabindex="-1"></a><span class="co"># combine the individual results</span></span>
<span id="cb32-1308"><a href="#cb32-1308" aria-hidden="true" tabindex="-1"></a>tab_combo <span class="ot">&lt;-</span> <span class="fu">rbind</span>(tab_double_pr,tab_double_robust)</span>
<span id="cb32-1309"><a href="#cb32-1309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1310"><a href="#cb32-1310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1311"><a href="#cb32-1311" aria-hidden="true" tabindex="-1"></a><span class="co"># table</span></span>
<span id="cb32-1312"><a href="#cb32-1312" aria-hidden="true" tabindex="-1"></a>tab_combo <span class="sc">|&gt;</span> </span>
<span id="cb32-1313"><a href="#cb32-1313" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">format =</span> <span class="st">"markdown"</span>)</span>
<span id="cb32-1314"><a href="#cb32-1314" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1315"><a href="#cb32-1315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1316"><a href="#cb32-1316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1317"><a href="#cb32-1317" aria-hidden="true" tabindex="-1"></a>We see that the doubly robust estimator leads to lower overall effect sizes.</span>
<span id="cb32-1318"><a href="#cb32-1318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1319"><a href="#cb32-1319" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ## Sugroup Estimation Using Machine Learning --&gt;</span></span>
<span id="cb32-1320"><a href="#cb32-1320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1321"><a href="#cb32-1321" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> impute baseline values only --&gt;</span></span>
<span id="cb32-1322"><a href="#cb32-1322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1323"><a href="#cb32-1323" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb32-1324"><a href="#cb32-1324" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| eval: false --&gt;</span></span>
<span id="cb32-1325"><a href="#cb32-1325" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| echo: true --&gt;</span></span>
<span id="cb32-1326"><a href="#cb32-1326" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| label: impute_subgroup_baseline --&gt;</span></span>
<span id="cb32-1327"><a href="#cb32-1327" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # let's take a different approach --&gt;</span></span>
<span id="cb32-1328"><a href="#cb32-1328" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # this time we include the censored variable  --&gt;</span></span>
<span id="cb32-1329"><a href="#cb32-1329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1330"><a href="#cb32-1330" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- exposure_vars &lt;- c("perfectionism_cat", "censored") --&gt;</span></span>
<span id="cb32-1331"><a href="#cb32-1331" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- baseline_vars&lt;-setdiff(baseline_vars, "sample_weights") --&gt;</span></span>
<span id="cb32-1332"><a href="#cb32-1332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1333"><a href="#cb32-1333" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # here we imput the baseline  --&gt;</span></span>
<span id="cb32-1334"><a href="#cb32-1334" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- df_impute_base&lt;- margot_wide_impute_baseline(dat_long, baseline_vars = baseline_vars,  --&gt;</span></span>
<span id="cb32-1335"><a href="#cb32-1335" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                                              exposure_var = exposure_vars, outcome_vars = outcome_vars) --&gt;</span></span>
<span id="cb32-1336"><a href="#cb32-1336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1337"><a href="#cb32-1337" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # save --&gt;</span></span>
<span id="cb32-1338"><a href="#cb32-1338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1339"><a href="#cb32-1339" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # get sample weights --&gt;</span></span>
<span id="cb32-1340"><a href="#cb32-1340" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- dt_18 &lt;- dat_long |&gt; filter(wave == 2018) --&gt;</span></span>
<span id="cb32-1341"><a href="#cb32-1341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1342"><a href="#cb32-1342" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # add sample weights --&gt;</span></span>
<span id="cb32-1343"><a href="#cb32-1343" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- df_impute_base$t0_sample_weights = dt_18$sample_weights --&gt;</span></span>
<span id="cb32-1344"><a href="#cb32-1344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1345"><a href="#cb32-1345" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # save --&gt;</span></span>
<span id="cb32-1346"><a href="#cb32-1346" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- here_save(df_impute_base, "df_impute_base") --&gt;</span></span>
<span id="cb32-1347"><a href="#cb32-1347" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb32-1348"><a href="#cb32-1348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1349"><a href="#cb32-1349" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Obtain censoring weights --&gt;</span></span>
<span id="cb32-1350"><a href="#cb32-1350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1351"><a href="#cb32-1351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1352"><a href="#cb32-1352" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb32-1353"><a href="#cb32-1353" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| eval: false --&gt;</span></span>
<span id="cb32-1354"><a href="#cb32-1354" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| echo: true --&gt;</span></span>
<span id="cb32-1355"><a href="#cb32-1355" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- df_impute_base &lt;- here_read("df_impute_base") --&gt;</span></span>
<span id="cb32-1356"><a href="#cb32-1356" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #  --&gt;</span></span>
<span id="cb32-1357"><a href="#cb32-1357" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # # is.factor(df_impute_base$t0_perfectionism_cat) --&gt;</span></span>
<span id="cb32-1358"><a href="#cb32-1358" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # # get correct censoring  --&gt;</span></span>
<span id="cb32-1359"><a href="#cb32-1359" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # t0_na_condition &lt;- --&gt;</span></span>
<span id="cb32-1360"><a href="#cb32-1360" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #   rowSums(is.na(select(df_impute_base, starts_with("t1_")))) &gt; 0 --&gt;</span></span>
<span id="cb32-1361"><a href="#cb32-1361" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # t1_na_condition &lt;- --&gt;</span></span>
<span id="cb32-1362"><a href="#cb32-1362" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #   rowSums(is.na(select(df_impute_base, starts_with("t2_")))) &gt; 0 --&gt;</span></span>
<span id="cb32-1363"><a href="#cb32-1363" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #  --&gt;</span></span>
<span id="cb32-1364"><a href="#cb32-1364" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # str(df_impute_base$t1_perfectionism_cat) --&gt;</span></span>
<span id="cb32-1365"><a href="#cb32-1365" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #  --&gt;</span></span>
<span id="cb32-1366"><a href="#cb32-1366" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #  --&gt;</span></span>
<span id="cb32-1367"><a href="#cb32-1367" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #  --&gt;</span></span>
<span id="cb32-1368"><a href="#cb32-1368" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # # Revised data cleaning code --&gt;</span></span>
<span id="cb32-1369"><a href="#cb32-1369" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # df_clean &lt;- df_impute_base |&gt; --&gt;</span></span>
<span id="cb32-1370"><a href="#cb32-1370" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #   mutate(t0_censored = ifelse(t0_na_condition, 0, t0_censored)) |&gt; --&gt;</span></span>
<span id="cb32-1371"><a href="#cb32-1371" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #   mutate(t1_censored = ifelse(t1_na_condition, 0, t1_censored)) |&gt; --&gt;</span></span>
<span id="cb32-1372"><a href="#cb32-1372" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #   mutate(across(starts_with("t1_"), ~ ifelse(t0_censored == 0, NA, .)), --&gt;</span></span>
<span id="cb32-1373"><a href="#cb32-1373" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #          across(starts_with("t2_"), ~ ifelse(t0_censored == 0, NA, .))) |&gt; --&gt;</span></span>
<span id="cb32-1374"><a href="#cb32-1374" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #   mutate(across(starts_with("t2_"), ~ ifelse(t1_censored == 0, NA, .))) |&gt; --&gt;</span></span>
<span id="cb32-1375"><a href="#cb32-1375" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #   # Scale numeric variables, excluding t1_perfectionism_cat --&gt;</span></span>
<span id="cb32-1376"><a href="#cb32-1376" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #   mutate(across(where(is.numeric) &amp;  --&gt;</span></span>
<span id="cb32-1377"><a href="#cb32-1377" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #                 !any_of(c("t0_censored", "t0_sample_weights", "t1_censored", "t1_perfectionism_cat")),  --&gt;</span></span>
<span id="cb32-1378"><a href="#cb32-1378" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #                 ~ scale(.),  --&gt;</span></span>
<span id="cb32-1379"><a href="#cb32-1379" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #                 .names = "{.col}_z")) |&gt; --&gt;</span></span>
<span id="cb32-1380"><a href="#cb32-1380" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #   # Ensure t1_perfectionism_cat remains a factor --&gt;</span></span>
<span id="cb32-1381"><a href="#cb32-1381" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #   mutate(t1_perfectionism_cat = factor(t1_perfectionism_cat,  --&gt;</span></span>
<span id="cb32-1382"><a href="#cb32-1382" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #                                        levels = levels(df_impute_base$t1_perfectionism_cat), --&gt;</span></span>
<span id="cb32-1383"><a href="#cb32-1383" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #                                        ordered = TRUE)) |&gt; --&gt;</span></span>
<span id="cb32-1384"><a href="#cb32-1384" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #   select( --&gt;</span></span>
<span id="cb32-1385"><a href="#cb32-1385" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #     where(is.factor), --&gt;</span></span>
<span id="cb32-1386"><a href="#cb32-1386" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #     t0_sample_weights, --&gt;</span></span>
<span id="cb32-1387"><a href="#cb32-1387" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #     t0_censored, --&gt;</span></span>
<span id="cb32-1388"><a href="#cb32-1388" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #     t1_perfectionism_cat, --&gt;</span></span>
<span id="cb32-1389"><a href="#cb32-1389" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #     t1_censored, --&gt;</span></span>
<span id="cb32-1390"><a href="#cb32-1390" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #     ends_with("_z") --&gt;</span></span>
<span id="cb32-1391"><a href="#cb32-1391" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #   ) |&gt; --&gt;</span></span>
<span id="cb32-1392"><a href="#cb32-1392" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #   mutate(t0_lost = 1 - t1_censored, --&gt;</span></span>
<span id="cb32-1393"><a href="#cb32-1393" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #          t1_lost = 1 - t1_censored) |&gt;  --&gt;</span></span>
<span id="cb32-1394"><a href="#cb32-1394" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #   relocate(starts_with("t0_"), .before = starts_with("t1_")) |&gt; --&gt;</span></span>
<span id="cb32-1395"><a href="#cb32-1395" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #   relocate("t0_censored", .before = starts_with("t1_")) |&gt; --&gt;</span></span>
<span id="cb32-1396"><a href="#cb32-1396" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #   relocate("t1_censored", .before = starts_with("t2_")) --&gt;</span></span>
<span id="cb32-1397"><a href="#cb32-1397" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #  --&gt;</span></span>
<span id="cb32-1398"><a href="#cb32-1398" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # # Check the result --&gt;</span></span>
<span id="cb32-1399"><a href="#cb32-1399" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # print(str(df_clean$t1_perfectionism_cat)) --&gt;</span></span>
<span id="cb32-1400"><a href="#cb32-1400" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # print(levels(df_clean$t1_perfectionism_cat)) --&gt;</span></span>
<span id="cb32-1401"><a href="#cb32-1401" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # str(df_clean$t1_perfectionism_cat) --&gt;</span></span>
<span id="cb32-1402"><a href="#cb32-1402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1403"><a href="#cb32-1403" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # Get correct not_censored conditions --&gt;</span></span>
<span id="cb32-1404"><a href="#cb32-1404" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- t0_na_condition &lt;- rowSums(is.na(select(df_impute_base, starts_with("t1_")))) &gt; 0 --&gt;</span></span>
<span id="cb32-1405"><a href="#cb32-1405" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- t1_na_condition &lt;- rowSums(is.na(select(df_impute_base, starts_with("t2_")))) &gt; 0 --&gt;</span></span>
<span id="cb32-1406"><a href="#cb32-1406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1407"><a href="#cb32-1407" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # Revised data cleaning code --&gt;</span></span>
<span id="cb32-1408"><a href="#cb32-1408" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- df_clean &lt;- df_impute_base |&gt; --&gt;</span></span>
<span id="cb32-1409"><a href="#cb32-1409" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   mutate(t0_not_censored = ifelse(t0_na_condition, 0, 1), --&gt;</span></span>
<span id="cb32-1410"><a href="#cb32-1410" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--          t1_not_censored = ifelse(t1_na_condition, 0, 1)) --&gt;</span></span>
<span id="cb32-1411"><a href="#cb32-1411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1412"><a href="#cb32-1412" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- print("t0_not_censored and t1_not_censored after initial mutation:") --&gt;</span></span>
<span id="cb32-1413"><a href="#cb32-1413" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- print(table(df_clean$t0_not_censored, df_clean$t1_not_censored)) --&gt;</span></span>
<span id="cb32-1414"><a href="#cb32-1414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1415"><a href="#cb32-1415" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- df_clean &lt;- df_clean |&gt; --&gt;</span></span>
<span id="cb32-1416"><a href="#cb32-1416" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # Apply NA conditions while preserving factor structure --&gt;</span></span>
<span id="cb32-1417"><a href="#cb32-1417" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   mutate(across(starts_with("t1_") &amp; !all_of("t1_perfectionism_cat"),  --&gt;</span></span>
<span id="cb32-1418"><a href="#cb32-1418" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                 ~ ifelse(t0_not_censored == 0, NA, .))) |&gt; --&gt;</span></span>
<span id="cb32-1419"><a href="#cb32-1419" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   mutate(across(starts_with("t2_"),  --&gt;</span></span>
<span id="cb32-1420"><a href="#cb32-1420" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                 ~ ifelse(t1_not_censored == 0, NA, .))) |&gt; --&gt;</span></span>
<span id="cb32-1421"><a href="#cb32-1421" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # Scale numeric variables, excluding t1_perfectionism_cat --&gt;</span></span>
<span id="cb32-1422"><a href="#cb32-1422" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   mutate(across(where(is.numeric) &amp;  --&gt;</span></span>
<span id="cb32-1423"><a href="#cb32-1423" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                 !any_of(c("t0_not_censored", "t0_sample_weights", "t1_not_censored", "t1_perfectionism_cat")),  --&gt;</span></span>
<span id="cb32-1424"><a href="#cb32-1424" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                 ~ scale(.),  --&gt;</span></span>
<span id="cb32-1425"><a href="#cb32-1425" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                 .names = "{.col}_z")) |&gt; --&gt;</span></span>
<span id="cb32-1426"><a href="#cb32-1426" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # Ensure t1_perfectionism_cat remains a factor and apply t1_not_censored condition --&gt;</span></span>
<span id="cb32-1427"><a href="#cb32-1427" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   mutate(t1_perfectionism_cat = factor(t1_perfectionism_cat,  --&gt;</span></span>
<span id="cb32-1428"><a href="#cb32-1428" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                                        levels = levels(df_impute_base$t1_perfectionism_cat), --&gt;</span></span>
<span id="cb32-1429"><a href="#cb32-1429" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                                        ordered = TRUE), --&gt;</span></span>
<span id="cb32-1430"><a href="#cb32-1430" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--          t1_perfectionism_cat = if_else(t1_not_censored == 0, NA_character_, as.character(t1_perfectionism_cat)), --&gt;</span></span>
<span id="cb32-1431"><a href="#cb32-1431" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--          t1_perfectionism_cat = factor(t1_perfectionism_cat,  --&gt;</span></span>
<span id="cb32-1432"><a href="#cb32-1432" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                                        levels = levels(df_impute_base$t1_perfectionism_cat), --&gt;</span></span>
<span id="cb32-1433"><a href="#cb32-1433" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                                        ordered = TRUE)) --&gt;</span></span>
<span id="cb32-1434"><a href="#cb32-1434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1435"><a href="#cb32-1435" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- print("t1_perfectionism_cat after applying conditions:") --&gt;</span></span>
<span id="cb32-1436"><a href="#cb32-1436" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- print(table(df_clean$t1_perfectionism_cat, useNA = "ifany")) --&gt;</span></span>
<span id="cb32-1437"><a href="#cb32-1437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1438"><a href="#cb32-1438" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- df_clean &lt;- df_clean |&gt; --&gt;</span></span>
<span id="cb32-1439"><a href="#cb32-1439" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   select( --&gt;</span></span>
<span id="cb32-1440"><a href="#cb32-1440" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     where(is.factor), --&gt;</span></span>
<span id="cb32-1441"><a href="#cb32-1441" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     t0_sample_weights, --&gt;</span></span>
<span id="cb32-1442"><a href="#cb32-1442" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     t0_not_censored, --&gt;</span></span>
<span id="cb32-1443"><a href="#cb32-1443" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     t1_perfectionism_cat, --&gt;</span></span>
<span id="cb32-1444"><a href="#cb32-1444" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     t1_not_censored, --&gt;</span></span>
<span id="cb32-1445"><a href="#cb32-1445" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     ends_with("_z") --&gt;</span></span>
<span id="cb32-1446"><a href="#cb32-1446" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   ) |&gt; --&gt;</span></span>
<span id="cb32-1447"><a href="#cb32-1447" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   mutate(t0_lost = 1 - t1_not_censored, --&gt;</span></span>
<span id="cb32-1448"><a href="#cb32-1448" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--          t1_lost = 1 - t1_not_censored) |&gt;  --&gt;</span></span>
<span id="cb32-1449"><a href="#cb32-1449" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   relocate(starts_with("t0_"), .before = starts_with("t1_")) |&gt; --&gt;</span></span>
<span id="cb32-1450"><a href="#cb32-1450" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   relocate("t0_not_censored", .before = starts_with("t1_")) |&gt; --&gt;</span></span>
<span id="cb32-1451"><a href="#cb32-1451" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   relocate("t1_not_censored", .before = starts_with("t2_")) --&gt;</span></span>
<span id="cb32-1452"><a href="#cb32-1452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1453"><a href="#cb32-1453" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # final checks --&gt;</span></span>
<span id="cb32-1454"><a href="#cb32-1454" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- print("Final t0_not_censored and t1_not_censored:") --&gt;</span></span>
<span id="cb32-1455"><a href="#cb32-1455" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- print(table(df_clean$t0_not_censored, df_clean$t1_not_censored)) --&gt;</span></span>
<span id="cb32-1456"><a href="#cb32-1456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1457"><a href="#cb32-1457" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- print("Final t1_perfectionism_cat:") --&gt;</span></span>
<span id="cb32-1458"><a href="#cb32-1458" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- print(table(df_clean$t1_perfectionism_cat, useNA = "ifany")) --&gt;</span></span>
<span id="cb32-1459"><a href="#cb32-1459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1460"><a href="#cb32-1460" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- print("Relationship between t1_not_censored and t1_perfectionism_cat:") --&gt;</span></span>
<span id="cb32-1461"><a href="#cb32-1461" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- print(table(df_clean$t1_not_censored, is.na(df_clean$t1_perfectionism_cat))) --&gt;</span></span>
<span id="cb32-1462"><a href="#cb32-1462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1463"><a href="#cb32-1463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1464"><a href="#cb32-1464" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # get rid of attributes --&gt;</span></span>
<span id="cb32-1465"><a href="#cb32-1465" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- df_clean &lt;- margot::remove_numeric_attributes(df_clean) --&gt;</span></span>
<span id="cb32-1466"><a href="#cb32-1466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1467"><a href="#cb32-1467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1468"><a href="#cb32-1468" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # censoring --------------------------------------------------------------- --&gt;</span></span>
<span id="cb32-1469"><a href="#cb32-1469" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- baseline_vars_models_ml = df_clean |&gt;  # post process of impute and combine --&gt;</span></span>
<span id="cb32-1470"><a href="#cb32-1470" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   dplyr::select(starts_with("t0"), -t0_not_censored, -t0_lost, -t0_sample_weights)|&gt; colnames() # note, we ear --&gt;</span></span>
<span id="cb32-1471"><a href="#cb32-1471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1472"><a href="#cb32-1472" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- baseline_vars_models_ml --&gt;</span></span>
<span id="cb32-1473"><a href="#cb32-1473" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # fit proponsity score model  --&gt;</span></span>
<span id="cb32-1474"><a href="#cb32-1474" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # match_censoring &lt;- margot::match_mi_general(data = df_clean,  --&gt;</span></span>
<span id="cb32-1475"><a href="#cb32-1475" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #                                       X = "t1_lost",  --&gt;</span></span>
<span id="cb32-1476"><a href="#cb32-1476" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #                                       baseline_vars = baseline_vars_models,  --&gt;</span></span>
<span id="cb32-1477"><a href="#cb32-1477" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #                                       estimand = "ATE",   --&gt;</span></span>
<span id="cb32-1478"><a href="#cb32-1478" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #                                       # focal = "&lt; &gt;", for ATT --&gt;</span></span>
<span id="cb32-1479"><a href="#cb32-1479" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #                                       method = "cbps",  --&gt;</span></span>
<span id="cb32-1480"><a href="#cb32-1480" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #                                       sample_weights = "sample_weights") --&gt;</span></span>
<span id="cb32-1481"><a href="#cb32-1481" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #  --&gt;</span></span>
<span id="cb32-1482"><a href="#cb32-1482" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # # save output --&gt;</span></span>
<span id="cb32-1483"><a href="#cb32-1483" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # here_save( match_censoring, "match_censoring")  # another approach --&gt;</span></span>
<span id="cb32-1484"><a href="#cb32-1484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1485"><a href="#cb32-1485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1486"><a href="#cb32-1486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1487"><a href="#cb32-1487" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- df_clean_pre &lt;- df_clean[baseline_vars_models_ml] --&gt;</span></span>
<span id="cb32-1488"><a href="#cb32-1488" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # colnames(df_clean_pre) --&gt;</span></span>
<span id="cb32-1489"><a href="#cb32-1489" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # Perform one-hot encoding using model.matrix --&gt;</span></span>
<span id="cb32-1490"><a href="#cb32-1490" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- encoded_vars &lt;- model.matrix(~  t0_perfectionism_cat + t0_eth_cat - 1, data = df_clean_pre) --&gt;</span></span>
<span id="cb32-1491"><a href="#cb32-1491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1492"><a href="#cb32-1492" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # convert matrix to data frame --&gt;</span></span>
<span id="cb32-1493"><a href="#cb32-1493" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- encoded_df &lt;- as.data.frame(encoded_vars) --&gt;</span></span>
<span id="cb32-1494"><a href="#cb32-1494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1495"><a href="#cb32-1495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1496"><a href="#cb32-1496" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # make better names (if needed) --&gt;</span></span>
<span id="cb32-1497"><a href="#cb32-1497" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- encoded_df &lt;- encoded_df |&gt; --&gt;</span></span>
<span id="cb32-1498"><a href="#cb32-1498" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   janitor::clean_names() --&gt;</span></span>
<span id="cb32-1499"><a href="#cb32-1499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1500"><a href="#cb32-1500" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # View the first few rows to confirm structure --&gt;</span></span>
<span id="cb32-1501"><a href="#cb32-1501" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- head(encoded_df) --&gt;</span></span>
<span id="cb32-1502"><a href="#cb32-1502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1503"><a href="#cb32-1503" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # bind the new one-hot encoded variables back to the original dataframe --&gt;</span></span>
<span id="cb32-1504"><a href="#cb32-1504" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # ensure to remove original categorical variables to avoid duplication --&gt;</span></span>
<span id="cb32-1505"><a href="#cb32-1505" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- df_clean_hot &lt;- df_clean |&gt; --&gt;</span></span>
<span id="cb32-1506"><a href="#cb32-1506" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   select(-c(t0_eth_cat,t0_perfectionism_cat)) |&gt; --&gt;</span></span>
<span id="cb32-1507"><a href="#cb32-1507" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   bind_cols(encoded_df) --&gt;</span></span>
<span id="cb32-1508"><a href="#cb32-1508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1509"><a href="#cb32-1509" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # extract and print the new column names for encoded variables --&gt;</span></span>
<span id="cb32-1510"><a href="#cb32-1510" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- new_encoded_colnames &lt;- colnames(encoded_df) --&gt;</span></span>
<span id="cb32-1511"><a href="#cb32-1511" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- print(new_encoded_colnames) --&gt;</span></span>
<span id="cb32-1512"><a href="#cb32-1512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1513"><a href="#cb32-1513" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- new_encoded_colnames --&gt;</span></span>
<span id="cb32-1514"><a href="#cb32-1514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1515"><a href="#cb32-1515" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- colnames(df_clean_pre) --&gt;</span></span>
<span id="cb32-1516"><a href="#cb32-1516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1517"><a href="#cb32-1517" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # assuming you have a base list of predictors --&gt;</span></span>
<span id="cb32-1518"><a href="#cb32-1518" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- baseline_vars_set &lt;- setdiff(names(df_clean_pre), c("t0_lost", "t0_eth_cat", "t0_perfectionism_cat")) --&gt;</span></span>
<span id="cb32-1519"><a href="#cb32-1519" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- baseline_vars_set --&gt;</span></span>
<span id="cb32-1520"><a href="#cb32-1520" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # Add the new encoded column names --&gt;</span></span>
<span id="cb32-1521"><a href="#cb32-1521" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- full_predictor_vars &lt;- c(baseline_vars_set, new_encoded_colnames) --&gt;</span></span>
<span id="cb32-1522"><a href="#cb32-1522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1523"><a href="#cb32-1523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1524"><a href="#cb32-1524" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # check --&gt;</span></span>
<span id="cb32-1525"><a href="#cb32-1525" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- full_predictor_vars --&gt;</span></span>
<span id="cb32-1526"><a href="#cb32-1526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1527"><a href="#cb32-1527" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # cross validated sets --&gt;</span></span>
<span id="cb32-1528"><a href="#cb32-1528" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- cv_control &lt;- list(V = 10, stratifyCV = TRUE)  # 10-fold CV with stratification --&gt;</span></span>
<span id="cb32-1529"><a href="#cb32-1529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1530"><a href="#cb32-1530" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # use super learner --&gt;</span></span>
<span id="cb32-1531"><a href="#cb32-1531" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- library(SuperLearner) --&gt;</span></span>
<span id="cb32-1532"><a href="#cb32-1532" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- library(ranger) --&gt;</span></span>
<span id="cb32-1533"><a href="#cb32-1533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1534"><a href="#cb32-1534" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # Multi core --&gt;</span></span>
<span id="cb32-1535"><a href="#cb32-1535" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- library(doParallel) --&gt;</span></span>
<span id="cb32-1536"><a href="#cb32-1536" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- library(SuperLearner) --&gt;</span></span>
<span id="cb32-1537"><a href="#cb32-1537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1538"><a href="#cb32-1538" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # check predictors --&gt;</span></span>
<span id="cb32-1539"><a href="#cb32-1539" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- str(df_clean_hot[full_predictor_vars]) --&gt;</span></span>
<span id="cb32-1540"><a href="#cb32-1540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1541"><a href="#cb32-1541" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # make library e.g. simple library --&gt;</span></span>
<span id="cb32-1542"><a href="#cb32-1542" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # list learners --&gt;</span></span>
<span id="cb32-1543"><a href="#cb32-1543" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- listWrappers() --&gt;</span></span>
<span id="cb32-1544"><a href="#cb32-1544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1545"><a href="#cb32-1545" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- match_lib = c("SL.glmnet", "SL.ranger") --&gt;</span></span>
<span id="cb32-1546"><a href="#cb32-1546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1547"><a href="#cb32-1547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1548"><a href="#cb32-1548" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # Set up parallel backend --&gt;</span></span>
<span id="cb32-1549"><a href="#cb32-1549" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- no_cores &lt;- detectCores() --&gt;</span></span>
<span id="cb32-1550"><a href="#cb32-1550" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- cl &lt;- makeCluster(no_cores - 1) --&gt;</span></span>
<span id="cb32-1551"><a href="#cb32-1551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1552"><a href="#cb32-1552" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # start parrallel --&gt;</span></span>
<span id="cb32-1553"><a href="#cb32-1553" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- registerDoParallel(cl) --&gt;</span></span>
<span id="cb32-1554"><a href="#cb32-1554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1555"><a href="#cb32-1555" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # propensity scores for censoring --&gt;</span></span>
<span id="cb32-1556"><a href="#cb32-1556" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- sl &lt;- SuperLearner( --&gt;</span></span>
<span id="cb32-1557"><a href="#cb32-1557" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   Y = df_clean_hot$t1_lost,  --&gt;</span></span>
<span id="cb32-1558"><a href="#cb32-1558" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   X = df_clean_hot[full_predictor_vars],  # Use all specified predictors --&gt;</span></span>
<span id="cb32-1559"><a href="#cb32-1559" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   SL.library = match_lib, --&gt;</span></span>
<span id="cb32-1560"><a href="#cb32-1560" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   family = binomial(),  --&gt;</span></span>
<span id="cb32-1561"><a href="#cb32-1561" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   method = "method.NNloglik",  --&gt;</span></span>
<span id="cb32-1562"><a href="#cb32-1562" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   cvControl = list(V = 10) --&gt;</span></span>
<span id="cb32-1563"><a href="#cb32-1563" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ) --&gt;</span></span>
<span id="cb32-1564"><a href="#cb32-1564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1565"><a href="#cb32-1565" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # save your model --&gt;</span></span>
<span id="cb32-1566"><a href="#cb32-1566" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- here_save(sl, "sl") --&gt;</span></span>
<span id="cb32-1567"><a href="#cb32-1567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1568"><a href="#cb32-1568" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # stop your cluster --&gt;</span></span>
<span id="cb32-1569"><a href="#cb32-1569" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- stopCluster(cl) --&gt;</span></span>
<span id="cb32-1570"><a href="#cb32-1570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1571"><a href="#cb32-1571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1572"><a href="#cb32-1572" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # checks  --&gt;</span></span>
<span id="cb32-1573"><a href="#cb32-1573" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- print(sl)                  # prints the summary of the SuperLearner output --&gt;</span></span>
<span id="cb32-1574"><a href="#cb32-1574" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- summary(sl)                # provides a detailed summary, including cross-validated risks --&gt;</span></span>
<span id="cb32-1575"><a href="#cb32-1575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1576"><a href="#cb32-1576" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # detailed examination of cross-validated performance --&gt;</span></span>
<span id="cb32-1577"><a href="#cb32-1577" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- sl$cvRisk                  # cross-validated risks for each learner --&gt;</span></span>
<span id="cb32-1578"><a href="#cb32-1578" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- sl$coef                    # weights assigned to each learner in the final ensemble --&gt;</span></span>
<span id="cb32-1579"><a href="#cb32-1579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1580"><a href="#cb32-1580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1581"><a href="#cb32-1581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1582"><a href="#cb32-1582" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # generate predictions from the model --&gt;</span></span>
<span id="cb32-1583"><a href="#cb32-1583" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- predictions &lt;- predict(sl, newdata = df_clean_hot[full_predictor_vars], type = "response") --&gt;</span></span>
<span id="cb32-1584"><a href="#cb32-1584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1585"><a href="#cb32-1585" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # extract predictions from the 'pred' component and ensure it's a vector --&gt;</span></span>
<span id="cb32-1586"><a href="#cb32-1586" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- df_clean_hot$pscore &lt;- predictions$pred[, 1] --&gt;</span></span>
<span id="cb32-1587"><a href="#cb32-1587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1588"><a href="#cb32-1588" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # Check the structure of the predictions --&gt;</span></span>
<span id="cb32-1589"><a href="#cb32-1589" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- str(predictions) --&gt;</span></span>
<span id="cb32-1590"><a href="#cb32-1590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1591"><a href="#cb32-1591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1592"><a href="#cb32-1592" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- df_clean$cens_weights &lt;- ifelse(df_clean_hot$t0_lost == 1, 1 / df_clean_hot$pscore, 1 / (1 - df_clean_hot$pscore)) --&gt;</span></span>
<span id="cb32-1593"><a href="#cb32-1593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1594"><a href="#cb32-1594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1595"><a href="#cb32-1595" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # check  --&gt;</span></span>
<span id="cb32-1596"><a href="#cb32-1596" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- hist(df_clean$cens_weights) --&gt;</span></span>
<span id="cb32-1597"><a href="#cb32-1597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1598"><a href="#cb32-1598" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- mean(df_clean$cens_weights) --&gt;</span></span>
<span id="cb32-1599"><a href="#cb32-1599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1600"><a href="#cb32-1600" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- max(df_clean$cens_weights) --&gt;</span></span>
<span id="cb32-1601"><a href="#cb32-1601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1602"><a href="#cb32-1602" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- min(df_clean$cens_weights) --&gt;</span></span>
<span id="cb32-1603"><a href="#cb32-1603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1604"><a href="#cb32-1604" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Stabalise weights --&gt;</span></span>
<span id="cb32-1605"><a href="#cb32-1605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1606"><a href="#cb32-1606" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- marginal_censored&lt;- mean(df_clean$t0_lost) --&gt;</span></span>
<span id="cb32-1607"><a href="#cb32-1607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1608"><a href="#cb32-1608" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # stabalised weights --&gt;</span></span>
<span id="cb32-1609"><a href="#cb32-1609" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- df_clean$weights_stabilised &lt;- ifelse(df_clean_hot$t0_lost == 1, --&gt;</span></span>
<span id="cb32-1610"><a href="#cb32-1610" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                                   marginal_censored / df_clean_hot$pscore, --&gt;</span></span>
<span id="cb32-1611"><a href="#cb32-1611" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                                   (1 - marginal_censored) / (1 - df_clean_hot$pscore)) --&gt;</span></span>
<span id="cb32-1612"><a href="#cb32-1612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1613"><a href="#cb32-1613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1614"><a href="#cb32-1614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1615"><a href="#cb32-1615" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- hist(df_clean$weights_stabilised ) --&gt;</span></span>
<span id="cb32-1616"><a href="#cb32-1616" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- min(df_clean$weights_stabilised ) --&gt;</span></span>
<span id="cb32-1617"><a href="#cb32-1617" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- max(df_clean$weights_stabilised ) --&gt;</span></span>
<span id="cb32-1618"><a href="#cb32-1618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1619"><a href="#cb32-1619" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # new weights --&gt;</span></span>
<span id="cb32-1620"><a href="#cb32-1620" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- df_clean$t0_combo_weights = df_clean$weights_stabilised * df_clean$t0_sample_weights --&gt;</span></span>
<span id="cb32-1621"><a href="#cb32-1621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1622"><a href="#cb32-1622" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- min( df_clean$t0_combo_weights) --&gt;</span></span>
<span id="cb32-1623"><a href="#cb32-1623" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- max( df_clean$t0_combo_weights) --&gt;</span></span>
<span id="cb32-1624"><a href="#cb32-1624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1625"><a href="#cb32-1625" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- hist( df_clean$t0_combo_weights) --&gt;</span></span>
<span id="cb32-1626"><a href="#cb32-1626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1627"><a href="#cb32-1627" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- here_save(df_clean, "df_clean") --&gt;</span></span>
<span id="cb32-1628"><a href="#cb32-1628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1629"><a href="#cb32-1629" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # save the censored sample  --&gt;</span></span>
<span id="cb32-1630"><a href="#cb32-1630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1631"><a href="#cb32-1631" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- df_clean_t2 &lt;- df_clean |&gt; --&gt;</span></span>
<span id="cb32-1632"><a href="#cb32-1632" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   filter(!is.na(t1_lost)) |&gt;  --&gt;</span></span>
<span id="cb32-1633"><a href="#cb32-1633" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--  select(-cens_weights, -marginal_censored) |&gt;  --&gt;</span></span>
<span id="cb32-1634"><a href="#cb32-1634" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   select(-all_of(c("t0_lost", "t1_lost"))) |&gt;  --&gt;</span></span>
<span id="cb32-1635"><a href="#cb32-1635" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   relocate(starts_with("t0_"), .before = starts_with("t1_")) |&gt; --&gt;</span></span>
<span id="cb32-1636"><a href="#cb32-1636" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   relocate("t0_censored", .before = starts_with("t1_"))  |&gt; --&gt;</span></span>
<span id="cb32-1637"><a href="#cb32-1637" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   relocate("t1_censored", .before = starts_with("t2_")) |&gt;  --&gt;</span></span>
<span id="cb32-1638"><a href="#cb32-1638" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   relocate("weights_stabilised", .before = starts_with("t0_")) --&gt;</span></span>
<span id="cb32-1639"><a href="#cb32-1639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1640"><a href="#cb32-1640" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- colnames(df_clean_t2) --&gt;</span></span>
<span id="cb32-1641"><a href="#cb32-1641" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- here_save(df_clean_t2, "df_clean_t2") --&gt;</span></span>
<span id="cb32-1642"><a href="#cb32-1642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1643"><a href="#cb32-1643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1644"><a href="#cb32-1644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1645"><a href="#cb32-1645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1646"><a href="#cb32-1646" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # Diagnostic steps --&gt;</span></span>
<span id="cb32-1647"><a href="#cb32-1647" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- print("Original data:") --&gt;</span></span>
<span id="cb32-1648"><a href="#cb32-1648" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- print(str(df_impute_base$t1_perfectionism_cat)) --&gt;</span></span>
<span id="cb32-1649"><a href="#cb32-1649" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- print(table(df_impute_base$t1_perfectionism_cat, useNA = "ifany")) --&gt;</span></span>
<span id="cb32-1650"><a href="#cb32-1650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1651"><a href="#cb32-1651" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # Revised data cleaning code --&gt;</span></span>
<span id="cb32-1652"><a href="#cb32-1652" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- df_clean &lt;- df_impute_base |&gt; --&gt;</span></span>
<span id="cb32-1653"><a href="#cb32-1653" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   mutate(t0_censored = ifelse(t0_na_condition, 0, t0_censored)) |&gt; --&gt;</span></span>
<span id="cb32-1654"><a href="#cb32-1654" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   mutate(t1_censored = ifelse(t1_na_condition, 0, t1_censored)) |&gt; --&gt;</span></span>
<span id="cb32-1655"><a href="#cb32-1655" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # Remove the lines that might be introducing NAs --&gt;</span></span>
<span id="cb32-1656"><a href="#cb32-1656" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # mutate(across(starts_with("t1_"), ~ ifelse(t0_censored == 0, NA, .)), --&gt;</span></span>
<span id="cb32-1657"><a href="#cb32-1657" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   #        across(starts_with("t2_"), ~ ifelse(t0_censored == 0, NA, .))) |&gt; --&gt;</span></span>
<span id="cb32-1658"><a href="#cb32-1658" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # mutate(across(starts_with("t2_"), ~ ifelse(t1_censored == 0, NA, .))) |&gt; --&gt;</span></span>
<span id="cb32-1659"><a href="#cb32-1659" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # Scale numeric variables, excluding t1_perfectionism_cat --&gt;</span></span>
<span id="cb32-1660"><a href="#cb32-1660" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   mutate(across(where(is.numeric) &amp;  --&gt;</span></span>
<span id="cb32-1661"><a href="#cb32-1661" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                 !any_of(c("t0_censored", "t0_sample_weights", "t1_censored", "t1_perfectionism_cat")),  --&gt;</span></span>
<span id="cb32-1662"><a href="#cb32-1662" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                 ~ scale(.),  --&gt;</span></span>
<span id="cb32-1663"><a href="#cb32-1663" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                 .names = "{.col}_z")) |&gt; --&gt;</span></span>
<span id="cb32-1664"><a href="#cb32-1664" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # Ensure t1_perfectionism_cat remains a factor --&gt;</span></span>
<span id="cb32-1665"><a href="#cb32-1665" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   mutate(t1_perfectionism_cat = factor(t1_perfectionism_cat,  --&gt;</span></span>
<span id="cb32-1666"><a href="#cb32-1666" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                                        levels = levels(df_impute_base$t1_perfectionism_cat), --&gt;</span></span>
<span id="cb32-1667"><a href="#cb32-1667" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                                        ordered = TRUE)) |&gt; --&gt;</span></span>
<span id="cb32-1668"><a href="#cb32-1668" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   select( --&gt;</span></span>
<span id="cb32-1669"><a href="#cb32-1669" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     where(is.factor), --&gt;</span></span>
<span id="cb32-1670"><a href="#cb32-1670" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     t0_sample_weights, --&gt;</span></span>
<span id="cb32-1671"><a href="#cb32-1671" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     t0_censored, --&gt;</span></span>
<span id="cb32-1672"><a href="#cb32-1672" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     t1_perfectionism_cat, --&gt;</span></span>
<span id="cb32-1673"><a href="#cb32-1673" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     t1_censored, --&gt;</span></span>
<span id="cb32-1674"><a href="#cb32-1674" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     ends_with("_z") --&gt;</span></span>
<span id="cb32-1675"><a href="#cb32-1675" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   ) |&gt; --&gt;</span></span>
<span id="cb32-1676"><a href="#cb32-1676" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   mutate(t0_lost = 1 - t1_censored, --&gt;</span></span>
<span id="cb32-1677"><a href="#cb32-1677" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--          t1_lost = 1 - t1_censored) |&gt;  --&gt;</span></span>
<span id="cb32-1678"><a href="#cb32-1678" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   relocate(starts_with("t0_"), .before = starts_with("t1_")) |&gt; --&gt;</span></span>
<span id="cb32-1679"><a href="#cb32-1679" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   relocate("t0_censored", .before = starts_with("t1_")) |&gt; --&gt;</span></span>
<span id="cb32-1680"><a href="#cb32-1680" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   relocate("t1_censored", .before = starts_with("t2_")) --&gt;</span></span>
<span id="cb32-1681"><a href="#cb32-1681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1682"><a href="#cb32-1682" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # Check the result --&gt;</span></span>
<span id="cb32-1683"><a href="#cb32-1683" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- print("Cleaned data:") --&gt;</span></span>
<span id="cb32-1684"><a href="#cb32-1684" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- print(str(df_clean$t1_perfectionism_cat)) --&gt;</span></span>
<span id="cb32-1685"><a href="#cb32-1685" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- print(table(df_clean$t1_perfectionism_cat, useNA = "ifany")) --&gt;</span></span>
<span id="cb32-1686"><a href="#cb32-1686" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- print(levels(df_clean$t1_perfectionism_cat)) --&gt;</span></span>
<span id="cb32-1687"><a href="#cb32-1687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1688"><a href="#cb32-1688" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # If NAs are still present, investigate which rows have NAs --&gt;</span></span>
<span id="cb32-1689"><a href="#cb32-1689" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- if(any(is.na(df_clean$t1_perfectionism_cat))) { --&gt;</span></span>
<span id="cb32-1690"><a href="#cb32-1690" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   print("Rows with NAs in t1_perfectionism_cat:") --&gt;</span></span>
<span id="cb32-1691"><a href="#cb32-1691" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   print(df_clean[is.na(df_clean$t1_perfectionism_cat),  --&gt;</span></span>
<span id="cb32-1692"><a href="#cb32-1692" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                  c("t0_censored", "t1_censored", "t1_perfectionism_cat")]) --&gt;</span></span>
<span id="cb32-1693"><a href="#cb32-1693" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- } --&gt;</span></span>
<span id="cb32-1694"><a href="#cb32-1694" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb32-1695"><a href="#cb32-1695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1696"><a href="#cb32-1696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1697"><a href="#cb32-1697" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Matching in subgroups --&gt;</span></span>
<span id="cb32-1698"><a href="#cb32-1698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1699"><a href="#cb32-1699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1700"><a href="#cb32-1700" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Subgroup analysis  --&gt;</span></span>
<span id="cb32-1701"><a href="#cb32-1701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1702"><a href="#cb32-1702" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb32-1703"><a href="#cb32-1703" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| label: subgroup_weights --&gt;</span></span>
<span id="cb32-1704"><a href="#cb32-1704" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| eval: false --&gt;</span></span>
<span id="cb32-1705"><a href="#cb32-1705" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| echo: true --&gt;</span></span>
<span id="cb32-1706"><a href="#cb32-1706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1707"><a href="#cb32-1707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1708"><a href="#cb32-1708" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- hist(df_clean_filtered$sample_weights) --&gt;</span></span>
<span id="cb32-1709"><a href="#cb32-1709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1710"><a href="#cb32-1710" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # next propensity scores by groups  --&gt;</span></span>
<span id="cb32-1711"><a href="#cb32-1711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1712"><a href="#cb32-1712" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- levels(df_clean_t2$t0_eth_cat) --&gt;</span></span>
<span id="cb32-1713"><a href="#cb32-1713" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- levels(df_clean_t2$t1_perfectionism_4tile) --&gt;</span></span>
<span id="cb32-1714"><a href="#cb32-1714" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #  --&gt;</span></span>
<span id="cb32-1715"><a href="#cb32-1715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1716"><a href="#cb32-1716" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- df_subgroup &lt;-df_clean_t2 |&gt; filter(t0_eth_cat == "maori" | t0_eth_cat == "euro") |&gt; droplevels() --&gt;</span></span>
<span id="cb32-1717"><a href="#cb32-1717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1718"><a href="#cb32-1718" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # save --&gt;</span></span>
<span id="cb32-1719"><a href="#cb32-1719" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- here_save(df_subgroup, "df_subgroup") --&gt;</span></span>
<span id="cb32-1720"><a href="#cb32-1720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1721"><a href="#cb32-1721" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # check --&gt;</span></span>
<span id="cb32-1722"><a href="#cb32-1722" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- table(df_subgroup$t0_eth_cat) --&gt;</span></span>
<span id="cb32-1723"><a href="#cb32-1723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1724"><a href="#cb32-1724" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- baseline_vars_models_sans_eth &lt;- setdiff(baseline_vars_models, "t0_eth_cat") --&gt;</span></span>
<span id="cb32-1725"><a href="#cb32-1725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1726"><a href="#cb32-1726" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # save --&gt;</span></span>
<span id="cb32-1727"><a href="#cb32-1727" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- here_save(baseline_vars_models_sans_eth, "baseline_vars_models_sans_eth") --&gt;</span></span>
<span id="cb32-1728"><a href="#cb32-1728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1729"><a href="#cb32-1729" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ##  --&gt;</span></span>
<span id="cb32-1730"><a href="#cb32-1730" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- string &lt;- formula_str &lt;- as.formula(paste("t1_perfectionism_4tile", "~", paste(baseline_vars_models, collapse = "+"))) --&gt;</span></span>
<span id="cb32-1731"><a href="#cb32-1731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1732"><a href="#cb32-1732" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- string_sans &lt;- formula_str &lt;- as.formula(paste("t1_perfectionism_4tile", "~", paste(baseline_vars_models_sans_eth, collapse = "+"))) --&gt;</span></span>
<span id="cb32-1733"><a href="#cb32-1733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1734"><a href="#cb32-1734" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- W1 &lt;- weightit( --&gt;</span></span>
<span id="cb32-1735"><a href="#cb32-1735" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   string, --&gt;</span></span>
<span id="cb32-1736"><a href="#cb32-1736" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   method = "ipt", --&gt;</span></span>
<span id="cb32-1737"><a href="#cb32-1737" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   estimand = "ATT", --&gt;</span></span>
<span id="cb32-1738"><a href="#cb32-1738" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   weights = "weights_stabilised", --&gt;</span></span>
<span id="cb32-1739"><a href="#cb32-1739" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   focal = "tile_3", --&gt;</span></span>
<span id="cb32-1740"><a href="#cb32-1740" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # super = TRUE, --&gt;</span></span>
<span id="cb32-1741"><a href="#cb32-1741" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   #SL.library = c("SL.ranger", "SL.glmnet", "SL.polymars", "SL.xgboost"), --&gt;</span></span>
<span id="cb32-1742"><a href="#cb32-1742" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   #super = TRUE, --&gt;</span></span>
<span id="cb32-1743"><a href="#cb32-1743" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   data = df_subgroup --&gt;</span></span>
<span id="cb32-1744"><a href="#cb32-1744" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ) --&gt;</span></span>
<span id="cb32-1745"><a href="#cb32-1745" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- summary(W1) --&gt;</span></span>
<span id="cb32-1746"><a href="#cb32-1746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1747"><a href="#cb32-1747" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # save model --&gt;</span></span>
<span id="cb32-1748"><a href="#cb32-1748" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- here_save(W1, "W1") --&gt;</span></span>
<span id="cb32-1749"><a href="#cb32-1749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1750"><a href="#cb32-1750" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- W2 &lt;- weightit( --&gt;</span></span>
<span id="cb32-1751"><a href="#cb32-1751" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   string_sans, --&gt;</span></span>
<span id="cb32-1752"><a href="#cb32-1752" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   method = "ipt", --&gt;</span></span>
<span id="cb32-1753"><a href="#cb32-1753" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   estimand = "ATT", --&gt;</span></span>
<span id="cb32-1754"><a href="#cb32-1754" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   weights = "sample_weights", --&gt;</span></span>
<span id="cb32-1755"><a href="#cb32-1755" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   by = "t0_eth_cat", --&gt;</span></span>
<span id="cb32-1756"><a href="#cb32-1756" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   weights = "sample_weights", --&gt;</span></span>
<span id="cb32-1757"><a href="#cb32-1757" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   focal = "tile_3", --&gt;</span></span>
<span id="cb32-1758"><a href="#cb32-1758" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #  super = TRUE, --&gt;</span></span>
<span id="cb32-1759"><a href="#cb32-1759" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #  SL.library = c("SL.ranger", "SL.glmnet", "SL.polymars", "SL.xgboost"), --&gt;</span></span>
<span id="cb32-1760"><a href="#cb32-1760" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   data = df_subgroup --&gt;</span></span>
<span id="cb32-1761"><a href="#cb32-1761" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ) --&gt;</span></span>
<span id="cb32-1762"><a href="#cb32-1762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1763"><a href="#cb32-1763" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- summary(W2) --&gt;</span></span>
<span id="cb32-1764"><a href="#cb32-1764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1765"><a href="#cb32-1765" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # save model --&gt;</span></span>
<span id="cb32-1766"><a href="#cb32-1766" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- here_save(W2, "W2") --&gt;</span></span>
<span id="cb32-1767"><a href="#cb32-1767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1768"><a href="#cb32-1768" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # test diff --&gt;</span></span>
<span id="cb32-1769"><a href="#cb32-1769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1770"><a href="#cb32-1770" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #S &lt;- sbps(W1, W2) --&gt;</span></span>
<span id="cb32-1771"><a href="#cb32-1771" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # warnings() --&gt;</span></span>
<span id="cb32-1772"><a href="#cb32-1772" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # S --&gt;</span></span>
<span id="cb32-1773"><a href="#cb32-1773" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb32-1774"><a href="#cb32-1774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1775"><a href="#cb32-1775" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Evaluate subgroup weighting model --&gt;</span></span>
<span id="cb32-1776"><a href="#cb32-1776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1777"><a href="#cb32-1777" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb32-1778"><a href="#cb32-1778" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| fig-width: 12 --&gt;</span></span>
<span id="cb32-1779"><a href="#cb32-1779" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| fig-height: 12 --&gt;</span></span>
<span id="cb32-1780"><a href="#cb32-1780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1781"><a href="#cb32-1781" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- W1 &lt;- here_read("W1") --&gt;</span></span>
<span id="cb32-1782"><a href="#cb32-1782" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- W2 &lt;- here_read("W2") --&gt;</span></span>
<span id="cb32-1783"><a href="#cb32-1783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1784"><a href="#cb32-1784" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # read --&gt;</span></span>
<span id="cb32-1785"><a href="#cb32-1785" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- df_subgroup &lt;- margot::here_read("df_subgroup") --&gt;</span></span>
<span id="cb32-1786"><a href="#cb32-1786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1787"><a href="#cb32-1787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1788"><a href="#cb32-1788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1789"><a href="#cb32-1789" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # this method has better effective samples --&gt;</span></span>
<span id="cb32-1790"><a href="#cb32-1790" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #bal.tab(W1) --&gt;</span></span>
<span id="cb32-1791"><a href="#cb32-1791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1792"><a href="#cb32-1792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1793"><a href="#cb32-1793" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # this method has better balance --&gt;</span></span>
<span id="cb32-1794"><a href="#cb32-1794" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # bal.tab(W2, cluster = "t0_eth_cat") --&gt;</span></span>
<span id="cb32-1795"><a href="#cb32-1795" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # bal.tab(W1, cluster = "t0_eth_cat") --&gt;</span></span>
<span id="cb32-1796"><a href="#cb32-1796" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # graph by cluster --&gt;</span></span>
<span id="cb32-1797"><a href="#cb32-1797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1798"><a href="#cb32-1798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1799"><a href="#cb32-1799" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # W2 obtains better balance --&gt;</span></span>
<span id="cb32-1800"><a href="#cb32-1800" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- love.plot(W1,  cluster = "t0_eth_cat", binary = "std", thresholds = c(m = .1), --&gt;</span></span>
<span id="cb32-1801"><a href="#cb32-1801" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--           wrap = 50, position = "bottom", size =2) --&gt;</span></span>
<span id="cb32-1802"><a href="#cb32-1802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1803"><a href="#cb32-1803" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- love.plot(W2,  cluster = "t0_eth_cat", binary = "std", thresholds = c(m = .1), --&gt;</span></span>
<span id="cb32-1804"><a href="#cb32-1804" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--           wrap = 50, position = "bottom", size =2) --&gt;</span></span>
<span id="cb32-1805"><a href="#cb32-1805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1806"><a href="#cb32-1806" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # check marginal too --&gt;</span></span>
<span id="cb32-1807"><a href="#cb32-1807" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- love.plot(W2,   binary = "std", thresholds = c(m = .1), --&gt;</span></span>
<span id="cb32-1808"><a href="#cb32-1808" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--           wrap = 50, position = "bottom", size =2) --&gt;</span></span>
<span id="cb32-1809"><a href="#cb32-1809" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb32-1810"><a href="#cb32-1810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1811"><a href="#cb32-1811" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1812"><a href="#cb32-1812" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Parametric estimation of subgroup model --&gt;</span></span>
<span id="cb32-1813"><a href="#cb32-1813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1814"><a href="#cb32-1814" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb32-1815"><a href="#cb32-1815" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # prepare data --&gt;</span></span>
<span id="cb32-1816"><a href="#cb32-1816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1817"><a href="#cb32-1817" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # read vars --&gt;</span></span>
<span id="cb32-1818"><a href="#cb32-1818" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- baseline_vars_models_sans_eth &lt;- margot::here_read("baseline_vars_models_sans_eth") --&gt;</span></span>
<span id="cb32-1819"><a href="#cb32-1819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1820"><a href="#cb32-1820" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # make combo weights --&gt;</span></span>
<span id="cb32-1821"><a href="#cb32-1821" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- df_subgroup$combo_weights = W2$weights * df_subgroup$t0_combo_weights --&gt;</span></span>
<span id="cb32-1822"><a href="#cb32-1822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1823"><a href="#cb32-1823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1824"><a href="#cb32-1824" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # set dataframe --&gt;</span></span>
<span id="cb32-1825"><a href="#cb32-1825" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- df = df_subgroup --&gt;</span></span>
<span id="cb32-1826"><a href="#cb32-1826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1827"><a href="#cb32-1827" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> SUBGROUP analysis --&gt;</span></span>
<span id="cb32-1828"><a href="#cb32-1828" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Y_anxiety = "t2_kessler_latent_anxiety_z" --&gt;</span></span>
<span id="cb32-1829"><a href="#cb32-1829" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Y_depression = "t2_kessler_latent_depression_z" --&gt;</span></span>
<span id="cb32-1830"><a href="#cb32-1830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1831"><a href="#cb32-1831" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- X = "t1_perfectionism_4tile" --&gt;</span></span>
<span id="cb32-1832"><a href="#cb32-1832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1833"><a href="#cb32-1833" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- treat_0 = "tile_1" --&gt;</span></span>
<span id="cb32-1834"><a href="#cb32-1834" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- treat_1 = "tile_3" --&gt;</span></span>
<span id="cb32-1835"><a href="#cb32-1835" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- estimand = "ATT" --&gt;</span></span>
<span id="cb32-1836"><a href="#cb32-1836" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- scale = "RD" --&gt;</span></span>
<span id="cb32-1837"><a href="#cb32-1837" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- nsims = 1000 --&gt;</span></span>
<span id="cb32-1838"><a href="#cb32-1838" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- family = "gaussian" --&gt;</span></span>
<span id="cb32-1839"><a href="#cb32-1839" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- continuous_X = FALSE --&gt;</span></span>
<span id="cb32-1840"><a href="#cb32-1840" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- splines = FALSE --&gt;</span></span>
<span id="cb32-1841"><a href="#cb32-1841" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- cores = parallel::detectCores() --&gt;</span></span>
<span id="cb32-1842"><a href="#cb32-1842" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- S = "t0_eth_cat" --&gt;</span></span>
<span id="cb32-1843"><a href="#cb32-1843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1844"><a href="#cb32-1844" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # not we interact the subclass X treatment X covariates --&gt;</span></span>
<span id="cb32-1845"><a href="#cb32-1845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1846"><a href="#cb32-1846" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- formula_str_anxiety &lt;- --&gt;</span></span>
<span id="cb32-1847"><a href="#cb32-1847" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   paste( --&gt;</span></span>
<span id="cb32-1848"><a href="#cb32-1848" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     Y_anxiety, --&gt;</span></span>
<span id="cb32-1849"><a href="#cb32-1849" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     "~", --&gt;</span></span>
<span id="cb32-1850"><a href="#cb32-1850" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     S, --&gt;</span></span>
<span id="cb32-1851"><a href="#cb32-1851" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     "*", --&gt;</span></span>
<span id="cb32-1852"><a href="#cb32-1852" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     "(", --&gt;</span></span>
<span id="cb32-1853"><a href="#cb32-1853" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     X , --&gt;</span></span>
<span id="cb32-1854"><a href="#cb32-1854" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     "*", --&gt;</span></span>
<span id="cb32-1855"><a href="#cb32-1855" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     "(", --&gt;</span></span>
<span id="cb32-1856"><a href="#cb32-1856" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     paste(baseline_vars_models_sans_eth, collapse = "+"), --&gt;</span></span>
<span id="cb32-1857"><a href="#cb32-1857" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     ")", --&gt;</span></span>
<span id="cb32-1858"><a href="#cb32-1858" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     ")" --&gt;</span></span>
<span id="cb32-1859"><a href="#cb32-1859" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   ) --&gt;</span></span>
<span id="cb32-1860"><a href="#cb32-1860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1861"><a href="#cb32-1861" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- formula_str_depression &lt;- --&gt;</span></span>
<span id="cb32-1862"><a href="#cb32-1862" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   paste( --&gt;</span></span>
<span id="cb32-1863"><a href="#cb32-1863" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     Y_depression, --&gt;</span></span>
<span id="cb32-1864"><a href="#cb32-1864" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     "~", --&gt;</span></span>
<span id="cb32-1865"><a href="#cb32-1865" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     S, --&gt;</span></span>
<span id="cb32-1866"><a href="#cb32-1866" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     "*", --&gt;</span></span>
<span id="cb32-1867"><a href="#cb32-1867" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     "(", --&gt;</span></span>
<span id="cb32-1868"><a href="#cb32-1868" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     X , --&gt;</span></span>
<span id="cb32-1869"><a href="#cb32-1869" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     "*", --&gt;</span></span>
<span id="cb32-1870"><a href="#cb32-1870" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     "(", --&gt;</span></span>
<span id="cb32-1871"><a href="#cb32-1871" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     paste(baseline_vars_models_sans_eth, collapse = "+"), --&gt;</span></span>
<span id="cb32-1872"><a href="#cb32-1872" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     ")", --&gt;</span></span>
<span id="cb32-1873"><a href="#cb32-1873" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     ")" --&gt;</span></span>
<span id="cb32-1874"><a href="#cb32-1874" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   ) --&gt;</span></span>
<span id="cb32-1875"><a href="#cb32-1875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1876"><a href="#cb32-1876" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- formula_str_anxiety --&gt;</span></span>
<span id="cb32-1877"><a href="#cb32-1877" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- formula_str_depression --&gt;</span></span>
<span id="cb32-1878"><a href="#cb32-1878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1879"><a href="#cb32-1879" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # fit model --&gt;</span></span>
<span id="cb32-1880"><a href="#cb32-1880" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- fit_all_all_anxiety  &lt;- glm( --&gt;</span></span>
<span id="cb32-1881"><a href="#cb32-1881" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   as.formula(formula_str_anxiety), --&gt;</span></span>
<span id="cb32-1882"><a href="#cb32-1882" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   weights = combo_weights, --&gt;</span></span>
<span id="cb32-1883"><a href="#cb32-1883" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # weights = if (!is.null(weight_var)) weight_var else NULL, --&gt;</span></span>
<span id="cb32-1884"><a href="#cb32-1884" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   family = family, --&gt;</span></span>
<span id="cb32-1885"><a href="#cb32-1885" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   data = df --&gt;</span></span>
<span id="cb32-1886"><a href="#cb32-1886" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ) --&gt;</span></span>
<span id="cb32-1887"><a href="#cb32-1887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1888"><a href="#cb32-1888" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #summary(fit_all_all_anxiety) --&gt;</span></span>
<span id="cb32-1889"><a href="#cb32-1889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1890"><a href="#cb32-1890" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- fit_all_all_depression  &lt;- glm( --&gt;</span></span>
<span id="cb32-1891"><a href="#cb32-1891" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   as.formula(formula_str_depression), --&gt;</span></span>
<span id="cb32-1892"><a href="#cb32-1892" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   weights = combo_weights, --&gt;</span></span>
<span id="cb32-1893"><a href="#cb32-1893" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   # weights = if (!is.null(weight_var)) weight_var else NULL, --&gt;</span></span>
<span id="cb32-1894"><a href="#cb32-1894" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   family = family, --&gt;</span></span>
<span id="cb32-1895"><a href="#cb32-1895" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   data = df --&gt;</span></span>
<span id="cb32-1896"><a href="#cb32-1896" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ) --&gt;</span></span>
<span id="cb32-1897"><a href="#cb32-1897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1898"><a href="#cb32-1898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1899"><a href="#cb32-1899" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # coefs &lt;- coef(fit_all_all_anxiety) --&gt;</span></span>
<span id="cb32-1900"><a href="#cb32-1900" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # table(is.na(coefs))#     t0_eth_catmāori:t1_perfectionism_coarsen.Q:t0_gen_cohort.C --&gt;</span></span>
<span id="cb32-1901"><a href="#cb32-1901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1902"><a href="#cb32-1902" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # #FALSE  TRUE --&gt;</span></span>
<span id="cb32-1903"><a href="#cb32-1903" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # 344     4 --&gt;</span></span>
<span id="cb32-1904"><a href="#cb32-1904" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #  --&gt;</span></span>
<span id="cb32-1905"><a href="#cb32-1905" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # insight::get_varcov(fit_all_all_anxiety) --&gt;</span></span>
<span id="cb32-1906"><a href="#cb32-1906" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb32-1907"><a href="#cb32-1907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1908"><a href="#cb32-1908" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Subgroup Results  --&gt;</span></span>
<span id="cb32-1909"><a href="#cb32-1909" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1910"><a href="#cb32-1910" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb32-1911"><a href="#cb32-1911" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| label: sim_subgroup --&gt;</span></span>
<span id="cb32-1912"><a href="#cb32-1912" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| eval: false --&gt;</span></span>
<span id="cb32-1913"><a href="#cb32-1913" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| echo: true --&gt;</span></span>
<span id="cb32-1914"><a href="#cb32-1914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1915"><a href="#cb32-1915" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # simulate coefficients --&gt;</span></span>
<span id="cb32-1916"><a href="#cb32-1916" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- sim_model_all &lt;- sim(fit_all_all_anxiety, n = nsims, vcov = "HC2") --&gt;</span></span>
<span id="cb32-1917"><a href="#cb32-1917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1918"><a href="#cb32-1918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1919"><a href="#cb32-1919" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # simulate effect as modified in europeans --&gt;</span></span>
<span id="cb32-1920"><a href="#cb32-1920" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- sim_estimand_all &lt;- sim_ame( --&gt;</span></span>
<span id="cb32-1921"><a href="#cb32-1921" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   sim_model_all, --&gt;</span></span>
<span id="cb32-1922"><a href="#cb32-1922" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   var = X, --&gt;</span></span>
<span id="cb32-1923"><a href="#cb32-1923" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   cl = cores, --&gt;</span></span>
<span id="cb32-1924"><a href="#cb32-1924" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   by = "t0_eth_cat", --&gt;</span></span>
<span id="cb32-1925"><a href="#cb32-1925" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   verbose = FALSE --&gt;</span></span>
<span id="cb32-1926"><a href="#cb32-1926" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ) --&gt;</span></span>
<span id="cb32-1927"><a href="#cb32-1927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1928"><a href="#cb32-1928" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # summary(sim_estimand_all) --&gt;</span></span>
<span id="cb32-1929"><a href="#cb32-1929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1930"><a href="#cb32-1930" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # make table --&gt;</span></span>
<span id="cb32-1931"><a href="#cb32-1931" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- sim_estimand_all_tab &lt;- --&gt;</span></span>
<span id="cb32-1932"><a href="#cb32-1932" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   transform(sim_estimand_all, RD_euro = `E[Y(tile_3)|euro]` - `E[Y(tile_1)|euro]`, --&gt;</span></span>
<span id="cb32-1933"><a href="#cb32-1933" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--             RD_maori =  `E[Y(tile_3)|maori]` - `E[Y(tile_1)|maori]`, --&gt;</span></span>
<span id="cb32-1934"><a href="#cb32-1934" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--             gamma_hat = (`E[Y(tile_3)|euro]` - `E[Y(tile_1)|euro]`) - (`E[Y(tile_3)|maori]` - `E[Y(tile_1)|maori]`)) --&gt;</span></span>
<span id="cb32-1935"><a href="#cb32-1935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1936"><a href="#cb32-1936" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- sim_estimand_all_tab --&gt;</span></span>
<span id="cb32-1937"><a href="#cb32-1937" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # save table --&gt;</span></span>
<span id="cb32-1938"><a href="#cb32-1938" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- here_save(sim_estimand_all_tab, "sim_estimand_all_tab") --&gt;</span></span>
<span id="cb32-1939"><a href="#cb32-1939" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb32-1940"><a href="#cb32-1940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1941"><a href="#cb32-1941" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Summary of model --&gt;</span></span>
<span id="cb32-1942"><a href="#cb32-1942" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1943"><a href="#cb32-1943" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb32-1944"><a href="#cb32-1944" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # read table --&gt;</span></span>
<span id="cb32-1945"><a href="#cb32-1945" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- sim_estimand_all_tab &lt;- margot::here_read("sim_estimand_all_tab") --&gt;</span></span>
<span id="cb32-1946"><a href="#cb32-1946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1947"><a href="#cb32-1947" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # print table --&gt;</span></span>
<span id="cb32-1948"><a href="#cb32-1948" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- summary(sim_estimand_all_tab) --&gt;</span></span>
<span id="cb32-1949"><a href="#cb32-1949" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb32-1950"><a href="#cb32-1950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1951"><a href="#cb32-1951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1952"><a href="#cb32-1952" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Machine learning estimation: subgroups --&gt;</span></span>
<span id="cb32-1953"><a href="#cb32-1953" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1954"><a href="#cb32-1954" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb32-1955"><a href="#cb32-1955" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| label: lmtp_subgroup --&gt;</span></span>
<span id="cb32-1956"><a href="#cb32-1956" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| eval: false --&gt;</span></span>
<span id="cb32-1957"><a href="#cb32-1957" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| echo: true --&gt;</span></span>
<span id="cb32-1958"><a href="#cb32-1958" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1959"><a href="#cb32-1959" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # lmtp --&gt;</span></span>
<span id="cb32-1960"><a href="#cb32-1960" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- library("lmtp") --&gt;</span></span>
<span id="cb32-1961"><a href="#cb32-1961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1962"><a href="#cb32-1962" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # set number of folds for ML here. use a minimum of 5 and a max of 10 --&gt;</span></span>
<span id="cb32-1963"><a href="#cb32-1963" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- SL_folds = 5 --&gt;</span></span>
<span id="cb32-1964"><a href="#cb32-1964" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1965"><a href="#cb32-1965" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #this will allow you to track progress --&gt;</span></span>
<span id="cb32-1966"><a href="#cb32-1966" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- progressr::handlers(global = TRUE) --&gt;</span></span>
<span id="cb32-1967"><a href="#cb32-1967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1968"><a href="#cb32-1968" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # set seed for reproducing results --&gt;</span></span>
<span id="cb32-1969"><a href="#cb32-1969" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- set.seed(0112358) --&gt;</span></span>
<span id="cb32-1970"><a href="#cb32-1970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1971"><a href="#cb32-1971" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # set cores for estimation --&gt;</span></span>
<span id="cb32-1972"><a href="#cb32-1972" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- library(future) --&gt;</span></span>
<span id="cb32-1973"><a href="#cb32-1973" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- plan(multisession) --&gt;</span></span>
<span id="cb32-1974"><a href="#cb32-1974" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- n_cores &lt;- parallel::detectCores() - 2 # save two cores for other work while these models run --&gt;</span></span>
<span id="cb32-1975"><a href="#cb32-1975" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1976"><a href="#cb32-1976" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # check --&gt;</span></span>
<span id="cb32-1977"><a href="#cb32-1977" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- n_cores --&gt;</span></span>
<span id="cb32-1978"><a href="#cb32-1978" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1979"><a href="#cb32-1979" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # super learner libraries --&gt;</span></span>
<span id="cb32-1980"><a href="#cb32-1980" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # these are useful for high-dimensional data --&gt;</span></span>
<span id="cb32-1981"><a href="#cb32-1981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1982"><a href="#cb32-1982" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1983"><a href="#cb32-1983" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- df_clean_t2 &lt;- here_read('df_clean_t2') --&gt;</span></span>
<span id="cb32-1984"><a href="#cb32-1984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1985"><a href="#cb32-1985" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- df_maori &lt;-df_clean_t2 |&gt; dplyr::filter(t0_eth_cat == "maori") |&gt; droplevels() --&gt;</span></span>
<span id="cb32-1986"><a href="#cb32-1986" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- df_euro &lt;-df_clean_t2 |&gt; dplyr::filter(t0_eth_cat == "euro")  |&gt; droplevels() --&gt;</span></span>
<span id="cb32-1987"><a href="#cb32-1987" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- nrow(df_maori) --&gt;</span></span>
<span id="cb32-1988"><a href="#cb32-1988" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- nrow(df_euro) --&gt;</span></span>
<span id="cb32-1989"><a href="#cb32-1989" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- colnames(df_euro) --&gt;</span></span>
<span id="cb32-1990"><a href="#cb32-1990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1991"><a href="#cb32-1991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1992"><a href="#cb32-1992" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- colnames(df_clean_t2) --&gt;</span></span>
<span id="cb32-1993"><a href="#cb32-1993" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1994"><a href="#cb32-1994" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- A&lt;- "t1_perfectionism_4tile" --&gt;</span></span>
<span id="cb32-1995"><a href="#cb32-1995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1996"><a href="#cb32-1996" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # note lmtp's unconventional use of "censored" --&gt;</span></span>
<span id="cb32-1997"><a href="#cb32-1997" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- C &lt;- c("t1_censored") --&gt;</span></span>
<span id="cb32-1998"><a href="#cb32-1998" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1999"><a href="#cb32-1999" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- df_clean_t2$t0_combo_weights --&gt;</span></span>
<span id="cb32-2000"><a href="#cb32-2000" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2001"><a href="#cb32-2001" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- names_base &lt;- --&gt;</span></span>
<span id="cb32-2002"><a href="#cb32-2002" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   df_clean_t2 |&gt; select(starts_with("t0"), --&gt;</span></span>
<span id="cb32-2003"><a href="#cb32-2003" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                      -t0_combo_weights,  --&gt;</span></span>
<span id="cb32-2004"><a href="#cb32-2004" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                      -t0_censored, --&gt;</span></span>
<span id="cb32-2005"><a href="#cb32-2005" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                      -t0_eth_cat) |&gt; colnames() --&gt;</span></span>
<span id="cb32-2006"><a href="#cb32-2006" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- names_base --&gt;</span></span>
<span id="cb32-2007"><a href="#cb32-2007" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- C &lt;- c("t1_censored") --&gt;</span></span>
<span id="cb32-2008"><a href="#cb32-2008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2009"><a href="#cb32-2009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2010"><a href="#cb32-2010" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- shift_all_tile_3 &lt;- function(data, trt) { --&gt;</span></span>
<span id="cb32-2011"><a href="#cb32-2011" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   ifelse(data[[trt]] != "tile_3", "tile_3",  data[[trt]]) --&gt;</span></span>
<span id="cb32-2012"><a href="#cb32-2012" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- } --&gt;</span></span>
<span id="cb32-2013"><a href="#cb32-2013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2014"><a href="#cb32-2014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2015"><a href="#cb32-2015" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- shift_all_tile_1 &lt;- function(data, trt) { --&gt;</span></span>
<span id="cb32-2016"><a href="#cb32-2016" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   ifelse(data[[trt]] != "tile_1", "tile_1",  data[[trt]]) --&gt;</span></span>
<span id="cb32-2017"><a href="#cb32-2017" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- } --&gt;</span></span>
<span id="cb32-2018"><a href="#cb32-2018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2019"><a href="#cb32-2019" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- C --&gt;</span></span>
<span id="cb32-2020"><a href="#cb32-2020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2021"><a href="#cb32-2021" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # for faster estimation use fewer --&gt;</span></span>
<span id="cb32-2022"><a href="#cb32-2022" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- sl_lib &lt;- c(#"SL.glmnet", --&gt;</span></span>
<span id="cb32-2023"><a href="#cb32-2023" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--             "SL.ranger", # forests --&gt;</span></span>
<span id="cb32-2024"><a href="#cb32-2024" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--           #  "SL.rpart",#  --&gt;</span></span>
<span id="cb32-2025"><a href="#cb32-2025" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--             "SL.xgboost" --&gt;</span></span>
<span id="cb32-2026"><a href="#cb32-2026" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--             )  --&gt;</span></span>
<span id="cb32-2027"><a href="#cb32-2027" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2028"><a href="#cb32-2028" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ## no parametric estimation  --&gt;</span></span>
<span id="cb32-2029"><a href="#cb32-2029" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- maori_tile_3_t2_kessler_latent_anxiety_z &lt;- lmtp_tmle( --&gt;</span></span>
<span id="cb32-2030"><a href="#cb32-2030" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     data = df_maori, --&gt;</span></span>
<span id="cb32-2031"><a href="#cb32-2031" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     trt = A, --&gt;</span></span>
<span id="cb32-2032"><a href="#cb32-2032" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     baseline = names_base, --&gt;</span></span>
<span id="cb32-2033"><a href="#cb32-2033" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     outcome = "t2_kessler_latent_anxiety_z", --&gt;</span></span>
<span id="cb32-2034"><a href="#cb32-2034" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     cens = C, --&gt;</span></span>
<span id="cb32-2035"><a href="#cb32-2035" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     shift = shift_all_tile_3, --&gt;</span></span>
<span id="cb32-2036"><a href="#cb32-2036" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     mtp = TRUE, --&gt;</span></span>
<span id="cb32-2037"><a href="#cb32-2037" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     folds = 5, --&gt;</span></span>
<span id="cb32-2038"><a href="#cb32-2038" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     # trim = 0.99, # if needed --&gt;</span></span>
<span id="cb32-2039"><a href="#cb32-2039" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     # time_vary = NULL, --&gt;</span></span>
<span id="cb32-2040"><a href="#cb32-2040" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     outcome_type = "continuous", --&gt;</span></span>
<span id="cb32-2041"><a href="#cb32-2041" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     weights = df_maori$weights_stabilised, --&gt;</span></span>
<span id="cb32-2042"><a href="#cb32-2042" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     learners_trt = sl_lib, --&gt;</span></span>
<span id="cb32-2043"><a href="#cb32-2043" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     learners_outcome =sl_lib, --&gt;</span></span>
<span id="cb32-2044"><a href="#cb32-2044" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     parallel = n_cores --&gt;</span></span>
<span id="cb32-2045"><a href="#cb32-2045" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   ) --&gt;</span></span>
<span id="cb32-2046"><a href="#cb32-2046" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- maori_tile_3_t2_kessler_latent_anxiety_z --&gt;</span></span>
<span id="cb32-2047"><a href="#cb32-2047" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- here_save(maori_tile_3_t2_kessler_latent_anxiety_z, "maori_tile_3_t2_kessler_latent_anxiety_z") --&gt;</span></span>
<span id="cb32-2048"><a href="#cb32-2048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2049"><a href="#cb32-2049" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # learners for the exposure --&gt;</span></span>
<span id="cb32-2050"><a href="#cb32-2050" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- maori_tile_3_t2_kessler_latent_anxiety_z$fits_m --&gt;</span></span>
<span id="cb32-2051"><a href="#cb32-2051" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2052"><a href="#cb32-2052" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # learners for the  outcome --&gt;</span></span>
<span id="cb32-2053"><a href="#cb32-2053" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- maori_tile_3_t2_kessler_latent_anxiety_z$fits_r --&gt;</span></span>
<span id="cb32-2054"><a href="#cb32-2054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2055"><a href="#cb32-2055" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2056"><a href="#cb32-2056" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- maori_tile_1_t2_kessler_latent_anxiety_z &lt;- lmtp_tmle( --&gt;</span></span>
<span id="cb32-2057"><a href="#cb32-2057" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     data = df_maori, --&gt;</span></span>
<span id="cb32-2058"><a href="#cb32-2058" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     trt = A, --&gt;</span></span>
<span id="cb32-2059"><a href="#cb32-2059" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     baseline = names_base, --&gt;</span></span>
<span id="cb32-2060"><a href="#cb32-2060" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     outcome = "t2_kessler_latent_anxiety_z", --&gt;</span></span>
<span id="cb32-2061"><a href="#cb32-2061" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     cens = C, --&gt;</span></span>
<span id="cb32-2062"><a href="#cb32-2062" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     shift = shift_all_tile_1, --&gt;</span></span>
<span id="cb32-2063"><a href="#cb32-2063" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     mtp = TRUE, --&gt;</span></span>
<span id="cb32-2064"><a href="#cb32-2064" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     folds = 5, --&gt;</span></span>
<span id="cb32-2065"><a href="#cb32-2065" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     # trim = 0.99, # if needed --&gt;</span></span>
<span id="cb32-2066"><a href="#cb32-2066" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     # time_vary = NULL, --&gt;</span></span>
<span id="cb32-2067"><a href="#cb32-2067" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     outcome_type = "continuous", --&gt;</span></span>
<span id="cb32-2068"><a href="#cb32-2068" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     weights = df_maori$weights_stabilised, --&gt;</span></span>
<span id="cb32-2069"><a href="#cb32-2069" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     learners_trt = sl_lib, --&gt;</span></span>
<span id="cb32-2070"><a href="#cb32-2070" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     learners_outcome =sl_lib, --&gt;</span></span>
<span id="cb32-2071"><a href="#cb32-2071" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     parallel = n_cores --&gt;</span></span>
<span id="cb32-2072"><a href="#cb32-2072" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   ) --&gt;</span></span>
<span id="cb32-2073"><a href="#cb32-2073" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- maori_tile_1_t2_kessler_latent_anxiety_z --&gt;</span></span>
<span id="cb32-2074"><a href="#cb32-2074" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- here_save(maori_tile_1_t2_kessler_latent_anxiety_z, "maori_tile_1_t2_kessler_latent_anxiety_z") --&gt;</span></span>
<span id="cb32-2075"><a href="#cb32-2075" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2076"><a href="#cb32-2076" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # higher anxiety  --&gt;</span></span>
<span id="cb32-2077"><a href="#cb32-2077" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- maori_results &lt;-lmtp_contrast(maori_tile_3_t2_kessler_latent_anxiety_z, ref = maori_tile_1_t2_kessler_latent_anxiety_z) --&gt;</span></span>
<span id="cb32-2078"><a href="#cb32-2078" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # maori_results --&gt;</span></span>
<span id="cb32-2079"><a href="#cb32-2079" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- here_save(maori_results, "maori_results") --&gt;</span></span>
<span id="cb32-2080"><a href="#cb32-2080" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2081"><a href="#cb32-2081" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- euro_tile_3_t2_kessler_latent_anxiety_z &lt;- lmtp_tmle( --&gt;</span></span>
<span id="cb32-2082"><a href="#cb32-2082" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     data = df_euro, --&gt;</span></span>
<span id="cb32-2083"><a href="#cb32-2083" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     trt = A, --&gt;</span></span>
<span id="cb32-2084"><a href="#cb32-2084" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     baseline = names_base, --&gt;</span></span>
<span id="cb32-2085"><a href="#cb32-2085" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     outcome = "t2_kessler_latent_anxiety_z", --&gt;</span></span>
<span id="cb32-2086"><a href="#cb32-2086" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     cens = C, --&gt;</span></span>
<span id="cb32-2087"><a href="#cb32-2087" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     shift = shift_all_tile_3, --&gt;</span></span>
<span id="cb32-2088"><a href="#cb32-2088" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     mtp = TRUE, --&gt;</span></span>
<span id="cb32-2089"><a href="#cb32-2089" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     folds = 5, --&gt;</span></span>
<span id="cb32-2090"><a href="#cb32-2090" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     # trim = 0.99, # if needed --&gt;</span></span>
<span id="cb32-2091"><a href="#cb32-2091" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     # time_vary = NULL, --&gt;</span></span>
<span id="cb32-2092"><a href="#cb32-2092" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     outcome_type = "continuous", --&gt;</span></span>
<span id="cb32-2093"><a href="#cb32-2093" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     weights = df_euro$weights_stabilised, --&gt;</span></span>
<span id="cb32-2094"><a href="#cb32-2094" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     learners_trt = sl_lib, --&gt;</span></span>
<span id="cb32-2095"><a href="#cb32-2095" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     learners_outcome =sl_lib, --&gt;</span></span>
<span id="cb32-2096"><a href="#cb32-2096" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     parallel = n_cores --&gt;</span></span>
<span id="cb32-2097"><a href="#cb32-2097" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   ) --&gt;</span></span>
<span id="cb32-2098"><a href="#cb32-2098" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- euro_tile_3_t2_kessler_latent_anxiety_z --&gt;</span></span>
<span id="cb32-2099"><a href="#cb32-2099" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- here_save(euro_tile_3_t2_kessler_latent_anxiety_z, "euro_tile_3_t2_kessler_latent_anxiety_z") --&gt;</span></span>
<span id="cb32-2100"><a href="#cb32-2100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2101"><a href="#cb32-2101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2102"><a href="#cb32-2102" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- euro_tile_1_t2_kessler_latent_anxiety_z &lt;- lmtp_tmle( --&gt;</span></span>
<span id="cb32-2103"><a href="#cb32-2103" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     data = df_euro, --&gt;</span></span>
<span id="cb32-2104"><a href="#cb32-2104" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     trt = A, --&gt;</span></span>
<span id="cb32-2105"><a href="#cb32-2105" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     baseline = names_base, --&gt;</span></span>
<span id="cb32-2106"><a href="#cb32-2106" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     outcome = "t2_kessler_latent_anxiety_z", --&gt;</span></span>
<span id="cb32-2107"><a href="#cb32-2107" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     cens = C, --&gt;</span></span>
<span id="cb32-2108"><a href="#cb32-2108" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     shift = shift_all_tile_1, --&gt;</span></span>
<span id="cb32-2109"><a href="#cb32-2109" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     mtp = TRUE, --&gt;</span></span>
<span id="cb32-2110"><a href="#cb32-2110" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     folds = 5, --&gt;</span></span>
<span id="cb32-2111"><a href="#cb32-2111" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     # trim = 0.99, # if needed --&gt;</span></span>
<span id="cb32-2112"><a href="#cb32-2112" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     # time_vary = NULL, --&gt;</span></span>
<span id="cb32-2113"><a href="#cb32-2113" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     outcome_type = "continuous", --&gt;</span></span>
<span id="cb32-2114"><a href="#cb32-2114" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     weights = df_euro$weights_stabilised, --&gt;</span></span>
<span id="cb32-2115"><a href="#cb32-2115" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     learners_trt = sl_lib, --&gt;</span></span>
<span id="cb32-2116"><a href="#cb32-2116" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     learners_outcome =sl_lib, --&gt;</span></span>
<span id="cb32-2117"><a href="#cb32-2117" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     parallel = n_cores --&gt;</span></span>
<span id="cb32-2118"><a href="#cb32-2118" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   ) --&gt;</span></span>
<span id="cb32-2119"><a href="#cb32-2119" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- euro_tile_1_t2_kessler_latent_anxiety_z --&gt;</span></span>
<span id="cb32-2120"><a href="#cb32-2120" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- here_save(euro_tile_1_t2_kessler_latent_anxiety_z, "euro_tile_1_t2_kessler_latent_anxiety_z") --&gt;</span></span>
<span id="cb32-2121"><a href="#cb32-2121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2122"><a href="#cb32-2122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2123"><a href="#cb32-2123" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- euro_results &lt;- lmtp_contrast(euro_tile_3_t2_kessler_latent_anxiety_z, ref = euro_tile_1_t2_kessler_latent_anxiety_z) --&gt;</span></span>
<span id="cb32-2124"><a href="#cb32-2124" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- here_save(euro_results, "euro_results") --&gt;</span></span>
<span id="cb32-2125"><a href="#cb32-2125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2126"><a href="#cb32-2126" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb32-2127"><a href="#cb32-2127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2128"><a href="#cb32-2128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2129"><a href="#cb32-2129" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Machine learning: results --&gt;</span></span>
<span id="cb32-2130"><a href="#cb32-2130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2131"><a href="#cb32-2131" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- No difference between groups.  --&gt;</span></span>
<span id="cb32-2132"><a href="#cb32-2132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2133"><a href="#cb32-2133" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb32-2134"><a href="#cb32-2134" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- euro_results &lt;- margot::here_read("euro_results") --&gt;</span></span>
<span id="cb32-2135"><a href="#cb32-2135" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- maori_results&lt;- margot::here_read("maori_results") --&gt;</span></span>
<span id="cb32-2136"><a href="#cb32-2136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2137"><a href="#cb32-2137" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- euro_results --&gt;</span></span>
<span id="cb32-2138"><a href="#cb32-2138" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- maori_results --&gt;</span></span>
<span id="cb32-2139"><a href="#cb32-2139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2140"><a href="#cb32-2140" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- g_hat_theta= euro_results$vals$theta - maori_results$vals$theta  --&gt;</span></span>
<span id="cb32-2141"><a href="#cb32-2141" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- g_hat_theta # difference of means --&gt;</span></span>
<span id="cb32-2142"><a href="#cb32-2142" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- euro_results$vals$std.error --&gt;</span></span>
<span id="cb32-2143"><a href="#cb32-2143" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # difference  --&gt;</span></span>
<span id="cb32-2144"><a href="#cb32-2144" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- se_diff = sqrt( (euro_results$vals$std.error^2) + (maori_results$vals$std.error^2) ) --&gt;</span></span>
<span id="cb32-2145"><a href="#cb32-2145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2146"><a href="#cb32-2146" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- diff_conf.low = g_hat_theta - (1.97 * se_diff) --&gt;</span></span>
<span id="cb32-2147"><a href="#cb32-2147" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- diff_conf.high = g_hat_theta + (1.97 * se_diff) --&gt;</span></span>
<span id="cb32-2148"><a href="#cb32-2148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2149"><a href="#cb32-2149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2150"><a href="#cb32-2150" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- g_hat_anxiety &lt;- cbind.data.frame(g_hat_theta, se_diff, diff_conf.low, diff_conf.high) --&gt;</span></span>
<span id="cb32-2151"><a href="#cb32-2151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2152"><a href="#cb32-2152" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # result --&gt;</span></span>
<span id="cb32-2153"><a href="#cb32-2153" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- g_hat_anxiety --&gt;</span></span>
<span id="cb32-2154"><a href="#cb32-2154" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb32-2155"><a href="#cb32-2155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2156"><a href="#cb32-2156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2157"><a href="#cb32-2157" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Note, however that the invevention increases anxiety for both groups equally --&gt;</span></span>
<span id="cb32-2158"><a href="#cb32-2158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2159"><a href="#cb32-2159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2160"><a href="#cb32-2160" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Europeans results --&gt;</span></span>
<span id="cb32-2161"><a href="#cb32-2161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2162"><a href="#cb32-2162" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb32-2163"><a href="#cb32-2163" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- euro_results &lt;- margot::here_read("euro_results") --&gt;</span></span>
<span id="cb32-2164"><a href="#cb32-2164" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- round( euro_results$vals, 3) --&gt;</span></span>
<span id="cb32-2165"><a href="#cb32-2165" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb32-2166"><a href="#cb32-2166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2167"><a href="#cb32-2167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2168"><a href="#cb32-2168" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Maori results --&gt;</span></span>
<span id="cb32-2169"><a href="#cb32-2169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2170"><a href="#cb32-2170" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb32-2171"><a href="#cb32-2171" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- maori_results&lt;- margot::here_read("maori_results") --&gt;</span></span>
<span id="cb32-2172"><a href="#cb32-2172" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- round(maori_results$vals, 3) --&gt;</span></span>
<span id="cb32-2173"><a href="#cb32-2173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2174"><a href="#cb32-2174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2175"><a href="#cb32-2175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2176"><a href="#cb32-2176" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb32-2177"><a href="#cb32-2177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2178"><a href="#cb32-2178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2179"><a href="#cb32-2179" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Graph results --&gt;</span></span>
<span id="cb32-2180"><a href="#cb32-2180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2181"><a href="#cb32-2181" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb32-2182"><a href="#cb32-2182" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- tab_euro_results &lt;- margot::margot_lmtp_evalue( --&gt;</span></span>
<span id="cb32-2183"><a href="#cb32-2183" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   euro_results, --&gt;</span></span>
<span id="cb32-2184"><a href="#cb32-2184" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   scale = "RD", --&gt;</span></span>
<span id="cb32-2185"><a href="#cb32-2185" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   new_name = "Euro: 1_tile to 3_tile" --&gt;</span></span>
<span id="cb32-2186"><a href="#cb32-2186" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ) --&gt;</span></span>
<span id="cb32-2187"><a href="#cb32-2187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2188"><a href="#cb32-2188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2189"><a href="#cb32-2189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2190"><a href="#cb32-2190" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- tab_maori_results &lt;- margot::margot_lmtp_evalue( --&gt;</span></span>
<span id="cb32-2191"><a href="#cb32-2191" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   maori_results, --&gt;</span></span>
<span id="cb32-2192"><a href="#cb32-2192" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   scale = "RD", --&gt;</span></span>
<span id="cb32-2193"><a href="#cb32-2193" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   new_name = "Māori: 1_tile to 3_tile" --&gt;</span></span>
<span id="cb32-2194"><a href="#cb32-2194" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ) --&gt;</span></span>
<span id="cb32-2195"><a href="#cb32-2195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2196"><a href="#cb32-2196" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- bind_results_anxiety &lt;- rbind(tab_euro_results, tab_maori_results) --&gt;</span></span>
<span id="cb32-2197"><a href="#cb32-2197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2198"><a href="#cb32-2198" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- here_save(bind_results_anxiety, "bind_results_anxiety") --&gt;</span></span>
<span id="cb32-2199"><a href="#cb32-2199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2200"><a href="#cb32-2200" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb32-2201"><a href="#cb32-2201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2202"><a href="#cb32-2202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2203"><a href="#cb32-2203" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb32-2204"><a href="#cb32-2204" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| fig-width: 10 --&gt;</span></span>
<span id="cb32-2205"><a href="#cb32-2205" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| fig-height: 12 --&gt;</span></span>
<span id="cb32-2206"><a href="#cb32-2206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2207"><a href="#cb32-2207" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- bind_results_anxiety &lt;- here_read("bind_results_anxiety") --&gt;</span></span>
<span id="cb32-2208"><a href="#cb32-2208" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- group_tab_anxiety &lt;- margot::group_tab(bind_results_anxiety, type = "RD") --&gt;</span></span>
<span id="cb32-2209"><a href="#cb32-2209" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- conflicted::conflicts_prefer(ggplot2::margin) --&gt;</span></span>
<span id="cb32-2210"><a href="#cb32-2210" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # graph results --&gt;</span></span>
<span id="cb32-2211"><a href="#cb32-2211" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--  margot_plot( --&gt;</span></span>
<span id="cb32-2212"><a href="#cb32-2212" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   group_tab_anxiety, --&gt;</span></span>
<span id="cb32-2213"><a href="#cb32-2213" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   type = "RD", --&gt;</span></span>
<span id="cb32-2214"><a href="#cb32-2214" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   title = "Perfectionism: shift all to 3_tile, contrast with 1_tile", --&gt;</span></span>
<span id="cb32-2215"><a href="#cb32-2215" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   subtitle = "Outcome = Anxiety", --&gt;</span></span>
<span id="cb32-2216"><a href="#cb32-2216" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   estimate_scale = 1, --&gt;</span></span>
<span id="cb32-2217"><a href="#cb32-2217" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   base_size = 18, --&gt;</span></span>
<span id="cb32-2218"><a href="#cb32-2218" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   text_size = 4.5, --&gt;</span></span>
<span id="cb32-2219"><a href="#cb32-2219" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   point_size = 3.5, --&gt;</span></span>
<span id="cb32-2220"><a href="#cb32-2220" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   title_size = 20, --&gt;</span></span>
<span id="cb32-2221"><a href="#cb32-2221" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   subtitle_size = 16, --&gt;</span></span>
<span id="cb32-2222"><a href="#cb32-2222" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   legend_text_size = 10, --&gt;</span></span>
<span id="cb32-2223"><a href="#cb32-2223" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   legend_title_size = 10, --&gt;</span></span>
<span id="cb32-2224"><a href="#cb32-2224" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   x_offset = -.5, --&gt;</span></span>
<span id="cb32-2225"><a href="#cb32-2225" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   x_lim_lo = -.5, --&gt;</span></span>
<span id="cb32-2226"><a href="#cb32-2226" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   x_lim_hi =  .5 --&gt;</span></span>
<span id="cb32-2227"><a href="#cb32-2227" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ) --&gt;</span></span>
<span id="cb32-2228"><a href="#cb32-2228" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb32-2229"><a href="#cb32-2229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2230"><a href="#cb32-2230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2231"><a href="#cb32-2231" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Interpret Results --&gt;</span></span>
<span id="cb32-2232"><a href="#cb32-2232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2233"><a href="#cb32-2233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2234"><a href="#cb32-2234" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb32-2235"><a href="#cb32-2235" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- margot_interpret_table(group_tab_anxiety, estimand = "ATT", causal_scale = "causal_difference") --&gt;</span></span>
<span id="cb32-2236"><a href="#cb32-2236" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb32-2237"><a href="#cb32-2237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2238"><a href="#cb32-2238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2239"><a href="#cb32-2239" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ## Take Home Message --&gt;</span></span>
<span id="cb32-2240"><a href="#cb32-2240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2241"><a href="#cb32-2241" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Machine learning with cross validation recovers nearly identical estimates for the effect of a shift in perfectionism on anxiety among Māori and Europeans.  --&gt;</span></span>
<span id="cb32-2242"><a href="#cb32-2242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2243"><a href="#cb32-2243" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Which results are correct?  We don't know. With more time, we would add more learners to the model, including parametric learners.  --&gt;</span></span>
<span id="cb32-2244"><a href="#cb32-2244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2245"><a href="#cb32-2245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2246"><a href="#cb32-2246" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Generally, I suggest using machine learning algorithms, because they can include parametric estimators.  --&gt;</span></span>
<span id="cb32-2247"><a href="#cb32-2247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2248"><a href="#cb32-2248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2249"><a href="#cb32-2249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2250"><a href="#cb32-2250" aria-hidden="true" tabindex="-1"></a><span class="fu">### Packages</span></span>
<span id="cb32-2251"><a href="#cb32-2251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2254"><a href="#cb32-2254" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-2255"><a href="#cb32-2255" aria-hidden="true" tabindex="-1"></a>report<span class="sc">::</span><span class="fu">cite_packages</span>()</span>
<span id="cb32-2256"><a href="#cb32-2256" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-2257"><a href="#cb32-2257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2258"><a href="#cb32-2258" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>