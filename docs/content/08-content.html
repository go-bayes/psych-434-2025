<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.20">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Joseph Bulbulia">
<meta name="dcterms.date" content="2025-04-29">

<title>Estimation of ATE and CATE Using Machine Learning – PSYC 434 Conducting Research Across Cultures: Trimester 1, 2025</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-94df807a54b4aea56b59f6b1a3567e79.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-d5a3029baa3e394e88f18ffb9b51a21b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css">

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">PSYC 434 Conducting Research Across Cultures: Trimester 1, 2025</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../content/course-outline.html"> 
<span class="menu-text">Course Outline</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-content" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Content</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-content">    
        <li>
    <a class="dropdown-item" href="../content/glossary.pdf">
 <span class="dropdown-text">Glossary</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/course-outline.html">
 <span class="dropdown-text">Course Outline</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/01-content.html">
 <span class="dropdown-text">Week 1: Course Introduction - R (installing packages)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/02-content.html">
 <span class="dropdown-text">Week 2: Causal Diagrams - Elementary Structures and Rules - R (using the interface)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/03-content.html">
 <span class="dropdown-text">Week 3: Causal Diagrams - Confounding Bias - R (regression/simulation)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/04-content.html">
 <span class="dropdown-text">Week 4: Causal Diagrams - Interaction, Measurement Bias, Selection Bias - R (regression/simulation)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/05-content.html">
 <span class="dropdown-text">Week 5: Causal Inference - Average Treatment Effects - R (regression/simulation: ATE)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/06-content.html">
 <span class="dropdown-text">Week 6: Conditional Average Treatment Effects (CATE) - R (regression/simulation: ATE)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/07-quiz.html">
 <span class="dropdown-text">Week 7: In Class Test</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/08-content.html">
 <span class="dropdown-text">Week 8: Estimation of ATE and CATE using machine learning - R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/09-content.html">
 <span class="dropdown-text">Week 9: Theoretically postulated Subgroups analysis- R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/10-content.html">
 <span class="dropdown-text">Week 10: Hands On: Writing Up Your Analysis: Quarto Documents</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/11-content.html">
 <span class="dropdown-text">Week 11: Measurement: Factor Analysis, CFA, MultiGroup CFA, Partial Invariance/ And How These Approaches Fail</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/12-content.html">
 <span class="dropdown-text">Week 12: Student Presentations</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Estimation of ATE and CATE Using Machine Learning</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
                      </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-heading">Affiliation</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author">Joseph Bulbulia <a href="mailto:joseph.bulbulia@vuw.ac.nz" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0000-0002-5861-2056" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              Victoria University of Wellington, New Zealand
            </p>
        </div>
    </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">April 29, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#heterogeneous-treatment-effect-analysis-with-causal-forests" id="toc-heterogeneous-treatment-effect-analysis-with-causal-forests" class="nav-link active" data-scroll-target="#heterogeneous-treatment-effect-analysis-with-causal-forests">Heterogeneous-Treatment-Effect Analysis with <strong>causal forests</strong></a>
  <ul class="collapse">
  <li><a href="#why-worry-about-heterogeneity" id="toc-why-worry-about-heterogeneity" class="nav-link" data-scroll-target="#why-worry-about-heterogeneity">Why worry about heterogeneity?</a></li>
  <li><a href="#start-with-estimating-the-average-treatment-effect-ate" id="toc-start-with-estimating-the-average-treatment-effect-ate" class="nav-link" data-scroll-target="#start-with-estimating-the-average-treatment-effect-ate">1 Start with estimating the average treatment effect (ATE)</a></li>
  <li><a href="#do-effects-differ-across-people" id="toc-do-effects-differ-across-people" class="nav-link" data-scroll-target="#do-effects-differ-across-people">2 Do effects differ across people?</a></li>
  <li><a href="#from-straight-lines-to-trees" id="toc-from-straight-lines-to-trees" class="nav-link" data-scroll-target="#from-straight-lines-to-trees">3. From straight lines to trees</a></li>
  <li><a href="#building-honest-trees-avoiding-over-fitting" id="toc-building-honest-trees-avoiding-over-fitting" class="nav-link" data-scroll-target="#building-honest-trees-avoiding-over-fitting">4 Building Honest Trees: Avoiding Over-Fitting</a></li>
  <li><a href="#handling-missing-data" id="toc-handling-missing-data" class="nav-link" data-scroll-target="#handling-missing-data">5 Handling missing data</a></li>
  <li><a href="#is-the-heterogeneity-actionable-rate-statistics" id="toc-is-the-heterogeneity-actionable-rate-statistics" class="nav-link" data-scroll-target="#is-the-heterogeneity-actionable-rate-statistics">6 Is the heterogeneity <em>actionable</em>? — RATE statistics</a></li>
  <li><a href="#rate-autoc-example" id="toc-rate-autoc-example" class="nav-link" data-scroll-target="#rate-autoc-example">7 RATE AUTOC EXAMPLE</a></li>
  <li><a href="#visualising-policy-value-the-qini-curve" id="toc-visualising-policy-value-the-qini-curve" class="nav-link" data-scroll-target="#visualising-policy-value-the-qini-curve">8 Visualising policy value: the Qini curve</a></li>
  <li><a href="#from-a-black-box-to-simple-rules-policy-trees" id="toc-from-a-black-box-to-simple-rules-policy-trees" class="nav-link" data-scroll-target="#from-a-black-box-to-simple-rules-policy-trees">9 From ‘a black box’ to simple rules: policy trees</a></li>
  <li><a href="#ethical-and-practical-considerations" id="toc-ethical-and-practical-considerations" class="nav-link" data-scroll-target="#ethical-and-practical-considerations">10 Ethical and practical considerations</a></li>
  <li><a href="#summarynext-steps" id="toc-summarynext-steps" class="nav-link" data-scroll-target="#summarynext-steps">Summary/next steps</a></li>
  </ul></li>
  <li><a href="#lab-data-preparation-and-analysis-scripts" id="toc-lab-data-preparation-and-analysis-scripts" class="nav-link" data-scroll-target="#lab-data-preparation-and-analysis-scripts">Lab: Data Preparation and Analysis Scripts</a>
  <ul class="collapse">
  <li><a href="#link-to-data-dictionary" id="toc-link-to-data-dictionary" class="nav-link" data-scroll-target="#link-to-data-dictionary">Link to data dictionary</a></li>
  <li><a href="#script-1" id="toc-script-1" class="nav-link" data-scroll-target="#script-1">Script 1:</a></li>
  <li><a href="#script-2" id="toc-script-2" class="nav-link" data-scroll-target="#script-2">Script 2</a></li>
  <li><a href="#script-3" id="toc-script-3" class="nav-link" data-scroll-target="#script-3">Script 3</a></li>
  </ul></li>
  <li><a href="#homework-prepare-a-fresh-set-of-analysis-scripts-using-a-different-exposure" id="toc-homework-prepare-a-fresh-set-of-analysis-scripts-using-a-different-exposure" class="nav-link" data-scroll-target="#homework-prepare-a-fresh-set-of-analysis-scripts-using-a-different-exposure">HOMEWORK: Prepare a fresh set of analysis scripts using a different exposure</a>
  <ul class="collapse">
  <li><a href="#packages" id="toc-packages" class="nav-link" data-scroll-target="#packages">Packages</a></li>
  </ul></li>
  <li><a href="#appendix" id="toc-appendix" class="nav-link" data-scroll-target="#appendix">Appendix</a></li>
  <li><a href="#review-the-fundamental-problem-of-causal-inference-as-a-missing-data-problem" id="toc-review-the-fundamental-problem-of-causal-inference-as-a-missing-data-problem" class="nav-link" data-scroll-target="#review-the-fundamental-problem-of-causal-inference-as-a-missing-data-problem">Review: The Fundamental Problem of Causal Inference as a Missing Data Problem</a></li>
  <li><a href="#subgroup-analysis" id="toc-subgroup-analysis" class="nav-link" data-scroll-target="#subgroup-analysis">Subgroup analysis</a>
  <ul class="collapse">
  <li><a href="#causal-estimand-statistical-estimand-statistical-estimator" id="toc-causal-estimand-statistical-estimand-statistical-estimator" class="nav-link" data-scroll-target="#causal-estimand-statistical-estimand-statistical-estimator">Causal Estimand, Statistical Estimand, Statistical Estimator</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Required</strong> - <a href="https://grf-labs.github.io/grf/">https://grf-labs.github.io/grf/</a></p>
<p><strong>Optional</strong> - <span class="citation" data-cites="vanderweele2020">(<a href="#ref-vanderweele2020" role="doc-biblioref">VanderWeele, Mathur, and Chen 2020</a>)</span> <a href="https://www.dropbox.com/scl/fi/srpynr0dvjcndveplcydn/OutcomeWide_StatisticalScience.pdf?rlkey=h4fv32oyjegdfl3jq9u1fifc3&amp;dl=0">link</a> - <span class="citation" data-cites="suzuki2020">(<a href="#ref-suzuki2020" role="doc-biblioref">Suzuki, Shinozaki, and Yamamoto 2020</a>)</span> <a href="https://www.dropbox.com/scl/fi/4midxwr9ltg9oce02e0ss/suzuki-causal-diagrams.pdf?rlkey=uktzf3nurtgpbj8m4h0xz82dn&amp;dl=0">link</a> - <span class="citation" data-cites="Bulbulia2024PracticalGuide">(<a href="#ref-Bulbulia2024PracticalGuide" role="doc-biblioref">Bulbulia 2024</a>)</span> <a href="https://osf.io/preprints/psyarxiv/uyg3d">link</a> - <span class="citation" data-cites="hoffman2023">(<a href="#ref-hoffman2023" role="doc-biblioref">Hoffman et al. 2023</a>)</span> <a href="https://arxiv.org/pdf/2304.09460.pdf">link</a></p>
</div>
</div>
<div class="no-row-height column-margin column-container"><div id="ref-hoffman2023" class="csl-entry" role="listitem">
Hoffman, Katherine L., Diego Salazar-Barreto, Kara E. Rudolph, and Iván Díaz. 2023. <span>“Introducing Longitudinal Modified Treatment Policies: A Unified Framework for Studying Complex Exposures,”</span> April. <a href="https://doi.org/10.48550/arXiv.2304.09460">https://doi.org/10.48550/arXiv.2304.09460</a>.
</div></div><div class="no-row-height column-margin column-container"><div id="ref-Bulbulia2024PracticalGuide" class="csl-entry" role="listitem">
Bulbulia, J. A. 2024. <span>“A Practical Guide to Causal Inference in Three-Wave Panel Studies.”</span> OSF. <a href="https://doi.org/10.31234/osf.io/uyg3d">https://doi.org/10.31234/osf.io/uyg3d</a>.
</div></div><div class="no-row-height column-margin column-container"><div id="ref-suzuki2020" class="csl-entry" role="listitem">
Suzuki, Etsuji, Tomohiro Shinozaki, and Eiji Yamamoto. 2020. <span>“Causal Diagrams: Pitfalls and Tips.”</span> <em>Journal of Epidemiology</em> 30 (4): 153–62. <a href="https://doi.org/10.2188/jea.JE20190192">https://doi.org/10.2188/jea.JE20190192</a>.
</div></div><div class="no-row-height column-margin column-container"><div id="ref-vanderweele2020" class="csl-entry" role="listitem">
VanderWeele, Tyler J, Maya B Mathur, and Ying Chen. 2020. <span>“Outcome-Wide Longitudinal Designs for Causal Inference: A New Template for Empirical Studies.”</span> <em>Statistical Science</em> 35 (3): 437–66.
</div></div><div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Key concepts
</div>
</div>
<div class="callout-body-container callout-body">
<p>The workflow below introduces <strong>heterogeneous-treatment-effect (HTE) analysis</strong> with <em>causal forests</em>. By the end of the lecture you should understand six technical ideas: (1) ATE (lectures 1-5) (2) CATE (lecture 6) (3) The estimator <span class="math inline">\widehat{\tau}(x)</span>, (lecture 6) (4) the RATE statistics drawn from a <strong>Targeting-Operator Characteristic</strong> (TOC) curve (new) (5) Qini Curves (new) (6) <strong>policy trees</strong>—and know how each fits into an applied research pipelin (new)</p>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
For the lab
</div>
</div>
<div class="callout-body-container callout-body">
<p>The lab puts the six ideas above to practical use.</p>
<p>There are <strong>Three</strong> R scripts we will be using over the next few weeks.&nbsp;</p>
<p>First:</p>
<p><a href="https://raw.githubusercontent.com/go-bayes/psych-434-2025/refs/heads/main/laboratory/01-example-script-data-wrangling.R">Script 1</a></p>
<p><a href="https://raw.githubusercontent.com/go-bayes/psych-434-2025/refs/heads/main/laboratory/02-example-script-data-wrangling-2.R">Script 2</a></p>
<p><a href="https://raw.githubusercontent.com/go-bayes/psych-434-2025/refs/heads/main/laboratory/03-example-script-estimation-results.R">Script 3</a></p>
</div>
</div>
<section id="heterogeneous-treatment-effect-analysis-with-causal-forests" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="heterogeneous-treatment-effect-analysis-with-causal-forests">Heterogeneous-Treatment-Effect Analysis with <strong>causal forests</strong></h2>
<section id="why-worry-about-heterogeneity" class="level3">
<h3 class="anchored" data-anchor-id="why-worry-about-heterogeneity">Why worry about heterogeneity?</h3>
<p>Relying on the average treatment effect (ATE) is a bit like handing out size-nine shoes to an entire student body: on <em>average</em> they might fit, but watch the tall students hobble and the small ones trip.</p>
<p>Today we will focus on the causal question: “What would be the effects on multi-dimensional well-being if everyone spent at least one hour a week socialising with their community?”</p>
<p>Note that a one-hour boost in weekly community socialising could send some students’ sense of belonging soaring while leaving others desolated. Spotting that spread, measuring how big it really is, and deciding whether it is worth tailoring an exposure to individual ‘shoe sizes’ are the three practical goals of Heterogeneous Treatment Effects analysis.</p>
<hr>
</section>
<section id="start-with-estimating-the-average-treatment-effect-ate" class="level3">
<h3 class="anchored" data-anchor-id="start-with-estimating-the-average-treatment-effect-ate">1 Start with estimating the average treatment effect (ATE)</h3>
<p>Assume the <a href="https://go-bayes.github.io/psych-434-2025/content/05-content.html#how-can-we-make-contrasts-between-counterfactual-potential-outcomes">Three Fundamental Assumptions of Causal Inference here</a> are met. Suppose we wish to estimate the average treatment effect for socialising with one’s community.</p>
<p>We begin with the most straightforward (and secretly impossible) counterfactual: *run two parallel universes—one where <strong>everyone</strong> gets the treatment, another where <strong>no-one</strong> does—and compare the final scores. The resulting difference is the <strong>average treatment effect</strong>:</p>
<p><span class="math display">
\text{ATE}=E\!\bigl[Y(1)-Y(0)\bigr].
</span></p>
<p>This gives us the average response – the shoe size… You’ve seen this before.</p>
<hr>
</section>
<section id="do-effects-differ-across-people" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="do-effects-differ-across-people">2 Do effects differ across people?</h3>
<p>Variation is captured by the <strong>conditional average treatment effect (CATE)</strong>,</p>
<p><span class="math display">
\tau(x)=E\!\bigl[Y(1)-Y(0)\mid X=x\bigr],
</span></p>
<p>where <span class="math inline">X</span> gathers pre-treatment covariates – age, baseline wellbeing, personality, whatever we have measured and included in our model. Normally these will be our <em>baseline confounders.</em></p>
<p>If <span class="math inline">\tau(x)</span> turns out to be flat, we say there is no evidence for heterogeneity worth targeting.</p>
<p>People differ in countless, overlapping ways. Think of age, baseline wellbeing, personality traits, study habits, and more.</p>
<p>A linear interaction model tests whether the treatment works differently along one straight dimension, such as gender, by fitting a straight line.</p>
<p>But real‐world data often twist and turn. If the true relationship bends like a garden hose, a straight line will miss the curve.</p>
<p>Regression forests fix this by letting the data place splits wherever the shape changes, so they can follow any bends that appear <span class="citation" data-cites="wager2018">(<a href="#ref-wager2018" role="doc-biblioref">Wager and Athey 2018</a>)</span>.</p>
<div class="no-row-height column-margin column-container"></div><p>Straight-line models are fine for simple patterns, but regression forests can trace the curves that simple lines overlook.</p>
<p>Causal forests are based on regression forests, where the splitting attempts to maximise differences in causal effect estimates. What this means will soon be clear.</p>
</section>
<section id="from-straight-lines-to-trees" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="from-straight-lines-to-trees">3. From straight lines to trees</h3>
<p>Traditional ‘parametric’ models (like simple regression) guess a single functional shape – often a straight line – before seeing the data. A <strong>non-parametric</strong> model, by contrast, lets the data decide the shape. A <em>regression tree</em> is the simplest non-parametric learner we will use.</p>
<ol type="1">
<li><strong>Regression tree</strong></li>
</ol>
<p><em>Idea</em>: split the covariate space by asking yes/no questions— ‘Age ≤ 20?’, ‘Baseline wellbeing &gt; 0.3?’ — until each terminal <strong>leaf</strong> is fairly homogeneous. Inside a leaf the predicted outcome is just the sample mean, so the tree builds a <em>piece-wise constant</em> surface instead of a global line.<br>
<em>Analogy</em>: think of tiling a garden with stepping-stones: each stone is flat, but taken together they follow the ground’s contours.</p>
<ol start="2" type="1">
<li><p><strong>Regression forest</strong><br>
A single tree is quick and interpretable but unstable: small changes in the data can move the splits and shift predictions. A <strong>random forest</strong> grows many trees on bootstrap samples and averages their outputs. Averaging cancels much of the noise <span class="citation" data-cites="breiman2001random">(<a href="#ref-breiman2001random" role="doc-biblioref">Breiman 2001</a>)</span>.</p></li>
<li><p><strong>Causal Forests</strong><br>
To estimate treatment effects rather than outcomes, each tree plays a two-step ‘honest’ game <span class="citation" data-cites="wager2018">(<a href="#ref-wager2018" role="doc-biblioref">Wager and Athey 2018</a>)</span>:</p>
<ul>
<li>use one half of its sample to choose splits that separate treated from control units;<br>
</li>
<li>use the other half to compute treatment-control differences within every leaf.</li>
</ul>
<p>For a new individual with covariates <span class="math inline">x_i</span> each tree supplies a noisy leaf-level effect; the forest reports the <strong>average</strong>, written</p></li>
</ol>
<div class="no-row-height column-margin column-container"><div id="ref-breiman2001random" class="csl-entry" role="listitem">
Breiman, Leo. 2001. <span>“Random Forests.”</span> <em>Machine Learning</em> 45 (1): 5–32. <a href="https://doi.org/10.1023/A:1010933404324">https://doi.org/10.1023/A:1010933404324</a>.
</div><div id="ref-wager2018" class="csl-entry" role="listitem">
Wager, Stefan, and Susan Athey. 2018. <span>“Estimation and Inference of Heterogeneous Treatment Effects Using Random Forests.”</span> <em>Journal of the American Statistical Association</em> 113 (523): 1228–42. <a href="https://doi.org/10.1080/01621459.2017.1319839">https://doi.org/10.1080/01621459.2017.1319839</a>.
</div></div><p><span class="math display">
  \widehat{\tau}(x)=E[Y(1)-Y(0)\mid X=x].
</span></p>
<p>Because the noisy estimates point in many directions, their average is markedly less variable – <em>the wisdom of trees is a wisdom of crowds</em>.</p>
<p>Straight‑line models suit simple patterns; regression forests flex to any bends; causal forests add a third dimension – variation in treatment responses. We’ll see this in action/</p>
<p>For more about causal forests see (~18mins in…)</p>
<div class="quarto-video ratio ratio-16x9"><iframe data-external="1" src="https://www.youtube.com/embed/YBbnCDRCcAI" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>
<!-- So, a regression tree chops the data into locally flat chunks; a regression forest averages many such trees to smooth away chance idiosyncrasies; a causal forest adds honesty so that its averaged differences, though never directly observable for any one person, give our best data-driven forecast of individual treatment effects. -->
<hr>
</section>
<section id="building-honest-trees-avoiding-over-fitting" class="level3">
<h3 class="anchored" data-anchor-id="building-honest-trees-avoiding-over-fitting">4 Building Honest Trees: Avoiding Over-Fitting</h3>
<p>Sample splitting meanings partitioning your data into training and testing sets. This avoids overfittign the model to observations (remember we seek to estimate parameters for an entire population under two different exposures, at most, only one of which is observed on any individual.) Sample splitting is a feature of estimation in cauasal forests – we separate model selection from estimation. Moreover, the forest adds a second safeguard: <strong>out-of-bag (OOB) prediction</strong>. Each <span class="math inline">\widehat{\tau}(x_i)</span> is averaged only over trees that never used <span class="math inline">i</span> in their split phase. Together, honesty and OOB prediction deliver reliable uncertainty estimates even in high-dimensional settings (i.e.&nbsp;settings with <em>many</em> covariates.)</p>
<hr>
</section>
<section id="handling-missing-data" class="level3">
<h3 class="anchored" data-anchor-id="handling-missing-data">5 Handling missing data</h3>
<p>The <code>grf</code> package adopts <strong>Missing Incorporated in Attributes (MIA)</strong> splitting. ‘Missing’ can itself become a branch, so cases are neither discarded nor randomly imputed. This pragmatic approach keeps all observations in play while preserving the forest’s interpretability.</p>
<hr>
</section>
<section id="is-the-heterogeneity-actionable-rate-statistics" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="is-the-heterogeneity-actionable-rate-statistics">6 Is the heterogeneity <em>actionable</em>? — RATE statistics</h3>
<p>Once we have a personalised score <span class="math inline">\widehat{\tau}(x)</span> for every unit, the practical question is whether <em>targeting</em> high scorers delivers a benefit large enough to justify the extra effort. The tool of choice is the <strong>Targeting-Operator Characteristic (TOC)</strong> curve:</p>
<p><span class="math display">
G(q)=\frac{1}{n}\sum_{i=1}^{\lfloor qn\rfloor}\widehat{\tau}_{(i)}, \qquad 0\le q\le1,
</span></p>
<p>where <span class="math inline">\widehat{\tau}_{(1)}\ge\widehat{\tau}_{(2)}\ge\cdots</span> are the estimated effects sorted from largest to smallest. The horizontal axis <span class="math inline">q</span> is the fraction of the population we would treat; the vertical axis <span class="math inline">G(q)</span> is the cumulative gain we expect from treating that top slice.</p>
<p>Two integrals of the TOC curve summarise how lucrative targeting could be:</p>
<ul>
<li><p><strong>RATE AUTOC</strong> (Area <em>Under</em> the TOC) puts equal weight on every <span class="math inline">q</span>. This answers: <em>If benefits are concentrated among the very best prospects, how much can we harvest by cherry-picking them?</em></p></li>
<li><p><strong>RATE Qini</strong> applies heavier weight to the mid-range of <span class="math inline">q</span>. This is the go-to metric when investigators face a fixed, moderate-sized budget—say, “we can afford to treat 40 % of individuals; will targeting help?” <span class="citation" data-cites="yadlowsky2021evaluating">(<a href="#ref-yadlowsky2021evaluating" role="doc-biblioref">Yadlowsky et al. 2021</a>)</span>. We will evaluate the curve at treatment of 20% and 50% of the population.</p></li>
</ul>
<div class="no-row-height column-margin column-container"><div id="ref-yadlowsky2021evaluating" class="csl-entry" role="listitem">
Yadlowsky, Steve, Scott Fleming, Nigam Shah, Emma Brunskill, and Stefan Wager. 2021. <span>“Evaluating Treatment Prioritization Rules via Rank-Weighted Average Treatment Effects.”</span> <em>arXiv Preprint arXiv:2111.07966</em>. <a href="https://doi.org/10.48550/arXiv.2111.07966">https://doi.org/10.48550/arXiv.2111.07966</a>.
</div></div><p>To quantify the economic or policy value of heterogeneity, rank units by <span class="math inline">\widehat{\tau}(x)</span> and draw a <strong>Targeting-Operator Characteristic (TOC)</strong> curve that plots cumulative gain against the fraction <span class="math inline">q</span> of the population treated.</p>
<hr>
</section>
<section id="rate-autoc-example" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="rate-autoc-example">7 RATE AUTOC EXAMPLE</h3>
<p>Although OOB predictions are ‘out-of-sample’ for individual trees, the full forest still reuses information. A simple remedy when estimating the RATE AUTOC and Qini is to split the data, <strong>training</strong> the forest on one fold and <strong>testing</strong> RATE/Qini on the other. Again, this explicit splitting blocks optimistic bias and yields honest test statistics (such as confidence intervals) <span class="citation" data-cites="grf2024">(<a href="#ref-grf2024" role="doc-biblioref">Tibshirani et al. 2024</a>)</span>.</p>
<div class="no-row-height column-margin column-container"></div><div class="cell page-columns page-full">
<div id="fig-rate-example" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-rate-example-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="08-content_files/figure-html/fig-rate-example-1.png" class="img-fluid figure-img column-screen" width="672">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig" id="fig-rate-example-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: RATE AUTOC: Hours Socialising → Sense of Meaning
</figcaption>
</figure>
</div>
</div>
<p><a href="#fig-rate-example" class="quarto-xref">Figure&nbsp;1</a> depicts a typical RATE AUTOC curve with sample splitting. A steep initial rise indicates that a small, correctly targeted programme could deliver large gains. Note that the curve begins dipping below zero past about 30% of the sample. At that point we might be doing worse than the ATE by targeting the CATE – at least for some.</p>
<div class="page-columns page-full"><p><strong>Remember – figuring out who will benefit from a treatment is a difficult statistical problem <span class="citation" data-cites="grf2024">(<a href="#ref-grf2024" role="doc-biblioref">Tibshirani et al. 2024</a>)</span>.</strong></p><div class="no-row-height column-margin column-container"><div id="ref-grf2024" class="csl-entry" role="listitem">
Tibshirani, Julie, Susan Athey, Erik Sverdrup, and Stefan Wager. 2024. <em>Grf: Generalized Random Forests</em>. <a href="https://github.com/grf-labs/grf">https://github.com/grf-labs/grf</a>.
</div></div></div>
<hr>
</section>
<section id="visualising-policy-value-the-qini-curve" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="visualising-policy-value-the-qini-curve">8 Visualising policy value: the Qini curve</h3>
<p>A <strong>Qini curve</strong> displays cumulative benefit on the vertical axis and treatment coverage (% of the population treated) on the horizontal. As with the AUTOC curve we are using a held-out test fold to validate the response curve.</p>
<div class="cell page-columns page-full">
<div id="fig-qini-example" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-qini-example-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="08-content_files/figure-html/fig-qini-example-1.png" class="img-fluid figure-img column-screen" width="672">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig" id="fig-qini-example-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Qini Curve: Hours Socialising → Social Belonging
</figcaption>
</figure>
</div>
</div>
<p><a href="#fig-qini-example" class="quarto-xref">Figure&nbsp;2</a>: we find that focussing on the top 20 % of individuals nets a gain of 0.08 units (95 % CI 0.04–0.12). Widening the net to 50 % bumps the haul to 0.13 units (95 % CI 0.07–0.19). After that the curve flattens – once we’ve treated everyone who offers a decent return, there are no more ‘big fish’ left to catch.</p>
<hr>
</section>
<section id="from-a-black-box-to-simple-rules-policy-trees" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="from-a-black-box-to-simple-rules-policy-trees">9 From ‘a black box’ to simple rules: policy trees</h3>
<p>The causal forest hands us a personalised CATE for every individual, mapping a <strong>high-dimensional</strong> covariate vector <span class="math inline">X</span> to a number <span class="math inline">\widehat{\tau}(X)</span>. Helpful as that forecast may be, it stops short of telling us <em>what to do</em>: the function itself is too tangled — thousands of overlapping splits – to translate directly into a policy.</p>
<p>The <strong>policytree</strong> algorithm bridges that gap by collapsing the forest’s many <span class="math inline">\widehat{\tau}(X)</span> values into a single, shallow decision tree whose depth you choose; each split is chosen to maximise expected benefit <span class="citation" data-cites="policytree_package_2024">(<a href="#ref-policytree_package_2024" role="doc-biblioref">Sverdrup et al. 2024</a>)</span>. In this course we cap the depth at <strong>two</strong> for a practical balance, specifially:</p>
<div class="no-row-height column-margin column-container"><div id="ref-policytree_package_2024" class="csl-entry" role="listitem">
Sverdrup, Erik, Ayush Kanodia, Zhengyuan Zhou, Susan Athey, and Stefan Wager. 2024. <em>Policytree: Policy Learning via Doubly Robust Empirical Welfare Maximization over Trees</em>. <a href="https://CRAN.R-project.org/package=policytree">https://CRAN.R-project.org/package=policytree</a>.
</div></div><ul>
<li>At most three yes/no questions per rule, so the logic fits on a slide you can present to policy-makers</li>
<li>Each leaf still contains enough observations to yield a stable effect estimate;<br>
</li>
<li>Deeper trees increase computational complexity faster than they improve payoffs.</li>
</ul>
<div class="cell page-columns page-full">
<div id="fig-decision-tree" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-decision-tree-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca" class="page-columns page-full">
<img src="08-content_files/figure-html/fig-decision-tree-1.png" class="img-fluid figure-img column-screen" width="672">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig" id="fig-decision-tree-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Decision tree for Social Belonging
</figcaption>
</figure>
</div>
</div>
<p><strong>Policy Tree Findings for Effect of Hour Socialising on Social Belonging:</strong></p>
<p>Participants are first split by Self Esteem at -0.925 (original scale: 3.958). For those with Self Esteem <span class="math inline">&lt;=</span> this threshold, the next split is by Neuroticism at 0.642 (original scale: 4.228). Within that subgroup, individuals with Neuroticism <span class="math inline">&lt;=</span> the threshold are recommended <strong>control</strong>, while those with Neuroticism <span class="math inline">&gt;</span> the threshold are recommended <strong>treated</strong>.</p>
<p>For participants with Self Esteem <span class="math inline">&gt;</span> -0.925 (original scale: 3.958), the second split is by Social Belonging at 0.776 (original scale: 5.972). In this subgroup, individuals with Social Belonging <span class="math inline">&lt;=</span> the threshold are recommended <strong>treated</strong>, while those with Social Belonging <span class="math inline">&gt;</span> the threshold are recommended <strong>control</strong>.</p>
<div id="fig-policy-map" class="quarto-float quarto-figure quarto-figure-center anchored page-columns page-full">
<figure class="quarto-float quarto-float-fig figure page-columns page-full">
<div aria-describedby="fig-policy-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="08-content_files/figure-html/fig-policy-map-1.png" class="img-fluid figure-img" width="1536">
</div>
<figcaption class="quarto-float-caption-margin quarto-float-caption quarto-float-fig margin-caption" id="fig-policy-map-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Predicted treatment assignment (predictions out of training sample)
</figcaption>
</figure>
</div>
<hr>
</section>
<section id="ethical-and-practical-considerations" class="level3">
<h3 class="anchored" data-anchor-id="ethical-and-practical-considerations">10 Ethical and practical considerations</h3>
<p>There is no guarantee that statistical optimality will line up with social optimality. A rule that maximises expected health gains might still be <strong>unaffordable</strong> for a public agency, <strong>unfair</strong> to a protected group, or <strong>opaque</strong> to those asked to trust it. We all have our notions of fairness, and we can’t be expected to ignore them. Moreover, the estimation of CATE is always senstive to which variables we include in our model (see the caveats in <a href="https://go-bayes.github.io/psych-434-2025/content/06-content.html#appendix-b-evidence-for-effect-modification-is-relative-to-inclusion-of-other-variables-in-the-model">Lecture 6</a>).</p>
<p>So, we should not consider CATE an absolute guide to practice. We should be cautious.</p>
<p>Yet the very same CATE machinery that powers targeting also helps science move past a <em>one-size-fits-all</em> mindset. By mapping treatment effects across a high-dimensional covariate space, we can test whether our favourite categories – gender, age group, clinical severity – actually capture the differences that matter. Sometimes they do; often they don’t, revealing that nature is not carved at the joints of our folk classifications. Discovering <em>where</em> the forest finds meaningful splits can generate fresh psychological hypotheses about who responds, why, and under what circumstances, even when no policy decision is on the table. Over the next several weeks, we shall return to this point with examples.</p>
<!-- Before deployment we therefore need three extra layers of scrutiny: -->
<!-- 1. **Cost realism**   Will the programme's administrative and opportunity costs erase the forecast benefit?  A cost–effectiveness analysis can reveal when a simpler, less 'optimal' rule actually delivers better value.   -->
<!-- 2. **Fairness auditing**  check whether error rates or treatment probabilities differ by gender, ethnicity, or socioeconomic status.  If gaps appear, consider adjusting the loss function or adding fairness constraints [@mitchell2021algorithmic].   -->
<!-- 3. **Transparency and consent**   Publish the rule, document data sources, and secure stakeholder buy-in.  Transparent governance limits the risk of political backlash and encourages external replication. -->
<hr>
</section>
<section id="summarynext-steps" class="level3">
<h3 class="anchored" data-anchor-id="summarynext-steps">Summary/next steps</h3>
<p>Our workflow answers three questions in sequence:</p>
<ol type="1">
<li><strong>Is there substantial heterogeneity?</strong> Reject <span class="math inline">H_0{:}\tau(x)</span> constant if RATE AUTOC or RATE Qini is positive and statistically reliable<br>
</li>
<li><strong>Does targeting pay at realistic budgets?</strong> Inspect the slope of the Qini curve around plausible coverage levels.</li>
<li><strong>Can we express the targeting rule in a few defensible steps?</strong> fit and validate a shallow policy tree.</li>
</ol>
<p>In the lab section you will reproduce each stage on a simulated dataset.</p>
<hr>
</section>
</section>
<section id="lab-data-preparation-and-analysis-scripts" class="level2">
<h2 class="anchored" data-anchor-id="lab-data-preparation-and-analysis-scripts">Lab: Data Preparation and Analysis Scripts</h2>
<section id="link-to-data-dictionary" class="level3">
<h3 class="anchored" data-anchor-id="link-to-data-dictionary">Link to data dictionary</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>For information about the variables in the synthetic data, download the New Zealand Attitudes and Values Data Dictionary here under “Primary Resources”</p>
<p><a href="https://osf.io/75snb/">https://osf.io/75snb/</a></p>
</div>
</div>
</section>
<section id="script-1" class="level3">
<h3 class="anchored" data-anchor-id="script-1">Script 1:</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># example script 1: data wrangling</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co"># spring 2025</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="co"># example estimation of average treatment effect - script 1</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co"># questions: joseph.bulbulia@vuw.ac.nz</span></span>
<span id="cb1-5"><a href="#cb1-5"></a></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="co"># restart fresh session if needed</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="co"># rstudioapi::restartSession()</span></span>
<span id="cb1-8"><a href="#cb1-8"></a></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="co"># set seed for reproducibility</span></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb1-11"><a href="#cb1-11"></a></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="co"># save paths -------------------------------------------------------------------</span></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="co"># specify the path where data will be saved</span></span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="co"># this is the path used by joseph</span></span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="co"># push_mods &lt;- here::here('/Users/joseph/v-project\ Dropbox/data/courses/25-psych-434')</span></span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="co"># replace with your own path after creating a data file</span></span>
<span id="cb1-17"><a href="#cb1-17"></a>push_mods <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>)</span>
<span id="cb1-18"><a href="#cb1-18"></a></span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="co"># load libraries ---------------------------------------------------------</span></span>
<span id="cb1-20"><a href="#cb1-20"></a><span class="co"># install and load 'margot' package if not already installed</span></span>
<span id="cb1-21"><a href="#cb1-21"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(margot, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb1-22"><a href="#cb1-22"></a>  devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"go-bayes/margot"</span>) <span class="co"># ensure version is at least 1.0.21</span></span>
<span id="cb1-23"><a href="#cb1-23"></a>}</span>
<span id="cb1-24"><a href="#cb1-24"></a></span>
<span id="cb1-25"><a href="#cb1-25"></a><span class="co"># install and load 'boilerplate' package if not already installed</span></span>
<span id="cb1-26"><a href="#cb1-26"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(boilerplate, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb1-27"><a href="#cb1-27"></a>  devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"go-bayes/boilerplate"</span>)</span>
<span id="cb1-28"><a href="#cb1-28"></a>}</span>
<span id="cb1-29"><a href="#cb1-29"></a></span>
<span id="cb1-30"><a href="#cb1-30"></a><span class="co"># load required libraries</span></span>
<span id="cb1-31"><a href="#cb1-31"></a><span class="fu">library</span>(margot)</span>
<span id="cb1-32"><a href="#cb1-32"></a><span class="fu">library</span>(boilerplate)</span>
<span id="cb1-33"><a href="#cb1-33"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-34"><a href="#cb1-34"></a><span class="fu">library</span>(qs)</span>
<span id="cb1-35"><a href="#cb1-35"></a><span class="fu">library</span>(here)</span>
<span id="cb1-36"><a href="#cb1-36"></a></span>
<span id="cb1-37"><a href="#cb1-37"></a><span class="co"># import synthetic data ---------------------------------------------------</span></span>
<span id="cb1-38"><a href="#cb1-38"></a><span class="co"># link to synthetic data</span></span>
<span id="cb1-39"><a href="#cb1-39"></a><span class="co"># url &lt;- "https://www.dropbox.com/scl/fi/ru0ecayju04ja8ky1mhel/df_nz_long.qs?rlkey=prpk9a5v4vcg1ilhkgf357dhd&amp;dl=1"</span></span>
<span id="cb1-40"><a href="#cb1-40"></a><span class="co"># </span></span>
<span id="cb1-41"><a href="#cb1-41"></a><span class="co"># # download data to a temporary file</span></span>
<span id="cb1-42"><a href="#cb1-42"></a><span class="co"># tmp &lt;- tempfile(fileext = ".qs")</span></span>
<span id="cb1-43"><a href="#cb1-43"></a><span class="co"># download.file(url, tmp, mode = "wb")</span></span>
<span id="cb1-44"><a href="#cb1-44"></a><span class="co"># </span></span>
<span id="cb1-45"><a href="#cb1-45"></a><span class="co"># # read data into R</span></span>
<span id="cb1-46"><a href="#cb1-46"></a><span class="co"># library(qs)</span></span>
<span id="cb1-47"><a href="#cb1-47"></a><span class="co"># df_nz_long &lt;- qread(tmp)</span></span>
<span id="cb1-48"><a href="#cb1-48"></a><span class="co"># </span></span>
<span id="cb1-49"><a href="#cb1-49"></a><span class="co"># # view first few rows of synthetic data</span></span>
<span id="cb1-50"><a href="#cb1-50"></a><span class="co"># head(df_nz_long)</span></span>
<span id="cb1-51"><a href="#cb1-51"></a><span class="co"># </span></span>
<span id="cb1-52"><a href="#cb1-52"></a><span class="co"># # save data to your directory for later use and comment the above</span></span>
<span id="cb1-53"><a href="#cb1-53"></a><span class="co"># margot::here_save_qs(df_nz_long,"df_nz_long" ,push_mods)</span></span>
<span id="cb1-54"><a href="#cb1-54"></a></span>
<span id="cb1-55"><a href="#cb1-55"></a><span class="co"># comment the above and henceforth read your data: </span></span>
<span id="cb1-56"><a href="#cb1-56"></a><span class="co"># remove old data </span></span>
<span id="cb1-57"><a href="#cb1-57"></a><span class="fu">rm</span>(df_nz_long)</span>
<span id="cb1-58"><a href="#cb1-58"></a></span>
<span id="cb1-59"><a href="#cb1-59"></a><span class="co"># read data from saved file</span></span>
<span id="cb1-60"><a href="#cb1-60"></a>df_nz_long <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read_qs</span>(<span class="st">"df_nz_long"</span>, push_mods)</span>
<span id="cb1-61"><a href="#cb1-61"></a></span>
<span id="cb1-62"><a href="#cb1-62"></a><span class="co"># define study variables --------------------------------------------------------</span></span>
<span id="cb1-63"><a href="#cb1-63"></a></span>
<span id="cb1-64"><a href="#cb1-64"></a><span class="co"># view variable names in the dataset</span></span>
<span id="cb1-65"><a href="#cb1-65"></a><span class="fu">glimpse</span>(df_nz_long)</span>
<span id="cb1-66"><a href="#cb1-66"></a></span>
<span id="cb1-67"><a href="#cb1-67"></a><span class="co"># count the number of unique participants</span></span>
<span id="cb1-68"><a href="#cb1-68"></a><span class="fu">length</span>(<span class="fu">unique</span>(df_nz_long<span class="sc">$</span>id))</span>
<span id="cb1-69"><a href="#cb1-69"></a></span>
<span id="cb1-70"><a href="#cb1-70"></a><span class="co"># define exposure variable</span></span>
<span id="cb1-71"><a href="#cb1-71"></a>name_exposure <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"hours_community"</span>)</span>
<span id="cb1-72"><a href="#cb1-72"></a>var_labels_exposure <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"hours_community"</span> <span class="ot">=</span> <span class="st">"Weekly Hours Community Socialising"</span>,</span>
<span id="cb1-73"><a href="#cb1-73"></a>                        <span class="st">"hours_community_binary"</span> <span class="ot">=</span> <span class="st">"Weekly Hours Community Socialising (binary)"</span>)</span>
<span id="cb1-74"><a href="#cb1-74"></a></span>
<span id="cb1-75"><a href="#cb1-75"></a><span class="co"># save variable labels for manuscript</span></span>
<span id="cb1-76"><a href="#cb1-76"></a><span class="fu">here_save</span>(var_labels_exposure, <span class="st">"var_labels_exposure"</span>)</span>
<span id="cb1-77"><a href="#cb1-77"></a></span>
<span id="cb1-78"><a href="#cb1-78"></a><span class="co"># define variable names for binary exposure</span></span>
<span id="cb1-79"><a href="#cb1-79"></a>name_exposure_binary <span class="ot">&lt;-</span> <span class="fu">paste0</span>(name_exposure, <span class="st">"_binary"</span>)</span>
<span id="cb1-80"><a href="#cb1-80"></a>t0_name_exposure_continuous <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t0_"</span>, name_exposure)</span>
<span id="cb1-81"><a href="#cb1-81"></a>t0_name_exposure_binary <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t0_"</span>, name_exposure, <span class="st">"_binary"</span>)</span>
<span id="cb1-82"><a href="#cb1-82"></a></span>
<span id="cb1-83"><a href="#cb1-83"></a><span class="co"># define wide variable names</span></span>
<span id="cb1-84"><a href="#cb1-84"></a>t0_name_exposure <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t0_"</span>, name_exposure)</span>
<span id="cb1-85"><a href="#cb1-85"></a>t0_name_exposure_continuous <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t0_"</span>, name_exposure)</span>
<span id="cb1-86"><a href="#cb1-86"></a>t0_name_exposure_binary <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t0_"</span>, name_exposure, <span class="st">"_binary"</span>)</span>
<span id="cb1-87"><a href="#cb1-87"></a></span>
<span id="cb1-88"><a href="#cb1-88"></a><span class="co"># define variable names for exposures used in models</span></span>
<span id="cb1-89"><a href="#cb1-89"></a>t1_name_exposure <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t1_"</span>, name_exposure)</span>
<span id="cb1-90"><a href="#cb1-90"></a>t1_name_exposure_binary <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t1_"</span>, name_exposure, <span class="st">"_binary"</span>)</span>
<span id="cb1-91"><a href="#cb1-91"></a><span class="co"># define study waves -----------------------------------------------------------</span></span>
<span id="cb1-92"><a href="#cb1-92"></a>baseline_wave <span class="ot">&lt;-</span> <span class="st">"2018"</span></span>
<span id="cb1-93"><a href="#cb1-93"></a>exposure_waves <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"2019"</span>)</span>
<span id="cb1-94"><a href="#cb1-94"></a>outcome_wave <span class="ot">&lt;-</span> <span class="st">"2020"</span></span>
<span id="cb1-95"><a href="#cb1-95"></a></span>
<span id="cb1-96"><a href="#cb1-96"></a><span class="co"># define wave combinations for analysis</span></span>
<span id="cb1-97"><a href="#cb1-97"></a>all_waves <span class="ot">&lt;-</span> <span class="fu">c</span>(baseline_wave, exposure_waves, outcome_wave)</span>
<span id="cb1-98"><a href="#cb1-98"></a>baseline_and_exposure_waves <span class="ot">&lt;-</span> <span class="fu">c</span>(baseline_wave, exposure_waves)</span>
<span id="cb1-99"><a href="#cb1-99"></a>baseline_and_outcome_waves <span class="ot">&lt;-</span> <span class="fu">c</span>(baseline_wave, outcome_wave)</span>
<span id="cb1-100"><a href="#cb1-100"></a></span>
<span id="cb1-101"><a href="#cb1-101"></a><span class="co"># define scale ranges ----------------------------------------------------------</span></span>
<span id="cb1-102"><a href="#cb1-102"></a>scale_range_exposure <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">20</span>)  <span class="co"># used for descriptive graphs</span></span>
<span id="cb1-103"><a href="#cb1-103"></a>scale_ranges_outcomes <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">7</span>)  <span class="co"># used for descriptive graphs</span></span>
<span id="cb1-104"><a href="#cb1-104"></a></span>
<span id="cb1-105"><a href="#cb1-105"></a><span class="co"># check package versions</span></span>
<span id="cb1-106"><a href="#cb1-106"></a><span class="fu">packageVersion</span>(<span class="at">pkg =</span> <span class="st">'margot'</span>)    <span class="co"># make sure it is 1.0.19 or greater</span></span>
<span id="cb1-107"><a href="#cb1-107"></a><span class="fu">packageVersion</span>(<span class="at">pkg =</span> <span class="st">'boilerplate'</span>)</span>
<span id="cb1-108"><a href="#cb1-108"></a></span>
<span id="cb1-109"><a href="#cb1-109"></a><span class="co"># load required packages -------------------------------------------------------</span></span>
<span id="cb1-110"><a href="#cb1-110"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb1-111"><a href="#cb1-111"></a>  <span class="co"># causal inference</span></span>
<span id="cb1-112"><a href="#cb1-112"></a>  clarify,      <span class="co"># sensitivity analysis</span></span>
<span id="cb1-113"><a href="#cb1-113"></a>  cobalt,       <span class="co"># covariate balance tables and plots</span></span>
<span id="cb1-114"><a href="#cb1-114"></a>  lmtp,         <span class="co"># longitudinal targeted maximum likelihood estimation</span></span>
<span id="cb1-115"><a href="#cb1-115"></a>  margot,       <span class="co"># functions for causal inference</span></span>
<span id="cb1-116"><a href="#cb1-116"></a>  MatchIt,      <span class="co"># matching methods</span></span>
<span id="cb1-117"><a href="#cb1-117"></a>  MatchThem,    <span class="co"># matching for multiply imputed datasets</span></span>
<span id="cb1-118"><a href="#cb1-118"></a>  policytree,   <span class="co"># causal inference with policy trees</span></span>
<span id="cb1-119"><a href="#cb1-119"></a>  WeightIt,     <span class="co"># weighting methods for covariate balancing</span></span>
<span id="cb1-120"><a href="#cb1-120"></a>  </span>
<span id="cb1-121"><a href="#cb1-121"></a>  <span class="co"># data processing</span></span>
<span id="cb1-122"><a href="#cb1-122"></a>  data.table,   <span class="co"># fast data wrangling</span></span>
<span id="cb1-123"><a href="#cb1-123"></a>  fastDummies,  <span class="co"># fast creation of dummy variables</span></span>
<span id="cb1-124"><a href="#cb1-124"></a>  fs,           <span class="co"># cross-platform file system operations</span></span>
<span id="cb1-125"><a href="#cb1-125"></a>  here,         <span class="co"># simple and robust file referencing</span></span>
<span id="cb1-126"><a href="#cb1-126"></a>  janitor,      <span class="co"># data cleaning and validation</span></span>
<span id="cb1-127"><a href="#cb1-127"></a>  naniar,       <span class="co"># handling and visualization of missing data</span></span>
<span id="cb1-128"><a href="#cb1-128"></a>  skimr,        <span class="co"># summary statistics for data frames</span></span>
<span id="cb1-129"><a href="#cb1-129"></a>  tidyverse,    <span class="co"># collection of "R" packages for data science</span></span>
<span id="cb1-130"><a href="#cb1-130"></a>  </span>
<span id="cb1-131"><a href="#cb1-131"></a>  <span class="co"># machine learning</span></span>
<span id="cb1-132"><a href="#cb1-132"></a>  glmnet,       <span class="co"># lasso and elastic-net regularized models</span></span>
<span id="cb1-133"><a href="#cb1-133"></a>  grf,          <span class="co"># generalized random forests</span></span>
<span id="cb1-134"><a href="#cb1-134"></a>  ranger,       <span class="co"># fast implementation of random forests</span></span>
<span id="cb1-135"><a href="#cb1-135"></a>  SuperLearner, <span class="co"># ensemble learning</span></span>
<span id="cb1-136"><a href="#cb1-136"></a>  xgboost,      <span class="co"># extreme gradient boosting</span></span>
<span id="cb1-137"><a href="#cb1-137"></a>  </span>
<span id="cb1-138"><a href="#cb1-138"></a>  <span class="co"># visualization</span></span>
<span id="cb1-139"><a href="#cb1-139"></a>  DiagrammeR,   <span class="co"># graph and network visualization</span></span>
<span id="cb1-140"><a href="#cb1-140"></a>  ggbeeswarm,   <span class="co"># data visualization   </span></span>
<span id="cb1-141"><a href="#cb1-141"></a>  ggplot2,      <span class="co"># data visualization</span></span>
<span id="cb1-142"><a href="#cb1-142"></a>  gt,           <span class="co"># "HTML" tables for data frames</span></span>
<span id="cb1-143"><a href="#cb1-143"></a>  gtsummary,    <span class="co"># summary tables for regression models</span></span>
<span id="cb1-144"><a href="#cb1-144"></a>  kableExtra,   <span class="co"># advanced table formatting</span></span>
<span id="cb1-145"><a href="#cb1-145"></a>  </span>
<span id="cb1-146"><a href="#cb1-146"></a>  <span class="co"># parallel processing</span></span>
<span id="cb1-147"><a href="#cb1-147"></a>  doParallel,   <span class="co"># parallel processing with foreach</span></span>
<span id="cb1-148"><a href="#cb1-148"></a>  progressr,    <span class="co"># progress reporting for "R"</span></span>
<span id="cb1-149"><a href="#cb1-149"></a>  </span>
<span id="cb1-150"><a href="#cb1-150"></a>  <span class="co"># analysis</span></span>
<span id="cb1-151"><a href="#cb1-151"></a>  parameters,   <span class="co"># parameters and performance metrics</span></span>
<span id="cb1-152"><a href="#cb1-152"></a>  EValue        <span class="co"># compute e-values</span></span>
<span id="cb1-153"><a href="#cb1-153"></a>)</span>
<span id="cb1-154"><a href="#cb1-154"></a><span class="co"># data preparation -------------------------------------------------------------</span></span>
<span id="cb1-155"><a href="#cb1-155"></a><span class="co"># import and prepare data</span></span>
<span id="cb1-156"><a href="#cb1-156"></a></span>
<span id="cb1-157"><a href="#cb1-157"></a><span class="co"># get total sample size</span></span>
<span id="cb1-158"><a href="#cb1-158"></a>n_total <span class="ot">&lt;-</span> skimr<span class="sc">::</span><span class="fu">n_unique</span>(df_nz_long<span class="sc">$</span>id)</span>
<span id="cb1-159"><a href="#cb1-159"></a>n_total <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">pretty_number</span>(n_total)</span>
<span id="cb1-160"><a href="#cb1-160"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(n_total, <span class="st">"n_total"</span>)</span>
<span id="cb1-161"><a href="#cb1-161"></a></span>
<span id="cb1-162"><a href="#cb1-162"></a><span class="co"># view</span></span>
<span id="cb1-163"><a href="#cb1-163"></a>n_total</span>
<span id="cb1-164"><a href="#cb1-164"></a></span>
<span id="cb1-165"><a href="#cb1-165"></a><span class="co"># Define Baseline Variables ----------------------------------------------------</span></span>
<span id="cb1-166"><a href="#cb1-166"></a>baseline_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-167"><a href="#cb1-167"></a>  <span class="co"># note all outcomes will be added to baseline vars later. </span></span>
<span id="cb1-168"><a href="#cb1-168"></a>  <span class="co"># demographics</span></span>
<span id="cb1-169"><a href="#cb1-169"></a>  <span class="st">"age"</span>,</span>
<span id="cb1-170"><a href="#cb1-170"></a>  <span class="st">"born_nz_binary"</span>,</span>
<span id="cb1-171"><a href="#cb1-171"></a>  <span class="st">"education_level_coarsen"</span>,</span>
<span id="cb1-172"><a href="#cb1-172"></a>  <span class="st">"employed_binary"</span>,</span>
<span id="cb1-173"><a href="#cb1-173"></a>  <span class="st">"eth_cat"</span>,</span>
<span id="cb1-174"><a href="#cb1-174"></a>  <span class="st">"male_binary"</span>,</span>
<span id="cb1-175"><a href="#cb1-175"></a>  <span class="st">"not_heterosexual_binary"</span>,</span>
<span id="cb1-176"><a href="#cb1-176"></a>  <span class="st">"parent_binary"</span>,</span>
<span id="cb1-177"><a href="#cb1-177"></a>  <span class="st">"partner_binary"</span>,</span>
<span id="cb1-178"><a href="#cb1-178"></a>  <span class="st">"rural_gch_2018_l"</span>,</span>
<span id="cb1-179"><a href="#cb1-179"></a>  <span class="st">"sample_frame_opt_in_binary"</span>,</span>
<span id="cb1-180"><a href="#cb1-180"></a>  </span>
<span id="cb1-181"><a href="#cb1-181"></a>  <span class="co"># personality traits</span></span>
<span id="cb1-182"><a href="#cb1-182"></a>  <span class="st">"agreeableness"</span>,</span>
<span id="cb1-183"><a href="#cb1-183"></a>  <span class="st">"conscientiousness"</span>,</span>
<span id="cb1-184"><a href="#cb1-184"></a>  <span class="st">"extraversion"</span>,</span>
<span id="cb1-185"><a href="#cb1-185"></a>  <span class="st">"neuroticism"</span>,</span>
<span id="cb1-186"><a href="#cb1-186"></a>  <span class="st">"openness"</span>,</span>
<span id="cb1-187"><a href="#cb1-187"></a>  </span>
<span id="cb1-188"><a href="#cb1-188"></a>  <span class="co"># health and lifestyle</span></span>
<span id="cb1-189"><a href="#cb1-189"></a>  <span class="st">"alcohol_frequency"</span>,</span>
<span id="cb1-190"><a href="#cb1-190"></a>  <span class="st">"alcohol_intensity"</span>,</span>
<span id="cb1-191"><a href="#cb1-191"></a>  <span class="st">"hlth_disability_binary"</span>,</span>
<span id="cb1-192"><a href="#cb1-192"></a>  <span class="st">"log_hours_children"</span>,</span>
<span id="cb1-193"><a href="#cb1-193"></a>  <span class="st">"log_hours_commute"</span>,</span>
<span id="cb1-194"><a href="#cb1-194"></a>  <span class="st">"log_hours_exercise"</span>,</span>
<span id="cb1-195"><a href="#cb1-195"></a>  <span class="st">"log_hours_housework"</span>,</span>
<span id="cb1-196"><a href="#cb1-196"></a>  <span class="st">"log_household_inc"</span>,</span>
<span id="cb1-197"><a href="#cb1-197"></a>  <span class="co"># "log_hours_community", # commented out because using as exposure</span></span>
<span id="cb1-198"><a href="#cb1-198"></a>  <span class="st">"short_form_health"</span>,</span>
<span id="cb1-199"><a href="#cb1-199"></a>  <span class="st">"smoker_binary"</span>,</span>
<span id="cb1-200"><a href="#cb1-200"></a>  </span>
<span id="cb1-201"><a href="#cb1-201"></a>  <span class="co"># social and psychological</span></span>
<span id="cb1-202"><a href="#cb1-202"></a>  <span class="st">"belong"</span>,</span>
<span id="cb1-203"><a href="#cb1-203"></a>  <span class="st">"nz_dep2018"</span>,</span>
<span id="cb1-204"><a href="#cb1-204"></a>  <span class="st">"nzsei_13_l"</span>,</span>
<span id="cb1-205"><a href="#cb1-205"></a>  <span class="st">"political_conservative"</span>,</span>
<span id="cb1-206"><a href="#cb1-206"></a>  <span class="st">"religion_identification_level"</span></span>
<span id="cb1-207"><a href="#cb1-207"></a>)</span>
<span id="cb1-208"><a href="#cb1-208"></a></span>
<span id="cb1-209"><a href="#cb1-209"></a><span class="co"># Sort baseline variables</span></span>
<span id="cb1-210"><a href="#cb1-210"></a>baseline_vars <span class="ot">&lt;-</span> <span class="fu">sort</span>(baseline_vars)</span>
<span id="cb1-211"><a href="#cb1-211"></a></span>
<span id="cb1-212"><a href="#cb1-212"></a></span>
<span id="cb1-213"><a href="#cb1-213"></a><span class="co"># baseline vars no log ----------------------------------------------------</span></span>
<span id="cb1-214"><a href="#cb1-214"></a></span>
<span id="cb1-215"><a href="#cb1-215"></a>baseline_vars_no_log <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-216"><a href="#cb1-216"></a>  <span class="co"># Demographics</span></span>
<span id="cb1-217"><a href="#cb1-217"></a>  <span class="st">"age"</span>,</span>
<span id="cb1-218"><a href="#cb1-218"></a>  <span class="st">"born_nz_binary"</span>,</span>
<span id="cb1-219"><a href="#cb1-219"></a>  <span class="st">"education_level_coarsen"</span>,</span>
<span id="cb1-220"><a href="#cb1-220"></a>  <span class="st">"eth_cat"</span>,</span>
<span id="cb1-221"><a href="#cb1-221"></a>  <span class="st">"employed_binary"</span>,</span>
<span id="cb1-222"><a href="#cb1-222"></a>  <span class="st">"male_binary"</span>,</span>
<span id="cb1-223"><a href="#cb1-223"></a>  <span class="st">"not_heterosexual_binary"</span>,</span>
<span id="cb1-224"><a href="#cb1-224"></a>  <span class="st">"parent_binary"</span>,</span>
<span id="cb1-225"><a href="#cb1-225"></a>  <span class="st">"partner_binary"</span>,</span>
<span id="cb1-226"><a href="#cb1-226"></a>  <span class="st">"rural_gch_2018_l"</span>,</span>
<span id="cb1-227"><a href="#cb1-227"></a>  <span class="st">"sample_frame_opt_in_binary"</span>,</span>
<span id="cb1-228"><a href="#cb1-228"></a>  </span>
<span id="cb1-229"><a href="#cb1-229"></a>  <span class="co"># Personality traits</span></span>
<span id="cb1-230"><a href="#cb1-230"></a>  <span class="st">"agreeableness"</span>,</span>
<span id="cb1-231"><a href="#cb1-231"></a>  <span class="st">"conscientiousness"</span>,</span>
<span id="cb1-232"><a href="#cb1-232"></a>  <span class="st">"extraversion"</span>,</span>
<span id="cb1-233"><a href="#cb1-233"></a>  <span class="st">"neuroticism"</span>,</span>
<span id="cb1-234"><a href="#cb1-234"></a>  <span class="st">"openness"</span>,</span>
<span id="cb1-235"><a href="#cb1-235"></a>  </span>
<span id="cb1-236"><a href="#cb1-236"></a>  <span class="co"># Health and lifestyle</span></span>
<span id="cb1-237"><a href="#cb1-237"></a>  <span class="st">"alcohol_frequency"</span>,</span>
<span id="cb1-238"><a href="#cb1-238"></a>  <span class="st">"alcohol_intensity"</span>,</span>
<span id="cb1-239"><a href="#cb1-239"></a>  <span class="st">"hlth_disability_binary"</span>,</span>
<span id="cb1-240"><a href="#cb1-240"></a>  <span class="st">"log_hours_children"</span>,</span>
<span id="cb1-241"><a href="#cb1-241"></a>  <span class="st">"hours_children"</span>,</span>
<span id="cb1-242"><a href="#cb1-242"></a>  <span class="st">"log_hours_commute"</span>,</span>
<span id="cb1-243"><a href="#cb1-243"></a>  <span class="st">"hours_commute"</span>,</span>
<span id="cb1-244"><a href="#cb1-244"></a>  <span class="st">"log_hours_exercise"</span>,</span>
<span id="cb1-245"><a href="#cb1-245"></a>  <span class="st">"hours_exercise"</span>,</span>
<span id="cb1-246"><a href="#cb1-246"></a>  <span class="st">"log_hours_housework"</span>,</span>
<span id="cb1-247"><a href="#cb1-247"></a>  <span class="st">"hours_housework"</span>,</span>
<span id="cb1-248"><a href="#cb1-248"></a>  <span class="st">"log_household_inc"</span>,</span>
<span id="cb1-249"><a href="#cb1-249"></a>  <span class="st">"household_inc"</span>,</span>
<span id="cb1-250"><a href="#cb1-250"></a>  <span class="co"># "log_hours_community",</span></span>
<span id="cb1-251"><a href="#cb1-251"></a>  <span class="st">"hours_community"</span>,</span>
<span id="cb1-252"><a href="#cb1-252"></a>  <span class="st">"short_form_health"</span>,</span>
<span id="cb1-253"><a href="#cb1-253"></a>  <span class="st">"smoker_binary"</span>,</span>
<span id="cb1-254"><a href="#cb1-254"></a>  </span>
<span id="cb1-255"><a href="#cb1-255"></a>  <span class="co"># Social and psychological</span></span>
<span id="cb1-256"><a href="#cb1-256"></a>  <span class="st">"belong"</span>,</span>
<span id="cb1-257"><a href="#cb1-257"></a>  <span class="st">"nz_dep2018"</span>,</span>
<span id="cb1-258"><a href="#cb1-258"></a>  <span class="st">"nzsei_13_l"</span>,</span>
<span id="cb1-259"><a href="#cb1-259"></a>  <span class="st">"political_conservative"</span>,</span>
<span id="cb1-260"><a href="#cb1-260"></a>  <span class="st">"religion_identification_level"</span></span>
<span id="cb1-261"><a href="#cb1-261"></a>)</span>
<span id="cb1-262"><a href="#cb1-262"></a></span>
<span id="cb1-263"><a href="#cb1-263"></a><span class="co"># define outcome variables ----------------------------------------------------</span></span>
<span id="cb1-264"><a href="#cb1-264"></a><span class="co"># define outcome variables without log transformation</span></span>
<span id="cb1-265"><a href="#cb1-265"></a><span class="co"># outcomes</span></span>
<span id="cb1-266"><a href="#cb1-266"></a>outcome_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-267"><a href="#cb1-267"></a>  <span class="st">"alcohol_frequency"</span>,</span>
<span id="cb1-268"><a href="#cb1-268"></a>  <span class="st">"alcohol_intensity"</span>,</span>
<span id="cb1-269"><a href="#cb1-269"></a>  <span class="st">"belong"</span>,</span>
<span id="cb1-270"><a href="#cb1-270"></a>  <span class="st">"bodysat"</span>,</span>
<span id="cb1-271"><a href="#cb1-271"></a>  <span class="st">"forgiveness"</span>,</span>
<span id="cb1-272"><a href="#cb1-272"></a>  <span class="st">"gratitude"</span>,</span>
<span id="cb1-273"><a href="#cb1-273"></a>  <span class="st">"hlth_bmi"</span>,</span>
<span id="cb1-274"><a href="#cb1-274"></a>  <span class="st">"hlth_fatigue"</span>,</span>
<span id="cb1-275"><a href="#cb1-275"></a>  <span class="st">"hlth_sleep_hours"</span>,</span>
<span id="cb1-276"><a href="#cb1-276"></a>  <span class="st">"kessler_latent_anxiety"</span>,</span>
<span id="cb1-277"><a href="#cb1-277"></a>  <span class="st">"kessler_latent_depression"</span>,</span>
<span id="cb1-278"><a href="#cb1-278"></a>  <span class="st">"lifesat"</span>,</span>
<span id="cb1-279"><a href="#cb1-279"></a>  <span class="st">"log_hours_exercise"</span>,</span>
<span id="cb1-280"><a href="#cb1-280"></a>  <span class="st">"meaning_purpose"</span>, </span>
<span id="cb1-281"><a href="#cb1-281"></a>  <span class="st">"meaning_sense"</span>,</span>
<span id="cb1-282"><a href="#cb1-282"></a>  <span class="st">"neighbourhood_community"</span>,</span>
<span id="cb1-283"><a href="#cb1-283"></a>  <span class="st">"perfectionism"</span>,</span>
<span id="cb1-284"><a href="#cb1-284"></a>  <span class="st">"pwi"</span>, </span>
<span id="cb1-285"><a href="#cb1-285"></a>  <span class="st">"rumination"</span>,</span>
<span id="cb1-286"><a href="#cb1-286"></a>  <span class="st">"self_control"</span>,</span>
<span id="cb1-287"><a href="#cb1-287"></a>  <span class="st">"self_esteem"</span>,</span>
<span id="cb1-288"><a href="#cb1-288"></a>  <span class="st">"sexual_satisfaction"</span>,</span>
<span id="cb1-289"><a href="#cb1-289"></a>  <span class="st">"short_form_health"</span>,</span>
<span id="cb1-290"><a href="#cb1-290"></a>  <span class="st">"support"</span></span>
<span id="cb1-291"><a href="#cb1-291"></a>)</span>
<span id="cb1-292"><a href="#cb1-292"></a></span>
<span id="cb1-293"><a href="#cb1-293"></a><span class="co"># sort and save outcome variables</span></span>
<span id="cb1-294"><a href="#cb1-294"></a>outcome_vars <span class="ot">&lt;-</span> <span class="fu">sort</span>(outcome_vars)</span>
<span id="cb1-295"><a href="#cb1-295"></a><span class="fu">here_save</span>(outcome_vars, <span class="st">"outcome_vars"</span>)</span>
<span id="cb1-296"><a href="#cb1-296"></a></span>
<span id="cb1-297"><a href="#cb1-297"></a><span class="co"># Create standardized outcome variables</span></span>
<span id="cb1-298"><a href="#cb1-298"></a>t2_outcome_vars_z <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t2_"</span>, outcome_vars, <span class="st">"_z"</span>)</span>
<span id="cb1-299"><a href="#cb1-299"></a></span>
<span id="cb1-300"><a href="#cb1-300"></a><span class="co"># view the result</span></span>
<span id="cb1-301"><a href="#cb1-301"></a>t2_outcome_vars_z</span>
<span id="cb1-302"><a href="#cb1-302"></a></span>
<span id="cb1-303"><a href="#cb1-303"></a></span>
<span id="cb1-304"><a href="#cb1-304"></a><span class="co"># define outcome variables without log transformation</span></span>
<span id="cb1-305"><a href="#cb1-305"></a><span class="co"># for tables</span></span>
<span id="cb1-306"><a href="#cb1-306"></a>outcome_vars_no_log <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-307"><a href="#cb1-307"></a>  <span class="st">"alcohol_frequency"</span>,</span>
<span id="cb1-308"><a href="#cb1-308"></a>  <span class="st">"alcohol_intensity"</span>,</span>
<span id="cb1-309"><a href="#cb1-309"></a>  <span class="st">"belong"</span>,</span>
<span id="cb1-310"><a href="#cb1-310"></a>  <span class="st">"bodysat"</span>,</span>
<span id="cb1-311"><a href="#cb1-311"></a>  <span class="st">"forgiveness"</span>,</span>
<span id="cb1-312"><a href="#cb1-312"></a>  <span class="st">"gratitude"</span>,</span>
<span id="cb1-313"><a href="#cb1-313"></a>  <span class="st">"hlth_bmi"</span>,</span>
<span id="cb1-314"><a href="#cb1-314"></a>  <span class="st">"hlth_fatigue"</span>,</span>
<span id="cb1-315"><a href="#cb1-315"></a>  <span class="st">"hlth_sleep_hours"</span>,</span>
<span id="cb1-316"><a href="#cb1-316"></a>  <span class="st">"hours_exercise"</span>, <span class="co"># logged </span></span>
<span id="cb1-317"><a href="#cb1-317"></a>  <span class="st">"kessler_latent_anxiety"</span>,</span>
<span id="cb1-318"><a href="#cb1-318"></a>  <span class="st">"kessler_latent_depression"</span>,</span>
<span id="cb1-319"><a href="#cb1-319"></a>  <span class="st">"lifesat"</span>,</span>
<span id="cb1-320"><a href="#cb1-320"></a>  <span class="st">"meaning_purpose"</span>,</span>
<span id="cb1-321"><a href="#cb1-321"></a>  <span class="st">"meaning_sense"</span>,</span>
<span id="cb1-322"><a href="#cb1-322"></a>  <span class="st">"neighbourhood_community"</span>,</span>
<span id="cb1-323"><a href="#cb1-323"></a>  <span class="st">"perfectionism"</span>,</span>
<span id="cb1-324"><a href="#cb1-324"></a>  <span class="st">"pwi"</span>, </span>
<span id="cb1-325"><a href="#cb1-325"></a>  <span class="st">"rumination"</span>,</span>
<span id="cb1-326"><a href="#cb1-326"></a>  <span class="st">"self_control"</span>,</span>
<span id="cb1-327"><a href="#cb1-327"></a>  <span class="st">"self_esteem"</span>,</span>
<span id="cb1-328"><a href="#cb1-328"></a>  <span class="st">"sexual_satisfaction"</span>,</span>
<span id="cb1-329"><a href="#cb1-329"></a>  <span class="st">"short_form_health"</span>,</span>
<span id="cb1-330"><a href="#cb1-330"></a>  <span class="st">"support"</span></span>
<span id="cb1-331"><a href="#cb1-331"></a>)</span>
<span id="cb1-332"><a href="#cb1-332"></a></span>
<span id="cb1-333"><a href="#cb1-333"></a><span class="co"># exposure_var</span></span>
<span id="cb1-334"><a href="#cb1-334"></a>exposure_var <span class="ot">=</span> <span class="fu">c</span>(name_exposure, name_exposure_binary)</span>
<span id="cb1-335"><a href="#cb1-335"></a></span>
<span id="cb1-336"><a href="#cb1-336"></a><span class="co"># check</span></span>
<span id="cb1-337"><a href="#cb1-337"></a><span class="co"># exposure_var_continuous = exposure_var[[1]]</span></span>
<span id="cb1-338"><a href="#cb1-338"></a><span class="co"># exposure_var_continuous</span></span>
<span id="cb1-339"><a href="#cb1-339"></a><span class="co"># </span></span>
<span id="cb1-340"><a href="#cb1-340"></a><span class="co"># exposure_var_binary =  exposure_var[[2]]</span></span>
<span id="cb1-341"><a href="#cb1-341"></a><span class="co"># exposure_var_binary</span></span>
<span id="cb1-342"><a href="#cb1-342"></a></span>
<span id="cb1-343"><a href="#cb1-343"></a><span class="co"># raw outcomes </span></span>
<span id="cb1-344"><a href="#cb1-344"></a>raw_outcomes_health <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-345"><a href="#cb1-345"></a>  <span class="st">"alcohol_frequency"</span>,</span>
<span id="cb1-346"><a href="#cb1-346"></a>  <span class="st">"alcohol_intensity"</span>,</span>
<span id="cb1-347"><a href="#cb1-347"></a>  <span class="st">"hlth_bmi"</span>, </span>
<span id="cb1-348"><a href="#cb1-348"></a>  <span class="st">"log_hours_exercise"</span>, </span>
<span id="cb1-349"><a href="#cb1-349"></a>  <span class="st">"hlth_sleep_hours"</span>, </span>
<span id="cb1-350"><a href="#cb1-350"></a>  <span class="st">"short_form_health"</span></span>
<span id="cb1-351"><a href="#cb1-351"></a>)</span>
<span id="cb1-352"><a href="#cb1-352"></a><span class="co"># sort</span></span>
<span id="cb1-353"><a href="#cb1-353"></a>raw_outcomes_health <span class="ot">&lt;-</span> <span class="fu">sort</span>(raw_outcomes_health)</span>
<span id="cb1-354"><a href="#cb1-354"></a></span>
<span id="cb1-355"><a href="#cb1-355"></a><span class="co"># save </span></span>
<span id="cb1-356"><a href="#cb1-356"></a><span class="fu">here_save</span>(raw_outcomes_health, <span class="st">"raw_outcomes_health"</span>)</span>
<span id="cb1-357"><a href="#cb1-357"></a></span>
<span id="cb1-358"><a href="#cb1-358"></a><span class="co"># define psych outcomes</span></span>
<span id="cb1-359"><a href="#cb1-359"></a>raw_outcomes_psych <span class="ot">&lt;-</span> <span class="fu">c</span>( </span>
<span id="cb1-360"><a href="#cb1-360"></a>  <span class="st">"hlth_fatigue"</span>, </span>
<span id="cb1-361"><a href="#cb1-361"></a>  <span class="st">"kessler_latent_anxiety"</span>, </span>
<span id="cb1-362"><a href="#cb1-362"></a>  <span class="st">"kessler_latent_depression"</span>,  </span>
<span id="cb1-363"><a href="#cb1-363"></a>  <span class="st">"rumination"</span></span>
<span id="cb1-364"><a href="#cb1-364"></a>)</span>
<span id="cb1-365"><a href="#cb1-365"></a></span>
<span id="cb1-366"><a href="#cb1-366"></a><span class="co"># sort</span></span>
<span id="cb1-367"><a href="#cb1-367"></a>raw_outcomes_psych <span class="ot">&lt;-</span> <span class="fu">sort</span>(raw_outcomes_psych)</span>
<span id="cb1-368"><a href="#cb1-368"></a></span>
<span id="cb1-369"><a href="#cb1-369"></a><span class="co"># save</span></span>
<span id="cb1-370"><a href="#cb1-370"></a><span class="fu">here_save</span>(raw_outcomes_psych, <span class="st">"raw_outcomes_psych"</span>)</span>
<span id="cb1-371"><a href="#cb1-371"></a></span>
<span id="cb1-372"><a href="#cb1-372"></a><span class="co"># define present outcomes</span></span>
<span id="cb1-373"><a href="#cb1-373"></a>raw_outcomes_present <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-374"><a href="#cb1-374"></a>  <span class="st">"bodysat"</span>,</span>
<span id="cb1-375"><a href="#cb1-375"></a>  <span class="st">"forgiveness"</span>,</span>
<span id="cb1-376"><a href="#cb1-376"></a>  <span class="st">"perfectionism"</span>, </span>
<span id="cb1-377"><a href="#cb1-377"></a>  <span class="st">"self_control"</span> , </span>
<span id="cb1-378"><a href="#cb1-378"></a>  <span class="st">"self_esteem"</span>, </span>
<span id="cb1-379"><a href="#cb1-379"></a>  <span class="st">"sexual_satisfaction"</span> </span>
<span id="cb1-380"><a href="#cb1-380"></a>)</span>
<span id="cb1-381"><a href="#cb1-381"></a></span>
<span id="cb1-382"><a href="#cb1-382"></a><span class="co"># sort</span></span>
<span id="cb1-383"><a href="#cb1-383"></a>raw_outcomes_present <span class="ot">&lt;-</span> <span class="fu">sort</span>(raw_outcomes_present)</span>
<span id="cb1-384"><a href="#cb1-384"></a></span>
<span id="cb1-385"><a href="#cb1-385"></a><span class="co"># save</span></span>
<span id="cb1-386"><a href="#cb1-386"></a><span class="fu">here_save</span>(raw_outcomes_present, <span class="st">"raw_outcomes_present"</span>)</span>
<span id="cb1-387"><a href="#cb1-387"></a></span>
<span id="cb1-388"><a href="#cb1-388"></a><span class="co"># define life outcomes</span></span>
<span id="cb1-389"><a href="#cb1-389"></a>raw_outcomes_life <span class="ot">&lt;-</span> <span class="fu">c</span>( </span>
<span id="cb1-390"><a href="#cb1-390"></a>  <span class="st">"gratitude"</span>, </span>
<span id="cb1-391"><a href="#cb1-391"></a>  <span class="st">"lifesat"</span>, </span>
<span id="cb1-392"><a href="#cb1-392"></a>  <span class="st">"meaning_purpose"</span>, </span>
<span id="cb1-393"><a href="#cb1-393"></a>  <span class="st">"meaning_sense"</span>,</span>
<span id="cb1-394"><a href="#cb1-394"></a>  <span class="st">"pwi"</span>  <span class="co"># move personal well-being here if not using individual facents</span></span>
<span id="cb1-395"><a href="#cb1-395"></a>)</span>
<span id="cb1-396"><a href="#cb1-396"></a></span>
<span id="cb1-397"><a href="#cb1-397"></a><span class="co"># sort</span></span>
<span id="cb1-398"><a href="#cb1-398"></a>raw_outcomes_life <span class="ot">&lt;-</span> <span class="fu">sort</span>(raw_outcomes_life)</span>
<span id="cb1-399"><a href="#cb1-399"></a></span>
<span id="cb1-400"><a href="#cb1-400"></a><span class="co"># save</span></span>
<span id="cb1-401"><a href="#cb1-401"></a><span class="fu">here_save</span>(raw_outcomes_life, <span class="st">"raw_outcomes_life"</span>)</span>
<span id="cb1-402"><a href="#cb1-402"></a></span>
<span id="cb1-403"><a href="#cb1-403"></a><span class="co"># define social outcomes</span></span>
<span id="cb1-404"><a href="#cb1-404"></a>raw_outcomes_social <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-405"><a href="#cb1-405"></a>  <span class="st">"belong"</span>,</span>
<span id="cb1-406"><a href="#cb1-406"></a>  <span class="st">"neighbourhood_community"</span>, </span>
<span id="cb1-407"><a href="#cb1-407"></a>  <span class="st">"support"</span> </span>
<span id="cb1-408"><a href="#cb1-408"></a>)</span>
<span id="cb1-409"><a href="#cb1-409"></a><span class="co"># sort</span></span>
<span id="cb1-410"><a href="#cb1-410"></a>raw_outcomes_social <span class="ot">&lt;-</span> <span class="fu">sort</span>(raw_outcomes_social)</span>
<span id="cb1-411"><a href="#cb1-411"></a></span>
<span id="cb1-412"><a href="#cb1-412"></a><span class="co"># save</span></span>
<span id="cb1-413"><a href="#cb1-413"></a><span class="fu">here_save</span>(raw_outcomes_social, <span class="st">"raw_outcomes_social"</span>)</span>
<span id="cb1-414"><a href="#cb1-414"></a></span>
<span id="cb1-415"><a href="#cb1-415"></a><span class="co"># save for publication</span></span>
<span id="cb1-416"><a href="#cb1-416"></a>raw_outcomes_all <span class="ot">&lt;-</span> <span class="fu">c</span>(raw_outcomes_health, </span>
<span id="cb1-417"><a href="#cb1-417"></a>                      raw_outcomes_psych,</span>
<span id="cb1-418"><a href="#cb1-418"></a>                      raw_outcomes_present, </span>
<span id="cb1-419"><a href="#cb1-419"></a>                      raw_outcomes_life, </span>
<span id="cb1-420"><a href="#cb1-420"></a>                      raw_outcomes_social)</span>
<span id="cb1-421"><a href="#cb1-421"></a></span>
<span id="cb1-422"><a href="#cb1-422"></a><span class="co"># save</span></span>
<span id="cb1-423"><a href="#cb1-423"></a><span class="fu">here_save</span>(raw_outcomes_all, <span class="st">"raw_outcomes_all"</span>)</span>
<span id="cb1-424"><a href="#cb1-424"></a></span>
<span id="cb1-425"><a href="#cb1-425"></a><span class="co">#table1::table1(~ religion_spiritual_identification |wave, data = dat)</span></span>
<span id="cb1-426"><a href="#cb1-426"></a>outcome_vars <span class="ot">&lt;-</span><span class="fu">sort</span>(outcome_vars)</span>
<span id="cb1-427"><a href="#cb1-427"></a>outcome_vars_no_log<span class="ot">&lt;-</span><span class="fu">sort</span>(outcome_vars_no_log)</span>
<span id="cb1-428"><a href="#cb1-428"></a>extra_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"wave"</span>, <span class="st">"year_measured"</span>, <span class="st">"not_lost"</span>, <span class="st">"sample_weights"</span>) </span>
<span id="cb1-429"><a href="#cb1-429"></a>all_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(baseline_vars, exposure_var, outcome_vars, extra_vars)</span>
<span id="cb1-430"><a href="#cb1-430"></a></span>
<span id="cb1-431"><a href="#cb1-431"></a>extra_vars_table <span class="ot">&lt;-</span> extra_vars</span>
<span id="cb1-432"><a href="#cb1-432"></a>not_all_vars<span class="ot">&lt;-</span> <span class="fu">c</span>(baseline_vars_no_log, exposure_var, outcome_vars_no_log, extra_vars_table)</span>
<span id="cb1-433"><a href="#cb1-433"></a></span>
<span id="cb1-434"><a href="#cb1-434"></a><span class="co"># sort</span></span>
<span id="cb1-435"><a href="#cb1-435"></a>all_vars <span class="ot">&lt;-</span> <span class="fu">sort</span>(all_vars)</span>
<span id="cb1-436"><a href="#cb1-436"></a>not_all_vars <span class="ot">&lt;-</span> <span class="fu">sort</span>(not_all_vars)</span>
<span id="cb1-437"><a href="#cb1-437"></a></span>
<span id="cb1-438"><a href="#cb1-438"></a><span class="co"># define columns that will later be handled in a special way</span></span>
<span id="cb1-439"><a href="#cb1-439"></a><span class="co"># define continuous columns that we will not standardise</span></span>
<span id="cb1-440"><a href="#cb1-440"></a>continuous_columns_keep <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"t0_sample_weights"</span>)</span>
<span id="cb1-441"><a href="#cb1-441"></a></span>
<span id="cb1-442"><a href="#cb1-442"></a></span>
<span id="cb1-443"><a href="#cb1-443"></a><span class="co"># define ordinal columns that we will expand into binary variables</span></span>
<span id="cb1-444"><a href="#cb1-444"></a>ordinal_columns <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"t0_education_level_coarsen"</span>, <span class="st">"t0_eth_cat"</span>, <span class="st">"t0_rural_gch_2018_l"</span>)</span>
<span id="cb1-445"><a href="#cb1-445"></a></span>
<span id="cb1-446"><a href="#cb1-446"></a><span class="co"># checks</span></span>
<span id="cb1-447"><a href="#cb1-447"></a>overlap <span class="ot">&lt;-</span> <span class="fu">intersect</span>(baseline_vars, outcome_vars)</span>
<span id="cb1-448"><a href="#cb1-448"></a><span class="fu">print</span>(overlap)</span>
<span id="cb1-449"><a href="#cb1-449"></a></span>
<span id="cb1-450"><a href="#cb1-450"></a><span class="co"># read and preprocess data ------------------------------------------------</span></span>
<span id="cb1-451"><a href="#cb1-451"></a>df_nz_long<span class="sc">$</span>hours_community</span>
<span id="cb1-452"><a href="#cb1-452"></a></span>
<span id="cb1-453"><a href="#cb1-453"></a><span class="co"># prepare initial dataframe -----------------------------------------------</span></span>
<span id="cb1-454"><a href="#cb1-454"></a>dat_prep <span class="ot">&lt;-</span> df_nz_long <span class="sc">|&gt;</span></span>
<span id="cb1-455"><a href="#cb1-455"></a>  <span class="fu">arrange</span>(id, wave) <span class="sc">|&gt;</span></span>
<span id="cb1-456"><a href="#cb1-456"></a>  <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb1-457"><a href="#cb1-457"></a>  margot<span class="sc">::</span><span class="fu">remove_numeric_attributes</span>() <span class="sc">|&gt;</span></span>
<span id="cb1-458"><a href="#cb1-458"></a>  <span class="fu">mutate</span>(<span class="at">sample_weights =</span> sample_weights) <span class="sc">|&gt;</span> </span>
<span id="cb1-459"><a href="#cb1-459"></a>  <span class="fu">mutate</span>(<span class="at">religion_church =</span> <span class="fu">round</span>( <span class="fu">ifelse</span>(religion_church <span class="sc">&gt;</span> <span class="dv">8</span>, <span class="dv">8</span>, religion_church)),<span class="dv">1</span>) <span class="sc">|&gt;</span>  <span class="co"># to simplify</span></span>
<span id="cb1-460"><a href="#cb1-460"></a>  <span class="fu">arrange</span>(id, wave) <span class="sc">|&gt;</span></span>
<span id="cb1-461"><a href="#cb1-461"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb1-462"><a href="#cb1-462"></a></span>
<span id="cb1-463"><a href="#cb1-463"></a><span class="co"># define variable names using paste0 # *-- needed in this study --*</span></span>
<span id="cb1-464"><a href="#cb1-464"></a><span class="co"># name_exposure_cat &lt;- paste0(name_exposure, "_cat")</span></span>
<span id="cb1-465"><a href="#cb1-465"></a><span class="co"># name_exposure_binary &lt;- paste0(name_exposure, "_binary")</span></span>
<span id="cb1-466"><a href="#cb1-466"></a></span>
<span id="cb1-467"><a href="#cb1-467"></a><span class="co"># define wide variable names</span></span>
<span id="cb1-468"><a href="#cb1-468"></a>t0_name_exposure <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t0_"</span>, name_exposure)</span>
<span id="cb1-469"><a href="#cb1-469"></a>t1_name_exposure <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t1_"</span>, name_exposure)</span>
<span id="cb1-470"><a href="#cb1-470"></a><span class="fu">here_save</span>(t0_name_exposure , <span class="st">'t0_name_exposure'</span>)</span>
<span id="cb1-471"><a href="#cb1-471"></a></span>
<span id="cb1-472"><a href="#cb1-472"></a><span class="co"># eligibility  ------------------------------------------------------------</span></span>
<span id="cb1-473"><a href="#cb1-473"></a><span class="co"># select baseline and exposure ids based on eligibility criteria </span></span>
<span id="cb1-474"><a href="#cb1-474"></a>ids_baseline <span class="ot">&lt;-</span> dat_prep <span class="sc">|&gt;</span></span>
<span id="cb1-475"><a href="#cb1-475"></a>  <span class="fu">filter</span>(year_measured <span class="sc">==</span> <span class="dv">1</span>, wave <span class="sc">==</span> baseline_wave) <span class="sc">|&gt;</span> </span>
<span id="cb1-476"><a href="#cb1-476"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_exposure))) <span class="sc">|&gt;</span> <span class="co"># exposure observed at baseline</span></span>
<span id="cb1-477"><a href="#cb1-477"></a>  <span class="fu">pull</span>(id)</span>
<span id="cb1-478"><a href="#cb1-478"></a></span>
<span id="cb1-479"><a href="#cb1-479"></a><span class="co"># get number of participants at baseline</span></span>
<span id="cb1-480"><a href="#cb1-480"></a>n_participants <span class="ot">&lt;-</span> <span class="fu">length</span>(ids_baseline)</span>
<span id="cb1-481"><a href="#cb1-481"></a>n_participants <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">pretty_number</span>(n_participants)</span>
<span id="cb1-482"><a href="#cb1-482"></a></span>
<span id="cb1-483"><a href="#cb1-483"></a><span class="co"># check number of participants</span></span>
<span id="cb1-484"><a href="#cb1-484"></a>n_participants</span>
<span id="cb1-485"><a href="#cb1-485"></a></span>
<span id="cb1-486"><a href="#cb1-486"></a><span class="co"># save number of participants</span></span>
<span id="cb1-487"><a href="#cb1-487"></a><span class="fu">here_save</span>(n_participants, <span class="st">"n_participants"</span>)</span>
<span id="cb1-488"><a href="#cb1-488"></a></span>
<span id="cb1-489"><a href="#cb1-489"></a><span class="co"># select ids for baseline cohort ------------------------------------------</span></span>
<span id="cb1-490"><a href="#cb1-490"></a><span class="co"># eligibility: participated in baseline wave, no missingness in the exposure</span></span>
<span id="cb1-491"><a href="#cb1-491"></a><span class="co"># may have been lost to follow up</span></span>
<span id="cb1-492"><a href="#cb1-492"></a>dat_long_1 <span class="ot">&lt;-</span> dat_prep <span class="sc">|&gt;</span></span>
<span id="cb1-493"><a href="#cb1-493"></a>  <span class="fu">filter</span>(id <span class="sc">%in%</span> ids_baseline <span class="sc">&amp;</span> wave <span class="sc">%in%</span> <span class="fu">c</span>(baseline_wave, exposure_waves, outcome_wave)) <span class="sc">|&gt;</span> </span>
<span id="cb1-494"><a href="#cb1-494"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb1-495"><a href="#cb1-495"></a></span>
<span id="cb1-496"><a href="#cb1-496"></a><span class="co"># check wave structure</span></span>
<span id="cb1-497"><a href="#cb1-497"></a><span class="fu">str</span>(dat_long_1<span class="sc">$</span>wave)</span>
<span id="cb1-498"><a href="#cb1-498"></a></span>
<span id="cb1-499"><a href="#cb1-499"></a><span class="co"># aside -------------------------------------------------------------------</span></span>
<span id="cb1-500"><a href="#cb1-500"></a><span class="co"># example of censoring with more conditions</span></span>
<span id="cb1-501"><a href="#cb1-501"></a></span>
<span id="cb1-502"><a href="#cb1-502"></a><span class="co"># censor exposure if lost</span></span>
<span id="cb1-503"><a href="#cb1-503"></a><span class="co"># ids_baseline_2 &lt;- dat_long_censored_0 |&gt;</span></span>
<span id="cb1-504"><a href="#cb1-504"></a><span class="co">#   filter(year_measured == 1, wave == baseline_wave, employed == 1, hours_work &gt;= 20) |&gt;</span></span>
<span id="cb1-505"><a href="#cb1-505"></a><span class="co">#   pull(id)</span></span>
<span id="cb1-506"><a href="#cb1-506"></a><span class="co"># </span></span>
<span id="cb1-507"><a href="#cb1-507"></a><span class="co"># dat_long_censored &lt;- dat_long_censored_0 |&gt;</span></span>
<span id="cb1-508"><a href="#cb1-508"></a><span class="co">#   filter(id %in% ids_baseline_2 &amp; wave %in% c(baseline_wave, exposure_waves, outcome_wave)) |&gt; </span></span>
<span id="cb1-509"><a href="#cb1-509"></a><span class="co">#   droplevels()</span></span>
<span id="cb1-510"><a href="#cb1-510"></a></span>
<span id="cb1-511"><a href="#cb1-511"></a><span class="co"># check for specific conditions in a subset</span></span>
<span id="cb1-512"><a href="#cb1-512"></a><span class="co"># subset_vals &lt;- dat_long_censored$year_measured[</span></span>
<span id="cb1-513"><a href="#cb1-513"></a><span class="co">#   dat_long_censored$wave == 2021 &amp; dat_long_censored$employed == 0</span></span>
<span id="cb1-514"><a href="#cb1-514"></a><span class="co"># ]</span></span>
<span id="cb1-515"><a href="#cb1-515"></a></span>
<span id="cb1-516"><a href="#cb1-516"></a><span class="co"># check if all year_measured are zero in this subset</span></span>
<span id="cb1-517"><a href="#cb1-517"></a><span class="co"># all_zero &lt;- all(subset_vals == 0, na.rm = TRUE)</span></span>
<span id="cb1-518"><a href="#cb1-518"></a></span>
<span id="cb1-519"><a href="#cb1-519"></a><span class="co"># view result</span></span>
<span id="cb1-520"><a href="#cb1-520"></a><span class="co"># all_zero</span></span>
<span id="cb1-521"><a href="#cb1-521"></a></span>
<span id="cb1-522"><a href="#cb1-522"></a><span class="co"># data with eligibility criteria</span></span>
<span id="cb1-523"><a href="#cb1-523"></a><span class="co"># dat_long_1 &lt;- dat_long_censored</span></span>
<span id="cb1-524"><a href="#cb1-524"></a></span>
<span id="cb1-525"><a href="#cb1-525"></a></span>
<span id="cb1-526"><a href="#cb1-526"></a><span class="co"># aside over --------------------------------------------------------------</span></span>
<span id="cb1-527"><a href="#cb1-527"></a></span>
<span id="cb1-528"><a href="#cb1-528"></a><span class="co"># evaluate exposure variable(s)</span></span>
<span id="cb1-529"><a href="#cb1-529"></a>dat_long_exposure <span class="ot">&lt;-</span> dat_long_1 <span class="sc">|&gt;</span></span>
<span id="cb1-530"><a href="#cb1-530"></a>  <span class="fu">filter</span>(wave <span class="sc">==</span> exposure_waves) <span class="sc">|&gt;</span></span>
<span id="cb1-531"><a href="#cb1-531"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb1-532"><a href="#cb1-532"></a></span>
<span id="cb1-533"><a href="#cb1-533"></a><span class="co"># check wave counts</span></span>
<span id="cb1-534"><a href="#cb1-534"></a><span class="fu">table</span>(dat_long_exposure<span class="sc">$</span>wave)</span>
<span id="cb1-535"><a href="#cb1-535"></a></span>
<span id="cb1-536"><a href="#cb1-536"></a><span class="co"># check missingness in religion_church</span></span>
<span id="cb1-537"><a href="#cb1-537"></a><span class="fu">table</span>(<span class="fu">is.na</span>(dat_long_exposure[[exposure_var]]))</span>
<span id="cb1-538"><a href="#cb1-538"></a></span>
<span id="cb1-539"><a href="#cb1-539"></a><span class="co"># check exposure variable name</span></span>
<span id="cb1-540"><a href="#cb1-540"></a>name_exposure</span>
<span id="cb1-541"><a href="#cb1-541"></a></span>
<span id="cb1-542"><a href="#cb1-542"></a><span class="co"># check missingness in exposure</span></span>
<span id="cb1-543"><a href="#cb1-543"></a><span class="co"># naniar::gg_miss_var(dat_long_exposure)</span></span>
<span id="cb1-544"><a href="#cb1-544"></a></span>
<span id="cb1-545"><a href="#cb1-545"></a><span class="co"># check quantile breaks for exposure</span></span>
<span id="cb1-546"><a href="#cb1-546"></a><span class="fu">quantile</span>(dat_long_exposure[[name_exposure]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">probs =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, .<span class="dv">25</span>))</span>
<span id="cb1-547"><a href="#cb1-547"></a><span class="fu">mean</span>(dat_long_exposure[[name_exposure]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-548"><a href="#cb1-548"></a><span class="fu">median</span>(dat_long_exposure[[name_exposure]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-549"><a href="#cb1-549"></a><span class="fu">max</span>(dat_long_exposure[[name_exposure]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-550"><a href="#cb1-550"></a><span class="fu">sd</span>(dat_long_exposure[[name_exposure]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-551"><a href="#cb1-551"></a></span>
<span id="cb1-552"><a href="#cb1-552"></a><span class="co"># count above and below break at one</span></span>
<span id="cb1-553"><a href="#cb1-553"></a><span class="fu">sum</span>(dat_long_exposure[[name_exposure]] <span class="sc">&gt;=</span> <span class="dv">1</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-554"><a href="#cb1-554"></a><span class="fu">sum</span>(dat_long_exposure[[name_exposure]] <span class="sc">&lt;</span> <span class="dv">1</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-555"><a href="#cb1-555"></a></span>
<span id="cb1-556"><a href="#cb1-556"></a><span class="co"># binary graph ------------------------------------------------------------</span></span>
<span id="cb1-557"><a href="#cb1-557"></a><span class="co"># graph binary break at lower quartile (5)</span></span>
<span id="cb1-558"><a href="#cb1-558"></a>graph_exposure_binary <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_plot_categorical</span>(</span>
<span id="cb1-559"><a href="#cb1-559"></a>  dat_long_exposure,</span>
<span id="cb1-560"><a href="#cb1-560"></a>  <span class="at">col_name =</span> name_exposure,</span>
<span id="cb1-561"><a href="#cb1-561"></a>  <span class="at">cutpoint_inclusive =</span> <span class="st">"lower"</span>,</span>
<span id="cb1-562"><a href="#cb1-562"></a>  <span class="co"># n_divisions = 2,</span></span>
<span id="cb1-563"><a href="#cb1-563"></a>  <span class="at">custom_breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>),</span>
<span id="cb1-564"><a href="#cb1-564"></a>  <span class="at">binwidth =</span> .<span class="dv">5</span>)</span>
<span id="cb1-565"><a href="#cb1-565"></a></span>
<span id="cb1-566"><a href="#cb1-566"></a><span class="co"># view binary graph</span></span>
<span id="cb1-567"><a href="#cb1-567"></a><span class="fu">print</span>(graph_exposure_binary)</span>
<span id="cb1-568"><a href="#cb1-568"></a></span>
<span id="cb1-569"><a href="#cb1-569"></a><span class="co"># check graph size</span></span>
<span id="cb1-570"><a href="#cb1-570"></a><span class="fu">margot_size</span>(graph_exposure_binary)</span>
<span id="cb1-571"><a href="#cb1-571"></a></span>
<span id="cb1-572"><a href="#cb1-572"></a><span class="co"># save binary graph for manuscript</span></span>
<span id="cb1-573"><a href="#cb1-573"></a>margot<span class="sc">::</span><span class="fu">here_save_qs</span>(graph_exposure_binary, <span class="st">"graph_exposure_binary"</span>, push_mods)</span>
<span id="cb1-574"><a href="#cb1-574"></a></span>
<span id="cb1-575"><a href="#cb1-575"></a><span class="co"># resume wrangling --------------------------------------------------------</span></span>
<span id="cb1-576"><a href="#cb1-576"></a><span class="co"># create categorical variable (if desired)</span></span>
<span id="cb1-577"><a href="#cb1-577"></a><span class="co"># check exposure variable name</span></span>
<span id="cb1-578"><a href="#cb1-578"></a>name_exposure</span>
<span id="cb1-579"><a href="#cb1-579"></a></span>
<span id="cb1-580"><a href="#cb1-580"></a>dat_long_2 <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">create_ordered_variable</span>(</span>
<span id="cb1-581"><a href="#cb1-581"></a>  dat_long_1,</span>
<span id="cb1-582"><a href="#cb1-582"></a>  <span class="at">var_name =</span> name_exposure,</span>
<span id="cb1-583"><a href="#cb1-583"></a>  <span class="at">cutpoint_inclusive =</span> <span class="st">"lower"</span>,</span>
<span id="cb1-584"><a href="#cb1-584"></a>  <span class="at">custom_breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb1-585"><a href="#cb1-585"></a>)</span>
<span id="cb1-586"><a href="#cb1-586"></a></span>
<span id="cb1-587"><a href="#cb1-587"></a><span class="co"># check binary exposure variable name</span></span>
<span id="cb1-588"><a href="#cb1-588"></a>name_exposure_binary</span>
<span id="cb1-589"><a href="#cb1-589"></a></span>
<span id="cb1-590"><a href="#cb1-590"></a><span class="co"># check missingness in binary exposure variable</span></span>
<span id="cb1-591"><a href="#cb1-591"></a><span class="fu">table</span>(<span class="fu">is.na</span>(dat_long_2[[name_exposure_binary]]))</span>
<span id="cb1-592"><a href="#cb1-592"></a></span>
<span id="cb1-593"><a href="#cb1-593"></a><span class="co"># convert binary factors to 0, 1</span></span>
<span id="cb1-594"><a href="#cb1-594"></a><span class="co"># use custom function</span></span>
<span id="cb1-595"><a href="#cb1-595"></a>dat_long_3 <span class="ot">&lt;-</span> <span class="fu">margot_process_binary_vars</span>(dat_long_2)</span>
<span id="cb1-596"><a href="#cb1-596"></a></span>
<span id="cb1-597"><a href="#cb1-597"></a><span class="co"># make 'not lost' variable ------------------------------------------------</span></span>
<span id="cb1-598"><a href="#cb1-598"></a><span class="co"># used for attrition handling</span></span>
<span id="cb1-599"><a href="#cb1-599"></a>dat_long_4 <span class="ot">&lt;-</span> dat_long_3 <span class="sc">|&gt;</span></span>
<span id="cb1-600"><a href="#cb1-600"></a>  <span class="fu">arrange</span>(id, wave) <span class="sc">|&gt;</span></span>
<span id="cb1-601"><a href="#cb1-601"></a>  <span class="fu">mutate</span>(</span>
<span id="cb1-602"><a href="#cb1-602"></a>    <span class="at">not_lost =</span> <span class="fu">ifelse</span>(<span class="fu">lead</span>(year_measured) <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb1-603"><a href="#cb1-603"></a>    <span class="at">not_lost =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(not_lost) <span class="sc">&amp;</span> year_measured <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, not_lost),</span>
<span id="cb1-604"><a href="#cb1-604"></a>    <span class="at">not_lost =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(not_lost), <span class="dv">0</span>, not_lost)</span>
<span id="cb1-605"><a href="#cb1-605"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb1-606"><a href="#cb1-606"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb1-607"><a href="#cb1-607"></a></span>
<span id="cb1-608"><a href="#cb1-608"></a><span class="co"># log-transform 'hours_' variables ----------------------------------------</span></span>
<span id="cb1-609"><a href="#cb1-609"></a>dat_long_table <span class="ot">&lt;-</span> <span class="fu">margot_log_transform_vars</span>(</span>
<span id="cb1-610"><a href="#cb1-610"></a>  dat_long_4,</span>
<span id="cb1-611"><a href="#cb1-611"></a>  <span class="at">vars =</span> <span class="fu">c</span>(<span class="fu">starts_with</span>(<span class="st">"hours_"</span>), <span class="st">"household_inc"</span>),</span>
<span id="cb1-612"><a href="#cb1-612"></a>  <span class="at">exceptions =</span> name_exposure,</span>
<span id="cb1-613"><a href="#cb1-613"></a>  <span class="at">prefix =</span> <span class="st">"log_"</span>,</span>
<span id="cb1-614"><a href="#cb1-614"></a>  <span class="at">keep_original =</span> <span class="cn">TRUE</span> <span class="co"># set to TRUE for tables</span></span>
<span id="cb1-615"><a href="#cb1-615"></a>) <span class="sc">|&gt;</span></span>
<span id="cb1-616"><a href="#cb1-616"></a>  <span class="fu">select</span>(<span class="fu">all_of</span>(not_all_vars)) <span class="sc">|&gt;</span></span>
<span id="cb1-617"><a href="#cb1-617"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb1-618"><a href="#cb1-618"></a></span>
<span id="cb1-619"><a href="#cb1-619"></a><span class="co"># make wave a factor</span></span>
<span id="cb1-620"><a href="#cb1-620"></a>dat_long_table<span class="sc">$</span>wave <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(dat_long_table<span class="sc">$</span>wave)</span>
<span id="cb1-621"><a href="#cb1-621"></a></span>
<span id="cb1-622"><a href="#cb1-622"></a></span>
<span id="cb1-623"><a href="#cb1-623"></a></span>
<span id="cb1-624"><a href="#cb1-624"></a><span class="co"># summary tables ----------------------------------------------------------</span></span>
<span id="cb1-625"><a href="#cb1-625"></a><span class="co"># useful function that creates summary tables in one place</span></span>
<span id="cb1-626"><a href="#cb1-626"></a>summary_tables  <span class="ot">&lt;-</span> <span class="fu">margot_summary_tables</span>(</span>
<span id="cb1-627"><a href="#cb1-627"></a>  <span class="at">data =</span> dat_long_table,</span>
<span id="cb1-628"><a href="#cb1-628"></a>  <span class="at">baseline_wave =</span> baseline_wave,</span>
<span id="cb1-629"><a href="#cb1-629"></a>  <span class="at">exposure_waves =</span> exposure_waves,</span>
<span id="cb1-630"><a href="#cb1-630"></a>  <span class="at">outcome_wave =</span> outcome_wave,</span>
<span id="cb1-631"><a href="#cb1-631"></a>  <span class="at">name_exposure =</span> name_exposure,</span>
<span id="cb1-632"><a href="#cb1-632"></a>  <span class="at">baseline_vars =</span> baseline_vars_no_log,</span>
<span id="cb1-633"><a href="#cb1-633"></a>  <span class="at">outcome_vars =</span> outcome_vars,</span>
<span id="cb1-634"><a href="#cb1-634"></a>  <span class="at">extra_vars =</span> extra_vars</span>
<span id="cb1-635"><a href="#cb1-635"></a>)</span>
<span id="cb1-636"><a href="#cb1-636"></a></span>
<span id="cb1-637"><a href="#cb1-637"></a><span class="co"># show details</span></span>
<span id="cb1-638"><a href="#cb1-638"></a>summary_tables<span class="sc">$</span>baseline_table</span>
<span id="cb1-639"><a href="#cb1-639"></a>summary_tables<span class="sc">$</span>exposure_table</span>
<span id="cb1-640"><a href="#cb1-640"></a>summary_tables<span class="sc">$</span>outcome_table</span>
<span id="cb1-641"><a href="#cb1-641"></a>summary_tables<span class="sc">$</span>n_participants</span>
<span id="cb1-642"><a href="#cb1-642"></a></span>
<span id="cb1-643"><a href="#cb1-643"></a></span>
<span id="cb1-644"><a href="#cb1-644"></a><span class="co"># newer tables (for manuscript) -------------------------------------------</span></span>
<span id="cb1-645"><a href="#cb1-645"></a><span class="co"># sort</span></span>
<span id="cb1-646"><a href="#cb1-646"></a>var_labels_health <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1-647"><a href="#cb1-647"></a>  <span class="st">"alcohol_frequency"</span> <span class="ot">=</span> <span class="st">"Alcohol Frequency"</span>,</span>
<span id="cb1-648"><a href="#cb1-648"></a>  <span class="st">"alcohol_intensity"</span> <span class="ot">=</span> <span class="st">"Alcohol Intensity"</span>,</span>
<span id="cb1-649"><a href="#cb1-649"></a>  <span class="st">"hlth_bmi"</span> <span class="ot">=</span> <span class="st">"Body Mass Index"</span>, </span>
<span id="cb1-650"><a href="#cb1-650"></a>  <span class="st">"hlth_sleep_hours"</span> <span class="ot">=</span> <span class="st">"Sleep"</span>, </span>
<span id="cb1-651"><a href="#cb1-651"></a>  <span class="st">"hours_exercise"</span> <span class="ot">=</span> <span class="st">"Hours of Exercise"</span>,   <span class="co"># logged in models</span></span>
<span id="cb1-652"><a href="#cb1-652"></a>  <span class="st">"short_form_health"</span> <span class="ot">=</span> <span class="st">"Short Form Health"</span> </span>
<span id="cb1-653"><a href="#cb1-653"></a>)</span>
<span id="cb1-654"><a href="#cb1-654"></a></span>
<span id="cb1-655"><a href="#cb1-655"></a><span class="co"># define psych outcomes </span></span>
<span id="cb1-656"><a href="#cb1-656"></a>var_labels_psych <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1-657"><a href="#cb1-657"></a>  <span class="st">"hlth_fatigue"</span> <span class="ot">=</span> <span class="st">"Fatigue"</span>, </span>
<span id="cb1-658"><a href="#cb1-658"></a>  <span class="st">"kessler_latent_anxiety"</span> <span class="ot">=</span> <span class="st">"Anxiety"</span>, </span>
<span id="cb1-659"><a href="#cb1-659"></a>  <span class="st">"kessler_latent_depression"</span> <span class="ot">=</span> <span class="st">"Depression"</span>,  </span>
<span id="cb1-660"><a href="#cb1-660"></a>  <span class="st">"rumination"</span> <span class="ot">=</span> <span class="st">"Rumination"</span></span>
<span id="cb1-661"><a href="#cb1-661"></a>)</span>
<span id="cb1-662"><a href="#cb1-662"></a></span>
<span id="cb1-663"><a href="#cb1-663"></a><span class="co"># define present outcomes</span></span>
<span id="cb1-664"><a href="#cb1-664"></a>var_labels_present <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1-665"><a href="#cb1-665"></a>  <span class="st">"bodysat"</span> <span class="ot">=</span> <span class="st">"Body Satisfaction"</span>,</span>
<span id="cb1-666"><a href="#cb1-666"></a>  <span class="st">"foregiveness"</span> <span class="ot">=</span> <span class="st">"Forgiveness"</span>,</span>
<span id="cb1-667"><a href="#cb1-667"></a>  <span class="st">"perfectionism"</span> <span class="ot">=</span> <span class="st">"Perfectionism"</span>,</span>
<span id="cb1-668"><a href="#cb1-668"></a>  <span class="st">"self_control"</span> <span class="ot">=</span> <span class="st">"Self Control"</span>,</span>
<span id="cb1-669"><a href="#cb1-669"></a>  <span class="st">"self_esteem"</span> <span class="ot">=</span> <span class="st">"Self Esteem"</span>,</span>
<span id="cb1-670"><a href="#cb1-670"></a>  <span class="st">"sexual_satisfaction"</span> <span class="ot">=</span> <span class="st">"Sexual Satisfaction"</span></span>
<span id="cb1-671"><a href="#cb1-671"></a>)</span>
<span id="cb1-672"><a href="#cb1-672"></a></span>
<span id="cb1-673"><a href="#cb1-673"></a><span class="co"># define life outcomes</span></span>
<span id="cb1-674"><a href="#cb1-674"></a>var_labels_life <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1-675"><a href="#cb1-675"></a>  <span class="st">"gratitude"</span> <span class="ot">=</span> <span class="st">"Gratitude"</span>, </span>
<span id="cb1-676"><a href="#cb1-676"></a>  <span class="st">"lifesat"</span> <span class="ot">=</span> <span class="st">"Life Satisfaction"</span>, </span>
<span id="cb1-677"><a href="#cb1-677"></a>  <span class="st">"meaning_purpose"</span> <span class="ot">=</span> <span class="st">"Meaning: Purpose"</span>, <span class="co"># exposure variable</span></span>
<span id="cb1-678"><a href="#cb1-678"></a>  <span class="st">"meaning_sense"</span> <span class="ot">=</span> <span class="st">"Meaning: Sense"</span>,</span>
<span id="cb1-679"><a href="#cb1-679"></a>  <span class="st">"pwi"</span> <span class="ot">=</span> <span class="st">"Personal Well-being Index"</span></span>
<span id="cb1-680"><a href="#cb1-680"></a>)</span>
<span id="cb1-681"><a href="#cb1-681"></a></span>
<span id="cb1-682"><a href="#cb1-682"></a><span class="co"># define social outcome names</span></span>
<span id="cb1-683"><a href="#cb1-683"></a>var_labels_social <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1-684"><a href="#cb1-684"></a>  <span class="st">"belong"</span> <span class="ot">=</span> <span class="st">"Belonging"</span>,</span>
<span id="cb1-685"><a href="#cb1-685"></a>  <span class="st">"neighbourhood_community"</span> <span class="ot">=</span> <span class="st">"Neighbourhood Belonging"</span>, </span>
<span id="cb1-686"><a href="#cb1-686"></a>  <span class="st">"support"</span> <span class="ot">=</span> <span class="st">"Support"</span> </span>
<span id="cb1-687"><a href="#cb1-687"></a>)</span>
<span id="cb1-688"><a href="#cb1-688"></a></span>
<span id="cb1-689"><a href="#cb1-689"></a><span class="co"># make labels</span></span>
<span id="cb1-690"><a href="#cb1-690"></a>var_labels_baseline <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1-691"><a href="#cb1-691"></a>  <span class="st">"sdo"</span> <span class="ot">=</span> <span class="st">"Social Dominance Orientation"</span>,</span>
<span id="cb1-692"><a href="#cb1-692"></a>  <span class="st">"belong"</span> <span class="ot">=</span> <span class="st">"Social Belonging"</span>,</span>
<span id="cb1-693"><a href="#cb1-693"></a>  <span class="st">"born_nz_binary"</span> <span class="ot">=</span> <span class="st">"Born in New Zealand (binary)"</span>,</span>
<span id="cb1-694"><a href="#cb1-694"></a>  <span class="st">"rural_gch_2018_l"</span> <span class="ot">=</span> <span class="st">"Rural Gch 2018 Levels"</span>,</span>
<span id="cb1-695"><a href="#cb1-695"></a>  <span class="st">"education_level_coarsen"</span> <span class="ot">=</span> <span class="st">"Education Level"</span>,</span>
<span id="cb1-696"><a href="#cb1-696"></a>  <span class="st">"employed_binary"</span> <span class="ot">=</span> <span class="st">"Employed (binary)"</span>,</span>
<span id="cb1-697"><a href="#cb1-697"></a>  <span class="st">"eth_cat"</span> <span class="ot">=</span> <span class="st">"Ethnicity"</span>,</span>
<span id="cb1-698"><a href="#cb1-698"></a>  <span class="st">"household_inc"</span> <span class="ot">=</span> <span class="st">"Household Income"</span>,</span>
<span id="cb1-699"><a href="#cb1-699"></a>  <span class="st">"log_household_inc"</span> <span class="ot">=</span> <span class="st">"Log Household Income"</span>,</span>
<span id="cb1-700"><a href="#cb1-700"></a>  <span class="st">"male_binary"</span> <span class="ot">=</span> <span class="st">"Male (binary)"</span>,</span>
<span id="cb1-701"><a href="#cb1-701"></a>  <span class="st">"nz_dep2018"</span> <span class="ot">=</span> <span class="st">"NZ Deprevation Index 2018"</span>,</span>
<span id="cb1-702"><a href="#cb1-702"></a>  <span class="st">"nzsei_13_l"</span> <span class="ot">=</span> <span class="st">"NZSEI (Occupational Prestige Index)"</span>,</span>
<span id="cb1-703"><a href="#cb1-703"></a>  <span class="st">"parent_binary"</span> <span class="ot">=</span> <span class="st">"Parent (binary)"</span>,</span>
<span id="cb1-704"><a href="#cb1-704"></a>  <span class="st">"rwa"</span> <span class="ot">=</span> <span class="st">"Right Wing Authoritarianism"</span>,</span>
<span id="cb1-705"><a href="#cb1-705"></a>  <span class="st">"sample_frame_opt_in_binary"</span> <span class="ot">=</span> <span class="st">"Sample Frame Opt-In (binary)"</span>,</span>
<span id="cb1-706"><a href="#cb1-706"></a>  <span class="st">"sdo"</span> <span class="ot">=</span> <span class="st">"Social Dominance Orientation"</span>,</span>
<span id="cb1-707"><a href="#cb1-707"></a>  <span class="st">"smoker_binary"</span> <span class="ot">=</span> <span class="st">"Smoker (binary)"</span>,</span>
<span id="cb1-708"><a href="#cb1-708"></a>  <span class="st">"support"</span> <span class="ot">=</span> <span class="st">"Social Support (perceived)"</span>,</span>
<span id="cb1-709"><a href="#cb1-709"></a>  <span class="st">"hours_community"</span> <span class="ot">=</span> <span class="st">"Hours Community Socialising"</span></span>
<span id="cb1-710"><a href="#cb1-710"></a>)</span>
<span id="cb1-711"><a href="#cb1-711"></a></span>
<span id="cb1-712"><a href="#cb1-712"></a><span class="co"># labels for factors</span></span>
<span id="cb1-713"><a href="#cb1-713"></a>rural_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-714"><a href="#cb1-714"></a>  <span class="st">"High Urban Accessibility"</span>,</span>
<span id="cb1-715"><a href="#cb1-715"></a>  <span class="st">"Medium Urban Accessibility"</span>,</span>
<span id="cb1-716"><a href="#cb1-716"></a>  <span class="st">"Low Urban Accessibility"</span>,</span>
<span id="cb1-717"><a href="#cb1-717"></a>  <span class="st">"Remote"</span>,</span>
<span id="cb1-718"><a href="#cb1-718"></a>  <span class="st">"Very Remote"</span></span>
<span id="cb1-719"><a href="#cb1-719"></a>)</span>
<span id="cb1-720"><a href="#cb1-720"></a></span>
<span id="cb1-721"><a href="#cb1-721"></a><span class="co"># save labels -------------------------------------------------------------</span></span>
<span id="cb1-722"><a href="#cb1-722"></a><span class="fu">here_save</span>(var_labels_baseline, <span class="st">"var_labels_baseline"</span>)</span>
<span id="cb1-723"><a href="#cb1-723"></a><span class="fu">here_save</span>(var_labels_health, <span class="st">"var_labels_health"</span>)</span>
<span id="cb1-724"><a href="#cb1-724"></a><span class="fu">here_save</span>(var_labels_psych, <span class="st">"var_labels_psych"</span>)</span>
<span id="cb1-725"><a href="#cb1-725"></a><span class="fu">here_save</span>(var_labels_present, <span class="st">"var_labels_present"</span>)</span>
<span id="cb1-726"><a href="#cb1-726"></a><span class="fu">here_save</span>(var_labels_life, <span class="st">"var_labels_life"</span>)</span>
<span id="cb1-727"><a href="#cb1-727"></a><span class="fu">here_save</span>(var_labels_social, <span class="st">"var_labels_social"</span>)</span>
<span id="cb1-728"><a href="#cb1-728"></a></span>
<span id="cb1-729"><a href="#cb1-729"></a></span>
<span id="cb1-730"><a href="#cb1-730"></a><span class="co"># combine all variable labels</span></span>
<span id="cb1-731"><a href="#cb1-731"></a>var_labels_measures <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-732"><a href="#cb1-732"></a>  var_labels_baseline,</span>
<span id="cb1-733"><a href="#cb1-733"></a>  var_labels_health,</span>
<span id="cb1-734"><a href="#cb1-734"></a>  var_labels_psych,</span>
<span id="cb1-735"><a href="#cb1-735"></a>  var_labels_present,</span>
<span id="cb1-736"><a href="#cb1-736"></a>  var_labels_life,</span>
<span id="cb1-737"><a href="#cb1-737"></a>  var_labels_social</span>
<span id="cb1-738"><a href="#cb1-738"></a>)</span>
<span id="cb1-739"><a href="#cb1-739"></a></span>
<span id="cb1-740"><a href="#cb1-740"></a><span class="co"># save</span></span>
<span id="cb1-741"><a href="#cb1-741"></a><span class="fu">here_save</span>(var_labels_measures, <span class="st">"var_labels_measures"</span>)</span>
<span id="cb1-742"><a href="#cb1-742"></a></span>
<span id="cb1-743"><a href="#cb1-743"></a><span class="co"># new df for table</span></span>
<span id="cb1-744"><a href="#cb1-744"></a>dat_long_table_x <span class="ot">&lt;-</span> dat_long_table</span>
<span id="cb1-745"><a href="#cb1-745"></a>dat_long_table_x<span class="sc">$</span>rural_gch_2018_l <span class="ot">&lt;-</span> <span class="fu">factor</span>(</span>
<span id="cb1-746"><a href="#cb1-746"></a>  dat_long_table_x<span class="sc">$</span>rural_gch_2018_l,</span>
<span id="cb1-747"><a href="#cb1-747"></a>  <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,</span>
<span id="cb1-748"><a href="#cb1-748"></a>  <span class="at">labels =</span> rural_labels,</span>
<span id="cb1-749"><a href="#cb1-749"></a>  <span class="at">ordered =</span> <span class="cn">TRUE</span>  <span class="co"># optional: if the levels have an inherent order</span></span>
<span id="cb1-750"><a href="#cb1-750"></a>)</span>
<span id="cb1-751"><a href="#cb1-751"></a></span>
<span id="cb1-752"><a href="#cb1-752"></a><span class="co"># nicer for church attendance -- if you use it</span></span>
<span id="cb1-753"><a href="#cb1-753"></a><span class="co"># dat_long_table_x$religion_church &lt;- factor(</span></span>
<span id="cb1-754"><a href="#cb1-754"></a><span class="co">#   dat_long_table_x$religion_church,</span></span>
<span id="cb1-755"><a href="#cb1-755"></a><span class="co">#   levels = 0:8,</span></span>
<span id="cb1-756"><a href="#cb1-756"></a><span class="co">#   ordered = TRUE  </span></span>
<span id="cb1-757"><a href="#cb1-757"></a><span class="co"># )</span></span>
<span id="cb1-758"><a href="#cb1-758"></a></span>
<span id="cb1-759"><a href="#cb1-759"></a><span class="co"># create dataframes for each wave</span></span>
<span id="cb1-760"><a href="#cb1-760"></a>dat_long_table_baseline <span class="ot">&lt;-</span> dat_long_table_x <span class="sc">|&gt;</span> </span>
<span id="cb1-761"><a href="#cb1-761"></a>  <span class="fu">filter</span>(wave <span class="sc">%in%</span> <span class="fu">c</span>(baseline_wave, exposure_waves, outcome_wave))</span>
<span id="cb1-762"><a href="#cb1-762"></a></span>
<span id="cb1-763"><a href="#cb1-763"></a><span class="co"># create dataframes for each wave</span></span>
<span id="cb1-764"><a href="#cb1-764"></a>dat_long_table_exposure_waves <span class="ot">&lt;-</span> dat_long_table_x <span class="sc">|&gt;</span> </span>
<span id="cb1-765"><a href="#cb1-765"></a>  <span class="fu">filter</span>(wave <span class="sc">%in%</span> <span class="fu">c</span>(baseline_wave, exposure_waves))</span>
<span id="cb1-766"><a href="#cb1-766"></a></span>
<span id="cb1-767"><a href="#cb1-767"></a><span class="co"># create dataframes for each wave</span></span>
<span id="cb1-768"><a href="#cb1-768"></a>dat_long_table_outcome_waves <span class="ot">&lt;-</span> dat_long_table_x <span class="sc">|&gt;</span> </span>
<span id="cb1-769"><a href="#cb1-769"></a>  <span class="fu">filter</span>(wave <span class="sc">%in%</span> <span class="fu">c</span>(baseline_wave, outcome_wave))</span>
<span id="cb1-770"><a href="#cb1-770"></a></span>
<span id="cb1-771"><a href="#cb1-771"></a><span class="co"># make tables</span></span>
<span id="cb1-772"><a href="#cb1-772"></a>markdown_table_baseline <span class="ot">&lt;-</span> <span class="fu">margot_make_tables</span>(</span>
<span id="cb1-773"><a href="#cb1-773"></a>  <span class="at">data =</span> dat_long_table_baseline,</span>
<span id="cb1-774"><a href="#cb1-774"></a>  <span class="at">vars =</span> baseline_vars_no_log,</span>
<span id="cb1-775"><a href="#cb1-775"></a>  <span class="at">by =</span> <span class="st">"wave"</span>,</span>
<span id="cb1-776"><a href="#cb1-776"></a>  <span class="at">labels =</span> var_labels_baseline,</span>
<span id="cb1-777"><a href="#cb1-777"></a>  <span class="at">factor_vars =</span> <span class="fu">c</span>(<span class="st">"rural_gch_2018_l"</span>, <span class="st">"eth_cat"</span>),</span>
<span id="cb1-778"><a href="#cb1-778"></a>  <span class="at">table1_opts =</span> <span class="fu">list</span>(<span class="at">overall =</span> <span class="cn">FALSE</span>, <span class="at">transpose =</span> <span class="cn">FALSE</span>),</span>
<span id="cb1-779"><a href="#cb1-779"></a>  <span class="at">format =</span> <span class="st">"markdown"</span></span>
<span id="cb1-780"><a href="#cb1-780"></a>)</span>
<span id="cb1-781"><a href="#cb1-781"></a></span>
<span id="cb1-782"><a href="#cb1-782"></a><span class="co"># view</span></span>
<span id="cb1-783"><a href="#cb1-783"></a>markdown_table_baseline</span>
<span id="cb1-784"><a href="#cb1-784"></a></span>
<span id="cb1-785"><a href="#cb1-785"></a><span class="co"># save</span></span>
<span id="cb1-786"><a href="#cb1-786"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(markdown_table_baseline, <span class="st">"markdown_table_baseline"</span>)</span>
<span id="cb1-787"><a href="#cb1-787"></a></span>
<span id="cb1-788"><a href="#cb1-788"></a><span class="co"># make exposure table</span></span>
<span id="cb1-789"><a href="#cb1-789"></a>markdown_table_exposures <span class="ot">&lt;-</span> <span class="fu">margot_make_tables</span>(</span>
<span id="cb1-790"><a href="#cb1-790"></a>  <span class="at">data =</span> dat_long_table_exposure_waves,</span>
<span id="cb1-791"><a href="#cb1-791"></a>  <span class="at">vars =</span> name_exposure,</span>
<span id="cb1-792"><a href="#cb1-792"></a>  <span class="at">by =</span> <span class="st">"wave"</span>,</span>
<span id="cb1-793"><a href="#cb1-793"></a>  <span class="at">labels =</span> var_labels_exposure,</span>
<span id="cb1-794"><a href="#cb1-794"></a>  <span class="at">table1_opts =</span> <span class="fu">list</span>(<span class="at">overall =</span> <span class="cn">FALSE</span>, <span class="at">transpose =</span> <span class="cn">FALSE</span>),</span>
<span id="cb1-795"><a href="#cb1-795"></a>  <span class="at">format =</span> <span class="st">"markdown"</span></span>
<span id="cb1-796"><a href="#cb1-796"></a>)</span>
<span id="cb1-797"><a href="#cb1-797"></a></span>
<span id="cb1-798"><a href="#cb1-798"></a><span class="co"># view</span></span>
<span id="cb1-799"><a href="#cb1-799"></a>markdown_table_exposures</span>
<span id="cb1-800"><a href="#cb1-800"></a></span>
<span id="cb1-801"><a href="#cb1-801"></a><span class="co"># save</span></span>
<span id="cb1-802"><a href="#cb1-802"></a><span class="fu">here_save</span>(markdown_table_exposures, <span class="st">"markdown_table_exposures"</span>)</span>
<span id="cb1-803"><a href="#cb1-803"></a></span>
<span id="cb1-804"><a href="#cb1-804"></a><span class="co"># names of outcome vars for health no logs</span></span>
<span id="cb1-805"><a href="#cb1-805"></a>raw_outcomes_health_no_log <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-806"><a href="#cb1-806"></a>  <span class="st">"alcohol_intensity"</span>,</span>
<span id="cb1-807"><a href="#cb1-807"></a>  <span class="st">"alcohol_frequency"</span>,</span>
<span id="cb1-808"><a href="#cb1-808"></a>  <span class="st">"hlth_bmi"</span>, </span>
<span id="cb1-809"><a href="#cb1-809"></a>  <span class="st">"hlth_sleep_hours"</span>, </span>
<span id="cb1-810"><a href="#cb1-810"></a>  <span class="st">"hours_exercise"</span>,</span>
<span id="cb1-811"><a href="#cb1-811"></a>  <span class="st">"short_form_health"</span></span>
<span id="cb1-812"><a href="#cb1-812"></a>)</span>
<span id="cb1-813"><a href="#cb1-813"></a></span>
<span id="cb1-814"><a href="#cb1-814"></a><span class="co"># make tables</span></span>
<span id="cb1-815"><a href="#cb1-815"></a><span class="co"># make tables</span></span>
<span id="cb1-816"><a href="#cb1-816"></a><span class="co"># latex_table_outcomes_all &lt;- margot_make_tables(</span></span>
<span id="cb1-817"><a href="#cb1-817"></a><span class="co">#   data = dat_long_table_outcome_waves,</span></span>
<span id="cb1-818"><a href="#cb1-818"></a><span class="co">#   vars = raw_outcomes_all,</span></span>
<span id="cb1-819"><a href="#cb1-819"></a><span class="co">#   by = "wave",</span></span>
<span id="cb1-820"><a href="#cb1-820"></a><span class="co">#   labels = var_labels_measures,</span></span>
<span id="cb1-821"><a href="#cb1-821"></a><span class="co">#   table1_opts = list(overall = FALSE, transpose = FALSE),</span></span>
<span id="cb1-822"><a href="#cb1-822"></a><span class="co">#   format = "latex",</span></span>
<span id="cb1-823"><a href="#cb1-823"></a><span class="co">#   kable_opts = list(</span></span>
<span id="cb1-824"><a href="#cb1-824"></a><span class="co">#     booktabs = TRUE,</span></span>
<span id="cb1-825"><a href="#cb1-825"></a><span class="co">#     longtable = TRUE,</span></span>
<span id="cb1-826"><a href="#cb1-826"></a><span class="co">#     font_size = 10,</span></span>
<span id="cb1-827"><a href="#cb1-827"></a><span class="co">#     latex_options = c("hold_position", "repeat_header", "striped", "longtable")</span></span>
<span id="cb1-828"><a href="#cb1-828"></a><span class="co">#   ),</span></span>
<span id="cb1-829"><a href="#cb1-829"></a><span class="co">#   quarto_label = "tbl-appendix-outcomes"  # This is the key addition!</span></span>
<span id="cb1-830"><a href="#cb1-830"></a><span class="co"># )</span></span>
<span id="cb1-831"><a href="#cb1-831"></a><span class="co"># </span></span>
<span id="cb1-832"><a href="#cb1-832"></a><span class="co"># cat(latex_table_outcomes_all)</span></span>
<span id="cb1-833"><a href="#cb1-833"></a><span class="co"># # view</span></span>
<span id="cb1-834"><a href="#cb1-834"></a><span class="co"># here_save(latex_table_outcomes_all, "latex_table_outcomes_all")</span></span>
<span id="cb1-835"><a href="#cb1-835"></a></span>
<span id="cb1-836"><a href="#cb1-836"></a>markdown_table_outcomes_all <span class="ot">&lt;-</span> <span class="fu">margot_make_tables</span>(</span>
<span id="cb1-837"><a href="#cb1-837"></a>  <span class="at">data =</span> dat_long_table_outcome_waves,</span>
<span id="cb1-838"><a href="#cb1-838"></a>  <span class="at">vars =</span> raw_outcomes_all,</span>
<span id="cb1-839"><a href="#cb1-839"></a>  <span class="at">by =</span> <span class="st">"wave"</span>,</span>
<span id="cb1-840"><a href="#cb1-840"></a>  <span class="at">labels =</span> var_labels_measures,</span>
<span id="cb1-841"><a href="#cb1-841"></a>  <span class="at">table1_opts =</span> <span class="fu">list</span>(<span class="at">overall =</span> <span class="cn">FALSE</span>, <span class="at">transpose =</span> <span class="cn">FALSE</span>),</span>
<span id="cb1-842"><a href="#cb1-842"></a>  <span class="at">format =</span> <span class="st">"markdown"</span>,</span>
<span id="cb1-843"><a href="#cb1-843"></a>  <span class="at">quarto_label =</span> <span class="st">"tbl-sample-outcomes"</span>  <span class="co"># This is the key addition!</span></span>
<span id="cb1-844"><a href="#cb1-844"></a>)</span>
<span id="cb1-845"><a href="#cb1-845"></a></span>
<span id="cb1-846"><a href="#cb1-846"></a><span class="co"># view</span></span>
<span id="cb1-847"><a href="#cb1-847"></a>markdown_table_outcomes_all</span>
<span id="cb1-848"><a href="#cb1-848"></a></span>
<span id="cb1-849"><a href="#cb1-849"></a><span class="co"># save</span></span>
<span id="cb1-850"><a href="#cb1-850"></a><span class="fu">here_save</span>(markdown_table_outcomes_all, <span class="st">"markdown_table_outcomes_all"</span>)</span>
<span id="cb1-851"><a href="#cb1-851"></a></span>
<span id="cb1-852"><a href="#cb1-852"></a></span>
<span id="cb1-853"><a href="#cb1-853"></a><span class="co"># data for study, remove originals ----------------------------------------</span></span>
<span id="cb1-854"><a href="#cb1-854"></a><span class="do">## create gender weights if needed</span></span>
<span id="cb1-855"><a href="#cb1-855"></a>dat_long_selected<span class="ot">&lt;-</span> dat_long_4</span>
<span id="cb1-856"><a href="#cb1-856"></a></span>
<span id="cb1-857"><a href="#cb1-857"></a></span>
<span id="cb1-858"><a href="#cb1-858"></a><span class="co"># aside -------------------------------------------------------------------</span></span>
<span id="cb1-859"><a href="#cb1-859"></a><span class="co"># only if gender weights</span></span>
<span id="cb1-860"><a href="#cb1-860"></a><span class="co"># dat_long_selected$gender_weights &lt;- margot_compute_gender_weights_by_wave(</span></span>
<span id="cb1-861"><a href="#cb1-861"></a><span class="co">#   dat_long_selected,</span></span>
<span id="cb1-862"><a href="#cb1-862"></a><span class="co">#   male_col = "male_binary",</span></span>
<span id="cb1-863"><a href="#cb1-863"></a><span class="co">#   wave_col = "wave",</span></span>
<span id="cb1-864"><a href="#cb1-864"></a><span class="co">#   target_wave = baseline_wave,</span></span>
<span id="cb1-865"><a href="#cb1-865"></a><span class="co">#   target_male_prop = 0.52 # source https://www.stats.govt.nz/news/women-in-paid-work</span></span>
<span id="cb1-866"><a href="#cb1-866"></a><span class="co"># )</span></span>
<span id="cb1-867"><a href="#cb1-867"></a></span>
<span id="cb1-868"><a href="#cb1-868"></a><span class="co"># end aside  --------------------------------------------------------------</span></span>
<span id="cb1-869"><a href="#cb1-869"></a><span class="co"># checks</span></span>
<span id="cb1-870"><a href="#cb1-870"></a><span class="fu">table</span>(dat_long_selected<span class="sc">$</span>sample_weights[dat_long_selected<span class="sc">$</span>wave <span class="sc">==</span> baseline_wave])</span>
<span id="cb1-871"><a href="#cb1-871"></a><span class="co"># hist(dat_long_selected$g_sample_weights)</span></span>
<span id="cb1-872"><a href="#cb1-872"></a><span class="co"># hist(dat_long_selected$gender_weights)</span></span>
<span id="cb1-873"><a href="#cb1-873"></a></span>
<span id="cb1-874"><a href="#cb1-874"></a><span class="co"># prepare data with log transformations</span></span>
<span id="cb1-875"><a href="#cb1-875"></a>dat_long_prepare <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_log_transform_vars</span>(</span>
<span id="cb1-876"><a href="#cb1-876"></a>  dat_long_selected,</span>
<span id="cb1-877"><a href="#cb1-877"></a>  <span class="at">vars =</span> <span class="fu">c</span>(<span class="fu">starts_with</span>(<span class="st">"hours_"</span>), <span class="st">"household_inc"</span>),</span>
<span id="cb1-878"><a href="#cb1-878"></a>  <span class="at">exceptions =</span> name_exposure,</span>
<span id="cb1-879"><a href="#cb1-879"></a>  <span class="at">prefix =</span> <span class="st">"log_"</span>,</span>
<span id="cb1-880"><a href="#cb1-880"></a>  <span class="at">keep_original =</span> <span class="cn">TRUE</span> <span class="co"># set to false if you do not want to keep originals</span></span>
<span id="cb1-881"><a href="#cb1-881"></a>) <span class="sc">|&gt;</span></span>
<span id="cb1-882"><a href="#cb1-882"></a>  <span class="co"># uncomment the next two lines if using gender weights</span></span>
<span id="cb1-883"><a href="#cb1-883"></a>  <span class="co"># select(-sample_weights) |&gt;</span></span>
<span id="cb1-884"><a href="#cb1-884"></a>  <span class="co"># dplyr::rename(sample_weights = gender_weights) |&gt;</span></span>
<span id="cb1-885"><a href="#cb1-885"></a>  <span class="fu">select</span>(<span class="fu">all_of</span>(all_vars)) <span class="sc">|&gt;</span></span>
<span id="cb1-886"><a href="#cb1-886"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb1-887"><a href="#cb1-887"></a></span>
<span id="cb1-888"><a href="#cb1-888"></a><span class="co"># check distribution and missingness</span></span>
<span id="cb1-889"><a href="#cb1-889"></a><span class="fu">hist</span>(dat_long_selected<span class="sc">$</span>sample_weights)</span>
<span id="cb1-890"><a href="#cb1-890"></a><span class="fu">table</span>(<span class="fu">is.na</span>(dat_long_selected<span class="sc">$</span>sample_weights))</span>
<span id="cb1-891"><a href="#cb1-891"></a><span class="fu">table</span>(<span class="fu">is.na</span>(dat_long_selected<span class="sc">$</span>male_binary))</span>
<span id="cb1-892"><a href="#cb1-892"></a></span>
<span id="cb1-893"><a href="#cb1-893"></a><span class="co"># extract baseline data</span></span>
<span id="cb1-894"><a href="#cb1-894"></a>dat_baseline <span class="ot">&lt;-</span> dat_long_prepare <span class="sc">|&gt;</span></span>
<span id="cb1-895"><a href="#cb1-895"></a>  <span class="fu">filter</span>(wave <span class="sc">==</span> baseline_wave)</span>
<span id="cb1-896"><a href="#cb1-896"></a></span>
<span id="cb1-897"><a href="#cb1-897"></a><span class="co"># check for missing values in baseline data</span></span>
<span id="cb1-898"><a href="#cb1-898"></a><span class="fu">table</span>(<span class="fu">is.na</span>(dat_baseline<span class="sc">$</span>sample_weights))</span>
<span id="cb1-899"><a href="#cb1-899"></a><span class="fu">table</span>(<span class="fu">is.na</span>(dat_baseline<span class="sc">$</span>male_binary))</span>
<span id="cb1-900"><a href="#cb1-900"></a></span>
<span id="cb1-901"><a href="#cb1-901"></a><span class="co"># extract sample weights from baseline</span></span>
<span id="cb1-902"><a href="#cb1-902"></a>t0_sample_weights <span class="ot">&lt;-</span> dat_baseline<span class="sc">$</span>sample_weights <span class="co"># use age/gender/ethnicity</span></span>
<span id="cb1-903"><a href="#cb1-903"></a><span class="fu">hist</span>(dat_baseline<span class="sc">$</span>sample_weights)</span>
<span id="cb1-904"><a href="#cb1-904"></a><span class="fu">hist</span>(t0_sample_weights)</span>
<span id="cb1-905"><a href="#cb1-905"></a></span>
<span id="cb1-906"><a href="#cb1-906"></a><span class="co"># alternative weights option (commented out)</span></span>
<span id="cb1-907"><a href="#cb1-907"></a><span class="co"># t0_sample_weights &lt;- dat_baseline$gender_weights</span></span>
<span id="cb1-908"><a href="#cb1-908"></a></span>
<span id="cb1-909"><a href="#cb1-909"></a><span class="co"># save sample weights</span></span>
<span id="cb1-910"><a href="#cb1-910"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(t0_sample_weights, <span class="st">"t0_sample_weights"</span>)</span>
<span id="cb1-911"><a href="#cb1-911"></a></span>
<span id="cb1-912"><a href="#cb1-912"></a><span class="co"># create tables -----------------------------------------------------------</span></span>
<span id="cb1-913"><a href="#cb1-913"></a>exposure_waves</span>
<span id="cb1-914"><a href="#cb1-914"></a></span>
<span id="cb1-915"><a href="#cb1-915"></a><span class="co"># create transition matrix for continuous exposure -----------------------</span></span>
<span id="cb1-916"><a href="#cb1-916"></a><span class="co"># prepare data for transition matrix</span></span>
<span id="cb1-917"><a href="#cb1-917"></a>dt_positivity <span class="ot">&lt;-</span> dat_long_selected <span class="sc">|&gt;</span></span>
<span id="cb1-918"><a href="#cb1-918"></a>  <span class="fu">filter</span>(wave <span class="sc">==</span> baseline_wave <span class="sc">|</span> wave <span class="sc">%in%</span> exposure_waves) <span class="sc">|&gt;</span></span>
<span id="cb1-919"><a href="#cb1-919"></a>  <span class="fu">select</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_exposure), id, wave) <span class="sc">|&gt;</span></span>
<span id="cb1-920"><a href="#cb1-920"></a>  <span class="fu">mutate</span>(<span class="at">exposure =</span> <span class="fu">as.numeric</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_exposure))) <span class="sc">|&gt;</span></span>
<span id="cb1-921"><a href="#cb1-921"></a>  <span class="fu">mutate</span>(<span class="at">exposure =</span> <span class="fu">round</span>(<span class="fu">ifelse</span>(exposure <span class="sc">&gt;</span> <span class="dv">5</span>, <span class="dv">5</span>, exposure), <span class="dv">0</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb1-922"><a href="#cb1-922"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb1-923"><a href="#cb1-923"></a></span>
<span id="cb1-924"><a href="#cb1-924"></a><span class="co"># create transition table</span></span>
<span id="cb1-925"><a href="#cb1-925"></a>transition_tables <span class="ot">&lt;-</span> <span class="fu">margot_transition_table</span>(dt_positivity, <span class="st">"exposure"</span>, <span class="st">"id"</span>, <span class="at">wave_var =</span> <span class="st">"wave"</span>)</span>
<span id="cb1-926"><a href="#cb1-926"></a></span>
<span id="cb1-927"><a href="#cb1-927"></a><span class="co"># check explanation of transition tables</span></span>
<span id="cb1-928"><a href="#cb1-928"></a><span class="fu">cat</span>(transition_tables<span class="sc">$</span>explanation)</span>
<span id="cb1-929"><a href="#cb1-929"></a></span>
<span id="cb1-930"><a href="#cb1-930"></a><span class="co"># view first transition table</span></span>
<span id="cb1-931"><a href="#cb1-931"></a>transition_tables<span class="sc">$</span>tables[[<span class="dv">1</span>]]</span>
<span id="cb1-932"><a href="#cb1-932"></a></span>
<span id="cb1-933"><a href="#cb1-933"></a><span class="co"># generate code for quarto document</span></span>
<span id="cb1-934"><a href="#cb1-934"></a>transition_tables<span class="sc">$</span><span class="fu">quarto_code</span>()</span>
<span id="cb1-935"><a href="#cb1-935"></a></span>
<span id="cb1-936"><a href="#cb1-936"></a><span class="co"># save transition tables for later use</span></span>
<span id="cb1-937"><a href="#cb1-937"></a><span class="fu">here_save</span>(transition_tables, <span class="st">"transition_tables"</span>)</span>
<span id="cb1-938"><a href="#cb1-938"></a></span>
<span id="cb1-939"><a href="#cb1-939"></a><span class="co"># create transition matrix for binary exposure ---------------------------</span></span>
<span id="cb1-940"><a href="#cb1-940"></a><span class="co"># prepare data for binary transition matrix</span></span>
<span id="cb1-941"><a href="#cb1-941"></a>dt_positivity_binary <span class="ot">&lt;-</span> dat_long_selected <span class="sc">|&gt;</span></span>
<span id="cb1-942"><a href="#cb1-942"></a>  <span class="fu">filter</span>(wave <span class="sc">==</span> baseline_wave <span class="sc">|</span> wave <span class="sc">%in%</span> exposure_waves) <span class="sc">|&gt;</span></span>
<span id="cb1-943"><a href="#cb1-943"></a>  <span class="fu">select</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_exposure_binary), id, wave) <span class="sc">|&gt;</span></span>
<span id="cb1-944"><a href="#cb1-944"></a>  <span class="fu">mutate</span>(<span class="at">exposure_binary =</span> <span class="fu">as.numeric</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_exposure_binary))) <span class="sc">|&gt;</span></span>
<span id="cb1-945"><a href="#cb1-945"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb1-946"><a href="#cb1-946"></a></span>
<span id="cb1-947"><a href="#cb1-947"></a><span class="co"># create binary transition table</span></span>
<span id="cb1-948"><a href="#cb1-948"></a>transition_tables_binary <span class="ot">&lt;-</span> <span class="fu">margot_transition_table</span>(</span>
<span id="cb1-949"><a href="#cb1-949"></a>  dt_positivity_binary, </span>
<span id="cb1-950"><a href="#cb1-950"></a>  <span class="st">"exposure_binary"</span>, </span>
<span id="cb1-951"><a href="#cb1-951"></a>  <span class="st">"id"</span>, </span>
<span id="cb1-952"><a href="#cb1-952"></a>  <span class="at">wave_var =</span> <span class="st">"wave"</span></span>
<span id="cb1-953"><a href="#cb1-953"></a>)</span>
<span id="cb1-954"><a href="#cb1-954"></a></span>
<span id="cb1-955"><a href="#cb1-955"></a><span class="co"># view binary transition table</span></span>
<span id="cb1-956"><a href="#cb1-956"></a>transition_tables_binary<span class="sc">$</span>tables[[<span class="dv">1</span>]]</span>
<span id="cb1-957"><a href="#cb1-957"></a></span>
<span id="cb1-958"><a href="#cb1-958"></a><span class="co"># check explanation for binary transition tables</span></span>
<span id="cb1-959"><a href="#cb1-959"></a><span class="fu">cat</span>(transition_tables_binary<span class="sc">$</span>explanation)</span>
<span id="cb1-960"><a href="#cb1-960"></a></span>
<span id="cb1-961"><a href="#cb1-961"></a><span class="co"># generate code for quarto document</span></span>
<span id="cb1-962"><a href="#cb1-962"></a>transition_tables_binary<span class="sc">$</span><span class="fu">quarto_code</span>()</span>
<span id="cb1-963"><a href="#cb1-963"></a></span>
<span id="cb1-964"><a href="#cb1-964"></a><span class="co"># save binary transition tables</span></span>
<span id="cb1-965"><a href="#cb1-965"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(transition_tables_binary, <span class="st">"transition_tables_binary"</span>)</span>
<span id="cb1-966"><a href="#cb1-966"></a></span>
<span id="cb1-967"><a href="#cb1-967"></a><span class="co"># check missing values ---------------------------------------------------</span></span>
<span id="cb1-968"><a href="#cb1-968"></a><span class="co"># examine overall missingness</span></span>
<span id="cb1-969"><a href="#cb1-969"></a>naniar<span class="sc">::</span><span class="fu">miss_var_summary</span>(dat_long_prepare) <span class="sc">|&gt;</span> <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">100</span>)</span>
<span id="cb1-970"><a href="#cb1-970"></a></span>
<span id="cb1-971"><a href="#cb1-971"></a><span class="co"># filter to baseline wave</span></span>
<span id="cb1-972"><a href="#cb1-972"></a>dat_baseline <span class="ot">&lt;-</span> dat_long_prepare <span class="sc">|&gt;</span> <span class="fu">filter</span>(wave <span class="sc">==</span> baseline_wave)</span>
<span id="cb1-973"><a href="#cb1-973"></a></span>
<span id="cb1-974"><a href="#cb1-974"></a><span class="co"># calculate percent missing at baseline</span></span>
<span id="cb1-975"><a href="#cb1-975"></a>percent_missing_baseline <span class="ot">&lt;-</span> naniar<span class="sc">::</span><span class="fu">pct_miss</span>(dat_baseline)</span>
<span id="cb1-976"><a href="#cb1-976"></a></span>
<span id="cb1-977"><a href="#cb1-977"></a><span class="co"># view missing percentage</span></span>
<span id="cb1-978"><a href="#cb1-978"></a>percent_missing_baseline</span>
<span id="cb1-979"><a href="#cb1-979"></a></span>
<span id="cb1-980"><a href="#cb1-980"></a><span class="co"># save for manuscript</span></span>
<span id="cb1-981"><a href="#cb1-981"></a><span class="fu">here_save</span>(percent_missing_baseline, <span class="st">"percent_missing_baseline"</span>)</span>
<span id="cb1-982"><a href="#cb1-982"></a></span>
<span id="cb1-983"><a href="#cb1-983"></a><span class="co"># visualise missingness patterns</span></span>
<span id="cb1-984"><a href="#cb1-984"></a>naniar<span class="sc">::</span><span class="fu">vis_miss</span>(dat_baseline, <span class="at">warn_large_data =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-985"><a href="#cb1-985"></a></span>
<span id="cb1-986"><a href="#cb1-986"></a><span class="co"># visualise missingness by variable</span></span>
<span id="cb1-987"><a href="#cb1-987"></a>naniar<span class="sc">::</span><span class="fu">gg_miss_var</span>(dat_baseline)</span>
<span id="cb1-988"><a href="#cb1-988"></a></span>
<span id="cb1-989"><a href="#cb1-989"></a><span class="co"># save the data ----------------------------------------------------------</span></span>
<span id="cb1-990"><a href="#cb1-990"></a><span class="co"># save prepared dataset</span></span>
<span id="cb1-991"><a href="#cb1-991"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(dat_long_prepare, <span class="st">"dat_long_prepare"</span>)</span>
<span id="cb1-992"><a href="#cb1-992"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(name_exposure, <span class="st">"name_exposure"</span>)</span>
<span id="cb1-993"><a href="#cb1-993"></a></span>
<span id="cb1-994"><a href="#cb1-994"></a><span class="co"># save variable names for later use</span></span>
<span id="cb1-995"><a href="#cb1-995"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(baseline_vars, <span class="st">"baseline_vars"</span>)</span>
<span id="cb1-996"><a href="#cb1-996"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(exposure_var, <span class="st">"exposure_var"</span>)</span>
<span id="cb1-997"><a href="#cb1-997"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(outcome_vars, <span class="st">"outcome_vars"</span>)</span>
<span id="cb1-998"><a href="#cb1-998"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(baseline_wave, <span class="st">"baseline_wave"</span>)</span>
<span id="cb1-999"><a href="#cb1-999"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(exposure_waves, <span class="st">"exposure_waves"</span>)</span>
<span id="cb1-1000"><a href="#cb1-1000"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(outcome_wave, <span class="st">"outcome_wave"</span>)</span>
<span id="cb1-1001"><a href="#cb1-1001"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(continuous_columns_keep, <span class="st">"continuous_columns_keep"</span>)</span>
<span id="cb1-1002"><a href="#cb1-1002"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(ordinal_columns, <span class="st">"ordinal_columns"</span>)</span>
<span id="cb1-1003"><a href="#cb1-1003"></a></span>
<span id="cb1-1004"><a href="#cb1-1004"></a><span class="co"># visualise individual patterns ------------------------------------------</span></span>
<span id="cb1-1005"><a href="#cb1-1005"></a><span class="co"># create plot of individual response trajectories</span></span>
<span id="cb1-1006"><a href="#cb1-1006"></a>individual_plot_exposure <span class="ot">&lt;-</span> <span class="fu">margot_plot_individual_responses</span>(</span>
<span id="cb1-1007"><a href="#cb1-1007"></a>  dat_long_1,</span>
<span id="cb1-1008"><a href="#cb1-1008"></a>  <span class="at">y_vars =</span> name_exposure,</span>
<span id="cb1-1009"><a href="#cb1-1009"></a>  <span class="at">id_col =</span> <span class="st">"id"</span>,</span>
<span id="cb1-1010"><a href="#cb1-1010"></a>  <span class="at">waves =</span> <span class="fu">c</span>(<span class="dv">2018</span><span class="sc">:</span><span class="dv">2019</span>), <span class="co"># only measured for two waves</span></span>
<span id="cb1-1011"><a href="#cb1-1011"></a>  <span class="at">theme =</span> <span class="fu">theme_classic</span>(),</span>
<span id="cb1-1012"><a href="#cb1-1012"></a>  <span class="at">random_draws =</span> <span class="dv">80</span>,</span>
<span id="cb1-1013"><a href="#cb1-1013"></a>  <span class="at">title =</span> <span class="cn">NULL</span>,</span>
<span id="cb1-1014"><a href="#cb1-1014"></a>  <span class="at">y_label =</span> <span class="cn">NULL</span>,</span>
<span id="cb1-1015"><a href="#cb1-1015"></a>  <span class="at">x_label =</span> <span class="cn">NULL</span>,</span>
<span id="cb1-1016"><a href="#cb1-1016"></a>  <span class="at">color_palette =</span> <span class="cn">NULL</span>,</span>
<span id="cb1-1017"><a href="#cb1-1017"></a>  <span class="at">include_timestamp =</span> <span class="cn">FALSE</span>,</span>
<span id="cb1-1018"><a href="#cb1-1018"></a>  <span class="co"># save_path = here::here(push_mods), # uncomment to save</span></span>
<span id="cb1-1019"><a href="#cb1-1019"></a>  <span class="at">width =</span> <span class="dv">16</span>,</span>
<span id="cb1-1020"><a href="#cb1-1020"></a>  <span class="at">height =</span> <span class="dv">8</span>,</span>
<span id="cb1-1021"><a href="#cb1-1021"></a>  <span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb1-1022"><a href="#cb1-1022"></a>  <span class="at">full_response_scale =</span> <span class="cn">TRUE</span>,</span>
<span id="cb1-1023"><a href="#cb1-1023"></a>  <span class="at">scale_range =</span> scale_range_exposure</span>
<span id="cb1-1024"><a href="#cb1-1024"></a>)</span>
<span id="cb1-1025"><a href="#cb1-1025"></a></span>
<span id="cb1-1026"><a href="#cb1-1026"></a><span class="co"># display individual trajectories plot</span></span>
<span id="cb1-1027"><a href="#cb1-1027"></a>individual_plot_exposure</span>
<span id="cb1-1028"><a href="#cb1-1028"></a></span>
<span id="cb1-1029"><a href="#cb1-1029"></a><span class="co"># check plot dimensions</span></span>
<span id="cb1-1030"><a href="#cb1-1030"></a><span class="fu">margot_size</span>(individual_plot_exposure)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="script-2" class="level3">
<h3 class="anchored" data-anchor-id="script-2">Script 2</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># 02-data-wrangling-grf-model</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co"># get data into wide format and ready for modelling using grf</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co"># joseph.bulbulia@gmail.com</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="co"># april 2025</span></span>
<span id="cb2-5"><a href="#cb2-5"></a></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="co"># restart fresh session</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="co"># rstudioapi::restartSession()</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="co"># set reproducibility</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb2-10"><a href="#cb2-10"></a></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="co"># save paths -------------------------------------------------------------------</span></span>
<span id="cb2-12"><a href="#cb2-12"></a><span class="co"># create a save path to your on computer</span></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="co"># this is mine</span></span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="co"># push_mods &lt;- here::here('/Users/joseph/v-project\ Dropbox/data/courses/25-psych-434')</span></span>
<span id="cb2-15"><a href="#cb2-15"></a><span class="co"># yours might be (after creating a data file)</span></span>
<span id="cb2-16"><a href="#cb2-16"></a>push_mods <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>)</span>
<span id="cb2-17"><a href="#cb2-17"></a></span>
<span id="cb2-18"><a href="#cb2-18"></a><span class="co"># load libraries ---------------------------------------------------------</span></span>
<span id="cb2-19"><a href="#cb2-19"></a><span class="co"># install and load 'margot' package</span></span>
<span id="cb2-20"><a href="#cb2-20"></a><span class="co"># make sure you have at least margot 1.0.21</span></span>
<span id="cb2-21"><a href="#cb2-21"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(margot, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb2-22"><a href="#cb2-22"></a>  devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"go-bayes/margot"</span>)</span>
<span id="cb2-23"><a href="#cb2-23"></a>}</span>
<span id="cb2-24"><a href="#cb2-24"></a></span>
<span id="cb2-25"><a href="#cb2-25"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(boilerplate, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb2-26"><a href="#cb2-26"></a>  devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"go-bayes/boilerplate"</span>)</span>
<span id="cb2-27"><a href="#cb2-27"></a>}</span>
<span id="cb2-28"><a href="#cb2-28"></a><span class="co"># load margot library</span></span>
<span id="cb2-29"><a href="#cb2-29"></a><span class="fu">library</span>(margot)</span>
<span id="cb2-30"><a href="#cb2-30"></a></span>
<span id="cb2-31"><a href="#cb2-31"></a><span class="co"># load necessary libraries</span></span>
<span id="cb2-32"><a href="#cb2-32"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb2-33"><a href="#cb2-33"></a>  clarify,     <span class="co"># sensitivity analysis for causal inference</span></span>
<span id="cb2-34"><a href="#cb2-34"></a>  cobalt,      <span class="co"># covariate balance tables and plots</span></span>
<span id="cb2-35"><a href="#cb2-35"></a>  DiagrammeR,  <span class="co"># graph and network visualization</span></span>
<span id="cb2-36"><a href="#cb2-36"></a>  doParallel,  <span class="co"># parallel processing with foreach</span></span>
<span id="cb2-37"><a href="#cb2-37"></a>  fastDummies, <span class="co"># fast creation of dummy variables</span></span>
<span id="cb2-38"><a href="#cb2-38"></a>  fs,          <span class="co"># cross-platform file system operations</span></span>
<span id="cb2-39"><a href="#cb2-39"></a>  ggbeeswarm,  <span class="co"># data visualisation</span></span>
<span id="cb2-40"><a href="#cb2-40"></a>  ggplot2,     <span class="co"># data visualisation</span></span>
<span id="cb2-41"><a href="#cb2-41"></a>  glmnet,      <span class="co"># lasso and elastic-net regularized models</span></span>
<span id="cb2-42"><a href="#cb2-42"></a>  grf,         <span class="co"># generalized random forests</span></span>
<span id="cb2-43"><a href="#cb2-43"></a>  gt,          <span class="co"># html tables for data frames</span></span>
<span id="cb2-44"><a href="#cb2-44"></a>  gtsummary,   <span class="co"># summary tables for regression models</span></span>
<span id="cb2-45"><a href="#cb2-45"></a>  here,        <span class="co"># simple and robust file referencing</span></span>
<span id="cb2-46"><a href="#cb2-46"></a>  janitor,     <span class="co"># data cleaning and validation</span></span>
<span id="cb2-47"><a href="#cb2-47"></a>  kableExtra,  <span class="co"># advanced table formatting</span></span>
<span id="cb2-48"><a href="#cb2-48"></a>  lmtp,        <span class="co"># longitudinal targeted maximum likelihood estimation</span></span>
<span id="cb2-49"><a href="#cb2-49"></a>  MatchIt,     <span class="co"># matching methods for causal inference</span></span>
<span id="cb2-50"><a href="#cb2-50"></a>  MatchThem,   <span class="co"># matching methods for multiply imputed datasets</span></span>
<span id="cb2-51"><a href="#cb2-51"></a>  naniar,      <span class="co"># handling and visualization of missing data</span></span>
<span id="cb2-52"><a href="#cb2-52"></a>  parameters,  <span class="co"># parameters and performance metrics</span></span>
<span id="cb2-53"><a href="#cb2-53"></a>  policytree,  <span class="co"># causal inference with policy trees</span></span>
<span id="cb2-54"><a href="#cb2-54"></a>  progressr,   <span class="co"># progress reporting for R</span></span>
<span id="cb2-55"><a href="#cb2-55"></a>  ranger,      <span class="co"># fast implementation of random forests</span></span>
<span id="cb2-56"><a href="#cb2-56"></a>  skimr,       <span class="co"># summary statistics for data frames</span></span>
<span id="cb2-57"><a href="#cb2-57"></a>  SuperLearner,<span class="co"># ensemble learning</span></span>
<span id="cb2-58"><a href="#cb2-58"></a>  tidyverse,   <span class="co"># collection of R packages for data science</span></span>
<span id="cb2-59"><a href="#cb2-59"></a>  WeightIt,    <span class="co"># weighting methods for covariate balancing</span></span>
<span id="cb2-60"><a href="#cb2-60"></a>  xgboost,     <span class="co"># extreme gradient boosting</span></span>
<span id="cb2-61"><a href="#cb2-61"></a>  EValue,      <span class="co"># compute Evalues</span></span>
<span id="cb2-62"><a href="#cb2-62"></a>  data.table,  <span class="co"># fast data wrangling</span></span>
<span id="cb2-63"><a href="#cb2-63"></a>  maq,         <span class="co"># qini curves</span></span>
<span id="cb2-64"><a href="#cb2-64"></a>  purrr,       <span class="co"># data wrangling</span></span>
<span id="cb2-65"><a href="#cb2-65"></a>  patchwork,   <span class="co"># multiple plots</span></span>
<span id="cb2-66"><a href="#cb2-66"></a>  labelled,</span>
<span id="cb2-67"><a href="#cb2-67"></a>  purrr,</span>
<span id="cb2-68"><a href="#cb2-68"></a>  boilerplate</span>
<span id="cb2-69"><a href="#cb2-69"></a>)</span>
<span id="cb2-70"><a href="#cb2-70"></a></span>
<span id="cb2-71"><a href="#cb2-71"></a><span class="co"># check</span></span>
<span id="cb2-72"><a href="#cb2-72"></a>push_mods</span>
<span id="cb2-73"><a href="#cb2-73"></a></span>
<span id="cb2-74"><a href="#cb2-74"></a><span class="co"># read data in</span></span>
<span id="cb2-75"><a href="#cb2-75"></a>dat_long_prepare <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"dat_long_prepare"</span>)</span>
<span id="cb2-76"><a href="#cb2-76"></a>name_exposure <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"name_exposure"</span>)</span>
<span id="cb2-77"><a href="#cb2-77"></a></span>
<span id="cb2-78"><a href="#cb2-78"></a><span class="co"># check</span></span>
<span id="cb2-79"><a href="#cb2-79"></a>name_exposure_binary <span class="ot">=</span> <span class="fu">paste0</span>(name_exposure, <span class="st">"_binary"</span>)</span>
<span id="cb2-80"><a href="#cb2-80"></a>name_exposure_continuous <span class="ot">=</span> name_exposure</span>
<span id="cb2-81"><a href="#cb2-81"></a></span>
<span id="cb2-82"><a href="#cb2-82"></a><span class="co"># check</span></span>
<span id="cb2-83"><a href="#cb2-83"></a>name_exposure_binary</span>
<span id="cb2-84"><a href="#cb2-84"></a>name_exposure_continuous</span>
<span id="cb2-85"><a href="#cb2-85"></a></span>
<span id="cb2-86"><a href="#cb2-86"></a><span class="co"># get vars</span></span>
<span id="cb2-87"><a href="#cb2-87"></a>baseline_vars <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"baseline_vars"</span>)</span>
<span id="cb2-88"><a href="#cb2-88"></a>outcome_vars <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"outcome_vars"</span>)</span>
<span id="cb2-89"><a href="#cb2-89"></a></span>
<span id="cb2-90"><a href="#cb2-90"></a>baseline_wave <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"baseline_wave"</span>)</span>
<span id="cb2-91"><a href="#cb2-91"></a>exposure_waves <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"exposure_waves"</span>)</span>
<span id="cb2-92"><a href="#cb2-92"></a>outcome_wave <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"outcome_wave"</span>)</span>
<span id="cb2-93"><a href="#cb2-93"></a>t0_sample_weights <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"t0_sample_weights"</span>)</span>
<span id="cb2-94"><a href="#cb2-94"></a></span>
<span id="cb2-95"><a href="#cb2-95"></a><span class="co"># define wide variable names</span></span>
<span id="cb2-96"><a href="#cb2-96"></a>t0_name_exposure_binary <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t0_"</span>, name_exposure_binary)</span>
<span id="cb2-97"><a href="#cb2-97"></a></span>
<span id="cb2-98"><a href="#cb2-98"></a><span class="co"># make exposure names (continuous not generally used)</span></span>
<span id="cb2-99"><a href="#cb2-99"></a>t1_name_exposure_binary <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t1_"</span>, name_exposure_binary)</span>
<span id="cb2-100"><a href="#cb2-100"></a>t1_name_exposure_binary</span>
<span id="cb2-101"><a href="#cb2-101"></a></span>
<span id="cb2-102"><a href="#cb2-102"></a>t0_name_exposure_continuous <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t0_"</span>, name_exposure)</span>
<span id="cb2-103"><a href="#cb2-103"></a>t0_name_exposure_continuous</span>
<span id="cb2-104"><a href="#cb2-104"></a></span>
<span id="cb2-105"><a href="#cb2-105"></a><span class="co"># make exposure names (continuous not generally used)</span></span>
<span id="cb2-106"><a href="#cb2-106"></a>t1_name_exposure_continuous <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t1_"</span>, name_exposure)</span>
<span id="cb2-107"><a href="#cb2-107"></a>t1_name_exposure_continuous</span>
<span id="cb2-108"><a href="#cb2-108"></a></span>
<span id="cb2-109"><a href="#cb2-109"></a><span class="co"># ordinal use</span></span>
<span id="cb2-110"><a href="#cb2-110"></a>ordinal_columns <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb2-111"><a href="#cb2-111"></a>  <span class="st">"t0_education_level_coarsen"</span>,</span>
<span id="cb2-112"><a href="#cb2-112"></a>  <span class="st">"t0_eth_cat"</span>,</span>
<span id="cb2-113"><a href="#cb2-113"></a>  <span class="st">"t0_rural_gch_2018_l"</span>,</span>
<span id="cb2-114"><a href="#cb2-114"></a>  <span class="st">"t0_gen_cohort"</span></span>
<span id="cb2-115"><a href="#cb2-115"></a>)</span>
<span id="cb2-116"><a href="#cb2-116"></a></span>
<span id="cb2-117"><a href="#cb2-117"></a><span class="co"># keep sample weights without standardisation</span></span>
<span id="cb2-118"><a href="#cb2-118"></a>continuous_columns_keep <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"t0_sample_weights"</span>)</span>
<span id="cb2-119"><a href="#cb2-119"></a></span>
<span id="cb2-120"><a href="#cb2-120"></a><span class="co"># prepare data for analysis ----------------------</span></span>
<span id="cb2-121"><a href="#cb2-121"></a>dat_long_prepare <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">remove_numeric_attributes</span>(dat_long_prepare)</span>
<span id="cb2-122"><a href="#cb2-122"></a></span>
<span id="cb2-123"><a href="#cb2-123"></a><span class="co"># update wave to numeric</span></span>
<span id="cb2-124"><a href="#cb2-124"></a>dat_long_prepare_updated <span class="ot">&lt;-</span> dat_long_prepare <span class="sc">%&gt;%</span></span>
<span id="cb2-125"><a href="#cb2-125"></a>  <span class="fu">mutate</span>(<span class="at">wave =</span> <span class="fu">as.numeric</span>(<span class="fu">factor</span>(wave, <span class="at">levels =</span> <span class="fu">sort</span>(<span class="fu">unique</span>(wave)))))</span>
<span id="cb2-126"><a href="#cb2-126"></a></span>
<span id="cb2-127"><a href="#cb2-127"></a><span class="co"># make both exposure variables</span></span>
<span id="cb2-128"><a href="#cb2-128"></a>name_exposure_both <span class="ot">&lt;-</span> <span class="fu">c</span>(name_exposure_binary,name_exposure_continuous)</span>
<span id="cb2-129"><a href="#cb2-129"></a><span class="co"># check</span></span>
<span id="cb2-130"><a href="#cb2-130"></a>name_exposure_both</span>
<span id="cb2-131"><a href="#cb2-131"></a></span>
<span id="cb2-132"><a href="#cb2-132"></a><span class="co"># wide data</span></span>
<span id="cb2-133"><a href="#cb2-133"></a>df_wide <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_wide</span>(</span>
<span id="cb2-134"><a href="#cb2-134"></a>  dat_long_prepare_updated,</span>
<span id="cb2-135"><a href="#cb2-135"></a>  <span class="at">baseline_vars =</span> baseline_vars,</span>
<span id="cb2-136"><a href="#cb2-136"></a>  <span class="at">exposure_var =</span> name_exposure_both,</span>
<span id="cb2-137"><a href="#cb2-137"></a>  <span class="at">outcome_vars =</span> outcome_vars</span>
<span id="cb2-138"><a href="#cb2-138"></a>)</span>
<span id="cb2-139"><a href="#cb2-139"></a></span>
<span id="cb2-140"><a href="#cb2-140"></a><span class="co"># check</span></span>
<span id="cb2-141"><a href="#cb2-141"></a><span class="fu">head</span>(df_wide)</span>
<span id="cb2-142"><a href="#cb2-142"></a></span>
<span id="cb2-143"><a href="#cb2-143"></a><span class="co"># check</span></span>
<span id="cb2-144"><a href="#cb2-144"></a><span class="co"># remove baseline binary</span></span>
<span id="cb2-145"><a href="#cb2-145"></a>t0_sample_weights</span>
<span id="cb2-146"><a href="#cb2-146"></a></span>
<span id="cb2-147"><a href="#cb2-147"></a><span class="co"># add weights back to data</span></span>
<span id="cb2-148"><a href="#cb2-148"></a>df_wide<span class="sc">$</span>t0_sample_weights <span class="ot">&lt;-</span> t0_sample_weights</span>
<span id="cb2-149"><a href="#cb2-149"></a></span>
<span id="cb2-150"><a href="#cb2-150"></a><span class="co"># make sure that rural is a factor</span></span>
<span id="cb2-151"><a href="#cb2-151"></a>df_wide<span class="sc">$</span>t0_rural_gch_2018_l <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df_wide<span class="sc">$</span>t0_rural_gch_2018_l)</span>
<span id="cb2-152"><a href="#cb2-152"></a></span>
<span id="cb2-153"><a href="#cb2-153"></a><span class="co"># save the wide data</span></span>
<span id="cb2-154"><a href="#cb2-154"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(df_wide, <span class="st">"df_wide"</span>)</span>
<span id="cb2-155"><a href="#cb2-155"></a></span>
<span id="cb2-156"><a href="#cb2-156"></a><span class="co"># naniar::vis_miss(df_wide, warn_large_data = FALSE)</span></span>
<span id="cb2-157"><a href="#cb2-157"></a><span class="co"># read back if needed</span></span>
<span id="cb2-158"><a href="#cb2-158"></a><span class="co"># df_wide &lt;- margot::here_read("df_wide")</span></span>
<span id="cb2-159"><a href="#cb2-159"></a></span>
<span id="cb2-160"><a href="#cb2-160"></a><span class="co"># check</span></span>
<span id="cb2-161"><a href="#cb2-161"></a><span class="fu">colnames</span>(df_wide)</span>
<span id="cb2-162"><a href="#cb2-162"></a></span>
<span id="cb2-163"><a href="#cb2-163"></a><span class="co"># this will order the data correctly</span></span>
<span id="cb2-164"><a href="#cb2-164"></a><span class="co"># see margot documentation</span></span>
<span id="cb2-165"><a href="#cb2-165"></a><span class="co"># standardise outcomes, create not-lost indicator</span></span>
<span id="cb2-166"><a href="#cb2-166"></a>df_wide_encoded <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_process_longitudinal_data_wider</span>(</span>
<span id="cb2-167"><a href="#cb2-167"></a>  df_wide,</span>
<span id="cb2-168"><a href="#cb2-168"></a>  <span class="at">ordinal_columns =</span> ordinal_columns,</span>
<span id="cb2-169"><a href="#cb2-169"></a>  <span class="at">continuous_columns_keep =</span> continuous_columns_keep,</span>
<span id="cb2-170"><a href="#cb2-170"></a>  <span class="at">not_lost_in_following_wave =</span> <span class="st">"not_lost_following_wave"</span>,</span>
<span id="cb2-171"><a href="#cb2-171"></a>  <span class="at">lost_in_following_wave =</span> <span class="st">"lost_following_wave"</span>,</span>
<span id="cb2-172"><a href="#cb2-172"></a>  <span class="at">remove_selected_columns =</span> <span class="cn">TRUE</span>,</span>
<span id="cb2-173"><a href="#cb2-173"></a>  <span class="at">exposure_var =</span> name_exposure_both,</span>
<span id="cb2-174"><a href="#cb2-174"></a>  <span class="at">scale_continuous =</span> <span class="cn">TRUE</span>,</span>
<span id="cb2-175"><a href="#cb2-175"></a>  <span class="at">censored_if_any_lost =</span> <span class="cn">FALSE</span> <span class="co"># not relevant here</span></span>
<span id="cb2-176"><a href="#cb2-176"></a>)</span>
<span id="cb2-177"><a href="#cb2-177"></a></span>
<span id="cb2-178"><a href="#cb2-178"></a><span class="co"># check</span></span>
<span id="cb2-179"><a href="#cb2-179"></a><span class="fu">colnames</span>(df_wide_encoded)</span>
<span id="cb2-180"><a href="#cb2-180"></a></span>
<span id="cb2-181"><a href="#cb2-181"></a><span class="co"># check</span></span>
<span id="cb2-182"><a href="#cb2-182"></a><span class="fu">table</span>(df_wide_encoded<span class="sc">$</span>t0_not_lost_following_wave)</span>
<span id="cb2-183"><a href="#cb2-183"></a></span>
<span id="cb2-184"><a href="#cb2-184"></a><span class="co"># make the binary variable numeric! </span></span>
<span id="cb2-185"><a href="#cb2-185"></a>df_wide_encoded[[t0_name_exposure_binary]] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(df_wide_encoded[[t0_name_exposure_binary]]) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb2-186"><a href="#cb2-186"></a>df_wide_encoded[[t1_name_exposure_binary]] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(df_wide_encoded[[t1_name_exposure_binary]]) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb2-187"><a href="#cb2-187"></a></span>
<span id="cb2-188"><a href="#cb2-188"></a><span class="co"># check</span></span>
<span id="cb2-189"><a href="#cb2-189"></a><span class="fu">table</span>(df_wide_encoded[[t0_name_exposure_binary]])</span>
<span id="cb2-190"><a href="#cb2-190"></a><span class="fu">table</span>(df_wide_encoded[[t1_name_exposure_binary]])</span>
<span id="cb2-191"><a href="#cb2-191"></a></span>
<span id="cb2-192"><a href="#cb2-192"></a><span class="co"># save data for models</span></span>
<span id="cb2-193"><a href="#cb2-193"></a><span class="fu">here_save_qs</span>(df_wide_encoded, <span class="st">"df_wide_encoded"</span>, push_mods)</span>
<span id="cb2-194"><a href="#cb2-194"></a></span>
<span id="cb2-195"><a href="#cb2-195"></a><span class="co"># save data for models</span></span>
<span id="cb2-196"><a href="#cb2-196"></a><span class="co"># make exposure numeric</span></span>
<span id="cb2-197"><a href="#cb2-197"></a></span>
<span id="cb2-198"><a href="#cb2-198"></a><span class="co"># check</span></span>
<span id="cb2-199"><a href="#cb2-199"></a><span class="fu">colnames</span>(df_wide_encoded)</span>
<span id="cb2-200"><a href="#cb2-200"></a><span class="fu">table</span>(<span class="fu">is.na</span>(df_wide_encoded[[t1_name_exposure_binary]]))</span>
<span id="cb2-201"><a href="#cb2-201"></a><span class="fu">table</span>(df_wide_encoded<span class="sc">$</span>t0_lost_following_wave)</span>
<span id="cb2-202"><a href="#cb2-202"></a></span>
<span id="cb2-203"><a href="#cb2-203"></a><span class="co"># check</span></span>
<span id="cb2-204"><a href="#cb2-204"></a><span class="fu">stopifnot</span>(</span>
<span id="cb2-205"><a href="#cb2-205"></a>  <span class="fu">all</span>(</span>
<span id="cb2-206"><a href="#cb2-206"></a>    <span class="fu">is.na</span>(df_wide_encoded[[t1_name_exposure_binary]]) <span class="sc">|</span></span>
<span id="cb2-207"><a href="#cb2-207"></a>      df_wide_encoded[[<span class="st">"t0_not_lost_following_wave"</span>]] <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb2-208"><a href="#cb2-208"></a>  )</span>
<span id="cb2-209"><a href="#cb2-209"></a>)</span>
<span id="cb2-210"><a href="#cb2-210"></a></span>
<span id="cb2-211"><a href="#cb2-211"></a><span class="co"># naniar::vis_miss(df_wide_encoded, warn_large_data = FALSE)</span></span>
<span id="cb2-212"><a href="#cb2-212"></a>naniar<span class="sc">::</span><span class="fu">gg_miss_var</span>(df_wide_encoded)</span>
<span id="cb2-213"><a href="#cb2-213"></a></span>
<span id="cb2-214"><a href="#cb2-214"></a>df_wide_encoded<span class="sc">$</span>t0_sample_weights</span>
<span id="cb2-215"><a href="#cb2-215"></a></span>
<span id="cb2-216"><a href="#cb2-216"></a><span class="co"># predict attrition and create censoring weights --------------------------</span></span>
<span id="cb2-217"><a href="#cb2-217"></a><span class="co"># step 1: prepare baseline covariates</span></span>
<span id="cb2-218"><a href="#cb2-218"></a>E <span class="ot">&lt;-</span> df_wide_encoded <span class="sc">%&gt;%</span></span>
<span id="cb2-219"><a href="#cb2-219"></a>  <span class="fu">select</span>(</span>
<span id="cb2-220"><a href="#cb2-220"></a>    <span class="sc">-</span><span class="fu">all_of</span>(t0_name_exposure_binary), <span class="co"># inserted by function but irrelevant</span></span>
<span id="cb2-221"><a href="#cb2-221"></a>    <span class="sc">-</span><span class="st">"t0_sample_weights"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-222"><a href="#cb2-222"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"t0_"</span>),</span>
<span id="cb2-223"><a href="#cb2-223"></a>         <span class="sc">-</span><span class="fu">ends_with</span>(<span class="st">"_lost"</span>),</span>
<span id="cb2-224"><a href="#cb2-224"></a>         <span class="sc">-</span><span class="fu">ends_with</span>(<span class="st">"lost_following_wave"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb2-225"><a href="#cb2-225"></a>  <span class="fu">colnames</span>() <span class="sc">%&gt;%</span></span>
<span id="cb2-226"><a href="#cb2-226"></a>  <span class="fu">sort</span>()</span>
<span id="cb2-227"><a href="#cb2-227"></a></span>
<span id="cb2-228"><a href="#cb2-228"></a><span class="co"># note for baseline confounding we use the continuous var</span></span>
<span id="cb2-229"><a href="#cb2-229"></a>E <span class="co"># we use the continuous variable</span></span>
<span id="cb2-230"><a href="#cb2-230"></a></span>
<span id="cb2-231"><a href="#cb2-231"></a><span class="co"># save baseline covariates</span></span>
<span id="cb2-232"><a href="#cb2-232"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(E, <span class="st">"E"</span>)</span>
<span id="cb2-233"><a href="#cb2-233"></a></span>
<span id="cb2-234"><a href="#cb2-234"></a><span class="co"># view</span></span>
<span id="cb2-235"><a href="#cb2-235"></a><span class="fu">print</span>(E)</span>
<span id="cb2-236"><a href="#cb2-236"></a></span>
<span id="cb2-237"><a href="#cb2-237"></a><span class="co"># step 2: calculate weights for t0</span></span>
<span id="cb2-238"><a href="#cb2-238"></a>D_0 <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df_wide_encoded<span class="sc">$</span>t0_lost_following_wave)</span>
<span id="cb2-239"><a href="#cb2-239"></a></span>
<span id="cb2-240"><a href="#cb2-240"></a><span class="co"># get covariates</span></span>
<span id="cb2-241"><a href="#cb2-241"></a>cen_0 <span class="ot">&lt;-</span> df_wide_encoded[, E]</span>
<span id="cb2-242"><a href="#cb2-242"></a></span>
<span id="cb2-243"><a href="#cb2-243"></a><span class="co"># probability forest for censoring</span></span>
<span id="cb2-244"><a href="#cb2-244"></a>cen_forest_0 <span class="ot">&lt;-</span> <span class="fu">probability_forest</span>(cen_0, D_0)</span>
<span id="cb2-245"><a href="#cb2-245"></a></span>
<span id="cb2-246"><a href="#cb2-246"></a><span class="co"># save if needed, very large!</span></span>
<span id="cb2-247"><a href="#cb2-247"></a><span class="co"># here_save_qs(cen_forest_0, "cen_forest_0", push_mods)</span></span>
<span id="cb2-248"><a href="#cb2-248"></a></span>
<span id="cb2-249"><a href="#cb2-249"></a><span class="co"># predict</span></span>
<span id="cb2-250"><a href="#cb2-250"></a>predictions_grf_0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(cen_forest_0, <span class="at">newdata =</span> cen_0, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb2-251"><a href="#cb2-251"></a></span>
<span id="cb2-252"><a href="#cb2-252"></a><span class="co"># get probability of censoring</span></span>
<span id="cb2-253"><a href="#cb2-253"></a>pscore_0 <span class="ot">&lt;-</span> predictions_grf_0<span class="sc">$</span>pred[, <span class="dv">2</span>]</span>
<span id="cb2-254"><a href="#cb2-254"></a></span>
<span id="cb2-255"><a href="#cb2-255"></a><span class="co"># view</span></span>
<span id="cb2-256"><a href="#cb2-256"></a><span class="fu">hist</span>(pscore_0)</span>
<span id="cb2-257"><a href="#cb2-257"></a></span>
<span id="cb2-258"><a href="#cb2-258"></a><span class="co"># check correct sample weights  </span></span>
<span id="cb2-259"><a href="#cb2-259"></a><span class="fu">hist</span>(t0_sample_weights)</span>
<span id="cb2-260"><a href="#cb2-260"></a></span>
<span id="cb2-261"><a href="#cb2-261"></a><span class="co"># use margot_adjust_weights for t0</span></span>
<span id="cb2-262"><a href="#cb2-262"></a>t0_weights <span class="ot">&lt;-</span> <span class="fu">margot_adjust_weights</span>(</span>
<span id="cb2-263"><a href="#cb2-263"></a>  <span class="at">pscore =</span> pscore_0,</span>
<span id="cb2-264"><a href="#cb2-264"></a>  <span class="at">trim =</span> <span class="cn">TRUE</span>,</span>
<span id="cb2-265"><a href="#cb2-265"></a>  <span class="at">normalize =</span> <span class="cn">TRUE</span>,</span>
<span id="cb2-266"><a href="#cb2-266"></a>  <span class="co"># lower trimming</span></span>
<span id="cb2-267"><a href="#cb2-267"></a>  <span class="at">lower_percentile =</span> <span class="fl">0.01</span>,</span>
<span id="cb2-268"><a href="#cb2-268"></a>  <span class="at">upper_percentile =</span> <span class="fl">0.99</span>,</span>
<span id="cb2-269"><a href="#cb2-269"></a>  <span class="co"># upper trimming</span></span>
<span id="cb2-270"><a href="#cb2-270"></a>  <span class="at">censoring_indicator =</span> df_wide_encoded<span class="sc">$</span>t0_lost_following_wave,</span>
<span id="cb2-271"><a href="#cb2-271"></a>  <span class="at">sample_weights =</span> df_wide_encoded<span class="sc">$</span>t0_sample_weights </span>
<span id="cb2-272"><a href="#cb2-272"></a>)</span>
<span id="cb2-273"><a href="#cb2-273"></a></span>
<span id="cb2-274"><a href="#cb2-274"></a><span class="co"># view</span></span>
<span id="cb2-275"><a href="#cb2-275"></a><span class="fu">length</span>(t0_weights<span class="sc">$</span>adjusted_weights)</span>
<span id="cb2-276"><a href="#cb2-276"></a><span class="fu">length</span>(df_wide_encoded<span class="sc">$</span>t0_sample_weights)</span>
<span id="cb2-277"><a href="#cb2-277"></a></span>
<span id="cb2-278"><a href="#cb2-278"></a><span class="co"># check</span></span>
<span id="cb2-279"><a href="#cb2-279"></a><span class="fu">nrow</span>(df_wide_encoded)</span>
<span id="cb2-280"><a href="#cb2-280"></a><span class="fu">hist</span>(t0_weights<span class="sc">$</span>adjusted_weights)</span>
<span id="cb2-281"><a href="#cb2-281"></a></span>
<span id="cb2-282"><a href="#cb2-282"></a><span class="co"># assign weights</span></span>
<span id="cb2-283"><a href="#cb2-283"></a>df_wide_encoded<span class="sc">$</span>t0_adjusted_weights <span class="ot">&lt;-</span> t0_weights<span class="sc">$</span>adjusted_weights</span>
<span id="cb2-284"><a href="#cb2-284"></a></span>
<span id="cb2-285"><a href="#cb2-285"></a><span class="co"># if you only wanted censoring weights</span></span>
<span id="cb2-286"><a href="#cb2-286"></a><span class="co"># df_wide_encoded$t0_propensity_score_model_weights &lt;- t0_weights$censoring_weights</span></span>
<span id="cb2-287"><a href="#cb2-287"></a></span>
<span id="cb2-288"><a href="#cb2-288"></a><span class="co"># check</span></span>
<span id="cb2-289"><a href="#cb2-289"></a>naniar<span class="sc">::</span><span class="fu">vis_miss</span>(df_wide_encoded, <span class="at">warn_large_data =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-290"><a href="#cb2-290"></a></span>
<span id="cb2-291"><a href="#cb2-291"></a><span class="co"># view</span></span>
<span id="cb2-292"><a href="#cb2-292"></a><span class="fu">head</span>(df_wide_encoded)</span>
<span id="cb2-293"><a href="#cb2-293"></a><span class="fu">colnames</span>(df_wide_encoded)</span>
<span id="cb2-294"><a href="#cb2-294"></a></span>
<span id="cb2-295"><a href="#cb2-295"></a><span class="co"># remove lost next wave (censored)</span></span>
<span id="cb2-296"><a href="#cb2-296"></a>df_wide_encoded_1 <span class="ot">&lt;-</span> df_wide_encoded <span class="sc">%&gt;%</span></span>
<span id="cb2-297"><a href="#cb2-297"></a>  <span class="fu">filter</span>(t0_lost_following_wave <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-298"><a href="#cb2-298"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb2-299"><a href="#cb2-299"></a></span>
<span id="cb2-300"><a href="#cb2-300"></a><span class="co"># step 4: calculate weights for t1</span></span>
<span id="cb2-301"><a href="#cb2-301"></a>E_and_exposure <span class="ot">&lt;-</span> <span class="fu">c</span>(E, t1_name_exposure_continuous)</span>
<span id="cb2-302"><a href="#cb2-302"></a>D_1 <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df_wide_encoded_1<span class="sc">$</span>t1_lost_following_wave)</span>
<span id="cb2-303"><a href="#cb2-303"></a>cen_1 <span class="ot">&lt;-</span> df_wide_encoded_1[, E_and_exposure]</span>
<span id="cb2-304"><a href="#cb2-304"></a></span>
<span id="cb2-305"><a href="#cb2-305"></a><span class="co"># probability forest for censoring</span></span>
<span id="cb2-306"><a href="#cb2-306"></a>cen_forest_1 <span class="ot">&lt;-</span> <span class="fu">probability_forest</span>(cen_1, D_1, <span class="at">sample.weights =</span> df_wide_encoded_1<span class="sc">$</span>t0_adjusted_weights)</span>
<span id="cb2-307"><a href="#cb2-307"></a></span>
<span id="cb2-308"><a href="#cb2-308"></a><span class="co"># save if needed, very large</span></span>
<span id="cb2-309"><a href="#cb2-309"></a><span class="co"># here_save(cen_forest_1, "cen_forest_1")</span></span>
<span id="cb2-310"><a href="#cb2-310"></a></span>
<span id="cb2-311"><a href="#cb2-311"></a>predictions_grf_1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(cen_forest_1, <span class="at">newdata =</span> cen_1, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb2-312"><a href="#cb2-312"></a>pscore_1 <span class="ot">&lt;-</span> predictions_grf_1<span class="sc">$</span>pred[, <span class="dv">2</span>]</span>
<span id="cb2-313"><a href="#cb2-313"></a></span>
<span id="cb2-314"><a href="#cb2-314"></a><span class="co"># check</span></span>
<span id="cb2-315"><a href="#cb2-315"></a><span class="fu">hist</span>(pscore_1)</span>
<span id="cb2-316"><a href="#cb2-316"></a></span>
<span id="cb2-317"><a href="#cb2-317"></a><span class="co"># use margot_adjust_weights for t1</span></span>
<span id="cb2-318"><a href="#cb2-318"></a>t1_weights <span class="ot">&lt;-</span> <span class="fu">margot_adjust_weights</span>(</span>
<span id="cb2-319"><a href="#cb2-319"></a>  <span class="at">pscore =</span> pscore_1,</span>
<span id="cb2-320"><a href="#cb2-320"></a>  <span class="at">trim =</span> <span class="cn">TRUE</span>,</span>
<span id="cb2-321"><a href="#cb2-321"></a>  <span class="at">normalize =</span> <span class="cn">TRUE</span>,</span>
<span id="cb2-322"><a href="#cb2-322"></a>  <span class="at">lower_percentile =</span> <span class="fl">0.01</span>,</span>
<span id="cb2-323"><a href="#cb2-323"></a>  <span class="at">upper_percentile =</span> <span class="fl">0.99</span>,</span>
<span id="cb2-324"><a href="#cb2-324"></a>  <span class="co"># upper trimming</span></span>
<span id="cb2-325"><a href="#cb2-325"></a>  <span class="at">censoring_indicator =</span> df_wide_encoded_1<span class="sc">$</span>t1_lost_following_wave,</span>
<span id="cb2-326"><a href="#cb2-326"></a>  <span class="at">sample_weights =</span> df_wide_encoded_1<span class="sc">$</span>t0_adjusted_weights <span class="co"># combine with weights</span></span>
<span id="cb2-327"><a href="#cb2-327"></a>)</span>
<span id="cb2-328"><a href="#cb2-328"></a></span>
<span id="cb2-329"><a href="#cb2-329"></a><span class="co"># check</span></span>
<span id="cb2-330"><a href="#cb2-330"></a><span class="fu">hist</span>(t1_weights<span class="sc">$</span>adjusted_weights)</span>
<span id="cb2-331"><a href="#cb2-331"></a></span>
<span id="cb2-332"><a href="#cb2-332"></a><span class="co"># add weights -- these will be the weights we use</span></span>
<span id="cb2-333"><a href="#cb2-333"></a>df_wide_encoded_1<span class="sc">$</span>t1_adjusted_weights <span class="ot">&lt;-</span> t1_weights<span class="sc">$</span>adjusted_weights</span>
<span id="cb2-334"><a href="#cb2-334"></a></span>
<span id="cb2-335"><a href="#cb2-335"></a><span class="co"># calculate summary statistics</span></span>
<span id="cb2-336"><a href="#cb2-336"></a>t0_adjusted_weight_summary <span class="ot">&lt;-</span> <span class="fu">summary</span>(df_wide_encoded<span class="sc">$</span>t0_adjusted_weights)</span>
<span id="cb2-337"><a href="#cb2-337"></a>t1_adjusted_weight_summary <span class="ot">&lt;-</span> <span class="fu">summary</span>(df_wide_encoded_1<span class="sc">$</span>t1_adjusted_weights)</span>
<span id="cb2-338"><a href="#cb2-338"></a></span>
<span id="cb2-339"><a href="#cb2-339"></a><span class="co"># view summaries</span></span>
<span id="cb2-340"><a href="#cb2-340"></a>t0_adjusted_weight_summary</span>
<span id="cb2-341"><a href="#cb2-341"></a>t1_adjusted_weight_summary</span>
<span id="cb2-342"><a href="#cb2-342"></a></span>
<span id="cb2-343"><a href="#cb2-343"></a><span class="co"># check</span></span>
<span id="cb2-344"><a href="#cb2-344"></a>naniar<span class="sc">::</span><span class="fu">vis_miss</span>(df_wide_encoded_1, <span class="at">warn_large_data =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-345"><a href="#cb2-345"></a></span>
<span id="cb2-346"><a href="#cb2-346"></a><span class="co"># save</span></span>
<span id="cb2-347"><a href="#cb2-347"></a><span class="fu">here_save</span>(df_wide_encoded_1, <span class="st">"df_wide_encoded_1"</span>)</span>
<span id="cb2-348"><a href="#cb2-348"></a></span>
<span id="cb2-349"><a href="#cb2-349"></a><span class="co"># read if needed</span></span>
<span id="cb2-350"><a href="#cb2-350"></a><span class="co"># df_wide_encoded_1 &lt;- here_read("df_wide_encoded_1")</span></span>
<span id="cb2-351"><a href="#cb2-351"></a></span>
<span id="cb2-352"><a href="#cb2-352"></a><span class="co"># check names</span></span>
<span id="cb2-353"><a href="#cb2-353"></a><span class="fu">colnames</span>(df_wide_encoded_1)</span>
<span id="cb2-354"><a href="#cb2-354"></a></span>
<span id="cb2-355"><a href="#cb2-355"></a><span class="co"># check</span></span>
<span id="cb2-356"><a href="#cb2-356"></a>df_wide_encoded_1[[t1_name_exposure_binary]]</span>
<span id="cb2-357"><a href="#cb2-357"></a></span>
<span id="cb2-358"><a href="#cb2-358"></a><span class="co"># step 5: prepare final dataset</span></span>
<span id="cb2-359"><a href="#cb2-359"></a><span class="fu">nrow</span>(df_wide_encoded_1)</span>
<span id="cb2-360"><a href="#cb2-360"></a><span class="fu">table</span>(df_wide_encoded_1<span class="sc">$</span>t1_lost_following_wave)</span>
<span id="cb2-361"><a href="#cb2-361"></a></span>
<span id="cb2-362"><a href="#cb2-362"></a><span class="co"># arrange</span></span>
<span id="cb2-363"><a href="#cb2-363"></a>df_grf <span class="ot">&lt;-</span> df_wide_encoded_1 <span class="sc">|&gt;</span></span>
<span id="cb2-364"><a href="#cb2-364"></a>  <span class="fu">filter</span>(t1_lost_following_wave <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-365"><a href="#cb2-365"></a>  <span class="fu">select</span>(</span>
<span id="cb2-366"><a href="#cb2-366"></a>    <span class="fu">where</span>(is.factor),</span>
<span id="cb2-367"><a href="#cb2-367"></a>    <span class="fu">ends_with</span>(<span class="st">"_binary"</span>),</span>
<span id="cb2-368"><a href="#cb2-368"></a>    <span class="fu">ends_with</span>(<span class="st">"_lost_following_wave"</span>),</span>
<span id="cb2-369"><a href="#cb2-369"></a>    <span class="fu">ends_with</span>(<span class="st">"_z"</span>),</span>
<span id="cb2-370"><a href="#cb2-370"></a>    <span class="fu">ends_with</span>(<span class="st">"_weights"</span>),</span>
<span id="cb2-371"><a href="#cb2-371"></a>    <span class="fu">starts_with</span>(<span class="st">"t0_"</span>),</span>
<span id="cb2-372"><a href="#cb2-372"></a>    <span class="fu">starts_with</span>(<span class="st">"t1_"</span>),</span>
<span id="cb2-373"><a href="#cb2-373"></a>    <span class="fu">starts_with</span>(<span class="st">"t2_"</span>),</span>
<span id="cb2-374"><a href="#cb2-374"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb2-375"><a href="#cb2-375"></a>  <span class="fu">relocate</span>(<span class="fu">starts_with</span>(<span class="st">"t0_"</span>), <span class="at">.before =</span> <span class="fu">starts_with</span>(<span class="st">"t1_"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb2-376"><a href="#cb2-376"></a>  <span class="fu">relocate</span>(<span class="fu">starts_with</span>(<span class="st">"t1_"</span>), <span class="at">.before =</span> <span class="fu">starts_with</span>(<span class="st">"t2_"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb2-377"><a href="#cb2-377"></a>  <span class="fu">relocate</span>(<span class="st">"t0_not_lost_following_wave"</span>, <span class="at">.before =</span> <span class="fu">starts_with</span>(<span class="st">"t1_"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb2-378"><a href="#cb2-378"></a>  <span class="fu">relocate</span>(<span class="fu">all_of</span>(t1_name_exposure_binary), <span class="at">.before =</span> <span class="fu">starts_with</span>(<span class="st">"t2_"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb2-379"><a href="#cb2-379"></a>  <span class="fu">droplevels</span>()</span>
<span id="cb2-380"><a href="#cb2-380"></a></span>
<span id="cb2-381"><a href="#cb2-381"></a><span class="co"># save final data</span></span>
<span id="cb2-382"><a href="#cb2-382"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(df_grf, <span class="st">"df_grf"</span>)</span>
<span id="cb2-383"><a href="#cb2-383"></a></span>
<span id="cb2-384"><a href="#cb2-384"></a><span class="co"># check final dataset</span></span>
<span id="cb2-385"><a href="#cb2-385"></a><span class="co">#check</span></span>
<span id="cb2-386"><a href="#cb2-386"></a><span class="fu">colnames</span>(df_grf)</span>
<span id="cb2-387"><a href="#cb2-387"></a></span>
<span id="cb2-388"><a href="#cb2-388"></a><span class="co"># visualise missing</span></span>
<span id="cb2-389"><a href="#cb2-389"></a>naniar<span class="sc">::</span><span class="fu">vis_miss</span>(df_grf, <span class="at">warn_large_data =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-390"><a href="#cb2-390"></a></span>
<span id="cb2-391"><a href="#cb2-391"></a><span class="co"># check weights</span></span>
<span id="cb2-392"><a href="#cb2-392"></a>df_grf<span class="sc">$</span>t1_adjusted_weights</span>
<span id="cb2-393"><a href="#cb2-393"></a></span>
<span id="cb2-394"><a href="#cb2-394"></a><span class="co">#checks</span></span>
<span id="cb2-395"><a href="#cb2-395"></a><span class="fu">colnames</span>(df_grf)</span>
<span id="cb2-396"><a href="#cb2-396"></a><span class="fu">str</span>(df_grf)</span>
<span id="cb2-397"><a href="#cb2-397"></a></span>
<span id="cb2-398"><a href="#cb2-398"></a><span class="co"># check exposures</span></span>
<span id="cb2-399"><a href="#cb2-399"></a><span class="fu">table</span>(df_grf[[t1_name_exposure_binary]])</span>
<span id="cb2-400"><a href="#cb2-400"></a></span>
<span id="cb2-401"><a href="#cb2-401"></a><span class="co"># check</span></span>
<span id="cb2-402"><a href="#cb2-402"></a><span class="fu">hist</span>(df_grf<span class="sc">$</span>t1_adjusted_weights)</span>
<span id="cb2-403"><a href="#cb2-403"></a></span>
<span id="cb2-404"><a href="#cb2-404"></a><span class="co"># calculate summary statistics</span></span>
<span id="cb2-405"><a href="#cb2-405"></a>t0_weight_summary <span class="ot">&lt;-</span> <span class="fu">summary</span>(df_wide_encoded)</span>
<span id="cb2-406"><a href="#cb2-406"></a></span>
<span id="cb2-407"><a href="#cb2-407"></a><span class="co"># check</span></span>
<span id="cb2-408"><a href="#cb2-408"></a><span class="fu">glimpse</span>(df_grf<span class="sc">$</span>t0_adjusted_weights)</span>
<span id="cb2-409"><a href="#cb2-409"></a></span>
<span id="cb2-410"><a href="#cb2-410"></a><span class="co"># visualise weight distributions</span></span>
<span id="cb2-411"><a href="#cb2-411"></a><span class="fu">hist</span>(df_grf<span class="sc">$</span>t0_adjusted_weights, <span class="at">main =</span> <span class="st">"t0_stabalised weights"</span>, <span class="at">xlab =</span> <span class="st">"Weight"</span>)</span>
<span id="cb2-412"><a href="#cb2-412"></a></span>
<span id="cb2-413"><a href="#cb2-413"></a><span class="co"># visualise and check missing values</span></span>
<span id="cb2-414"><a href="#cb2-414"></a>naniar<span class="sc">::</span><span class="fu">vis_miss</span>(df_grf, <span class="at">warn_large_data =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-415"><a href="#cb2-415"></a>naniar<span class="sc">::</span><span class="fu">gg_miss_var</span>(df_grf)</span>
<span id="cb2-416"><a href="#cb2-416"></a>naniar<span class="sc">::</span><span class="fu">miss_var_summary</span>(dat_long_prepare) <span class="sc">|&gt;</span> <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">100</span>)</span>
<span id="cb2-417"><a href="#cb2-417"></a></span>
<span id="cb2-418"><a href="#cb2-418"></a><span class="co"># check n</span></span>
<span id="cb2-419"><a href="#cb2-419"></a>n_observed_grf <span class="ot">&lt;-</span> <span class="fu">nrow</span>(df_grf)</span>
<span id="cb2-420"><a href="#cb2-420"></a></span>
<span id="cb2-421"><a href="#cb2-421"></a><span class="co"># view</span></span>
<span id="cb2-422"><a href="#cb2-422"></a>n_observed_grf</span>
<span id="cb2-423"><a href="#cb2-423"></a></span>
<span id="cb2-424"><a href="#cb2-424"></a><span class="co"># save</span></span>
<span id="cb2-425"><a href="#cb2-425"></a>margot<span class="sc">::</span><span class="fu">here_save</span>(n_observed_grf, <span class="st">"n_observed_grf"</span>)</span>
<span id="cb2-426"><a href="#cb2-426"></a></span>
<span id="cb2-427"><a href="#cb2-427"></a></span>
<span id="cb2-428"><a href="#cb2-428"></a><span class="co"># inspect propensity scores -----------------------------------------------</span></span>
<span id="cb2-429"><a href="#cb2-429"></a><span class="co"># get data # read in if needed</span></span>
<span id="cb2-430"><a href="#cb2-430"></a><span class="co"># df_grf &lt;- here_read('df_grf')</span></span>
<span id="cb2-431"><a href="#cb2-431"></a></span>
<span id="cb2-432"><a href="#cb2-432"></a><span class="co"># assign weights var name</span></span>
<span id="cb2-433"><a href="#cb2-433"></a>weights_var_name <span class="ot">=</span> <span class="st">"t0_adjusted_weights"</span></span>
<span id="cb2-434"><a href="#cb2-434"></a></span>
<span id="cb2-435"><a href="#cb2-435"></a><span class="co"># baseline covariates  # E already exists and is defined</span></span>
<span id="cb2-436"><a href="#cb2-436"></a>E</span>
<span id="cb2-437"><a href="#cb2-437"></a></span>
<span id="cb2-438"><a href="#cb2-438"></a><span class="co"># must be a data frame, no NA in exposure</span></span>
<span id="cb2-439"><a href="#cb2-439"></a></span>
<span id="cb2-440"><a href="#cb2-440"></a><span class="co"># df_grf is a data frame - we must process this data frame in several steps</span></span>
<span id="cb2-441"><a href="#cb2-441"></a><span class="co"># user to specify which columns are outcomes, default to 'starts_with("t2_")'</span></span>
<span id="cb2-442"><a href="#cb2-442"></a>df_propensity_org <span class="ot">&lt;-</span> df_grf <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">!</span><span class="fu">starts_with</span>(<span class="st">"t2_"</span>))</span>
<span id="cb2-443"><a href="#cb2-443"></a></span>
<span id="cb2-444"><a href="#cb2-444"></a><span class="co"># Remove NAs and print message that this has been done</span></span>
<span id="cb2-445"><a href="#cb2-445"></a>df_propensity <span class="ot">&lt;-</span> df_propensity_org <span class="sc">|&gt;</span> <span class="fu">drop_na</span>() <span class="sc">|&gt;</span> <span class="fu">droplevels</span>()</span>
<span id="cb2-446"><a href="#cb2-446"></a></span>
<span id="cb2-447"><a href="#cb2-447"></a><span class="co"># first run model for baseline propensity if this is selected.  The default should be to not select it.</span></span>
<span id="cb2-448"><a href="#cb2-448"></a>propensity_model_and_plots <span class="ot">&lt;-</span> <span class="fu">margot_propensity_model_and_plots</span>(</span>
<span id="cb2-449"><a href="#cb2-449"></a>  <span class="at">df_propensity =</span> df_propensity,</span>
<span id="cb2-450"><a href="#cb2-450"></a>  <span class="at">exposure_variable =</span> t1_name_exposure_binary,</span>
<span id="cb2-451"><a href="#cb2-451"></a>  <span class="at">baseline_vars =</span> E,</span>
<span id="cb2-452"><a href="#cb2-452"></a>  <span class="at">weights_var_name =</span> weights_var_name,</span>
<span id="cb2-453"><a href="#cb2-453"></a>  <span class="at">estimand =</span> <span class="st">"ATE"</span>,</span>
<span id="cb2-454"><a href="#cb2-454"></a>  <span class="at">method =</span> <span class="st">"ebal"</span>,</span>
<span id="cb2-455"><a href="#cb2-455"></a>  <span class="at">focal =</span> <span class="cn">NULL</span></span>
<span id="cb2-456"><a href="#cb2-456"></a>)</span>
<span id="cb2-457"><a href="#cb2-457"></a></span>
<span id="cb2-458"><a href="#cb2-458"></a><span class="co"># visualise</span></span>
<span id="cb2-459"><a href="#cb2-459"></a><span class="fu">summary</span>(propensity_model_and_plots<span class="sc">$</span>match_propensity)</span>
<span id="cb2-460"><a href="#cb2-460"></a></span>
<span id="cb2-461"><a href="#cb2-461"></a><span class="co"># key plot</span></span>
<span id="cb2-462"><a href="#cb2-462"></a>propensity_model_and_plots<span class="sc">$</span>love_plot</span>
<span id="cb2-463"><a href="#cb2-463"></a></span>
<span id="cb2-464"><a href="#cb2-464"></a><span class="co"># other diagnostic plots</span></span>
<span id="cb2-465"><a href="#cb2-465"></a>propensity_model_and_plots<span class="sc">$</span>summary_plot</span>
<span id="cb2-466"><a href="#cb2-466"></a>propensity_model_and_plots<span class="sc">$</span>balance_table</span>
<span id="cb2-467"><a href="#cb2-467"></a>propensity_model_and_plots<span class="sc">$</span>diagnostics</span>
<span id="cb2-468"><a href="#cb2-468"></a></span>
<span id="cb2-469"><a href="#cb2-469"></a></span>
<span id="cb2-470"><a href="#cb2-470"></a><span class="co"># check size</span></span>
<span id="cb2-471"><a href="#cb2-471"></a>size_bytes <span class="ot">&lt;-</span> <span class="fu">object.size</span>(propensity_model_and_plots)</span>
<span id="cb2-472"><a href="#cb2-472"></a><span class="fu">print</span>(size_bytes, <span class="at">units =</span> <span class="st">"auto"</span>) <span class="co"># Mb</span></span>
<span id="cb2-473"><a href="#cb2-473"></a></span>
<span id="cb2-474"><a href="#cb2-474"></a><span class="co"># use qs to save only if you have space</span></span>
<span id="cb2-475"><a href="#cb2-475"></a><span class="fu">here_save_qs</span>(propensity_model_and_plots,</span>
<span id="cb2-476"><a href="#cb2-476"></a>             <span class="st">"propensity_model_and_plots"</span>,</span>
<span id="cb2-477"><a href="#cb2-477"></a>             push_mods)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="script-3" class="level3">
<h3 class="anchored" data-anchor-id="script-3">Script 3</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># 03-estimating-models-grf</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="co"># joseph.bulbulia@vuw.ac.nz</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="co"># april 2025</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="co"># devtools::load_all("/Users/joseph/GIT/margot/") # use version &gt;= 1.0.21 </span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="co"># for information on causal forests see: </span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="co"># https://grf-labs.github.io/grf/</span></span>
<span id="cb3-7"><a href="#cb3-7"></a></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="co"># ** </span><span class="al">NOTE</span><span class="co"> THESE DATA ARE SIMULATED SO RESULTS ARE NOT INTERPRETABLE **</span></span>
<span id="cb3-9"><a href="#cb3-9"></a></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="co"># restart fresh session</span></span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="co">#rstudioapi::restartSession()</span></span>
<span id="cb3-12"><a href="#cb3-12"></a></span>
<span id="cb3-13"><a href="#cb3-13"></a><span class="co"># set reproducibility</span></span>
<span id="cb3-14"><a href="#cb3-14"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb3-15"><a href="#cb3-15"></a></span>
<span id="cb3-16"><a href="#cb3-16"></a></span>
<span id="cb3-17"><a href="#cb3-17"></a><span class="co"># save paths -------------------------------------------------------------------</span></span>
<span id="cb3-18"><a href="#cb3-18"></a><span class="co"># create a save path to your on computer</span></span>
<span id="cb3-19"><a href="#cb3-19"></a><span class="co"># this is mine</span></span>
<span id="cb3-20"><a href="#cb3-20"></a><span class="co"># push_mods &lt;- here::here('/Users/joseph/v-project\ Dropbox/data/courses/25-psych-434')</span></span>
<span id="cb3-21"><a href="#cb3-21"></a><span class="co"># yours might be (after creating a data file)</span></span>
<span id="cb3-22"><a href="#cb3-22"></a></span>
<span id="cb3-23"><a href="#cb3-23"></a><span class="co"># data path</span></span>
<span id="cb3-24"><a href="#cb3-24"></a>push_mods <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>)</span>
<span id="cb3-25"><a href="#cb3-25"></a></span>
<span id="cb3-26"><a href="#cb3-26"></a></span>
<span id="cb3-27"><a href="#cb3-27"></a><span class="co"># load libraries ---------------------------------------------------------</span></span>
<span id="cb3-28"><a href="#cb3-28"></a><span class="co"># install and load 'margot' package</span></span>
<span id="cb3-29"><a href="#cb3-29"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(margot, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb3-30"><a href="#cb3-30"></a>  devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"go-bayes/margot"</span>)</span>
<span id="cb3-31"><a href="#cb3-31"></a>}</span>
<span id="cb3-32"><a href="#cb3-32"></a></span>
<span id="cb3-33"><a href="#cb3-33"></a><span class="co"># load margot library</span></span>
<span id="cb3-34"><a href="#cb3-34"></a><span class="fu">library</span>(margot)</span>
<span id="cb3-35"><a href="#cb3-35"></a></span>
<span id="cb3-36"><a href="#cb3-36"></a><span class="co"># load necessary libraries</span></span>
<span id="cb3-37"><a href="#cb3-37"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb3-38"><a href="#cb3-38"></a>  clarify,      <span class="co"># sensitivity analysis for causal inference</span></span>
<span id="cb3-39"><a href="#cb3-39"></a>  cobalt,       <span class="co"># covariate balance tables and plots</span></span>
<span id="cb3-40"><a href="#cb3-40"></a>  DiagrammeR,   <span class="co"># graph and network visualisation</span></span>
<span id="cb3-41"><a href="#cb3-41"></a>  doParallel,   <span class="co"># parallel processing with foreach</span></span>
<span id="cb3-42"><a href="#cb3-42"></a>  fastDummies,  <span class="co"># fast creation of dummy variables</span></span>
<span id="cb3-43"><a href="#cb3-43"></a>  fs,           <span class="co"># cross-platform file system operations</span></span>
<span id="cb3-44"><a href="#cb3-44"></a>  ggplot2,      <span class="co"># data visualisation</span></span>
<span id="cb3-45"><a href="#cb3-45"></a>  glmnet,       <span class="co"># lasso and elastic-net regularised models</span></span>
<span id="cb3-46"><a href="#cb3-46"></a>  grf,          <span class="co"># generalised random forests</span></span>
<span id="cb3-47"><a href="#cb3-47"></a>  gt,           <span class="co"># html tables for data frames</span></span>
<span id="cb3-48"><a href="#cb3-48"></a>  gtsummary,    <span class="co"># summary tables for regression models</span></span>
<span id="cb3-49"><a href="#cb3-49"></a>  here,         <span class="co"># simple and robust file referencing</span></span>
<span id="cb3-50"><a href="#cb3-50"></a>  janitor,      <span class="co"># data cleaning and validation</span></span>
<span id="cb3-51"><a href="#cb3-51"></a>  kableExtra,   <span class="co"># advanced table formatting</span></span>
<span id="cb3-52"><a href="#cb3-52"></a>  lmtp,         <span class="co"># longitudinal targeted maximum likelihood estimation</span></span>
<span id="cb3-53"><a href="#cb3-53"></a>  margot,       <span class="co"># functions for casual inference</span></span>
<span id="cb3-54"><a href="#cb3-54"></a>  MatchIt,      <span class="co"># matching methods for causal inference</span></span>
<span id="cb3-55"><a href="#cb3-55"></a>  MatchThem,    <span class="co"># matching methods for multiply imputed datasets</span></span>
<span id="cb3-56"><a href="#cb3-56"></a>  naniar,       <span class="co"># handling and visualisation of missing data</span></span>
<span id="cb3-57"><a href="#cb3-57"></a>  parameters,   <span class="co"># parameters and performance metrics</span></span>
<span id="cb3-58"><a href="#cb3-58"></a>  policytree,   <span class="co"># causal inference with policy trees</span></span>
<span id="cb3-59"><a href="#cb3-59"></a>  progressr,    <span class="co"># progress reporting for R</span></span>
<span id="cb3-60"><a href="#cb3-60"></a>  ranger,       <span class="co"># fast implementation of random forests</span></span>
<span id="cb3-61"><a href="#cb3-61"></a>  skimr,        <span class="co"># summary statistics for data frames</span></span>
<span id="cb3-62"><a href="#cb3-62"></a>  SuperLearner, <span class="co"># ensemble learning</span></span>
<span id="cb3-63"><a href="#cb3-63"></a>  tidyverse,    <span class="co"># collection of R packages for data science</span></span>
<span id="cb3-64"><a href="#cb3-64"></a>  WeightIt,     <span class="co"># weighting methods for covariate balancing</span></span>
<span id="cb3-65"><a href="#cb3-65"></a>  xgboost,      <span class="co"># extreme gradient boosting</span></span>
<span id="cb3-66"><a href="#cb3-66"></a>  EValue,       <span class="co"># compute Evalues</span></span>
<span id="cb3-67"><a href="#cb3-67"></a>  data.table,   <span class="co"># fast data wrangling</span></span>
<span id="cb3-68"><a href="#cb3-68"></a>  maq,          <span class="co"># qini curves</span></span>
<span id="cb3-69"><a href="#cb3-69"></a>  purrr,        <span class="co"># data wrangling</span></span>
<span id="cb3-70"><a href="#cb3-70"></a>  patchwork,    <span class="co"># multiple plots</span></span>
<span id="cb3-71"><a href="#cb3-71"></a>  labelled,     <span class="co"># allows working with labelled data (variable and value labels)</span></span>
<span id="cb3-72"><a href="#cb3-72"></a>  cli,          <span class="co"># tools for building command line interfaces</span></span>
<span id="cb3-73"><a href="#cb3-73"></a>  crayon,       <span class="co"># colored terminal output</span></span>
<span id="cb3-74"><a href="#cb3-74"></a>  rlang,        <span class="co"># tools for programming with R</span></span>
<span id="cb3-75"><a href="#cb3-75"></a>  kableExtra    <span class="co"># enhance kable output with additional formatting</span></span>
<span id="cb3-76"><a href="#cb3-76"></a>)</span>
<span id="cb3-77"><a href="#cb3-77"></a></span>
<span id="cb3-78"><a href="#cb3-78"></a></span>
<span id="cb3-79"><a href="#cb3-79"></a><span class="co"># variable names and labels -----------------------------------------------</span></span>
<span id="cb3-80"><a href="#cb3-80"></a><span class="co"># import exposure variable (binary) </span></span>
<span id="cb3-81"><a href="#cb3-81"></a>name_exposure <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"name_exposure"</span>)</span>
<span id="cb3-82"><a href="#cb3-82"></a>name_exposure</span>
<span id="cb3-83"><a href="#cb3-83"></a></span>
<span id="cb3-84"><a href="#cb3-84"></a><span class="co"># make exposure names</span></span>
<span id="cb3-85"><a href="#cb3-85"></a>t1_name_exposure_binary <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t1_"</span>, name_exposure, <span class="st">"_binary"</span>)</span>
<span id="cb3-86"><a href="#cb3-86"></a></span>
<span id="cb3-87"><a href="#cb3-87"></a><span class="co"># check exposure name</span></span>
<span id="cb3-88"><a href="#cb3-88"></a>t1_name_exposure_binary</span>
<span id="cb3-89"><a href="#cb3-89"></a></span>
<span id="cb3-90"><a href="#cb3-90"></a><span class="co"># read health outcomes </span></span>
<span id="cb3-91"><a href="#cb3-91"></a>raw_outcomes_health <span class="ot">&lt;-</span> <span class="fu">here_read</span>(<span class="st">"raw_outcomes_health"</span>)</span>
<span id="cb3-92"><a href="#cb3-92"></a>t2_outcome_health_z <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t2_"</span>, raw_outcomes_health, <span class="st">"_z"</span>)</span>
<span id="cb3-93"><a href="#cb3-93"></a>t2_outcome_health_z <span class="ot">&lt;-</span> <span class="fu">sort</span>(t2_outcome_health_z)</span>
<span id="cb3-94"><a href="#cb3-94"></a></span>
<span id="cb3-95"><a href="#cb3-95"></a><span class="co"># read raw outcomes </span></span>
<span id="cb3-96"><a href="#cb3-96"></a>raw_outcomes_psych <span class="ot">&lt;-</span> <span class="fu">here_read</span>(<span class="st">"raw_outcomes_psych"</span>)</span>
<span id="cb3-97"><a href="#cb3-97"></a>t2_outcome_psych_z <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t2_"</span>, raw_outcomes_psych, <span class="st">"_z"</span>)</span>
<span id="cb3-98"><a href="#cb3-98"></a>t2_outcome_psych_z <span class="ot">&lt;-</span> <span class="fu">sort</span>(t2_outcome_psych_z)</span>
<span id="cb3-99"><a href="#cb3-99"></a></span>
<span id="cb3-100"><a href="#cb3-100"></a><span class="co"># read raw outcomes</span></span>
<span id="cb3-101"><a href="#cb3-101"></a>raw_outcomes_present <span class="ot">&lt;-</span> <span class="fu">here_read</span>(<span class="st">"raw_outcomes_present"</span>)</span>
<span id="cb3-102"><a href="#cb3-102"></a>t2_outcome_present_z <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t2_"</span>, raw_outcomes_present, <span class="st">"_z"</span>)</span>
<span id="cb3-103"><a href="#cb3-103"></a>t2_outcome_present_z <span class="ot">&lt;-</span> <span class="fu">sort</span>(t2_outcome_present_z)</span>
<span id="cb3-104"><a href="#cb3-104"></a></span>
<span id="cb3-105"><a href="#cb3-105"></a><span class="co"># read raw outcomes</span></span>
<span id="cb3-106"><a href="#cb3-106"></a>raw_outcomes_life <span class="ot">&lt;-</span> <span class="fu">here_read</span>(<span class="st">"raw_outcomes_life"</span>)</span>
<span id="cb3-107"><a href="#cb3-107"></a>t2_outcome_life_z <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t2_"</span>, raw_outcomes_life, <span class="st">"_z"</span>)</span>
<span id="cb3-108"><a href="#cb3-108"></a>t2_outcome_life_z <span class="ot">&lt;-</span> <span class="fu">sort</span>(t2_outcome_life_z)</span>
<span id="cb3-109"><a href="#cb3-109"></a></span>
<span id="cb3-110"><a href="#cb3-110"></a><span class="co"># read raw outcomes</span></span>
<span id="cb3-111"><a href="#cb3-111"></a>raw_outcomes_social <span class="ot">&lt;-</span> <span class="fu">here_read</span>(<span class="st">"raw_outcomes_social"</span>)</span>
<span id="cb3-112"><a href="#cb3-112"></a>t2_outcome_social_z <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"t2_"</span>, raw_outcomes_social, <span class="st">"_z"</span>)</span>
<span id="cb3-113"><a href="#cb3-113"></a>t2_outcome_social_z <span class="ot">&lt;-</span> <span class="fu">sort</span>(t2_outcome_social_z)</span>
<span id="cb3-114"><a href="#cb3-114"></a></span>
<span id="cb3-115"><a href="#cb3-115"></a><span class="co"># combine all raww outcome names</span></span>
<span id="cb3-116"><a href="#cb3-116"></a>raw_outcomes_all <span class="ot">&lt;-</span> <span class="fu">c</span>(raw_outcomes_health, </span>
<span id="cb3-117"><a href="#cb3-117"></a>                      raw_outcomes_psych,</span>
<span id="cb3-118"><a href="#cb3-118"></a>                      raw_outcomes_present, </span>
<span id="cb3-119"><a href="#cb3-119"></a>                      raw_outcomes_life, </span>
<span id="cb3-120"><a href="#cb3-120"></a>                      raw_outcomes_social)</span>
<span id="cb3-121"><a href="#cb3-121"></a></span>
<span id="cb3-122"><a href="#cb3-122"></a><span class="co"># save all outcomes</span></span>
<span id="cb3-123"><a href="#cb3-123"></a><span class="fu">here_save</span>(raw_outcomes_all, <span class="st">"raw_outcomes_all"</span>)</span>
<span id="cb3-124"><a href="#cb3-124"></a></span>
<span id="cb3-125"><a href="#cb3-125"></a></span>
<span id="cb3-126"><a href="#cb3-126"></a><span class="co"># label mappings for health outcomes</span></span>
<span id="cb3-127"><a href="#cb3-127"></a>label_mapping_health <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-128"><a href="#cb3-128"></a>  <span class="st">"t2_alcohol_frequency"</span> <span class="ot">=</span> <span class="st">"Alcohol Frequency"</span>,</span>
<span id="cb3-129"><a href="#cb3-129"></a>  <span class="st">"t2_alcohol_intensity"</span> <span class="ot">=</span> <span class="st">"Alcohol Intensity"</span>,</span>
<span id="cb3-130"><a href="#cb3-130"></a>  <span class="st">"t2_hlth_bmi_z"</span> <span class="ot">=</span> <span class="st">"BMI"</span>, </span>
<span id="cb3-131"><a href="#cb3-131"></a>  <span class="st">"t2_hlth_sleep_hours_z"</span> <span class="ot">=</span> <span class="st">"Sleep"</span>, </span>
<span id="cb3-132"><a href="#cb3-132"></a>  <span class="st">"t2_log_hours_exercise_z"</span> <span class="ot">=</span> <span class="st">"Hours of Exercise (log)"</span>,</span>
<span id="cb3-133"><a href="#cb3-133"></a>  <span class="st">"t2_short_form_health_z"</span> <span class="ot">=</span> <span class="st">"Short Form Health"</span> </span>
<span id="cb3-134"><a href="#cb3-134"></a>)</span>
<span id="cb3-135"><a href="#cb3-135"></a></span>
<span id="cb3-136"><a href="#cb3-136"></a><span class="co"># label mappings for psychological well-being outcomes</span></span>
<span id="cb3-137"><a href="#cb3-137"></a>label_mapping_psych <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-138"><a href="#cb3-138"></a>  <span class="st">"t2_hlth_fatigue_z"</span> <span class="ot">=</span> <span class="st">"Fatigue"</span>, </span>
<span id="cb3-139"><a href="#cb3-139"></a>  <span class="st">"t2_kessler_latent_anxiety_z"</span> <span class="ot">=</span> <span class="st">"Anxiety"</span>, </span>
<span id="cb3-140"><a href="#cb3-140"></a>  <span class="st">"t2_kessler_latent_depression_z"</span> <span class="ot">=</span> <span class="st">"Depression"</span>,  </span>
<span id="cb3-141"><a href="#cb3-141"></a>  <span class="st">"t2_rumination_z"</span> <span class="ot">=</span> <span class="st">"Rumination"</span></span>
<span id="cb3-142"><a href="#cb3-142"></a>)</span>
<span id="cb3-143"><a href="#cb3-143"></a></span>
<span id="cb3-144"><a href="#cb3-144"></a><span class="co"># label mappings for present reflective outcomes</span></span>
<span id="cb3-145"><a href="#cb3-145"></a>label_mapping_present <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-146"><a href="#cb3-146"></a>  <span class="st">"t2_bodysat_z"</span> <span class="ot">=</span> <span class="st">"Body Satisfaction"</span>,</span>
<span id="cb3-147"><a href="#cb3-147"></a>  <span class="st">"t2_foregiveness_z"</span> <span class="ot">=</span> <span class="st">"Forgiveness"</span>,  </span>
<span id="cb3-148"><a href="#cb3-148"></a>  <span class="st">"t2_perfectionism_z"</span> <span class="ot">=</span> <span class="st">"Perfectionism"</span>,  </span>
<span id="cb3-149"><a href="#cb3-149"></a>  <span class="st">"t2_self_control_z"</span> <span class="ot">=</span> <span class="st">"Self Control"</span>,  </span>
<span id="cb3-150"><a href="#cb3-150"></a>  <span class="st">"t2_sexual_satisfaction_z"</span> <span class="ot">=</span> <span class="st">"Sexual Satisfaction"</span></span>
<span id="cb3-151"><a href="#cb3-151"></a>)</span>
<span id="cb3-152"><a href="#cb3-152"></a></span>
<span id="cb3-153"><a href="#cb3-153"></a><span class="co"># label mappings for life reflective outcomes</span></span>
<span id="cb3-154"><a href="#cb3-154"></a>label_mapping_life <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-155"><a href="#cb3-155"></a>  <span class="st">"t2_gratitude_z"</span> <span class="ot">=</span> <span class="st">"Gratitude"</span>, </span>
<span id="cb3-156"><a href="#cb3-156"></a>  <span class="st">"t2_lifesat_z"</span> <span class="ot">=</span> <span class="st">"Life Satisfaction"</span>, </span>
<span id="cb3-157"><a href="#cb3-157"></a>  <span class="st">"t2_meaning_purpose_z"</span> <span class="ot">=</span> <span class="st">"Meaning: Purpose"</span>,  </span>
<span id="cb3-158"><a href="#cb3-158"></a>  <span class="st">"t2_meaning_sense_z"</span> <span class="ot">=</span> <span class="st">"Meaning: Sense"</span>, </span>
<span id="cb3-159"><a href="#cb3-159"></a>  <span class="st">"t2_pwi_z"</span> <span class="ot">=</span> <span class="st">"Personal Well-being Index"</span></span>
<span id="cb3-160"><a href="#cb3-160"></a>)</span>
<span id="cb3-161"><a href="#cb3-161"></a></span>
<span id="cb3-162"><a href="#cb3-162"></a><span class="co"># label mappings for social outcomes</span></span>
<span id="cb3-163"><a href="#cb3-163"></a>label_mapping_social <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-164"><a href="#cb3-164"></a>  <span class="st">"t2_belong_z"</span> <span class="ot">=</span> <span class="st">"Social Belonging"</span>,</span>
<span id="cb3-165"><a href="#cb3-165"></a>  <span class="st">"t2_neighbourhood_community_z"</span> <span class="ot">=</span> <span class="st">"Neighbourhood Community"</span>, </span>
<span id="cb3-166"><a href="#cb3-166"></a>  <span class="st">"t2_support_z"</span> <span class="ot">=</span> <span class="st">"Social Support"</span> </span>
<span id="cb3-167"><a href="#cb3-167"></a>)</span>
<span id="cb3-168"><a href="#cb3-168"></a></span>
<span id="cb3-169"><a href="#cb3-169"></a><span class="co"># n participants (can be useful for graphs)</span></span>
<span id="cb3-170"><a href="#cb3-170"></a>n_participants <span class="ot">&lt;-</span> <span class="fu">here_read</span>(<span class="st">"n_participants"</span>)</span>
<span id="cb3-171"><a href="#cb3-171"></a></span>
<span id="cb3-172"><a href="#cb3-172"></a><span class="co"># label mapping all -------------------------------------------------------</span></span>
<span id="cb3-173"><a href="#cb3-173"></a>label_mapping_all <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb3-174"><a href="#cb3-174"></a>  label_mapping_health,</span>
<span id="cb3-175"><a href="#cb3-175"></a>  label_mapping_psych,</span>
<span id="cb3-176"><a href="#cb3-176"></a>  label_mapping_present,</span>
<span id="cb3-177"><a href="#cb3-177"></a>  label_mapping_life,</span>
<span id="cb3-178"><a href="#cb3-178"></a>  label_mapping_social</span>
<span id="cb3-179"><a href="#cb3-179"></a>)</span>
<span id="cb3-180"><a href="#cb3-180"></a></span>
<span id="cb3-181"><a href="#cb3-181"></a></span>
<span id="cb3-182"><a href="#cb3-182"></a><span class="co"># save label mappings -----------------------------------------------------</span></span>
<span id="cb3-183"><a href="#cb3-183"></a><span class="fu">here_save</span>(label_mapping_health, <span class="st">"label_mapping_health"</span>)</span>
<span id="cb3-184"><a href="#cb3-184"></a><span class="fu">here_save</span>(label_mapping_psych, <span class="st">"label_mapping_psych"</span>)</span>
<span id="cb3-185"><a href="#cb3-185"></a><span class="fu">here_save</span>(label_mapping_present, <span class="st">"label_mapping_present"</span>)</span>
<span id="cb3-186"><a href="#cb3-186"></a><span class="fu">here_save</span>(label_mapping_life, <span class="st">"label_mapping_life"</span>)</span>
<span id="cb3-187"><a href="#cb3-187"></a><span class="fu">here_save</span>(label_mapping_social, <span class="st">"label_mapping_social"</span>)</span>
<span id="cb3-188"><a href="#cb3-188"></a><span class="fu">here_save</span>(label_mapping_all, <span class="st">"label_mapping_all"</span>)</span>
<span id="cb3-189"><a href="#cb3-189"></a></span>
<span id="cb3-190"><a href="#cb3-190"></a><span class="co"># start analysis here ----------------------------------------------------</span></span>
<span id="cb3-191"><a href="#cb3-191"></a><span class="co"># import data</span></span>
<span id="cb3-192"><a href="#cb3-192"></a>df_grf <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">'df_grf'</span>)</span>
<span id="cb3-193"><a href="#cb3-193"></a></span>
<span id="cb3-194"><a href="#cb3-194"></a><span class="co"># check</span></span>
<span id="cb3-195"><a href="#cb3-195"></a><span class="fu">colnames</span>(df_grf)</span>
<span id="cb3-196"><a href="#cb3-196"></a></span>
<span id="cb3-197"><a href="#cb3-197"></a><span class="co"># read original dataframe / used to get measures on data scale</span></span>
<span id="cb3-198"><a href="#cb3-198"></a>original_df <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"df_wide"</span>, push_mods)</span>
<span id="cb3-199"><a href="#cb3-199"></a></span>
<span id="cb3-200"><a href="#cb3-200"></a><span class="co"># check missing values (baseline missingness is handled by grf)</span></span>
<span id="cb3-201"><a href="#cb3-201"></a><span class="co"># takes a long time to render so commented out</span></span>
<span id="cb3-202"><a href="#cb3-202"></a><span class="co"># naniar::vis_miss(df_grf, warn_large_data = FALSE)</span></span>
<span id="cb3-203"><a href="#cb3-203"></a></span>
<span id="cb3-204"><a href="#cb3-204"></a><span class="co"># check another way</span></span>
<span id="cb3-205"><a href="#cb3-205"></a>naniar<span class="sc">::</span><span class="fu">gg_miss_var</span>(df_grf)</span>
<span id="cb3-206"><a href="#cb3-206"></a></span>
<span id="cb3-207"><a href="#cb3-207"></a><span class="co"># import names of baseline covariates</span></span>
<span id="cb3-208"><a href="#cb3-208"></a>E <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"E"</span>)</span>
<span id="cb3-209"><a href="#cb3-209"></a><span class="co"># check</span></span>
<span id="cb3-210"><a href="#cb3-210"></a>E</span>
<span id="cb3-211"><a href="#cb3-211"></a></span>
<span id="cb3-212"><a href="#cb3-212"></a><span class="co"># exposure variable (we use the GRF convention where W is the exposure)</span></span>
<span id="cb3-213"><a href="#cb3-213"></a><span class="co"># *****SET ***************</span></span>
<span id="cb3-214"><a href="#cb3-214"></a><span class="co"># make binary</span></span>
<span id="cb3-215"><a href="#cb3-215"></a></span>
<span id="cb3-216"><a href="#cb3-216"></a><span class="co"># *********************************</span></span>
<span id="cb3-217"><a href="#cb3-217"></a><span class="co"># check that variables are 0 or 1</span></span>
<span id="cb3-218"><a href="#cb3-218"></a>df_grf[[t1_name_exposure_binary]]</span>
<span id="cb3-219"><a href="#cb3-219"></a><span class="co"># *********************************</span></span>
<span id="cb3-220"><a href="#cb3-220"></a></span>
<span id="cb3-221"><a href="#cb3-221"></a><span class="co"># needs to be a matrix</span></span>
<span id="cb3-222"><a href="#cb3-222"></a>W <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(df_grf[[t1_name_exposure_binary]])</span>
<span id="cb3-223"><a href="#cb3-223"></a></span>
<span id="cb3-224"><a href="#cb3-224"></a><span class="co"># check that these values are 0 or 1</span></span>
<span id="cb3-225"><a href="#cb3-225"></a>W</span>
<span id="cb3-226"><a href="#cb3-226"></a></span>
<span id="cb3-227"><a href="#cb3-227"></a><span class="co"># set weights</span></span>
<span id="cb3-228"><a href="#cb3-228"></a>weights <span class="ot">&lt;-</span> df_grf<span class="sc">$</span>t1_adjusted_weights </span>
<span id="cb3-229"><a href="#cb3-229"></a></span>
<span id="cb3-230"><a href="#cb3-230"></a><span class="co"># view/ check none too extreme</span></span>
<span id="cb3-231"><a href="#cb3-231"></a><span class="fu">hist</span>(weights)</span>
<span id="cb3-232"><a href="#cb3-232"></a></span>
<span id="cb3-233"><a href="#cb3-233"></a><span class="co"># remove attributes of baseline co-variaties</span></span>
<span id="cb3-234"><a href="#cb3-234"></a>X <span class="ot">&lt;-</span>  margot<span class="sc">::</span><span class="fu">remove_numeric_attributes</span>(df_grf[E]) </span>
<span id="cb3-235"><a href="#cb3-235"></a></span>
<span id="cb3-236"><a href="#cb3-236"></a><span class="co"># set parameters ----------------------------------------------------------</span></span>
<span id="cb3-237"><a href="#cb3-237"></a><span class="co"># set model defaults -----------------------------------------------------</span></span>
<span id="cb3-238"><a href="#cb3-238"></a>grf_defaults <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-239"><a href="#cb3-239"></a>  <span class="at">seed =</span> <span class="dv">123</span>, <span class="co"># reproduce results</span></span>
<span id="cb3-240"><a href="#cb3-240"></a>  <span class="at">stabilize.splits =</span> <span class="cn">TRUE</span>, <span class="co"># robustness</span></span>
<span id="cb3-241"><a href="#cb3-241"></a>  <span class="co"># min.node.size = 5,  # default is five/ requires at least 5 observed in control and treated</span></span>
<span id="cb3-242"><a href="#cb3-242"></a>  <span class="co"># set higher for greater smoothing</span></span>
<span id="cb3-243"><a href="#cb3-243"></a>  <span class="at">num.trees =</span> <span class="dv">2000</span> <span class="co"># grf default = 2000 # set lower or higher depending on storage</span></span>
<span id="cb3-244"><a href="#cb3-244"></a>)</span>
<span id="cb3-245"><a href="#cb3-245"></a></span>
<span id="cb3-246"><a href="#cb3-246"></a><span class="co"># set defaults for graphs (see bottom of script for options)</span></span>
<span id="cb3-247"><a href="#cb3-247"></a>decision_tree_defaults <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-248"><a href="#cb3-248"></a>  <span class="at">span_ratio =</span> .<span class="dv">3</span>,</span>
<span id="cb3-249"><a href="#cb3-249"></a>  <span class="at">text_size =</span> <span class="fl">3.8</span>,</span>
<span id="cb3-250"><a href="#cb3-250"></a>  <span class="at">y_padding =</span> <span class="fl">0.25</span>  <span class="co"># use full parameter name</span></span>
<span id="cb3-251"><a href="#cb3-251"></a>  <span class="co"># edge_label_offset = .002, # options</span></span>
<span id="cb3-252"><a href="#cb3-252"></a>  <span class="co"># border_size = .05</span></span>
<span id="cb3-253"><a href="#cb3-253"></a>)</span>
<span id="cb3-254"><a href="#cb3-254"></a></span>
<span id="cb3-255"><a href="#cb3-255"></a><span class="co"># set defaults for graphs (see bottom of script for options)</span></span>
<span id="cb3-256"><a href="#cb3-256"></a><span class="co"># set policy tree defaults</span></span>
<span id="cb3-257"><a href="#cb3-257"></a>policy_tree_defaults <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-258"><a href="#cb3-258"></a>  <span class="at">point_alpha =</span> .<span class="dv">5</span>,</span>
<span id="cb3-259"><a href="#cb3-259"></a>  <span class="at">title_size =</span> <span class="dv">12</span>,</span>
<span id="cb3-260"><a href="#cb3-260"></a>  <span class="at">subtitle_size =</span> <span class="dv">14</span>,</span>
<span id="cb3-261"><a href="#cb3-261"></a>  <span class="at">axis_title_size =</span> <span class="dv">14</span>,</span>
<span id="cb3-262"><a href="#cb3-262"></a>  <span class="at">legend_title_size =</span> <span class="dv">14</span>,</span>
<span id="cb3-263"><a href="#cb3-263"></a>  <span class="at">split_line_color =</span> <span class="st">"red"</span>,</span>
<span id="cb3-264"><a href="#cb3-264"></a>  <span class="at">split_line_alpha =</span> <span class="fl">0.8</span>,</span>
<span id="cb3-265"><a href="#cb3-265"></a>  <span class="at">split_label_color =</span> <span class="st">"red"</span></span>
<span id="cb3-266"><a href="#cb3-266"></a>)</span>
<span id="cb3-267"><a href="#cb3-267"></a></span>
<span id="cb3-268"><a href="#cb3-268"></a><span class="co"># test --------------------------------------------------------------------</span></span>
<span id="cb3-269"><a href="#cb3-269"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X) <span class="co"># n in sample</span></span>
<span id="cb3-270"><a href="#cb3-270"></a></span>
<span id="cb3-271"><a href="#cb3-271"></a><span class="co"># define training sample</span></span>
<span id="cb3-272"><a href="#cb3-272"></a>toy <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>n, n <span class="sc">/</span> <span class="dv">4</span>) <span class="co"># get half sample</span></span>
<span id="cb3-273"><a href="#cb3-273"></a></span>
<span id="cb3-274"><a href="#cb3-274"></a><span class="co"># test data</span></span>
<span id="cb3-275"><a href="#cb3-275"></a>toy_data <span class="ot">=</span> df_grf[toy, ]</span>
<span id="cb3-276"><a href="#cb3-276"></a></span>
<span id="cb3-277"><a href="#cb3-277"></a><span class="co"># check</span></span>
<span id="cb3-278"><a href="#cb3-278"></a><span class="fu">nrow</span>(toy_data)</span>
<span id="cb3-279"><a href="#cb3-279"></a></span>
<span id="cb3-280"><a href="#cb3-280"></a><span class="co"># test covariates</span></span>
<span id="cb3-281"><a href="#cb3-281"></a>X_toy <span class="ot">=</span> X[toy, ]</span>
<span id="cb3-282"><a href="#cb3-282"></a></span>
<span id="cb3-283"><a href="#cb3-283"></a><span class="co"># check</span></span>
<span id="cb3-284"><a href="#cb3-284"></a><span class="fu">str</span>(X_toy)</span>
<span id="cb3-285"><a href="#cb3-285"></a></span>
<span id="cb3-286"><a href="#cb3-286"></a><span class="co"># test exposure</span></span>
<span id="cb3-287"><a href="#cb3-287"></a>W_toy <span class="ot">=</span> W[toy]</span>
<span id="cb3-288"><a href="#cb3-288"></a></span>
<span id="cb3-289"><a href="#cb3-289"></a><span class="co"># test weights</span></span>
<span id="cb3-290"><a href="#cb3-290"></a>weights_toy <span class="ot">=</span> weights[toy]</span>
<span id="cb3-291"><a href="#cb3-291"></a></span>
<span id="cb3-292"><a href="#cb3-292"></a><span class="co"># # test model</span></span>
<span id="cb3-293"><a href="#cb3-293"></a><span class="co"># ignore warnings</span></span>
<span id="cb3-294"><a href="#cb3-294"></a>cf.test <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_causal_forest</span>(</span>
<span id="cb3-295"><a href="#cb3-295"></a>  <span class="at">data          =</span> toy_data,</span>
<span id="cb3-296"><a href="#cb3-296"></a>  <span class="at">outcome_vars  =</span> <span class="st">"t2_log_hours_exercise_z"</span>,</span>
<span id="cb3-297"><a href="#cb3-297"></a>  <span class="at">covariates    =</span> X_toy,</span>
<span id="cb3-298"><a href="#cb3-298"></a>  <span class="at">W             =</span> W_toy,</span>
<span id="cb3-299"><a href="#cb3-299"></a>  <span class="at">weights       =</span> weights_toy,</span>
<span id="cb3-300"><a href="#cb3-300"></a>  <span class="at">top_n_vars =</span> <span class="dv">15</span>,</span>
<span id="cb3-301"><a href="#cb3-301"></a>  <span class="at">save_models =</span> <span class="cn">TRUE</span> <span class="co"># save the models</span></span>
<span id="cb3-302"><a href="#cb3-302"></a>)</span>
<span id="cb3-303"><a href="#cb3-303"></a></span>
<span id="cb3-304"><a href="#cb3-304"></a><span class="co"># test plots</span></span>
<span id="cb3-305"><a href="#cb3-305"></a>models_binary_batch_test <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_policy</span>(</span>
<span id="cb3-306"><a href="#cb3-306"></a>  cf.test,</span>
<span id="cb3-307"><a href="#cb3-307"></a>  <span class="at">save_plots =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-308"><a href="#cb3-308"></a>  <span class="at">output_dir =</span> here<span class="sc">::</span><span class="fu">here</span>(push_mods),</span>
<span id="cb3-309"><a href="#cb3-309"></a>  <span class="at">decision_tree_args =</span> decision_tree_defaults,</span>
<span id="cb3-310"><a href="#cb3-310"></a>  <span class="at">policy_tree_args =</span> policy_tree_defaults,</span>
<span id="cb3-311"><a href="#cb3-311"></a>  <span class="at">model_names =</span> <span class="st">"model_t2_log_hours_exercise_z"</span>,</span>
<span id="cb3-312"><a href="#cb3-312"></a>  <span class="at">original_df =</span> original_df,</span>
<span id="cb3-313"><a href="#cb3-313"></a>  <span class="at">label_mapping =</span> label_mapping_psych</span>
<span id="cb3-314"><a href="#cb3-314"></a>)</span>
<span id="cb3-315"><a href="#cb3-315"></a></span>
<span id="cb3-316"><a href="#cb3-316"></a><span class="co"># test plots</span></span>
<span id="cb3-317"><a href="#cb3-317"></a>models_binary_batch_test<span class="sc">$</span>model_t2_log_hours_exercise_z<span class="sc">$</span>qini_plot</span>
<span id="cb3-318"><a href="#cb3-318"></a>models_binary_batch_test<span class="sc">$</span>model_t2_log_hours_exercise_z<span class="sc">$</span>decision_tree</span>
<span id="cb3-319"><a href="#cb3-319"></a>models_binary_batch_test<span class="sc">$</span>model_t2_log_hours_exercise_z<span class="sc">$</span>policy_tree</span>
<span id="cb3-320"><a href="#cb3-320"></a></span>
<span id="cb3-321"><a href="#cb3-321"></a></span>
<span id="cb3-322"><a href="#cb3-322"></a><span class="co"># run binary model --------------------------------------------------------</span></span>
<span id="cb3-323"><a href="#cb3-323"></a><span class="co"># health models -----------------------------------------------------------</span></span>
<span id="cb3-324"><a href="#cb3-324"></a>models_binary_health <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_causal_forest</span>(</span>
<span id="cb3-325"><a href="#cb3-325"></a>  <span class="at">data =</span> df_grf,</span>
<span id="cb3-326"><a href="#cb3-326"></a>  <span class="at">outcome_vars =</span> t2_outcome_health_z,</span>
<span id="cb3-327"><a href="#cb3-327"></a>  <span class="at">covariates =</span> X,</span>
<span id="cb3-328"><a href="#cb3-328"></a>  <span class="at">W =</span> W,</span>
<span id="cb3-329"><a href="#cb3-329"></a>  <span class="at">weights =</span> weights,</span>
<span id="cb3-330"><a href="#cb3-330"></a>  <span class="at">grf_defaults =</span> grf_defaults,</span>
<span id="cb3-331"><a href="#cb3-331"></a>  <span class="at">top_n_vars =</span> <span class="dv">15</span>,</span>
<span id="cb3-332"><a href="#cb3-332"></a>  <span class="at">save_models =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-333"><a href="#cb3-333"></a>  <span class="at">train_proportion =</span> <span class="fl">0.7</span></span>
<span id="cb3-334"><a href="#cb3-334"></a>)</span>
<span id="cb3-335"><a href="#cb3-335"></a></span>
<span id="cb3-336"><a href="#cb3-336"></a><span class="co"># check size if needed</span></span>
<span id="cb3-337"><a href="#cb3-337"></a>margot<span class="sc">::</span><span class="fu">margot_size</span>(models_binary_health)</span>
<span id="cb3-338"><a href="#cb3-338"></a></span>
<span id="cb3-339"><a href="#cb3-339"></a><span class="co"># save model</span></span>
<span id="cb3-340"><a href="#cb3-340"></a>margot<span class="sc">::</span><span class="fu">here_save_qs</span>(models_binary_health, <span class="st">"models_binary_health"</span>, push_mods)</span>
<span id="cb3-341"><a href="#cb3-341"></a></span>
<span id="cb3-342"><a href="#cb3-342"></a><span class="co"># psych models ------------------------------------------------------------</span></span>
<span id="cb3-343"><a href="#cb3-343"></a>models_binary_psych <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_causal_forest</span>(</span>
<span id="cb3-344"><a href="#cb3-344"></a>  <span class="at">data =</span> df_grf,</span>
<span id="cb3-345"><a href="#cb3-345"></a>  <span class="at">outcome_vars =</span> t2_outcome_psych_z,</span>
<span id="cb3-346"><a href="#cb3-346"></a>  <span class="at">covariates =</span> X,</span>
<span id="cb3-347"><a href="#cb3-347"></a>  <span class="at">W =</span> W,</span>
<span id="cb3-348"><a href="#cb3-348"></a>  <span class="at">weights =</span> weights,</span>
<span id="cb3-349"><a href="#cb3-349"></a>  <span class="at">grf_defaults =</span> grf_defaults,</span>
<span id="cb3-350"><a href="#cb3-350"></a>  <span class="at">top_n_vars =</span> <span class="dv">15</span>,</span>
<span id="cb3-351"><a href="#cb3-351"></a>  <span class="at">save_models =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-352"><a href="#cb3-352"></a>  <span class="at">train_proportion =</span> <span class="fl">0.7</span></span>
<span id="cb3-353"><a href="#cb3-353"></a>)</span>
<span id="cb3-354"><a href="#cb3-354"></a></span>
<span id="cb3-355"><a href="#cb3-355"></a><span class="co"># save model</span></span>
<span id="cb3-356"><a href="#cb3-356"></a>margot<span class="sc">::</span><span class="fu">here_save_qs</span>(models_binary_psych, <span class="st">"models_binary_psych"</span>, push_mods)</span>
<span id="cb3-357"><a href="#cb3-357"></a></span>
<span id="cb3-358"><a href="#cb3-358"></a></span>
<span id="cb3-359"><a href="#cb3-359"></a><span class="co"># present models ----------------------------------------------------------</span></span>
<span id="cb3-360"><a href="#cb3-360"></a>models_binary_present <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_causal_forest</span>(</span>
<span id="cb3-361"><a href="#cb3-361"></a>  <span class="at">data =</span> df_grf,</span>
<span id="cb3-362"><a href="#cb3-362"></a>  <span class="at">outcome_vars =</span> t2_outcome_present_z,</span>
<span id="cb3-363"><a href="#cb3-363"></a>  <span class="at">covariates =</span> X,</span>
<span id="cb3-364"><a href="#cb3-364"></a>  <span class="at">W =</span> W,</span>
<span id="cb3-365"><a href="#cb3-365"></a>  <span class="at">weights =</span> weights,</span>
<span id="cb3-366"><a href="#cb3-366"></a>  <span class="at">grf_defaults =</span> grf_defaults,</span>
<span id="cb3-367"><a href="#cb3-367"></a>  <span class="at">top_n_vars =</span> <span class="dv">15</span>,</span>
<span id="cb3-368"><a href="#cb3-368"></a>  <span class="at">save_models =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-369"><a href="#cb3-369"></a>  <span class="at">train_proportion =</span> <span class="fl">0.7</span></span>
<span id="cb3-370"><a href="#cb3-370"></a>)</span>
<span id="cb3-371"><a href="#cb3-371"></a><span class="co"># save model</span></span>
<span id="cb3-372"><a href="#cb3-372"></a>margot<span class="sc">::</span><span class="fu">here_save_qs</span>(models_binary_present, <span class="st">"models_binary_present"</span>, push_mods)</span>
<span id="cb3-373"><a href="#cb3-373"></a></span>
<span id="cb3-374"><a href="#cb3-374"></a></span>
<span id="cb3-375"><a href="#cb3-375"></a><span class="co"># life models -------------------------------------------------------------</span></span>
<span id="cb3-376"><a href="#cb3-376"></a>models_binary_life <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_causal_forest</span>(</span>
<span id="cb3-377"><a href="#cb3-377"></a>  <span class="at">data =</span> df_grf,</span>
<span id="cb3-378"><a href="#cb3-378"></a>  <span class="at">outcome_vars =</span> t2_outcome_life_z,</span>
<span id="cb3-379"><a href="#cb3-379"></a>  <span class="at">covariates =</span> X,</span>
<span id="cb3-380"><a href="#cb3-380"></a>  <span class="at">W =</span> W,</span>
<span id="cb3-381"><a href="#cb3-381"></a>  <span class="at">weights =</span> weights,</span>
<span id="cb3-382"><a href="#cb3-382"></a>  <span class="at">grf_defaults =</span> grf_defaults,</span>
<span id="cb3-383"><a href="#cb3-383"></a>  <span class="at">top_n_vars =</span> <span class="dv">15</span>,</span>
<span id="cb3-384"><a href="#cb3-384"></a>  <span class="at">save_models =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-385"><a href="#cb3-385"></a>  <span class="at">train_proportion =</span> <span class="fl">0.7</span></span>
<span id="cb3-386"><a href="#cb3-386"></a>)</span>
<span id="cb3-387"><a href="#cb3-387"></a></span>
<span id="cb3-388"><a href="#cb3-388"></a><span class="co"># save model</span></span>
<span id="cb3-389"><a href="#cb3-389"></a>margot<span class="sc">::</span><span class="fu">here_save_qs</span>(models_binary_life, <span class="st">"models_binary_life"</span>, push_mods)</span>
<span id="cb3-390"><a href="#cb3-390"></a></span>
<span id="cb3-391"><a href="#cb3-391"></a></span>
<span id="cb3-392"><a href="#cb3-392"></a><span class="co"># social models -----------------------------------------------------------</span></span>
<span id="cb3-393"><a href="#cb3-393"></a>models_binary_social <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_causal_forest</span>(</span>
<span id="cb3-394"><a href="#cb3-394"></a>  <span class="at">data =</span> df_grf,</span>
<span id="cb3-395"><a href="#cb3-395"></a>  <span class="at">outcome_vars =</span> t2_outcome_social_z,</span>
<span id="cb3-396"><a href="#cb3-396"></a>  <span class="at">covariates =</span> X,</span>
<span id="cb3-397"><a href="#cb3-397"></a>  <span class="at">W =</span> W,</span>
<span id="cb3-398"><a href="#cb3-398"></a>  <span class="at">weights =</span> weights,</span>
<span id="cb3-399"><a href="#cb3-399"></a>  <span class="at">grf_defaults =</span> grf_defaults,</span>
<span id="cb3-400"><a href="#cb3-400"></a>  <span class="at">top_n_vars =</span> <span class="dv">15</span>,</span>
<span id="cb3-401"><a href="#cb3-401"></a>  <span class="at">save_models =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-402"><a href="#cb3-402"></a>  <span class="at">train_proportion =</span> <span class="fl">0.7</span></span>
<span id="cb3-403"><a href="#cb3-403"></a>)</span>
<span id="cb3-404"><a href="#cb3-404"></a></span>
<span id="cb3-405"><a href="#cb3-405"></a><span class="co"># save model</span></span>
<span id="cb3-406"><a href="#cb3-406"></a>margot<span class="sc">::</span><span class="fu">here_save_qs</span>(models_binary_social, <span class="st">"models_binary_social"</span>, push_mods)</span>
<span id="cb3-407"><a href="#cb3-407"></a></span>
<span id="cb3-408"><a href="#cb3-408"></a><span class="co"># graphs ------------------------------------------------------------------</span></span>
<span id="cb3-409"><a href="#cb3-409"></a><span class="co"># plot defaults -----------------------------------------------------------</span></span>
<span id="cb3-410"><a href="#cb3-410"></a>title_binary <span class="ot">=</span> <span class="st">"Community Socialising (binary)"</span></span>
<span id="cb3-411"><a href="#cb3-411"></a>filename_prefix <span class="ot">=</span> <span class="st">"grf_extraversion_wb"</span></span>
<span id="cb3-412"><a href="#cb3-412"></a></span>
<span id="cb3-413"><a href="#cb3-413"></a><span class="co"># titles</span></span>
<span id="cb3-414"><a href="#cb3-414"></a>subtitle_health <span class="ot">=</span> <span class="st">"Health"</span></span>
<span id="cb3-415"><a href="#cb3-415"></a>subtitle_psych <span class="ot">=</span> <span class="st">"Psychological Well-being"</span></span>
<span id="cb3-416"><a href="#cb3-416"></a>subtitle_present <span class="ot">=</span> <span class="st">"Present-Focussed Well-being"</span></span>
<span id="cb3-417"><a href="#cb3-417"></a>subtitle_life <span class="ot">=</span> <span class="st">"Life-Focussed Well-being"</span></span>
<span id="cb3-418"><a href="#cb3-418"></a>subtitle_social <span class="ot">=</span> <span class="st">"Social Well-being"</span></span>
<span id="cb3-419"><a href="#cb3-419"></a></span>
<span id="cb3-420"><a href="#cb3-420"></a><span class="co"># defaults</span></span>
<span id="cb3-421"><a href="#cb3-421"></a>base_defaults_binary <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-422"><a href="#cb3-422"></a>  <span class="at">type =</span> <span class="st">"RD"</span>,</span>
<span id="cb3-423"><a href="#cb3-423"></a>  <span class="at">title =</span> title_binary,</span>
<span id="cb3-424"><a href="#cb3-424"></a>  <span class="at">e_val_bound_threshold =</span> <span class="fl">1.2</span>,</span>
<span id="cb3-425"><a href="#cb3-425"></a>  <span class="at">colors =</span> <span class="fu">c</span>(</span>
<span id="cb3-426"><a href="#cb3-426"></a>    <span class="st">"positive"</span> <span class="ot">=</span> <span class="st">"#E69F00"</span>,</span>
<span id="cb3-427"><a href="#cb3-427"></a>    <span class="st">"not reliable"</span> <span class="ot">=</span> <span class="st">"grey50"</span>,</span>
<span id="cb3-428"><a href="#cb3-428"></a>    <span class="st">"negative"</span> <span class="ot">=</span> <span class="st">"#56B4E9"</span></span>
<span id="cb3-429"><a href="#cb3-429"></a>  ),</span>
<span id="cb3-430"><a href="#cb3-430"></a>  <span class="at">x_offset =</span> <span class="sc">-</span>.<span class="dv">275</span>,</span>
<span id="cb3-431"><a href="#cb3-431"></a>  <span class="co"># will be set based on type</span></span>
<span id="cb3-432"><a href="#cb3-432"></a>  <span class="at">x_lim_lo =</span> <span class="sc">-</span>.<span class="dv">275</span>,</span>
<span id="cb3-433"><a href="#cb3-433"></a>  <span class="co"># will be set based on type</span></span>
<span id="cb3-434"><a href="#cb3-434"></a>  <span class="at">x_lim_hi =</span> .<span class="dv">275</span>,</span>
<span id="cb3-435"><a href="#cb3-435"></a>  <span class="at">text_size =</span> <span class="dv">4</span>,</span>
<span id="cb3-436"><a href="#cb3-436"></a>  <span class="at">linewidth =</span> <span class="fl">0.5</span>,</span>
<span id="cb3-437"><a href="#cb3-437"></a>  <span class="at">estimate_scale =</span> <span class="dv">1</span>,</span>
<span id="cb3-438"><a href="#cb3-438"></a>  <span class="at">base_size =</span> <span class="dv">18</span>,</span>
<span id="cb3-439"><a href="#cb3-439"></a>  <span class="at">point_size =</span> <span class="dv">2</span>,</span>
<span id="cb3-440"><a href="#cb3-440"></a>  <span class="at">title_size =</span> <span class="dv">19</span>,</span>
<span id="cb3-441"><a href="#cb3-441"></a>  <span class="at">subtitle_size =</span> <span class="dv">16</span>,</span>
<span id="cb3-442"><a href="#cb3-442"></a>  <span class="at">legend_text_size =</span> <span class="dv">10</span>,</span>
<span id="cb3-443"><a href="#cb3-443"></a>  <span class="at">legend_title_size =</span> <span class="dv">10</span>,</span>
<span id="cb3-444"><a href="#cb3-444"></a>  <span class="at">include_coefficients =</span> <span class="cn">FALSE</span></span>
<span id="cb3-445"><a href="#cb3-445"></a>)</span>
<span id="cb3-446"><a href="#cb3-446"></a></span>
<span id="cb3-447"><a href="#cb3-447"></a><span class="co"># set options for graphs</span></span>
<span id="cb3-448"><a href="#cb3-448"></a><span class="co"># health graph options</span></span>
<span id="cb3-449"><a href="#cb3-449"></a>outcomes_options_health <span class="ot">&lt;-</span> <span class="fu">margot_plot_create_options</span>(</span>
<span id="cb3-450"><a href="#cb3-450"></a>  <span class="at">title =</span> subtitle_health,</span>
<span id="cb3-451"><a href="#cb3-451"></a>  <span class="at">base_defaults =</span> base_defaults_binary,</span>
<span id="cb3-452"><a href="#cb3-452"></a>  <span class="at">subtitle =</span> <span class="st">""</span>,</span>
<span id="cb3-453"><a href="#cb3-453"></a>  <span class="at">filename_prefix =</span> filename_prefix)</span>
<span id="cb3-454"><a href="#cb3-454"></a></span>
<span id="cb3-455"><a href="#cb3-455"></a><span class="co"># psych graph options</span></span>
<span id="cb3-456"><a href="#cb3-456"></a>outcomes_options_psych <span class="ot">&lt;-</span> <span class="fu">margot_plot_create_options</span>(</span>
<span id="cb3-457"><a href="#cb3-457"></a>  <span class="at">title =</span> subtitle_psych,</span>
<span id="cb3-458"><a href="#cb3-458"></a>  <span class="at">base_defaults =</span> base_defaults_binary,</span>
<span id="cb3-459"><a href="#cb3-459"></a>  <span class="at">subtitle =</span> <span class="st">""</span>,</span>
<span id="cb3-460"><a href="#cb3-460"></a>  <span class="at">filename_prefix =</span> filename_prefix)</span>
<span id="cb3-461"><a href="#cb3-461"></a></span>
<span id="cb3-462"><a href="#cb3-462"></a></span>
<span id="cb3-463"><a href="#cb3-463"></a><span class="co"># present graph options ---------------------------------------------------</span></span>
<span id="cb3-464"><a href="#cb3-464"></a>outcomes_options_present <span class="ot">&lt;-</span> <span class="fu">margot_plot_create_options</span>(</span>
<span id="cb3-465"><a href="#cb3-465"></a>  <span class="at">title =</span> subtitle_present,</span>
<span id="cb3-466"><a href="#cb3-466"></a>  <span class="at">base_defaults =</span> base_defaults_binary,</span>
<span id="cb3-467"><a href="#cb3-467"></a>  <span class="at">subtitle =</span> <span class="st">""</span>,</span>
<span id="cb3-468"><a href="#cb3-468"></a>  <span class="at">filename_prefix =</span> filename_prefix)</span>
<span id="cb3-469"><a href="#cb3-469"></a></span>
<span id="cb3-470"><a href="#cb3-470"></a></span>
<span id="cb3-471"><a href="#cb3-471"></a><span class="co"># life graph options ------------------------------------------------------</span></span>
<span id="cb3-472"><a href="#cb3-472"></a>outcomes_options_life <span class="ot">&lt;-</span> <span class="fu">margot_plot_create_options</span>(</span>
<span id="cb3-473"><a href="#cb3-473"></a>  <span class="at">title =</span> subtitle_life,</span>
<span id="cb3-474"><a href="#cb3-474"></a>  <span class="at">base_defaults =</span> base_defaults_binary,</span>
<span id="cb3-475"><a href="#cb3-475"></a>  <span class="at">subtitle =</span> <span class="st">""</span>,</span>
<span id="cb3-476"><a href="#cb3-476"></a>  <span class="at">filename_prefix =</span> filename_prefix)</span>
<span id="cb3-477"><a href="#cb3-477"></a></span>
<span id="cb3-478"><a href="#cb3-478"></a></span>
<span id="cb3-479"><a href="#cb3-479"></a><span class="co"># social graph options ----------------------------------------------------</span></span>
<span id="cb3-480"><a href="#cb3-480"></a>outcomes_options_social <span class="ot">&lt;-</span> <span class="fu">margot_plot_create_options</span>(</span>
<span id="cb3-481"><a href="#cb3-481"></a>  <span class="at">title =</span> subtitle_social,</span>
<span id="cb3-482"><a href="#cb3-482"></a>  <span class="at">base_defaults =</span> base_defaults_binary,</span>
<span id="cb3-483"><a href="#cb3-483"></a>  <span class="at">subtitle =</span> <span class="st">""</span>,</span>
<span id="cb3-484"><a href="#cb3-484"></a>  <span class="at">filename_prefix =</span> filename_prefix)</span>
<span id="cb3-485"><a href="#cb3-485"></a></span>
<span id="cb3-486"><a href="#cb3-486"></a><span class="co"># all graph options ------------------------------------------------------</span></span>
<span id="cb3-487"><a href="#cb3-487"></a>options_all_models <span class="ot">&lt;-</span> <span class="fu">margot_plot_create_options</span>(</span>
<span id="cb3-488"><a href="#cb3-488"></a>  <span class="at">title =</span> <span class="st">"Outcomewide Wellbeing"</span>,</span>
<span id="cb3-489"><a href="#cb3-489"></a>  <span class="at">base_defaults =</span> base_defaults_binary,</span>
<span id="cb3-490"><a href="#cb3-490"></a>  <span class="at">subtitle =</span> <span class="st">""</span>,</span>
<span id="cb3-491"><a href="#cb3-491"></a>  <span class="at">filename_prefix =</span> filename_prefix)</span>
<span id="cb3-492"><a href="#cb3-492"></a></span>
<span id="cb3-493"><a href="#cb3-493"></a></span>
<span id="cb3-494"><a href="#cb3-494"></a><span class="co"># make graphs -------------------------------------------------------------</span></span>
<span id="cb3-495"><a href="#cb3-495"></a><span class="co"># read results</span></span>
<span id="cb3-496"><a href="#cb3-496"></a><span class="co"># warning: reading models will take time</span></span>
<span id="cb3-497"><a href="#cb3-497"></a><span class="co"># import</span></span>
<span id="cb3-498"><a href="#cb3-498"></a>models_binary_health <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read_qs</span>(<span class="st">"models_binary_health"</span>, push_mods)</span>
<span id="cb3-499"><a href="#cb3-499"></a>models_binary_psych <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read_qs</span>(<span class="st">"models_binary_psych"</span>, push_mods)</span>
<span id="cb3-500"><a href="#cb3-500"></a>models_binary_present <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read_qs</span>(<span class="st">"models_binary_present"</span>, push_mods)</span>
<span id="cb3-501"><a href="#cb3-501"></a>models_binary_life <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read_qs</span>(<span class="st">"models_binary_life"</span>, push_mods)</span>
<span id="cb3-502"><a href="#cb3-502"></a>models_binary_social <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read_qs</span>(<span class="st">"models_binary_social"</span>, push_mods)</span>
<span id="cb3-503"><a href="#cb3-503"></a></span>
<span id="cb3-504"><a href="#cb3-504"></a><span class="co"># check size (example)</span></span>
<span id="cb3-505"><a href="#cb3-505"></a>margot<span class="sc">::</span><span class="fu">margot_size</span>(models_binary_health)</span>
<span id="cb3-506"><a href="#cb3-506"></a></span>
<span id="cb3-507"><a href="#cb3-507"></a><span class="co"># make ATE plots ----------------------------------------------------------</span></span>
<span id="cb3-508"><a href="#cb3-508"></a><span class="co"># health plots ------------------------------------------------------------</span></span>
<span id="cb3-509"><a href="#cb3-509"></a>binary_results_health <span class="ot">&lt;-</span> <span class="fu">margot_plot</span>(</span>
<span id="cb3-510"><a href="#cb3-510"></a>  models_binary_health<span class="sc">$</span>combined_table,</span>
<span id="cb3-511"><a href="#cb3-511"></a>  <span class="at">options =</span> outcomes_options_health,</span>
<span id="cb3-512"><a href="#cb3-512"></a>  <span class="at">label_mapping =</span> label_mapping_health,</span>
<span id="cb3-513"><a href="#cb3-513"></a>  <span class="at">include_coefficients =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-514"><a href="#cb3-514"></a>  <span class="at">save_output =</span> <span class="cn">FALSE</span>, </span>
<span id="cb3-515"><a href="#cb3-515"></a>  <span class="at">order =</span> <span class="st">"evaluebound_asc"</span>,</span>
<span id="cb3-516"><a href="#cb3-516"></a>  <span class="at">original_df =</span> original_df,</span>
<span id="cb3-517"><a href="#cb3-517"></a>  <span class="at">e_val_bound_threshold =</span> <span class="fl">1.2</span></span>
<span id="cb3-518"><a href="#cb3-518"></a>)</span>
<span id="cb3-519"><a href="#cb3-519"></a></span>
<span id="cb3-520"><a href="#cb3-520"></a><span class="co"># view</span></span>
<span id="cb3-521"><a href="#cb3-521"></a>binary_results_health<span class="sc">$</span>transformed_table <span class="sc">|&gt;</span> <span class="fu">rename</span>(</span>
<span id="cb3-522"><a href="#cb3-522"></a>  <span class="st">"E-Value"</span> <span class="ot">=</span> <span class="st">"E_Value"</span>,</span>
<span id="cb3-523"><a href="#cb3-523"></a>  <span class="st">"E-Value bound"</span> <span class="ot">=</span> <span class="st">"E_Val_bound"</span></span>
<span id="cb3-524"><a href="#cb3-524"></a>) <span class="sc">|&gt;</span></span>
<span id="cb3-525"><a href="#cb3-525"></a>  <span class="fu">kbl</span>(<span class="at">format =</span> <span class="st">'markdown'</span>)</span>
<span id="cb3-526"><a href="#cb3-526"></a></span>
<span id="cb3-527"><a href="#cb3-527"></a><span class="co"># check</span></span>
<span id="cb3-528"><a href="#cb3-528"></a><span class="fu">cat</span>(binary_results_health<span class="sc">$</span>interpretation)</span>
<span id="cb3-529"><a href="#cb3-529"></a></span>
<span id="cb3-530"><a href="#cb3-530"></a><span class="co"># interpretation</span></span>
<span id="cb3-531"><a href="#cb3-531"></a><span class="fu">cat</span>(binary_results_health<span class="sc">$</span>interpretation)</span>
<span id="cb3-532"><a href="#cb3-532"></a></span>
<span id="cb3-533"><a href="#cb3-533"></a><span class="co"># plot psych</span></span>
<span id="cb3-534"><a href="#cb3-534"></a>binary_results_psych_asc <span class="ot">&lt;-</span> <span class="fu">margot_plot</span>(</span>
<span id="cb3-535"><a href="#cb3-535"></a>  models_binary_psych<span class="sc">$</span>combined_table,</span>
<span id="cb3-536"><a href="#cb3-536"></a>  <span class="at">options =</span> outcomes_options_psych,</span>
<span id="cb3-537"><a href="#cb3-537"></a>  <span class="at">label_mapping =</span> label_mapping_psych,</span>
<span id="cb3-538"><a href="#cb3-538"></a>  <span class="at">include_coefficients =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-539"><a href="#cb3-539"></a>  <span class="at">save_output =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-540"><a href="#cb3-540"></a>  <span class="at">original_df =</span> original_df,</span>
<span id="cb3-541"><a href="#cb3-541"></a>  <span class="at">e_val_bound_threshold =</span> <span class="fl">1.2</span>,</span>
<span id="cb3-542"><a href="#cb3-542"></a>  <span class="at">order =</span> <span class="st">"evaluebound_asc"</span>)</span>
<span id="cb3-543"><a href="#cb3-543"></a></span>
<span id="cb3-544"><a href="#cb3-544"></a></span>
<span id="cb3-545"><a href="#cb3-545"></a><span class="co"># order</span></span>
<span id="cb3-546"><a href="#cb3-546"></a>binary_results_psych_asc<span class="sc">$</span>plot</span>
<span id="cb3-547"><a href="#cb3-547"></a></span>
<span id="cb3-548"><a href="#cb3-548"></a><span class="co"># reorder for descriptions</span></span>
<span id="cb3-549"><a href="#cb3-549"></a>binary_results_psych <span class="ot">&lt;-</span> <span class="fu">margot_plot</span>(</span>
<span id="cb3-550"><a href="#cb3-550"></a>  models_binary_psych<span class="sc">$</span>combined_table,</span>
<span id="cb3-551"><a href="#cb3-551"></a>  <span class="at">options =</span> outcomes_options_psych,</span>
<span id="cb3-552"><a href="#cb3-552"></a>  <span class="at">label_mapping =</span> label_mapping_psych,</span>
<span id="cb3-553"><a href="#cb3-553"></a>  <span class="at">include_coefficients =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-554"><a href="#cb3-554"></a>  <span class="at">save_output =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-555"><a href="#cb3-555"></a>  <span class="at">e_val_bound_threshold =</span> <span class="fl">1.2</span>,</span>
<span id="cb3-556"><a href="#cb3-556"></a>  <span class="at">original_df =</span> original_df,</span>
<span id="cb3-557"><a href="#cb3-557"></a>  <span class="at">order =</span> <span class="st">"evaluebound_asc"</span></span>
<span id="cb3-558"><a href="#cb3-558"></a>)</span>
<span id="cb3-559"><a href="#cb3-559"></a></span>
<span id="cb3-560"><a href="#cb3-560"></a><span class="co"># table</span></span>
<span id="cb3-561"><a href="#cb3-561"></a>binary_results_psych<span class="sc">$</span>transformed_table <span class="sc">|&gt;</span> <span class="fu">rename</span>(</span>
<span id="cb3-562"><a href="#cb3-562"></a>  <span class="st">"E-Value"</span> <span class="ot">=</span> <span class="st">"E_Value"</span>,</span>
<span id="cb3-563"><a href="#cb3-563"></a>  <span class="st">"E-Value bound"</span> <span class="ot">=</span> <span class="st">"E_Val_bound"</span></span>
<span id="cb3-564"><a href="#cb3-564"></a>) <span class="sc">|&gt;</span></span>
<span id="cb3-565"><a href="#cb3-565"></a>  <span class="fu">kbl</span>(<span class="at">format =</span> <span class="st">'markdown'</span>)</span>
<span id="cb3-566"><a href="#cb3-566"></a></span>
<span id="cb3-567"><a href="#cb3-567"></a><span class="co"># interpretation</span></span>
<span id="cb3-568"><a href="#cb3-568"></a><span class="fu">cat</span>(binary_results_psych<span class="sc">$</span>interpretation)</span>
<span id="cb3-569"><a href="#cb3-569"></a></span>
<span id="cb3-570"><a href="#cb3-570"></a><span class="co"># plot present</span></span>
<span id="cb3-571"><a href="#cb3-571"></a><span class="co"># order</span></span>
<span id="cb3-572"><a href="#cb3-572"></a>binary_results_present <span class="ot">&lt;-</span> <span class="fu">margot_plot</span>(</span>
<span id="cb3-573"><a href="#cb3-573"></a>  models_binary_present<span class="sc">$</span>combined_table,</span>
<span id="cb3-574"><a href="#cb3-574"></a>  <span class="at">options =</span> outcomes_options_present,</span>
<span id="cb3-575"><a href="#cb3-575"></a>  <span class="at">label_mapping =</span> label_mapping_present,</span>
<span id="cb3-576"><a href="#cb3-576"></a>  <span class="at">include_coefficients =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-577"><a href="#cb3-577"></a>  <span class="at">save_output =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-578"><a href="#cb3-578"></a>  <span class="at">original_df =</span> original_df,</span>
<span id="cb3-579"><a href="#cb3-579"></a>  <span class="at">order =</span> <span class="st">"evaluebound_asc"</span></span>
<span id="cb3-580"><a href="#cb3-580"></a>)</span>
<span id="cb3-581"><a href="#cb3-581"></a></span>
<span id="cb3-582"><a href="#cb3-582"></a><span class="co"># plot</span></span>
<span id="cb3-583"><a href="#cb3-583"></a>binary_results_present<span class="sc">$</span>plot</span>
<span id="cb3-584"><a href="#cb3-584"></a></span>
<span id="cb3-585"><a href="#cb3-585"></a><span class="co"># interpretation</span></span>
<span id="cb3-586"><a href="#cb3-586"></a><span class="fu">cat</span>(binary_results_present<span class="sc">$</span>interpretation)</span>
<span id="cb3-587"><a href="#cb3-587"></a>(binary_results_present<span class="sc">$</span>transformed_table)</span>
<span id="cb3-588"><a href="#cb3-588"></a></span>
<span id="cb3-589"><a href="#cb3-589"></a><span class="co"># plot life</span></span>
<span id="cb3-590"><a href="#cb3-590"></a>binary_results_life <span class="ot">&lt;-</span> <span class="fu">margot_plot</span>(</span>
<span id="cb3-591"><a href="#cb3-591"></a>  models_binary_life<span class="sc">$</span>combined_table,</span>
<span id="cb3-592"><a href="#cb3-592"></a>  <span class="at">options =</span> outcomes_options_life,</span>
<span id="cb3-593"><a href="#cb3-593"></a>  <span class="at">label_mapping =</span> label_mapping_life,</span>
<span id="cb3-594"><a href="#cb3-594"></a>  <span class="at">include_coefficients =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-595"><a href="#cb3-595"></a>  <span class="at">save_output =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-596"><a href="#cb3-596"></a>  <span class="at">order =</span> <span class="st">"evaluebound_asc"</span>,</span>
<span id="cb3-597"><a href="#cb3-597"></a>  <span class="at">original_df =</span> original_df</span>
<span id="cb3-598"><a href="#cb3-598"></a>)</span>
<span id="cb3-599"><a href="#cb3-599"></a></span>
<span id="cb3-600"><a href="#cb3-600"></a><span class="co"># table</span></span>
<span id="cb3-601"><a href="#cb3-601"></a>binary_results_life<span class="sc">$</span>transformed_table <span class="sc">|&gt;</span> <span class="fu">rename</span>(</span>
<span id="cb3-602"><a href="#cb3-602"></a>  <span class="st">"E-Value"</span> <span class="ot">=</span> <span class="st">"E_Value"</span>,</span>
<span id="cb3-603"><a href="#cb3-603"></a>  <span class="st">"E-Value bound"</span> <span class="ot">=</span> <span class="st">"E_Val_bound"</span></span>
<span id="cb3-604"><a href="#cb3-604"></a>) <span class="sc">|&gt;</span></span>
<span id="cb3-605"><a href="#cb3-605"></a>  <span class="fu">kbl</span>(<span class="at">format =</span> <span class="st">'markdown'</span>)</span>
<span id="cb3-606"><a href="#cb3-606"></a></span>
<span id="cb3-607"><a href="#cb3-607"></a><span class="co"># plot</span></span>
<span id="cb3-608"><a href="#cb3-608"></a>binary_results_life<span class="sc">$</span>transformed_table</span>
<span id="cb3-609"><a href="#cb3-609"></a></span>
<span id="cb3-610"><a href="#cb3-610"></a><span class="co"># interpretation</span></span>
<span id="cb3-611"><a href="#cb3-611"></a><span class="fu">cat</span>(binary_results_life<span class="sc">$</span>interpretation)</span>
<span id="cb3-612"><a href="#cb3-612"></a></span>
<span id="cb3-613"><a href="#cb3-613"></a><span class="co"># plot social</span></span>
<span id="cb3-614"><a href="#cb3-614"></a>binary_results_social <span class="ot">&lt;-</span> <span class="fu">margot_plot</span>(</span>
<span id="cb3-615"><a href="#cb3-615"></a>  models_binary_social<span class="sc">$</span>combined_table,</span>
<span id="cb3-616"><a href="#cb3-616"></a>  <span class="at">options =</span> outcomes_options_social,</span>
<span id="cb3-617"><a href="#cb3-617"></a>  <span class="at">label_mapping =</span> label_mapping_social,</span>
<span id="cb3-618"><a href="#cb3-618"></a>  <span class="at">include_coefficients =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-619"><a href="#cb3-619"></a>  <span class="at">save_output =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-620"><a href="#cb3-620"></a>  <span class="at">original_df =</span> original_df,</span>
<span id="cb3-621"><a href="#cb3-621"></a>  <span class="at">order =</span> <span class="st">"evaluebound_asc"</span></span>
<span id="cb3-622"><a href="#cb3-622"></a>)</span>
<span id="cb3-623"><a href="#cb3-623"></a></span>
<span id="cb3-624"><a href="#cb3-624"></a><span class="co"># table</span></span>
<span id="cb3-625"><a href="#cb3-625"></a>binary_results_social<span class="sc">$</span>transformed_table <span class="sc">|&gt;</span> <span class="fu">rename</span>(</span>
<span id="cb3-626"><a href="#cb3-626"></a>  <span class="st">"E-Value"</span> <span class="ot">=</span> <span class="st">"E_Value"</span>,</span>
<span id="cb3-627"><a href="#cb3-627"></a>  <span class="st">"E-Value bound"</span> <span class="ot">=</span> <span class="st">"E_Val_bound"</span></span>
<span id="cb3-628"><a href="#cb3-628"></a>) <span class="sc">|&gt;</span></span>
<span id="cb3-629"><a href="#cb3-629"></a>  <span class="fu">kbl</span>(<span class="at">format =</span> <span class="st">'markdown'</span>)</span>
<span id="cb3-630"><a href="#cb3-630"></a></span>
<span id="cb3-631"><a href="#cb3-631"></a><span class="co"># interpretation</span></span>
<span id="cb3-632"><a href="#cb3-632"></a><span class="fu">cat</span>(binary_results_social<span class="sc">$</span>interpretation)</span>
<span id="cb3-633"><a href="#cb3-633"></a></span>
<span id="cb3-634"><a href="#cb3-634"></a></span>
<span id="cb3-635"><a href="#cb3-635"></a><span class="co"># combine ate plots ------------------------------------------------------</span></span>
<span id="cb3-636"><a href="#cb3-636"></a><span class="co"># plot_ate_health &lt;- binary_results_health_asc$plot</span></span>
<span id="cb3-637"><a href="#cb3-637"></a><span class="co"># plot_ate_psych &lt;- binary_results_psych_asc$plot</span></span>
<span id="cb3-638"><a href="#cb3-638"></a><span class="co"># plot_ate_present &lt;- binary_results_present_asc$plot</span></span>
<span id="cb3-639"><a href="#cb3-639"></a><span class="co"># plot_ate_life &lt;- binary_results_life_asc$plot</span></span>
<span id="cb3-640"><a href="#cb3-640"></a><span class="co"># plot_ate_social &lt;- binary_results_social_asc$plot</span></span>
<span id="cb3-641"><a href="#cb3-641"></a><span class="co"># </span></span>
<span id="cb3-642"><a href="#cb3-642"></a><span class="co"># </span></span>
<span id="cb3-643"><a href="#cb3-643"></a><span class="co"># </span></span>
<span id="cb3-644"><a href="#cb3-644"></a><span class="co"># # create combined plot with annotations</span></span>
<span id="cb3-645"><a href="#cb3-645"></a><span class="co"># ate_plots_combined &lt;- plot_ate_health + </span></span>
<span id="cb3-646"><a href="#cb3-646"></a><span class="co">#   plot_ate_psych + </span></span>
<span id="cb3-647"><a href="#cb3-647"></a><span class="co">#   plot_ate_present + </span></span>
<span id="cb3-648"><a href="#cb3-648"></a><span class="co">#   plot_ate_life + </span></span>
<span id="cb3-649"><a href="#cb3-649"></a><span class="co">#   plot_ate_social +</span></span>
<span id="cb3-650"><a href="#cb3-650"></a><span class="co">#   plot_annotation(</span></span>
<span id="cb3-651"><a href="#cb3-651"></a><span class="co">#     title = title_binary,</span></span>
<span id="cb3-652"><a href="#cb3-652"></a><span class="co">#     tag_levels = "A",</span></span>
<span id="cb3-653"><a href="#cb3-653"></a><span class="co">#     theme = theme(</span></span>
<span id="cb3-654"><a href="#cb3-654"></a><span class="co">#       plot.title = element_text(size = 20),</span></span>
<span id="cb3-655"><a href="#cb3-655"></a><span class="co">#       legend.position = "top"</span></span>
<span id="cb3-656"><a href="#cb3-656"></a><span class="co">#     )</span></span>
<span id="cb3-657"><a href="#cb3-657"></a><span class="co">#   ) +</span></span>
<span id="cb3-658"><a href="#cb3-658"></a><span class="co">#   plot_layout(guides = "collect")</span></span>
<span id="cb3-659"><a href="#cb3-659"></a><span class="co"># </span></span>
<span id="cb3-660"><a href="#cb3-660"></a><span class="co"># # view combined plot</span></span>
<span id="cb3-661"><a href="#cb3-661"></a><span class="co"># ate_plots_combined</span></span>
<span id="cb3-662"><a href="#cb3-662"></a></span>
<span id="cb3-663"><a href="#cb3-663"></a><span class="co"># combine all models -----------------------------------------------------</span></span>
<span id="cb3-664"><a href="#cb3-664"></a><span class="co"># merge all domain models into single object</span></span>
<span id="cb3-665"><a href="#cb3-665"></a>all_models <span class="ot">&lt;-</span> <span class="fu">margot_bind_models</span>(</span>
<span id="cb3-666"><a href="#cb3-666"></a>  models_binary_health,</span>
<span id="cb3-667"><a href="#cb3-667"></a>  models_binary_psych,</span>
<span id="cb3-668"><a href="#cb3-668"></a>  models_binary_present,</span>
<span id="cb3-669"><a href="#cb3-669"></a>  models_binary_life,</span>
<span id="cb3-670"><a href="#cb3-670"></a>  models_binary_social</span>
<span id="cb3-671"><a href="#cb3-671"></a>)</span>
<span id="cb3-672"><a href="#cb3-672"></a></span>
<span id="cb3-673"><a href="#cb3-673"></a></span>
<span id="cb3-674"><a href="#cb3-674"></a><span class="co"># graph</span></span>
<span id="cb3-675"><a href="#cb3-675"></a>plot_all_models <span class="ot">&lt;-</span> <span class="fu">margot_plot</span>(</span>
<span id="cb3-676"><a href="#cb3-676"></a>  all_models<span class="sc">$</span>combined_table,</span>
<span id="cb3-677"><a href="#cb3-677"></a>  <span class="at">options =</span> options_all_models,</span>
<span id="cb3-678"><a href="#cb3-678"></a>  <span class="at">save_output =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-679"><a href="#cb3-679"></a>  <span class="at">e_val_bound_threshold =</span> <span class="fl">1.2</span>,</span>
<span id="cb3-680"><a href="#cb3-680"></a>  <span class="at">label_mapping =</span> label_mapping_all,</span>
<span id="cb3-681"><a href="#cb3-681"></a>  <span class="at">save_path =</span> here<span class="sc">::</span><span class="fu">here</span>(push_mods),</span>
<span id="cb3-682"><a href="#cb3-682"></a>  <span class="at">original_df =</span> original_df,</span>
<span id="cb3-683"><a href="#cb3-683"></a>  <span class="at">include_coefficients =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-684"><a href="#cb3-684"></a>  <span class="at">order =</span> <span class="st">"evaluebound_asc"</span></span>
<span id="cb3-685"><a href="#cb3-685"></a>)</span>
<span id="cb3-686"><a href="#cb3-686"></a></span>
<span id="cb3-687"><a href="#cb3-687"></a><span class="co"># view plot</span></span>
<span id="cb3-688"><a href="#cb3-688"></a>plot_all_models<span class="sc">$</span>plot</span>
<span id="cb3-689"><a href="#cb3-689"></a></span>
<span id="cb3-690"><a href="#cb3-690"></a><span class="co"># interpretation</span></span>
<span id="cb3-691"><a href="#cb3-691"></a><span class="fu">cat</span>(plot_all_models<span class="sc">$</span>interpretation)</span>
<span id="cb3-692"><a href="#cb3-692"></a></span>
<span id="cb3-693"><a href="#cb3-693"></a><span class="co"># table</span></span>
<span id="cb3-694"><a href="#cb3-694"></a>plot_all_models<span class="sc">$</span>transformed_table</span>
<span id="cb3-695"><a href="#cb3-695"></a></span>
<span id="cb3-696"><a href="#cb3-696"></a><span class="co"># nice table</span></span>
<span id="cb3-697"><a href="#cb3-697"></a>tables_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-698"><a href="#cb3-698"></a>  <span class="at">Health =</span> binary_results_health<span class="sc">$</span>transformed_table,</span>
<span id="cb3-699"><a href="#cb3-699"></a>  <span class="at">Psych =</span> binary_results_psych<span class="sc">$</span>transformed_table,</span>
<span id="cb3-700"><a href="#cb3-700"></a>  <span class="at">Present =</span> binary_results_present<span class="sc">$</span>transformed_table,</span>
<span id="cb3-701"><a href="#cb3-701"></a>  <span class="at">Life =</span> binary_results_life<span class="sc">$</span>transformed_table,</span>
<span id="cb3-702"><a href="#cb3-702"></a>  <span class="at">Social =</span> binary_results_social<span class="sc">$</span>transformed_table</span>
<span id="cb3-703"><a href="#cb3-703"></a>)</span>
<span id="cb3-704"><a href="#cb3-704"></a></span>
<span id="cb3-705"><a href="#cb3-705"></a>margot_bind_tables_markdown <span class="ot">&lt;-</span> <span class="fu">margot_bind_tables</span>(</span>
<span id="cb3-706"><a href="#cb3-706"></a>  <span class="at">tables_list =</span> tables_list, <span class="co">#list(all_models$combined_table),</span></span>
<span id="cb3-707"><a href="#cb3-707"></a>  <span class="at">sort_E_val_bound =</span> <span class="st">"desc"</span>,</span>
<span id="cb3-708"><a href="#cb3-708"></a>  <span class="at">e_val_bound_threshold =</span> <span class="fl">1.2</span>,</span>
<span id="cb3-709"><a href="#cb3-709"></a>  <span class="at">highlight_color =</span> <span class="cn">NULL</span>,</span>
<span id="cb3-710"><a href="#cb3-710"></a>  <span class="at">bold =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-711"><a href="#cb3-711"></a>  <span class="at">rename_cols =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-712"><a href="#cb3-712"></a>  <span class="at">col_renames =</span> <span class="fu">list</span>(</span>
<span id="cb3-713"><a href="#cb3-713"></a>    <span class="st">"E-Value"</span> <span class="ot">=</span> <span class="st">"E_Value"</span>,</span>
<span id="cb3-714"><a href="#cb3-714"></a>    <span class="st">"E-Value bound"</span> <span class="ot">=</span> <span class="st">"E_Val_bound"</span></span>
<span id="cb3-715"><a href="#cb3-715"></a>  ),</span>
<span id="cb3-716"><a href="#cb3-716"></a>  <span class="at">rename_ate =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-717"><a href="#cb3-717"></a>  <span class="at">threshold_col =</span> <span class="st">"E_Val_bound"</span>,</span>
<span id="cb3-718"><a href="#cb3-718"></a>  <span class="at">output_format =</span> <span class="st">"markdown"</span>,</span>
<span id="cb3-719"><a href="#cb3-719"></a>  <span class="at">kbl_args =</span> <span class="fu">list</span>(</span>
<span id="cb3-720"><a href="#cb3-720"></a>    <span class="at">booktabs =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-721"><a href="#cb3-721"></a>    <span class="at">caption =</span> <span class="cn">NULL</span>,</span>
<span id="cb3-722"><a href="#cb3-722"></a>    <span class="at">align =</span> <span class="cn">NULL</span></span>
<span id="cb3-723"><a href="#cb3-723"></a>  )</span>
<span id="cb3-724"><a href="#cb3-724"></a>)</span>
<span id="cb3-725"><a href="#cb3-725"></a></span>
<span id="cb3-726"><a href="#cb3-726"></a><span class="co"># view markdown table</span></span>
<span id="cb3-727"><a href="#cb3-727"></a>margot_bind_tables_markdown</span>
<span id="cb3-728"><a href="#cb3-728"></a></span>
<span id="cb3-729"><a href="#cb3-729"></a><span class="co"># save for publication</span></span>
<span id="cb3-730"><a href="#cb3-730"></a><span class="fu">here_save</span>(margot_bind_tables_markdown, <span class="st">"margot_bind_tables_markdown"</span>)</span>
<span id="cb3-731"><a href="#cb3-731"></a></span>
<span id="cb3-732"><a href="#cb3-732"></a></span>
<span id="cb3-733"><a href="#cb3-733"></a><span class="co"># count models by category</span></span>
<span id="cb3-734"><a href="#cb3-734"></a><span class="fu">cat</span>(<span class="st">"Number of original models:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb3-735"><a href="#cb3-735"></a><span class="fu">cat</span>(<span class="st">"Social models:"</span>, <span class="fu">length</span>(models_binary_social<span class="sc">$</span>results), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb3-736"><a href="#cb3-736"></a><span class="fu">cat</span>(<span class="st">"Psych models:"</span>, <span class="fu">length</span>(models_binary_psych<span class="sc">$</span>results), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb3-737"><a href="#cb3-737"></a><span class="fu">cat</span>(<span class="st">"Health models:"</span>, <span class="fu">length</span>(models_binary_health<span class="sc">$</span>results), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb3-738"><a href="#cb3-738"></a><span class="fu">cat</span>(<span class="st">"Present models:"</span>, <span class="fu">length</span>(models_binary_present<span class="sc">$</span>results), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb3-739"><a href="#cb3-739"></a><span class="fu">cat</span>(<span class="st">"Life models:"</span>, <span class="fu">length</span>(models_binary_life<span class="sc">$</span>results), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb3-740"><a href="#cb3-740"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Total models in combined object:"</span>, <span class="fu">length</span>(all_models<span class="sc">$</span>results), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb3-741"><a href="#cb3-741"></a></span>
<span id="cb3-742"><a href="#cb3-742"></a></span>
<span id="cb3-743"><a href="#cb3-743"></a><span class="co"># flip negatively oriented outcomes --------------------------------------</span></span>
<span id="cb3-744"><a href="#cb3-744"></a><span class="co"># flip outcomes where higher values are worse for interpretation consistency</span></span>
<span id="cb3-745"><a href="#cb3-745"></a>models_binary_flipped_all <span class="ot">&lt;-</span> <span class="fu">margot_flip_forests</span>(</span>
<span id="cb3-746"><a href="#cb3-746"></a>  all_models,</span>
<span id="cb3-747"><a href="#cb3-747"></a>  <span class="at">flip_outcomes =</span> <span class="fu">c</span>(</span>
<span id="cb3-748"><a href="#cb3-748"></a>    <span class="st">"t2_alcohol_frequency"</span>,</span>
<span id="cb3-749"><a href="#cb3-749"></a>    <span class="st">"t2_alcohol_intensity"</span>,</span>
<span id="cb3-750"><a href="#cb3-750"></a>    <span class="st">"t2_hlth_bmi_z"</span>, </span>
<span id="cb3-751"><a href="#cb3-751"></a>    <span class="st">"t2_hlth_fatigue_z"</span>,</span>
<span id="cb3-752"><a href="#cb3-752"></a>    <span class="st">"t2_kessler_latent_anxiety_z"</span>,</span>
<span id="cb3-753"><a href="#cb3-753"></a>    <span class="st">"t2_kessler_latent_depression_z"</span>,</span>
<span id="cb3-754"><a href="#cb3-754"></a>    <span class="st">"t2_rumination_z"</span>,</span>
<span id="cb3-755"><a href="#cb3-755"></a>    <span class="st">"t2_perfectionism_z"</span></span>
<span id="cb3-756"><a href="#cb3-756"></a>  )</span>
<span id="cb3-757"><a href="#cb3-757"></a>)</span>
<span id="cb3-758"><a href="#cb3-758"></a></span>
<span id="cb3-759"><a href="#cb3-759"></a><span class="co"># size</span></span>
<span id="cb3-760"><a href="#cb3-760"></a><span class="fu">margot_size</span>(models_binary_flipped_all)</span>
<span id="cb3-761"><a href="#cb3-761"></a></span>
<span id="cb3-762"><a href="#cb3-762"></a><span class="co"># save (only jb - for lecture)</span></span>
<span id="cb3-763"><a href="#cb3-763"></a><span class="fu">here_save_qs</span>(models_binary_flipped_all, <span class="st">"models_binary_flipped_all"</span>, push_mods)</span>
<span id="cb3-764"><a href="#cb3-764"></a></span>
<span id="cb3-765"><a href="#cb3-765"></a><span class="co"># omnibus heterogeneity tests --------------------------------------------</span></span>
<span id="cb3-766"><a href="#cb3-766"></a><span class="co"># test for treatment effect heterogeneity across all outcomes</span></span>
<span id="cb3-767"><a href="#cb3-767"></a>result_ominbus_hetero_all <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_omnibus_hetero_test</span>(models_binary_flipped_all, <span class="at">label_mapping =</span> label_mapping_all)</span>
<span id="cb3-768"><a href="#cb3-768"></a></span>
<span id="cb3-769"><a href="#cb3-769"></a><span class="co"># view results table</span></span>
<span id="cb3-770"><a href="#cb3-770"></a>result_ominbus_hetero_all<span class="sc">$</span>summary_table <span class="sc">|&gt;</span> <span class="fu">kbl</span>(<span class="st">"markdown"</span>)</span>
<span id="cb3-771"><a href="#cb3-771"></a></span>
<span id="cb3-772"><a href="#cb3-772"></a><span class="co"># view test interpretation</span></span>
<span id="cb3-773"><a href="#cb3-773"></a><span class="fu">cat</span>(result_ominbus_hetero_all<span class="sc">$</span>brief_interpretation)</span>
<span id="cb3-774"><a href="#cb3-774"></a></span>
<span id="cb3-775"><a href="#cb3-775"></a></span>
<span id="cb3-776"><a href="#cb3-776"></a><span class="co"># rate test analysis -----------------------------------------------------</span></span>
<span id="cb3-777"><a href="#cb3-777"></a><span class="co"># define flipped outcome names for interpretation</span></span>
<span id="cb3-778"><a href="#cb3-778"></a>flipped_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Alcohol Frequency"</span>, <span class="st">"Alcohol Intensity"</span>, <span class="st">"BMI"</span>, <span class="st">"Fatigue"</span>, <span class="st">"Anxiety"</span>, <span class="st">"Depression"</span>, <span class="st">"Perfectionism"</span>, <span class="st">"Rumination"</span>)</span>
<span id="cb3-779"><a href="#cb3-779"></a></span>
<span id="cb3-780"><a href="#cb3-780"></a><span class="co"># save for publication</span></span>
<span id="cb3-781"><a href="#cb3-781"></a><span class="fu">here_save</span>(flipped_names, <span class="st">"flipped_names"</span>)</span>
<span id="cb3-782"><a href="#cb3-782"></a></span>
<span id="cb3-783"><a href="#cb3-783"></a><span class="co"># create rate analysis table</span></span>
<span id="cb3-784"><a href="#cb3-784"></a>rate_table_all <span class="ot">&lt;-</span> <span class="fu">margot_rate</span>(</span>
<span id="cb3-785"><a href="#cb3-785"></a>  models_binary_flipped_all, </span>
<span id="cb3-786"><a href="#cb3-786"></a>  <span class="at">label_mapping =</span> label_mapping_all, </span>
<span id="cb3-787"><a href="#cb3-787"></a>  <span class="at">highlight_significant =</span> <span class="cn">TRUE</span></span>
<span id="cb3-788"><a href="#cb3-788"></a>)</span>
<span id="cb3-789"><a href="#cb3-789"></a></span>
<span id="cb3-790"><a href="#cb3-790"></a><span class="co"># view rate tables</span></span>
<span id="cb3-791"><a href="#cb3-791"></a>rate_table_all<span class="sc">$</span>rate_autoc <span class="sc">|&gt;</span> <span class="fu">kbl</span>(<span class="st">"markdown"</span>)</span>
<span id="cb3-792"><a href="#cb3-792"></a>rate_table_all<span class="sc">$</span>rate_qini <span class="sc">|&gt;</span> <span class="fu">kbl</span>(<span class="st">"markdown"</span>)</span>
<span id="cb3-793"><a href="#cb3-793"></a></span>
<span id="cb3-794"><a href="#cb3-794"></a></span>
<span id="cb3-795"><a href="#cb3-795"></a><span class="co"># generate interpretation</span></span>
<span id="cb3-796"><a href="#cb3-796"></a>rate_interpretation_all <span class="ot">&lt;-</span> <span class="fu">margot_interpret_rate</span>(</span>
<span id="cb3-797"><a href="#cb3-797"></a>  rate_table_all, </span>
<span id="cb3-798"><a href="#cb3-798"></a>  <span class="at">flipped_outcomes =</span> flipped_names</span>
<span id="cb3-799"><a href="#cb3-799"></a>)</span>
<span id="cb3-800"><a href="#cb3-800"></a></span>
<span id="cb3-801"><a href="#cb3-801"></a><span class="co"># view interpretations</span></span>
<span id="cb3-802"><a href="#cb3-802"></a><span class="fu">cat</span>(rate_interpretation_all<span class="sc">$</span>autoc_results)</span>
<span id="cb3-803"><a href="#cb3-803"></a><span class="fu">cat</span>(rate_interpretation_all<span class="sc">$</span>qini_results)</span>
<span id="cb3-804"><a href="#cb3-804"></a><span class="fu">cat</span>(rate_interpretation_all<span class="sc">$</span>comparison)</span>
<span id="cb3-805"><a href="#cb3-805"></a></span>
<span id="cb3-806"><a href="#cb3-806"></a></span>
<span id="cb3-807"><a href="#cb3-807"></a><span class="co"># check out model names</span></span>
<span id="cb3-808"><a href="#cb3-808"></a>rate_interpretation_all<span class="sc">$</span>either_model_names</span>
<span id="cb3-809"><a href="#cb3-809"></a>rate_interpretation_all<span class="sc">$</span>qini_model_names</span>
<span id="cb3-810"><a href="#cb3-810"></a>rate_interpretation_all<span class="sc">$</span>both_model_names</span>
<span id="cb3-811"><a href="#cb3-811"></a>rate_interpretation_all<span class="sc">$</span>autoc_model_names</span>
<span id="cb3-812"><a href="#cb3-812"></a></span>
<span id="cb3-813"><a href="#cb3-813"></a></span>
<span id="cb3-814"><a href="#cb3-814"></a><span class="co"># autoc plots ------------------------------------------------------------</span></span>
<span id="cb3-815"><a href="#cb3-815"></a><span class="co"># generate batch rate plots for models with significant heterogeneity</span></span>
<span id="cb3-816"><a href="#cb3-816"></a>batch_rate_autoc_plots <span class="ot">&lt;-</span> <span class="fu">margot_plot_rate_batch</span>(</span>
<span id="cb3-817"><a href="#cb3-817"></a>  models_binary_flipped_all, </span>
<span id="cb3-818"><a href="#cb3-818"></a>  <span class="at">save_plots =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-819"><a href="#cb3-819"></a>  <span class="co"># just use rate autoc</span></span>
<span id="cb3-820"><a href="#cb3-820"></a>  <span class="at">model_names =</span> rate_interpretation_all<span class="sc">$</span>autoc_model_names  </span>
<span id="cb3-821"><a href="#cb3-821"></a>)</span>
<span id="cb3-822"><a href="#cb3-822"></a></span>
<span id="cb3-823"><a href="#cb3-823"></a><span class="co"># view selected autoc plots</span></span>
<span id="cb3-824"><a href="#cb3-824"></a>batch_rate_autoc_plots<span class="sc">$</span>model_t2_log_hours_exercise_z</span>
<span id="cb3-825"><a href="#cb3-825"></a>batch_rate_autoc_plots<span class="sc">$</span>model_t2_hlth_fatigue_z</span>
<span id="cb3-826"><a href="#cb3-826"></a>batch_rate_autoc_plots<span class="sc">$</span>model_t2_self_control_z</span>
<span id="cb3-827"><a href="#cb3-827"></a>batch_rate_autoc_plots<span class="sc">$</span>model_t2_meaning_sense_z</span>
<span id="cb3-828"><a href="#cb3-828"></a></span>
<span id="cb3-829"><a href="#cb3-829"></a><span class="co"># for instruction</span></span>
<span id="cb3-830"><a href="#cb3-830"></a>batch_rate_qini_plots <span class="ot">&lt;-</span> <span class="fu">margot_plot_rate_batch</span>(</span>
<span id="cb3-831"><a href="#cb3-831"></a>  models_binary_flipped_all, </span>
<span id="cb3-832"><a href="#cb3-832"></a>  <span class="at">save_plots =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-833"><a href="#cb3-833"></a>  <span class="at">model_names =</span> rate_interpretation_all<span class="sc">$</span>qini_model_names</span>
<span id="cb3-834"><a href="#cb3-834"></a>)</span>
<span id="cb3-835"><a href="#cb3-835"></a></span>
<span id="cb3-836"><a href="#cb3-836"></a><span class="co"># for instruction -- note that initial heterogeneity dips below zero</span></span>
<span id="cb3-837"><a href="#cb3-837"></a>batch_rate_qini_plots<span class="sc">$</span>model_t2_bodysat_z</span>
<span id="cb3-838"><a href="#cb3-838"></a>batch_rate_qini_plots<span class="sc">$</span>model_t2_self_esteem_z</span>
<span id="cb3-839"><a href="#cb3-839"></a>batch_rate_qini_plots<span class="sc">$</span>model_t2_belong_z</span>
<span id="cb3-840"><a href="#cb3-840"></a></span>
<span id="cb3-841"><a href="#cb3-841"></a></span>
<span id="cb3-842"><a href="#cb3-842"></a><span class="co"># QINI --------------------------------------------------------------------</span></span>
<span id="cb3-843"><a href="#cb3-843"></a><span class="co"># batch process heterogeneity results for qini</span></span>
<span id="cb3-844"><a href="#cb3-844"></a>models_binary_batch_qini <span class="ot">&lt;-</span> <span class="fu">margot_policy</span>(</span>
<span id="cb3-845"><a href="#cb3-845"></a>  models_binary_flipped_all,</span>
<span id="cb3-846"><a href="#cb3-846"></a>  <span class="at">save_plots =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-847"><a href="#cb3-847"></a>  <span class="at">output_dir =</span> here<span class="sc">::</span><span class="fu">here</span>(push_mods),</span>
<span id="cb3-848"><a href="#cb3-848"></a>  <span class="at">decision_tree_args =</span> decision_tree_defaults,</span>
<span id="cb3-849"><a href="#cb3-849"></a>  <span class="at">policy_tree_args =</span> policy_tree_defaults,</span>
<span id="cb3-850"><a href="#cb3-850"></a>  <span class="at">model_names =</span> rate_interpretation_all<span class="sc">$</span>qini_model_names,</span>
<span id="cb3-851"><a href="#cb3-851"></a>  <span class="at">original_df =</span> original_df,</span>
<span id="cb3-852"><a href="#cb3-852"></a>  <span class="at">label_mapping =</span> label_mapping_all</span>
<span id="cb3-853"><a href="#cb3-853"></a>)</span>
<span id="cb3-854"><a href="#cb3-854"></a></span>
<span id="cb3-855"><a href="#cb3-855"></a><span class="co"># check size</span></span>
<span id="cb3-856"><a href="#cb3-856"></a><span class="fu">margot_size</span>(models_binary_batch_qini)</span>
<span id="cb3-857"><a href="#cb3-857"></a></span>
<span id="cb3-858"><a href="#cb3-858"></a><span class="co"># save</span></span>
<span id="cb3-859"><a href="#cb3-859"></a><span class="fu">here_save_qs</span>(models_binary_batch_qini, <span class="st">"models_binary_batch_qini"</span>, push_mods)</span>
<span id="cb3-860"><a href="#cb3-860"></a></span>
<span id="cb3-861"><a href="#cb3-861"></a><span class="co"># view models</span></span>
<span id="cb3-862"><a href="#cb3-862"></a><span class="co"># first make graphs</span></span>
<span id="cb3-863"><a href="#cb3-863"></a>plot_qini_exercise <span class="ot">&lt;-</span> models_binary_batch_qini<span class="sc">$</span>model_t2_log_hours_exercise_z<span class="sc">$</span>qini_plot</span>
<span id="cb3-864"><a href="#cb3-864"></a>plot_qini_fatigue <span class="ot">&lt;-</span> models_binary_batch_qini<span class="sc">$</span>model_t2_hlth_fatigue_z<span class="sc">$</span>qini_plot</span>
<span id="cb3-865"><a href="#cb3-865"></a>plot_qini_bodysat <span class="ot">&lt;-</span> models_binary_batch_qini<span class="sc">$</span>model_t2_bodysat_z<span class="sc">$</span>qini_plot</span>
<span id="cb3-866"><a href="#cb3-866"></a>plot_qini_self_control <span class="ot">&lt;-</span> models_binary_batch_qini<span class="sc">$</span>model_t2_self_control_z<span class="sc">$</span>qini_plot</span>
<span id="cb3-867"><a href="#cb3-867"></a>plot_qini_self_esteem <span class="ot">&lt;-</span> models_binary_batch_qini<span class="sc">$</span>model_t2_self_esteem_z<span class="sc">$</span>qini_plot</span>
<span id="cb3-868"><a href="#cb3-868"></a>plot_qini_belong <span class="ot">&lt;-</span> models_binary_batch_qini<span class="sc">$</span>model_t2_belong_z<span class="sc">$</span>qini_plot</span>
<span id="cb3-869"><a href="#cb3-869"></a></span>
<span id="cb3-870"><a href="#cb3-870"></a><span class="co"># recall the ate</span></span>
<span id="cb3-871"><a href="#cb3-871"></a>plot_all_models<span class="sc">$</span>plot</span>
<span id="cb3-872"><a href="#cb3-872"></a></span>
<span id="cb3-873"><a href="#cb3-873"></a><span class="co"># interpret qini curves</span></span>
<span id="cb3-874"><a href="#cb3-874"></a>interpretation_qini_curves <span class="ot">&lt;-</span> <span class="fu">margot_interpret_qini</span>(</span>
<span id="cb3-875"><a href="#cb3-875"></a>  models_binary_batch_qini,</span>
<span id="cb3-876"><a href="#cb3-876"></a>  <span class="at">model_names =</span> rate_interpretation_all<span class="sc">$</span>qini_model_names,</span>
<span id="cb3-877"><a href="#cb3-877"></a>  <span class="at">label_mapping =</span> label_mapping_all</span>
<span id="cb3-878"><a href="#cb3-878"></a>)</span>
<span id="cb3-879"><a href="#cb3-879"></a></span>
<span id="cb3-880"><a href="#cb3-880"></a><span class="co"># view qini interpretation</span></span>
<span id="cb3-881"><a href="#cb3-881"></a><span class="fu">cat</span>(interpretation_qini_curves<span class="sc">$</span>qini_explanation)</span>
<span id="cb3-882"><a href="#cb3-882"></a></span>
<span id="cb3-883"><a href="#cb3-883"></a><span class="co"># view summary table</span></span>
<span id="cb3-884"><a href="#cb3-884"></a>interpretation_qini_curves<span class="sc">$</span>summary_table <span class="sc">|&gt;</span> <span class="fu">kbl</span>(<span class="st">"markdown"</span>)</span>
<span id="cb3-885"><a href="#cb3-885"></a></span>
<span id="cb3-886"><a href="#cb3-886"></a><span class="co"># combine qini plots for visualisation</span></span>
<span id="cb3-887"><a href="#cb3-887"></a><span class="co"># patchwork allows us to group graphs together</span></span>
<span id="cb3-888"><a href="#cb3-888"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb3-889"><a href="#cb3-889"></a>qini_plots_combined <span class="ot">&lt;-</span> </span>
<span id="cb3-890"><a href="#cb3-890"></a>  (plot_qini_exercise <span class="sc">+</span> plot_qini_fatigue <span class="sc">+</span> plot_qini_bodysat) <span class="sc">/</span> </span>
<span id="cb3-891"><a href="#cb3-891"></a>  (plot_qini_self_control <span class="sc">+</span> plot_qini_self_esteem <span class="sc">+</span> plot_qini_belong) <span class="sc">+</span> </span>
<span id="cb3-892"><a href="#cb3-892"></a>  <span class="fu">plot_annotation</span>(</span>
<span id="cb3-893"><a href="#cb3-893"></a>    <span class="at">title =</span> <span class="st">"Qini Plots: Reliable Priority 'Spending' at Fractional Budgets"</span>,</span>
<span id="cb3-894"><a href="#cb3-894"></a>    <span class="at">tag_levels =</span> <span class="st">"A"</span>,</span>
<span id="cb3-895"><a href="#cb3-895"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb3-896"><a href="#cb3-896"></a>  ) <span class="sc">+</span></span>
<span id="cb3-897"><a href="#cb3-897"></a>  <span class="fu">plot_layout</span>(<span class="at">guides =</span> <span class="st">"collect"</span>)</span>
<span id="cb3-898"><a href="#cb3-898"></a></span>
<span id="cb3-899"><a href="#cb3-899"></a><span class="co"># view combined qini plots</span></span>
<span id="cb3-900"><a href="#cb3-900"></a>qini_plots_combined</span>
<span id="cb3-901"><a href="#cb3-901"></a></span>
<span id="cb3-902"><a href="#cb3-902"></a><span class="co"># again compare with ate</span></span>
<span id="cb3-903"><a href="#cb3-903"></a>plot_all_models<span class="sc">$</span>plot </span>
<span id="cb3-904"><a href="#cb3-904"></a></span>
<span id="cb3-905"><a href="#cb3-905"></a></span>
<span id="cb3-906"><a href="#cb3-906"></a><span class="co"># policy tree analysis ---------------------------------------------------</span></span>
<span id="cb3-907"><a href="#cb3-907"></a><span class="co"># model_names_subset &lt;- c(</span></span>
<span id="cb3-908"><a href="#cb3-908"></a><span class="co">#   "model_t2_log_hours_exercise_z",</span></span>
<span id="cb3-909"><a href="#cb3-909"></a><span class="co">#   "model_t2_self_control_z", </span></span>
<span id="cb3-910"><a href="#cb3-910"></a><span class="co">#   "model_t2_sexual_satisfaction_z",</span></span>
<span id="cb3-911"><a href="#cb3-911"></a><span class="co">#   "model_t2_belong_z",</span></span>
<span id="cb3-912"><a href="#cb3-912"></a><span class="co">#   "model_t2_support_z"</span></span>
<span id="cb3-913"><a href="#cb3-913"></a><span class="co"># )</span></span>
<span id="cb3-914"><a href="#cb3-914"></a></span>
<span id="cb3-915"><a href="#cb3-915"></a><span class="co"># make policy trees</span></span>
<span id="cb3-916"><a href="#cb3-916"></a>plots_policy_trees <span class="ot">&lt;-</span> <span class="fu">margot_policy</span>(</span>
<span id="cb3-917"><a href="#cb3-917"></a>  models_binary_flipped_all,</span>
<span id="cb3-918"><a href="#cb3-918"></a>  <span class="at">save_plots =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-919"><a href="#cb3-919"></a>  <span class="at">output_dir =</span> here<span class="sc">::</span><span class="fu">here</span>(push_mods),</span>
<span id="cb3-920"><a href="#cb3-920"></a>  <span class="at">decision_tree_args =</span> decision_tree_defaults,</span>
<span id="cb3-921"><a href="#cb3-921"></a>  <span class="at">policy_tree_args =</span> policy_tree_defaults,</span>
<span id="cb3-922"><a href="#cb3-922"></a>  <span class="at">model_names =</span> rate_interpretation_all<span class="sc">$</span>either_model_names, <span class="co"># defined above</span></span>
<span id="cb3-923"><a href="#cb3-923"></a>  <span class="at">original_df =</span> original_df,</span>
<span id="cb3-924"><a href="#cb3-924"></a>  <span class="at">label_mapping =</span> label_mapping_all</span>
<span id="cb3-925"><a href="#cb3-925"></a>)</span>
<span id="cb3-926"><a href="#cb3-926"></a></span>
<span id="cb3-927"><a href="#cb3-927"></a><span class="co"># generate policy tree interpretations</span></span>
<span id="cb3-928"><a href="#cb3-928"></a>interpretation_policy_trees <span class="ot">&lt;-</span> <span class="fu">margot_interpret_policy_batch</span>(</span>
<span id="cb3-929"><a href="#cb3-929"></a>  models_binary_flipped_all,</span>
<span id="cb3-930"><a href="#cb3-930"></a>  <span class="co"># use eithre model</span></span>
<span id="cb3-931"><a href="#cb3-931"></a>  <span class="at">model_names =</span> rate_interpretation_all<span class="sc">$</span>either_model_names, <span class="co"># defined above</span></span>
<span id="cb3-932"><a href="#cb3-932"></a>  <span class="at">train_proportion =</span> <span class="fl">0.8</span>,</span>
<span id="cb3-933"><a href="#cb3-933"></a>  <span class="at">original_df =</span> original_df,</span>
<span id="cb3-934"><a href="#cb3-934"></a>  <span class="at">label_mapping =</span> label_mapping_all</span>
<span id="cb3-935"><a href="#cb3-935"></a>)</span>
<span id="cb3-936"><a href="#cb3-936"></a></span>
<span id="cb3-937"><a href="#cb3-937"></a><span class="co"># this will give you results</span></span>
<span id="cb3-938"><a href="#cb3-938"></a><span class="fu">cat</span>(interpretation_policy_trees)</span>
<span id="cb3-939"><a href="#cb3-939"></a></span>
<span id="cb3-940"><a href="#cb3-940"></a><span class="co"># view plots --------------------------------------------------------------</span></span>
<span id="cb3-941"><a href="#cb3-941"></a><span class="co"># log hours exercise</span></span>
<span id="cb3-942"><a href="#cb3-942"></a>plots_policy_trees<span class="sc">$</span>model_t2_log_hours_exercise_z<span class="sc">$</span>decision_tree</span>
<span id="cb3-943"><a href="#cb3-943"></a>plots_policy_trees<span class="sc">$</span>model_t2_log_hours_exercise_z<span class="sc">$</span>policy_tree</span>
<span id="cb3-944"><a href="#cb3-944"></a>plots_policy_trees<span class="sc">$</span>model_t2_log_hours_exercise_z<span class="sc">$</span>combined_plot</span>
<span id="cb3-945"><a href="#cb3-945"></a></span>
<span id="cb3-946"><a href="#cb3-946"></a><span class="co"># fatigue</span></span>
<span id="cb3-947"><a href="#cb3-947"></a>plots_policy_trees<span class="sc">$</span>model_t2_hlth_fatigue_z<span class="sc">$</span>decision_tree</span>
<span id="cb3-948"><a href="#cb3-948"></a>plots_policy_trees<span class="sc">$</span>model_t2_hlth_fatigue_z<span class="sc">$</span>policy_tree</span>
<span id="cb3-949"><a href="#cb3-949"></a>plots_policy_trees<span class="sc">$</span>model_t2_hlth_fatigue_z<span class="sc">$</span>combined_plot</span>
<span id="cb3-950"><a href="#cb3-950"></a></span>
<span id="cb3-951"><a href="#cb3-951"></a><span class="co"># self control</span></span>
<span id="cb3-952"><a href="#cb3-952"></a>plots_policy_trees<span class="sc">$</span>model_t2_self_control_z<span class="sc">$</span>decision_tree</span>
<span id="cb3-953"><a href="#cb3-953"></a>plots_policy_trees<span class="sc">$</span>model_t2_self_control_z<span class="sc">$</span>policy_tree</span>
<span id="cb3-954"><a href="#cb3-954"></a>plots_policy_trees<span class="sc">$</span>model_t2_self_control_z<span class="sc">$</span>combined_plot</span>
<span id="cb3-955"><a href="#cb3-955"></a></span>
<span id="cb3-956"><a href="#cb3-956"></a><span class="co"># meaning sense</span></span>
<span id="cb3-957"><a href="#cb3-957"></a>plots_policy_trees<span class="sc">$</span>model_t2_meaning_sense_z<span class="sc">$</span>decision_tree</span>
<span id="cb3-958"><a href="#cb3-958"></a>plots_policy_trees<span class="sc">$</span>model_t2_meaning_sense_z<span class="sc">$</span>policy_tree</span>
<span id="cb3-959"><a href="#cb3-959"></a>plots_policy_trees<span class="sc">$</span>model_t2_meaning_sense_z<span class="sc">$</span>combined_plot</span>
<span id="cb3-960"><a href="#cb3-960"></a></span>
<span id="cb3-961"><a href="#cb3-961"></a><span class="co"># body satisfaction</span></span>
<span id="cb3-962"><a href="#cb3-962"></a>plots_policy_trees<span class="sc">$</span>model_t2_bodysat_z<span class="sc">$</span>decision_tree</span>
<span id="cb3-963"><a href="#cb3-963"></a>plots_policy_trees<span class="sc">$</span>model_t2_bodysat_z<span class="sc">$</span>policy_tree</span>
<span id="cb3-964"><a href="#cb3-964"></a>plots_policy_trees<span class="sc">$</span>model_t2_bodysat_z<span class="sc">$</span>combined_plot</span>
<span id="cb3-965"><a href="#cb3-965"></a></span>
<span id="cb3-966"><a href="#cb3-966"></a><span class="co"># self esteem</span></span>
<span id="cb3-967"><a href="#cb3-967"></a>plots_policy_trees<span class="sc">$</span>model_t2_self_esteem_z<span class="sc">$</span>decision_tree</span>
<span id="cb3-968"><a href="#cb3-968"></a>plots_policy_trees<span class="sc">$</span>model_t2_self_esteem_z<span class="sc">$</span>policy_tree</span>
<span id="cb3-969"><a href="#cb3-969"></a>plots_policy_trees<span class="sc">$</span>model_t2_self_esteem_z<span class="sc">$</span>combined_plot</span>
<span id="cb3-970"><a href="#cb3-970"></a></span>
<span id="cb3-971"><a href="#cb3-971"></a><span class="co"># belonging</span></span>
<span id="cb3-972"><a href="#cb3-972"></a>plots_policy_trees<span class="sc">$</span>model_t2_belong_z<span class="sc">$</span>decision_tree</span>
<span id="cb3-973"><a href="#cb3-973"></a>plots_policy_trees<span class="sc">$</span>model_t2_belong_z<span class="sc">$</span>policy_tree</span>
<span id="cb3-974"><a href="#cb3-974"></a>plots_policy_trees<span class="sc">$</span>model_t2_belong_z<span class="sc">$</span>combined_plot</span>
<span id="cb3-975"><a href="#cb3-975"></a></span>
<span id="cb3-976"><a href="#cb3-976"></a></span>
<span id="cb3-977"><a href="#cb3-977"></a><span class="do">#############################################################################</span></span>
<span id="cb3-978"><a href="#cb3-978"></a><span class="co"># theoretical comparisons ---------------------------------------------------</span></span>
<span id="cb3-979"><a href="#cb3-979"></a><span class="co"># individual theoretical comparisons (if relevant)</span></span>
<span id="cb3-980"><a href="#cb3-980"></a><span class="co"># need to get values for wealth if wealth is compared</span></span>
<span id="cb3-981"><a href="#cb3-981"></a></span>
<span id="cb3-982"><a href="#cb3-982"></a><span class="co"># step 1 get information for wealth for conditonal comparisons</span></span>
<span id="cb3-983"><a href="#cb3-983"></a><span class="fu">head</span>(df_grf<span class="sc">$</span>t0_log_household_inc_z)</span>
<span id="cb3-984"><a href="#cb3-984"></a></span>
<span id="cb3-985"><a href="#cb3-985"></a><span class="co"># get mean on original data scale</span></span>
<span id="cb3-986"><a href="#cb3-986"></a>log_mean_inc <span class="ot">&lt;-</span> <span class="fu">mean</span>(original_df<span class="sc">$</span>t0_log_household_inc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-987"><a href="#cb3-987"></a></span>
<span id="cb3-988"><a href="#cb3-988"></a><span class="co"># get sd on original data scale</span></span>
<span id="cb3-989"><a href="#cb3-989"></a>log_sd_inc <span class="ot">&lt;-</span> <span class="fu">sd</span>(original_df<span class="sc">$</span>t0_log_household_inc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-990"><a href="#cb3-990"></a></span>
<span id="cb3-991"><a href="#cb3-991"></a><span class="co"># function to get back to data scale</span></span>
<span id="cb3-992"><a href="#cb3-992"></a><span class="fu">margot_back_transform_log_z</span>(</span>
<span id="cb3-993"><a href="#cb3-993"></a>  <span class="at">log_mean =</span> log_mean_inc, </span>
<span id="cb3-994"><a href="#cb3-994"></a>  <span class="at">log_sd =</span> log_sd_inc,</span>
<span id="cb3-995"><a href="#cb3-995"></a>  <span class="at">z_scores =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb3-996"><a href="#cb3-996"></a>  <span class="at">label =</span> <span class="st">"data_scale"</span></span>
<span id="cb3-997"><a href="#cb3-997"></a>)</span>
<span id="cb3-998"><a href="#cb3-998"></a></span>
<span id="cb3-999"><a href="#cb3-999"></a><span class="co"># define complex conditions for subsetting</span></span>
<span id="cb3-1000"><a href="#cb3-1000"></a>complex_condition_political <span class="ot">&lt;-</span> X[, <span class="st">"t0_political_conservative_z"</span>] <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">&amp;</span></span>
<span id="cb3-1001"><a href="#cb3-1001"></a>  X[, <span class="st">"t0_political_conservative_z"</span>] <span class="sc">&lt;</span> <span class="dv">1</span></span>
<span id="cb3-1002"><a href="#cb3-1002"></a></span>
<span id="cb3-1003"><a href="#cb3-1003"></a>complex_condition_wealth <span class="ot">&lt;-</span> X[, <span class="st">"t0_log_household_inc_z"</span>] <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">&amp;</span> </span>
<span id="cb3-1004"><a href="#cb3-1004"></a>  X[, <span class="st">"t0_log_household_inc_z"</span>] <span class="sc">&lt;</span> <span class="dv">1</span></span>
<span id="cb3-1005"><a href="#cb3-1005"></a></span>
<span id="cb3-1006"><a href="#cb3-1006"></a><span class="co"># wealth subsets</span></span>
<span id="cb3-1007"><a href="#cb3-1007"></a>subsets_standard_wealth <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-1008"><a href="#cb3-1008"></a>  <span class="at">Poor =</span> <span class="fu">list</span>(</span>
<span id="cb3-1009"><a href="#cb3-1009"></a>    <span class="at">var =</span> <span class="st">"t0_log_household_inc_z"</span>,</span>
<span id="cb3-1010"><a href="#cb3-1010"></a>    <span class="at">value =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb3-1011"><a href="#cb3-1011"></a>    <span class="at">operator =</span> <span class="st">"&lt;"</span>,</span>
<span id="cb3-1012"><a href="#cb3-1012"></a>    <span class="at">description =</span> <span class="st">"HShold income &lt; -1 SD (NZD ~41k)"</span></span>
<span id="cb3-1013"><a href="#cb3-1013"></a>    <span class="co"># label = "Conservative"  # label remains as is, but could be changed if desired</span></span>
<span id="cb3-1014"><a href="#cb3-1014"></a>  ),</span>
<span id="cb3-1015"><a href="#cb3-1015"></a>  <span class="at">MiddleIncome =</span> <span class="fu">list</span>(</span>
<span id="cb3-1016"><a href="#cb3-1016"></a>    <span class="at">subset_condition =</span> complex_condition_wealth,</span>
<span id="cb3-1017"><a href="#cb3-1017"></a>    <span class="at">description =</span> <span class="st">"HShold income within +/-1SD (&gt; NZD 41k &lt; NZD 191k)"</span></span>
<span id="cb3-1018"><a href="#cb3-1018"></a>  ),</span>
<span id="cb3-1019"><a href="#cb3-1019"></a>  <span class="at">Rich =</span> <span class="fu">list</span>(</span>
<span id="cb3-1020"><a href="#cb3-1020"></a>    <span class="at">var =</span> <span class="st">"t0_log_household_inc_z"</span>,</span>
<span id="cb3-1021"><a href="#cb3-1021"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb3-1022"><a href="#cb3-1022"></a>    <span class="at">operator =</span> <span class="st">"&gt;"</span>,</span>
<span id="cb3-1023"><a href="#cb3-1023"></a>    <span class="at">description =</span> <span class="st">"HShold income &gt; +1 SD (NZD 191k)"</span>,</span>
<span id="cb3-1024"><a href="#cb3-1024"></a>    <span class="at">label =</span> <span class="st">"Rich"</span></span>
<span id="cb3-1025"><a href="#cb3-1025"></a>  )</span>
<span id="cb3-1026"><a href="#cb3-1026"></a>)</span>
<span id="cb3-1027"><a href="#cb3-1027"></a></span>
<span id="cb3-1028"><a href="#cb3-1028"></a><span class="co"># political subsets</span></span>
<span id="cb3-1029"><a href="#cb3-1029"></a>subsets_standard_political <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-1030"><a href="#cb3-1030"></a>  <span class="at">Liberal =</span> <span class="fu">list</span>(</span>
<span id="cb3-1031"><a href="#cb3-1031"></a>    <span class="at">var =</span> <span class="st">"t0_political_conservative_z"</span>,</span>
<span id="cb3-1032"><a href="#cb3-1032"></a>    <span class="at">value =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb3-1033"><a href="#cb3-1033"></a>    <span class="at">operator =</span> <span class="st">"&lt;"</span>,</span>
<span id="cb3-1034"><a href="#cb3-1034"></a>    <span class="at">description =</span> <span class="st">"&lt; -1 SD in political conservativism"</span></span>
<span id="cb3-1035"><a href="#cb3-1035"></a>  ),</span>
<span id="cb3-1036"><a href="#cb3-1036"></a>  <span class="at">Moderates =</span> <span class="fu">list</span>(</span>
<span id="cb3-1037"><a href="#cb3-1037"></a>    <span class="at">var =</span> <span class="st">"t0_political_conservative_z"</span>,</span>
<span id="cb3-1038"><a href="#cb3-1038"></a>    <span class="co"># operator = "&lt;",</span></span>
<span id="cb3-1039"><a href="#cb3-1039"></a>    <span class="at">subset_condition =</span> complex_condition_political,</span>
<span id="cb3-1040"><a href="#cb3-1040"></a>    <span class="at">description =</span> <span class="st">"Effects among those &gt; -1 SD and &lt; +1 in political conservativism"</span>,</span>
<span id="cb3-1041"><a href="#cb3-1041"></a>    <span class="at">label =</span> <span class="st">"Centrist"</span></span>
<span id="cb3-1042"><a href="#cb3-1042"></a>  ),</span>
<span id="cb3-1043"><a href="#cb3-1043"></a>  <span class="at">Conservative =</span> <span class="fu">list</span>(</span>
<span id="cb3-1044"><a href="#cb3-1044"></a>    <span class="at">var =</span> <span class="st">"t0_political_conservative_z"</span>,</span>
<span id="cb3-1045"><a href="#cb3-1045"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb3-1046"><a href="#cb3-1046"></a>    <span class="at">operator =</span> <span class="st">"&gt;"</span>,</span>
<span id="cb3-1047"><a href="#cb3-1047"></a>    <span class="at">description =</span> <span class="st">"&gt; +1 SD in political conservativism"</span>,</span>
<span id="cb3-1048"><a href="#cb3-1048"></a>    <span class="at">label =</span> <span class="st">"Conservative"</span></span>
<span id="cb3-1049"><a href="#cb3-1049"></a>  )</span>
<span id="cb3-1050"><a href="#cb3-1050"></a>)</span>
<span id="cb3-1051"><a href="#cb3-1051"></a></span>
<span id="cb3-1052"><a href="#cb3-1052"></a><span class="co"># gender subsets</span></span>
<span id="cb3-1053"><a href="#cb3-1053"></a>subsets_standard_gender <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-1054"><a href="#cb3-1054"></a>  <span class="at">Female =</span> <span class="fu">list</span>(</span>
<span id="cb3-1055"><a href="#cb3-1055"></a>    <span class="at">var =</span> <span class="st">"t0_male_binary"</span>,</span>
<span id="cb3-1056"><a href="#cb3-1056"></a>    <span class="at">value =</span> <span class="dv">0</span>,</span>
<span id="cb3-1057"><a href="#cb3-1057"></a>    <span class="at">description =</span> <span class="st">"Females"</span></span>
<span id="cb3-1058"><a href="#cb3-1058"></a>  ),</span>
<span id="cb3-1059"><a href="#cb3-1059"></a>  <span class="at">Male =</span> <span class="fu">list</span>(</span>
<span id="cb3-1060"><a href="#cb3-1060"></a>    <span class="at">var =</span> <span class="st">"t0_male_binary"</span>,</span>
<span id="cb3-1061"><a href="#cb3-1061"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb3-1062"><a href="#cb3-1062"></a>    <span class="at">description =</span> <span class="st">"Males"</span></span>
<span id="cb3-1063"><a href="#cb3-1063"></a>  )</span>
<span id="cb3-1064"><a href="#cb3-1064"></a>) </span>
<span id="cb3-1065"><a href="#cb3-1065"></a></span>
<span id="cb3-1066"><a href="#cb3-1066"></a><span class="co"># ethnicity subsets</span></span>
<span id="cb3-1067"><a href="#cb3-1067"></a>subsets_standard_ethnicity <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-1068"><a href="#cb3-1068"></a>  <span class="at">Asian =</span> <span class="fu">list</span>(</span>
<span id="cb3-1069"><a href="#cb3-1069"></a>    <span class="at">var =</span> <span class="st">"t0_eth_cat_asian_binary"</span>,</span>
<span id="cb3-1070"><a href="#cb3-1070"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb3-1071"><a href="#cb3-1071"></a>    <span class="at">description =</span> <span class="st">"Asians"</span></span>
<span id="cb3-1072"><a href="#cb3-1072"></a>  ),</span>
<span id="cb3-1073"><a href="#cb3-1073"></a>  <span class="at">Euro =</span> <span class="fu">list</span>(</span>
<span id="cb3-1074"><a href="#cb3-1074"></a>    <span class="at">var =</span> <span class="st">"t0_eth_cat_euro_binary"</span>,</span>
<span id="cb3-1075"><a href="#cb3-1075"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb3-1076"><a href="#cb3-1076"></a>    <span class="at">description =</span> <span class="st">"Europeans (Pakeha)"</span></span>
<span id="cb3-1077"><a href="#cb3-1077"></a>  ),</span>
<span id="cb3-1078"><a href="#cb3-1078"></a>  <span class="at">Pacific =</span> <span class="fu">list</span>(</span>
<span id="cb3-1079"><a href="#cb3-1079"></a>    <span class="at">var =</span> <span class="st">"t0_eth_cat_pacific_binary"</span>,</span>
<span id="cb3-1080"><a href="#cb3-1080"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb3-1081"><a href="#cb3-1081"></a>    <span class="at">description =</span> <span class="st">"Pacific Peoples"</span></span>
<span id="cb3-1082"><a href="#cb3-1082"></a>  ),</span>
<span id="cb3-1083"><a href="#cb3-1083"></a>  <span class="at">Maori =</span> <span class="fu">list</span>(</span>
<span id="cb3-1084"><a href="#cb3-1084"></a>    <span class="at">var =</span> <span class="st">"t0_eth_cat_maori_binary"</span>,</span>
<span id="cb3-1085"><a href="#cb3-1085"></a>    <span class="at">value =</span> <span class="dv">1</span>,</span>
<span id="cb3-1086"><a href="#cb3-1086"></a>    <span class="at">description =</span> <span class="st">"Māori"</span></span>
<span id="cb3-1087"><a href="#cb3-1087"></a>  )</span>
<span id="cb3-1088"><a href="#cb3-1088"></a>)</span>
<span id="cb3-1089"><a href="#cb3-1089"></a></span>
<span id="cb3-1090"><a href="#cb3-1090"></a><span class="co"># subsets_standard_cohort &lt;- list(</span></span>
<span id="cb3-1091"><a href="#cb3-1091"></a><span class="co">#   boomers = list(</span></span>
<span id="cb3-1092"><a href="#cb3-1092"></a><span class="co">#     var = "t0_gen_cohort_gen_Boomers_binary",</span></span>
<span id="cb3-1093"><a href="#cb3-1093"></a><span class="co">#     value = 1,</span></span>
<span id="cb3-1094"><a href="#cb3-1094"></a><span class="co">#     description = "Baby Boomers",</span></span>
<span id="cb3-1095"><a href="#cb3-1095"></a><span class="co">#     label = "Boomers"  # label remains as is, but could be changed if desired</span></span>
<span id="cb3-1096"><a href="#cb3-1096"></a><span class="co">#   ),</span></span>
<span id="cb3-1097"><a href="#cb3-1097"></a><span class="co">#   gen_X = list(</span></span>
<span id="cb3-1098"><a href="#cb3-1098"></a><span class="co">#     var = "t0_gen_cohort_gen_X_binary",</span></span>
<span id="cb3-1099"><a href="#cb3-1099"></a><span class="co">#     value = 1,</span></span>
<span id="cb3-1100"><a href="#cb3-1100"></a><span class="co">#     description = "Generation X",</span></span>
<span id="cb3-1101"><a href="#cb3-1101"></a><span class="co">#     label = "Generation_X"  # label remains as is, but could be changed if desired</span></span>
<span id="cb3-1102"><a href="#cb3-1102"></a><span class="co">#   ),</span></span>
<span id="cb3-1103"><a href="#cb3-1103"></a><span class="co">#   gen_Y = list(</span></span>
<span id="cb3-1104"><a href="#cb3-1104"></a><span class="co">#     var = "t0_gen_cohort_gen_Y_binary",</span></span>
<span id="cb3-1105"><a href="#cb3-1105"></a><span class="co">#     value = 1,</span></span>
<span id="cb3-1106"><a href="#cb3-1106"></a><span class="co">#     description = "Generation Y",</span></span>
<span id="cb3-1107"><a href="#cb3-1107"></a><span class="co">#     label = "Generation_Y"  # label remains as is, but could be changed if desired</span></span>
<span id="cb3-1108"><a href="#cb3-1108"></a><span class="co">#   ),</span></span>
<span id="cb3-1109"><a href="#cb3-1109"></a><span class="co">#   gen_Z = list(</span></span>
<span id="cb3-1110"><a href="#cb3-1110"></a><span class="co">#     var = "t0_gen_cohort_gen_Z_binary",</span></span>
<span id="cb3-1111"><a href="#cb3-1111"></a><span class="co">#     value = 1,</span></span>
<span id="cb3-1112"><a href="#cb3-1112"></a><span class="co">#     description = "Generation Z",</span></span>
<span id="cb3-1113"><a href="#cb3-1113"></a><span class="co">#     label = "Generation_Z"  # label remains as is, but could be changed if desired</span></span>
<span id="cb3-1114"><a href="#cb3-1114"></a><span class="co">#   )</span></span>
<span id="cb3-1115"><a href="#cb3-1115"></a><span class="co"># )</span></span>
<span id="cb3-1116"><a href="#cb3-1116"></a></span>
<span id="cb3-1117"><a href="#cb3-1117"></a><span class="co"># check</span></span>
<span id="cb3-1118"><a href="#cb3-1118"></a><span class="fu">mean</span>(original_df<span class="sc">$</span>t0_age) <span class="sc">-</span> <span class="fu">sd</span>(original_df<span class="sc">$</span>t0_age) <span class="co">#</span></span>
<span id="cb3-1119"><a href="#cb3-1119"></a></span>
<span id="cb3-1120"><a href="#cb3-1120"></a><span class="co"># if we have specific groups to compare</span></span>
<span id="cb3-1121"><a href="#cb3-1121"></a>complex_condition_age_under_neg_1_sd  <span class="ot">&lt;-</span> X[, <span class="st">"t0_age_z"</span>] <span class="sc">&lt;</span> <span class="sc">-</span><span class="dv">1</span> </span>
<span id="cb3-1122"><a href="#cb3-1122"></a>complex_condition_age_gr_eq_neg_1_sd  <span class="ot">&lt;-</span> X[, <span class="st">"t0_age_z"</span>] <span class="sc">&gt;=</span> <span class="sc">-</span><span class="dv">1</span> </span>
<span id="cb3-1123"><a href="#cb3-1123"></a></span>
<span id="cb3-1124"><a href="#cb3-1124"></a><span class="co"># age subsets</span></span>
<span id="cb3-1125"><a href="#cb3-1125"></a>subsets_standard_cohort <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-1126"><a href="#cb3-1126"></a>  <span class="at">under_37 =</span> <span class="fu">list</span>(</span>
<span id="cb3-1127"><a href="#cb3-1127"></a>    <span class="at">value =</span> complex_condition_age_under_neg_1_sd,</span>
<span id="cb3-1128"><a href="#cb3-1128"></a>    <span class="at">description =</span> <span class="st">"under_37"</span></span>
<span id="cb3-1129"><a href="#cb3-1129"></a>  ),</span>
<span id="cb3-1130"><a href="#cb3-1130"></a>  <span class="at">over_37 =</span> <span class="fu">list</span>(</span>
<span id="cb3-1131"><a href="#cb3-1131"></a>    <span class="at">value =</span> complex_condition_age_gr_eq_neg_1_sd,</span>
<span id="cb3-1132"><a href="#cb3-1132"></a>    <span class="at">description =</span> <span class="st">"37 and over"</span></span>
<span id="cb3-1133"><a href="#cb3-1133"></a>  )</span>
<span id="cb3-1134"><a href="#cb3-1134"></a>)</span>
<span id="cb3-1135"><a href="#cb3-1135"></a></span>
<span id="cb3-1136"><a href="#cb3-1136"></a><span class="co"># batch planned subgroup analysis -----------------------------------------</span></span>
<span id="cb3-1137"><a href="#cb3-1137"></a><span class="co"># set up lists of models, names, and subtitles</span></span>
<span id="cb3-1138"><a href="#cb3-1138"></a>domain_models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-1139"><a href="#cb3-1139"></a>  models_binary_health,</span>
<span id="cb3-1140"><a href="#cb3-1140"></a>  models_binary_psych,</span>
<span id="cb3-1141"><a href="#cb3-1141"></a>  models_binary_present,</span>
<span id="cb3-1142"><a href="#cb3-1142"></a>  models_binary_life,</span>
<span id="cb3-1143"><a href="#cb3-1143"></a>  models_binary_social</span>
<span id="cb3-1144"><a href="#cb3-1144"></a>)</span>
<span id="cb3-1145"><a href="#cb3-1145"></a></span>
<span id="cb3-1146"><a href="#cb3-1146"></a><span class="co"># set up domain names</span></span>
<span id="cb3-1147"><a href="#cb3-1147"></a>domain_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"health"</span>, <span class="st">"psych"</span>, <span class="st">"present"</span>, <span class="st">"life"</span>, <span class="st">"social"</span>)</span>
<span id="cb3-1148"><a href="#cb3-1148"></a></span>
<span id="cb3-1149"><a href="#cb3-1149"></a><span class="co"># set up subtitles</span></span>
<span id="cb3-1150"><a href="#cb3-1150"></a>subtitles <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb3-1151"><a href="#cb3-1151"></a>  subtitle_health,</span>
<span id="cb3-1152"><a href="#cb3-1152"></a>  subtitle_psych,</span>
<span id="cb3-1153"><a href="#cb3-1153"></a>  subtitle_present,</span>
<span id="cb3-1154"><a href="#cb3-1154"></a>  subtitle_life,</span>
<span id="cb3-1155"><a href="#cb3-1155"></a>  subtitle_social</span>
<span id="cb3-1156"><a href="#cb3-1156"></a>)</span>
<span id="cb3-1157"><a href="#cb3-1157"></a></span>
<span id="cb3-1158"><a href="#cb3-1158"></a><span class="co"># set up subset types in a list</span></span>
<span id="cb3-1159"><a href="#cb3-1159"></a>subset_types <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-1160"><a href="#cb3-1160"></a>  <span class="at">wealth =</span> subsets_standard_wealth,</span>
<span id="cb3-1161"><a href="#cb3-1161"></a>  <span class="at">ethnicity =</span> subsets_standard_ethnicity,</span>
<span id="cb3-1162"><a href="#cb3-1162"></a>  <span class="at">political =</span> subsets_standard_political,</span>
<span id="cb3-1163"><a href="#cb3-1163"></a>  <span class="at">gender =</span> subsets_standard_gender<span class="co">#,</span></span>
<span id="cb3-1164"><a href="#cb3-1164"></a>  <span class="co"># cohort = subsets_standard_cohort</span></span>
<span id="cb3-1165"><a href="#cb3-1165"></a>)</span>
<span id="cb3-1166"><a href="#cb3-1166"></a></span>
<span id="cb3-1167"><a href="#cb3-1167"></a><span class="co"># run the batch processing for all domains and subsets</span></span>
<span id="cb3-1168"><a href="#cb3-1168"></a>planned_subset_results <span class="ot">&lt;-</span> <span class="fu">margot_planned_subgroups_batch</span>(</span>
<span id="cb3-1169"><a href="#cb3-1169"></a>  <span class="at">domain_models =</span> domain_models,</span>
<span id="cb3-1170"><a href="#cb3-1170"></a>  <span class="at">X =</span> X,</span>
<span id="cb3-1171"><a href="#cb3-1171"></a>  <span class="at">base_defaults =</span> base_defaults_binary,</span>
<span id="cb3-1172"><a href="#cb3-1172"></a>  <span class="at">subset_types =</span> subset_types,</span>
<span id="cb3-1173"><a href="#cb3-1173"></a>  <span class="at">original_df =</span> original_df,</span>
<span id="cb3-1174"><a href="#cb3-1174"></a>  <span class="at">domain_names =</span> domain_names,</span>
<span id="cb3-1175"><a href="#cb3-1175"></a>  <span class="at">subtitles =</span> subtitles,</span>
<span id="cb3-1176"><a href="#cb3-1176"></a>  <span class="at">push_mods =</span> push_mods</span>
<span id="cb3-1177"><a href="#cb3-1177"></a>)</span>
<span id="cb3-1178"><a href="#cb3-1178"></a></span>
<span id="cb3-1179"><a href="#cb3-1179"></a><span class="co"># results</span></span>
<span id="cb3-1180"><a href="#cb3-1180"></a><span class="co"># health subgroup</span></span>
<span id="cb3-1181"><a href="#cb3-1181"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>wealth<span class="sc">$</span>explanation)</span>
<span id="cb3-1182"><a href="#cb3-1182"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>ethnicity<span class="sc">$</span>explanation) </span>
<span id="cb3-1183"><a href="#cb3-1183"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>political<span class="sc">$</span>explanation) </span>
<span id="cb3-1184"><a href="#cb3-1184"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>gender<span class="sc">$</span>explanation) </span>
<span id="cb3-1185"><a href="#cb3-1185"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>cohort<span class="sc">$</span>explanation) </span>
<span id="cb3-1186"><a href="#cb3-1186"></a></span>
<span id="cb3-1187"><a href="#cb3-1187"></a></span>
<span id="cb3-1188"><a href="#cb3-1188"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>wealth<span class="sc">$</span>explanation) </span>
<span id="cb3-1189"><a href="#cb3-1189"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>ethnicity<span class="sc">$</span>explanation) </span>
<span id="cb3-1190"><a href="#cb3-1190"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>political<span class="sc">$</span>explanation) </span>
<span id="cb3-1191"><a href="#cb3-1191"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>gender<span class="sc">$</span>explanation) </span>
<span id="cb3-1192"><a href="#cb3-1192"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>cohort<span class="sc">$</span>explanation) </span>
<span id="cb3-1193"><a href="#cb3-1193"></a></span>
<span id="cb3-1194"><a href="#cb3-1194"></a></span>
<span id="cb3-1195"><a href="#cb3-1195"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>present<span class="sc">$</span>wealth<span class="sc">$</span>explanation) </span>
<span id="cb3-1196"><a href="#cb3-1196"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>present<span class="sc">$</span>ethnicity<span class="sc">$</span>explanation) </span>
<span id="cb3-1197"><a href="#cb3-1197"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>present<span class="sc">$</span>political<span class="sc">$</span>explanation) </span>
<span id="cb3-1198"><a href="#cb3-1198"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>present<span class="sc">$</span>gender<span class="sc">$</span>explanation) </span>
<span id="cb3-1199"><a href="#cb3-1199"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>present<span class="sc">$</span>cohort<span class="sc">$</span>explanation) </span>
<span id="cb3-1200"><a href="#cb3-1200"></a></span>
<span id="cb3-1201"><a href="#cb3-1201"></a></span>
<span id="cb3-1202"><a href="#cb3-1202"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>life<span class="sc">$</span>wealth<span class="sc">$</span>explanation) </span>
<span id="cb3-1203"><a href="#cb3-1203"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>life<span class="sc">$</span>ethnicity<span class="sc">$</span>explanation) </span>
<span id="cb3-1204"><a href="#cb3-1204"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>life<span class="sc">$</span>political<span class="sc">$</span>explanation) </span>
<span id="cb3-1205"><a href="#cb3-1205"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>life<span class="sc">$</span>gender<span class="sc">$</span>explanation) </span>
<span id="cb3-1206"><a href="#cb3-1206"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>life<span class="sc">$</span>cohort<span class="sc">$</span>explanation) </span>
<span id="cb3-1207"><a href="#cb3-1207"></a></span>
<span id="cb3-1208"><a href="#cb3-1208"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>social<span class="sc">$</span>wealth<span class="sc">$</span>explanation) </span>
<span id="cb3-1209"><a href="#cb3-1209"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>social<span class="sc">$</span>ethnicity<span class="sc">$</span>explanation) </span>
<span id="cb3-1210"><a href="#cb3-1210"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>social<span class="sc">$</span>political<span class="sc">$</span>explanation) </span>
<span id="cb3-1211"><a href="#cb3-1211"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>social<span class="sc">$</span>gender<span class="sc">$</span>explanation) </span>
<span id="cb3-1212"><a href="#cb3-1212"></a><span class="fu">cat</span>(planned_subset_results<span class="sc">$</span>social<span class="sc">$</span>cohort<span class="sc">$</span>explanation) </span>
<span id="cb3-1213"><a href="#cb3-1213"></a></span>
<span id="cb3-1214"><a href="#cb3-1214"></a></span>
<span id="cb3-1215"><a href="#cb3-1215"></a><span class="co"># combine tables ----------------------------------------------------------</span></span>
<span id="cb3-1216"><a href="#cb3-1216"></a><span class="co"># wrap each domain's table in a list:</span></span>
<span id="cb3-1217"><a href="#cb3-1217"></a><span class="co"># wealth subgroups --------------------------------------------------------</span></span>
<span id="cb3-1218"><a href="#cb3-1218"></a>tables_list_poor <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-1219"><a href="#cb3-1219"></a>  <span class="at">Health =</span> planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>Poor<span class="sc">$</span>transformed_table,</span>
<span id="cb3-1220"><a href="#cb3-1220"></a>  <span class="at">Psych  =</span> planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>Poor<span class="sc">$</span>transformed_table,</span>
<span id="cb3-1221"><a href="#cb3-1221"></a>  <span class="at">Life   =</span> planned_subset_results<span class="sc">$</span>life<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>Poor<span class="sc">$</span>transformed_table,</span>
<span id="cb3-1222"><a href="#cb3-1222"></a>  <span class="at">Social =</span> planned_subset_results<span class="sc">$</span>social<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>Poor<span class="sc">$</span>transformed_table</span>
<span id="cb3-1223"><a href="#cb3-1223"></a>)</span>
<span id="cb3-1224"><a href="#cb3-1224"></a></span>
<span id="cb3-1225"><a href="#cb3-1225"></a><span class="co"># new function bind tables</span></span>
<span id="cb3-1226"><a href="#cb3-1226"></a>margot<span class="sc">::</span><span class="fu">margot_bind_tables</span>(</span>
<span id="cb3-1227"><a href="#cb3-1227"></a>  <span class="at">tables_list =</span> tables_list_poor,</span>
<span id="cb3-1228"><a href="#cb3-1228"></a>  <span class="at">bold =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-1229"><a href="#cb3-1229"></a>  <span class="at">kbl_args =</span> <span class="fu">list</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>, <span class="at">caption =</span> <span class="st">"Wealth Subgroup Analysis: Poor"</span>),</span>
<span id="cb3-1230"><a href="#cb3-1230"></a>  <span class="at">highlight_color =</span> <span class="cn">NULL</span>, </span>
<span id="cb3-1231"><a href="#cb3-1231"></a>  <span class="at">output_format =</span> <span class="st">"html"</span></span>
<span id="cb3-1232"><a href="#cb3-1232"></a>)</span>
<span id="cb3-1233"><a href="#cb3-1233"></a></span>
<span id="cb3-1234"><a href="#cb3-1234"></a><span class="co"># create table list for middle income subgroup</span></span>
<span id="cb3-1235"><a href="#cb3-1235"></a>tables_list_middleincome <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-1236"><a href="#cb3-1236"></a>  <span class="at">Health =</span> planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>MiddleIncome<span class="sc">$</span>transformed_table,</span>
<span id="cb3-1237"><a href="#cb3-1237"></a>  <span class="at">Psych  =</span> planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>MiddleIncome<span class="sc">$</span>transformed_table,</span>
<span id="cb3-1238"><a href="#cb3-1238"></a>  <span class="at">Life   =</span> planned_subset_results<span class="sc">$</span>life<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>MiddleIncome<span class="sc">$</span>transformed_table,</span>
<span id="cb3-1239"><a href="#cb3-1239"></a>  <span class="at">Social =</span> planned_subset_results<span class="sc">$</span>social<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>MiddleIncome<span class="sc">$</span>transformed_table</span>
<span id="cb3-1240"><a href="#cb3-1240"></a>)</span>
<span id="cb3-1241"><a href="#cb3-1241"></a></span>
<span id="cb3-1242"><a href="#cb3-1242"></a><span class="co"># bind tables and display results</span></span>
<span id="cb3-1243"><a href="#cb3-1243"></a>margot<span class="sc">::</span><span class="fu">margot_bind_tables</span>(</span>
<span id="cb3-1244"><a href="#cb3-1244"></a>  <span class="at">tables_list =</span> tables_list_middleincome,</span>
<span id="cb3-1245"><a href="#cb3-1245"></a>  <span class="at">bold =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-1246"><a href="#cb3-1246"></a>  <span class="at">kbl_args =</span> <span class="fu">list</span>(</span>
<span id="cb3-1247"><a href="#cb3-1247"></a>    <span class="at">booktabs =</span> <span class="cn">TRUE</span>, </span>
<span id="cb3-1248"><a href="#cb3-1248"></a>    <span class="at">caption =</span> <span class="st">"Wealth Subgroup Analysis: Middle Income"</span></span>
<span id="cb3-1249"><a href="#cb3-1249"></a>  ),</span>
<span id="cb3-1250"><a href="#cb3-1250"></a>  <span class="at">highlight_color =</span> <span class="cn">NULL</span>, </span>
<span id="cb3-1251"><a href="#cb3-1251"></a>  <span class="at">output_format =</span> <span class="st">"html"</span></span>
<span id="cb3-1252"><a href="#cb3-1252"></a>)</span>
<span id="cb3-1253"><a href="#cb3-1253"></a></span>
<span id="cb3-1254"><a href="#cb3-1254"></a>planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>Rich<span class="sc">$</span>transformed_table</span>
<span id="cb3-1255"><a href="#cb3-1255"></a></span>
<span id="cb3-1256"><a href="#cb3-1256"></a>tables_list_rich <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-1257"><a href="#cb3-1257"></a>  <span class="at">Health =</span> planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>Rich<span class="sc">$</span>transformed_table,</span>
<span id="cb3-1258"><a href="#cb3-1258"></a>  <span class="at">Psych  =</span> planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>Rich<span class="sc">$</span>transformed_table,</span>
<span id="cb3-1259"><a href="#cb3-1259"></a>  <span class="at">Life   =</span> planned_subset_results<span class="sc">$</span>life<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>Rich<span class="sc">$</span>transformed_table,</span>
<span id="cb3-1260"><a href="#cb3-1260"></a>  <span class="at">Social =</span> planned_subset_results<span class="sc">$</span>social<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>Rich<span class="sc">$</span>transformed_table</span>
<span id="cb3-1261"><a href="#cb3-1261"></a>)</span>
<span id="cb3-1262"><a href="#cb3-1262"></a></span>
<span id="cb3-1263"><a href="#cb3-1263"></a></span>
<span id="cb3-1264"><a href="#cb3-1264"></a><span class="co"># new function bind tables</span></span>
<span id="cb3-1265"><a href="#cb3-1265"></a>margot<span class="sc">::</span><span class="fu">margot_bind_tables</span>(</span>
<span id="cb3-1266"><a href="#cb3-1266"></a>  <span class="at">tables_list =</span> tables_list_rich,</span>
<span id="cb3-1267"><a href="#cb3-1267"></a>  <span class="at">bold =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-1268"><a href="#cb3-1268"></a>  <span class="at">kbl_args =</span> <span class="fu">list</span>(</span>
<span id="cb3-1269"><a href="#cb3-1269"></a>    <span class="at">booktabs =</span> <span class="cn">TRUE</span>, </span>
<span id="cb3-1270"><a href="#cb3-1270"></a>    <span class="at">caption =</span> <span class="st">"Wealth Subgroup Analysis: Rich"</span></span>
<span id="cb3-1271"><a href="#cb3-1271"></a>  ),</span>
<span id="cb3-1272"><a href="#cb3-1272"></a>  <span class="at">highlight_color =</span> <span class="cn">NULL</span>, </span>
<span id="cb3-1273"><a href="#cb3-1273"></a>  <span class="at">output_format =</span> <span class="st">"html"</span></span>
<span id="cb3-1274"><a href="#cb3-1274"></a>)</span>
<span id="cb3-1275"><a href="#cb3-1275"></a></span>
<span id="cb3-1276"><a href="#cb3-1276"></a><span class="co"># cohort subgroups --------------------------------------------------------</span></span>
<span id="cb3-1277"><a href="#cb3-1277"></a></span>
<span id="cb3-1278"><a href="#cb3-1278"></a><span class="co"># wealth subgroups --------------------------------------------------------</span></span>
<span id="cb3-1279"><a href="#cb3-1279"></a>planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Generation_X<span class="sc">$</span>transformed_table</span>
<span id="cb3-1280"><a href="#cb3-1280"></a></span>
<span id="cb3-1281"><a href="#cb3-1281"></a>planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Boomers<span class="sc">$</span>transformed_table</span>
<span id="cb3-1282"><a href="#cb3-1282"></a>tables_list_boomers <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-1283"><a href="#cb3-1283"></a>  <span class="at">Health =</span> planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Boomers<span class="sc">$</span>transformed_table,</span>
<span id="cb3-1284"><a href="#cb3-1284"></a>  <span class="at">Psych  =</span> planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Boomers<span class="sc">$</span>transformed_table,</span>
<span id="cb3-1285"><a href="#cb3-1285"></a>  <span class="at">Life   =</span> planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Boomers<span class="sc">$</span>transformed_table,</span>
<span id="cb3-1286"><a href="#cb3-1286"></a>  <span class="at">Social =</span> planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Boomers<span class="sc">$</span>transformed_table</span>
<span id="cb3-1287"><a href="#cb3-1287"></a>)</span>
<span id="cb3-1288"><a href="#cb3-1288"></a></span>
<span id="cb3-1289"><a href="#cb3-1289"></a></span>
<span id="cb3-1290"><a href="#cb3-1290"></a><span class="co"># new function bind tables</span></span>
<span id="cb3-1291"><a href="#cb3-1291"></a>margot<span class="sc">::</span><span class="fu">margot_bind_tables</span>(</span>
<span id="cb3-1292"><a href="#cb3-1292"></a>  <span class="at">tables_list =</span> tables_list_boomers,</span>
<span id="cb3-1293"><a href="#cb3-1293"></a>  <span class="at">bold =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-1294"><a href="#cb3-1294"></a>  <span class="at">kbl_args =</span> <span class="fu">list</span>(</span>
<span id="cb3-1295"><a href="#cb3-1295"></a>    <span class="at">booktabs =</span> <span class="cn">TRUE</span>, </span>
<span id="cb3-1296"><a href="#cb3-1296"></a>    <span class="at">caption =</span> <span class="st">"Cohort Subgroup Analysis: Boomers"</span></span>
<span id="cb3-1297"><a href="#cb3-1297"></a>  ),</span>
<span id="cb3-1298"><a href="#cb3-1298"></a>  <span class="at">highlight_color =</span> <span class="cn">NULL</span>,</span>
<span id="cb3-1299"><a href="#cb3-1299"></a>  <span class="at">output_format =</span> <span class="st">"html"</span></span>
<span id="cb3-1300"><a href="#cb3-1300"></a>)</span>
<span id="cb3-1301"><a href="#cb3-1301"></a></span>
<span id="cb3-1302"><a href="#cb3-1302"></a></span>
<span id="cb3-1303"><a href="#cb3-1303"></a><span class="co"># margot_bind_tables(tables_list = tables_lisblue()# margot_bind_tables(tables_list = tables_list,</span></span>
<span id="cb3-1304"><a href="#cb3-1304"></a><span class="co">#                    bold = TRUE,</span></span>
<span id="cb3-1305"><a href="#cb3-1305"></a><span class="co">#                    highlight_color = NULL, output_format = "latex")</span></span>
<span id="cb3-1306"><a href="#cb3-1306"></a>tables_list_genZ <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-1307"><a href="#cb3-1307"></a>  <span class="at">Health =</span> planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Generation_Z<span class="sc">$</span>transformed_table,</span>
<span id="cb3-1308"><a href="#cb3-1308"></a>  <span class="at">Psych  =</span> planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Generation_Z<span class="sc">$</span>transformed_table,</span>
<span id="cb3-1309"><a href="#cb3-1309"></a>  <span class="at">Life   =</span> planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Generation_Z<span class="sc">$</span>transformed_table,</span>
<span id="cb3-1310"><a href="#cb3-1310"></a>  <span class="at">Social =</span> planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Generation_Z<span class="sc">$</span>transformed_table</span>
<span id="cb3-1311"><a href="#cb3-1311"></a>)</span>
<span id="cb3-1312"><a href="#cb3-1312"></a></span>
<span id="cb3-1313"><a href="#cb3-1313"></a></span>
<span id="cb3-1314"><a href="#cb3-1314"></a><span class="co"># new function bind tables</span></span>
<span id="cb3-1315"><a href="#cb3-1315"></a><span class="co"># new function bind tables</span></span>
<span id="cb3-1316"><a href="#cb3-1316"></a>margot<span class="sc">::</span><span class="fu">margot_bind_tables</span>(</span>
<span id="cb3-1317"><a href="#cb3-1317"></a>  <span class="at">tables_list =</span> tables_list_genZ,</span>
<span id="cb3-1318"><a href="#cb3-1318"></a>  <span class="at">bold =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-1319"><a href="#cb3-1319"></a>  <span class="at">kbl_args =</span> <span class="fu">list</span>(</span>
<span id="cb3-1320"><a href="#cb3-1320"></a>    <span class="at">booktabs =</span> <span class="cn">TRUE</span>, </span>
<span id="cb3-1321"><a href="#cb3-1321"></a>    <span class="at">caption =</span> <span class="st">"Cohort Subgroup Analysis: Generation Z"</span></span>
<span id="cb3-1322"><a href="#cb3-1322"></a>  ),</span>
<span id="cb3-1323"><a href="#cb3-1323"></a>  <span class="at">highlight_color =</span> <span class="cn">NULL</span>,</span>
<span id="cb3-1324"><a href="#cb3-1324"></a>  <span class="at">output_format =</span> <span class="st">"html"</span></span>
<span id="cb3-1325"><a href="#cb3-1325"></a>)</span>
<span id="cb3-1326"><a href="#cb3-1326"></a></span>
<span id="cb3-1327"><a href="#cb3-1327"></a><span class="co"># new function bind tables</span></span>
<span id="cb3-1328"><a href="#cb3-1328"></a>margot<span class="sc">::</span><span class="fu">margot_bind_tables</span>(</span>
<span id="cb3-1329"><a href="#cb3-1329"></a>  <span class="at">tables_list =</span> tables_list_rich,</span>
<span id="cb3-1330"><a href="#cb3-1330"></a>  <span class="at">bold =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-1331"><a href="#cb3-1331"></a>  <span class="at">kbl_args =</span> <span class="fu">list</span>(</span>
<span id="cb3-1332"><a href="#cb3-1332"></a>    <span class="at">booktabs =</span> <span class="cn">TRUE</span>, </span>
<span id="cb3-1333"><a href="#cb3-1333"></a>    <span class="at">caption =</span> <span class="st">"Wealth Subgroup Analysis: Rich"</span></span>
<span id="cb3-1334"><a href="#cb3-1334"></a>  ),</span>
<span id="cb3-1335"><a href="#cb3-1335"></a>  <span class="at">highlight_color =</span> <span class="cn">NULL</span>,</span>
<span id="cb3-1336"><a href="#cb3-1336"></a>  <span class="at">output_format =</span> <span class="st">"html"</span></span>
<span id="cb3-1337"><a href="#cb3-1337"></a>)</span>
<span id="cb3-1338"><a href="#cb3-1338"></a></span>
<span id="cb3-1339"><a href="#cb3-1339"></a></span>
<span id="cb3-1340"><a href="#cb3-1340"></a><span class="co"># plots -------------------------------------------------------------------</span></span>
<span id="cb3-1341"><a href="#cb3-1341"></a><span class="co"># Results Plots</span></span>
<span id="cb3-1342"><a href="#cb3-1342"></a><span class="co"># health</span></span>
<span id="cb3-1343"><a href="#cb3-1343"></a>plots_subgroup_wealth_health <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb3-1344"><a href="#cb3-1344"></a>  <span class="fu">list</span>(</span>
<span id="cb3-1345"><a href="#cb3-1345"></a>    planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>Poor<span class="sc">$</span>plot,</span>
<span id="cb3-1346"><a href="#cb3-1346"></a>    planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>MiddleIncome<span class="sc">$</span>plot,</span>
<span id="cb3-1347"><a href="#cb3-1347"></a>    planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>Rich<span class="sc">$</span>plot</span>
<span id="cb3-1348"><a href="#cb3-1348"></a>  ),</span>
<span id="cb3-1349"><a href="#cb3-1349"></a>  <span class="at">ncol =</span> <span class="dv">1</span></span>
<span id="cb3-1350"><a href="#cb3-1350"></a>) <span class="sc">+</span></span>
<span id="cb3-1351"><a href="#cb3-1351"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb3-1352"><a href="#cb3-1352"></a>    <span class="at">title =</span> subtitle_health,</span>
<span id="cb3-1353"><a href="#cb3-1353"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>,  <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb3-1354"><a href="#cb3-1354"></a>  )</span>
<span id="cb3-1355"><a href="#cb3-1355"></a></span>
<span id="cb3-1356"><a href="#cb3-1356"></a><span class="co"># view</span></span>
<span id="cb3-1357"><a href="#cb3-1357"></a><span class="fu">print</span>(plots_subgroup_wealth_health)</span>
<span id="cb3-1358"><a href="#cb3-1358"></a></span>
<span id="cb3-1359"><a href="#cb3-1359"></a><span class="co"># plots</span></span>
<span id="cb3-1360"><a href="#cb3-1360"></a>plots_subgroup_ethnicity_health<span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb3-1361"><a href="#cb3-1361"></a>  <span class="fu">list</span>(</span>
<span id="cb3-1362"><a href="#cb3-1362"></a>    planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Asian<span class="sc">$</span>plot,</span>
<span id="cb3-1363"><a href="#cb3-1363"></a>    planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Euro<span class="sc">$</span>plot,</span>
<span id="cb3-1364"><a href="#cb3-1364"></a>    planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Maori<span class="sc">$</span>plot,</span>
<span id="cb3-1365"><a href="#cb3-1365"></a>    planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Pacific<span class="sc">$</span>plot</span>
<span id="cb3-1366"><a href="#cb3-1366"></a>  ),</span>
<span id="cb3-1367"><a href="#cb3-1367"></a>  <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb3-1368"><a href="#cb3-1368"></a>)<span class="sc">+</span></span>
<span id="cb3-1369"><a href="#cb3-1369"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb3-1370"><a href="#cb3-1370"></a>    <span class="at">title =</span> subtitle_health,</span>
<span id="cb3-1371"><a href="#cb3-1371"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>,  <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb3-1372"><a href="#cb3-1372"></a>  )</span>
<span id="cb3-1373"><a href="#cb3-1373"></a></span>
<span id="cb3-1374"><a href="#cb3-1374"></a><span class="co"># view</span></span>
<span id="cb3-1375"><a href="#cb3-1375"></a><span class="fu">print</span>(plots_subgroup_ethnicity_health)</span>
<span id="cb3-1376"><a href="#cb3-1376"></a></span>
<span id="cb3-1377"><a href="#cb3-1377"></a><span class="co"># plots</span></span>
<span id="cb3-1378"><a href="#cb3-1378"></a>plots_subgroup_political_health <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb3-1379"><a href="#cb3-1379"></a>  <span class="fu">list</span>(</span>
<span id="cb3-1380"><a href="#cb3-1380"></a>    planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>political<span class="sc">$</span>results<span class="sc">$</span>Conservative<span class="sc">$</span>plot,</span>
<span id="cb3-1381"><a href="#cb3-1381"></a>    planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>political<span class="sc">$</span>results<span class="sc">$</span>Centrist<span class="sc">$</span>plot,</span>
<span id="cb3-1382"><a href="#cb3-1382"></a>    planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>political<span class="sc">$</span>results<span class="sc">$</span>Conservative<span class="sc">$</span>plot</span>
<span id="cb3-1383"><a href="#cb3-1383"></a>  ),</span>
<span id="cb3-1384"><a href="#cb3-1384"></a>  <span class="at">ncol =</span> <span class="dv">1</span></span>
<span id="cb3-1385"><a href="#cb3-1385"></a>)<span class="sc">+</span></span>
<span id="cb3-1386"><a href="#cb3-1386"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb3-1387"><a href="#cb3-1387"></a>    <span class="at">title =</span> subtitle_health,</span>
<span id="cb3-1388"><a href="#cb3-1388"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>,  <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb3-1389"><a href="#cb3-1389"></a>  )</span>
<span id="cb3-1390"><a href="#cb3-1390"></a></span>
<span id="cb3-1391"><a href="#cb3-1391"></a><span class="co"># view</span></span>
<span id="cb3-1392"><a href="#cb3-1392"></a><span class="fu">print</span>(plots_subgroup_political_health)</span>
<span id="cb3-1393"><a href="#cb3-1393"></a></span>
<span id="cb3-1394"><a href="#cb3-1394"></a><span class="co"># plots</span></span>
<span id="cb3-1395"><a href="#cb3-1395"></a>plots_subgroup_gender_health<span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb3-1396"><a href="#cb3-1396"></a>  <span class="fu">list</span>(</span>
<span id="cb3-1397"><a href="#cb3-1397"></a>    planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>gender<span class="sc">$</span>results<span class="sc">$</span>Female<span class="sc">$</span>plot,</span>
<span id="cb3-1398"><a href="#cb3-1398"></a>    planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>gender<span class="sc">$</span>results<span class="sc">$</span>Male<span class="sc">$</span>plot</span>
<span id="cb3-1399"><a href="#cb3-1399"></a>  ),</span>
<span id="cb3-1400"><a href="#cb3-1400"></a>  <span class="at">ncol =</span> <span class="dv">1</span></span>
<span id="cb3-1401"><a href="#cb3-1401"></a>)<span class="sc">+</span></span>
<span id="cb3-1402"><a href="#cb3-1402"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb3-1403"><a href="#cb3-1403"></a>    <span class="at">title =</span> subtitle_health,</span>
<span id="cb3-1404"><a href="#cb3-1404"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>,  <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb3-1405"><a href="#cb3-1405"></a>  )</span>
<span id="cb3-1406"><a href="#cb3-1406"></a></span>
<span id="cb3-1407"><a href="#cb3-1407"></a><span class="co"># view</span></span>
<span id="cb3-1408"><a href="#cb3-1408"></a><span class="fu">print</span>(plots_subgroup_gender_health)</span>
<span id="cb3-1409"><a href="#cb3-1409"></a></span>
<span id="cb3-1410"><a href="#cb3-1410"></a><span class="co"># plots</span></span>
<span id="cb3-1411"><a href="#cb3-1411"></a>plots_subgroup_cohort_health<span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb3-1412"><a href="#cb3-1412"></a>  <span class="fu">list</span>(</span>
<span id="cb3-1413"><a href="#cb3-1413"></a>    planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Boomers<span class="sc">$</span>plot,</span>
<span id="cb3-1414"><a href="#cb3-1414"></a>    planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Generation_X<span class="sc">$</span>plot,</span>
<span id="cb3-1415"><a href="#cb3-1415"></a>    planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Generation_Y<span class="sc">$</span>plot,</span>
<span id="cb3-1416"><a href="#cb3-1416"></a>    planned_subset_results<span class="sc">$</span>health<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Generation_Z<span class="sc">$</span>plot</span>
<span id="cb3-1417"><a href="#cb3-1417"></a>    </span>
<span id="cb3-1418"><a href="#cb3-1418"></a>  ),</span>
<span id="cb3-1419"><a href="#cb3-1419"></a>  <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb3-1420"><a href="#cb3-1420"></a>)<span class="sc">+</span></span>
<span id="cb3-1421"><a href="#cb3-1421"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb3-1422"><a href="#cb3-1422"></a>    <span class="at">title =</span> subtitle_health,</span>
<span id="cb3-1423"><a href="#cb3-1423"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>,  <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb3-1424"><a href="#cb3-1424"></a>  )</span>
<span id="cb3-1425"><a href="#cb3-1425"></a></span>
<span id="cb3-1426"><a href="#cb3-1426"></a><span class="co"># view</span></span>
<span id="cb3-1427"><a href="#cb3-1427"></a><span class="fu">print</span>(plots_subgroup_cohort_health)</span>
<span id="cb3-1428"><a href="#cb3-1428"></a></span>
<span id="cb3-1429"><a href="#cb3-1429"></a><span class="co"># psychological well-being</span></span>
<span id="cb3-1430"><a href="#cb3-1430"></a>plots_subgroup_wealth_psych <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb3-1431"><a href="#cb3-1431"></a>  <span class="fu">list</span>(</span>
<span id="cb3-1432"><a href="#cb3-1432"></a>    planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>Poor<span class="sc">$</span>plot,</span>
<span id="cb3-1433"><a href="#cb3-1433"></a>    planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>MiddleIncome<span class="sc">$</span>plot,</span>
<span id="cb3-1434"><a href="#cb3-1434"></a>    planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>Rich<span class="sc">$</span>plot</span>
<span id="cb3-1435"><a href="#cb3-1435"></a>  ),</span>
<span id="cb3-1436"><a href="#cb3-1436"></a>  <span class="at">ncol =</span> <span class="dv">1</span></span>
<span id="cb3-1437"><a href="#cb3-1437"></a>) <span class="sc">+</span></span>
<span id="cb3-1438"><a href="#cb3-1438"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb3-1439"><a href="#cb3-1439"></a>    <span class="at">title =</span> subtitle_psych,</span>
<span id="cb3-1440"><a href="#cb3-1440"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>,  <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb3-1441"><a href="#cb3-1441"></a>  )</span>
<span id="cb3-1442"><a href="#cb3-1442"></a></span>
<span id="cb3-1443"><a href="#cb3-1443"></a><span class="co"># view</span></span>
<span id="cb3-1444"><a href="#cb3-1444"></a><span class="fu">print</span>(plots_subgroup_wealth_psych)</span>
<span id="cb3-1445"><a href="#cb3-1445"></a></span>
<span id="cb3-1446"><a href="#cb3-1446"></a><span class="co"># plots</span></span>
<span id="cb3-1447"><a href="#cb3-1447"></a>plots_subgroup_ethnicity_psych<span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb3-1448"><a href="#cb3-1448"></a>  <span class="fu">list</span>(</span>
<span id="cb3-1449"><a href="#cb3-1449"></a>    planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Asian<span class="sc">$</span>plot,</span>
<span id="cb3-1450"><a href="#cb3-1450"></a>    planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Euro<span class="sc">$</span>plot,</span>
<span id="cb3-1451"><a href="#cb3-1451"></a>    planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Maori<span class="sc">$</span>plot,</span>
<span id="cb3-1452"><a href="#cb3-1452"></a>    planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Pacific<span class="sc">$</span>plot</span>
<span id="cb3-1453"><a href="#cb3-1453"></a>  ),</span>
<span id="cb3-1454"><a href="#cb3-1454"></a>  <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb3-1455"><a href="#cb3-1455"></a>)<span class="sc">+</span></span>
<span id="cb3-1456"><a href="#cb3-1456"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb3-1457"><a href="#cb3-1457"></a>    <span class="at">title =</span> subtitle_psych,</span>
<span id="cb3-1458"><a href="#cb3-1458"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>,  <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb3-1459"><a href="#cb3-1459"></a>  )</span>
<span id="cb3-1460"><a href="#cb3-1460"></a></span>
<span id="cb3-1461"><a href="#cb3-1461"></a><span class="co"># view</span></span>
<span id="cb3-1462"><a href="#cb3-1462"></a><span class="fu">print</span>(plots_subgroup_ethnicity_psych)</span>
<span id="cb3-1463"><a href="#cb3-1463"></a></span>
<span id="cb3-1464"><a href="#cb3-1464"></a><span class="co"># plots</span></span>
<span id="cb3-1465"><a href="#cb3-1465"></a>plots_subgroup_political_psych <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb3-1466"><a href="#cb3-1466"></a>  <span class="fu">list</span>(</span>
<span id="cb3-1467"><a href="#cb3-1467"></a>    planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>political<span class="sc">$</span>results<span class="sc">$</span>Conservative<span class="sc">$</span>plot,</span>
<span id="cb3-1468"><a href="#cb3-1468"></a>    planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>political<span class="sc">$</span>results<span class="sc">$</span>Centrist<span class="sc">$</span>plot,</span>
<span id="cb3-1469"><a href="#cb3-1469"></a>    planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>political<span class="sc">$</span>results<span class="sc">$</span>Conservative<span class="sc">$</span>plot</span>
<span id="cb3-1470"><a href="#cb3-1470"></a>  ),</span>
<span id="cb3-1471"><a href="#cb3-1471"></a>  <span class="at">ncol =</span> <span class="dv">1</span></span>
<span id="cb3-1472"><a href="#cb3-1472"></a>)<span class="sc">+</span></span>
<span id="cb3-1473"><a href="#cb3-1473"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb3-1474"><a href="#cb3-1474"></a>    <span class="at">title =</span> subtitle_psych,</span>
<span id="cb3-1475"><a href="#cb3-1475"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>,  <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb3-1476"><a href="#cb3-1476"></a>  )</span>
<span id="cb3-1477"><a href="#cb3-1477"></a></span>
<span id="cb3-1478"><a href="#cb3-1478"></a><span class="co"># view</span></span>
<span id="cb3-1479"><a href="#cb3-1479"></a><span class="fu">print</span>(plots_subgroup_political_psych)</span>
<span id="cb3-1480"><a href="#cb3-1480"></a></span>
<span id="cb3-1481"><a href="#cb3-1481"></a><span class="co"># plots</span></span>
<span id="cb3-1482"><a href="#cb3-1482"></a>plots_subgroup_gender_psych<span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb3-1483"><a href="#cb3-1483"></a>  <span class="fu">list</span>(</span>
<span id="cb3-1484"><a href="#cb3-1484"></a>    planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>gender<span class="sc">$</span>results<span class="sc">$</span>Female<span class="sc">$</span>plot,</span>
<span id="cb3-1485"><a href="#cb3-1485"></a>    planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>gender<span class="sc">$</span>results<span class="sc">$</span>Male<span class="sc">$</span>plot</span>
<span id="cb3-1486"><a href="#cb3-1486"></a>  ),</span>
<span id="cb3-1487"><a href="#cb3-1487"></a>  <span class="at">ncol =</span> <span class="dv">1</span></span>
<span id="cb3-1488"><a href="#cb3-1488"></a>)<span class="sc">+</span></span>
<span id="cb3-1489"><a href="#cb3-1489"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb3-1490"><a href="#cb3-1490"></a>    <span class="at">title =</span> subtitle_psych,</span>
<span id="cb3-1491"><a href="#cb3-1491"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>,  <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb3-1492"><a href="#cb3-1492"></a>  )</span>
<span id="cb3-1493"><a href="#cb3-1493"></a></span>
<span id="cb3-1494"><a href="#cb3-1494"></a><span class="co"># view</span></span>
<span id="cb3-1495"><a href="#cb3-1495"></a><span class="fu">print</span>(plots_subgroup_gender_psych)</span>
<span id="cb3-1496"><a href="#cb3-1496"></a></span>
<span id="cb3-1497"><a href="#cb3-1497"></a><span class="co"># plots</span></span>
<span id="cb3-1498"><a href="#cb3-1498"></a>plots_subgroup_cohort_psych<span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb3-1499"><a href="#cb3-1499"></a>  <span class="fu">list</span>(</span>
<span id="cb3-1500"><a href="#cb3-1500"></a>    planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Boomers<span class="sc">$</span>plot,</span>
<span id="cb3-1501"><a href="#cb3-1501"></a>    planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Generation_X<span class="sc">$</span>plot,</span>
<span id="cb3-1502"><a href="#cb3-1502"></a>    planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Generation_Y<span class="sc">$</span>plot,</span>
<span id="cb3-1503"><a href="#cb3-1503"></a>    planned_subset_results<span class="sc">$</span>psych<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Generation_Z<span class="sc">$</span>plot</span>
<span id="cb3-1504"><a href="#cb3-1504"></a>    </span>
<span id="cb3-1505"><a href="#cb3-1505"></a>  ),</span>
<span id="cb3-1506"><a href="#cb3-1506"></a>  <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb3-1507"><a href="#cb3-1507"></a>)<span class="sc">+</span></span>
<span id="cb3-1508"><a href="#cb3-1508"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb3-1509"><a href="#cb3-1509"></a>    <span class="at">title =</span> subtitle_psych,</span>
<span id="cb3-1510"><a href="#cb3-1510"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>,  <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb3-1511"><a href="#cb3-1511"></a>  )</span>
<span id="cb3-1512"><a href="#cb3-1512"></a></span>
<span id="cb3-1513"><a href="#cb3-1513"></a><span class="co"># view</span></span>
<span id="cb3-1514"><a href="#cb3-1514"></a><span class="fu">print</span>(plots_subgroup_cohort_psych)</span>
<span id="cb3-1515"><a href="#cb3-1515"></a></span>
<span id="cb3-1516"><a href="#cb3-1516"></a><span class="co"># present focussed well-being</span></span>
<span id="cb3-1517"><a href="#cb3-1517"></a>plots_subgroup_wealth_present <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb3-1518"><a href="#cb3-1518"></a>  <span class="fu">list</span>(</span>
<span id="cb3-1519"><a href="#cb3-1519"></a>    planned_subset_results<span class="sc">$</span>present<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>Poor<span class="sc">$</span>plot,</span>
<span id="cb3-1520"><a href="#cb3-1520"></a>    planned_subset_results<span class="sc">$</span>present<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>MiddleIncome<span class="sc">$</span>plot,</span>
<span id="cb3-1521"><a href="#cb3-1521"></a>    planned_subset_results<span class="sc">$</span>present<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>Rich<span class="sc">$</span>plot</span>
<span id="cb3-1522"><a href="#cb3-1522"></a>  ),</span>
<span id="cb3-1523"><a href="#cb3-1523"></a>  <span class="at">ncol =</span> <span class="dv">1</span></span>
<span id="cb3-1524"><a href="#cb3-1524"></a>) <span class="sc">+</span></span>
<span id="cb3-1525"><a href="#cb3-1525"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb3-1526"><a href="#cb3-1526"></a>    <span class="at">title =</span> subtitle_present,</span>
<span id="cb3-1527"><a href="#cb3-1527"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>,  <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb3-1528"><a href="#cb3-1528"></a>  )</span>
<span id="cb3-1529"><a href="#cb3-1529"></a></span>
<span id="cb3-1530"><a href="#cb3-1530"></a><span class="co"># view</span></span>
<span id="cb3-1531"><a href="#cb3-1531"></a><span class="fu">print</span>(plots_subgroup_wealth_present)</span>
<span id="cb3-1532"><a href="#cb3-1532"></a></span>
<span id="cb3-1533"><a href="#cb3-1533"></a><span class="co"># plots</span></span>
<span id="cb3-1534"><a href="#cb3-1534"></a>plots_subgroup_ethnicity_present<span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb3-1535"><a href="#cb3-1535"></a>  <span class="fu">list</span>(</span>
<span id="cb3-1536"><a href="#cb3-1536"></a>    planned_subset_results<span class="sc">$</span>present<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Asian<span class="sc">$</span>plot,</span>
<span id="cb3-1537"><a href="#cb3-1537"></a>    planned_subset_results<span class="sc">$</span>present<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Euro<span class="sc">$</span>plot,</span>
<span id="cb3-1538"><a href="#cb3-1538"></a>    planned_subset_results<span class="sc">$</span>present<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Maori<span class="sc">$</span>plot,</span>
<span id="cb3-1539"><a href="#cb3-1539"></a>    planned_subset_results<span class="sc">$</span>present<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Pacific<span class="sc">$</span>plot</span>
<span id="cb3-1540"><a href="#cb3-1540"></a>  ),</span>
<span id="cb3-1541"><a href="#cb3-1541"></a>  <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb3-1542"><a href="#cb3-1542"></a>)<span class="sc">+</span></span>
<span id="cb3-1543"><a href="#cb3-1543"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb3-1544"><a href="#cb3-1544"></a>    <span class="at">title =</span> subtitle_present,</span>
<span id="cb3-1545"><a href="#cb3-1545"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>,  <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb3-1546"><a href="#cb3-1546"></a>  )</span>
<span id="cb3-1547"><a href="#cb3-1547"></a></span>
<span id="cb3-1548"><a href="#cb3-1548"></a><span class="co"># view</span></span>
<span id="cb3-1549"><a href="#cb3-1549"></a><span class="fu">print</span>(plots_subgroup_ethnicity_present)</span>
<span id="cb3-1550"><a href="#cb3-1550"></a></span>
<span id="cb3-1551"><a href="#cb3-1551"></a><span class="co"># plots</span></span>
<span id="cb3-1552"><a href="#cb3-1552"></a>plots_subgroup_political_present <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb3-1553"><a href="#cb3-1553"></a>  <span class="fu">list</span>(</span>
<span id="cb3-1554"><a href="#cb3-1554"></a>    planned_subset_results<span class="sc">$</span>present<span class="sc">$</span>political<span class="sc">$</span>results<span class="sc">$</span>Conservative<span class="sc">$</span>plot,</span>
<span id="cb3-1555"><a href="#cb3-1555"></a>    planned_subset_results<span class="sc">$</span>present<span class="sc">$</span>political<span class="sc">$</span>results<span class="sc">$</span>Centrist<span class="sc">$</span>plot,</span>
<span id="cb3-1556"><a href="#cb3-1556"></a>    planned_subset_results<span class="sc">$</span>present<span class="sc">$</span>political<span class="sc">$</span>results<span class="sc">$</span>Conservative<span class="sc">$</span>plot</span>
<span id="cb3-1557"><a href="#cb3-1557"></a>  ),</span>
<span id="cb3-1558"><a href="#cb3-1558"></a>  <span class="at">ncol =</span> <span class="dv">1</span></span>
<span id="cb3-1559"><a href="#cb3-1559"></a>)<span class="sc">+</span></span>
<span id="cb3-1560"><a href="#cb3-1560"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb3-1561"><a href="#cb3-1561"></a>    <span class="at">title =</span> subtitle_present,</span>
<span id="cb3-1562"><a href="#cb3-1562"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>,  <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb3-1563"><a href="#cb3-1563"></a>  )</span>
<span id="cb3-1564"><a href="#cb3-1564"></a></span>
<span id="cb3-1565"><a href="#cb3-1565"></a><span class="co"># view</span></span>
<span id="cb3-1566"><a href="#cb3-1566"></a><span class="fu">print</span>(plots_subgroup_political_present)</span>
<span id="cb3-1567"><a href="#cb3-1567"></a></span>
<span id="cb3-1568"><a href="#cb3-1568"></a><span class="co"># plots</span></span>
<span id="cb3-1569"><a href="#cb3-1569"></a>plots_subgroup_gender_present<span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb3-1570"><a href="#cb3-1570"></a>  <span class="fu">list</span>(</span>
<span id="cb3-1571"><a href="#cb3-1571"></a>    planned_subset_results<span class="sc">$</span>present<span class="sc">$</span>gender<span class="sc">$</span>results<span class="sc">$</span>Female<span class="sc">$</span>plot,</span>
<span id="cb3-1572"><a href="#cb3-1572"></a>    planned_subset_results<span class="sc">$</span>present<span class="sc">$</span>gender<span class="sc">$</span>results<span class="sc">$</span>Male<span class="sc">$</span>plot</span>
<span id="cb3-1573"><a href="#cb3-1573"></a>  ),</span>
<span id="cb3-1574"><a href="#cb3-1574"></a>  <span class="at">ncol =</span> <span class="dv">1</span></span>
<span id="cb3-1575"><a href="#cb3-1575"></a>)<span class="sc">+</span></span>
<span id="cb3-1576"><a href="#cb3-1576"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb3-1577"><a href="#cb3-1577"></a>    <span class="at">title =</span> subtitle_present,</span>
<span id="cb3-1578"><a href="#cb3-1578"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>,  <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb3-1579"><a href="#cb3-1579"></a>  )</span>
<span id="cb3-1580"><a href="#cb3-1580"></a></span>
<span id="cb3-1581"><a href="#cb3-1581"></a><span class="co"># view  </span></span>
<span id="cb3-1582"><a href="#cb3-1582"></a><span class="fu">print</span>(plots_subgroup_gender_present)</span>
<span id="cb3-1583"><a href="#cb3-1583"></a></span>
<span id="cb3-1584"><a href="#cb3-1584"></a><span class="co"># plots</span></span>
<span id="cb3-1585"><a href="#cb3-1585"></a>plots_subgroup_cohort_present<span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb3-1586"><a href="#cb3-1586"></a>  <span class="fu">list</span>(</span>
<span id="cb3-1587"><a href="#cb3-1587"></a>    planned_subset_results<span class="sc">$</span>present<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Boomers<span class="sc">$</span>plot,</span>
<span id="cb3-1588"><a href="#cb3-1588"></a>    planned_subset_results<span class="sc">$</span>present<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Generation_X<span class="sc">$</span>plot,</span>
<span id="cb3-1589"><a href="#cb3-1589"></a>    planned_subset_results<span class="sc">$</span>present<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Generation_Y<span class="sc">$</span>plot,</span>
<span id="cb3-1590"><a href="#cb3-1590"></a>    planned_subset_results<span class="sc">$</span>present<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Generation_Z<span class="sc">$</span>plot</span>
<span id="cb3-1591"><a href="#cb3-1591"></a>    </span>
<span id="cb3-1592"><a href="#cb3-1592"></a>  ),</span>
<span id="cb3-1593"><a href="#cb3-1593"></a>  <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb3-1594"><a href="#cb3-1594"></a>)<span class="sc">+</span></span>
<span id="cb3-1595"><a href="#cb3-1595"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb3-1596"><a href="#cb3-1596"></a>    <span class="at">title =</span> subtitle_present,</span>
<span id="cb3-1597"><a href="#cb3-1597"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>,  <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb3-1598"><a href="#cb3-1598"></a>  )</span>
<span id="cb3-1599"><a href="#cb3-1599"></a></span>
<span id="cb3-1600"><a href="#cb3-1600"></a><span class="co"># view</span></span>
<span id="cb3-1601"><a href="#cb3-1601"></a><span class="fu">print</span>(plots_subgroup_cohort_present)</span>
<span id="cb3-1602"><a href="#cb3-1602"></a></span>
<span id="cb3-1603"><a href="#cb3-1603"></a></span>
<span id="cb3-1604"><a href="#cb3-1604"></a><span class="do">## life focussed well-being</span></span>
<span id="cb3-1605"><a href="#cb3-1605"></a>plots_subgroup_wealth_life <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb3-1606"><a href="#cb3-1606"></a>  <span class="fu">list</span>(</span>
<span id="cb3-1607"><a href="#cb3-1607"></a>    planned_subset_results<span class="sc">$</span>life<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>Poor<span class="sc">$</span>plot,</span>
<span id="cb3-1608"><a href="#cb3-1608"></a>    planned_subset_results<span class="sc">$</span>life<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>MiddleIncome<span class="sc">$</span>plot,</span>
<span id="cb3-1609"><a href="#cb3-1609"></a>    planned_subset_results<span class="sc">$</span>life<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>Rich<span class="sc">$</span>plot</span>
<span id="cb3-1610"><a href="#cb3-1610"></a>  ),</span>
<span id="cb3-1611"><a href="#cb3-1611"></a>  <span class="at">ncol =</span> <span class="dv">1</span></span>
<span id="cb3-1612"><a href="#cb3-1612"></a>) <span class="sc">+</span></span>
<span id="cb3-1613"><a href="#cb3-1613"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb3-1614"><a href="#cb3-1614"></a>    <span class="at">title =</span> subtitle_life,</span>
<span id="cb3-1615"><a href="#cb3-1615"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>,  <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb3-1616"><a href="#cb3-1616"></a>  )</span>
<span id="cb3-1617"><a href="#cb3-1617"></a></span>
<span id="cb3-1618"><a href="#cb3-1618"></a><span class="co"># view</span></span>
<span id="cb3-1619"><a href="#cb3-1619"></a><span class="fu">print</span>(plots_subgroup_wealth_life)</span>
<span id="cb3-1620"><a href="#cb3-1620"></a></span>
<span id="cb3-1621"><a href="#cb3-1621"></a><span class="co"># plots</span></span>
<span id="cb3-1622"><a href="#cb3-1622"></a>plots_subgroup_ethnicity_life<span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb3-1623"><a href="#cb3-1623"></a>  <span class="fu">list</span>(</span>
<span id="cb3-1624"><a href="#cb3-1624"></a>    planned_subset_results<span class="sc">$</span>life<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Asian<span class="sc">$</span>plot,</span>
<span id="cb3-1625"><a href="#cb3-1625"></a>    planned_subset_results<span class="sc">$</span>life<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Euro<span class="sc">$</span>plot,</span>
<span id="cb3-1626"><a href="#cb3-1626"></a>    planned_subset_results<span class="sc">$</span>life<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Maori<span class="sc">$</span>plot,</span>
<span id="cb3-1627"><a href="#cb3-1627"></a>    planned_subset_results<span class="sc">$</span>life<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Pacific<span class="sc">$</span>plot</span>
<span id="cb3-1628"><a href="#cb3-1628"></a>  ),</span>
<span id="cb3-1629"><a href="#cb3-1629"></a>  <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb3-1630"><a href="#cb3-1630"></a>)<span class="sc">+</span></span>
<span id="cb3-1631"><a href="#cb3-1631"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb3-1632"><a href="#cb3-1632"></a>    <span class="at">title =</span> subtitle_life,</span>
<span id="cb3-1633"><a href="#cb3-1633"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>,  <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb3-1634"><a href="#cb3-1634"></a>  )</span>
<span id="cb3-1635"><a href="#cb3-1635"></a></span>
<span id="cb3-1636"><a href="#cb3-1636"></a><span class="co"># view</span></span>
<span id="cb3-1637"><a href="#cb3-1637"></a><span class="fu">print</span>(plots_subgroup_ethnicity_life)</span>
<span id="cb3-1638"><a href="#cb3-1638"></a></span>
<span id="cb3-1639"><a href="#cb3-1639"></a><span class="co"># plots</span></span>
<span id="cb3-1640"><a href="#cb3-1640"></a>plots_subgroup_political_life <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb3-1641"><a href="#cb3-1641"></a>  <span class="fu">list</span>(</span>
<span id="cb3-1642"><a href="#cb3-1642"></a>    planned_subset_results<span class="sc">$</span>life<span class="sc">$</span>political<span class="sc">$</span>results<span class="sc">$</span>Conservative<span class="sc">$</span>plot,</span>
<span id="cb3-1643"><a href="#cb3-1643"></a>    planned_subset_results<span class="sc">$</span>life<span class="sc">$</span>political<span class="sc">$</span>results<span class="sc">$</span>Centrist<span class="sc">$</span>plot,</span>
<span id="cb3-1644"><a href="#cb3-1644"></a>    planned_subset_results<span class="sc">$</span>life<span class="sc">$</span>political<span class="sc">$</span>results<span class="sc">$</span>Conservative<span class="sc">$</span>plot</span>
<span id="cb3-1645"><a href="#cb3-1645"></a>  ),</span>
<span id="cb3-1646"><a href="#cb3-1646"></a>  <span class="at">ncol =</span> <span class="dv">1</span></span>
<span id="cb3-1647"><a href="#cb3-1647"></a>)<span class="sc">+</span></span>
<span id="cb3-1648"><a href="#cb3-1648"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb3-1649"><a href="#cb3-1649"></a>    <span class="at">title =</span> subtitle_life,</span>
<span id="cb3-1650"><a href="#cb3-1650"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>,  <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb3-1651"><a href="#cb3-1651"></a>  )</span>
<span id="cb3-1652"><a href="#cb3-1652"></a></span>
<span id="cb3-1653"><a href="#cb3-1653"></a><span class="co"># view</span></span>
<span id="cb3-1654"><a href="#cb3-1654"></a><span class="fu">print</span>(plots_subgroup_political_life)</span>
<span id="cb3-1655"><a href="#cb3-1655"></a></span>
<span id="cb3-1656"><a href="#cb3-1656"></a><span class="co"># plots</span></span>
<span id="cb3-1657"><a href="#cb3-1657"></a>plots_subgroup_gender_life<span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb3-1658"><a href="#cb3-1658"></a>  <span class="fu">list</span>(</span>
<span id="cb3-1659"><a href="#cb3-1659"></a>    planned_subset_results<span class="sc">$</span>life<span class="sc">$</span>gender<span class="sc">$</span>results<span class="sc">$</span>Female<span class="sc">$</span>plot,</span>
<span id="cb3-1660"><a href="#cb3-1660"></a>    planned_subset_results<span class="sc">$</span>life<span class="sc">$</span>gender<span class="sc">$</span>results<span class="sc">$</span>Male<span class="sc">$</span>plot</span>
<span id="cb3-1661"><a href="#cb3-1661"></a>  ),</span>
<span id="cb3-1662"><a href="#cb3-1662"></a>  <span class="at">ncol =</span> <span class="dv">1</span></span>
<span id="cb3-1663"><a href="#cb3-1663"></a>)<span class="sc">+</span></span>
<span id="cb3-1664"><a href="#cb3-1664"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb3-1665"><a href="#cb3-1665"></a>    <span class="at">title =</span> subtitle_life,</span>
<span id="cb3-1666"><a href="#cb3-1666"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>,  <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb3-1667"><a href="#cb3-1667"></a>  )</span>
<span id="cb3-1668"><a href="#cb3-1668"></a></span>
<span id="cb3-1669"><a href="#cb3-1669"></a><span class="co"># view</span></span>
<span id="cb3-1670"><a href="#cb3-1670"></a><span class="fu">print</span>(plots_subgroup_gender_life)</span>
<span id="cb3-1671"><a href="#cb3-1671"></a></span>
<span id="cb3-1672"><a href="#cb3-1672"></a><span class="co"># plots</span></span>
<span id="cb3-1673"><a href="#cb3-1673"></a>plots_subgroup_cohort_life<span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb3-1674"><a href="#cb3-1674"></a>  <span class="fu">list</span>(</span>
<span id="cb3-1675"><a href="#cb3-1675"></a>    planned_subset_results<span class="sc">$</span>life<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Boomers<span class="sc">$</span>plot,</span>
<span id="cb3-1676"><a href="#cb3-1676"></a>    planned_subset_results<span class="sc">$</span>life<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Generation_X<span class="sc">$</span>plot,</span>
<span id="cb3-1677"><a href="#cb3-1677"></a>    planned_subset_results<span class="sc">$</span>life<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Generation_Y<span class="sc">$</span>plot,</span>
<span id="cb3-1678"><a href="#cb3-1678"></a>    planned_subset_results<span class="sc">$</span>life<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Generation_Z<span class="sc">$</span>plot</span>
<span id="cb3-1679"><a href="#cb3-1679"></a>    </span>
<span id="cb3-1680"><a href="#cb3-1680"></a>  ),</span>
<span id="cb3-1681"><a href="#cb3-1681"></a>  <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb3-1682"><a href="#cb3-1682"></a>)<span class="sc">+</span></span>
<span id="cb3-1683"><a href="#cb3-1683"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb3-1684"><a href="#cb3-1684"></a>    <span class="at">title =</span> subtitle_life,</span>
<span id="cb3-1685"><a href="#cb3-1685"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>,  <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb3-1686"><a href="#cb3-1686"></a>  )</span>
<span id="cb3-1687"><a href="#cb3-1687"></a></span>
<span id="cb3-1688"><a href="#cb3-1688"></a><span class="fu">print</span>(plots_subgroup_cohort_life)</span>
<span id="cb3-1689"><a href="#cb3-1689"></a></span>
<span id="cb3-1690"><a href="#cb3-1690"></a><span class="co"># social well-being</span></span>
<span id="cb3-1691"><a href="#cb3-1691"></a>plots_subgroup_wealth_social <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb3-1692"><a href="#cb3-1692"></a>  <span class="fu">list</span>(</span>
<span id="cb3-1693"><a href="#cb3-1693"></a>    planned_subset_results<span class="sc">$</span>social<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>Poor<span class="sc">$</span>plot,</span>
<span id="cb3-1694"><a href="#cb3-1694"></a>    planned_subset_results<span class="sc">$</span>social<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>MiddleIncome<span class="sc">$</span>plot,</span>
<span id="cb3-1695"><a href="#cb3-1695"></a>    planned_subset_results<span class="sc">$</span>social<span class="sc">$</span>wealth<span class="sc">$</span>results<span class="sc">$</span>Rich<span class="sc">$</span>plot</span>
<span id="cb3-1696"><a href="#cb3-1696"></a>  ),</span>
<span id="cb3-1697"><a href="#cb3-1697"></a>  <span class="at">ncol =</span> <span class="dv">1</span></span>
<span id="cb3-1698"><a href="#cb3-1698"></a>) <span class="sc">+</span></span>
<span id="cb3-1699"><a href="#cb3-1699"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb3-1700"><a href="#cb3-1700"></a>    <span class="at">title =</span> subtitle_social,</span>
<span id="cb3-1701"><a href="#cb3-1701"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>,  <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb3-1702"><a href="#cb3-1702"></a>  )</span>
<span id="cb3-1703"><a href="#cb3-1703"></a></span>
<span id="cb3-1704"><a href="#cb3-1704"></a><span class="co"># view</span></span>
<span id="cb3-1705"><a href="#cb3-1705"></a><span class="fu">print</span>(plots_subgroup_wealth_social)</span>
<span id="cb3-1706"><a href="#cb3-1706"></a></span>
<span id="cb3-1707"><a href="#cb3-1707"></a>plots_subgroup_ethnicity_social<span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb3-1708"><a href="#cb3-1708"></a>  <span class="fu">list</span>(</span>
<span id="cb3-1709"><a href="#cb3-1709"></a>    planned_subset_results<span class="sc">$</span>social<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Asian<span class="sc">$</span>plot,</span>
<span id="cb3-1710"><a href="#cb3-1710"></a>    planned_subset_results<span class="sc">$</span>social<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Euro<span class="sc">$</span>plot,</span>
<span id="cb3-1711"><a href="#cb3-1711"></a>    planned_subset_results<span class="sc">$</span>social<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Maori<span class="sc">$</span>plot,</span>
<span id="cb3-1712"><a href="#cb3-1712"></a>    planned_subset_results<span class="sc">$</span>social<span class="sc">$</span>ethnicity<span class="sc">$</span>results<span class="sc">$</span>Pacific<span class="sc">$</span>plot</span>
<span id="cb3-1713"><a href="#cb3-1713"></a>  ),</span>
<span id="cb3-1714"><a href="#cb3-1714"></a>  <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb3-1715"><a href="#cb3-1715"></a>)<span class="sc">+</span></span>
<span id="cb3-1716"><a href="#cb3-1716"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb3-1717"><a href="#cb3-1717"></a>    <span class="at">title =</span> subtitle_social,</span>
<span id="cb3-1718"><a href="#cb3-1718"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>,  <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb3-1719"><a href="#cb3-1719"></a>  )</span>
<span id="cb3-1720"><a href="#cb3-1720"></a></span>
<span id="cb3-1721"><a href="#cb3-1721"></a><span class="co"># view</span></span>
<span id="cb3-1722"><a href="#cb3-1722"></a><span class="fu">print</span>(plots_subgroup_ethnicity_social)</span>
<span id="cb3-1723"><a href="#cb3-1723"></a></span>
<span id="cb3-1724"><a href="#cb3-1724"></a></span>
<span id="cb3-1725"><a href="#cb3-1725"></a>plots_subgroup_political_social <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb3-1726"><a href="#cb3-1726"></a>  <span class="fu">list</span>(</span>
<span id="cb3-1727"><a href="#cb3-1727"></a>    planned_subset_results<span class="sc">$</span>social<span class="sc">$</span>political<span class="sc">$</span>results<span class="sc">$</span>Conservative<span class="sc">$</span>plot,</span>
<span id="cb3-1728"><a href="#cb3-1728"></a>    planned_subset_results<span class="sc">$</span>social<span class="sc">$</span>political<span class="sc">$</span>results<span class="sc">$</span>Centrist<span class="sc">$</span>plot,</span>
<span id="cb3-1729"><a href="#cb3-1729"></a>    planned_subset_results<span class="sc">$</span>social<span class="sc">$</span>political<span class="sc">$</span>results<span class="sc">$</span>Conservative<span class="sc">$</span>plot</span>
<span id="cb3-1730"><a href="#cb3-1730"></a>  ),</span>
<span id="cb3-1731"><a href="#cb3-1731"></a>  <span class="at">ncol =</span> <span class="dv">1</span></span>
<span id="cb3-1732"><a href="#cb3-1732"></a>)<span class="sc">+</span></span>
<span id="cb3-1733"><a href="#cb3-1733"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb3-1734"><a href="#cb3-1734"></a>    <span class="at">title =</span> subtitle_social,</span>
<span id="cb3-1735"><a href="#cb3-1735"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>,  <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb3-1736"><a href="#cb3-1736"></a>  )</span>
<span id="cb3-1737"><a href="#cb3-1737"></a></span>
<span id="cb3-1738"><a href="#cb3-1738"></a><span class="co"># view</span></span>
<span id="cb3-1739"><a href="#cb3-1739"></a><span class="fu">print</span>(plots_subgroup_political_social)</span>
<span id="cb3-1740"><a href="#cb3-1740"></a></span>
<span id="cb3-1741"><a href="#cb3-1741"></a><span class="co"># plots</span></span>
<span id="cb3-1742"><a href="#cb3-1742"></a>plots_subgroup_gender_social<span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb3-1743"><a href="#cb3-1743"></a>  <span class="fu">list</span>(</span>
<span id="cb3-1744"><a href="#cb3-1744"></a>    planned_subset_results<span class="sc">$</span>social<span class="sc">$</span>gender<span class="sc">$</span>results<span class="sc">$</span>Female<span class="sc">$</span>plot,</span>
<span id="cb3-1745"><a href="#cb3-1745"></a>    planned_subset_results<span class="sc">$</span>social<span class="sc">$</span>gender<span class="sc">$</span>results<span class="sc">$</span>Male<span class="sc">$</span>plot</span>
<span id="cb3-1746"><a href="#cb3-1746"></a>  ),</span>
<span id="cb3-1747"><a href="#cb3-1747"></a>  <span class="at">ncol =</span> <span class="dv">1</span></span>
<span id="cb3-1748"><a href="#cb3-1748"></a>)<span class="sc">+</span></span>
<span id="cb3-1749"><a href="#cb3-1749"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb3-1750"><a href="#cb3-1750"></a>    <span class="at">title =</span> subtitle_social,</span>
<span id="cb3-1751"><a href="#cb3-1751"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>,  <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb3-1752"><a href="#cb3-1752"></a>  )</span>
<span id="cb3-1753"><a href="#cb3-1753"></a></span>
<span id="cb3-1754"><a href="#cb3-1754"></a><span class="co"># view</span></span>
<span id="cb3-1755"><a href="#cb3-1755"></a><span class="fu">print</span>(plots_subgroup_gender_social)</span>
<span id="cb3-1756"><a href="#cb3-1756"></a></span>
<span id="cb3-1757"><a href="#cb3-1757"></a><span class="co"># plots</span></span>
<span id="cb3-1758"><a href="#cb3-1758"></a>plots_subgroup_cohort_social<span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(</span>
<span id="cb3-1759"><a href="#cb3-1759"></a>  <span class="fu">list</span>(</span>
<span id="cb3-1760"><a href="#cb3-1760"></a>    planned_subset_results<span class="sc">$</span>social<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Boomers<span class="sc">$</span>plot,</span>
<span id="cb3-1761"><a href="#cb3-1761"></a>    planned_subset_results<span class="sc">$</span>social<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Generation_X<span class="sc">$</span>plot,</span>
<span id="cb3-1762"><a href="#cb3-1762"></a>    planned_subset_results<span class="sc">$</span>social<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Generation_Y<span class="sc">$</span>plot,</span>
<span id="cb3-1763"><a href="#cb3-1763"></a>    planned_subset_results<span class="sc">$</span>social<span class="sc">$</span>cohort<span class="sc">$</span>results<span class="sc">$</span>Generation_Z<span class="sc">$</span>plot</span>
<span id="cb3-1764"><a href="#cb3-1764"></a>    </span>
<span id="cb3-1765"><a href="#cb3-1765"></a>  ),</span>
<span id="cb3-1766"><a href="#cb3-1766"></a>  <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb3-1767"><a href="#cb3-1767"></a>)<span class="sc">+</span></span>
<span id="cb3-1768"><a href="#cb3-1768"></a>  patchwork<span class="sc">::</span><span class="fu">plot_annotation</span>(</span>
<span id="cb3-1769"><a href="#cb3-1769"></a>    <span class="at">title =</span> subtitle_social,</span>
<span id="cb3-1770"><a href="#cb3-1770"></a>    <span class="at">theme =</span> <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>,  <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb3-1771"><a href="#cb3-1771"></a>  )</span>
<span id="cb3-1772"><a href="#cb3-1772"></a></span>
<span id="cb3-1773"><a href="#cb3-1773"></a><span class="fu">print</span>(plots_subgroup_cohort_social)</span>
<span id="cb3-1774"><a href="#cb3-1774"></a></span>
<span id="cb3-1775"><a href="#cb3-1775"></a></span>
<span id="cb3-1776"><a href="#cb3-1776"></a></span>
<span id="cb3-1777"><a href="#cb3-1777"></a><span class="co"># plot options: showcased ---------------------------------------------</span></span>
<span id="cb3-1778"><a href="#cb3-1778"></a><span class="co"># default</span></span>
<span id="cb3-1779"><a href="#cb3-1779"></a><span class="fu">margot_plot_decision_tree</span>(</span>
<span id="cb3-1780"><a href="#cb3-1780"></a>  models_binary_social,</span>
<span id="cb3-1781"><a href="#cb3-1781"></a>  <span class="st">"model_t2_support_z"</span>,</span>
<span id="cb3-1782"><a href="#cb3-1782"></a>)</span>
<span id="cb3-1783"><a href="#cb3-1783"></a><span class="co"># tighten branches for easier viewing in single graphs</span></span>
<span id="cb3-1784"><a href="#cb3-1784"></a>margot<span class="sc">::</span><span class="fu">margot_plot_decision_tree</span>(</span>
<span id="cb3-1785"><a href="#cb3-1785"></a>  models_binary_social,</span>
<span id="cb3-1786"><a href="#cb3-1786"></a>  <span class="st">"model_t2_support_z"</span>,</span>
<span id="cb3-1787"><a href="#cb3-1787"></a>  <span class="at">span_ratio =</span> .<span class="dv">30</span>,</span>
<span id="cb3-1788"><a href="#cb3-1788"></a>  <span class="at">text_size =</span> <span class="fl">3.8</span>,</span>
<span id="cb3-1789"><a href="#cb3-1789"></a>  <span class="at">border_size =</span> .<span class="dv">1</span>,</span>
<span id="cb3-1790"><a href="#cb3-1790"></a>  <span class="co">#  title = "none",</span></span>
<span id="cb3-1791"><a href="#cb3-1791"></a>  <span class="at">original_df =</span> original_df</span>
<span id="cb3-1792"><a href="#cb3-1792"></a>)</span>
<span id="cb3-1793"><a href="#cb3-1793"></a><span class="co"># colour decision node</span></span>
<span id="cb3-1794"><a href="#cb3-1794"></a>margot<span class="sc">::</span><span class="fu">margot_plot_decision_tree</span>(</span>
<span id="cb3-1795"><a href="#cb3-1795"></a>  models_binary_social,</span>
<span id="cb3-1796"><a href="#cb3-1796"></a>  <span class="st">"model_t2_support_z"</span>,</span>
<span id="cb3-1797"><a href="#cb3-1797"></a>  <span class="at">span_ratio =</span> .<span class="dv">3</span>,</span>
<span id="cb3-1798"><a href="#cb3-1798"></a>  <span class="at">text_size =</span> <span class="dv">4</span>, </span>
<span id="cb3-1799"><a href="#cb3-1799"></a>  <span class="at">title =</span> <span class="st">"New Title"</span>,</span>
<span id="cb3-1800"><a href="#cb3-1800"></a>  <span class="at">non_leaf_fill =</span>  <span class="st">"violet"</span>,</span>
<span id="cb3-1801"><a href="#cb3-1801"></a>  <span class="at">original_df =</span> original_df</span>
<span id="cb3-1802"><a href="#cb3-1802"></a>)</span>
<span id="cb3-1803"><a href="#cb3-1803"></a><span class="co"># make new title</span></span>
<span id="cb3-1804"><a href="#cb3-1804"></a>margot<span class="sc">::</span><span class="fu">margot_plot_decision_tree</span>(</span>
<span id="cb3-1805"><a href="#cb3-1805"></a>  models_binary_social,</span>
<span id="cb3-1806"><a href="#cb3-1806"></a>  <span class="st">"model_t2_support_z"</span>,</span>
<span id="cb3-1807"><a href="#cb3-1807"></a>  <span class="at">span_ratio =</span> .<span class="dv">2</span>,</span>
<span id="cb3-1808"><a href="#cb3-1808"></a>  <span class="at">text_size =</span> <span class="dv">3</span>, </span>
<span id="cb3-1809"><a href="#cb3-1809"></a>  <span class="at">title =</span> <span class="st">"New Title"</span>,</span>
<span id="cb3-1810"><a href="#cb3-1810"></a>  <span class="at">non_leaf_fill =</span>  <span class="st">"white"</span>,</span>
<span id="cb3-1811"><a href="#cb3-1811"></a>  <span class="at">original_df =</span> original_df</span>
<span id="cb3-1812"><a href="#cb3-1812"></a>)</span>
<span id="cb3-1813"><a href="#cb3-1813"></a></span>
<span id="cb3-1814"><a href="#cb3-1814"></a><span class="co"># remove title</span></span>
<span id="cb3-1815"><a href="#cb3-1815"></a>margot<span class="sc">::</span><span class="fu">margot_plot_decision_tree</span>(</span>
<span id="cb3-1816"><a href="#cb3-1816"></a>  models_binary_social,</span>
<span id="cb3-1817"><a href="#cb3-1817"></a>  <span class="st">"model_t2_support_z"</span>,</span>
<span id="cb3-1818"><a href="#cb3-1818"></a>  <span class="at">text_size =</span> <span class="dv">5</span>, </span>
<span id="cb3-1819"><a href="#cb3-1819"></a>  <span class="at">title =</span> <span class="st">'none'</span>, <span class="co"># set title to none</span></span>
<span id="cb3-1820"><a href="#cb3-1820"></a>  <span class="at">original_df =</span> original_df</span>
<span id="cb3-1821"><a href="#cb3-1821"></a>)</span>
<span id="cb3-1822"><a href="#cb3-1822"></a></span>
<span id="cb3-1823"><a href="#cb3-1823"></a><span class="co"># policy tree options </span></span>
<span id="cb3-1824"><a href="#cb3-1824"></a><span class="co"># select only plot 1 change alpha</span></span>
<span id="cb3-1825"><a href="#cb3-1825"></a>margot<span class="sc">::</span><span class="fu">margot_plot_policy_tree</span>(</span>
<span id="cb3-1826"><a href="#cb3-1826"></a>  models_binary_social,</span>
<span id="cb3-1827"><a href="#cb3-1827"></a>  <span class="st">"model_t2_support_z"</span>,</span>
<span id="cb3-1828"><a href="#cb3-1828"></a>  <span class="at">point_alpha =</span> .<span class="dv">25</span>, </span>
<span id="cb3-1829"><a href="#cb3-1829"></a>  <span class="at">plot_selection =</span> <span class="st">"p1"</span></span>
<span id="cb3-1830"><a href="#cb3-1830"></a>)</span>
<span id="cb3-1831"><a href="#cb3-1831"></a><span class="co"># select only plot 2 change size of axis_text</span></span>
<span id="cb3-1832"><a href="#cb3-1832"></a><span class="co"># change colours, modify etc... </span></span>
<span id="cb3-1833"><a href="#cb3-1833"></a>margot<span class="sc">::</span><span class="fu">margot_plot_policy_tree</span>(</span>
<span id="cb3-1834"><a href="#cb3-1834"></a>  models_binary,</span>
<span id="cb3-1835"><a href="#cb3-1835"></a>  <span class="st">"model_t2_agreeableness_z"</span>,</span>
<span id="cb3-1836"><a href="#cb3-1836"></a>  <span class="at">plot_selection =</span> <span class="st">"p2"</span>,</span>
<span id="cb3-1837"><a href="#cb3-1837"></a>  <span class="at">axis_title_size =</span> <span class="dv">30</span>,</span>
<span id="cb3-1838"><a href="#cb3-1838"></a>  <span class="at">split_label_size =</span> <span class="dv">20</span>,</span>
<span id="cb3-1839"><a href="#cb3-1839"></a>  <span class="at">split_label_color =</span> <span class="st">"red"</span>,</span>
<span id="cb3-1840"><a href="#cb3-1840"></a>  <span class="at">split_line_color =</span> <span class="st">"red"</span>,</span>
<span id="cb3-1841"><a href="#cb3-1841"></a>)</span>
<span id="cb3-1842"><a href="#cb3-1842"></a></span>
<span id="cb3-1843"><a href="#cb3-1843"></a><span class="co"># adjust only the alpha</span></span>
<span id="cb3-1844"><a href="#cb3-1844"></a>margot<span class="sc">::</span><span class="fu">margot_plot_policy_tree</span>(</span>
<span id="cb3-1845"><a href="#cb3-1845"></a>  models_binary,</span>
<span id="cb3-1846"><a href="#cb3-1846"></a>  <span class="st">"model_t2_agreeableness_z"</span>,</span>
<span id="cb3-1847"><a href="#cb3-1847"></a>  <span class="at">point_alpha =</span> .<span class="dv">1</span></span>
<span id="cb3-1848"><a href="#cb3-1848"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="homework-prepare-a-fresh-set-of-analysis-scripts-using-a-different-exposure" class="level2">
<h2 class="anchored" data-anchor-id="homework-prepare-a-fresh-set-of-analysis-scripts-using-a-different-exposure">HOMEWORK: Prepare a fresh set of analysis scripts using a different exposure</h2>
<ul>
<li>E.g. Ask: what are the effects of a shift in religious service <code>religion_church</code> on multi-dimensional well-being.</li>
<li>Consider what variables you need for confounding control at baseline.</li>
<li>Think about how to make the exposure variable binary.</li>
<li>You may consider different outcome(s) as well as a different exposure.</li>
</ul>
<section id="packages" class="level3">
<h3 class="anchored" data-anchor-id="packages">Packages</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>report<span class="sc">::</span><span class="fu">cite_packages</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  - Bulbulia J (2024). _boilerplate_. doi:10.5281/zenodo.13370825 &lt;https://doi.org/10.5281/zenodo.13370825&gt;, R package version 1.0.4, &lt;https://go-bayes.github.io/biolerplate/&gt;.
  - Bulbulia J (2024). _margot: MARGinal Observational Treatment-effects_. doi:10.5281/zenodo.10907724 &lt;https://doi.org/10.5281/zenodo.10907724&gt;, R package version 1.0.23 Functions to obtain MARGinal Observational Treatment-effects from observational data., &lt;https://go-bayes.github.io/margot/&gt;.
  - Chang W (2023). _extrafont: Tools for Using Fonts_. doi:10.32614/CRAN.package.extrafont &lt;https://doi.org/10.32614/CRAN.package.extrafont&gt;, R package version 0.19, &lt;https://CRAN.R-project.org/package=extrafont&gt;.
  - Grolemund G, Wickham H (2011). "Dates and Times Made Easy with lubridate." _Journal of Statistical Software_, *40*(3), 1-25. &lt;https://www.jstatsoft.org/v40/i03/&gt;.
  - Müller K (2020). _here: A Simpler Way to Find Your Files_. doi:10.32614/CRAN.package.here &lt;https://doi.org/10.32614/CRAN.package.here&gt;, R package version 1.0.1, &lt;https://CRAN.R-project.org/package=here&gt;.
  - Müller K, Wickham H (2023). _tibble: Simple Data Frames_. doi:10.32614/CRAN.package.tibble &lt;https://doi.org/10.32614/CRAN.package.tibble&gt;, R package version 3.2.1, &lt;https://CRAN.R-project.org/package=tibble&gt;.
  - Pedersen T (2024). _patchwork: The Composer of Plots_. doi:10.32614/CRAN.package.patchwork &lt;https://doi.org/10.32614/CRAN.package.patchwork&gt;, R package version 1.3.0, &lt;https://CRAN.R-project.org/package=patchwork&gt;.
  - R Core Team (2025). _R: A Language and Environment for Statistical Computing_. R Foundation for Statistical Computing, Vienna, Austria. &lt;https://www.R-project.org/&gt;.
  - Wickham H (2016). _ggplot2: Elegant Graphics for Data Analysis_. Springer-Verlag New York. ISBN 978-3-319-24277-4, &lt;https://ggplot2.tidyverse.org&gt;.
  - Wickham H (2023). _forcats: Tools for Working with Categorical Variables (Factors)_. doi:10.32614/CRAN.package.forcats &lt;https://doi.org/10.32614/CRAN.package.forcats&gt;, R package version 1.0.0, &lt;https://CRAN.R-project.org/package=forcats&gt;.
  - Wickham H (2023). _stringr: Simple, Consistent Wrappers for Common String Operations_. doi:10.32614/CRAN.package.stringr &lt;https://doi.org/10.32614/CRAN.package.stringr&gt;, R package version 1.5.1, &lt;https://CRAN.R-project.org/package=stringr&gt;.
  - Wickham H, Averick M, Bryan J, Chang W, McGowan LD, François R, Grolemund G, Hayes A, Henry L, Hester J, Kuhn M, Pedersen TL, Miller E, Bache SM, Müller K, Ooms J, Robinson D, Seidel DP, Spinu V, Takahashi K, Vaughan D, Wilke C, Woo K, Yutani H (2019). "Welcome to the tidyverse." _Journal of Open Source Software_, *4*(43), 1686. doi:10.21105/joss.01686 &lt;https://doi.org/10.21105/joss.01686&gt;.
  - Wickham H, François R, Henry L, Müller K, Vaughan D (2023). _dplyr: A Grammar of Data Manipulation_. doi:10.32614/CRAN.package.dplyr &lt;https://doi.org/10.32614/CRAN.package.dplyr&gt;, R package version 1.1.4, &lt;https://CRAN.R-project.org/package=dplyr&gt;.
  - Wickham H, Henry L (2025). _purrr: Functional Programming Tools_. doi:10.32614/CRAN.package.purrr &lt;https://doi.org/10.32614/CRAN.package.purrr&gt;, R package version 1.0.4, &lt;https://CRAN.R-project.org/package=purrr&gt;.
  - Wickham H, Hester J, Bryan J (2024). _readr: Read Rectangular Text Data_. doi:10.32614/CRAN.package.readr &lt;https://doi.org/10.32614/CRAN.package.readr&gt;, R package version 2.1.5, &lt;https://CRAN.R-project.org/package=readr&gt;.
  - Wickham H, Vaughan D, Girlich M (2024). _tidyr: Tidy Messy Data_. doi:10.32614/CRAN.package.tidyr &lt;https://doi.org/10.32614/CRAN.package.tidyr&gt;, R package version 1.3.1, &lt;https://CRAN.R-project.org/package=tidyr&gt;.
  - Xie Y (2025). _tinytex: Helper Functions to Install and Maintain TeX Live, and Compile LaTeX Documents_. R package version 0.57, &lt;https://github.com/rstudio/tinytex&gt;. Xie Y (2019). "TinyTeX: A lightweight, cross-platform, and easy-to-maintain LaTeX distribution based on TeX Live." _TUGboat_, *40*(1), 30-32. &lt;https://tug.org/TUGboat/Contents/contents40-1.html&gt;.
  - Zhu H (2024). _kableExtra: Construct Complex Table with 'kable' and Pipe Syntax_. doi:10.32614/CRAN.package.kableExtra &lt;https://doi.org/10.32614/CRAN.package.kableExtra&gt;, R package version 1.4.0, &lt;https://CRAN.R-project.org/package=kableExtra&gt;.</code></pre>
</div>
</div>
</section>
</section>
<section id="appendix" class="level2">
<h2 class="anchored" data-anchor-id="appendix">Appendix</h2>
</section>
<section id="review-the-fundamental-problem-of-causal-inference-as-a-missing-data-problem" class="level2">
<h2 class="anchored" data-anchor-id="review-the-fundamental-problem-of-causal-inference-as-a-missing-data-problem">Review: The Fundamental Problem of Causal Inference as a Missing Data Problem</h2>
<p>Recall the fundamental problem of causal inference, returning to the question of whether bilingualism improves cognitive abilities:</p>
<ul>
<li><span class="math inline">Y_i^{a = 1}</span>: The cognitive ability of child <span class="math inline">i</span> if they were bilingual. This is the counterfactual outcome when A = 1.</li>
<li><span class="math inline">Y_i^{a = 0}</span>:: The cognitive ability of child <span class="math inline">i</span> if they were monolingual. This is the counterfactual outcome when A = 0.</li>
</ul>
<p>The causal effect of bilingualism on cognitive ability for individual <span class="math inline">i</span> is then defined as the difference between these potential outcomes:</p>
<p><span class="math display">
\text{Causal Effect}_i = Y_i^{a=1} - Y_i^{a=0}
</span></p>
<p>We say there is a causal effect if:</p>
<p><span class="math display">
Y_i^{a=1} - Y_i^{a=0}  \neq 0
</span></p>
<p>However, we only observe one of the potential outcomes for each child. The other outcome is not observed because physics prevents a child from both receiving and not receiving bilingual exposure.</p>
<p>The fact that causal contrasts are not observed in individuals is called “The fundamental problem of causal inference.”</p>
<p>Although we typically cannot observe individual causal effects, we can obtain average causal effects when certain assumptions are satisfied.</p>
<span class="math display">\begin{align}
E(\delta) = E(Y^{a=1} - Y^{a=0})\\
          ~  = E(Y^{a=1}) - E(Y^{a=0}) \\
          ~  = ATE
\end{align}</span>
<p>We may identify average causal effects from the data when the following assumptions are met:</p>
<ul>
<li><strong>Causal Consistency:</strong> The exposure values under comparisons correspond to well-defined interventions that, in turn, correspond to the treatment versions in the data.[]</li>
<li><strong>Positivity:</strong> The probability of receiving every value of the exposure within all strata of co-variates is greater than zero []</li>
<li><strong>Exchangeability:</strong> The conditional probability of receiving every value of an exposure level, though not decided by the investigators, depends only on the measured covariates []</li>
</ul>
<p>Further assumptions:</p>
<ul>
<li><strong>No Interference,</strong> also known as the <strong>Stable Unit Treatment Value Assumption</strong> (SUTVA), requires that the treatment given to one unit (e.g., person, group, organization) does not interfere with the potential outcomes of another unit. Put differently, there are no “spillover” effects. Note: this assumption may be thought to be part of causal consistency, namely individual has only one potential outcome under each treatment condition.</li>
<li><strong>Correctly specified model</strong>: the requirement that the underlying statistical model used to estimate causal effects accurately represents the true relationships between the variables of interest. We say the model should be able to capture “the functional form” of the relationship between the treatment, the outcome, and any covariates. The model’s functional form should be flexible enough to capture the true underlying relationship. The estimated causal effects may be biased if the model’s functional form is incorrect. Additionally, the model must handle omitted variable bias by including all relevant confounders and should correctly handle missing data from non-response or loss-to follow up. We will return to the bias arising from missing data in the weeks ahead. For now, it is important to note that causal inference assumes that our model is correctly specified.</li>
</ul>
</section>
<section id="subgroup-analysis" class="level2">
<h2 class="anchored" data-anchor-id="subgroup-analysis">Subgroup analysis</h2>
<p>Redcall, <strong>Effect Modification</strong> (also known as “heterogeneity of treatment effects”, and “Effect-measure modification”) occurs when the causal effect of intervention <span class="math inline">A</span> varies across different levels of another variable <span class="math inline">R</span>:</p>
<p><span class="math display">E(Y^{a=1}|G=g_1, L=l) - E(Y^{a=0}|G=g_1, L=l) \neq E(Y^{a=1}|G=g_2, L=l) - E(Y^{a=0}|G=g_2, L=l)</span></p>
<p>Effect modification indicates that the magnitude of the causal effect of intervention <span class="math inline">A</span> is related to the modifier variable <span class="math inline">G</span> level. As discussed last week, effect modification can be observed even when there is no direct causal interaction between the treatment and the modifier variable. We noted that <strong>interaction in causal inference refers to a situation where the combined effect of two interventions is not equal to the sum of their individual effects</strong>. <strong>Effect modification, on the other hand, occurs when the causal effect of one intervention varies across different levels of another variable.</strong></p>
<p>We also noted that</p>
<blockquote class="blockquote">
<p><strong>For comparative research, we are typically interested in effect-modification, which requires subgroup analysis.</strong></p>
</blockquote>
<section id="causal-estimand-statistical-estimand-statistical-estimator" class="level3">
<h3 class="anchored" data-anchor-id="causal-estimand-statistical-estimand-statistical-estimator">Causal Estimand, Statistical Estimand, Statistical Estimator</h3>
<p>Let’s set subgroup analysis to the side for a moment and begin focussing on statistical estimation.</p>
<p>Suppose a researcher wants to understand the causal effect of marriage on individual happiness. Participants in the study are surveyed for their marital status (“married” or “not married”) and their self-reported happiness on a scale from 1 to 10.</p>
<section id="causal-estimand" class="level4">
<h4 class="anchored" data-anchor-id="causal-estimand">Causal Estimand</h4>
<ul>
<li><p><strong>Definition</strong>: The causal estimand is the specific quantity or parameter that we aim to estimate to understand the causal effect of an intervention or treatment on an outcome.</p></li>
<li><p><strong>Example</strong>: Here, the <strong>Causal Estimand</strong> would be the Average Treatment Effect (ATE) of being married on happiness. Specifically, we define the ATE as the difference in the potential outcomes of happiness if all individuals were married versus if no individuals were married:</p>
<p><span class="math display">
\text{ATE} = E[Y^{a=1} - Y^{a=0}]
</span></p>
<p>Here, <span class="math inline">Y^{a=1}</span> represents the potential happiness score if an individual is married, and <span class="math inline">Y^{a=0}</span> if they are not married.</p></li>
</ul>
</section>
<section id="next-step-are-causal-assumptions-met" class="level4">
<h4 class="anchored" data-anchor-id="next-step-are-causal-assumptions-met">Next step: Are Causal Assumptions Met?</h4>
<ul>
<li><p>Identification (Exchangeability): balance in the confounders across the treatments to be compared</p></li>
<li><p>Consistency: well-defined interventions</p></li>
<li><p>Positivity: treatments occur within levels of covariates <span class="math inline">L</span></p></li>
</ul>
</section>
<section id="statistical-estimand-next-step" class="level4">
<h4 class="anchored" data-anchor-id="statistical-estimand-next-step">Statistical Estimand (next step)</h4>
<ul>
<li><p><strong>The problem</strong>: how do we bridge the gap between potential outcomes and data?</p></li>
<li><p><strong>Definition</strong>: the statistical estimand is the parameter or function that summarises the relationship between variables as described by a statistical model applied to data.</p></li>
<li><p><strong>Example</strong>: for our study, the <strong>Statistical Estimand</strong> might be the mean difference in happiness scores between individuals who are married and those who are not, as derived from a linear regression model:</p>
<p><span class="math display">
\text{Happiness} = \beta_0 + \beta_1 \times \text{Married} + \epsilon
</span></p>
<p>In this equation, <span class="math inline">\beta_1</span> represents the estimated difference in happiness scores between the married and non-married groups.</p></li>
</ul>
</section>
<section id="statistical-estimator" class="level4">
<h4 class="anchored" data-anchor-id="statistical-estimator">Statistical Estimator</h4>
<ul>
<li><p><strong>Definition</strong>: a statistical estimator is a rule or method by which a numerical estimate of a statistical estimand is calculated from the data.</p></li>
<li><p><strong>Example</strong>: in our marriage study, the <strong>Statistical Estimator</strong> for <span class="math inline">\beta_1</span> is the ordinary least squares (OLS) estimator. This estimator is used to calculate <span class="math inline">\beta_1</span> from the sample data provided by the survey. It provides an estimate of the impact of being married on happiness, calculated using: <span class="math display">
\hat{\beta}_1 = \frac{\sum_{i=1}^n (X_i - \bar{X})(Y_i - \bar{Y})}{\sum_{i=1}^n (X_i - \bar{X})^2}
</span> where <span class="math inline">X_i</span> is a binary indicator for being married (1 for married, 0 for not married), <span class="math inline">Y_i</span> is the observed happiness score, and <span class="math inline">\bar{X}</span>, <span class="math inline">\bar{Y}</span> are the sample means of <span class="math inline">X</span> and <span class="math inline">Y</span>, respectively.</p></li>
</ul>
<p>The upshot, we anchor our causal inquiries within a multi-step framework of data analysis. This involves:</p>
<ol type="1">
<li>clearly defining our causal estimand within a specified <em>target population,</em></li>
<li>clarifying assumptions, &amp; especially identification assumptions,</li>
<li>describing a statistical strategy for extracting this estimand from the data, and then</li>
<li>applying an algorithm that embodies this statistical method.</li>
</ol>
<!-- ## Methods for Statistical Estimation in Causal Inference: Inverse Probability of Treatment Weights Using Propensity Scores -->
<!-- Last week, we discussed confounding control using regression adjustment. Recall the formula for the average treatment effect (ATE) when conditioning on a set of covariates $L$: -->
<!-- $$ -->
<!-- \begin{aligned} -->
<!-- \text{ATE} = E[Y^{a=1} \mid L = l] - E[Y^{a=0} \mid L = l] \quad \text{for any value of } l -->
<!-- \end{aligned} -->
<!-- $$ -->
<!-- > "We say that a set $L$ of measured non-descendants of $L$ is a sufficient set for confounding adjustment when conditioning on $L$ blocks all backdoor paths—that is, the treated and the untreated are exchangeable within levels of $L$" (Hernán & Robins, *Causal Inference*, p. 86). -->
<!-- This formula calculates the expected outcome difference between treated ($a=1$) and untreated ($a=0$) groups, given a specific value of the covariates $l$. -->
<!-- Inverse Probability of Treatment Weighting (IPTW) takes a different approach. We create a pseudo-population where the treatment assignment is independent of the observed covariates by assigning weights to each individual based on their propensity scores. -->
<!-- **We do this by modelling the treatment** -->
<!-- Denote the treatment indicator by $A$, where $A = 1$ if an individual receives treatment and $A = 0$ otherwise. $L$ represents the vector of observed covariates, and $Y^a$ the potential outcomes. The propensity score, $e(L)$, is defined as the probability of receiving the treatment given the observed covariates: -->
<!-- $$ -->
<!-- \hat{e}(L) = P(A = 1 \mid L) -->
<!-- $$ -->
<!-- To obtain IPTW weights, compute the inverse probability of treatment: -->
<!-- $$ -->
<!-- v_i = \frac{A_i}{\hat{e}(L_i)} + \frac{1 - A_i}{1 - \hat{e}(L_i)} -->
<!-- $$ -->
<!-- Which simplifies to  -->
<!-- $$ -->
<!-- v_i =  -->
<!-- \begin{cases}  -->
<!-- \frac{1}{\hat{e}} & \text{if } A_i = 1 \\ -->
<!-- \frac{1}{1-\hat{e}} & \text{if } A_i = 0  -->
<!-- \end{cases} -->
<!-- $$ -->
<!-- where $v_i$ is the IPTW weight for individual $i$, $A_i$ is the treatment indicator for individual $i$, and $\hat{e}(L_i)$ is the estimated propensity score for individual $i$.    -->
<!-- How might we use these weights to obtain causal effect estimates? -->
<!-- ## Marginal Structural Models (MSMs) -->
<!-- Marginal Structural Models (MSMs) estimate causal effects without requiring an "outcome model" that stratifies on covariates. Rather, MSMs employ weights derived from the inverse probability of treatment weighting (IPTW) to create a pseudo-population in which the distribution of covariates is independent of treatment assignment over time. -->
<!-- The general form of an MSM can be expressed as follows: -->
<!-- $$ -->
<!-- E[Y^a] = \beta_0 + \beta_1a -->
<!-- $$ -->
<!-- where $E[Y^a]$ is the expected outcome under treatment $a$  and $\beta_0$ and $\beta_1$ are parameters estimated by fitting the weighted model. Again, the weights used in the MSM, typically derived from the IPTW (or another treatment model), adjust for the confounding, allowing the model to estimate the unbiased effect of the treatment on the outcome without requiring covariates in the model. -->
<!-- Where do weights fit in?   Note, we have $E[Y^a]$ in please of $E[Y|A=a]$.  When applying propensity score weights in the linear regression model $E[Y^a] = \beta_0 + \beta_1a$, each observation is weighted by $v_i$, such that $v_i(\beta_0 + \beta_1a)$. This changes the estimation process to focus on a weighted sum of outcomes, where each individual's contribution is adjusted to reflect their probability of receiving the treatment, given their covariates. -->
<!-- ## Interpretation of $\beta_0$ and $\beta_1$  in a Marginal Structural Model -->
<!-- ### Binary Treatment -->
<!-- In models where the treatment $a$ is binary (e.g., $a = 0$ or $a = 1$), such as in many causal inference studies: -->
<!-- - **$\beta_0$**: the expected value of the outcome $Y$ when the treatment is not applied ($a = 0$). This is the baseline level of the outcome in the absence of treatment. -->
<!-- - **$\beta_1$**: the change in the expected outcome when the treatment status changes from 0 to 1. In logistic regression, $\beta_1$ represents the log-odds ratio of the outcome for the treatment group relative to the control group. In linear regression, $\beta_1$ quantifies the difference in the average outcome between the treated and untreated groups. -->
<!-- ### Continuous Treatment -->
<!-- When the treatment $a$ is continuous, the interpretation of $\beta_0$ and $\beta_1$ adjusts slightly: -->
<!-- - **$\beta_0$**: represents the expected value of the outcome $Y$ when the treatment $a$ is at its reference value (often zero).  -->
<!-- - **$\beta_1$**: represents the expected change in the outcome for each unit increase in the treatment. In this case, $\beta_1$ measures the gradient or slope of the relationship between the treatment and the outcome. For every one-unit increase in treatment, the outcome changes by $\beta_1$ units, assuming all other factors remain constant. -->
<!-- ###  How can we apply marginal structural models in subgroups?  -->
<!-- ### Assumptions -->
<!-- - **Model assumptions**: the treatment model is correctly specified. -->
<!-- - **Causal assumptions**: all confounders are appropriately controlled, positivity and consistency assumptions hold. -->
<!-- ### Calculating Treatment Weights (Propensity Scores) and Confounding Control in Subgroups -->
<!-- We may often achieve greater balance when conducting weighted analyses in subgroups by estimating propensity scores *within* these subgroups. The propensity score $ e(L, G) $ is the conditional probability of receiving the exposure $ A = 1 $, given the covariates $ L $ and subgroup indicator $ G $. This is often modelled using logistic regression or other methods that ensure covariate balance -->
<!-- We define the estimated propensity score as follows: -->
<!-- $$ -->
<!-- \hat{e} = P(A = 1 \mid L, G) = f_A(L, G; \theta_A) -->
<!-- $$ -->
<!-- Here, $ f_A(L, G; \theta_A) $ is the statistical model estimating the probability of exposure $A = 1$ given covariates $L$ and subgroup $G$. We then calculate the weights for each individual, denoted $v$, using the estimated propensity score: -->
<!-- $\theta_A$ encapsulates all the coefficients (parameters) in this model, including intercepts, slopes, and potentially other parameters depending on the model complexity (e.g., interaction terms, non-linear effects...etc). -->
<!-- These weights $v$ depend on $A$ and are calculated as the inverse of the propensity score for exposed individuals and as the inverse of $ 1-\hat{e} $ for unexposed individuals. -->
<!-- Propensity scores are estimated *separately* within strata of the subgroup to control for potential confounding tailored to each subgroup. These weights $v$ are specific to each individual in subgroup $G$. In the lab, we will clarify how to fit models to estimate contrasts for the causal effects within groups $\hat{\delta}_{g}, \hat{\delta}_{g'}$, etc., and how to obtain estimates for group-wise differences: -->
<!-- $$ -->
<!-- \hat{\gamma} = \overbrace{\big( \hat{E}[Y^a \mid G=g] - \hat{E}[Y^{a'} \mid G=g] \big)}^{\hat{\delta}_g} - \overbrace{\big( \hat{E}[Y^{a'} \mid G=g'] - \hat{E}[Y^a \mid G=g'] \big)}^{\hat{\delta}_{g'}} -->
<!-- $$ -->
<!-- - **$\hat{E}[Y^a \mid G=g]$**: Estimated expected outcome when treatment $a$ is applied to subgroup $G=g$. -->
<!-- - **$\hat{E}[Y^{a'} \mid G=g]$**: Estimated expected outcome when a different treatment or control $a'$ is applied to the same subgroup $G=g$. -->
<!-- - **$\hat{\delta}_g$**: Represents the estimated treatment effect within subgroup $G=g$, computed as the difference in expected outcomes between treatment $a$ and $a'$ within this subgroup. -->
<!-- - **$\hat{E}[Y^{a'} \mid G=g']$**: Estimated expected outcome when treatment $a'$ is applied to a different subgroup $G=g'$. -->
<!-- - **$\hat{E}[Y^a \mid G=g']$**: Estimated expected outcome when treatment $a$ is applied to subgroup $G=g'$. -->
<!-- - **$\hat{\delta}_{g'}$**: Represents the estimated treatment effect within subgroup $G=g'$, computed as the difference in expected outcomes between treatment $a'$ and $a$ within this subgroup. -->
<!-- - **$\hat{\gamma}$**: The overall measure calculated from your formula represents the difference in treatment effects between two subgroups, $G=g$ and $G=g'$. It quantifies how the effect of switching between treatments $a$ and $a'$ differs across the two subgroups. -->
<!-- ### Considerations -->
<!-- - **Estimation**: to estimate the expected outcomes $\hat{E}[Y^a \mid G]$ and $\hat{E}[Y^{a'} \mid G]$, we require statistical models. If we use regression, we include interaction terms between treatment and subgroup indicators to directly estimate subgroup-specific treatment effects. Our use depends on correct model specification. -->
<!-- - **Confidence intervals**: we may compute confidence intervals for $\hat{\gamma}$ using bootstrap, the delta method, or -- in our excercises -- simulation based methods. -->
<!-- - **Causal assumptions**: again, a causal interpretation of $\hat{\gamma}$ relies on satisfying both causal assumptions and modelling assumptions.  Here, we have described estimation using propensity scores. -->
<!-- ## Doubly Robust Estimation -->
<!-- We can combine regression-based estimation with propensity score estimation to obtain *doubly robust* estimation. I will walk you through the steps in the lab. The TL;DR is this: doubly robust estimation reduces reliance on correct model specification. If either the PS model or the regression model is correctly specified, the model will be unbiased -- if the other causal inference assumptions are met. -->
<!-- We cannot know whether these assumptions are met, we will need to do a sensitivity analysis, the topic of next week. -->
<!-- I'll show you in lab how to employ simulation-based inference methods to compute standard errors and confidence intervals, following the approaches suggested by Greifer (2023)[]. -->
<!-- ## Extra Readings n on Propensity Scores: -->
<!-- Noah Griefer's Software and Blogs: [https://ngreifer.github.io/blog/subgroup-analysis-psm/](https://ngreifer.github.io/blog/) -->


<!-- -->


</section>
</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb6" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb6-1"><a href="#cb6-1"></a><span class="co">---</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="an">title:</span><span class="co"> "Estimation of ATE and CATE Using Machine Learning"</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="an">date:</span><span class="co"> "2025-APR-29"</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="an">format:</span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="co">  html:</span></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="co">    warnings: false</span></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="co">    error: false</span></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="co">    messages: false</span></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="co">    code-overflow: scroll</span></span>
<span id="cb6-10"><a href="#cb6-10"></a><span class="co">    highlight-style: kate</span></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="co">    code-line-numbers: true</span></span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="co">    code-fold: false</span></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="co">    code-tools:</span></span>
<span id="cb6-14"><a href="#cb6-14"></a><span class="co">      source: true</span></span>
<span id="cb6-15"><a href="#cb6-15"></a><span class="co">      toggle: false</span></span>
<span id="cb6-16"><a href="#cb6-16"></a><span class="an">html-math-method:</span><span class="co"> katex</span></span>
<span id="cb6-17"><a href="#cb6-17"></a><span class="an">reference-location:</span><span class="co"> margin</span></span>
<span id="cb6-18"><a href="#cb6-18"></a><span class="an">citation-location:</span><span class="co"> margin</span></span>
<span id="cb6-19"><a href="#cb6-19"></a><span class="an">cap-location:</span><span class="co"> margin</span></span>
<span id="cb6-20"><a href="#cb6-20"></a><span class="an">code-block-border-left:</span><span class="co"> true</span></span>
<span id="cb6-21"><a href="#cb6-21"></a><span class="an">bibliography:</span><span class="co"> /Users/joseph/GIT/templates/bib/references.bib</span></span>
<span id="cb6-22"><a href="#cb6-22"></a><span class="an">editor_options:</span><span class="co"> </span></span>
<span id="cb6-23"><a href="#cb6-23"></a><span class="co">  chunk_output_type: console</span></span>
<span id="cb6-24"><a href="#cb6-24"></a><span class="co">---</span></span>
<span id="cb6-25"><a href="#cb6-25"></a></span>
<span id="cb6-28"><a href="#cb6-28"></a><span class="in">```{r}</span></span>
<span id="cb6-29"><a href="#cb6-29"></a><span class="co">#| eval: true</span></span>
<span id="cb6-30"><a href="#cb6-30"></a><span class="co">#| include: false</span></span>
<span id="cb6-31"><a href="#cb6-31"></a><span class="co">#| echo: false</span></span>
<span id="cb6-32"><a href="#cb6-32"></a><span class="co"># libraries</span></span>
<span id="cb6-33"><a href="#cb6-33"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(margot, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb6-34"><a href="#cb6-34"></a>  devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"go-bayes/margot"</span>) <span class="co"># ensure version is at least 1.0.21</span></span>
<span id="cb6-35"><a href="#cb6-35"></a>}</span>
<span id="cb6-36"><a href="#cb6-36"></a></span>
<span id="cb6-37"><a href="#cb6-37"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(boilerplate, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb6-38"><a href="#cb6-38"></a>  devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"go-bayes/boilerplate"</span>) <span class="co"># </span></span>
<span id="cb6-39"><a href="#cb6-39"></a>}</span>
<span id="cb6-40"><a href="#cb6-40"></a></span>
<span id="cb6-41"><a href="#cb6-41"></a><span class="fu">library</span>(<span class="st">"tinytex"</span>)</span>
<span id="cb6-42"><a href="#cb6-42"></a><span class="fu">library</span>(extrafont)</span>
<span id="cb6-43"><a href="#cb6-43"></a><span class="fu">loadfonts</span>(<span class="at">device =</span> <span class="st">"win"</span>)</span>
<span id="cb6-44"><a href="#cb6-44"></a><span class="fu">library</span>(margot)</span>
<span id="cb6-45"><a href="#cb6-45"></a><span class="fu">library</span>(here)</span>
<span id="cb6-46"><a href="#cb6-46"></a><span class="co"># library(boilerplate)</span></span>
<span id="cb6-47"><a href="#cb6-47"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb6-48"><a href="#cb6-48"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb6-49"><a href="#cb6-49"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb6-50"><a href="#cb6-50"></a></span>
<span id="cb6-51"><a href="#cb6-51"></a><span class="co"># set save path</span></span>
<span id="cb6-52"><a href="#cb6-52"></a>push_mods <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">'/Users/joseph/v-project\ Dropbox/data/courses/25-psych-434'</span>)</span>
<span id="cb6-53"><a href="#cb6-53"></a></span>
<span id="cb6-54"><a href="#cb6-54"></a><span class="co"># read (large file)</span></span>
<span id="cb6-55"><a href="#cb6-55"></a>models_binary_flipped_all <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read_qs</span>(<span class="st">"models_binary_flipped_all"</span>, push_mods)</span>
<span id="cb6-56"><a href="#cb6-56"></a></span>
<span id="cb6-57"><a href="#cb6-57"></a><span class="co"># models_binary_flipped_all &lt;- here_read_qs("models_binary_flipped_all", here::here("data"))</span></span>
<span id="cb6-58"><a href="#cb6-58"></a></span>
<span id="cb6-59"><a href="#cb6-59"></a><span class="co"># names</span></span>
<span id="cb6-60"><a href="#cb6-60"></a>flipped_names <span class="ot">&lt;-</span> <span class="fu">here_read</span>(<span class="st">"flipped_names"</span>, push_mods)</span>
<span id="cb6-61"><a href="#cb6-61"></a></span>
<span id="cb6-62"><a href="#cb6-62"></a><span class="co"># read labels</span></span>
<span id="cb6-63"><a href="#cb6-63"></a>label_mapping_all <span class="ot">&lt;-</span> <span class="fu">here_read</span>(<span class="st">"label_mapping_all"</span>)</span>
<span id="cb6-64"><a href="#cb6-64"></a></span>
<span id="cb6-65"><a href="#cb6-65"></a><span class="co"># set boilerplate path (set to your own machine)</span></span>
<span id="cb6-66"><a href="#cb6-66"></a>master_path <span class="ot">&lt;-</span> <span class="st">"/Users/joseph/GIT/templates/boilerplate_data"</span></span>
<span id="cb6-67"><a href="#cb6-67"></a></span>
<span id="cb6-68"><a href="#cb6-68"></a><span class="co"># set directory database path</span></span>
<span id="cb6-69"><a href="#cb6-69"></a>here_data_path <span class="ot">=</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>)</span>
<span id="cb6-70"><a href="#cb6-70"></a></span>
<span id="cb6-71"><a href="#cb6-71"></a><span class="co"># data</span></span>
<span id="cb6-72"><a href="#cb6-72"></a>original_df <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">here_read</span>(<span class="st">"df_wide"</span>, push_mods)</span>
<span id="cb6-73"><a href="#cb6-73"></a></span>
<span id="cb6-74"><a href="#cb6-74"></a><span class="co"># # import</span></span>
<span id="cb6-75"><a href="#cb6-75"></a><span class="co"># master_unified_db &lt;- boilerplate_import(data_path = master_path)</span></span>
<span id="cb6-76"><a href="#cb6-76"></a></span>
<span id="cb6-77"><a href="#cb6-77"></a><span class="co"># boilerplate_save(master_unified_db, output_file = "unified_db", data_path  = here_data_path, create_backup = FALSE)</span></span>
<span id="cb6-78"><a href="#cb6-78"></a></span>
<span id="cb6-79"><a href="#cb6-79"></a><span class="co"># unified_db &lt;- boilerplate_import(data_path = here_data_path)</span></span>
<span id="cb6-80"><a href="#cb6-80"></a></span>
<span id="cb6-81"><a href="#cb6-81"></a><span class="co"># cat(unified_db$appendix$explain$grf)</span></span>
<span id="cb6-82"><a href="#cb6-82"></a><span class="co"># set model defaults -----------------------------------------------------</span></span>
<span id="cb6-83"><a href="#cb6-83"></a>grf_defaults <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">seed =</span> <span class="dv">123</span>,</span>
<span id="cb6-84"><a href="#cb6-84"></a>                     <span class="co"># reproduce results</span></span>
<span id="cb6-85"><a href="#cb6-85"></a>                     <span class="at">stabilize.splits =</span> <span class="cn">TRUE</span>,</span>
<span id="cb6-86"><a href="#cb6-86"></a>                     <span class="co"># robustness</span></span>
<span id="cb6-87"><a href="#cb6-87"></a>                     <span class="co"># min.node.size = 5,  # default is five/ requires at least 5 observed in control and treated</span></span>
<span id="cb6-88"><a href="#cb6-88"></a>                     <span class="co"># set higher for greater smoothing</span></span>
<span id="cb6-89"><a href="#cb6-89"></a>                     <span class="at">num.trees =</span> <span class="dv">2000</span> )</span>
<span id="cb6-90"><a href="#cb6-90"></a>                     </span>
<span id="cb6-91"><a href="#cb6-91"></a>                     <span class="co"># grf default = 2000 # set lower or higher depending on storage)</span></span>
<span id="cb6-92"><a href="#cb6-92"></a></span>
<span id="cb6-93"><a href="#cb6-93"></a><span class="co"># set defaults for graphs (see bottom of script for options)</span></span>
<span id="cb6-94"><a href="#cb6-94"></a>decision_tree_defaults <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">span_ratio =</span> .<span class="dv">3</span>,</span>
<span id="cb6-95"><a href="#cb6-95"></a>                               <span class="at">text_size =</span> <span class="fl">3.8</span>,</span>
<span id="cb6-96"><a href="#cb6-96"></a>                               <span class="at">y_padding =</span> <span class="fl">0.25</span>)  <span class="co"># Use full parameter name</span></span>
<span id="cb6-97"><a href="#cb6-97"></a>                               <span class="co"># edge_label_offset = .002,</span></span>
<span id="cb6-98"><a href="#cb6-98"></a>                               <span class="co"># border_size = .05)</span></span>
<span id="cb6-99"><a href="#cb6-99"></a></span>
<span id="cb6-100"><a href="#cb6-100"></a><span class="co"># set defaults for graphs (see bottom of script for options)</span></span>
<span id="cb6-101"><a href="#cb6-101"></a><span class="co"># set policy tree defaults</span></span>
<span id="cb6-102"><a href="#cb6-102"></a>policy_tree_defaults <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb6-103"><a href="#cb6-103"></a>  <span class="at">point_alpha =</span> .<span class="dv">5</span>,</span>
<span id="cb6-104"><a href="#cb6-104"></a>  <span class="at">title_size =</span> <span class="dv">12</span>,</span>
<span id="cb6-105"><a href="#cb6-105"></a>  <span class="at">subtitle_size =</span> <span class="dv">14</span>,</span>
<span id="cb6-106"><a href="#cb6-106"></a>  <span class="at">axis_title_size =</span> <span class="dv">14</span>,</span>
<span id="cb6-107"><a href="#cb6-107"></a>  <span class="at">legend_title_size =</span> <span class="dv">14</span>,</span>
<span id="cb6-108"><a href="#cb6-108"></a>  <span class="at">split_line_color =</span> <span class="st">"red"</span>,</span>
<span id="cb6-109"><a href="#cb6-109"></a>  <span class="at">split_line_alpha =</span> <span class="fl">0.8</span>,</span>
<span id="cb6-110"><a href="#cb6-110"></a>  <span class="at">split_label_color =</span> <span class="st">"red"</span></span>
<span id="cb6-111"><a href="#cb6-111"></a>)</span>
<span id="cb6-112"><a href="#cb6-112"></a></span>
<span id="cb6-113"><a href="#cb6-113"></a><span class="co"># rate table</span></span>
<span id="cb6-114"><a href="#cb6-114"></a>rate_table_all <span class="ot">&lt;-</span> <span class="fu">margot_rate</span>(</span>
<span id="cb6-115"><a href="#cb6-115"></a>  models_binary_flipped_all, </span>
<span id="cb6-116"><a href="#cb6-116"></a>  <span class="at">label_mapping =</span> label_mapping_all, </span>
<span id="cb6-117"><a href="#cb6-117"></a>  <span class="at">highlight_significant =</span> <span class="cn">TRUE</span></span>
<span id="cb6-118"><a href="#cb6-118"></a>)</span>
<span id="cb6-119"><a href="#cb6-119"></a></span>
<span id="cb6-120"><a href="#cb6-120"></a><span class="co"># view</span></span>
<span id="cb6-121"><a href="#cb6-121"></a><span class="co"># rate_table_all$rate_autoc |&gt; kbl("markdown")</span></span>
<span id="cb6-122"><a href="#cb6-122"></a><span class="co"># rate_table_all$rate_qini |&gt; kbl("markdown")</span></span>
<span id="cb6-123"><a href="#cb6-123"></a></span>
<span id="cb6-124"><a href="#cb6-124"></a><span class="co"># generate interpretation</span></span>
<span id="cb6-125"><a href="#cb6-125"></a>rate_interpretation_all <span class="ot">&lt;-</span> <span class="fu">margot_interpret_rate</span>(</span>
<span id="cb6-126"><a href="#cb6-126"></a>  rate_table_all, </span>
<span id="cb6-127"><a href="#cb6-127"></a>  <span class="at">flipped_outcomes =</span> flipped_names</span>
<span id="cb6-128"><a href="#cb6-128"></a>)</span>
<span id="cb6-129"><a href="#cb6-129"></a></span>
<span id="cb6-130"><a href="#cb6-130"></a><span class="co"># view interpretations</span></span>
<span id="cb6-131"><a href="#cb6-131"></a><span class="fu">cat</span>(rate_interpretation_all<span class="sc">$</span>autoc_results)</span>
<span id="cb6-132"><a href="#cb6-132"></a><span class="fu">cat</span>(rate_interpretation_all<span class="sc">$</span>qini_results)</span>
<span id="cb6-133"><a href="#cb6-133"></a><span class="fu">cat</span>(rate_interpretation_all<span class="sc">$</span>comparison)</span>
<span id="cb6-134"><a href="#cb6-134"></a></span>
<span id="cb6-135"><a href="#cb6-135"></a><span class="co"># # check out model names</span></span>
<span id="cb6-136"><a href="#cb6-136"></a><span class="co"># rate_interpretation_all$either_model_names</span></span>
<span id="cb6-137"><a href="#cb6-137"></a><span class="co"># rate_interpretation_all$qini_model_names</span></span>
<span id="cb6-138"><a href="#cb6-138"></a><span class="co"># rate_interpretation_all$both_model_names</span></span>
<span id="cb6-139"><a href="#cb6-139"></a><span class="co"># rate_interpretation_all$autoc_model_names</span></span>
<span id="cb6-140"><a href="#cb6-140"></a></span>
<span id="cb6-141"><a href="#cb6-141"></a><span class="co"># define autoc model names for batch processing</span></span>
<span id="cb6-142"><a href="#cb6-142"></a><span class="co"># autoc plots ------------------------------------------------------------</span></span>
<span id="cb6-143"><a href="#cb6-143"></a><span class="co"># generate batch rate plots</span></span>
<span id="cb6-144"><a href="#cb6-144"></a>batch_rate_autoc_plots <span class="ot">&lt;-</span> <span class="fu">margot_plot_rate_batch</span>(</span>
<span id="cb6-145"><a href="#cb6-145"></a>  models_binary_flipped_all, </span>
<span id="cb6-146"><a href="#cb6-146"></a>  <span class="at">save_plots =</span> <span class="cn">FALSE</span>,</span>
<span id="cb6-147"><a href="#cb6-147"></a>  <span class="co"># just use rate autoc</span></span>
<span id="cb6-148"><a href="#cb6-148"></a>  <span class="at">model_names =</span> rate_interpretation_all<span class="sc">$</span>autoc_model_names  </span>
<span id="cb6-149"><a href="#cb6-149"></a>)</span>
<span id="cb6-150"><a href="#cb6-150"></a></span>
<span id="cb6-151"><a href="#cb6-151"></a><span class="co"># batch_rate_autoc_plots$model_t2_hlth_fatigue_z</span></span>
<span id="cb6-152"><a href="#cb6-152"></a><span class="co"># view selected autoc plots</span></span>
<span id="cb6-153"><a href="#cb6-153"></a><span class="co"># batch_rate_autoc_plots$model_t2_log_hours_exercise_z</span></span>
<span id="cb6-154"><a href="#cb6-154"></a><span class="co"># batch_rate_autoc_plots$model_t2_hlth_fatigue_z</span></span>
<span id="cb6-155"><a href="#cb6-155"></a><span class="co"># batch_rate_autoc_plots$model_t2_self_control_z</span></span>
<span id="cb6-156"><a href="#cb6-156"></a></span>
<span id="cb6-157"><a href="#cb6-157"></a><span class="co"># QINI --------------------------------------------------------------------</span></span>
<span id="cb6-158"><a href="#cb6-158"></a><span class="co"># batch process heterogeneity results for qini</span></span>
<span id="cb6-159"><a href="#cb6-159"></a>models_binary_batch_qini <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_policy</span>(</span>
<span id="cb6-160"><a href="#cb6-160"></a>  models_binary_flipped_all,</span>
<span id="cb6-161"><a href="#cb6-161"></a>  <span class="at">save_plots =</span> <span class="cn">FALSE</span>,</span>
<span id="cb6-162"><a href="#cb6-162"></a>  <span class="at">decision_tree_args =</span> decision_tree_defaults,</span>
<span id="cb6-163"><a href="#cb6-163"></a>  <span class="at">policy_tree_args =</span> policy_tree_defaults,</span>
<span id="cb6-164"><a href="#cb6-164"></a>  <span class="at">model_names =</span> rate_interpretation_all<span class="sc">$</span>qini_model_names,</span>
<span id="cb6-165"><a href="#cb6-165"></a>  <span class="at">original_df =</span> original_df,</span>
<span id="cb6-166"><a href="#cb6-166"></a>  <span class="at">label_mapping =</span> label_mapping_all</span>
<span id="cb6-167"><a href="#cb6-167"></a>)</span>
<span id="cb6-168"><a href="#cb6-168"></a></span>
<span id="cb6-169"><a href="#cb6-169"></a><span class="co"># view models</span></span>
<span id="cb6-170"><a href="#cb6-170"></a><span class="co"># first make graphs</span></span>
<span id="cb6-171"><a href="#cb6-171"></a>plot_qini_exercise <span class="ot">&lt;-</span>models_binary_batch_qini<span class="sc">$</span>model_t2_log_hours_exercise_z<span class="sc">$</span>qini_plot</span>
<span id="cb6-172"><a href="#cb6-172"></a>plot_qini_fatigue <span class="ot">&lt;-</span> models_binary_batch_qini<span class="sc">$</span>model_t2_hlth_fatigue_z<span class="sc">$</span>qini_plot</span>
<span id="cb6-173"><a href="#cb6-173"></a>plot_qini_bodysat <span class="ot">&lt;-</span> models_binary_batch_qini<span class="sc">$</span>model_t2_bodysat_z<span class="sc">$</span>qini_plot</span>
<span id="cb6-174"><a href="#cb6-174"></a>plot_qini_self_control <span class="ot">&lt;-</span> models_binary_batch_qini<span class="sc">$</span>model_t2_self_control_z<span class="sc">$</span>qini_plot</span>
<span id="cb6-175"><a href="#cb6-175"></a>plot_qini_self_esteem <span class="ot">&lt;-</span> models_binary_batch_qini<span class="sc">$</span>model_t2_self_esteem_z<span class="sc">$</span>qini_plot</span>
<span id="cb6-176"><a href="#cb6-176"></a>plot_qini_belong <span class="ot">&lt;-</span> models_binary_batch_qini<span class="sc">$</span>model_t2_belong_z<span class="sc">$</span>qini_plot</span>
<span id="cb6-177"><a href="#cb6-177"></a></span>
<span id="cb6-178"><a href="#cb6-178"></a><span class="co"># recall the ate</span></span>
<span id="cb6-179"><a href="#cb6-179"></a><span class="co"># plot_all_models$plot</span></span>
<span id="cb6-180"><a href="#cb6-180"></a></span>
<span id="cb6-181"><a href="#cb6-181"></a><span class="co"># patchwork allows us to group graphs together</span></span>
<span id="cb6-182"><a href="#cb6-182"></a></span>
<span id="cb6-183"><a href="#cb6-183"></a><span class="co"># view plots</span></span>
<span id="cb6-184"><a href="#cb6-184"></a><span class="co"># (plot_qini_exercise / plot_qini_fatigue / plot_qini_bodysat) </span></span>
<span id="cb6-185"><a href="#cb6-185"></a><span class="co"># </span></span>
<span id="cb6-186"><a href="#cb6-186"></a><span class="co"># (plot_qini_self_control /plot_qini_self_esteem / plot_qini_t2_belong)</span></span>
<span id="cb6-187"><a href="#cb6-187"></a><span class="co"># (plot_qini_exercise / plot_qini_fatigue / plot_qini_bodysat) </span></span>
<span id="cb6-188"><a href="#cb6-188"></a></span>
<span id="cb6-189"><a href="#cb6-189"></a><span class="co"># (plot_qini_self_control /plot_qini_self_esteem / plot_qini_t2_belong)</span></span>
<span id="cb6-190"><a href="#cb6-190"></a></span>
<span id="cb6-191"><a href="#cb6-191"></a><span class="co"># extract plots for models without reliable heterogeneity</span></span>
<span id="cb6-192"><a href="#cb6-192"></a></span>
<span id="cb6-193"><a href="#cb6-193"></a><span class="co"># interpret qini curves</span></span>
<span id="cb6-194"><a href="#cb6-194"></a>interpretation_qini_curves <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_interpret_qini</span>(</span>
<span id="cb6-195"><a href="#cb6-195"></a>  models_binary_batch_qini,</span>
<span id="cb6-196"><a href="#cb6-196"></a>  <span class="at">model_names =</span> rate_interpretation_all<span class="sc">$</span>qini_model_names,</span>
<span id="cb6-197"><a href="#cb6-197"></a>  <span class="at">label_mapping =</span> label_mapping_all</span>
<span id="cb6-198"><a href="#cb6-198"></a>)</span>
<span id="cb6-199"><a href="#cb6-199"></a></span>
<span id="cb6-200"><a href="#cb6-200"></a><span class="co"># view qini interpretation</span></span>
<span id="cb6-201"><a href="#cb6-201"></a><span class="fu">cat</span>(interpretation_qini_curves<span class="sc">$</span>qini_explanation)</span>
<span id="cb6-202"><a href="#cb6-202"></a></span>
<span id="cb6-203"><a href="#cb6-203"></a><span class="co"># view summary table</span></span>
<span id="cb6-204"><a href="#cb6-204"></a>interpretation_qini_curves<span class="sc">$</span>summary_table <span class="sc">|&gt;</span> <span class="fu">kbl</span>(<span class="st">"markdown"</span>)</span>
<span id="cb6-205"><a href="#cb6-205"></a></span>
<span id="cb6-206"><a href="#cb6-206"></a><span class="co"># others</span></span>
<span id="cb6-207"><a href="#cb6-207"></a><span class="co"># combine qini plots</span></span>
<span id="cb6-208"><a href="#cb6-208"></a><span class="co"># qini_plots_combined &lt;- </span></span>
<span id="cb6-209"><a href="#cb6-209"></a><span class="co">#   (plot_qini_exercise + plot_qini_fatigue +  plot_qini_bodysat) / (plot_qini_self_control + plot_qini_self_esteem + plot_qini_t2_belong) + </span></span>
<span id="cb6-210"><a href="#cb6-210"></a><span class="co">#   plot_annotation(</span></span>
<span id="cb6-211"><a href="#cb6-211"></a><span class="co">#     title = "Qini Plots: Reliable Priority 'Spending' at Fractional Budgets",</span></span>
<span id="cb6-212"><a href="#cb6-212"></a><span class="co">#     tag_levels = "A",</span></span>
<span id="cb6-213"><a href="#cb6-213"></a><span class="co">#     theme = theme(legend.position = "top")</span></span>
<span id="cb6-214"><a href="#cb6-214"></a><span class="co">#   ) +</span></span>
<span id="cb6-215"><a href="#cb6-215"></a><span class="co">#   plot_layout(guides = "collect")</span></span>
<span id="cb6-216"><a href="#cb6-216"></a><span class="co"># </span></span>
<span id="cb6-217"><a href="#cb6-217"></a><span class="co"># # view combined qini plots</span></span>
<span id="cb6-218"><a href="#cb6-218"></a><span class="co"># qini_plots_combined</span></span>
<span id="cb6-219"><a href="#cb6-219"></a></span>
<span id="cb6-220"><a href="#cb6-220"></a><span class="co"># again compare with ate</span></span>
<span id="cb6-221"><a href="#cb6-221"></a><span class="co"># plot_all_models$plot </span></span>
<span id="cb6-222"><a href="#cb6-222"></a></span>
<span id="cb6-223"><a href="#cb6-223"></a></span>
<span id="cb6-224"><a href="#cb6-224"></a><span class="co"># policy tree analysis ---------------------------------------------------</span></span>
<span id="cb6-225"><a href="#cb6-225"></a><span class="co"># model_names_subset &lt;- c(</span></span>
<span id="cb6-226"><a href="#cb6-226"></a><span class="co">#   "model_t2_log_hours_exercise_z",</span></span>
<span id="cb6-227"><a href="#cb6-227"></a><span class="co">#   "model_t2_self_control_z", </span></span>
<span id="cb6-228"><a href="#cb6-228"></a><span class="co">#   "model_t2_sexual_satisfaction_z",</span></span>
<span id="cb6-229"><a href="#cb6-229"></a><span class="co">#   "model_t2_belong_z",</span></span>
<span id="cb6-230"><a href="#cb6-230"></a><span class="co">#   "model_t2_support_z"</span></span>
<span id="cb6-231"><a href="#cb6-231"></a><span class="co"># )</span></span>
<span id="cb6-232"><a href="#cb6-232"></a></span>
<span id="cb6-233"><a href="#cb6-233"></a></span>
<span id="cb6-234"><a href="#cb6-234"></a>plots_policy_trees <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_policy</span>(</span>
<span id="cb6-235"><a href="#cb6-235"></a>  models_binary_flipped_all,</span>
<span id="cb6-236"><a href="#cb6-236"></a>  <span class="at">save_plots =</span> <span class="cn">FALSE</span>,</span>
<span id="cb6-237"><a href="#cb6-237"></a>  <span class="at">output_dir =</span> here<span class="sc">::</span><span class="fu">here</span>(push_mods),</span>
<span id="cb6-238"><a href="#cb6-238"></a>  <span class="at">decision_tree_args =</span> decision_tree_defaults,</span>
<span id="cb6-239"><a href="#cb6-239"></a>  <span class="at">policy_tree_args =</span> policy_tree_defaults,</span>
<span id="cb6-240"><a href="#cb6-240"></a>  <span class="at">model_names =</span> rate_interpretation_all<span class="sc">$</span>either_model_names, <span class="co"># defined above</span></span>
<span id="cb6-241"><a href="#cb6-241"></a>  <span class="at">original_df =</span> original_df,</span>
<span id="cb6-242"><a href="#cb6-242"></a>  <span class="at">label_mapping =</span> label_mapping_all</span>
<span id="cb6-243"><a href="#cb6-243"></a>)</span>
<span id="cb6-244"><a href="#cb6-244"></a></span>
<span id="cb6-245"><a href="#cb6-245"></a><span class="co"># generate policy tree interpretations</span></span>
<span id="cb6-246"><a href="#cb6-246"></a>interpretation_policy_trees <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_interpret_policy_batch</span>(</span>
<span id="cb6-247"><a href="#cb6-247"></a>  models_binary_flipped_all,</span>
<span id="cb6-248"><a href="#cb6-248"></a>  <span class="co"># use eithre model</span></span>
<span id="cb6-249"><a href="#cb6-249"></a>  <span class="at">model_names =</span> rate_interpretation_all<span class="sc">$</span>either_model_names, <span class="co"># defined above</span></span>
<span id="cb6-250"><a href="#cb6-250"></a>  <span class="at">train_proportion =</span> <span class="fl">0.8</span>,</span>
<span id="cb6-251"><a href="#cb6-251"></a>  <span class="at">original_df =</span> original_df,</span>
<span id="cb6-252"><a href="#cb6-252"></a>  <span class="at">label_mapping =</span> label_mapping_all</span>
<span id="cb6-253"><a href="#cb6-253"></a>)</span>
<span id="cb6-254"><a href="#cb6-254"></a></span>
<span id="cb6-255"><a href="#cb6-255"></a><span class="co"># this will give you results</span></span>
<span id="cb6-256"><a href="#cb6-256"></a><span class="co"># cat(interpretation_policy_trees)</span></span>
<span id="cb6-257"><a href="#cb6-257"></a></span>
<span id="cb6-258"><a href="#cb6-258"></a><span class="co"># # plots</span></span>
<span id="cb6-259"><a href="#cb6-259"></a><span class="co"># plots_policy_trees$model_t2_log_hours_exercise_z$decision_tree</span></span>
<span id="cb6-260"><a href="#cb6-260"></a><span class="co"># plots_policy_trees$model_t2_log_hours_exercise_z$policy_tree</span></span>
<span id="cb6-261"><a href="#cb6-261"></a><span class="co"># plots_policy_trees$model_t2_log_hours_exercise_z$combined_plot</span></span>
<span id="cb6-262"><a href="#cb6-262"></a><span class="co"># # </span></span>
<span id="cb6-263"><a href="#cb6-263"></a><span class="co"># plots_policy_trees$model_t2_hlth_fatigue_z$decision_tree</span></span>
<span id="cb6-264"><a href="#cb6-264"></a><span class="co"># plots_policy_trees$model_t2_hlth_fatigue_z$policy_tree</span></span>
<span id="cb6-265"><a href="#cb6-265"></a><span class="co"># plots_policy_trees$model_t2_hlth_fatigue_z$combined_plot</span></span>
<span id="cb6-266"><a href="#cb6-266"></a><span class="co"># # </span></span>
<span id="cb6-267"><a href="#cb6-267"></a><span class="co"># plots_policy_trees$model_t2_self_control_z$decision_tree</span></span>
<span id="cb6-268"><a href="#cb6-268"></a><span class="co"># plots_policy_trees$model_t2_self_control_z$policy_tree</span></span>
<span id="cb6-269"><a href="#cb6-269"></a><span class="co"># plots_policy_trees$model_t2_self_control_z$combined_plot</span></span>
<span id="cb6-270"><a href="#cb6-270"></a></span>
<span id="cb6-271"><a href="#cb6-271"></a><span class="co"># plots_policy_trees$model_t2_meaning_sense_z$decision_tree</span></span>
<span id="cb6-272"><a href="#cb6-272"></a><span class="co"># plots_policy_trees$model_t2_meaning_sense_z$policy_tree</span></span>
<span id="cb6-273"><a href="#cb6-273"></a><span class="co"># plots_policy_trees$model_t2_meaning_sense_z$combined_plot</span></span>
<span id="cb6-274"><a href="#cb6-274"></a><span class="co"># </span></span>
<span id="cb6-275"><a href="#cb6-275"></a><span class="co"># plots_policy_trees$model_t2_bodysat_z$decision_tree</span></span>
<span id="cb6-276"><a href="#cb6-276"></a><span class="co"># plots_policy_trees$model_t2_bodysat_z$policy_tree</span></span>
<span id="cb6-277"><a href="#cb6-277"></a><span class="co"># plots_policy_trees$model_t2_bodysat_z$combined_plot</span></span>
<span id="cb6-278"><a href="#cb6-278"></a><span class="co"># # </span></span>
<span id="cb6-279"><a href="#cb6-279"></a><span class="co"># </span></span>
<span id="cb6-280"><a href="#cb6-280"></a><span class="co"># plots_policy_trees$model_t2_self_esteem_z$decision_tree</span></span>
<span id="cb6-281"><a href="#cb6-281"></a><span class="co"># plots_policy_trees$model_t2_self_esteem_z$policy_tree</span></span>
<span id="cb6-282"><a href="#cb6-282"></a><span class="co"># plots_policy_trees$model_t2_self_esteem_z$combined_plot</span></span>
<span id="cb6-283"><a href="#cb6-283"></a></span>
<span id="cb6-284"><a href="#cb6-284"></a><span class="co"># plots_policy_trees$model_t2_belong_z$decision_tree</span></span>
<span id="cb6-285"><a href="#cb6-285"></a><span class="co"># plots_policy_trees$model_t2_belong_z$policy_tree</span></span>
<span id="cb6-286"><a href="#cb6-286"></a><span class="co"># plots_policy_trees$model_t2_belong_z$combined_plot</span></span>
<span id="cb6-287"><a href="#cb6-287"></a></span>
<span id="cb6-288"><a href="#cb6-288"></a><span class="co"># batch_rate_autoc_plots$model_t2_meaning_sense_z</span></span>
<span id="cb6-289"><a href="#cb6-289"></a><span class="co"># models_binary_batch_qini$model_t2_belong_z$qini_plot</span></span>
<span id="cb6-290"><a href="#cb6-290"></a></span>
<span id="cb6-291"><a href="#cb6-291"></a><span class="in">```</span></span>
<span id="cb6-292"><a href="#cb6-292"></a></span>
<span id="cb6-293"><a href="#cb6-293"></a></span>
<span id="cb6-294"><a href="#cb6-294"></a>::: {.callout-note}</span>
<span id="cb6-295"><a href="#cb6-295"></a>**Required**</span>
<span id="cb6-296"><a href="#cb6-296"></a><span class="ss">- </span><span class="co">[</span><span class="ot">https://grf-labs.github.io/grf/</span><span class="co">](https://grf-labs.github.io/grf/)</span></span>
<span id="cb6-297"><a href="#cb6-297"></a></span>
<span id="cb6-298"><a href="#cb6-298"></a></span>
<span id="cb6-299"><a href="#cb6-299"></a></span>
<span id="cb6-300"><a href="#cb6-300"></a>**Optional**</span>
<span id="cb6-301"><a href="#cb6-301"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@vanderweele2020</span><span class="co">] [link]</span>(https://www.dropbox.com/scl/fi/srpynr0dvjcndveplcydn/OutcomeWide_StatisticalScience.pdf?rlkey=h4fv32oyjegdfl3jq9u1fifc3&amp;dl=0)</span>
<span id="cb6-302"><a href="#cb6-302"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@suzuki2020</span><span class="co">] [link]</span>(https://www.dropbox.com/scl/fi/4midxwr9ltg9oce02e0ss/suzuki-causal-diagrams.pdf?rlkey=uktzf3nurtgpbj8m4h0xz82dn&amp;dl=0)</span>
<span id="cb6-303"><a href="#cb6-303"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@Bulbulia2024PracticalGuide</span><span class="co">] [link]</span>(https://osf.io/preprints/psyarxiv/uyg3d)</span>
<span id="cb6-304"><a href="#cb6-304"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@hoffman2023</span><span class="co">] [link]</span>(https://arxiv.org/pdf/2304.09460.pdf)</span>
<span id="cb6-305"><a href="#cb6-305"></a>:::</span>
<span id="cb6-306"><a href="#cb6-306"></a></span>
<span id="cb6-307"><a href="#cb6-307"></a></span>
<span id="cb6-308"><a href="#cb6-308"></a>::: {.callout-important}</span>
<span id="cb6-309"><a href="#cb6-309"></a><span class="fu">### Key concepts  </span></span>
<span id="cb6-310"><a href="#cb6-310"></a></span>
<span id="cb6-311"><a href="#cb6-311"></a>The workflow below introduces **heterogeneous-treatment-effect (HTE) analysis** with *causal forests*. By the end of the lecture you should understand six technical ideas:</span>
<span id="cb6-312"><a href="#cb6-312"></a>(1) ATE (lectures 1-5)</span>
<span id="cb6-313"><a href="#cb6-313"></a>(2) CATE (lecture 6)</span>
<span id="cb6-314"><a href="#cb6-314"></a>(3) The estimator $\widehat{\tau}(x)$, (lecture 6)</span>
<span id="cb6-315"><a href="#cb6-315"></a>(4) the RATE statistics drawn from a **Targeting-Operator Characteristic** (TOC) curve (new)</span>
<span id="cb6-316"><a href="#cb6-316"></a>(5) Qini Curves (new)</span>
<span id="cb6-317"><a href="#cb6-317"></a>(6) **policy trees**—and know how each fits into an applied research pipelin (new)</span>
<span id="cb6-318"><a href="#cb6-318"></a>:::</span>
<span id="cb6-319"><a href="#cb6-319"></a></span>
<span id="cb6-320"><a href="#cb6-320"></a>::: {.callout-important}</span>
<span id="cb6-321"><a href="#cb6-321"></a><span class="fu">### For the lab  </span></span>
<span id="cb6-322"><a href="#cb6-322"></a></span>
<span id="cb6-323"><a href="#cb6-323"></a>The lab puts the six ideas above to practical use. </span>
<span id="cb6-324"><a href="#cb6-324"></a></span>
<span id="cb6-325"><a href="#cb6-325"></a>There are **Three** R scripts we will be using over the next few weeks.&nbsp;</span>
<span id="cb6-326"><a href="#cb6-326"></a></span>
<span id="cb6-327"><a href="#cb6-327"></a>First:</span>
<span id="cb6-328"><a href="#cb6-328"></a></span>
<span id="cb6-329"><a href="#cb6-329"></a><span class="co">[</span><span class="ot">Script 1</span><span class="co">](https://raw.githubusercontent.com/go-bayes/psych-434-2025/refs/heads/main/laboratory/01-example-script-data-wrangling.R)</span></span>
<span id="cb6-330"><a href="#cb6-330"></a></span>
<span id="cb6-331"><a href="#cb6-331"></a><span class="co">[</span><span class="ot">Script 2</span><span class="co">](https://raw.githubusercontent.com/go-bayes/psych-434-2025/refs/heads/main/laboratory/02-example-script-data-wrangling-2.R)</span></span>
<span id="cb6-332"><a href="#cb6-332"></a></span>
<span id="cb6-333"><a href="#cb6-333"></a><span class="co">[</span><span class="ot">Script 3</span><span class="co">](https://raw.githubusercontent.com/go-bayes/psych-434-2025/refs/heads/main/laboratory/03-example-script-estimation-results.R)</span></span>
<span id="cb6-334"><a href="#cb6-334"></a></span>
<span id="cb6-335"><a href="#cb6-335"></a>:::</span>
<span id="cb6-336"><a href="#cb6-336"></a></span>
<span id="cb6-337"><a href="#cb6-337"></a></span>
<span id="cb6-338"><a href="#cb6-338"></a></span>
<span id="cb6-339"><a href="#cb6-339"></a><span class="fu">## Heterogeneous-Treatment-Effect Analysis with **causal forests**</span></span>
<span id="cb6-340"><a href="#cb6-340"></a></span>
<span id="cb6-341"><a href="#cb6-341"></a><span class="fu">### Why worry about heterogeneity?  </span></span>
<span id="cb6-342"><a href="#cb6-342"></a></span>
<span id="cb6-343"><a href="#cb6-343"></a></span>
<span id="cb6-344"><a href="#cb6-344"></a>Relying on the average treatment effect (ATE) is a bit like handing out size-nine shoes to an entire student body: on *average* they might fit, but watch the tall students hobble and the small ones trip.  </span>
<span id="cb6-345"><a href="#cb6-345"></a></span>
<span id="cb6-346"><a href="#cb6-346"></a>Today we will focus on the causal question: "What would be the effects on multi-dimensional well-being if everyone spent at least one hour a week socialising with their community?"</span>
<span id="cb6-347"><a href="#cb6-347"></a></span>
<span id="cb6-348"><a href="#cb6-348"></a>Note that a one-hour boost in weekly community socialising could send some students' sense of belonging soaring while leaving others desolated.  Spotting that spread, measuring how big it really is, and deciding whether it is worth tailoring an exposure to individual 'shoe sizes' are the three practical goals of Heterogeneous Treatment Effects analysis.</span>
<span id="cb6-349"><a href="#cb6-349"></a></span>
<span id="cb6-350"><a href="#cb6-350"></a></span>
<span id="cb6-351"><a href="#cb6-351"></a>---</span>
<span id="cb6-352"><a href="#cb6-352"></a></span>
<span id="cb6-353"><a href="#cb6-353"></a><span class="fu">### 1 Start with estimating the average treatment effect (ATE)  </span></span>
<span id="cb6-354"><a href="#cb6-354"></a></span>
<span id="cb6-355"><a href="#cb6-355"></a>Assume the <span class="co">[</span><span class="ot">Three Fundamental Assumptions of Causal Inference here</span><span class="co">](https://go-bayes.github.io/psych-434-2025/content/05-content.html#how-can-we-make-contrasts-between-counterfactual-potential-outcomes)</span> are met. Suppose we wish to estimate the average treatment effect for socialising with one's community. </span>
<span id="cb6-356"><a href="#cb6-356"></a></span>
<span id="cb6-357"><a href="#cb6-357"></a>We begin with the most straightforward (and secretly impossible) counterfactual: *run two parallel universes—one where **everyone** gets the treatment, another where **no-one** does—and compare the final scores.  The resulting difference is the **average treatment effect**:  </span>
<span id="cb6-358"><a href="#cb6-358"></a></span>
<span id="cb6-359"><a href="#cb6-359"></a></span>
<span id="cb6-360"><a href="#cb6-360"></a>$$</span>
<span id="cb6-361"><a href="#cb6-361"></a>\text{ATE}=E<span class="sc">\!</span>\bigl<span class="co">[</span><span class="ot">Y(1)-Y(0)\bigr</span><span class="co">]</span>.</span>
<span id="cb6-362"><a href="#cb6-362"></a>$$</span>
<span id="cb6-363"><a href="#cb6-363"></a></span>
<span id="cb6-364"><a href="#cb6-364"></a>This gives us the average response -- the shoe size... You've seen this before.</span>
<span id="cb6-365"><a href="#cb6-365"></a></span>
<span id="cb6-366"><a href="#cb6-366"></a></span>
<span id="cb6-367"><a href="#cb6-367"></a>---</span>
<span id="cb6-368"><a href="#cb6-368"></a></span>
<span id="cb6-369"><a href="#cb6-369"></a><span class="fu">### 2 Do effects differ across people?  </span></span>
<span id="cb6-370"><a href="#cb6-370"></a></span>
<span id="cb6-371"><a href="#cb6-371"></a>Variation is captured by the **conditional average treatment effect (CATE)**,  </span>
<span id="cb6-372"><a href="#cb6-372"></a></span>
<span id="cb6-373"><a href="#cb6-373"></a>$$</span>
<span id="cb6-374"><a href="#cb6-374"></a>\tau(x)=E<span class="sc">\!</span>\bigl<span class="co">[</span><span class="ot">Y(1)-Y(0)\mid X=x\bigr</span><span class="co">]</span>,</span>
<span id="cb6-375"><a href="#cb6-375"></a>$$</span>
<span id="cb6-376"><a href="#cb6-376"></a></span>
<span id="cb6-377"><a href="#cb6-377"></a>where $X$ gathers pre-treatment covariates -- age, baseline wellbeing, personality, whatever we have measured and included in our model. Normally these will be our *baseline confounders.* </span>
<span id="cb6-378"><a href="#cb6-378"></a></span>
<span id="cb6-379"><a href="#cb6-379"></a>If $\tau(x)$ turns out to be flat, we say there is no evidence for heterogeneity worth targeting. </span>
<span id="cb6-380"><a href="#cb6-380"></a></span>
<span id="cb6-381"><a href="#cb6-381"></a>People differ in countless, overlapping ways. Think of age, baseline wellbeing, personality traits, study habits, and more. </span>
<span id="cb6-382"><a href="#cb6-382"></a></span>
<span id="cb6-383"><a href="#cb6-383"></a>A linear interaction model tests whether the treatment works differently along one straight dimension, such as gender, by fitting a straight line. </span>
<span id="cb6-384"><a href="#cb6-384"></a></span>
<span id="cb6-385"><a href="#cb6-385"></a>But real‐world data often twist and turn. If the true relationship bends like a garden hose, a straight line will miss the curve. </span>
<span id="cb6-386"><a href="#cb6-386"></a></span>
<span id="cb6-387"><a href="#cb6-387"></a>Regression forests fix this by letting the data place splits wherever the shape changes, so they can follow any bends that appear <span class="co">[</span><span class="ot">@wager2018</span><span class="co">]</span>.  </span>
<span id="cb6-388"><a href="#cb6-388"></a></span>
<span id="cb6-389"><a href="#cb6-389"></a>Straight-line models are fine for simple patterns, but regression forests can trace the curves that simple lines overlook.</span>
<span id="cb6-390"><a href="#cb6-390"></a></span>
<span id="cb6-391"><a href="#cb6-391"></a>Causal forests are based on regression forests, where the splitting attempts to maximise differences in causal effect estimates. What this means will soon be clear. </span>
<span id="cb6-392"><a href="#cb6-392"></a></span>
<span id="cb6-393"><a href="#cb6-393"></a></span>
<span id="cb6-394"><a href="#cb6-394"></a><span class="fu">### 3. From straight lines to trees  </span></span>
<span id="cb6-395"><a href="#cb6-395"></a></span>
<span id="cb6-396"><a href="#cb6-396"></a>Traditional 'parametric' models (like simple regression) guess a single functional shape -- often a straight line -- before seeing the data.  A **non-parametric** model, by contrast, lets the data decide the shape.  A *regression tree* is the simplest non-parametric learner we will use.  </span>
<span id="cb6-397"><a href="#cb6-397"></a></span>
<span id="cb6-398"><a href="#cb6-398"></a><span class="ss">1. </span>**Regression tree**  </span>
<span id="cb6-399"><a href="#cb6-399"></a></span>
<span id="cb6-400"><a href="#cb6-400"></a>*Idea*: split the covariate space by asking yes/no questions— 'Age ≤ 20?', 'Baseline wellbeing &gt; 0.3?' — until each terminal **leaf** is fairly homogeneous.  Inside a leaf the predicted outcome is just the sample mean, so the tree builds a *piece-wise constant* surface instead of a global line.    </span>
<span id="cb6-401"><a href="#cb6-401"></a>*Analogy*: think of tiling a garden with stepping-stones: each stone is flat, but taken together they follow the ground’s contours.</span>
<span id="cb6-402"><a href="#cb6-402"></a></span>
<span id="cb6-403"><a href="#cb6-403"></a><span class="ss">2. </span>**Regression forest**  </span>
<span id="cb6-404"><a href="#cb6-404"></a>   A single tree is quick and interpretable but unstable: small changes in the data can move the splits and shift predictions.  A **random forest** grows many trees on bootstrap samples and averages their outputs.  Averaging cancels much of the noise <span class="co">[</span><span class="ot">@breiman2001random</span><span class="co">]</span>.  </span>
<span id="cb6-405"><a href="#cb6-405"></a></span>
<span id="cb6-406"><a href="#cb6-406"></a><span class="ss">3. </span>**Causal Forests**  </span>
<span id="cb6-407"><a href="#cb6-407"></a>   To estimate treatment effects rather than outcomes, each tree plays a two-step 'honest' game <span class="co">[</span><span class="ot">@wager2018</span><span class="co">]</span>:  </span>
<span id="cb6-408"><a href="#cb6-408"></a><span class="ss">   - </span>use one half of its sample to choose splits that separate treated from control units;  </span>
<span id="cb6-409"><a href="#cb6-409"></a><span class="ss">   - </span>use the other half to compute treatment-control differences within every leaf.  </span>
<span id="cb6-410"><a href="#cb6-410"></a></span>
<span id="cb6-411"><a href="#cb6-411"></a>   For a new individual with covariates $x_i$ each tree supplies a noisy leaf-level effect; the forest reports the **average**, written  </span>
<span id="cb6-412"><a href="#cb6-412"></a></span>
<span id="cb6-413"><a href="#cb6-413"></a>$$</span>
<span id="cb6-414"><a href="#cb6-414"></a>  \widehat{\tau}(x)=E<span class="co">[</span><span class="ot">Y(1)-Y(0)\mid X=x</span><span class="co">]</span>.</span>
<span id="cb6-415"><a href="#cb6-415"></a>$$</span>
<span id="cb6-416"><a href="#cb6-416"></a></span>
<span id="cb6-417"><a href="#cb6-417"></a>Because the noisy estimates point in many directions, their average is markedly less variable -- *the wisdom of trees is a wisdom of crowds*.</span>
<span id="cb6-418"><a href="#cb6-418"></a></span>
<span id="cb6-419"><a href="#cb6-419"></a>Straight‑line models suit simple patterns; regression forests flex to any bends; causal forests add a third dimension -- variation in treatment responses. We'll see this in action/</span>
<span id="cb6-420"><a href="#cb6-420"></a></span>
<span id="cb6-421"><a href="#cb6-421"></a></span>
<span id="cb6-422"><a href="#cb6-422"></a>For more about causal forests see (~18mins in...)</span>
<span id="cb6-423"><a href="#cb6-423"></a></span>
<span id="cb6-424"><a href="#cb6-424"></a>{{&lt; video https://www.youtube.com/watch?v=YBbnCDRCcAI &gt;}}</span>
<span id="cb6-425"><a href="#cb6-425"></a></span>
<span id="cb6-426"><a href="#cb6-426"></a></span>
<span id="cb6-427"><a href="#cb6-427"></a><span class="co">&lt;!-- So, a regression tree chops the data into locally flat chunks; a regression forest averages many such trees to smooth away chance idiosyncrasies; a causal forest adds honesty so that its averaged differences, though never directly observable for any one person, give our best data-driven forecast of individual treatment effects. --&gt;</span></span>
<span id="cb6-428"><a href="#cb6-428"></a></span>
<span id="cb6-429"><a href="#cb6-429"></a>---</span>
<span id="cb6-430"><a href="#cb6-430"></a></span>
<span id="cb6-431"><a href="#cb6-431"></a><span class="fu">### 4 Building Honest Trees: Avoiding Over-Fitting  </span></span>
<span id="cb6-432"><a href="#cb6-432"></a></span>
<span id="cb6-433"><a href="#cb6-433"></a>Sample splitting meanings partitioning your data into training and testing sets. This avoids overfittign the model to observations (remember we seek to estimate parameters for an entire population under two different exposures, at most, only one of which is observed on any individual.) Sample splitting is a feature of estimation in cauasal forests -- we separate model selection from estimation. Moreover, the forest adds a second safeguard: **out-of-bag (OOB) prediction**. Each $\widehat{\tau}(x_i)$ is averaged only over trees that never used $i$ in their split phase.  Together, honesty and OOB prediction deliver reliable uncertainty estimates even in high-dimensional settings (i.e. settings with *many* covariates.)</span>
<span id="cb6-434"><a href="#cb6-434"></a></span>
<span id="cb6-435"><a href="#cb6-435"></a>---</span>
<span id="cb6-436"><a href="#cb6-436"></a></span>
<span id="cb6-437"><a href="#cb6-437"></a><span class="fu">### 5 Handling missing data  </span></span>
<span id="cb6-438"><a href="#cb6-438"></a></span>
<span id="cb6-439"><a href="#cb6-439"></a>The <span class="in">`grf`</span> package adopts **Missing Incorporated in Attributes (MIA)** splitting.  'Missing' can itself become a branch, so cases are neither discarded nor randomly imputed.  This pragmatic approach keeps all observations in play while preserving the forest’s interpretability. </span>
<span id="cb6-440"><a href="#cb6-440"></a></span>
<span id="cb6-441"><a href="#cb6-441"></a>---</span>
<span id="cb6-442"><a href="#cb6-442"></a></span>
<span id="cb6-443"><a href="#cb6-443"></a><span class="fu">### 6 Is the heterogeneity *actionable*? — RATE statistics  </span></span>
<span id="cb6-444"><a href="#cb6-444"></a></span>
<span id="cb6-445"><a href="#cb6-445"></a>Once we have a personalised score $\widehat{\tau}(x)$ for every unit, the practical question is whether *targeting* high scorers delivers a benefit large enough to justify the extra effort.  The tool of choice is the **Targeting-Operator Characteristic (TOC)** curve:</span>
<span id="cb6-446"><a href="#cb6-446"></a></span>
<span id="cb6-447"><a href="#cb6-447"></a>$$</span>
<span id="cb6-448"><a href="#cb6-448"></a>G(q)=\frac{1}{n}\sum_{i=1}^{\lfloor qn\rfloor}\widehat{\tau}_{(i)}, \qquad 0\le q\le1,</span>
<span id="cb6-449"><a href="#cb6-449"></a>$$</span>
<span id="cb6-450"><a href="#cb6-450"></a></span>
<span id="cb6-451"><a href="#cb6-451"></a>where $\widehat{\tau}_{(1)}\ge\widehat{\tau}_{(2)}\ge\cdots$ are the estimated effects sorted from largest to smallest.  The horizontal axis $q$ is the fraction of the population we would treat; the vertical axis $G(q)$ is the cumulative gain we expect from treating that top slice.</span>
<span id="cb6-452"><a href="#cb6-452"></a></span>
<span id="cb6-453"><a href="#cb6-453"></a>Two integrals of the TOC curve summarise how lucrative targeting could be:</span>
<span id="cb6-454"><a href="#cb6-454"></a></span>
<span id="cb6-455"><a href="#cb6-455"></a><span class="ss">* </span>**RATE AUTOC** (Area *Under* the TOC) puts equal weight on every $q$.  This answers: *If benefits are concentrated among the very best prospects, how much can we harvest by cherry-picking them?*  </span>
<span id="cb6-456"><a href="#cb6-456"></a></span>
<span id="cb6-457"><a href="#cb6-457"></a><span class="ss">* </span>**RATE Qini** applies heavier weight to the mid-range of $q$.  This is the go-to metric when investigators face a fixed, moderate-sized budget—say, "we can afford to treat 40 % of individuals; will targeting help?"  <span class="co">[</span><span class="ot">@yadlowsky2021evaluating</span><span class="co">]</span>. We will evaluate the curve at treatment of 20% and 50% of the population.</span>
<span id="cb6-458"><a href="#cb6-458"></a></span>
<span id="cb6-459"><a href="#cb6-459"></a></span>
<span id="cb6-460"><a href="#cb6-460"></a>To quantify the economic or policy value of heterogeneity, rank units by $\widehat{\tau}(x)$ and draw a **Targeting-Operator Characteristic (TOC)** curve that plots cumulative gain against the fraction $q$ of the population treated.  </span>
<span id="cb6-461"><a href="#cb6-461"></a></span>
<span id="cb6-462"><a href="#cb6-462"></a>---</span>
<span id="cb6-463"><a href="#cb6-463"></a></span>
<span id="cb6-464"><a href="#cb6-464"></a><span class="fu">### 7 RATE AUTOC EXAMPLE</span></span>
<span id="cb6-465"><a href="#cb6-465"></a></span>
<span id="cb6-466"><a href="#cb6-466"></a>Although OOB predictions are 'out-of-sample' for individual trees, the full forest still reuses information.  A simple remedy when estimating the RATE AUTOC and Qini is to split the data, **training** the forest on one fold and **testing** RATE/Qini on the other.  Again, this explicit splitting blocks optimistic bias and yields honest test statistics (such as confidence intervals) <span class="co">[</span><span class="ot">@grf2024</span><span class="co">]</span>.</span>
<span id="cb6-467"><a href="#cb6-467"></a></span>
<span id="cb6-468"><a href="#cb6-468"></a><span class="in">```{r, results='asis'}</span></span>
<span id="cb6-469"><a href="#cb6-469"></a><span class="co">#| label: fig-rate-example</span></span>
<span id="cb6-470"><a href="#cb6-470"></a><span class="co">#| fig-cap: "RATE AUTOC: Hours Socialising → Sense of Meaning"</span></span>
<span id="cb6-471"><a href="#cb6-471"></a><span class="co">#| echo: false</span></span>
<span id="cb6-472"><a href="#cb6-472"></a><span class="co">#| column: screen</span></span>
<span id="cb6-473"><a href="#cb6-473"></a>batch_rate_autoc_plots<span class="sc">$</span>model_t2_meaning_sense_z</span>
<span id="cb6-474"><a href="#cb6-474"></a><span class="in">```</span></span>
<span id="cb6-475"><a href="#cb6-475"></a></span>
<span id="cb6-476"><a href="#cb6-476"></a>@fig-rate-example depicts a typical RATE AUTOC curve with sample splitting.  A steep initial rise indicates that a small, correctly targeted programme could deliver large gains. Note that the curve begins dipping below zero past about 30% of the sample. At that point we might be doing worse than the ATE by targeting the CATE -- at least for some.</span>
<span id="cb6-477"><a href="#cb6-477"></a></span>
<span id="cb6-478"><a href="#cb6-478"></a>**Remember -- figuring out who will benefit from a treatment is a difficult statistical problem [@grf2024].**</span>
<span id="cb6-479"><a href="#cb6-479"></a></span>
<span id="cb6-480"><a href="#cb6-480"></a>---</span>
<span id="cb6-481"><a href="#cb6-481"></a></span>
<span id="cb6-482"><a href="#cb6-482"></a><span class="fu">### 8 Visualising policy value: the Qini curve  </span></span>
<span id="cb6-483"><a href="#cb6-483"></a></span>
<span id="cb6-484"><a href="#cb6-484"></a>A **Qini curve** displays cumulative benefit on the vertical axis and treatment coverage (% of the population treated) on the horizontal.  As with the AUTOC curve we are using a held-out test fold to validate the response curve.</span>
<span id="cb6-485"><a href="#cb6-485"></a></span>
<span id="cb6-486"><a href="#cb6-486"></a><span class="in">```{r, results='asis'}</span></span>
<span id="cb6-487"><a href="#cb6-487"></a><span class="co">#| label: fig-qini-example</span></span>
<span id="cb6-488"><a href="#cb6-488"></a><span class="co">#| fig-cap: "Qini Curve: Hours Socialising → Social Belonging"</span></span>
<span id="cb6-489"><a href="#cb6-489"></a><span class="co">#| echo: false</span></span>
<span id="cb6-490"><a href="#cb6-490"></a><span class="co">#| column: screen</span></span>
<span id="cb6-491"><a href="#cb6-491"></a>plot_qini_belong</span>
<span id="cb6-492"><a href="#cb6-492"></a><span class="in">```</span></span>
<span id="cb6-493"><a href="#cb6-493"></a></span>
<span id="cb6-494"><a href="#cb6-494"></a></span>
<span id="cb6-495"><a href="#cb6-495"></a></span>
<span id="cb6-496"><a href="#cb6-496"></a>@fig-qini-example: we find that focussing on the top 20 % of individuals nets a gain of 0.08 units (95 % CI 0.04–0.12).  Widening the net to 50 % bumps the haul to 0.13 units (95 % CI 0.07–0.19).  After that the curve flattens -- once we’ve treated everyone who offers a decent return, there are no more 'big fish' left to catch.</span>
<span id="cb6-497"><a href="#cb6-497"></a></span>
<span id="cb6-498"><a href="#cb6-498"></a>---</span>
<span id="cb6-499"><a href="#cb6-499"></a></span>
<span id="cb6-500"><a href="#cb6-500"></a></span>
<span id="cb6-501"><a href="#cb6-501"></a><span class="fu">### 9 From 'a black box' to simple rules: policy trees  </span></span>
<span id="cb6-502"><a href="#cb6-502"></a></span>
<span id="cb6-503"><a href="#cb6-503"></a>The causal forest hands us a personalised CATE for every individual, mapping a **high-dimensional** covariate vector $X$ to a number $\widehat{\tau}(X)$.  Helpful as that forecast may be, it stops short of telling us *what to do*: the function itself is too tangled --- thousands of overlapping splits -- to translate directly into a policy.  </span>
<span id="cb6-504"><a href="#cb6-504"></a></span>
<span id="cb6-505"><a href="#cb6-505"></a>The **policytree** algorithm bridges that gap by collapsing the forest's many $\widehat{\tau}(X)$ values into a single, shallow decision tree whose depth you choose; each split is chosen to maximise expected benefit [@policytree_package_2024].  In this course we cap the depth at **two** for a practical balance, specifially:</span>
<span id="cb6-506"><a href="#cb6-506"></a></span>
<span id="cb6-507"><a href="#cb6-507"></a><span class="ss">- </span>At most three yes/no questions per rule, so the logic fits on a slide you can present to policy-makers</span>
<span id="cb6-508"><a href="#cb6-508"></a><span class="ss">- </span>Each leaf still contains enough observations to yield a stable effect estimate;  </span>
<span id="cb6-509"><a href="#cb6-509"></a><span class="ss">- </span>Deeper trees increase computational complexity faster than they improve payoffs.</span>
<span id="cb6-510"><a href="#cb6-510"></a></span>
<span id="cb6-511"><a href="#cb6-511"></a><span class="in">```{r, results='asis'}</span></span>
<span id="cb6-512"><a href="#cb6-512"></a><span class="co">#| label: fig-decision-tree</span></span>
<span id="cb6-513"><a href="#cb6-513"></a><span class="co">#| fig-cap: "Decision tree for Social Belonging"</span></span>
<span id="cb6-514"><a href="#cb6-514"></a><span class="co">#| echo: false</span></span>
<span id="cb6-515"><a href="#cb6-515"></a><span class="co">#| column: screen</span></span>
<span id="cb6-516"><a href="#cb6-516"></a>plots_policy_trees<span class="sc">$</span>model_t2_belong_z<span class="sc">$</span>decision_tree</span>
<span id="cb6-517"><a href="#cb6-517"></a><span class="in">```</span></span>
<span id="cb6-518"><a href="#cb6-518"></a></span>
<span id="cb6-519"><a href="#cb6-519"></a> </span>
<span id="cb6-520"><a href="#cb6-520"></a>**Policy Tree Findings for Effect of Hour Socialising on Social Belonging:**</span>
<span id="cb6-521"><a href="#cb6-521"></a></span>
<span id="cb6-522"><a href="#cb6-522"></a>Participants are first split by Self Esteem at -0.925 (original scale: 3.958). For those with Self Esteem $&lt;=$ this threshold, the next split is by Neuroticism at 0.642 (original scale: 4.228). Within that subgroup, individuals with Neuroticism $&lt;=$ the threshold are recommended **control**, while those with Neuroticism $&gt;$ the threshold are recommended **treated**.</span>
<span id="cb6-523"><a href="#cb6-523"></a></span>
<span id="cb6-524"><a href="#cb6-524"></a>For participants with Self Esteem $&gt;$ -0.925 (original scale: 3.958), the second split is by Social Belonging at 0.776 (original scale: 5.972). In this subgroup, individuals with Social Belonging $&lt;=$ the threshold are recommended **treated**, while those with Social Belonging $&gt;$ the threshold are recommended **control**.</span>
<span id="cb6-525"><a href="#cb6-525"></a></span>
<span id="cb6-526"><a href="#cb6-526"></a></span>
<span id="cb6-527"><a href="#cb6-527"></a><span class="in">```{r, results='asis'}</span></span>
<span id="cb6-528"><a href="#cb6-528"></a><span class="co">#| label: fig-policy-map</span></span>
<span id="cb6-529"><a href="#cb6-529"></a><span class="co">#| fig-cap: "Predicted treatment assignment (predictions out of training sample)"</span></span>
<span id="cb6-530"><a href="#cb6-530"></a><span class="co">#| fig-height: 14   # adjust</span></span>
<span id="cb6-531"><a href="#cb6-531"></a><span class="co">#| fig-width: 16  # adjust</span></span>
<span id="cb6-532"><a href="#cb6-532"></a><span class="co">#| echo: false</span></span>
<span id="cb6-533"><a href="#cb6-533"></a>plots_policy_trees<span class="sc">$</span>model_t2_belong_z<span class="sc">$</span>policy_tree</span>
<span id="cb6-534"><a href="#cb6-534"></a><span class="in">```</span></span>
<span id="cb6-535"><a href="#cb6-535"></a></span>
<span id="cb6-536"><a href="#cb6-536"></a></span>
<span id="cb6-537"><a href="#cb6-537"></a></span>
<span id="cb6-538"><a href="#cb6-538"></a>---</span>
<span id="cb6-539"><a href="#cb6-539"></a></span>
<span id="cb6-540"><a href="#cb6-540"></a><span class="fu">### 10 Ethical and practical considerations  </span></span>
<span id="cb6-541"><a href="#cb6-541"></a></span>
<span id="cb6-542"><a href="#cb6-542"></a>There is no guarantee that statistical optimality will line up with social optimality. A rule that maximises expected health gains might still be **unaffordable** for a public agency, **unfair** to a protected group, or **opaque** to those asked to trust it.  We all have our notions of fairness, and we can't be expected to ignore them. Moreover, the estimation of CATE is always senstive to which variables we include in our model (see the caveats in <span class="co">[</span><span class="ot">Lecture 6</span><span class="co">](https://go-bayes.github.io/psych-434-2025/content/06-content.html#appendix-b-evidence-for-effect-modification-is-relative-to-inclusion-of-other-variables-in-the-model)</span>).  </span>
<span id="cb6-543"><a href="#cb6-543"></a></span>
<span id="cb6-544"><a href="#cb6-544"></a>So, we should not consider CATE an absolute guide to practice. We should be cautious. </span>
<span id="cb6-545"><a href="#cb6-545"></a></span>
<span id="cb6-546"><a href="#cb6-546"></a>Yet the very same CATE machinery that powers targeting also helps science move past a *one-size-fits-all* mindset.  By mapping treatment effects across a high-dimensional covariate space, we can test whether our favourite categories -- gender, age group, clinical severity -- actually capture the differences that matter.  Sometimes they do; often they don't, revealing that nature is not carved at the joints of our folk classifications.  Discovering *where* the forest finds meaningful splits can generate fresh psychological hypotheses about who responds, why, and under what circumstances, even when no policy decision is on the table. Over the next several weeks, we shall return to this point with examples.</span>
<span id="cb6-547"><a href="#cb6-547"></a></span>
<span id="cb6-548"><a href="#cb6-548"></a></span>
<span id="cb6-549"><a href="#cb6-549"></a><span class="co">&lt;!-- Before deployment we therefore need three extra layers of scrutiny: --&gt;</span></span>
<span id="cb6-550"><a href="#cb6-550"></a></span>
<span id="cb6-551"><a href="#cb6-551"></a><span class="co">&lt;!-- 1. **Cost realism**   Will the programme's administrative and opportunity costs erase the forecast benefit?  A cost–effectiveness analysis can reveal when a simpler, less 'optimal' rule actually delivers better value.   --&gt;</span></span>
<span id="cb6-552"><a href="#cb6-552"></a><span class="co">&lt;!-- 2. **Fairness auditing**  check whether error rates or treatment probabilities differ by gender, ethnicity, or socioeconomic status.  If gaps appear, consider adjusting the loss function or adding fairness constraints [@mitchell2021algorithmic].   --&gt;</span></span>
<span id="cb6-553"><a href="#cb6-553"></a><span class="co">&lt;!-- 3. **Transparency and consent**   Publish the rule, document data sources, and secure stakeholder buy-in.  Transparent governance limits the risk of political backlash and encourages external replication. --&gt;</span></span>
<span id="cb6-554"><a href="#cb6-554"></a></span>
<span id="cb6-555"><a href="#cb6-555"></a>---</span>
<span id="cb6-556"><a href="#cb6-556"></a></span>
<span id="cb6-557"><a href="#cb6-557"></a><span class="fu">### Summary/next steps  </span></span>
<span id="cb6-558"><a href="#cb6-558"></a></span>
<span id="cb6-559"><a href="#cb6-559"></a>Our workflow answers three questions in sequence:</span>
<span id="cb6-560"><a href="#cb6-560"></a></span>
<span id="cb6-561"><a href="#cb6-561"></a><span class="ss">1. </span>**Is there substantial heterogeneity?**  Reject $H_0{:}\tau(x)$ constant if RATE AUTOC or RATE Qini is positive and statistically reliable  </span>
<span id="cb6-562"><a href="#cb6-562"></a><span class="ss">2. </span>**Does targeting pay at realistic budgets?**  Inspect the slope of the Qini curve around plausible coverage levels.</span>
<span id="cb6-563"><a href="#cb6-563"></a><span class="ss">3. </span>**Can we express the targeting rule in a few defensible steps?**  fit and validate a shallow policy tree.</span>
<span id="cb6-564"><a href="#cb6-564"></a></span>
<span id="cb6-565"><a href="#cb6-565"></a>In the lab section you will reproduce each stage on a simulated dataset.</span>
<span id="cb6-566"><a href="#cb6-566"></a></span>
<span id="cb6-567"><a href="#cb6-567"></a>---</span>
<span id="cb6-568"><a href="#cb6-568"></a></span>
<span id="cb6-569"><a href="#cb6-569"></a></span>
<span id="cb6-570"><a href="#cb6-570"></a><span class="fu">## Lab: Data Preparation and Analysis Scripts</span></span>
<span id="cb6-571"><a href="#cb6-571"></a></span>
<span id="cb6-572"><a href="#cb6-572"></a></span>
<span id="cb6-573"><a href="#cb6-573"></a><span class="fu">### Link to data dictionary</span></span>
<span id="cb6-574"><a href="#cb6-574"></a></span>
<span id="cb6-575"><a href="#cb6-575"></a>::: {.callout-note}</span>
<span id="cb6-576"><a href="#cb6-576"></a>For information about the variables in the synthetic data, download the New Zealand Attitudes and Values Data Dictionary here under "Primary Resources"</span>
<span id="cb6-577"><a href="#cb6-577"></a></span>
<span id="cb6-578"><a href="#cb6-578"></a><span class="co">[</span><span class="ot">https://osf.io/75snb/</span><span class="co">](https://osf.io/75snb/)</span></span>
<span id="cb6-579"><a href="#cb6-579"></a></span>
<span id="cb6-580"><a href="#cb6-580"></a>:::</span>
<span id="cb6-581"><a href="#cb6-581"></a></span>
<span id="cb6-582"><a href="#cb6-582"></a></span>
<span id="cb6-583"><a href="#cb6-583"></a><span class="fu">### Script 1:</span></span>
<span id="cb6-584"><a href="#cb6-584"></a></span>
<span id="cb6-585"><a href="#cb6-585"></a></span>
<span id="cb6-586"><a href="#cb6-586"></a></span>
<span id="cb6-589"><a href="#cb6-589"></a><span class="in">```{r}</span></span>
<span id="cb6-590"><a href="#cb6-590"></a><span class="co">#| include: true</span></span>
<span id="cb6-591"><a href="#cb6-591"></a><span class="co">#| eval: false</span></span>
<span id="cb6-592"><a href="#cb6-592"></a><span class="co">#| file: ../laboratory/01-example-script-data-wrangling.R</span></span>
<span id="cb6-593"><a href="#cb6-593"></a></span>
<span id="cb6-594"><a href="#cb6-594"></a></span>
<span id="cb6-595"><a href="#cb6-595"></a><span class="in">```</span></span>
<span id="cb6-596"><a href="#cb6-596"></a></span>
<span id="cb6-597"><a href="#cb6-597"></a></span>
<span id="cb6-598"><a href="#cb6-598"></a><span class="fu">### Script 2</span></span>
<span id="cb6-599"><a href="#cb6-599"></a></span>
<span id="cb6-602"><a href="#cb6-602"></a><span class="in">```{r}</span></span>
<span id="cb6-603"><a href="#cb6-603"></a><span class="co">#| include: true</span></span>
<span id="cb6-604"><a href="#cb6-604"></a><span class="co">#| eval: false</span></span>
<span id="cb6-605"><a href="#cb6-605"></a><span class="co">#| file: ../laboratory/02-example-script-data-wrangling-2.R</span></span>
<span id="cb6-606"><a href="#cb6-606"></a></span>
<span id="cb6-607"><a href="#cb6-607"></a><span class="in">```</span></span>
<span id="cb6-608"><a href="#cb6-608"></a></span>
<span id="cb6-609"><a href="#cb6-609"></a></span>
<span id="cb6-610"><a href="#cb6-610"></a><span class="fu">### Script 3</span></span>
<span id="cb6-611"><a href="#cb6-611"></a></span>
<span id="cb6-614"><a href="#cb6-614"></a><span class="in">```{r}</span></span>
<span id="cb6-615"><a href="#cb6-615"></a><span class="co">#| include: true</span></span>
<span id="cb6-616"><a href="#cb6-616"></a><span class="co">#| eval: false</span></span>
<span id="cb6-617"><a href="#cb6-617"></a><span class="co">#| file: ../laboratory/03-example-script-estimation-results.R</span></span>
<span id="cb6-618"><a href="#cb6-618"></a></span>
<span id="cb6-619"><a href="#cb6-619"></a><span class="in">```</span></span>
<span id="cb6-620"><a href="#cb6-620"></a></span>
<span id="cb6-621"><a href="#cb6-621"></a></span>
<span id="cb6-622"><a href="#cb6-622"></a></span>
<span id="cb6-623"><a href="#cb6-623"></a><span class="fu">## HOMEWORK: Prepare a fresh set of analysis scripts using a different exposure</span></span>
<span id="cb6-624"><a href="#cb6-624"></a></span>
<span id="cb6-625"><a href="#cb6-625"></a><span class="ss">- </span>E.g. Ask: what are the effects of a shift in religious service <span class="in">`religion_church`</span> on multi-dimensional well-being. </span>
<span id="cb6-626"><a href="#cb6-626"></a><span class="ss">- </span>Consider what variables you need for confounding control at baseline. </span>
<span id="cb6-627"><a href="#cb6-627"></a><span class="ss">- </span>Think about how to make the exposure variable binary.</span>
<span id="cb6-628"><a href="#cb6-628"></a><span class="ss">- </span>You may consider different outcome(s) as well as a different exposure. </span>
<span id="cb6-629"><a href="#cb6-629"></a></span>
<span id="cb6-630"><a href="#cb6-630"></a></span>
<span id="cb6-631"><a href="#cb6-631"></a></span>
<span id="cb6-632"><a href="#cb6-632"></a></span>
<span id="cb6-633"><a href="#cb6-633"></a><span class="fu">### Packages</span></span>
<span id="cb6-634"><a href="#cb6-634"></a></span>
<span id="cb6-637"><a href="#cb6-637"></a><span class="in">```{r}</span></span>
<span id="cb6-638"><a href="#cb6-638"></a>report<span class="sc">::</span><span class="fu">cite_packages</span>()</span>
<span id="cb6-639"><a href="#cb6-639"></a><span class="in">```</span></span>
<span id="cb6-640"><a href="#cb6-640"></a></span>
<span id="cb6-641"><a href="#cb6-641"></a></span>
<span id="cb6-642"><a href="#cb6-642"></a></span>
<span id="cb6-643"><a href="#cb6-643"></a><span class="fu">## Appendix </span></span>
<span id="cb6-644"><a href="#cb6-644"></a></span>
<span id="cb6-645"><a href="#cb6-645"></a><span class="fu">## Review: The Fundamental Problem of Causal Inference as a Missing Data Problem</span></span>
<span id="cb6-646"><a href="#cb6-646"></a></span>
<span id="cb6-647"><a href="#cb6-647"></a>Recall the fundamental problem of causal inference, returning to the question of whether bilingualism improves cognitive abilities:</span>
<span id="cb6-648"><a href="#cb6-648"></a></span>
<span id="cb6-649"><a href="#cb6-649"></a><span class="ss">-   </span>$Y_i^{a = 1}$: The cognitive ability of child $i$ if they were bilingual. This is the counterfactual outcome when A = 1.</span>
<span id="cb6-650"><a href="#cb6-650"></a><span class="ss">-   </span>$Y_i^{a = 0}$:: The cognitive ability of child $i$ if they were monolingual. This is the counterfactual outcome when A = 0.</span>
<span id="cb6-651"><a href="#cb6-651"></a></span>
<span id="cb6-652"><a href="#cb6-652"></a>The causal effect of bilingualism on cognitive ability for individual $i$ is then defined as the difference between these potential outcomes:</span>
<span id="cb6-653"><a href="#cb6-653"></a></span>
<span id="cb6-654"><a href="#cb6-654"></a>$$</span>
<span id="cb6-655"><a href="#cb6-655"></a>\text{Causal Effect}_i = Y_i^{a=1} - Y_i^{a=0} </span>
<span id="cb6-656"><a href="#cb6-656"></a>$$</span>
<span id="cb6-657"><a href="#cb6-657"></a></span>
<span id="cb6-658"><a href="#cb6-658"></a>We say there is a causal effect if:</span>
<span id="cb6-659"><a href="#cb6-659"></a></span>
<span id="cb6-660"><a href="#cb6-660"></a>$$</span>
<span id="cb6-661"><a href="#cb6-661"></a>Y_i^{a=1} - Y_i^{a=0}  \neq 0</span>
<span id="cb6-662"><a href="#cb6-662"></a>$$</span>
<span id="cb6-663"><a href="#cb6-663"></a></span>
<span id="cb6-664"><a href="#cb6-664"></a>However, we only observe one of the potential outcomes for each child. The other outcome is not observed because physics prevents a child from both receiving and not receiving bilingual exposure.</span>
<span id="cb6-665"><a href="#cb6-665"></a></span>
<span id="cb6-666"><a href="#cb6-666"></a>The fact that causal contrasts are not observed in individuals is called "The fundamental problem of causal inference."</span>
<span id="cb6-667"><a href="#cb6-667"></a></span>
<span id="cb6-668"><a href="#cb6-668"></a>Although we typically cannot observe individual causal effects, we can obtain average causal effects when certain assumptions are satisfied.</span>
<span id="cb6-669"><a href="#cb6-669"></a></span>
<span id="cb6-670"><a href="#cb6-670"></a><span class="in">```{=tex}</span></span>
<span id="cb6-671"><a href="#cb6-671"></a><span class="in">\begin{align}</span></span>
<span id="cb6-672"><a href="#cb6-672"></a><span class="in">E(\delta) = E(Y^{a=1} - Y^{a=0})\\</span></span>
<span id="cb6-673"><a href="#cb6-673"></a><span class="in">          ~  = E(Y^{a=1}) - E(Y^{a=0}) \\</span></span>
<span id="cb6-674"><a href="#cb6-674"></a><span class="in">          ~  = ATE</span></span>
<span id="cb6-675"><a href="#cb6-675"></a><span class="in">\end{align}</span></span>
<span id="cb6-676"><a href="#cb6-676"></a><span class="in">```</span></span>
<span id="cb6-677"><a href="#cb6-677"></a>We may identify average causal effects from the data when the following assumptions are met:</span>
<span id="cb6-678"><a href="#cb6-678"></a></span>
<span id="cb6-679"><a href="#cb6-679"></a><span class="ss">-   </span>**Causal Consistency:** The exposure values under comparisons correspond to well-defined interventions that, in turn, correspond to the treatment versions in the data.[]</span>
<span id="cb6-680"><a href="#cb6-680"></a><span class="ss">-   </span>**Positivity:** The probability of receiving every value of the exposure within all strata of co-variates is greater than zero []</span>
<span id="cb6-681"><a href="#cb6-681"></a><span class="ss">-   </span>**Exchangeability:** The conditional probability of receiving every value of an exposure level, though not decided by the investigators, depends only on the measured covariates []</span>
<span id="cb6-682"><a href="#cb6-682"></a></span>
<span id="cb6-683"><a href="#cb6-683"></a>Further assumptions:</span>
<span id="cb6-684"><a href="#cb6-684"></a></span>
<span id="cb6-685"><a href="#cb6-685"></a><span class="ss">-   </span>**No Interference,** also known as the **Stable Unit Treatment Value Assumption** (SUTVA), requires that the treatment given to one unit (e.g., person, group, organization) does not interfere with the potential outcomes of another unit. Put differently, there are no "spillover" effects. Note: this assumption may be thought to be part of causal consistency, namely individual has only one potential outcome under each treatment condition.</span>
<span id="cb6-686"><a href="#cb6-686"></a><span class="ss">-   </span>**Correctly specified model**: the requirement that the underlying statistical model used to estimate causal effects accurately represents the true relationships between the variables of interest. We say the model should be able to capture "the functional form" of the relationship between the treatment, the outcome, and any covariates. The model's functional form should be flexible enough to capture the true underlying relationship. The estimated causal effects may be biased if the model's functional form is incorrect. Additionally, the model must handle omitted variable bias by including all relevant confounders and should correctly handle missing data from non-response or loss-to follow up. We will return to the bias arising from missing data in the weeks ahead. For now, it is important to note that causal inference assumes that our model is correctly specified.</span>
<span id="cb6-687"><a href="#cb6-687"></a></span>
<span id="cb6-688"><a href="#cb6-688"></a></span>
<span id="cb6-689"><a href="#cb6-689"></a><span class="fu">## Subgroup analysis</span></span>
<span id="cb6-690"><a href="#cb6-690"></a></span>
<span id="cb6-691"><a href="#cb6-691"></a>Redcall, **Effect Modification** (also known as "heterogeneity of treatment effects", and "Effect-measure modification") occurs when the causal effect of intervention $A$ varies across different levels of another variable $R$:</span>
<span id="cb6-692"><a href="#cb6-692"></a></span>
<span id="cb6-693"><a href="#cb6-693"></a>$$E(Y^{a=1}|G=g_1, L=l) - E(Y^{a=0}|G=g_1, L=l) \neq E(Y^{a=1}|G=g_2, L=l) - E(Y^{a=0}|G=g_2, L=l)$$</span>
<span id="cb6-694"><a href="#cb6-694"></a></span>
<span id="cb6-695"><a href="#cb6-695"></a>Effect modification indicates that the magnitude of the causal effect of intervention $A$ is related to the modifier variable $G$ level. As discussed last week, effect modification can be observed even when there is no direct causal interaction between the treatment and the modifier variable. We noted that **interaction in causal inference refers to a situation where the combined effect of two interventions is not equal to the sum of their individual effects**. **Effect modification, on the other hand, occurs when the causal effect of one intervention varies across different levels of another variable.**</span>
<span id="cb6-696"><a href="#cb6-696"></a></span>
<span id="cb6-697"><a href="#cb6-697"></a></span>
<span id="cb6-698"><a href="#cb6-698"></a>We also noted that </span>
<span id="cb6-699"><a href="#cb6-699"></a></span>
<span id="cb6-700"><a href="#cb6-700"></a><span class="at">&gt; **For comparative research, we are typically interested in effect-modification, which requires subgroup analysis.**</span></span>
<span id="cb6-701"><a href="#cb6-701"></a></span>
<span id="cb6-702"><a href="#cb6-702"></a></span>
<span id="cb6-703"><a href="#cb6-703"></a><span class="fu">### Causal Estimand, Statistical Estimand, Statistical Estimator</span></span>
<span id="cb6-704"><a href="#cb6-704"></a></span>
<span id="cb6-705"><a href="#cb6-705"></a>Let's set subgroup analysis to the side for a moment and begin focussing on statistical estimation.  </span>
<span id="cb6-706"><a href="#cb6-706"></a></span>
<span id="cb6-707"><a href="#cb6-707"></a>Suppose a researcher wants to understand the causal effect of marriage on individual happiness. Participants in the study are surveyed for their marital status ("married" or "not married") and their self-reported happiness on a scale from 1 to 10.</span>
<span id="cb6-708"><a href="#cb6-708"></a></span>
<span id="cb6-709"><a href="#cb6-709"></a><span class="fu">#### Causal Estimand</span></span>
<span id="cb6-710"><a href="#cb6-710"></a></span>
<span id="cb6-711"><a href="#cb6-711"></a><span class="ss">- </span>**Definition**: The causal estimand is the specific quantity or parameter that we aim to estimate to understand the causal effect of an intervention or treatment on an outcome.</span>
<span id="cb6-712"><a href="#cb6-712"></a></span>
<span id="cb6-713"><a href="#cb6-713"></a><span class="ss">- </span>**Example**: Here, the **Causal Estimand** would be the Average Treatment Effect (ATE) of being married on happiness. Specifically, we define the ATE as the difference in the potential outcomes of happiness if all individuals were married versus if no individuals were married:</span>
<span id="cb6-714"><a href="#cb6-714"></a></span>
<span id="cb6-715"><a href="#cb6-715"></a>  $$</span>
<span id="cb6-716"><a href="#cb6-716"></a>  \text{ATE} = E<span class="co">[</span><span class="ot">Y^{a=1} - Y^{a=0}</span><span class="co">]</span></span>
<span id="cb6-717"><a href="#cb6-717"></a>  $$</span>
<span id="cb6-718"><a href="#cb6-718"></a></span>
<span id="cb6-719"><a href="#cb6-719"></a></span>
<span id="cb6-720"><a href="#cb6-720"></a>  Here, $Y^{a=1}$ represents the potential happiness score if an individual is married, and $Y^{a=0}$ if they are not married.</span>
<span id="cb6-721"><a href="#cb6-721"></a></span>
<span id="cb6-722"><a href="#cb6-722"></a></span>
<span id="cb6-723"><a href="#cb6-723"></a><span class="fu">#### Next step: Are Causal Assumptions Met? </span></span>
<span id="cb6-724"><a href="#cb6-724"></a></span>
<span id="cb6-725"><a href="#cb6-725"></a><span class="ss">- </span>Identification (Exchangeability): balance in the confounders across the treatments to be compared</span>
<span id="cb6-726"><a href="#cb6-726"></a></span>
<span id="cb6-727"><a href="#cb6-727"></a><span class="ss">- </span>Consistency: well-defined interventions</span>
<span id="cb6-728"><a href="#cb6-728"></a></span>
<span id="cb6-729"><a href="#cb6-729"></a><span class="ss">- </span>Positivity: treatments occur within levels of covariates $L$</span>
<span id="cb6-730"><a href="#cb6-730"></a></span>
<span id="cb6-731"><a href="#cb6-731"></a></span>
<span id="cb6-732"><a href="#cb6-732"></a><span class="fu">#### Statistical Estimand (next step)</span></span>
<span id="cb6-733"><a href="#cb6-733"></a></span>
<span id="cb6-734"><a href="#cb6-734"></a><span class="ss">- </span>**The problem**: how do we bridge the gap between potential outcomes and data? </span>
<span id="cb6-735"><a href="#cb6-735"></a></span>
<span id="cb6-736"><a href="#cb6-736"></a><span class="ss">- </span>**Definition**: the statistical estimand is the parameter or function that summarises the relationship between variables as described by a statistical model applied to data. </span>
<span id="cb6-737"><a href="#cb6-737"></a></span>
<span id="cb6-738"><a href="#cb6-738"></a><span class="ss">- </span>**Example**: for our study, the **Statistical Estimand** might be the mean difference in happiness scores between individuals who are married and those who are not, as derived from a linear regression model:</span>
<span id="cb6-739"><a href="#cb6-739"></a></span>
<span id="cb6-740"><a href="#cb6-740"></a>  $$</span>
<span id="cb6-741"><a href="#cb6-741"></a>  \text{Happiness} = \beta_0 + \beta_1 \times \text{Married} + \epsilon</span>
<span id="cb6-742"><a href="#cb6-742"></a>  $$</span>
<span id="cb6-743"><a href="#cb6-743"></a></span>
<span id="cb6-744"><a href="#cb6-744"></a>  In this equation, $\beta_1$ represents the estimated difference in happiness scores between the married and non-married groups.</span>
<span id="cb6-745"><a href="#cb6-745"></a></span>
<span id="cb6-746"><a href="#cb6-746"></a><span class="fu">#### Statistical Estimator</span></span>
<span id="cb6-747"><a href="#cb6-747"></a></span>
<span id="cb6-748"><a href="#cb6-748"></a><span class="ss">- </span>**Definition**: a statistical estimator is a rule or method by which a numerical estimate of a statistical estimand is calculated from the data.</span>
<span id="cb6-749"><a href="#cb6-749"></a></span>
<span id="cb6-750"><a href="#cb6-750"></a><span class="ss">- </span>**Example**: in our marriage study, the **Statistical Estimator** for $\beta_1$ is the ordinary least squares (OLS) estimator. This estimator is used to calculate $\beta_1$ from the sample data provided by the survey. It provides an estimate of the impact of being married on happiness, calculated using:</span>
<span id="cb6-751"><a href="#cb6-751"></a>  $$</span>
<span id="cb6-752"><a href="#cb6-752"></a>  \hat{\beta}_1 = \frac{\sum_{i=1}^n (X_i - \bar{X})(Y_i - \bar{Y})}{\sum_{i=1}^n (X_i - \bar{X})^2}</span>
<span id="cb6-753"><a href="#cb6-753"></a>  $$</span>
<span id="cb6-754"><a href="#cb6-754"></a>  where $X_i$ is a binary indicator for being married (1 for married, 0 for not married), $Y_i$ is the observed happiness score, and $\bar{X}$, $\bar{Y}$ are the sample means of $X$ and $Y$, respectively.</span>
<span id="cb6-755"><a href="#cb6-755"></a></span>
<span id="cb6-756"><a href="#cb6-756"></a>The upshot, we anchor our causal inquiries within a multi-step framework of data analysis. This involves: </span>
<span id="cb6-757"><a href="#cb6-757"></a></span>
<span id="cb6-758"><a href="#cb6-758"></a><span class="ss">1. </span>clearly defining our causal estimand within a specified *target population,*</span>
<span id="cb6-759"><a href="#cb6-759"></a><span class="ss">2. </span>clarifying assumptions, &amp; especially identification assumptions, </span>
<span id="cb6-760"><a href="#cb6-760"></a><span class="ss">3. </span>describing a statistical strategy for extracting this estimand from the data, and then </span>
<span id="cb6-761"><a href="#cb6-761"></a><span class="ss">4. </span>applying an algorithm that embodies this statistical method.</span>
<span id="cb6-762"><a href="#cb6-762"></a></span>
<span id="cb6-763"><a href="#cb6-763"></a></span>
<span id="cb6-764"><a href="#cb6-764"></a><span class="co">&lt;!-- ## Methods for Statistical Estimation in Causal Inference: Inverse Probability of Treatment Weights Using Propensity Scores --&gt;</span></span>
<span id="cb6-765"><a href="#cb6-765"></a></span>
<span id="cb6-766"><a href="#cb6-766"></a><span class="co">&lt;!-- Last week, we discussed confounding control using regression adjustment. Recall the formula for the average treatment effect (ATE) when conditioning on a set of covariates $L$: --&gt;</span></span>
<span id="cb6-767"><a href="#cb6-767"></a></span>
<span id="cb6-768"><a href="#cb6-768"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb6-769"><a href="#cb6-769"></a><span class="co">&lt;!-- \begin{aligned} --&gt;</span></span>
<span id="cb6-770"><a href="#cb6-770"></a><span class="co">&lt;!-- \text{ATE} = E[Y^{a=1} \mid L = l] - E[Y^{a=0} \mid L = l] \quad \text{for any value of } l --&gt;</span></span>
<span id="cb6-771"><a href="#cb6-771"></a><span class="co">&lt;!-- \end{aligned} --&gt;</span></span>
<span id="cb6-772"><a href="#cb6-772"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb6-773"><a href="#cb6-773"></a></span>
<span id="cb6-774"><a href="#cb6-774"></a><span class="co">&lt;!-- &gt; "We say that a set $L$ of measured non-descendants of $L$ is a sufficient set for confounding adjustment when conditioning on $L$ blocks all backdoor paths—that is, the treated and the untreated are exchangeable within levels of $L$" (Hernán &amp; Robins, *Causal Inference*, p. 86). --&gt;</span></span>
<span id="cb6-775"><a href="#cb6-775"></a></span>
<span id="cb6-776"><a href="#cb6-776"></a><span class="co">&lt;!-- This formula calculates the expected outcome difference between treated ($a=1$) and untreated ($a=0$) groups, given a specific value of the covariates $l$. --&gt;</span></span>
<span id="cb6-777"><a href="#cb6-777"></a></span>
<span id="cb6-778"><a href="#cb6-778"></a><span class="co">&lt;!-- Inverse Probability of Treatment Weighting (IPTW) takes a different approach. We create a pseudo-population where the treatment assignment is independent of the observed covariates by assigning weights to each individual based on their propensity scores. --&gt;</span></span>
<span id="cb6-779"><a href="#cb6-779"></a></span>
<span id="cb6-780"><a href="#cb6-780"></a><span class="co">&lt;!-- **We do this by modelling the treatment** --&gt;</span></span>
<span id="cb6-781"><a href="#cb6-781"></a></span>
<span id="cb6-782"><a href="#cb6-782"></a><span class="co">&lt;!-- Denote the treatment indicator by $A$, where $A = 1$ if an individual receives treatment and $A = 0$ otherwise. $L$ represents the vector of observed covariates, and $Y^a$ the potential outcomes. The propensity score, $e(L)$, is defined as the probability of receiving the treatment given the observed covariates: --&gt;</span></span>
<span id="cb6-783"><a href="#cb6-783"></a></span>
<span id="cb6-784"><a href="#cb6-784"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb6-785"><a href="#cb6-785"></a><span class="co">&lt;!-- \hat{e}(L) = P(A = 1 \mid L) --&gt;</span></span>
<span id="cb6-786"><a href="#cb6-786"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb6-787"><a href="#cb6-787"></a></span>
<span id="cb6-788"><a href="#cb6-788"></a><span class="co">&lt;!-- To obtain IPTW weights, compute the inverse probability of treatment: --&gt;</span></span>
<span id="cb6-789"><a href="#cb6-789"></a></span>
<span id="cb6-790"><a href="#cb6-790"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb6-791"><a href="#cb6-791"></a><span class="co">&lt;!-- v_i = \frac{A_i}{\hat{e}(L_i)} + \frac{1 - A_i}{1 - \hat{e}(L_i)} --&gt;</span></span>
<span id="cb6-792"><a href="#cb6-792"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb6-793"><a href="#cb6-793"></a></span>
<span id="cb6-794"><a href="#cb6-794"></a><span class="co">&lt;!-- Which simplifies to  --&gt;</span></span>
<span id="cb6-795"><a href="#cb6-795"></a></span>
<span id="cb6-796"><a href="#cb6-796"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb6-797"><a href="#cb6-797"></a><span class="co">&lt;!-- v_i =  --&gt;</span></span>
<span id="cb6-798"><a href="#cb6-798"></a><span class="co">&lt;!-- \begin{cases}  --&gt;</span></span>
<span id="cb6-799"><a href="#cb6-799"></a><span class="co">&lt;!-- \frac{1}{\hat{e}} &amp; \text{if } A_i = 1 \\ --&gt;</span></span>
<span id="cb6-800"><a href="#cb6-800"></a><span class="co">&lt;!-- \frac{1}{1-\hat{e}} &amp; \text{if } A_i = 0  --&gt;</span></span>
<span id="cb6-801"><a href="#cb6-801"></a><span class="co">&lt;!-- \end{cases} --&gt;</span></span>
<span id="cb6-802"><a href="#cb6-802"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb6-803"><a href="#cb6-803"></a></span>
<span id="cb6-804"><a href="#cb6-804"></a><span class="co">&lt;!-- where $v_i$ is the IPTW weight for individual $i$, $A_i$ is the treatment indicator for individual $i$, and $\hat{e}(L_i)$ is the estimated propensity score for individual $i$.    --&gt;</span></span>
<span id="cb6-805"><a href="#cb6-805"></a></span>
<span id="cb6-806"><a href="#cb6-806"></a><span class="co">&lt;!-- How might we use these weights to obtain causal effect estimates? --&gt;</span></span>
<span id="cb6-807"><a href="#cb6-807"></a></span>
<span id="cb6-808"><a href="#cb6-808"></a></span>
<span id="cb6-809"><a href="#cb6-809"></a></span>
<span id="cb6-810"><a href="#cb6-810"></a><span class="co">&lt;!-- ## Marginal Structural Models (MSMs) --&gt;</span></span>
<span id="cb6-811"><a href="#cb6-811"></a></span>
<span id="cb6-812"><a href="#cb6-812"></a><span class="co">&lt;!-- Marginal Structural Models (MSMs) estimate causal effects without requiring an "outcome model" that stratifies on covariates. Rather, MSMs employ weights derived from the inverse probability of treatment weighting (IPTW) to create a pseudo-population in which the distribution of covariates is independent of treatment assignment over time. --&gt;</span></span>
<span id="cb6-813"><a href="#cb6-813"></a></span>
<span id="cb6-814"><a href="#cb6-814"></a><span class="co">&lt;!-- The general form of an MSM can be expressed as follows: --&gt;</span></span>
<span id="cb6-815"><a href="#cb6-815"></a></span>
<span id="cb6-816"><a href="#cb6-816"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb6-817"><a href="#cb6-817"></a><span class="co">&lt;!-- E[Y^a] = \beta_0 + \beta_1a --&gt;</span></span>
<span id="cb6-818"><a href="#cb6-818"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb6-819"><a href="#cb6-819"></a></span>
<span id="cb6-820"><a href="#cb6-820"></a><span class="co">&lt;!-- where $E[Y^a]$ is the expected outcome under treatment $a$  and $\beta_0$ and $\beta_1$ are parameters estimated by fitting the weighted model. Again, the weights used in the MSM, typically derived from the IPTW (or another treatment model), adjust for the confounding, allowing the model to estimate the unbiased effect of the treatment on the outcome without requiring covariates in the model. --&gt;</span></span>
<span id="cb6-821"><a href="#cb6-821"></a></span>
<span id="cb6-822"><a href="#cb6-822"></a><span class="co">&lt;!-- Where do weights fit in?   Note, we have $E[Y^a]$ in please of $E[Y|A=a]$.  When applying propensity score weights in the linear regression model $E[Y^a] = \beta_0 + \beta_1a$, each observation is weighted by $v_i$, such that $v_i(\beta_0 + \beta_1a)$. This changes the estimation process to focus on a weighted sum of outcomes, where each individual's contribution is adjusted to reflect their probability of receiving the treatment, given their covariates. --&gt;</span></span>
<span id="cb6-823"><a href="#cb6-823"></a></span>
<span id="cb6-824"><a href="#cb6-824"></a></span>
<span id="cb6-825"><a href="#cb6-825"></a><span class="co">&lt;!-- ## Interpretation of $\beta_0$ and $\beta_1$  in a Marginal Structural Model --&gt;</span></span>
<span id="cb6-826"><a href="#cb6-826"></a></span>
<span id="cb6-827"><a href="#cb6-827"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Binary Treatment --&gt;</span></span>
<span id="cb6-828"><a href="#cb6-828"></a></span>
<span id="cb6-829"><a href="#cb6-829"></a><span class="co">&lt;!-- In models where the treatment $a$ is binary (e.g., $a = 0$ or $a = 1$), such as in many causal inference studies: --&gt;</span></span>
<span id="cb6-830"><a href="#cb6-830"></a></span>
<span id="cb6-831"><a href="#cb6-831"></a><span class="co">&lt;!-- - **$\beta_0$**: the expected value of the outcome $Y$ when the treatment is not applied ($a = 0$). This is the baseline level of the outcome in the absence of treatment. --&gt;</span></span>
<span id="cb6-832"><a href="#cb6-832"></a><span class="co">&lt;!-- - **$\beta_1$**: the change in the expected outcome when the treatment status changes from 0 to 1. In logistic regression, $\beta_1$ represents the log-odds ratio of the outcome for the treatment group relative to the control group. In linear regression, $\beta_1$ quantifies the difference in the average outcome between the treated and untreated groups. --&gt;</span></span>
<span id="cb6-833"><a href="#cb6-833"></a></span>
<span id="cb6-834"><a href="#cb6-834"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Continuous Treatment --&gt;</span></span>
<span id="cb6-835"><a href="#cb6-835"></a></span>
<span id="cb6-836"><a href="#cb6-836"></a><span class="co">&lt;!-- When the treatment $a$ is continuous, the interpretation of $\beta_0$ and $\beta_1$ adjusts slightly: --&gt;</span></span>
<span id="cb6-837"><a href="#cb6-837"></a></span>
<span id="cb6-838"><a href="#cb6-838"></a><span class="co">&lt;!-- - **$\beta_0$**: represents the expected value of the outcome $Y$ when the treatment $a$ is at its reference value (often zero).  --&gt;</span></span>
<span id="cb6-839"><a href="#cb6-839"></a><span class="co">&lt;!-- - **$\beta_1$**: represents the expected change in the outcome for each unit increase in the treatment. In this case, $\beta_1$ measures the gradient or slope of the relationship between the treatment and the outcome. For every one-unit increase in treatment, the outcome changes by $\beta_1$ units, assuming all other factors remain constant. --&gt;</span></span>
<span id="cb6-840"><a href="#cb6-840"></a></span>
<span id="cb6-841"><a href="#cb6-841"></a></span>
<span id="cb6-842"><a href="#cb6-842"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co">  How can we apply marginal structural models in subgroups?  --&gt;</span></span>
<span id="cb6-843"><a href="#cb6-843"></a></span>
<span id="cb6-844"><a href="#cb6-844"></a></span>
<span id="cb6-845"><a href="#cb6-845"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Assumptions --&gt;</span></span>
<span id="cb6-846"><a href="#cb6-846"></a></span>
<span id="cb6-847"><a href="#cb6-847"></a><span class="co">&lt;!-- - **Model assumptions**: the treatment model is correctly specified. --&gt;</span></span>
<span id="cb6-848"><a href="#cb6-848"></a><span class="co">&lt;!-- - **Causal assumptions**: all confounders are appropriately controlled, positivity and consistency assumptions hold. --&gt;</span></span>
<span id="cb6-849"><a href="#cb6-849"></a></span>
<span id="cb6-850"><a href="#cb6-850"></a></span>
<span id="cb6-851"><a href="#cb6-851"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Calculating Treatment Weights (Propensity Scores) and Confounding Control in Subgroups --&gt;</span></span>
<span id="cb6-852"><a href="#cb6-852"></a></span>
<span id="cb6-853"><a href="#cb6-853"></a><span class="co">&lt;!-- We may often achieve greater balance when conducting weighted analyses in subgroups by estimating propensity scores *within* these subgroups. The propensity score $ e(L, G) $ is the conditional probability of receiving the exposure $ A = 1 $, given the covariates $ L $ and subgroup indicator $ G $. This is often modelled using logistic regression or other methods that ensure covariate balance --&gt;</span></span>
<span id="cb6-854"><a href="#cb6-854"></a><span class="co">&lt;!-- We define the estimated propensity score as follows: --&gt;</span></span>
<span id="cb6-855"><a href="#cb6-855"></a></span>
<span id="cb6-856"><a href="#cb6-856"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb6-857"><a href="#cb6-857"></a><span class="co">&lt;!-- \hat{e} = P(A = 1 \mid L, G) = f_A(L, G; \theta_A) --&gt;</span></span>
<span id="cb6-858"><a href="#cb6-858"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb6-859"><a href="#cb6-859"></a></span>
<span id="cb6-860"><a href="#cb6-860"></a><span class="co">&lt;!-- Here, $ f_A(L, G; \theta_A) $ is the statistical model estimating the probability of exposure $A = 1$ given covariates $L$ and subgroup $G$. We then calculate the weights for each individual, denoted $v$, using the estimated propensity score: --&gt;</span></span>
<span id="cb6-861"><a href="#cb6-861"></a></span>
<span id="cb6-862"><a href="#cb6-862"></a><span class="co">&lt;!-- $\theta_A$ encapsulates all the coefficients (parameters) in this model, including intercepts, slopes, and potentially other parameters depending on the model complexity (e.g., interaction terms, non-linear effects...etc). --&gt;</span></span>
<span id="cb6-863"><a href="#cb6-863"></a></span>
<span id="cb6-864"><a href="#cb6-864"></a><span class="co">&lt;!-- These weights $v$ depend on $A$ and are calculated as the inverse of the propensity score for exposed individuals and as the inverse of $ 1-\hat{e} $ for unexposed individuals. --&gt;</span></span>
<span id="cb6-865"><a href="#cb6-865"></a></span>
<span id="cb6-866"><a href="#cb6-866"></a><span class="co">&lt;!-- Propensity scores are estimated *separately* within strata of the subgroup to control for potential confounding tailored to each subgroup. These weights $v$ are specific to each individual in subgroup $G$. In the lab, we will clarify how to fit models to estimate contrasts for the causal effects within groups $\hat{\delta}_{g}, \hat{\delta}_{g'}$, etc., and how to obtain estimates for group-wise differences: --&gt;</span></span>
<span id="cb6-867"><a href="#cb6-867"></a></span>
<span id="cb6-868"><a href="#cb6-868"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb6-869"><a href="#cb6-869"></a><span class="co">&lt;!-- \hat{\gamma} = \overbrace{\big( \hat{E}[Y^a \mid G=g] - \hat{E}[Y^{a'} \mid G=g] \big)}^{\hat{\delta}_g} - \overbrace{\big( \hat{E}[Y^{a'} \mid G=g'] - \hat{E}[Y^a \mid G=g'] \big)}^{\hat{\delta}_{g'}} --&gt;</span></span>
<span id="cb6-870"><a href="#cb6-870"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb6-871"><a href="#cb6-871"></a></span>
<span id="cb6-872"><a href="#cb6-872"></a></span>
<span id="cb6-873"><a href="#cb6-873"></a><span class="co">&lt;!-- - **$\hat{E}[Y^a \mid G=g]$**: Estimated expected outcome when treatment $a$ is applied to subgroup $G=g$. --&gt;</span></span>
<span id="cb6-874"><a href="#cb6-874"></a><span class="co">&lt;!-- - **$\hat{E}[Y^{a'} \mid G=g]$**: Estimated expected outcome when a different treatment or control $a'$ is applied to the same subgroup $G=g$. --&gt;</span></span>
<span id="cb6-875"><a href="#cb6-875"></a><span class="co">&lt;!-- - **$\hat{\delta}_g$**: Represents the estimated treatment effect within subgroup $G=g$, computed as the difference in expected outcomes between treatment $a$ and $a'$ within this subgroup. --&gt;</span></span>
<span id="cb6-876"><a href="#cb6-876"></a></span>
<span id="cb6-877"><a href="#cb6-877"></a><span class="co">&lt;!-- - **$\hat{E}[Y^{a'} \mid G=g']$**: Estimated expected outcome when treatment $a'$ is applied to a different subgroup $G=g'$. --&gt;</span></span>
<span id="cb6-878"><a href="#cb6-878"></a><span class="co">&lt;!-- - **$\hat{E}[Y^a \mid G=g']$**: Estimated expected outcome when treatment $a$ is applied to subgroup $G=g'$. --&gt;</span></span>
<span id="cb6-879"><a href="#cb6-879"></a><span class="co">&lt;!-- - **$\hat{\delta}_{g'}$**: Represents the estimated treatment effect within subgroup $G=g'$, computed as the difference in expected outcomes between treatment $a'$ and $a$ within this subgroup. --&gt;</span></span>
<span id="cb6-880"><a href="#cb6-880"></a></span>
<span id="cb6-881"><a href="#cb6-881"></a><span class="co">&lt;!-- - **$\hat{\gamma}$**: The overall measure calculated from your formula represents the difference in treatment effects between two subgroups, $G=g$ and $G=g'$. It quantifies how the effect of switching between treatments $a$ and $a'$ differs across the two subgroups. --&gt;</span></span>
<span id="cb6-882"><a href="#cb6-882"></a></span>
<span id="cb6-883"><a href="#cb6-883"></a></span>
<span id="cb6-884"><a href="#cb6-884"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Considerations --&gt;</span></span>
<span id="cb6-885"><a href="#cb6-885"></a></span>
<span id="cb6-886"><a href="#cb6-886"></a><span class="co">&lt;!-- - **Estimation**: to estimate the expected outcomes $\hat{E}[Y^a \mid G]$ and $\hat{E}[Y^{a'} \mid G]$, we require statistical models. If we use regression, we include interaction terms between treatment and subgroup indicators to directly estimate subgroup-specific treatment effects. Our use depends on correct model specification. --&gt;</span></span>
<span id="cb6-887"><a href="#cb6-887"></a><span class="co">&lt;!-- - **Confidence intervals**: we may compute confidence intervals for $\hat{\gamma}$ using bootstrap, the delta method, or -- in our excercises -- simulation based methods. --&gt;</span></span>
<span id="cb6-888"><a href="#cb6-888"></a><span class="co">&lt;!-- - **Causal assumptions**: again, a causal interpretation of $\hat{\gamma}$ relies on satisfying both causal assumptions and modelling assumptions.  Here, we have described estimation using propensity scores. --&gt;</span></span>
<span id="cb6-889"><a href="#cb6-889"></a></span>
<span id="cb6-890"><a href="#cb6-890"></a></span>
<span id="cb6-891"><a href="#cb6-891"></a><span class="co">&lt;!-- ## Doubly Robust Estimation --&gt;</span></span>
<span id="cb6-892"><a href="#cb6-892"></a></span>
<span id="cb6-893"><a href="#cb6-893"></a><span class="co">&lt;!-- We can combine regression-based estimation with propensity score estimation to obtain *doubly robust* estimation. I will walk you through the steps in the lab. The TL;DR is this: doubly robust estimation reduces reliance on correct model specification. If either the PS model or the regression model is correctly specified, the model will be unbiased -- if the other causal inference assumptions are met. --&gt;</span></span>
<span id="cb6-894"><a href="#cb6-894"></a></span>
<span id="cb6-895"><a href="#cb6-895"></a><span class="co">&lt;!-- We cannot know whether these assumptions are met, we will need to do a sensitivity analysis, the topic of next week. --&gt;</span></span>
<span id="cb6-896"><a href="#cb6-896"></a></span>
<span id="cb6-897"><a href="#cb6-897"></a><span class="co">&lt;!-- I'll show you in lab how to employ simulation-based inference methods to compute standard errors and confidence intervals, following the approaches suggested by Greifer (2023)[]. --&gt;</span></span>
<span id="cb6-898"><a href="#cb6-898"></a></span>
<span id="cb6-899"><a href="#cb6-899"></a><span class="co">&lt;!-- ## Extra Readings n on Propensity Scores: --&gt;</span></span>
<span id="cb6-900"><a href="#cb6-900"></a></span>
<span id="cb6-901"><a href="#cb6-901"></a><span class="co">&lt;!-- Noah Griefer's Software and Blogs: [https://ngreifer.github.io/blog/subgroup-analysis-psm/](https://ngreifer.github.io/blog/) --&gt;</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>