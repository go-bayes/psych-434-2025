<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.5">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Joseph Bulbulia">
<meta name="dcterms.date" content="2025-03-25">

<title>Causal Inference: Average Treatment Effects – PSYC 434 Conducting Research Across Cultures: Trimester 1, 2025</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-cb64309e6bcb4fe4e8f7b1d812ed84fe.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-ebb6838dc08a669b2ff582ce1331d571.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css">

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">PSYC 434 Conducting Research Across Cultures: Trimester 1, 2025</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../content/course-outline.html"> 
<span class="menu-text">Course Outline</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-content" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Content</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-content">    
        <li>
    <a class="dropdown-item" href="../content/glossary.pdf">
 <span class="dropdown-text">Glossary</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/course-outline.html">
 <span class="dropdown-text">Course Outline</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/01-content.html">
 <span class="dropdown-text">Week 1: Course Introduction - R (installing packages)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/02-content.html">
 <span class="dropdown-text">Week 2: Causal Diagrams - Elementary Structures and Rules - R (using the interface)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/03-content.html">
 <span class="dropdown-text">Week 3: Causal Diagrams - Confounding Bias - R (regression/simulation)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/04-content.html">
 <span class="dropdown-text">Week 4: Causal Diagrams - Interaction, Measurement Bias, Selection Bias - R (regression/simulation)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/05-content.html">
 <span class="dropdown-text">Week 5: Causal Inference - Average Treatment Effects - R (regression/simulation: ATE)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/06-content.html">
 <span class="dropdown-text">Week 6: Conditional Average Treatment Effects (CATE) - R (regression/simulation: ATE)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/07-quiz.html">
 <span class="dropdown-text">Week 7: In Class Test</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/08-content.html">
 <span class="dropdown-text">Week 8: Causal Inference - Estimation of ATE and CATE - R and LaTeX</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/09-content.html">
 <span class="dropdown-text">Week 9: Hands On: A Full Study Analysis in R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/10-content.html">
 <span class="dropdown-text">Week 10: Hands On: Writing Up Your Analysis: Quarto Documents</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/11-content.html">
 <span class="dropdown-text">Week 11: Measurement: Factor Analysis, CFA, MultiGroup CFA, Partial Invariance/ And How These Approaches Fail</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../content/12-content.html">
 <span class="dropdown-text">Week 12: Student Presentations</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Causal Inference: Average Treatment Effects</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
                      </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-heading">Affiliation</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author">Joseph Bulbulia <a href="mailto:joseph.bulbulia@vuw.ac.nz" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> <a href="https://orcid.org/0000-0002-5861-2056" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              Victoria University of Wellington, New Zealand
            </p>
        </div>
    </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">March 25, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#seminar" id="toc-seminar" class="nav-link active" data-scroll-target="#seminar">Seminar</a>
  <ul class="collapse">
  <li><a href="#learning-outcomes" id="toc-learning-outcomes" class="nav-link" data-scroll-target="#learning-outcomes">Learning Outcomes</a></li>
  <li><a href="#opening" id="toc-opening" class="nav-link" data-scroll-target="#opening">Opening</a></li>
  <li><a href="#introduction-motivating-example" id="toc-introduction-motivating-example" class="nav-link" data-scroll-target="#introduction-motivating-example">Introduction: Motivating Example</a></li>
  <li><a href="#part-1-the-fundamental-problem-of-causal-inference-as-a-missing-data-problem" id="toc-part-1-the-fundamental-problem-of-causal-inference-as-a-missing-data-problem" class="nav-link" data-scroll-target="#part-1-the-fundamental-problem-of-causal-inference-as-a-missing-data-problem">Part 1: The Fundamental Problem of Causal Inference as a Missing Data Problem</a></li>
  <li><a href="#how-can-we-make-contrasts-between-counterfactual-potential-outcomes" id="toc-how-can-we-make-contrasts-between-counterfactual-potential-outcomes" class="nav-link" data-scroll-target="#how-can-we-make-contrasts-between-counterfactual-potential-outcomes">How can we make contrasts between counterfactual (potential) outcomes?</a>
  <ul class="collapse">
  <li><a href="#fundamental-assumption-1-causal-consistency" id="toc-fundamental-assumption-1-causal-consistency" class="nav-link" data-scroll-target="#fundamental-assumption-1-causal-consistency">Fundamental Assumption 1: Causal Consistency</a></li>
  <li><a href="#fundamental-assumption-2-exchangeability" id="toc-fundamental-assumption-2-exchangeability" class="nav-link" data-scroll-target="#fundamental-assumption-2-exchangeability">Fundamental Assumption 2: Exchangeability</a></li>
  <li><a href="#fundamental-assumption-3-positivity" id="toc-fundamental-assumption-3-positivity" class="nav-link" data-scroll-target="#fundamental-assumption-3-positivity">Fundamental Assumption 3: Positivity</a></li>
  </ul></li>
  <li><a href="#challenges-with-observational-data" id="toc-challenges-with-observational-data" class="nav-link" data-scroll-target="#challenges-with-observational-data">Challenges with Observational Data</a>
  <ul class="collapse">
  <li><a href="#satisfying-causal-consistency-is-difficult-in-observational-settings" id="toc-satisfying-causal-consistency-is-difficult-in-observational-settings" class="nav-link" data-scroll-target="#satisfying-causal-consistency-is-difficult-in-observational-settings">1. Satisfying Causal Consistency is Difficult in Observational Settings</a></li>
  <li><a href="#conditional-exchangeability-no-unmeasured-confounding-is-difficult-to-achieve" id="toc-conditional-exchangeability-no-unmeasured-confounding-is-difficult-to-achieve" class="nav-link" data-scroll-target="#conditional-exchangeability-no-unmeasured-confounding-is-difficult-to-achieve">2. Conditional Exchangeability (No Unmeasured Confounding) Is Difficult to Achieve</a></li>
  <li><a href="#the-positivity-assumption-may-fail-treatments-might-not-exist-for-all" id="toc-the-positivity-assumption-may-fail-treatments-might-not-exist-for-all" class="nav-link" data-scroll-target="#the-positivity-assumption-may-fail-treatments-might-not-exist-for-all">3. The Positivity Assumption May Fail: Treatments Might Not Exist for All</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#part-2-lab" id="toc-part-2-lab" class="nav-link" data-scroll-target="#part-2-lab">Part 2: Lab</a></li>
  <li><a href="#appendix-a" id="toc-appendix-a" class="nav-link" data-scroll-target="#appendix-a">Appendix A</a>
  <ul class="collapse">
  <li><a href="#packages" id="toc-packages" class="nav-link" data-scroll-target="#packages">Packages</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Required</strong> - <span class="citation" data-cites="hernan2024WHATIF">(<a href="#ref-hernan2024WHATIF" role="doc-biblioref">Hernan and Robins 2020</a>)</span> Chapters 1-3 <a href="https://www.dropbox.com/scl/fi/9hy6xw1g1o4yz94ip8cvd/hernanrobins_WhatIf_2jan24.pdf?rlkey=8eaw6lqhmes7ddepuriwk5xk9&amp;dl=0">link</a></p>
<p><strong>Optional</strong> - <span class="citation" data-cites="neal2020introduction">(<a href="#ref-neal2020introduction" role="doc-biblioref">Neal 2020</a>)</span> Chapter 1-2 <a href="https://www.dropbox.com/scl/fi/9hy6xw1g1o4yz94ip8cvd/hernanrobins_WhatIf_2jan24.pdf?rlkey=8eaw6lqhmes7ddepuriwk5xk9&amp;dl=0">link</a></p>
</div>
</div>
<div class="no-row-height column-margin column-container"><div id="ref-neal2020introduction" class="csl-entry" role="listitem">
Neal, Brady. 2020. <span>“Introduction to Causal Inference from a Machine Learning Perspective.”</span> <em>Course Lecture Notes (Draft)</em>. <a href="https://www.bradyneal.com/Introduction_to_Causal_Inference-Dec17_2020-Neal.pdf">https://www.bradyneal.com/Introduction_to_Causal_Inference-Dec17_2020-Neal.pdf</a>.
</div></div><div class="no-row-height column-margin column-container"><div id="ref-hernan2024WHATIF" class="csl-entry" role="listitem">
Hernan, M. A., and J. M. Robins. 2020. <em>Causal Inference: What If?</em> Chapman &amp; Hall/CRC Monographs on Statistics &amp; Applied Probab. Taylor &amp; Francis. <a href="https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/">https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/</a>.
</div></div><div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Key concepts for the test(s):
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><strong>The Fundamental Problem of Causal Inference</strong></li>
<li><strong>Causal Inference in Randomised Experiments</strong></li>
<li><strong>Causal Inference in Observational Studies - Average (Marginal) Treatment Effects</strong></li>
<li><strong>Three Fundamental Assumptions for Causal Inference</strong></li>
</ul>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
For the lab, copy and paste code chunks following the “LAB 6” section.
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>In these notes, we use the terms “counterfactual outcomes” and “potential outcomes” interchangeably.</p>
</div>
</div>
<section id="seminar" class="level1 page-columns page-full">
<h1>Seminar</h1>
<section id="learning-outcomes" class="level2">
<h2 class="anchored" data-anchor-id="learning-outcomes">Learning Outcomes</h2>
<ul>
<li>You will understand why causation is never directly observed.</li>
<li>You will understand how experiments address this “causal gap.”</li>
<li>You will understand how applying three principles from experimental research allows human scientists to close this “causal gap” when making inferences about a population as a whole — that is, inferences about “marginal effects.”</li>
</ul>
</section>
<section id="opening" class="level2">
<h2 class="anchored" data-anchor-id="opening">Opening</h2>
<div class="callout-quote">
<p><strong>Robert Frost writes:</strong></p>
<blockquote class="blockquote">
<p>Two roads diverged in a yellow wood,<br>
And sorry I could not travel both<br>
And be one traveler, long I stood<br>
And looked down one as far as I could<br>
To where it bent in the undergrowth;</p>
<p>Then took the other, as just as fair,<br>
And having perhaps the better claim,<br>
Because it was grassy and wanted wear;<br>
Though as for that the passing there<br>
Had worn them really about the same,</p>
<p>And both that morning equally lay<br>
In leaves no step had trodden black.<br>
Oh, I kept the first for another day!<br>
Yet knowing how way leads on to way,<br>
I doubted if I should ever come back.</p>
<p>I shall be telling this with a sigh<br>
Somewhere ages and ages hence:<br>
Two roads diverged in a wood, and I—<br>
I took the one less traveled by,<br>
And that has made all the difference.</p>
<p>– <em>The Road Not Taken</em></p>
</blockquote>
</div>
</section>
<section id="introduction-motivating-example" class="level2">
<h2 class="anchored" data-anchor-id="introduction-motivating-example">Introduction: Motivating Example</h2>
<p>Consider the following cross-cultural question:</p>
<blockquote class="blockquote">
<p>Does bilingualism improve cognitive abilities in children?</p>
</blockquote>
<p>There is evidence that bilingual children perform better at cognitive tasks, but is this improvement truly caused by learning more than one language, or is it confounded by other factors (e.g., cultural environment, parental influence)? How can we know? Each child might answer, like the traveller in Frost’s poem:</p>
<p><strong>“And sorry I could not travel both. And be one traveler <span class="math inline">\dots</span>”</strong></p>
</section>
<section id="part-1-the-fundamental-problem-of-causal-inference-as-a-missing-data-problem" class="level2">
<h2 class="anchored" data-anchor-id="part-1-the-fundamental-problem-of-causal-inference-as-a-missing-data-problem">Part 1: The Fundamental Problem of Causal Inference as a Missing Data Problem</h2>
<p><strong>The fundamental problem of causal inference</strong> is that causality is never directly observed.</p>
<p>Let <span class="math inline">Y</span> and <span class="math inline">A</span> denote random variables.</p>
<p>We formulate a causal question by asking whether experiencing a exposure <span class="math inline">A</span>, when this exposure is set to level <span class="math inline">A = a</span>, would lead to a difference in <span class="math inline">Y</span>, compared to what would have occurred had the exposure been set to a different level, say <span class="math inline">A=a'</span> will lead to a difference in outcome <span class="math inline">Y</span>. For simplicity, we imagine binary exposure such that <span class="math inline">A = 1</span> denotes receiving the “bilingual” exposure and <span class="math inline">A = 0</span> denotes receiving the “monolingual” exposure. Assume these are the only two exposures of interest:</p>
<p>Let:</p>
<ul>
<li><span class="math inline">Y_i(a = 1)</span> denote the cognitive ability of child <span class="math inline">i</span> if the child were bilingual (potential outcome when <span class="math inline">A_i = 1</span>).</li>
<li><span class="math inline">Y_i(a = 0)</span> denote the cognitive ability of child <span class="math inline">i</span> if the child were monolingual (potential outcome when <span class="math inline">A_i = 0</span>).</li>
</ul>
<p>What does it mean to <em>quantify</em> a causal effect. We may define the individual-level causal effect of bilingualism on cognitive ability for child <span class="math inline">i</span> as the difference between two states of the world: one for which the child experiences a bilingual exposure and the other for which the child does not. We write this contrast by referring to the potential outcomes under different levels of exposure:</p>
<p><span class="math display">
\text{Causal Effect}_i = Y_i(1) - Y_i(0).
</span></p>
<p>We say there is a causal effect of the bilingual exposure if</p>
<p><span class="math display">
Y_i(1) - Y_i(0) \neq 0.
</span></p>
<p>Because each child experiences only <strong>one</strong> exposure condition in reality, we cannot directly compute this difference from any dataset — the missing observation is called the <strong>counterfactual</strong>:</p>
<ul>
<li>If <span class="math inline">Y_i|A_i = 1</span> is observed, then <span class="math inline">Y_i(0)|A_i=1</span> is counterfactual.</li>
<li>If <span class="math inline">Y_i|A_i = 0</span> is observed, then <span class="math inline">Y_i(1)|A_i=1</span> is counterfactual.</li>
</ul>
<p><strong>“And sorry I could not travel both / And be one traveler, long I stood <span class="math inline">\dots</span>”</strong></p>
<p>In short, individuals cannot simultaneously experience both exposure conditions, so one outcome is inevitably missing.</p>
</section>
<section id="how-can-we-make-contrasts-between-counterfactual-potential-outcomes" class="level2">
<h2 class="anchored" data-anchor-id="how-can-we-make-contrasts-between-counterfactual-potential-outcomes">How can we make contrasts between counterfactual (potential) outcomes?</h2>
<section id="fundamental-assumption-1-causal-consistency" class="level3">
<h3 class="anchored" data-anchor-id="fundamental-assumption-1-causal-consistency">Fundamental Assumption 1: Causal Consistency</h3>
<p>Causal consistency means that the potential outcome corresponding to the exposure an individual actually receives is exactly what we observe. In other words, if individual <span class="math inline">i</span> receives exposure <span class="math inline">a</span>, then the <em>potential outcome</em> (or equivalently the <em>counterfactual outcome</em> under a given level of exposure <span class="math inline">A=a</span> – that is <span class="math inline">Y_i(a)</span> – is equivalent to the <em>the observed outcome</em>: <span class="math inline">Y_i \mid A_i \equiv a</span>. Where the symbol <span class="math inline">\equiv</span> means “equivalent to”, when we assume that the causal consistency assumption is satisfied, we assume that:</p>
<p><span class="math display">
\begin{aligned}
\underbrace{Y_i(1)}_{\text{counterfactual}} &amp;\equiv \underbrace{(Y_i \mid A_i = 1)}_{\text{observable}}, \\
\underbrace{Y_i(0)}_{\text{counterfactual}} &amp;\equiv \underbrace{(Y_i \mid A_i = 0)}_{\text{observable}}.
\end{aligned}
</span></p>
<p>Notice however that we cannot generally obtain individual causal effects because at any given time, each individual may only receive at most one leve of an exposure. Where the symbol <span class="math inline">\implies</span> means “implies,” at any given time, receiving one level of an exposure precludes receiving any other level of that exposure:</p>
<p><span class="math display">
Y_i|A_i = 1 \implies Y_i(0)|A_i = 1~ \text{is counterfactual}
</span> Likewise:</p>
<p><span class="math display">
Y_i|A_i = 0 \implies Y_i(1)|A_i = 1~ \text{is counterfactual}
</span></p>
<p>Because of the laws of physics (above the atomic scale), an individual can experience only one exposure level at any moment. Consequently, we can observe only one of the two counterfactual outcomes needed to quantify a causal effect. This is the fundamental problem of causal inference. Counterfactual contrasts cannot be individually observed.</p>
<p>However, because of the causal consistency assumption, we can nevertheless recover half of the missing counterfactual (or “potential”) outcomes needed to estimate average treatment effects. We may do this if two other assumptions are satisfied.</p>
</section>
<section id="fundamental-assumption-2-exchangeability" class="level3">
<h3 class="anchored" data-anchor-id="fundamental-assumption-2-exchangeability">Fundamental Assumption 2: Exchangeability</h3>
<p>Exchangeability justifies recovering unobserved counterfactuals from observed outcomes and averaging them. By accepting that <span class="math inline">Y_i(a) = Y_i</span> if <span class="math inline">A_i = a</span>, we can estimate population-level average potential outcomes. In an experiment where exposure groups are comparable, we define the Average Treatment Effect (ATE) as:</p>
<p><span class="math display">
\begin{aligned}
\text{ATE} &amp;= \mathbb{E}[Y(1)] - \mathbb{E}[Y(0)] \\
           &amp;= \mathbb{E}(Y \mid A=1) \;-\; \mathbb{E}(Y \mid A=0).
\end{aligned}
</span> Because randomisation ensures that missing counterfactuals are exchangeable with those observed, we can still estimate <span class="math inline">\mathbb{E}[Y(a)]</span>. For instance, assume:</p>
<p><span class="math display">
\underbrace{\mathbb{E}[Y(1)\mid A=1]}_{\text{counterfactual}}  = \textcolor{red}{\underbrace{\mathbb{E}[Y(1)\mid A=0]}_{\text{unobservable}}}  =  \underbrace{(Y_i \mid A_i = 1)}_{\text{observed}}
</span></p>
<p>which lets us infer the average outcome if everyone were treated. Likewise, if</p>
<p><span class="math display">
\underbrace{\mathbb{E}[Y(0)\mid A=0]}_{\text{counterfactual}}  = \textcolor{red}{\underbrace{\mathbb{E}[Y(1)\mid A=0]}_{\text{unobservable}}}  =  \underbrace{\mathbb{E}(Y \mid A_i = 0)}_{\text{observed}}
</span></p>
<p>then we can infer the average outcome if everyone were given the control. The difference between these two quantities gives the ATE:</p>
<p><span class="math display">
\text{ATE} = \Big[
\overbrace{\mathbb{E}[Y(1)\mid A=1]}^{\substack{\text{by consistency:}\\ \equiv \text{ observed } \; \mathbb{E}[Y\mid A=1]}}
\;+\;
\overbrace{\textcolor{red}{\mathbb{E}[Y(1)\mid A=0]}}^{\substack{\text{by exchangeability:}\\ \text{unobservable, yet } \; \equiv \mathbb{E}[Y\mid A=1]}}
\Big]
-\,
\Big[
\overbrace{\mathbb{E}[Y(0)\mid A=0]}^{\substack{\text{by consistency:}\\ \equiv  \text{observed } \; \mathbb{E}[Y\mid A=0]}}
\;+\;
\overbrace{\textcolor{red}{\mathbb{E}[Y(0)\mid A=1]}}^{\substack{\text{by exchangeability:}\\ \text{unobservable, yet } \; \equiv \mathbb{E}[Y\mid A=0]}}
\Big]
</span></p>
<p>We have it that <span class="math inline">\mathbb{E}[Y\mid A=1]</span> and <span class="math inline">\mathbb{E}[Y\mid A=0]</span> and <span class="math inline">\mathbb{E}[Y(1)\mid A=0]</span> are observed. If both consistency and exchangeability are satisifed then we may use these observed quantities to identify contrasts of counterfactual quanities.</p>
<p>Thus, although individual-level counterfactuals are missing, the consistency assumptions and the exchangeability assumptions allow us to identify the average effect of treatment using observed data. Randomised controlled experiments allow us to meet these assumptions. Randomisation warrents the exchangeability assumption. Control warrents the consistency asumption.</p>
</section>
<section id="fundamental-assumption-3-positivity" class="level3">
<h3 class="anchored" data-anchor-id="fundamental-assumption-3-positivity">Fundamental Assumption 3: Positivity</h3>
<p>There is one further assumption, called positivity. It states that treatment assignments cannot be deterministic. That is, for every covariate pattern <span class="math inline">L = l</span>, each individual has a non-zero probability of receiving ever treatment level to be compared:</p>
<p><span class="math display">
P(A = a \mid L = l) &gt; 0.
</span></p>
<p>Randomised experiments achieve positivity by design – at least for the sample that is selected into the study. In observational settings violations occur if some subgroups never receive a particular treatment. If treatments occur but are rare, we may have sufficient data from which to obtain convincing causal inferences.</p>
<p>Positivity is the only assumption that can be verified with data. We will consider how to assess this assumption using data when we develop our data analytic workflows in the second half of this course.</p>
</section>
</section>
<section id="challenges-with-observational-data" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="challenges-with-observational-data">Challenges with Observational Data</h2>
<section id="satisfying-causal-consistency-is-difficult-in-observational-settings" class="level3">
<h3 class="anchored" data-anchor-id="satisfying-causal-consistency-is-difficult-in-observational-settings">1. Satisfying Causal Consistency is Difficult in Observational Settings</h3>
<p>Below are some ways in which real-world complexities can violate causal consistency in observational studies. For example, causal consistency requires there is no interference between units (also called “SUTVA” or “Stable Unit Treatment Value.” Causal consistency also requires that each treatment level is well-defined and applied uniformly. If these conditions fail, then <span class="math inline">Y(a)</span> may not reflect a consistent exposures across individuals. We are then comparing apples with oranges. Consider some examples:</p>
<ol type="1">
<li><p><strong>Cultural differences</strong>: one group’s “second-language exposure” may differ qualitatively from another’s if cultural norms shape how, when, or by whom the second language is taught. For instance, a child in a bilingual community may receive diverse and immersive language experiences all of which are are coded as <span class="math inline">A=1</span>. Yet the treatments might be quite different. We might be comparing apples with oranges.</p></li>
<li><p><strong>Age of acquisition</strong>: the developmental effect of learning a second language may vary by when the child is exposed. Comparing aquisition at, say, age two with aquisition at say, age twelve, might be comparing apples with oranges.</p></li>
<li><p><strong>Language variation:</strong> sign languages, highly tonal languages, or unwritten languages may demand different cognitive tasks than spoken, nontonal, or widely documented languages. Thus, lumping them together as “learning a second language” can obscure the fact that these distinct exposures might produce fundamentally different outcomes. Again, comparisons here would be of apples with oranges.</p></li>
</ol>
<p>These sources of heterogeneity reveal why careful delineation of treatments is crucial. If the actual exposures differ across individuals, then consistency <span class="math inline">(Y_i(a) = Y_i \mid A_i = a)</span> may fail, because <span class="math inline">A=a</span> is not the same phenomenon for everyone.</p>
</section>
<section id="conditional-exchangeability-no-unmeasured-confounding-is-difficult-to-achieve" class="level3">
<h3 class="anchored" data-anchor-id="conditional-exchangeability-no-unmeasured-confounding-is-difficult-to-achieve">2. Conditional Exchangeability (No Unmeasured Confounding) Is Difficult to Achieve</h3>
<p>In theory, we can identify a causal effect from observational data if all confounders <span class="math inline">L</span> are measured. Formally, we need the potential outcomes to be independent of treatment once we condition on <span class="math inline">L</span>. One way to express this asssumption is: <span class="math inline">Y(a) \coprod A \mid L</span>. If the potential outcomes are independent of treatment assignment, we can identify the Average Treatment Effect (ATE) as: <span class="math display">
\text{ATE} \;=\; \sum_{l}
\Bigl[\mathbb{E}\bigl(Y \mid A=1, L=l\bigr) \;-\; \mathbb{E}\bigl(Y \mid A=0, L=l\bigr)\Bigr] \;\Pr(L=l).
</span></p>
<p>In randomised experiments, conditioning is automatic because <span class="math inline">A</span> is unrelated to potential outcomes by design. In observational studies, ensuring or approximating such <strong>conditional exchangeability</strong> is often difficult. For example, bilingualism research would need to consider:</p>
<ul>
<li><strong>Cultural histories</strong>: cultures that value language acquistion might also value knowledge acquistion. Associations might arise from Culture, not causation.</li>
<li><strong>Personal values</strong>: families who place a high priority on bilingualism may also promote other developmental resources.</li>
</ul>
<p>If important confounders go unmeasured or are poorly measured, these differences can bias causal effect estimates.</p>
</section>
<section id="the-positivity-assumption-may-fail-treatments-might-not-exist-for-all" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="the-positivity-assumption-may-fail-treatments-might-not-exist-for-all">3. The Positivity Assumption May Fail: Treatments Might Not Exist for All</h3>
<p>Positivity requires that each individual could, in principle, receive <em>any</em> exposure level. But in real-world observational settings, some groups have no access to bilingual education (or no reason to be monolingual), making certain treatment levels impossible for them. If a treatment level does not appear in the data for a given subgroup, any causal effect estimate for that subgroup is purely an extrapolation <span class="citation" data-cites="westreich2010 hernan2023">(<a href="#ref-westreich2010" role="doc-biblioref">Westreich and Cole 2010</a>; <a href="#ref-hernan2023" role="doc-biblioref">Hernan and Robins 2023</a>)</span>.</p>
<div class="no-row-height column-margin column-container"><div id="ref-westreich2010" class="csl-entry" role="listitem">
Westreich, Daniel, and Stephen R. Cole. 2010. <span>“Invited commentary: positivity in practice.”</span> <em>American Journal of Epidemiology</em> 171 (6). <a href="https://doi.org/10.1093/aje/kwp436">https://doi.org/10.1093/aje/kwp436</a>.
</div><div id="ref-hernan2023" class="csl-entry" role="listitem">
———. 2023. <em>Causal Inference</em>. Chapman &amp; Hall/CRC Monographs on Statistics &amp;Applied Probab. Taylor &amp; Francis. <a href="https://books.google.co.nz/books?id=\_KnHIAAACAAJ">https://books.google.co.nz/books?id=\_KnHIAAACAAJ</a>.
</div></div></section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>We introduced the fundamental problem of causal inference by distinguishing correlation (associations in the data) from causation (contrasts between potential outcomes, of which only one can be observed for each individual).</p>
<p><strong>Randomised experiments</strong> address this problem by balancing confounding variables across treatment levels. Although individual causal effects are unobservable, random assignment allows us to infer <strong>average</strong> causal effects — also called <em>marginal</em> effects.</p>
<p>In <strong>observational data</strong>, inferring average treatment effects demands that we satisfy three assumptions that are automatically satisfied in (well-conducted) experiments: <strong>causal consistency</strong>, <strong>exchangeability</strong>, and <strong>positivity</strong>. These assumptions ensure that we can compare like-with-like (that the population-level treatment effect is consistent across individuals), that there are no unmeasured common causes of the exposure and outcomes that may lead to associations in the absence of causality, and that every exposure level is a real possibility for each subgroup.</p>
<!-- # Seminar -->
<!-- ## Learning Outcomes -->
<!-- - You will understand why causation is never directly observed. -->
<!-- - You will understand how experiments address this "causal gap." -->
<!-- - You will understand how the application of three principles from experimental research allow human scientists to close this "causal gap" when making inferences about a population as whole -- that is, inferences about "marginal effects." -->
<!-- ## Opening  -->
<!-- Robert Frost writes,  -->
<!-- > Two roads diverged in a yellow wood, -->
<!-- And sorry I could not travel both -->
<!-- And be one traveler, long I stood -->
<!-- And looked down one as far as I could -->
<!-- To where it bent in the undergrowth; -->
<!-- >Then took the other, as just as fair, -->
<!-- And having perhaps the better claim, -->
<!-- Because it was grassy and wanted wear; -->
<!-- Though as for that the passing there -->
<!-- Had worn them really about the same, -->
<!-- >And both that morning equally lay -->
<!-- In leaves no step had trodden black. -->
<!-- Oh, I kept the first for another day! -->
<!-- Yet knowing how way leads on to way, -->
<!-- I doubted if I should ever come back. -->
<!-- >I shall be telling this with a sigh -->
<!-- Somewhere ages and ages hence: -->
<!-- Two roads diverged in a wood, and I— -->
<!-- I took the one less traveled by, -->
<!-- And that has made all the difference.  -->
<!-- -- The Road Not Taken -->
<!-- ## Introduction: Motivating Example -->
<!-- Consider the following cross-cultural question:  -->
<!-- > Does bilingualism improve cognitive abilities in children?  -->
<!-- There is evidence that bilingual children perform better oat cognitive tasks, but is learning more than one language a confounding factor?  -->
<!-- How can we know?  Each child might respond as the traveller in Frost's poem: -->
<!-- "And sorry I could not travel both. And be one traveller$\dots$" -->
<!-- ## Part 1: The Fundamental Problem of Causal Inference as a Missing Data Problem  -->
<!-- Humans think in images, words, and songs -- sometimes dance. However, a little mathematical notation helps to clarify the key concepts in causal inference. -->
<!-- To understand **the fundamental problem of causal inference,** we first define two potential outcomes for each individual in our study: -->
<!-- Let $Y$ and $A$ denote random variables.  -->
<!-- Mathematically, we formulate a causal question by asking whether assignment to treatment $A = a$ will lead to a difference to the outcome $Y$.   -->
<!-- Let $A = 1$ denote getting the "bilingual" treatment, and $A = 0$ denote getting the monolingual treatment. Assume these are the only two treatments of interest.  -->
<!-- - $Y_i(a = 1)$ The cognitive ability of child $i$ if they were bilingual. This is the counterfactual outcome when treatement $A = (a  =  1)$. -->
<!-- - $Y_i(a = 0)$:: The cognitive ability of child $i$ if they were monolingual. This is the counterfactual outcome when $A = (a = 0)$. -->
<!-- Using this notation, we may define a quantitative causal effect of bilingualism on cognitive ability for individual $i$ as the difference between these potential outcomes: -->
<!-- $$ -->
<!-- \text{Causal Effect}_i = Y_i(1) - Y_i(0) -->
<!-- $$ -->
<!-- We say there is a causal effect if:  -->
<!-- $$ -->
<!-- Y_i(1) - Y_i(0)  \neq 0 -->
<!-- $$ -->
<!-- Writing out our contrast of interest this way makes it clear that, because individuals experience only **one** treatment condition, we cannot compute this contrast directly from any data we may observe.  We call the missing observation "counterfactual." -->
<!-- $$ -->
<!-- Y_i|A_i = 1 \implies Y_i(0)|A_i = 1~ \text{is counterfactual} -->
<!-- $$ -->
<!-- Furthermore: -->
<!-- $$ -->
<!-- Y_i|A_i = 0 \implies Y_i(1)|A_i = 1~ \text{is counterfactual} -->
<!-- $$ -->
<!-- **And sorry I could not travel both And be one traveller, long I stood** $\dots$ -->
<!-- ## How can we make contrasts between counterfactual (potential) outcomes?  -->
<!-- ### Fundamental Assumption 1: Causal Consistency -->
<!-- We say that causal consistency holds if there is no heterogeneity in the treatments that would prevent us from assuming that the observed outcomes under treatments correspond to their potential outcomes. For an individual 'i', we must be able to assume: -->
<!-- $$ -->
<!-- \begin{aligned} -->
<!-- Y_{i}(1) &= (Y_{i}|A_{i} = 1) \quad \text{(Potential outcome if treated)} \\ -->
<!-- Y_{i}(0) &= (Y_{i}|A_{i} = 0) \quad \text{(Potential outcome if untreated)} -->
<!-- \end{aligned} -->
<!-- $$ -->
<!-- If this assumption holds, as well as the assumptions of conditional exchangeability and positivity, we can calculate the Average Treatment Effect (ATE) from observed data as: -->
<!-- $$ -->
<!-- \begin{aligned} -->
<!-- \text{ATE} &= \mathbb{E}[Y(1)] - \mathbb{E}[Y(0)] \\ -->
<!-- &= \mathbb{E}(Y|A=1) - \mathbb{E}(Y|A=0) -->
<!-- \end{aligned} -->
<!-- $$ -->
<!-- This contrast assumes that the potential outcome under treatment is observable when the treatment is administered, setting $Y_i(a)$ to $Y_i|A_i=a$.  -->
<!-- ### Fundamental Assumption 2: Exchangeability -->
<!-- We say that exchangability holds if the potential outcomes and treatment assignments are statistically independent, considering all measured confounders. This principle enables us to attribute observed group differences directly to the treatment. Randomisation provides *unconditional* exchangeability, simplifying the analytical process. -->
<!-- #### Fundamental Assumption 3: Positivity -->
<!-- We must assume that there is a non-zero probability of receiving each treatment level within covariate-defined subgroups. -->
<!-- $$ -->
<!-- P(A = a | L= l) > 0 -->
<!-- $$ -->
<!-- This assumption is also met by the *control* that experimentalists exert over randomised controlled experiments and is rarely stated explicitly. However, in observational settings, this condition must be verified to avoid extrapolating results beyond observed data.   -->
<!-- ### Average Treatment Effect in randomised controlled experiments work from assumptions -->
<!-- Consider inherently missing observations in an experiment: -->
<!-- ::: {#tbl-01} -->
<!-- $$ -->
<!-- \text{ATE} = \left[ \begin{aligned} -->
<!-- &\left( \underbrace{\mathbb{E}[Y(1)|A = 1]}_{\text{observed}} + \textcolor{red}{\underbrace{\mathbb{E}[Y(1)|A = 0]}_{\text{unobserved}}} \right) \\ -->
<!-- &- \left( \underbrace{\mathbb{E}[Y(0)|A = 0]}_{\text{observed}} + \textcolor{red}{\underbrace{\mathbb{E}[Y(0)|A = 1]}_{\text{unobserved}}} \right) -->
<!-- \end{aligned} \right] -->
<!-- $$ -->
<!-- :::  -->
<!-- In @tbl-01, the expression, $\mathbb{E}[Y(1)|A = 1]$ represents the average outcome when the treatment is given, which is observable. However, $\mathbb{E}[Y(1)|A = 0]$ represents the average outcome if the treatment had been given to those who were untreated, which remains unobservable. Similarly, the quantity $\mathbb{E}[Y(0)|A = 1]$ also remains unobservable.  Note that the problem isn't merely one of statistical analysis on the data. **The problem is that the relevant data to identify individual causal effects are missing.** Thus, it is evident that the fundamental problem of causal inference is an ever-present concern even in experiments! -->
<!-- All the data we require for causal inferences at the individual level are missing, Nevertheless, because the treatments have been randomised, the data we observe from randomised controlled experiments can allow us to infer what would happen, **on average** if the treatment were applied to the population from which the participants were sampled.  -->
<!-- We call this causal affect the "Average Treatment Effect" or equivalently, the "Marginal Effect of the Treatment."  -->
<!-- ### Challenges with Observational data -->
<!-- #### 1. Causal Consistency is Challenging with Observational Data: "Treatments" are not adminsitered in a controlled way -->
<!-- The standardisation of treatments in randomised controlled experiments generally ensures the validity of the causal consistency assumption, which is seldom disputed. However, in observational settings, we cannot typically control the treatments that people receive. This fact imposes considerable challenges for satisfying this assumption. For example: -->
<!-- - **Cultures**: the language one starts with, and the language one learns next, and the order of learning, may affect cognitive development. -->
<!-- - **Parents**: the way in which one learns languages, either at schools or at home environments, may affect cognitive development. -->
<!-- - **Language**: language impose different demands, consider the demands of a sign language (body-brain), a highly tonal language, the demands of different writing systems, the cognitive demands that arise in cultures with no written scripts...   -->
<!-- Put another ways, causal inference does not merely require *randomisation*, it also requires *control*.  -->
<!-- #### 2. Conditional Exchangeability (No Unmeasured Confounding) with Observational Data -->
<!-- Under stronger assumptions, we may sometimes infer causal effects from associations in data, even if the treatment variable $A$ has not been randomised.  -->
<!-- $$ -->
<!-- \text{ATE} = \sum_{l} \large( \mathbb{E}[Y|A=1, \textcolor{blue}{L=l}] - \mathbb{E}[Y|A=0, \textcolor{blue}{L=l}] \large) \times \textcolor{blue}{\Pr(L=l)} -->
<!-- $$ -->
<!-- Where $L$ denotes a set of measured covariates, we can express this principle of "no confounding" mathematically in two complementary ways. Recall our notation: $A \coprod B$ signifies that $A$ is independent of $B$, and vice versa: -->
<!-- 1. **Potential Outcomes Independent of Treatment (given L):** $Y(a) \coprod A \mid L$ -->
<!-- 2. **Treatment Assignment Independent of Potential Outcomes (given L):** $A \coprod Y(a) \mid L$ -->
<!-- These formulations are crucial when working with causal diagrams, which visually encode these principles. The key idea is straightforward: ensuring a balance of confounders across treatment groups is fundamental to experimental and observational causal inference strategies.  -->
<!-- With sufficiently large numbers of individuals, **randomisation facilitates this balance, achieving $A \coprod Y(a)$*** -->
<!-- The challenge in achieving conditional exchangability is challenging in observational studies. This condition requires the groups being compared to be similar in every aspect except for the treatment. Consider bilingualism. In real-world data, individuals with access to green spaces may differ from those without access in several ways: -->
<!-- - **Socioeconomic status**: the economic capacity of individuals often determines their opportunities for education and language learning, thereby affecting cognitive development. -->
<!-- - **Age demographics**: language development is not even throughout childhood; when one learns a second language may make a difference. -->
<!-- - **Lifestyle choices**: Children who learn different language  -->
<!-- - **Personal values and social connections**: environmental values and community ties may influence both the choice of residence and the utilisation of green spaces. -->
<!-- These and other unmeasured factors can introduce biases, complicating the interpretation of causal relationships in observational studies. -->
<!-- ##### 3. The Positivity Assumption is challenging with observational data: The Relevant Treatments Do Not Exist in The Data -->
<!-- Positivity demands that each individual has the possibility of experiencing *every* level of the treatment to be compared. However, real-world constraints, such as the availability of bilingualism within different cultural settings, may preclude some groups from accessing bilinual learning. Where the treatments of interest are absent or scarcely represented in our dataset, the resulting causal inferences will lack empirical support. Consequently, any coefficients derived will represent extrapolations from statistical models, challenging the validity of our causal inferences [@westreich2010; @hernan2023]. -->
<!-- ### Summary  -->
<!-- We described the fundamental problem of causal inference, focusing on the critical distinction between correlation -- associations in the data, and causation -- the contrast between potential outcomes only one of which, at most, can be observed. We discussed how controlled experiments facilitate the estimation of average treatment effects (ATE) by systematically manipulating the variable of interest, allowing for the distribution of variables that might affect the outcome to be balanced across the treatment conditions. Our discussion then shifted to observational data, emphasising the challenges inherent in extracting causal relationships from data without the benefit of controlled interventions. We underscored the need to satisfy three key assumptions —- conditional exchangeability, causal consistency, and positivity—for inferring average treatment effects from observational data. These assumptions ensure that the treatment groups are comparable, the treatment effect is consistent across the population, and every individual has a non-zero probability of receiving each treatment level, respectively.  -->
<!-- **A note on causal diagrams**: we have seen that causal diagrams are graphical tools offer a systematic approach to identifying and controlling for confounding variables -- for helping to understand the conditions in which the assumption of "no unmeasured confounding" or equivalently  of "balance in the confounders across treatments" may be satisfied. Causal diagrams, however, do not obviate the need for these assumptions; instead, they provide a framework for evaluating whether and how the first of the three assumptions -- conditional exchangeability -- may be satisfied in a given study. -->
</section>
<section id="part-2-lab" class="level2">
<h2 class="anchored" data-anchor-id="part-2-lab">Part 2: Lab</h2>
<section id="focus" class="level4">
<h4 class="anchored" data-anchor-id="focus">Focus</h4>
<ul>
<li>Application of regression and simulation in R for ATE estimation</li>
</ul>
</section>
<section id="setting-up-your-r-script." class="level4">
<h4 class="anchored" data-anchor-id="setting-up-your-r-script.">Setting up your r script.</h4>
<p>First, reinstall the <code>margot</code> package: https://go-bayes.github.io/margot/</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># functions explained here: https://go-bayes.github.io/margot/</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># installation</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(devtools, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"devtools"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(devtools)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># reinstall the `margot` packagewith updates</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># devtools::install_github("go-bayes/margot", quietly = TRUE)</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># call package</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"margot"</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"tidyverse"</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"parameters"</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"skimr"</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"haven"</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"stdReg"</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'mice'</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"clarify"</span>)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co"># uncomment and check simulated data</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co"># head(df_nz)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="download-a-copy-of-the-data-directory-from-the-nzavs-osf-website" class="level4">
<h4 class="anchored" data-anchor-id="download-a-copy-of-the-data-directory-from-the-nzavs-osf-website">Download a copy of the data directory from the NZAVS OSF website</h4>
<p>Find it the data directory here: https://osf.io/75snb/</p>
<p>The variables in the simulated data <code>df_nz</code> correspond to a subset of the variables in this directory.</p>
</section>
<section id="check-n" class="level4">
<h4 class="anchored" data-anchor-id="check-n">Check N</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check total n in data</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># total nzavs participants</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>n_total <span class="ot">&lt;-</span> skimr<span class="sc">::</span><span class="fu">n_unique</span>(df_nz<span class="sc">$</span>id)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(n_total)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 20000</code></pre>
</div>
</div>
</section>
<section id="get-data-into-shape-for-analysis" class="level4">
<h4 class="anchored" data-anchor-id="get-data-into-shape-for-analysis">Get data into shape for analysis</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="do">#### Data wrangling: select columns and transpose the data from long to wide</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># filter the original dataset for these IDs three waves</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>df_nz <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(df_nz)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>df_nz <span class="ot">&lt;-</span> haven<span class="sc">::</span><span class="fu">zap_formats</span>(df_nz)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>df_nz <span class="ot">&lt;-</span> haven<span class="sc">::</span><span class="fu">zap_label</span>(df_nz)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>df_nz <span class="ot">&lt;-</span> haven<span class="sc">::</span><span class="fu">zap_widths</span>(df_nz)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>name_exposure <span class="ot">&lt;-</span>  <span class="st">"perfectionism"</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain ids for individuals who participated in 2018 and have no missing baseline exposure</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>ids_2018 <span class="ot">&lt;-</span> df_nz <span class="sc">%&gt;%</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>   dplyr<span class="sc">::</span><span class="fu">filter</span>(year_measured <span class="sc">==</span> <span class="dv">1</span>, wave <span class="sc">==</span> <span class="dv">2018</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>   dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_exposure))) <span class="sc">|&gt;</span> <span class="co"># criteria, no missing</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(id)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain ids for individuals who participated in 2019</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>ids_2019 <span class="ot">&lt;-</span> df_nz <span class="sc">%&gt;%</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>   dplyr<span class="sc">::</span><span class="fu">filter</span>(year_measured <span class="sc">==</span> <span class="dv">1</span>, wave <span class="sc">==</span> <span class="dv">2019</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>   dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_exposure))) <span class="sc">|&gt;</span> <span class="co"># criteria, no missing</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(id)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="co"># intersect IDs from 2018 and 2019 to ensure participation in both years</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>ids_2018_2019 <span class="ot">&lt;-</span> <span class="fu">intersect</span>(ids_2018, ids_2019)</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="co"># data wrangling</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>dat_long <span class="ot">&lt;-</span> df_nz <span class="sc">|&gt;</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(id <span class="sc">%in%</span> ids_2018_2019 <span class="sc">&amp;</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>                  wave <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2018</span>, <span class="dv">2019</span>, <span class="dv">2020</span>)) <span class="sc">|&gt;</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id, wave) <span class="sc">|&gt;</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">"id"</span>,</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"wave"</span>,</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"year_measured"</span>,</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"age"</span>,</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">"male"</span>,</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">"born_nz"</span>,</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">"eth_cat"</span>,</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">#factor(EthCat, labels = c("Euro", "Maori", "Pacific", "Asian")),</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">"employed"</span>,</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Are you currently employed? (this includes self-employment or casual work)</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">"edu"</span>,</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">"kessler6_sum"</span>,</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># "gen_cohort",</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">"household_inc"</span>,</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">"partner"</span>,</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 0 = no, 1 = yes</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>    <span class="st">"parent"</span>,</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 0 = no, 1 = yes</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">"political_conservative"</span>,</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hours_exercise"</span>,</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">"agreeableness"</span>,</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mini-IPIP6 Agreeableness (also modelled as empathy facet)</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sympathize with others' feelings.</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Am not interested in other people's problems.</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Feel others' emotions.</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Am not really interested in others.</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">"conscientiousness"</span>,</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># see mini ipip6</span></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get chores done right away.</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Like order.</span></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make a mess of things.</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Often forget to put things back in their proper place.</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>    <span class="st">"extraversion"</span>,</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mini-IPIP6 Extraversion</span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Am the life of the party.</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Don't talk a lot.</span></span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keep in the background.</span></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Talk to a lot of different people at parties.</span></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>    <span class="st">"honesty_humility"</span>,</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># see mini ipip6</span></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Would like to be seen driving around in a very expensive car.</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Would get a lot of pleasure from owning expensive luxury goods.</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Feel entitled to more of everything.</span></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Deserve more things in life.</span></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>    <span class="st">"openness"</span>,</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># see mini ipip6</span></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Have a vivid imagination.</span></span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Have difficulty understanding abstract ideas.</span></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Do not have a good imagination.</span></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Am not interested in abstract ideas.</span></span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>    <span class="st">"neuroticism"</span>,</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>    <span class="co"># see mini ipip6</span></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Have frequent mood swings.</span></span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Am relaxed most of the time.</span></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get upset easily.</span></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Seldom feel blue.</span></span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>    <span class="st">"modesty"</span>,</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # see mini ipip6</span></span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # I want people to know that I am an important person of high status,</span></span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # I am an ordinary person who is no better than others.</span></span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # I wouldn’t want people to treat me as though I were superior to them.</span></span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # I think that I am entitled to more respect than the average person is</span></span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>    <span class="co">#"w_gend_age_ethnic",</span></span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sample_weights"</span>,</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>    <span class="st">"neighbourhood_community"</span>,</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># #I feel a sense of community with others in my local neighbourhood.</span></span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>    <span class="st">"belong"</span>,</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rural_gch_2018_l"</span>,</span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>    <span class="st">"support"</span>,</span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>    <span class="co"># "support_help",</span></span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # 'There are people I can depend on to help me if I really need it.</span></span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>    <span class="co"># "support_turnto",</span></span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # There is no one I can turn to for guidance in times of stress.</span></span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># "support_rnoguidance",</span></span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>    <span class="co">#There is no one I can turn to for guidance in times of stress.</span></span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a>    <span class="st">"perfectionism"</span>,</span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>    <span class="st">"kessler6_sum"</span></span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>    <span class="co">#initialize 'censored'</span></span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a>    <span class="at">censored =</span> <span class="fu">ifelse</span>(<span class="fu">lead</span>(year_measured) <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a>    <span class="co"># modify 'censored' based on the condition; no need to check for NA here as 'censored' is already defined in the previous step</span></span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a>    <span class="at">censored =</span>  <span class="fu">ifelse</span>(<span class="fu">is.na</span>(censored) <span class="sc">&amp;</span></span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a>                         year_measured <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, censored)</span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # Apply the case_when condition for setting 'censored' based on 'wave' and the dynamic column specified by 'nzavs_exposure'</span></span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># censored = case_when(</span></span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   # Add this condition to keep previous modifications unless the specific condition is met!is.na(censored) ~ censored,</span></span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   # Then check if 'wave' is 2019 and the specified exposure is NA, adjusting the condition to reflect the accurate logic</span></span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   wave == 2019 &amp; !is.na(!!sym(nzavs_exposure)) ~ 1,</span></span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   # Default case if none of the above apply; might not be necessary if all possibilities are covered</span></span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   TRUE ~ 0</span></span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a>    <span class="co"># )</span></span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>year_measured) <span class="sc">|&gt;</span></span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a>    <span class="at">household_inc_log =</span> <span class="fu">log</span>(household_inc <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a>    <span class="at">hours_exercise_log =</span> <span class="fu">log</span>(hours_exercise <span class="sc">+</span> <span class="dv">1</span>)  ) <span class="sc">|&gt;</span></span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span><span class="fu">c</span>(</span>
<span id="cb4-138"><a href="#cb4-138" aria-hidden="true" tabindex="-1"></a>      household_inc,</span>
<span id="cb4-139"><a href="#cb4-139" aria-hidden="true" tabindex="-1"></a>      hours_exercise</span>
<span id="cb4-140"><a href="#cb4-140" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-141"><a href="#cb4-141" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb4-142"><a href="#cb4-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">droplevels</span>() <span class="sc">|&gt;</span></span>
<span id="cb4-143"><a href="#cb4-143" aria-hidden="true" tabindex="-1"></a>  <span class="co"># dplyr::rename(sample_weights = w_gend_age_ethnic,</span></span>
<span id="cb4-144"><a href="#cb4-144" aria-hidden="true" tabindex="-1"></a>  <span class="co">#               sample_origin =  sample_origin_names_combined) |&gt;</span></span>
<span id="cb4-145"><a href="#cb4-145" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id, wave) <span class="sc">|&gt;</span></span>
<span id="cb4-146"><a href="#cb4-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">droplevels</span>() <span class="sc">|&gt;</span></span>
<span id="cb4-147"><a href="#cb4-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb4-148"><a href="#cb4-148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">droplevels</span>() <span class="sc">|&gt;</span></span>
<span id="cb4-149"><a href="#cb4-149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id, wave) <span class="sc">|&gt;</span></span>
<span id="cb4-150"><a href="#cb4-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb4-151"><a href="#cb4-151" aria-hidden="true" tabindex="-1"></a>  <span class="at">rural_gch_2018_l =</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(rural_gch_2018_l)),</span>
<span id="cb4-152"><a href="#cb4-152" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   parent = as.numeric(as.character(parent)),</span></span>
<span id="cb4-153"><a href="#cb4-153" aria-hidden="true" tabindex="-1"></a>  <span class="at">partner =</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(partner)),</span>
<span id="cb4-154"><a href="#cb4-154" aria-hidden="true" tabindex="-1"></a>  <span class="at">born_nz =</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(born_nz)),</span>
<span id="cb4-155"><a href="#cb4-155" aria-hidden="true" tabindex="-1"></a>  <span class="at">censored =</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(censored)),</span>
<span id="cb4-156"><a href="#cb4-156" aria-hidden="true" tabindex="-1"></a>  <span class="at">employed =</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(employed))</span>
<span id="cb4-157"><a href="#cb4-157" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb4-158"><a href="#cb4-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">droplevels</span>() <span class="sc">|&gt;</span></span>
<span id="cb4-159"><a href="#cb4-159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id, wave) <span class="sc">|&gt;</span></span>
<span id="cb4-160"><a href="#cb4-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>()</span>
<span id="cb4-161"><a href="#cb4-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-162"><a href="#cb4-162" aria-hidden="true" tabindex="-1"></a><span class="co"># check n in this sample</span></span>
<span id="cb4-163"><a href="#cb4-163" aria-hidden="true" tabindex="-1"></a>skimr<span class="sc">::</span><span class="fu">n_unique</span>(dat_long<span class="sc">$</span>id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 14439</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#check</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">#head(dat_long)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="convert-data-from-long-to-wide-and-impute-baseline-values" class="level4">
<h4 class="anchored" data-anchor-id="convert-data-from-long-to-wide-and-impute-baseline-values">Convert data from long to wide and impute baseline values</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># baseline variables</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>baseline_vars <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"male"</span>, <span class="st">"edu"</span>, <span class="st">"partner"</span>, <span class="st">"employed"</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>exposure_var <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"perfectionism"</span>, <span class="st">"censored"</span>) <span class="co"># we will use the censored variable later</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>outcome_vars <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"kessler6_sum"</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># function will add exposure and outcome to baseline</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>dat_long_wide <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_wide_impute_baseline</span>(dat_long, <span class="at">baseline_vars =</span> baseline_vars, <span class="at">exposure_var =</span> exposure_var, <span class="at">outcome_vars =</span>outcome_vars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 iter imp variable
  1   1  t0_employed  t0_edu  t0_kessler6_sum  t0_partner
  2   1  t0_employed  t0_edu  t0_kessler6_sum  t0_partner
  3   1  t0_employed  t0_edu  t0_kessler6_sum  t0_partner
  4   1  t0_employed  t0_edu  t0_kessler6_sum  t0_partner
  5   1  t0_employed  t0_edu  t0_kessler6_sum  t0_partner</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dat_long_wide)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  id   t0_age t0_male t0_edu t0_partner t0_employed t0_perfectionism
1  1 40.31341       1      8          1           1         4.303349
2  3 47.14449       1      3          1           0         2.660515
3  4 74.60987       0      6          1           0         4.297503
4  5 57.46461       0      6          1           1         4.046052
5  6 50.32225       0      7          1           0         4.030903
6  8 53.36900       1      6          1           1         1.967654
  t0_censored t0_kessler6_sum t1_perfectionism t1_censored t2_kessler6_sum
1           1        3.044502         3.670650           1        5.005375
2           1        2.962828         3.333177           0              NA
3           1        1.006293         4.350912           1        3.972263
4           1        1.986856         2.045632           1        2.038406
5           1        6.018567         4.350877           1        4.978472
6           1        2.987620         2.991798           1        2.029845</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># standardise vars</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> dat_long_wide <span class="sc">|&gt;</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">t0_age_z =</span> <span class="fu">scale</span>(t0_age),</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">t0_edu_z =</span> <span class="fu">scale</span>(t0_edu),</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">t0_kessler6_sum_z =</span>  <span class="fu">scale</span>(t0_kessler6_sum),</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">t0_perfectionism_z =</span> <span class="fu">scale</span>(t0_perfectionism),</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">t1_perfectionism_z =</span> <span class="fu">scale</span>(t1_perfectionism),</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">t2_kessler6_sum_z =</span> <span class="fu">scale</span>(t2_kessler6_sum)) <span class="sc">|&gt;</span> </span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>()</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co"># we are not handling missing data well, and this will throw bugs down stream</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co"># to avoid this problem we remove attributes</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>dt<span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">remove_numeric_attributes</span>(dt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="use-regression-to-obtain-conditional-average-treatment-effect" class="level4">
<h4 class="anchored" data-anchor-id="use-regression-to-obtain-conditional-average-treatment-effect">Use regression to obtain <em>conditional average treatment</em> effect</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># note that we are not handling missing data appropriately here</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># take interaction of treatment and baseline vars</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>fit_1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(t2_kessler6_sum_z  <span class="sc">~</span> t1_perfectionism_z <span class="sc">*</span> (t0_age_z <span class="sc">+</span>  t0_edu_z <span class="sc">+</span> t0_kessler6_sum_z <span class="sc">+</span> t0_perfectionism_z), <span class="at">data =</span> dt)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># summarise</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>regression_table  <span class="ot">&lt;-</span> parameters<span class="sc">::</span><span class="fu">model_parameters</span>(fit_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This regression coefficient has a <em>causal</em> interpretation (it is the ate, at the value when all variables in the model are set to zero)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>regression_table[<span class="dv">2</span>, ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Parameter          | Coefficient |       SE |       95% CI | t(11539) |      p
------------------------------------------------------------------------------
t1 perfectionism z |        0.22 | 9.37e-03 | [0.20, 0.24] |    23.50 | &lt; .001</code></pre>
</div>
</div>
</section>
<section id="average-treatment-effect" class="level4">
<h4 class="anchored" data-anchor-id="average-treatment-effect">Average Treatment Effect</h4>
<p>First we’ll use the <code>stdReg</code> package:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fit the ate</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>fit_ate <span class="ot">&lt;-</span> stdReg<span class="sc">::</span><span class="fu">stdGlm</span>(fit_1,<span class="at">data =</span> dt, <span class="at">X =</span> <span class="st">"t1_perfectionism_z"</span>, <span class="at">x=</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">summary</span>(fit_ate))</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co"># summarise the ate</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>ate_stdreg_method <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit_ate,  <span class="at">contrast =</span> <span class="st">"difference"</span>,  <span class="at">reference =</span> <span class="dv">0</span>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>( ate_stdreg_method )</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co"># graph ate using stdReg method</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ate_stdreg_method)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="obtain-ate-by-hand-using-g-computation" class="level5">
<h5 class="anchored" data-anchor-id="obtain-ate-by-hand-using-g-computation">Obtain ATE by hand using g-computation</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># recall our fit</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>fit_1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(t2_kessler6_sum_z <span class="sc">~</span> t1_perfectionism_z <span class="sc">+</span> t0_age_z <span class="sc">+</span> t0_edu_z <span class="sc">+</span> t0_kessler6_sum_z <span class="sc">+</span> t0_perfectionism_z, <span class="at">data =</span> dt, <span class="at">family =</span> <span class="fu">gaussian</span>())</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co"># step 2: create a new dataset where everyone receives the treatment</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>dt_treated <span class="ot">&lt;-</span> dt</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>dt_treated<span class="sc">$</span>t1_perfectionism_z <span class="ot">&lt;-</span> <span class="fu">mean</span>(dt<span class="sc">$</span>t1_perfectionism_z)  <span class="co"># setting treatment to the mean can be adjusted as needed</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co"># step 3: predict outcomes under the treatment scenario</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>dt_treated<span class="sc">$</span>predicted_outcome <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_1, <span class="at">newdata =</span> dt_treated, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co"># step 4: calculate the mean outcome under this treatment scenario</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>mean_outcome_treated <span class="ot">&lt;-</span> <span class="fu">mean</span>(dt_treated<span class="sc">$</span>predicted_outcome)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co"># repeat Steps 2-4 for control or another treatment level</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>dt_control <span class="ot">&lt;-</span> dt</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>dt_control<span class="sc">$</span>t1_perfectionism_z <span class="ot">&lt;-</span> <span class="dv">1</span>  <span class="co"># one sd increase in perfectionism</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>dt_control<span class="sc">$</span>predicted_outcome <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_1, <span class="at">newdata =</span> dt_control, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>mean_outcome_control <span class="ot">&lt;-</span> <span class="fu">mean</span>(dt_control<span class="sc">$</span>predicted_outcome)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="co"># step 5: calculate the average treatment effect</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>ate_gcomp <span class="ot">&lt;-</span> <span class="fu">round</span>( mean_outcome_treated <span class="sc">-</span> mean_outcome_control, <span class="dv">2</span>)</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Average Treatment Effect (ATE) of t1_perfectionism_z using g-computation: "</span>, ate_gcomp))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Average Treatment Effect (ATE) of t1_perfectionism_z using g-computation:  -0.22"</code></pre>
</div>
</div>
</section>
<section id="next-obtain-the-ate-and-standard-errors-by-simulation-using-clarify" class="level5">
<h5 class="anchored" data-anchor-id="next-obtain-the-ate-and-standard-errors-by-simulation-using-clarify">Next obtain the ATE and standard errors by simulation using <code>clarify</code></h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"clarify"</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># setup simulation with clarify to manipulate the treatment variable and predict outcomes</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>sim_coefs <span class="ot">&lt;-</span> <span class="fu">sim</span>(fit_1)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co"># compute ate</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>sim_est <span class="ot">&lt;-</span> <span class="fu">sim_ame</span>(sim_coefs, <span class="at">contrast =</span> <span class="st">"diff"</span>, <span class="at">var =</span>  <span class="st">"t1_perfectionism_z"</span>)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co"># summarise</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(sim_est)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                            Estimate 2.5 % 97.5 %
E[dY/d(t1_perfectionism_z)]    0.223 0.204  0.241</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="appendix-a" class="level2">
<h2 class="anchored" data-anchor-id="appendix-a">Appendix A</h2>
<p>Consider that in the causal inference literature, we may write this contrast two potential outcomes under treatment as:</p>
<p><span class="math display">
\text{Causal Effect}_i = Y_i^{a=1} - Y_i^{a=0}
</span></p>
<p>or</p>
<p><span class="math display">
\text{Causal Effect}_i = Y_i^{1} - Y_i^{0}
</span></p>
<p>or:</p>
<p><span class="math display">
\text{Causal Effect}_i = Y_{1} - Y_0
</span> Where subscripts are dropped. You will soon encounter that many</p>
<section id="packages" class="level3">
<h3 class="anchored" data-anchor-id="packages">Packages</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>report<span class="sc">::</span><span class="fu">cite_packages</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  - Bulbulia J (2024). _margot: MARGinal Observational Treatment-effects_. doi:10.5281/zenodo.10907724 &lt;https://doi.org/10.5281/zenodo.10907724&gt;, R package version 0.3.3.1 Functions to obtain MARGinal Observational Treatment-effects from observational data., &lt;https://go-bayes.github.io/margot/&gt;.
  - Chang W (2023). _extrafont: Tools for Using Fonts_. R package version 0.19, &lt;https://CRAN.R-project.org/package=extrafont&gt;.
  - Greifer N, Worthington S, Iacus S, King G (2024). _clarify: Simulation-Based Inference for Regression Models_. R package version 0.2.1, &lt;https://CRAN.R-project.org/package=clarify&gt;.
  - Grolemund G, Wickham H (2011). "Dates and Times Made Easy with lubridate." _Journal of Statistical Software_, *40*(3), 1-25. &lt;https://www.jstatsoft.org/v40/i03/&gt;.
  - Lüdecke D, Ben-Shachar M, Patil I, Makowski D (2020). "Extracting, Computing and Exploring the Parameters of Statistical Models using R." _Journal of Open Source Software_, *5*(53), 2445. doi:10.21105/joss.02445 &lt;https://doi.org/10.21105/joss.02445&gt;.
  - Müller K, Wickham H (2023). _tibble: Simple Data Frames_. R package version 3.2.1, &lt;https://CRAN.R-project.org/package=tibble&gt;.
  - R Core Team (2024). _R: A Language and Environment for Statistical Computing_. R Foundation for Statistical Computing, Vienna, Austria. &lt;https://www.R-project.org/&gt;.
  - Sjolander A, Dahlqwist E (2021). _stdReg: Regression Standardization_. R package version 3.4.1, &lt;https://CRAN.R-project.org/package=stdReg&gt;.
  - van Buuren S, Groothuis-Oudshoorn K (2011). "mice: Multivariate Imputation by Chained Equations in R." _Journal of Statistical Software_, *45*(3), 1-67. doi:10.18637/jss.v045.i03 &lt;https://doi.org/10.18637/jss.v045.i03&gt;.
  - Waring E, Quinn M, McNamara A, Arino de la Rubia E, Zhu H, Ellis S (2022). _skimr: Compact and Flexible Summaries of Data_. R package version 2.1.5, &lt;https://CRAN.R-project.org/package=skimr&gt;.
  - Wickham H (2016). _ggplot2: Elegant Graphics for Data Analysis_. Springer-Verlag New York. ISBN 978-3-319-24277-4, &lt;https://ggplot2.tidyverse.org&gt;.
  - Wickham H (2023). _forcats: Tools for Working with Categorical Variables (Factors)_. R package version 1.0.0, &lt;https://CRAN.R-project.org/package=forcats&gt;.
  - Wickham H (2023). _stringr: Simple, Consistent Wrappers for Common String Operations_. R package version 1.5.1, &lt;https://CRAN.R-project.org/package=stringr&gt;.
  - Wickham H, Averick M, Bryan J, Chang W, McGowan LD, François R, Grolemund G, Hayes A, Henry L, Hester J, Kuhn M, Pedersen TL, Miller E, Bache SM, Müller K, Ooms J, Robinson D, Seidel DP, Spinu V, Takahashi K, Vaughan D, Wilke C, Woo K, Yutani H (2019). "Welcome to the tidyverse." _Journal of Open Source Software_, *4*(43), 1686. doi:10.21105/joss.01686 &lt;https://doi.org/10.21105/joss.01686&gt;.
  - Wickham H, Bryan J, Barrett M, Teucher A (2024). _usethis: Automate Package and Project Setup_. R package version 3.1.0, &lt;https://CRAN.R-project.org/package=usethis&gt;.
  - Wickham H, François R, Henry L, Müller K, Vaughan D (2023). _dplyr: A Grammar of Data Manipulation_. R package version 1.1.4, &lt;https://CRAN.R-project.org/package=dplyr&gt;.
  - Wickham H, Henry L (2025). _purrr: Functional Programming Tools_. R package version 1.0.4, &lt;https://CRAN.R-project.org/package=purrr&gt;.
  - Wickham H, Hester J, Bryan J (2024). _readr: Read Rectangular Text Data_. R package version 2.1.5, &lt;https://CRAN.R-project.org/package=readr&gt;.
  - Wickham H, Hester J, Chang W, Bryan J (2022). _devtools: Tools to Make Developing R Packages Easier_. R package version 2.4.5, &lt;https://CRAN.R-project.org/package=devtools&gt;.
  - Wickham H, Miller E, Smith D (2023). _haven: Import and Export 'SPSS', 'Stata' and 'SAS' Files_. R package version 2.5.4, &lt;https://CRAN.R-project.org/package=haven&gt;.
  - Wickham H, Vaughan D, Girlich M (2024). _tidyr: Tidy Messy Data_. R package version 1.3.1, &lt;https://CRAN.R-project.org/package=tidyr&gt;.
  - Xie Y (2025). _tinytex: Helper Functions to Install and Maintain TeX Live, and Compile LaTeX Documents_. R package version 0.56, &lt;https://github.com/rstudio/tinytex&gt;. Xie Y (2019). "TinyTeX: A lightweight, cross-platform, and easy-to-maintain LaTeX distribution based on TeX Live." _TUGboat_, *40*(1), 30-32. &lt;https://tug.org/TUGboat/Contents/contents40-1.html&gt;.</code></pre>
</div>
</div>


<!-- -->


</section>
</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb22" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Causal Inference: Average Treatment Effects"</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "2025-March-25"</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="an">bibliography:</span><span class="co"> /Users/joseph/GIT/templates/bib/references.bib</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="an">editor_options:</span><span class="co"> </span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co">  chunk_output_type: console</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co">    warnings: FALSE</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co">    error: FALSE</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="co">    messages: FALSE</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="co">    code-overflow: scroll</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="co">    highlight-style: kate</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools:</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="co">      source: true</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="co">      toggle: FALSE</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="an">html-math-method:</span><span class="co"> katex</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="an">reference-location:</span><span class="co"> margin</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="an">citation-location:</span><span class="co"> margin</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="an">cap-location:</span><span class="co"> margin</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="an">code-block-border-left:</span><span class="co"> true</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">WARNING</span><span class="co">:  COMMENT THIS OUT. JB DOES THIS FOR WORKING WITHOUT WIFI</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a><span class="co">#source("/Users/joseph/GIT/templates/functions/libs2.R")</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">WARNING</span><span class="co">:  COMMENT THIS OUT. JB DOES THIS FOR WORKING WITHOUT WIFI</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a><span class="co">#source("/Users/joseph/GIT/templates/functions/funs.R")</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">ALERT</span><span class="co">: UNCOMMENT THIS AND DOWNLOAD THE FUNCTIONS FROM JB's GITHUB</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a><span class="co"># source(</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a><span class="co">#   "https://raw.githubusercontent.com/go-bayes/templates/main/functions/experimental_funs.R"</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a><span class="co"># source(</span></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a><span class="co">#   "https://raw.githubusercontent.com/go-bayes/templates/main/functions/experimental_funs.R"</span></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a><span class="co"># for making graphs</span></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"tinytex"</span>)</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"extrafont"</span>)</span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a><span class="fu">loadfonts</span>(<span class="at">device =</span> <span class="st">"all"</span>)</span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>::: {.callout-note}</span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>**Required**</span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@hernan2024WHATIF</span><span class="co">]</span> Chapters 1-3 <span class="co">[</span><span class="ot">link</span><span class="co">](https://www.dropbox.com/scl/fi/9hy6xw1g1o4yz94ip8cvd/hernanrobins_WhatIf_2jan24.pdf?rlkey=8eaw6lqhmes7ddepuriwk5xk9&amp;dl=0)</span></span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a>**Optional**</span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@neal2020introduction</span><span class="co">]</span> Chapter 1-2 <span class="co">[</span><span class="ot">link</span><span class="co">](https://www.dropbox.com/scl/fi/9hy6xw1g1o4yz94ip8cvd/hernanrobins_WhatIf_2jan24.pdf?rlkey=8eaw6lqhmes7ddepuriwk5xk9&amp;dl=0)</span></span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>::: {.callout-important}</span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a><span class="fu">## Key concepts for the test(s):</span></span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>**The Fundamental Problem of Causal Inference**</span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>**Causal Inference in Randomised Experiments**</span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>**Causal Inference in Observational Studies - Average (Marginal) Treatment Effects**</span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>**Three Fundamental Assumptions for Causal Inference**</span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a>::: {.callout-important}</span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a><span class="fu">## For the lab, copy and paste code chunks following the "LAB 6" section.</span></span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a>::: {.callout-important}</span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a>In these notes, we use the terms "counterfactual outcomes" and "potential outcomes" interchangeably.</span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a><span class="fu"># Seminar</span></span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a><span class="fu">## Learning Outcomes</span></span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-81"><a href="#cb22-81" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You will understand why causation is never directly observed.</span>
<span id="cb22-82"><a href="#cb22-82" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You will understand how experiments address this "causal gap."</span>
<span id="cb22-83"><a href="#cb22-83" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>You will understand how applying three principles from experimental research allows human scientists to close this "causal gap" when making inferences about a population as a whole — that is, inferences about "marginal effects."</span>
<span id="cb22-84"><a href="#cb22-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-85"><a href="#cb22-85" aria-hidden="true" tabindex="-1"></a><span class="fu">## Opening </span></span>
<span id="cb22-86"><a href="#cb22-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-87"><a href="#cb22-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-88"><a href="#cb22-88" aria-hidden="true" tabindex="-1"></a>::: {.callout-quote}</span>
<span id="cb22-89"><a href="#cb22-89" aria-hidden="true" tabindex="-1"></a>**Robert Frost writes:**</span>
<span id="cb22-90"><a href="#cb22-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-91"><a href="#cb22-91" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Two roads diverged in a yellow wood,</span>  </span>
<span id="cb22-92"><a href="#cb22-92" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; And sorry I could not travel both</span>  </span>
<span id="cb22-93"><a href="#cb22-93" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; And be one traveler, long I stood</span>  </span>
<span id="cb22-94"><a href="#cb22-94" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; And looked down one as far as I could</span>  </span>
<span id="cb22-95"><a href="#cb22-95" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; To where it bent in the undergrowth;</span>  </span>
<span id="cb22-96"><a href="#cb22-96" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; </span></span>
<span id="cb22-97"><a href="#cb22-97" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Then took the other, as just as fair,</span>  </span>
<span id="cb22-98"><a href="#cb22-98" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; And having perhaps the better claim,</span>  </span>
<span id="cb22-99"><a href="#cb22-99" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Because it was grassy and wanted wear;</span>  </span>
<span id="cb22-100"><a href="#cb22-100" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Though as for that the passing there</span>  </span>
<span id="cb22-101"><a href="#cb22-101" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Had worn them really about the same,</span>  </span>
<span id="cb22-102"><a href="#cb22-102" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; </span></span>
<span id="cb22-103"><a href="#cb22-103" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; And both that morning equally lay</span>  </span>
<span id="cb22-104"><a href="#cb22-104" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; In leaves no step had trodden black.</span>  </span>
<span id="cb22-105"><a href="#cb22-105" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Oh, I kept the first for another day!</span>  </span>
<span id="cb22-106"><a href="#cb22-106" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Yet knowing how way leads on to way,</span>  </span>
<span id="cb22-107"><a href="#cb22-107" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; I doubted if I should ever come back.</span>  </span>
<span id="cb22-108"><a href="#cb22-108" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; </span></span>
<span id="cb22-109"><a href="#cb22-109" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; I shall be telling this with a sigh</span>  </span>
<span id="cb22-110"><a href="#cb22-110" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Somewhere ages and ages hence:</span>  </span>
<span id="cb22-111"><a href="#cb22-111" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Two roads diverged in a wood, and I—</span>  </span>
<span id="cb22-112"><a href="#cb22-112" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; I took the one less traveled by,</span>  </span>
<span id="cb22-113"><a href="#cb22-113" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; And that has made all the difference.</span></span>
<span id="cb22-114"><a href="#cb22-114" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; </span></span>
<span id="cb22-115"><a href="#cb22-115" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; -- *The Road Not Taken*</span></span>
<span id="cb22-116"><a href="#cb22-116" aria-hidden="true" tabindex="-1"></a><span class="at">:::</span></span>
<span id="cb22-117"><a href="#cb22-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-118"><a href="#cb22-118" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction: Motivating Example</span></span>
<span id="cb22-119"><a href="#cb22-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-120"><a href="#cb22-120" aria-hidden="true" tabindex="-1"></a>Consider the following cross-cultural question:</span>
<span id="cb22-121"><a href="#cb22-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-122"><a href="#cb22-122" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Does bilingualism improve cognitive abilities in children?</span></span>
<span id="cb22-123"><a href="#cb22-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-124"><a href="#cb22-124" aria-hidden="true" tabindex="-1"></a>There is evidence that bilingual children perform better at cognitive tasks, but is this improvement truly caused by learning more than one language, or is it confounded by other factors (e.g., cultural environment, parental influence)? How can we know? Each child might answer, like the traveller in Frost’s poem:</span>
<span id="cb22-125"><a href="#cb22-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-126"><a href="#cb22-126" aria-hidden="true" tabindex="-1"></a>**"And sorry I could not travel both. And be one traveler $\dots$"**</span>
<span id="cb22-127"><a href="#cb22-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-128"><a href="#cb22-128" aria-hidden="true" tabindex="-1"></a><span class="fu">## Part 1: The Fundamental Problem of Causal Inference as a Missing Data Problem </span></span>
<span id="cb22-129"><a href="#cb22-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-130"><a href="#cb22-130" aria-hidden="true" tabindex="-1"></a>**The fundamental problem of causal inference** is that causality is never directly observed. </span>
<span id="cb22-131"><a href="#cb22-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-132"><a href="#cb22-132" aria-hidden="true" tabindex="-1"></a>Let $Y$ and $A$ denote random variables.</span>
<span id="cb22-133"><a href="#cb22-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-134"><a href="#cb22-134" aria-hidden="true" tabindex="-1"></a>We formulate a causal question by asking whether experiencing a exposure $A$, when this exposure is set to level $A = a$, would lead to a difference in $Y$, compared to what would have occurred had the exposure been set to a different level, say $A=a'$ will lead to a difference in outcome $Y$. For simplicity, we imagine binary exposure such that $A = 1$ denotes receiving the "bilingual" exposure and $A = 0$ denotes receiving the "monolingual" exposure. Assume these are the only two exposures of interest:</span>
<span id="cb22-135"><a href="#cb22-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-136"><a href="#cb22-136" aria-hidden="true" tabindex="-1"></a>Let: </span>
<span id="cb22-137"><a href="#cb22-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-138"><a href="#cb22-138" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>$Y_i(a = 1)$ denote the cognitive ability of child $i$ if the child were bilingual (potential outcome when $A_i = 1$).</span>
<span id="cb22-139"><a href="#cb22-139" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>$Y_i(a = 0)$ denote the cognitive ability of child $i$ if the child were monolingual (potential outcome when $A_i = 0$).</span>
<span id="cb22-140"><a href="#cb22-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-141"><a href="#cb22-141" aria-hidden="true" tabindex="-1"></a>What does it mean to *quantify* a causal effect. We may define the individual-level causal effect of bilingualism on cognitive ability for child $i$ as the difference between two states of the world: one for which the child experiences a bilingual exposure and the other for which the child does not. We write this contrast by referring to the potential outcomes under different levels of exposure:</span>
<span id="cb22-142"><a href="#cb22-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-143"><a href="#cb22-143" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-144"><a href="#cb22-144" aria-hidden="true" tabindex="-1"></a>\text{Causal Effect}_i = Y_i(1) - Y_i(0).</span>
<span id="cb22-145"><a href="#cb22-145" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-146"><a href="#cb22-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-147"><a href="#cb22-147" aria-hidden="true" tabindex="-1"></a>We say there is a causal effect of the bilingual exposure if</span>
<span id="cb22-148"><a href="#cb22-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-149"><a href="#cb22-149" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-150"><a href="#cb22-150" aria-hidden="true" tabindex="-1"></a>Y_i(1) - Y_i(0) \neq 0.</span>
<span id="cb22-151"><a href="#cb22-151" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-152"><a href="#cb22-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-153"><a href="#cb22-153" aria-hidden="true" tabindex="-1"></a>Because each child experiences only **one** exposure condition in reality, we cannot directly compute this difference from any dataset — the missing observation is called the **counterfactual**:</span>
<span id="cb22-154"><a href="#cb22-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-155"><a href="#cb22-155" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>If $Y_i|A_i = 1$ is observed, then $Y_i(0)|A_i=1$ is counterfactual.</span>
<span id="cb22-156"><a href="#cb22-156" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>If $Y_i|A_i = 0$ is observed, then $Y_i(1)|A_i=1$ is counterfactual.</span>
<span id="cb22-157"><a href="#cb22-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-158"><a href="#cb22-158" aria-hidden="true" tabindex="-1"></a>**"And sorry I could not travel both / And be one traveler, long I stood $\dots$"**</span>
<span id="cb22-159"><a href="#cb22-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-160"><a href="#cb22-160" aria-hidden="true" tabindex="-1"></a>In short, individuals cannot simultaneously experience both exposure conditions, so one outcome is inevitably missing. </span>
<span id="cb22-161"><a href="#cb22-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-162"><a href="#cb22-162" aria-hidden="true" tabindex="-1"></a><span class="fu">## How can we make contrasts between counterfactual (potential) outcomes?</span></span>
<span id="cb22-163"><a href="#cb22-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-164"><a href="#cb22-164" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fundamental Assumption 1: Causal Consistency</span></span>
<span id="cb22-165"><a href="#cb22-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-166"><a href="#cb22-166" aria-hidden="true" tabindex="-1"></a>Causal consistency means that the potential outcome corresponding to the exposure an individual actually receives is exactly what we observe. In other words, if individual $i$ receives exposure $a$, then the *potential outcome* (or equivalently the *counterfactual outcome* under a given level of exposure $A=a$ -- that is $Y_i(a)$ -- is equivalent to the *the observed outcome*: $Y_i \mid A_i \equiv a$. Where the symbol $\equiv$ means "equivalent to", when we assume that the causal consistency assumption is satisfied, we assume that:</span>
<span id="cb22-167"><a href="#cb22-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-168"><a href="#cb22-168" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-169"><a href="#cb22-169" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb22-170"><a href="#cb22-170" aria-hidden="true" tabindex="-1"></a>\underbrace{Y_i(1)}_{\text{counterfactual}} &amp;\equiv \underbrace{(Y_i \mid A_i = 1)}_{\text{observable}}, <span class="sc">\\</span></span>
<span id="cb22-171"><a href="#cb22-171" aria-hidden="true" tabindex="-1"></a>\underbrace{Y_i(0)}_{\text{counterfactual}} &amp;\equiv \underbrace{(Y_i \mid A_i = 0)}_{\text{observable}}.</span>
<span id="cb22-172"><a href="#cb22-172" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb22-173"><a href="#cb22-173" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-174"><a href="#cb22-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-175"><a href="#cb22-175" aria-hidden="true" tabindex="-1"></a>Notice however that we cannot generally obtain individual causal effects because at any given time, each individual may only receive at most one leve of an exposure. Where the symbol $\implies$ means "implies," at any given time, receiving one level of an exposure precludes receiving any other level of that exposure:</span>
<span id="cb22-176"><a href="#cb22-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-177"><a href="#cb22-177" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-178"><a href="#cb22-178" aria-hidden="true" tabindex="-1"></a>Y_i|A_i = 1 \implies Y_i(0)|A_i = 1~ \text{is counterfactual}</span>
<span id="cb22-179"><a href="#cb22-179" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-180"><a href="#cb22-180" aria-hidden="true" tabindex="-1"></a>Likewise:</span>
<span id="cb22-181"><a href="#cb22-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-182"><a href="#cb22-182" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-183"><a href="#cb22-183" aria-hidden="true" tabindex="-1"></a>Y_i|A_i = 0 \implies Y_i(1)|A_i = 1~ \text{is counterfactual}</span>
<span id="cb22-184"><a href="#cb22-184" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-185"><a href="#cb22-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-186"><a href="#cb22-186" aria-hidden="true" tabindex="-1"></a>Because of the laws of physics (above the atomic scale), an individual can experience only one exposure level at any moment. Consequently, we can observe only one of the two counterfactual outcomes needed to quantify a causal effect. This is the fundamental problem of causal inference. Counterfactual contrasts cannot be individually observed. </span>
<span id="cb22-187"><a href="#cb22-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-188"><a href="#cb22-188" aria-hidden="true" tabindex="-1"></a>However, because of the causal consistency assumption, we can nevertheless recover half of the missing counterfactual (or “potential”) outcomes needed to estimate average treatment effects. We may do this if two other assumptions are satisfied.</span>
<span id="cb22-189"><a href="#cb22-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-190"><a href="#cb22-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-191"><a href="#cb22-191" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fundamental Assumption 2: Exchangeability</span></span>
<span id="cb22-192"><a href="#cb22-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-193"><a href="#cb22-193" aria-hidden="true" tabindex="-1"></a>Exchangeability justifies recovering unobserved counterfactuals from observed outcomes and averaging them. By accepting that $Y_i(a) = Y_i$ if $A_i = a$, we can estimate population-level average potential outcomes. In an experiment where exposure groups are comparable, we define the Average Treatment Effect (ATE) as:</span>
<span id="cb22-194"><a href="#cb22-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-195"><a href="#cb22-195" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-196"><a href="#cb22-196" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb22-197"><a href="#cb22-197" aria-hidden="true" tabindex="-1"></a>\text{ATE} &amp;= \mathbb{E}<span class="co">[</span><span class="ot">Y(1)</span><span class="co">]</span> - \mathbb{E}<span class="co">[</span><span class="ot">Y(0)</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb22-198"><a href="#cb22-198" aria-hidden="true" tabindex="-1"></a>           &amp;= \mathbb{E}(Y \mid A=1) \;-\; \mathbb{E}(Y \mid A=0).</span>
<span id="cb22-199"><a href="#cb22-199" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb22-200"><a href="#cb22-200" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-201"><a href="#cb22-201" aria-hidden="true" tabindex="-1"></a>Because randomisation ensures that missing counterfactuals are exchangeable with those observed, we can still estimate $\mathbb{E}<span class="co">[</span><span class="ot">Y(a)</span><span class="co">]</span>$. For instance, assume:</span>
<span id="cb22-202"><a href="#cb22-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-203"><a href="#cb22-203" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-204"><a href="#cb22-204" aria-hidden="true" tabindex="-1"></a> \underbrace{\mathbb{E}<span class="co">[</span><span class="ot">Y(1)\mid A=1</span><span class="co">]</span>}_{\text{counterfactual}}  = \textcolor{red}{\underbrace{\mathbb{E}[Y(1)\mid A=0]}_{\text{unobservable}}}  =  \underbrace{(Y_i \mid A_i = 1)}_{\text{observed}}</span>
<span id="cb22-205"><a href="#cb22-205" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-206"><a href="#cb22-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-207"><a href="#cb22-207" aria-hidden="true" tabindex="-1"></a>which lets us infer the average outcome if everyone were treated. Likewise, if</span>
<span id="cb22-208"><a href="#cb22-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-209"><a href="#cb22-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-210"><a href="#cb22-210" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-211"><a href="#cb22-211" aria-hidden="true" tabindex="-1"></a> \underbrace{\mathbb{E}<span class="co">[</span><span class="ot">Y(0)\mid A=0</span><span class="co">]</span>}_{\text{counterfactual}}  = \textcolor{red}{\underbrace{\mathbb{E}[Y(1)\mid A=0]}_{\text{unobservable}}}  =  \underbrace{\mathbb{E}(Y \mid A_i = 0)}_{\text{observed}}</span>
<span id="cb22-212"><a href="#cb22-212" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-213"><a href="#cb22-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-214"><a href="#cb22-214" aria-hidden="true" tabindex="-1"></a>then we can infer the average outcome if everyone were given the control. The difference between these two quantities gives the ATE:</span>
<span id="cb22-215"><a href="#cb22-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-216"><a href="#cb22-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-217"><a href="#cb22-217" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-218"><a href="#cb22-218" aria-hidden="true" tabindex="-1"></a>\text{ATE} = \Big[</span>
<span id="cb22-219"><a href="#cb22-219" aria-hidden="true" tabindex="-1"></a>\overbrace{\mathbb{E}<span class="co">[</span><span class="ot">Y(1)\mid A=1</span><span class="co">]</span>}^{\substack{\text{by consistency:}<span class="sc">\\</span> \equiv \text{ observed } \; \mathbb{E}<span class="co">[</span><span class="ot">Y\mid A=1</span><span class="co">]</span>}}</span>
<span id="cb22-220"><a href="#cb22-220" aria-hidden="true" tabindex="-1"></a>\;+\;</span>
<span id="cb22-221"><a href="#cb22-221" aria-hidden="true" tabindex="-1"></a>\overbrace{\textcolor{red}{\mathbb{E}<span class="co">[</span><span class="ot">Y(1)\mid A=0</span><span class="co">]</span>}}^{\substack{\text{by exchangeability:}<span class="sc">\\</span> \text{unobservable, yet } \; \equiv \mathbb{E}<span class="co">[</span><span class="ot">Y\mid A=1</span><span class="co">]</span>}}</span>
<span id="cb22-222"><a href="#cb22-222" aria-hidden="true" tabindex="-1"></a>\Big]</span>
<span id="cb22-223"><a href="#cb22-223" aria-hidden="true" tabindex="-1"></a>-\,</span>
<span id="cb22-224"><a href="#cb22-224" aria-hidden="true" tabindex="-1"></a>\Big[</span>
<span id="cb22-225"><a href="#cb22-225" aria-hidden="true" tabindex="-1"></a>\overbrace{\mathbb{E}<span class="co">[</span><span class="ot">Y(0)\mid A=0</span><span class="co">]</span>}^{\substack{\text{by consistency:}<span class="sc">\\</span> \equiv  \text{observed } \; \mathbb{E}<span class="co">[</span><span class="ot">Y\mid A=0</span><span class="co">]</span>}}</span>
<span id="cb22-226"><a href="#cb22-226" aria-hidden="true" tabindex="-1"></a>\;+\;</span>
<span id="cb22-227"><a href="#cb22-227" aria-hidden="true" tabindex="-1"></a>\overbrace{\textcolor{red}{\mathbb{E}<span class="co">[</span><span class="ot">Y(0)\mid A=1</span><span class="co">]</span>}}^{\substack{\text{by exchangeability:}<span class="sc">\\</span> \text{unobservable, yet } \; \equiv \mathbb{E}<span class="co">[</span><span class="ot">Y\mid A=0</span><span class="co">]</span>}}</span>
<span id="cb22-228"><a href="#cb22-228" aria-hidden="true" tabindex="-1"></a>\Big]</span>
<span id="cb22-229"><a href="#cb22-229" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-230"><a href="#cb22-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-231"><a href="#cb22-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-232"><a href="#cb22-232" aria-hidden="true" tabindex="-1"></a>We have it that $\mathbb{E}<span class="co">[</span><span class="ot">Y\mid A=1</span><span class="co">]</span>$ and  $\mathbb{E}<span class="co">[</span><span class="ot">Y\mid A=0</span><span class="co">]</span>$ and  $\mathbb{E}<span class="co">[</span><span class="ot">Y(1)\mid A=0</span><span class="co">]</span>$ are observed. If both consistency and exchangeability are satisifed then we may use these observed quantities to identify contrasts of counterfactual quanities. </span>
<span id="cb22-233"><a href="#cb22-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-234"><a href="#cb22-234" aria-hidden="true" tabindex="-1"></a>Thus, although individual-level counterfactuals are missing, the consistency assumptions and the exchangeability assumptions allow us to identify the average effect of treatment using observed data.  Randomised controlled experiments allow us to meet these assumptions. Randomisation warrents the exchangeability assumption. Control warrents the consistency asumption. </span>
<span id="cb22-235"><a href="#cb22-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-236"><a href="#cb22-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-237"><a href="#cb22-237" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fundamental Assumption 3: Positivity</span></span>
<span id="cb22-238"><a href="#cb22-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-239"><a href="#cb22-239" aria-hidden="true" tabindex="-1"></a>There is one further assumption, called positivity. It states that treatment assignments cannot be deterministic. That is, for every covariate pattern $L = l$, each individual has a non-zero probability of receiving ever treatment level to be compared:</span>
<span id="cb22-240"><a href="#cb22-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-241"><a href="#cb22-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-242"><a href="#cb22-242" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-243"><a href="#cb22-243" aria-hidden="true" tabindex="-1"></a>P(A = a \mid L = l) &gt; 0.</span>
<span id="cb22-244"><a href="#cb22-244" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-245"><a href="#cb22-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-246"><a href="#cb22-246" aria-hidden="true" tabindex="-1"></a>Randomised experiments achieve positivity by design -- at least for the sample that is selected into the study. In observational settings violations occur if some subgroups never receive a particular treatment. If treatments occur but are rare, we may have sufficient data from which to obtain convincing causal inferences. </span>
<span id="cb22-247"><a href="#cb22-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-248"><a href="#cb22-248" aria-hidden="true" tabindex="-1"></a>Positivity is the only assumption that can be verified with data. We will consider how to assess this assumption using data when we develop our data analytic workflows in the second half of this course.</span>
<span id="cb22-249"><a href="#cb22-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-250"><a href="#cb22-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-251"><a href="#cb22-251" aria-hidden="true" tabindex="-1"></a><span class="fu">## Challenges with Observational Data</span></span>
<span id="cb22-252"><a href="#cb22-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-253"><a href="#cb22-253" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. Satisfying Causal Consistency is Difficult in Observational Settings</span></span>
<span id="cb22-254"><a href="#cb22-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-255"><a href="#cb22-255" aria-hidden="true" tabindex="-1"></a>Below are some ways in which real-world complexities can violate causal consistency in observational studies. For example, causal consistency requires there is no interference between units (also called "SUTVA" or "Stable Unit Treatment Value." Causal consistency also requires that each treatment level is well-defined and applied uniformly. If these conditions fail, then $Y(a)$ may not reflect a consistent exposures across individuals. We are then comparing apples with oranges. Consider some examples:</span>
<span id="cb22-256"><a href="#cb22-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-257"><a href="#cb22-257" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Cultural differences**: one group’s "second-language exposure" may differ qualitatively from another’s if cultural norms shape how, when, or by whom the second language is taught. For instance, a child in a bilingual community may receive diverse and immersive language experiences all of which are are coded as $A=1$. Yet the treatments might be quite different. We might be comparing apples with oranges.</span>
<span id="cb22-258"><a href="#cb22-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-259"><a href="#cb22-259" aria-hidden="true" tabindex="-1"></a><span class="ss">2.   </span>**Age of acquisition**: the developmental effect of learning a second language may vary by when the child is exposed. Comparing aquisition at, say, age two with aquisition at say, age twelve, might be comparing apples with oranges.</span>
<span id="cb22-260"><a href="#cb22-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-261"><a href="#cb22-261" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Language variation:** sign languages, highly tonal languages, or unwritten languages may demand different cognitive tasks than spoken, nontonal, or widely documented languages. Thus, lumping them together as "learning a second language" can obscure the fact that these distinct exposures might produce fundamentally different outcomes. Again, comparisons here would be of apples with oranges.</span>
<span id="cb22-262"><a href="#cb22-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-263"><a href="#cb22-263" aria-hidden="true" tabindex="-1"></a>These sources of heterogeneity reveal why careful delineation of treatments is crucial. If the actual exposures differ across individuals, then consistency $(Y_i(a) = Y_i \mid A_i = a)$ may fail, because $A=a$ is not the same phenomenon for everyone.</span>
<span id="cb22-264"><a href="#cb22-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-265"><a href="#cb22-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-266"><a href="#cb22-266" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. Conditional Exchangeability (No Unmeasured Confounding) Is Difficult to Achieve</span></span>
<span id="cb22-267"><a href="#cb22-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-268"><a href="#cb22-268" aria-hidden="true" tabindex="-1"></a>In theory, we can identify a causal effect from observational data if all confounders $L$ are measured. Formally, we need the potential outcomes to be independent of treatment once we condition on $L$. One way to express this asssumption is: $Y(a) \coprod A \mid L$. If the potential outcomes are independent of treatment assignment, we can identify the Average Treatment Effect (ATE) as:</span>
<span id="cb22-269"><a href="#cb22-269" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-270"><a href="#cb22-270" aria-hidden="true" tabindex="-1"></a>\text{ATE} \;=\; \sum_{l}</span>
<span id="cb22-271"><a href="#cb22-271" aria-hidden="true" tabindex="-1"></a>\Bigl<span class="co">[</span><span class="ot">\mathbb{E}\bigl(Y \mid A=1, L=l\bigr) \;-\; \mathbb{E}\bigl(Y \mid A=0, L=l\bigr)\Bigr</span><span class="co">]</span> \;\Pr(L=l).</span>
<span id="cb22-272"><a href="#cb22-272" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-273"><a href="#cb22-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-274"><a href="#cb22-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-275"><a href="#cb22-275" aria-hidden="true" tabindex="-1"></a>In randomised experiments, conditioning is automatic because $A$ is unrelated to potential outcomes by design. In observational studies, ensuring or approximating such **conditional exchangeability** is often difficult. For example, bilingualism research would need to consider:</span>
<span id="cb22-276"><a href="#cb22-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-277"><a href="#cb22-277" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Cultural histories**: cultures that value language acquistion might also value knowledge acquistion. Associations might arise from Culture, not causation.</span>
<span id="cb22-278"><a href="#cb22-278" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Personal values**: families who place a high priority on bilingualism may also promote other developmental resources.</span>
<span id="cb22-279"><a href="#cb22-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-280"><a href="#cb22-280" aria-hidden="true" tabindex="-1"></a>If important confounders go unmeasured or are poorly measured, these differences can bias causal effect estimates.</span>
<span id="cb22-281"><a href="#cb22-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-282"><a href="#cb22-282" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3. The Positivity Assumption May Fail: Treatments Might Not Exist for All</span></span>
<span id="cb22-283"><a href="#cb22-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-284"><a href="#cb22-284" aria-hidden="true" tabindex="-1"></a>Positivity requires that each individual could, in principle, receive *any* exposure level. But in real-world observational settings, some groups have no access to bilingual education (or no reason to be monolingual), making certain treatment levels impossible for them. If a treatment level does not appear in the data for a given subgroup, any causal effect estimate for that subgroup is purely an extrapolation <span class="co">[</span><span class="ot">@westreich2010; @hernan2023</span><span class="co">]</span>. </span>
<span id="cb22-285"><a href="#cb22-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-286"><a href="#cb22-286" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb22-287"><a href="#cb22-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-288"><a href="#cb22-288" aria-hidden="true" tabindex="-1"></a>We introduced the fundamental problem of causal inference by distinguishing correlation (associations in the data) from causation (contrasts between potential outcomes, of which only one can be observed for each individual). </span>
<span id="cb22-289"><a href="#cb22-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-290"><a href="#cb22-290" aria-hidden="true" tabindex="-1"></a>**Randomised experiments** address this problem by balancing confounding variables across treatment levels. Although individual causal effects are unobservable, random assignment allows us to infer **average** causal effects — also called *marginal* effects.</span>
<span id="cb22-291"><a href="#cb22-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-292"><a href="#cb22-292" aria-hidden="true" tabindex="-1"></a>In **observational data**, inferring average treatment effects demands that we satisfy three assumptions that are automatically satisfied in (well-conducted) experiments: **causal consistency**, **exchangeability**, and **positivity**. These assumptions ensure that we can compare like-with-like (that the population-level treatment effect is consistent across individuals), that there are no unmeasured common causes of the exposure and outcomes that may lead to associations in the absence of causality, and that every exposure level is a real possibility for each subgroup. </span>
<span id="cb22-293"><a href="#cb22-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-294"><a href="#cb22-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-295"><a href="#cb22-295" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- # Seminar --&gt;</span></span>
<span id="cb22-296"><a href="#cb22-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-297"><a href="#cb22-297" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ## Learning Outcomes --&gt;</span></span>
<span id="cb22-298"><a href="#cb22-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-299"><a href="#cb22-299" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- - You will understand why causation is never directly observed. --&gt;</span></span>
<span id="cb22-300"><a href="#cb22-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-301"><a href="#cb22-301" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- - You will understand how experiments address this "causal gap." --&gt;</span></span>
<span id="cb22-302"><a href="#cb22-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-303"><a href="#cb22-303" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- - You will understand how the application of three principles from experimental research allow human scientists to close this "causal gap" when making inferences about a population as whole -- that is, inferences about "marginal effects." --&gt;</span></span>
<span id="cb22-304"><a href="#cb22-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-305"><a href="#cb22-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-306"><a href="#cb22-306" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ## Opening  --&gt;</span></span>
<span id="cb22-307"><a href="#cb22-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-308"><a href="#cb22-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-309"><a href="#cb22-309" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Robert Frost writes,  --&gt;</span></span>
<span id="cb22-310"><a href="#cb22-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-311"><a href="#cb22-311" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- &gt; Two roads diverged in a yellow wood, --&gt;</span></span>
<span id="cb22-312"><a href="#cb22-312" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- And sorry I could not travel both --&gt;</span></span>
<span id="cb22-313"><a href="#cb22-313" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- And be one traveler, long I stood --&gt;</span></span>
<span id="cb22-314"><a href="#cb22-314" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- And looked down one as far as I could --&gt;</span></span>
<span id="cb22-315"><a href="#cb22-315" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- To where it bent in the undergrowth; --&gt;</span></span>
<span id="cb22-316"><a href="#cb22-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-317"><a href="#cb22-317" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- &gt;Then took the other, as just as fair, --&gt;</span></span>
<span id="cb22-318"><a href="#cb22-318" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- And having perhaps the better claim, --&gt;</span></span>
<span id="cb22-319"><a href="#cb22-319" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Because it was grassy and wanted wear; --&gt;</span></span>
<span id="cb22-320"><a href="#cb22-320" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Though as for that the passing there --&gt;</span></span>
<span id="cb22-321"><a href="#cb22-321" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Had worn them really about the same, --&gt;</span></span>
<span id="cb22-322"><a href="#cb22-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-323"><a href="#cb22-323" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- &gt;And both that morning equally lay --&gt;</span></span>
<span id="cb22-324"><a href="#cb22-324" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- In leaves no step had trodden black. --&gt;</span></span>
<span id="cb22-325"><a href="#cb22-325" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Oh, I kept the first for another day! --&gt;</span></span>
<span id="cb22-326"><a href="#cb22-326" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Yet knowing how way leads on to way, --&gt;</span></span>
<span id="cb22-327"><a href="#cb22-327" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- I doubted if I should ever come back. --&gt;</span></span>
<span id="cb22-328"><a href="#cb22-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-329"><a href="#cb22-329" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- &gt;I shall be telling this with a sigh --&gt;</span></span>
<span id="cb22-330"><a href="#cb22-330" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Somewhere ages and ages hence: --&gt;</span></span>
<span id="cb22-331"><a href="#cb22-331" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Two roads diverged in a wood, and I— --&gt;</span></span>
<span id="cb22-332"><a href="#cb22-332" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- I took the one less traveled by, --&gt;</span></span>
<span id="cb22-333"><a href="#cb22-333" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- And that has made all the difference.  --&gt;</span></span>
<span id="cb22-334"><a href="#cb22-334" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- -- The Road Not Taken --&gt;</span></span>
<span id="cb22-335"><a href="#cb22-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-336"><a href="#cb22-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-337"><a href="#cb22-337" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ## Introduction: Motivating Example --&gt;</span></span>
<span id="cb22-338"><a href="#cb22-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-339"><a href="#cb22-339" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Consider the following cross-cultural question:  --&gt;</span></span>
<span id="cb22-340"><a href="#cb22-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-341"><a href="#cb22-341" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- &gt; Does bilingualism improve cognitive abilities in children?  --&gt;</span></span>
<span id="cb22-342"><a href="#cb22-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-343"><a href="#cb22-343" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- There is evidence that bilingual children perform better oat cognitive tasks, but is learning more than one language a confounding factor?  --&gt;</span></span>
<span id="cb22-344"><a href="#cb22-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-345"><a href="#cb22-345" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- How can we know?  Each child might respond as the traveller in Frost's poem: --&gt;</span></span>
<span id="cb22-346"><a href="#cb22-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-347"><a href="#cb22-347" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- "And sorry I could not travel both. And be one traveller$\dots$" --&gt;</span></span>
<span id="cb22-348"><a href="#cb22-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-349"><a href="#cb22-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-350"><a href="#cb22-350" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ## Part 1: The Fundamental Problem of Causal Inference as a Missing Data Problem  --&gt;</span></span>
<span id="cb22-351"><a href="#cb22-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-352"><a href="#cb22-352" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Humans think in images, words, and songs -- sometimes dance. However, a little mathematical notation helps to clarify the key concepts in causal inference. --&gt;</span></span>
<span id="cb22-353"><a href="#cb22-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-354"><a href="#cb22-354" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- To understand **the fundamental problem of causal inference,** we first define two potential outcomes for each individual in our study: --&gt;</span></span>
<span id="cb22-355"><a href="#cb22-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-356"><a href="#cb22-356" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Let $Y$ and $A$ denote random variables.  --&gt;</span></span>
<span id="cb22-357"><a href="#cb22-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-358"><a href="#cb22-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-359"><a href="#cb22-359" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Mathematically, we formulate a causal question by asking whether assignment to treatment $A = a$ will lead to a difference to the outcome $Y$.   --&gt;</span></span>
<span id="cb22-360"><a href="#cb22-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-361"><a href="#cb22-361" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Let $A = 1$ denote getting the "bilingual" treatment, and $A = 0$ denote getting the monolingual treatment. Assume these are the only two treatments of interest.  --&gt;</span></span>
<span id="cb22-362"><a href="#cb22-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-363"><a href="#cb22-363" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- - $Y_i(a = 1)$ The cognitive ability of child $i$ if they were bilingual. This is the counterfactual outcome when treatement $A = (a  =  1)$. --&gt;</span></span>
<span id="cb22-364"><a href="#cb22-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-365"><a href="#cb22-365" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- - $Y_i(a = 0)$:: The cognitive ability of child $i$ if they were monolingual. This is the counterfactual outcome when $A = (a = 0)$. --&gt;</span></span>
<span id="cb22-366"><a href="#cb22-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-367"><a href="#cb22-367" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Using this notation, we may define a quantitative causal effect of bilingualism on cognitive ability for individual $i$ as the difference between these potential outcomes: --&gt;</span></span>
<span id="cb22-368"><a href="#cb22-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-369"><a href="#cb22-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-370"><a href="#cb22-370" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb22-371"><a href="#cb22-371" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \text{Causal Effect}_i = Y_i(1) - Y_i(0) --&gt;</span></span>
<span id="cb22-372"><a href="#cb22-372" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb22-373"><a href="#cb22-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-374"><a href="#cb22-374" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- We say there is a causal effect if:  --&gt;</span></span>
<span id="cb22-375"><a href="#cb22-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-376"><a href="#cb22-376" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb22-377"><a href="#cb22-377" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Y_i(1) - Y_i(0)  \neq 0 --&gt;</span></span>
<span id="cb22-378"><a href="#cb22-378" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb22-379"><a href="#cb22-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-380"><a href="#cb22-380" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Writing out our contrast of interest this way makes it clear that, because individuals experience only **one** treatment condition, we cannot compute this contrast directly from any data we may observe.  We call the missing observation "counterfactual." --&gt;</span></span>
<span id="cb22-381"><a href="#cb22-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-382"><a href="#cb22-382" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb22-383"><a href="#cb22-383" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Y_i|A_i = 1 \implies Y_i(0)|A_i = 1~ \text{is counterfactual} --&gt;</span></span>
<span id="cb22-384"><a href="#cb22-384" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb22-385"><a href="#cb22-385" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Furthermore: --&gt;</span></span>
<span id="cb22-386"><a href="#cb22-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-387"><a href="#cb22-387" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb22-388"><a href="#cb22-388" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Y_i|A_i = 0 \implies Y_i(1)|A_i = 1~ \text{is counterfactual} --&gt;</span></span>
<span id="cb22-389"><a href="#cb22-389" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb22-390"><a href="#cb22-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-391"><a href="#cb22-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-392"><a href="#cb22-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-393"><a href="#cb22-393" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- **And sorry I could not travel both And be one traveller, long I stood** $\dots$ --&gt;</span></span>
<span id="cb22-394"><a href="#cb22-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-395"><a href="#cb22-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-396"><a href="#cb22-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-397"><a href="#cb22-397" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ## How can we make contrasts between counterfactual (potential) outcomes?  --&gt;</span></span>
<span id="cb22-398"><a href="#cb22-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-399"><a href="#cb22-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-400"><a href="#cb22-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-401"><a href="#cb22-401" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Fundamental Assumption 1: Causal Consistency --&gt;</span></span>
<span id="cb22-402"><a href="#cb22-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-403"><a href="#cb22-403" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- We say that causal consistency holds if there is no heterogeneity in the treatments that would prevent us from assuming that the observed outcomes under treatments correspond to their potential outcomes. For an individual 'i', we must be able to assume: --&gt;</span></span>
<span id="cb22-404"><a href="#cb22-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-405"><a href="#cb22-405" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb22-406"><a href="#cb22-406" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \begin{aligned} --&gt;</span></span>
<span id="cb22-407"><a href="#cb22-407" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Y_{i}(1) &amp;= (Y_{i}|A_{i} = 1) \quad \text{(Potential outcome if treated)} \\ --&gt;</span></span>
<span id="cb22-408"><a href="#cb22-408" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Y_{i}(0) &amp;= (Y_{i}|A_{i} = 0) \quad \text{(Potential outcome if untreated)} --&gt;</span></span>
<span id="cb22-409"><a href="#cb22-409" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \end{aligned} --&gt;</span></span>
<span id="cb22-410"><a href="#cb22-410" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb22-411"><a href="#cb22-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-412"><a href="#cb22-412" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- If this assumption holds, as well as the assumptions of conditional exchangeability and positivity, we can calculate the Average Treatment Effect (ATE) from observed data as: --&gt;</span></span>
<span id="cb22-413"><a href="#cb22-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-414"><a href="#cb22-414" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb22-415"><a href="#cb22-415" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \begin{aligned} --&gt;</span></span>
<span id="cb22-416"><a href="#cb22-416" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \text{ATE} &amp;= \mathbb{E}[Y(1)] - \mathbb{E}[Y(0)] \\ --&gt;</span></span>
<span id="cb22-417"><a href="#cb22-417" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- &amp;= \mathbb{E}(Y|A=1) - \mathbb{E}(Y|A=0) --&gt;</span></span>
<span id="cb22-418"><a href="#cb22-418" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \end{aligned} --&gt;</span></span>
<span id="cb22-419"><a href="#cb22-419" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb22-420"><a href="#cb22-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-421"><a href="#cb22-421" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- This contrast assumes that the potential outcome under treatment is observable when the treatment is administered, setting $Y_i(a)$ to $Y_i|A_i=a$.  --&gt;</span></span>
<span id="cb22-422"><a href="#cb22-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-423"><a href="#cb22-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-424"><a href="#cb22-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-425"><a href="#cb22-425" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Fundamental Assumption 2: Exchangeability --&gt;</span></span>
<span id="cb22-426"><a href="#cb22-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-427"><a href="#cb22-427" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- We say that exchangability holds if the potential outcomes and treatment assignments are statistically independent, considering all measured confounders. This principle enables us to attribute observed group differences directly to the treatment. Randomisation provides *unconditional* exchangeability, simplifying the analytical process. --&gt;</span></span>
<span id="cb22-428"><a href="#cb22-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-429"><a href="#cb22-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-430"><a href="#cb22-430" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #### Fundamental Assumption 3: Positivity --&gt;</span></span>
<span id="cb22-431"><a href="#cb22-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-432"><a href="#cb22-432" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- We must assume that there is a non-zero probability of receiving each treatment level within covariate-defined subgroups. --&gt;</span></span>
<span id="cb22-433"><a href="#cb22-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-434"><a href="#cb22-434" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb22-435"><a href="#cb22-435" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- P(A = a | L= l) &gt; 0 --&gt;</span></span>
<span id="cb22-436"><a href="#cb22-436" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb22-437"><a href="#cb22-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-438"><a href="#cb22-438" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- This assumption is also met by the *control* that experimentalists exert over randomised controlled experiments and is rarely stated explicitly. However, in observational settings, this condition must be verified to avoid extrapolating results beyond observed data.   --&gt;</span></span>
<span id="cb22-439"><a href="#cb22-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-440"><a href="#cb22-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-441"><a href="#cb22-441" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Average Treatment Effect in randomised controlled experiments work from assumptions --&gt;</span></span>
<span id="cb22-442"><a href="#cb22-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-443"><a href="#cb22-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-444"><a href="#cb22-444" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Consider inherently missing observations in an experiment: --&gt;</span></span>
<span id="cb22-445"><a href="#cb22-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-446"><a href="#cb22-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-447"><a href="#cb22-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-448"><a href="#cb22-448" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ::: {#tbl-01} --&gt;</span></span>
<span id="cb22-449"><a href="#cb22-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-450"><a href="#cb22-450" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb22-451"><a href="#cb22-451" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \text{ATE} = \left[ \begin{aligned} --&gt;</span></span>
<span id="cb22-452"><a href="#cb22-452" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- &amp;\left( \underbrace{\mathbb{E}[Y(1)|A = 1]}_{\text{observed}} + \textcolor{red}{\underbrace{\mathbb{E}[Y(1)|A = 0]}_{\text{unobserved</span><span class="re">}}}</span><span class="co"> \right) \\ --&gt;</span></span>
<span id="cb22-453"><a href="#cb22-453" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- &amp;- \left( \underbrace{\mathbb{E}[Y(0)|A = 0]}_{\text{observed}} + \textcolor{red}{\underbrace{\mathbb{E}[Y(0)|A = 1]}_{\text{unobserved</span><span class="re">}}}</span><span class="co"> \right) --&gt;</span></span>
<span id="cb22-454"><a href="#cb22-454" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \end{aligned} \right] --&gt;</span></span>
<span id="cb22-455"><a href="#cb22-455" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb22-456"><a href="#cb22-456" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- :::  --&gt;</span></span>
<span id="cb22-457"><a href="#cb22-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-458"><a href="#cb22-458" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- In @tbl-01, the expression, $\mathbb{E}[Y(1)|A = 1]$ represents the average outcome when the treatment is given, which is observable. However, $\mathbb{E}[Y(1)|A = 0]$ represents the average outcome if the treatment had been given to those who were untreated, which remains unobservable. Similarly, the quantity $\mathbb{E}[Y(0)|A = 1]$ also remains unobservable.  Note that the problem isn't merely one of statistical analysis on the data. **The problem is that the relevant data to identify individual causal effects are missing.** Thus, it is evident that the fundamental problem of causal inference is an ever-present concern even in experiments! --&gt;</span></span>
<span id="cb22-459"><a href="#cb22-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-460"><a href="#cb22-460" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- All the data we require for causal inferences at the individual level are missing, Nevertheless, because the treatments have been randomised, the data we observe from randomised controlled experiments can allow us to infer what would happen, **on average** if the treatment were applied to the population from which the participants were sampled.  --&gt;</span></span>
<span id="cb22-461"><a href="#cb22-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-462"><a href="#cb22-462" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- We call this causal affect the "Average Treatment Effect" or equivalently, the "Marginal Effect of the Treatment."  --&gt;</span></span>
<span id="cb22-463"><a href="#cb22-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-464"><a href="#cb22-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-465"><a href="#cb22-465" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Challenges with Observational data --&gt;</span></span>
<span id="cb22-466"><a href="#cb22-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-467"><a href="#cb22-467" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #### 1. Causal Consistency is Challenging with Observational Data: "Treatments" are not adminsitered in a controlled way --&gt;</span></span>
<span id="cb22-468"><a href="#cb22-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-469"><a href="#cb22-469" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- The standardisation of treatments in randomised controlled experiments generally ensures the validity of the causal consistency assumption, which is seldom disputed. However, in observational settings, we cannot typically control the treatments that people receive. This fact imposes considerable challenges for satisfying this assumption. For example: --&gt;</span></span>
<span id="cb22-470"><a href="#cb22-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-471"><a href="#cb22-471" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- - **Cultures**: the language one starts with, and the language one learns next, and the order of learning, may affect cognitive development. --&gt;</span></span>
<span id="cb22-472"><a href="#cb22-472" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- - **Parents**: the way in which one learns languages, either at schools or at home environments, may affect cognitive development. --&gt;</span></span>
<span id="cb22-473"><a href="#cb22-473" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- - **Language**: language impose different demands, consider the demands of a sign language (body-brain), a highly tonal language, the demands of different writing systems, the cognitive demands that arise in cultures with no written scripts...   --&gt;</span></span>
<span id="cb22-474"><a href="#cb22-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-475"><a href="#cb22-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-476"><a href="#cb22-476" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Put another ways, causal inference does not merely require *randomisation*, it also requires *control*.  --&gt;</span></span>
<span id="cb22-477"><a href="#cb22-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-478"><a href="#cb22-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-479"><a href="#cb22-479" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #### 2. Conditional Exchangeability (No Unmeasured Confounding) with Observational Data --&gt;</span></span>
<span id="cb22-480"><a href="#cb22-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-481"><a href="#cb22-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-482"><a href="#cb22-482" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Under stronger assumptions, we may sometimes infer causal effects from associations in data, even if the treatment variable $A$ has not been randomised.  --&gt;</span></span>
<span id="cb22-483"><a href="#cb22-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-484"><a href="#cb22-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-485"><a href="#cb22-485" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb22-486"><a href="#cb22-486" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \text{ATE} = \sum_{l} \large( \mathbb{E}[Y|A=1, \textcolor{blue}{L=l}] - \mathbb{E}[Y|A=0, \textcolor{blue}{L=l}] \large) \times \textcolor{blue}{\Pr(L=l)} --&gt;</span></span>
<span id="cb22-487"><a href="#cb22-487" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb22-488"><a href="#cb22-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-489"><a href="#cb22-489" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Where $L$ denotes a set of measured covariates, we can express this principle of "no confounding" mathematically in two complementary ways. Recall our notation: $A \coprod B$ signifies that $A$ is independent of $B$, and vice versa: --&gt;</span></span>
<span id="cb22-490"><a href="#cb22-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-491"><a href="#cb22-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-492"><a href="#cb22-492" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 1. **Potential Outcomes Independent of Treatment (given L):** $Y(a) \coprod A \mid L$ --&gt;</span></span>
<span id="cb22-493"><a href="#cb22-493" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 2. **Treatment Assignment Independent of Potential Outcomes (given L):** $A \coprod Y(a) \mid L$ --&gt;</span></span>
<span id="cb22-494"><a href="#cb22-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-495"><a href="#cb22-495" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- These formulations are crucial when working with causal diagrams, which visually encode these principles. The key idea is straightforward: ensuring a balance of confounders across treatment groups is fundamental to experimental and observational causal inference strategies.  --&gt;</span></span>
<span id="cb22-496"><a href="#cb22-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-497"><a href="#cb22-497" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- With sufficiently large numbers of individuals, **randomisation facilitates this balance, achieving $A \coprod Y(a)$*** --&gt;</span></span>
<span id="cb22-498"><a href="#cb22-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-499"><a href="#cb22-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-500"><a href="#cb22-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-501"><a href="#cb22-501" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- The challenge in achieving conditional exchangability is challenging in observational studies. This condition requires the groups being compared to be similar in every aspect except for the treatment. Consider bilingualism. In real-world data, individuals with access to green spaces may differ from those without access in several ways: --&gt;</span></span>
<span id="cb22-502"><a href="#cb22-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-503"><a href="#cb22-503" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- - **Socioeconomic status**: the economic capacity of individuals often determines their opportunities for education and language learning, thereby affecting cognitive development. --&gt;</span></span>
<span id="cb22-504"><a href="#cb22-504" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- - **Age demographics**: language development is not even throughout childhood; when one learns a second language may make a difference. --&gt;</span></span>
<span id="cb22-505"><a href="#cb22-505" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- - **Lifestyle choices**: Children who learn different language  --&gt;</span></span>
<span id="cb22-506"><a href="#cb22-506" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- - **Personal values and social connections**: environmental values and community ties may influence both the choice of residence and the utilisation of green spaces. --&gt;</span></span>
<span id="cb22-507"><a href="#cb22-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-508"><a href="#cb22-508" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- These and other unmeasured factors can introduce biases, complicating the interpretation of causal relationships in observational studies. --&gt;</span></span>
<span id="cb22-509"><a href="#cb22-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-510"><a href="#cb22-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-511"><a href="#cb22-511" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ##### 3. The Positivity Assumption is challenging with observational data: The Relevant Treatments Do Not Exist in The Data --&gt;</span></span>
<span id="cb22-512"><a href="#cb22-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-513"><a href="#cb22-513" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Positivity demands that each individual has the possibility of experiencing *every* level of the treatment to be compared. However, real-world constraints, such as the availability of bilingualism within different cultural settings, may preclude some groups from accessing bilinual learning. Where the treatments of interest are absent or scarcely represented in our dataset, the resulting causal inferences will lack empirical support. Consequently, any coefficients derived will represent extrapolations from statistical models, challenging the validity of our causal inferences [@westreich2010; @hernan2023]. --&gt;</span></span>
<span id="cb22-514"><a href="#cb22-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-515"><a href="#cb22-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-516"><a href="#cb22-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-517"><a href="#cb22-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-518"><a href="#cb22-518" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Summary  --&gt;</span></span>
<span id="cb22-519"><a href="#cb22-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-520"><a href="#cb22-520" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- We described the fundamental problem of causal inference, focusing on the critical distinction between correlation -- associations in the data, and causation -- the contrast between potential outcomes only one of which, at most, can be observed. We discussed how controlled experiments facilitate the estimation of average treatment effects (ATE) by systematically manipulating the variable of interest, allowing for the distribution of variables that might affect the outcome to be balanced across the treatment conditions. Our discussion then shifted to observational data, emphasising the challenges inherent in extracting causal relationships from data without the benefit of controlled interventions. We underscored the need to satisfy three key assumptions —- conditional exchangeability, causal consistency, and positivity—for inferring average treatment effects from observational data. These assumptions ensure that the treatment groups are comparable, the treatment effect is consistent across the population, and every individual has a non-zero probability of receiving each treatment level, respectively.  --&gt;</span></span>
<span id="cb22-521"><a href="#cb22-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-522"><a href="#cb22-522" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- **A note on causal diagrams**: we have seen that causal diagrams are graphical tools offer a systematic approach to identifying and controlling for confounding variables -- for helping to understand the conditions in which the assumption of "no unmeasured confounding" or equivalently  of "balance in the confounders across treatments" may be satisfied. Causal diagrams, however, do not obviate the need for these assumptions; instead, they provide a framework for evaluating whether and how the first of the three assumptions -- conditional exchangeability -- may be satisfied in a given study. --&gt;</span></span>
<span id="cb22-523"><a href="#cb22-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-524"><a href="#cb22-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-525"><a href="#cb22-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-526"><a href="#cb22-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-527"><a href="#cb22-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-528"><a href="#cb22-528" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-529"><a href="#cb22-529" aria-hidden="true" tabindex="-1"></a><span class="fu">## Part 2: Lab</span></span>
<span id="cb22-530"><a href="#cb22-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-531"><a href="#cb22-531" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Focus</span></span>
<span id="cb22-532"><a href="#cb22-532" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Application of regression and simulation in R for ATE estimation</span>
<span id="cb22-533"><a href="#cb22-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-534"><a href="#cb22-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-535"><a href="#cb22-535" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Setting up your r script.</span></span>
<span id="cb22-536"><a href="#cb22-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-537"><a href="#cb22-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-538"><a href="#cb22-538" aria-hidden="true" tabindex="-1"></a>First, reinstall the <span class="in">`margot`</span> package:  https://go-bayes.github.io/margot/</span>
<span id="cb22-539"><a href="#cb22-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-542"><a href="#cb22-542" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-543"><a href="#cb22-543" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: install</span></span>
<span id="cb22-544"><a href="#cb22-544" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb22-545"><a href="#cb22-545" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb22-546"><a href="#cb22-546" aria-hidden="true" tabindex="-1"></a><span class="co"># functions explained here: https://go-bayes.github.io/margot/</span></span>
<span id="cb22-547"><a href="#cb22-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-548"><a href="#cb22-548" aria-hidden="true" tabindex="-1"></a><span class="co"># installation</span></span>
<span id="cb22-549"><a href="#cb22-549" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(devtools, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb22-550"><a href="#cb22-550" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"devtools"</span>)</span>
<span id="cb22-551"><a href="#cb22-551" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(devtools)</span>
<span id="cb22-552"><a href="#cb22-552" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-553"><a href="#cb22-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-554"><a href="#cb22-554" aria-hidden="true" tabindex="-1"></a><span class="co"># reinstall the `margot` packagewith updates</span></span>
<span id="cb22-555"><a href="#cb22-555" aria-hidden="true" tabindex="-1"></a><span class="co"># devtools::install_github("go-bayes/margot", quietly = TRUE)</span></span>
<span id="cb22-556"><a href="#cb22-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-557"><a href="#cb22-557" aria-hidden="true" tabindex="-1"></a><span class="co"># call package</span></span>
<span id="cb22-558"><a href="#cb22-558" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"margot"</span>)</span>
<span id="cb22-559"><a href="#cb22-559" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"tidyverse"</span>)</span>
<span id="cb22-560"><a href="#cb22-560" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"parameters"</span>)</span>
<span id="cb22-561"><a href="#cb22-561" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"skimr"</span>)</span>
<span id="cb22-562"><a href="#cb22-562" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"haven"</span>)</span>
<span id="cb22-563"><a href="#cb22-563" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"stdReg"</span>)</span>
<span id="cb22-564"><a href="#cb22-564" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">'mice'</span>)</span>
<span id="cb22-565"><a href="#cb22-565" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"clarify"</span>)</span>
<span id="cb22-566"><a href="#cb22-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-567"><a href="#cb22-567" aria-hidden="true" tabindex="-1"></a><span class="co"># uncomment and check simulated data</span></span>
<span id="cb22-568"><a href="#cb22-568" aria-hidden="true" tabindex="-1"></a><span class="co"># head(df_nz)</span></span>
<span id="cb22-569"><a href="#cb22-569" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-570"><a href="#cb22-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-571"><a href="#cb22-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-572"><a href="#cb22-572" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Download a copy of the data directory from the NZAVS OSF website</span></span>
<span id="cb22-573"><a href="#cb22-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-574"><a href="#cb22-574" aria-hidden="true" tabindex="-1"></a>Find it the data directory here: https://osf.io/75snb/</span>
<span id="cb22-575"><a href="#cb22-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-576"><a href="#cb22-576" aria-hidden="true" tabindex="-1"></a>The variables in the simulated data <span class="in">`df_nz`</span> correspond to a subset of the variables in this directory.</span>
<span id="cb22-577"><a href="#cb22-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-578"><a href="#cb22-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-579"><a href="#cb22-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-580"><a href="#cb22-580" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Check N</span></span>
<span id="cb22-581"><a href="#cb22-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-584"><a href="#cb22-584" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-585"><a href="#cb22-585" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb22-586"><a href="#cb22-586" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb22-587"><a href="#cb22-587" aria-hidden="true" tabindex="-1"></a><span class="co"># check total n in data</span></span>
<span id="cb22-588"><a href="#cb22-588" aria-hidden="true" tabindex="-1"></a><span class="co"># total nzavs participants</span></span>
<span id="cb22-589"><a href="#cb22-589" aria-hidden="true" tabindex="-1"></a>n_total <span class="ot">&lt;-</span> skimr<span class="sc">::</span><span class="fu">n_unique</span>(df_nz<span class="sc">$</span>id)</span>
<span id="cb22-590"><a href="#cb22-590" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(n_total)</span>
<span id="cb22-591"><a href="#cb22-591" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-592"><a href="#cb22-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-593"><a href="#cb22-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-594"><a href="#cb22-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-595"><a href="#cb22-595" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Get data into shape for analysis</span></span>
<span id="cb22-596"><a href="#cb22-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-597"><a href="#cb22-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-600"><a href="#cb22-600" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-601"><a href="#cb22-601" aria-hidden="true" tabindex="-1"></a><span class="do">#### Data wrangling: select columns and transpose the data from long to wide</span></span>
<span id="cb22-602"><a href="#cb22-602" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb22-603"><a href="#cb22-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-604"><a href="#cb22-604" aria-hidden="true" tabindex="-1"></a><span class="co"># filter the original dataset for these IDs three waves</span></span>
<span id="cb22-605"><a href="#cb22-605" aria-hidden="true" tabindex="-1"></a>df_nz <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(df_nz)</span>
<span id="cb22-606"><a href="#cb22-606" aria-hidden="true" tabindex="-1"></a>df_nz <span class="ot">&lt;-</span> haven<span class="sc">::</span><span class="fu">zap_formats</span>(df_nz)</span>
<span id="cb22-607"><a href="#cb22-607" aria-hidden="true" tabindex="-1"></a>df_nz <span class="ot">&lt;-</span> haven<span class="sc">::</span><span class="fu">zap_label</span>(df_nz)</span>
<span id="cb22-608"><a href="#cb22-608" aria-hidden="true" tabindex="-1"></a>df_nz <span class="ot">&lt;-</span> haven<span class="sc">::</span><span class="fu">zap_widths</span>(df_nz)</span>
<span id="cb22-609"><a href="#cb22-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-610"><a href="#cb22-610" aria-hidden="true" tabindex="-1"></a>name_exposure <span class="ot">&lt;-</span>  <span class="st">"perfectionism"</span></span>
<span id="cb22-611"><a href="#cb22-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-612"><a href="#cb22-612" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain ids for individuals who participated in 2018 and have no missing baseline exposure</span></span>
<span id="cb22-613"><a href="#cb22-613" aria-hidden="true" tabindex="-1"></a>ids_2018 <span class="ot">&lt;-</span> df_nz <span class="sc">%&gt;%</span></span>
<span id="cb22-614"><a href="#cb22-614" aria-hidden="true" tabindex="-1"></a>   dplyr<span class="sc">::</span><span class="fu">filter</span>(year_measured <span class="sc">==</span> <span class="dv">1</span>, wave <span class="sc">==</span> <span class="dv">2018</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-615"><a href="#cb22-615" aria-hidden="true" tabindex="-1"></a>   dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_exposure))) <span class="sc">|&gt;</span> <span class="co"># criteria, no missing</span></span>
<span id="cb22-616"><a href="#cb22-616" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(id)</span>
<span id="cb22-617"><a href="#cb22-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-618"><a href="#cb22-618" aria-hidden="true" tabindex="-1"></a><span class="co"># obtain ids for individuals who participated in 2019</span></span>
<span id="cb22-619"><a href="#cb22-619" aria-hidden="true" tabindex="-1"></a>ids_2019 <span class="ot">&lt;-</span> df_nz <span class="sc">%&gt;%</span></span>
<span id="cb22-620"><a href="#cb22-620" aria-hidden="true" tabindex="-1"></a>   dplyr<span class="sc">::</span><span class="fu">filter</span>(year_measured <span class="sc">==</span> <span class="dv">1</span>, wave <span class="sc">==</span> <span class="dv">2019</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-621"><a href="#cb22-621" aria-hidden="true" tabindex="-1"></a>   dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="sc">!!</span><span class="fu">sym</span>(name_exposure))) <span class="sc">|&gt;</span> <span class="co"># criteria, no missing</span></span>
<span id="cb22-622"><a href="#cb22-622" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(id)</span>
<span id="cb22-623"><a href="#cb22-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-624"><a href="#cb22-624" aria-hidden="true" tabindex="-1"></a><span class="co"># intersect IDs from 2018 and 2019 to ensure participation in both years</span></span>
<span id="cb22-625"><a href="#cb22-625" aria-hidden="true" tabindex="-1"></a>ids_2018_2019 <span class="ot">&lt;-</span> <span class="fu">intersect</span>(ids_2018, ids_2019)</span>
<span id="cb22-626"><a href="#cb22-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-627"><a href="#cb22-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-628"><a href="#cb22-628" aria-hidden="true" tabindex="-1"></a><span class="co"># data wrangling</span></span>
<span id="cb22-629"><a href="#cb22-629" aria-hidden="true" tabindex="-1"></a>dat_long <span class="ot">&lt;-</span> df_nz <span class="sc">|&gt;</span></span>
<span id="cb22-630"><a href="#cb22-630" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(id <span class="sc">%in%</span> ids_2018_2019 <span class="sc">&amp;</span></span>
<span id="cb22-631"><a href="#cb22-631" aria-hidden="true" tabindex="-1"></a>                  wave <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2018</span>, <span class="dv">2019</span>, <span class="dv">2020</span>)) <span class="sc">|&gt;</span></span>
<span id="cb22-632"><a href="#cb22-632" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id, wave) <span class="sc">|&gt;</span></span>
<span id="cb22-633"><a href="#cb22-633" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb22-634"><a href="#cb22-634" aria-hidden="true" tabindex="-1"></a>    <span class="st">"id"</span>,</span>
<span id="cb22-635"><a href="#cb22-635" aria-hidden="true" tabindex="-1"></a>    <span class="st">"wave"</span>,</span>
<span id="cb22-636"><a href="#cb22-636" aria-hidden="true" tabindex="-1"></a>    <span class="st">"year_measured"</span>,</span>
<span id="cb22-637"><a href="#cb22-637" aria-hidden="true" tabindex="-1"></a>    <span class="st">"age"</span>,</span>
<span id="cb22-638"><a href="#cb22-638" aria-hidden="true" tabindex="-1"></a>    <span class="st">"male"</span>,</span>
<span id="cb22-639"><a href="#cb22-639" aria-hidden="true" tabindex="-1"></a>    <span class="st">"born_nz"</span>,</span>
<span id="cb22-640"><a href="#cb22-640" aria-hidden="true" tabindex="-1"></a>    <span class="st">"eth_cat"</span>,</span>
<span id="cb22-641"><a href="#cb22-641" aria-hidden="true" tabindex="-1"></a>    <span class="co">#factor(EthCat, labels = c("Euro", "Maori", "Pacific", "Asian")),</span></span>
<span id="cb22-642"><a href="#cb22-642" aria-hidden="true" tabindex="-1"></a>    <span class="st">"employed"</span>,</span>
<span id="cb22-643"><a href="#cb22-643" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Are you currently employed? (this includes self-employment or casual work)</span></span>
<span id="cb22-644"><a href="#cb22-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-645"><a href="#cb22-645" aria-hidden="true" tabindex="-1"></a>    <span class="st">"edu"</span>,</span>
<span id="cb22-646"><a href="#cb22-646" aria-hidden="true" tabindex="-1"></a>    <span class="st">"kessler6_sum"</span>,</span>
<span id="cb22-647"><a href="#cb22-647" aria-hidden="true" tabindex="-1"></a>    <span class="co"># "gen_cohort",</span></span>
<span id="cb22-648"><a href="#cb22-648" aria-hidden="true" tabindex="-1"></a>    <span class="st">"household_inc"</span>,</span>
<span id="cb22-649"><a href="#cb22-649" aria-hidden="true" tabindex="-1"></a>    <span class="st">"partner"</span>,</span>
<span id="cb22-650"><a href="#cb22-650" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 0 = no, 1 = yes</span></span>
<span id="cb22-651"><a href="#cb22-651" aria-hidden="true" tabindex="-1"></a>    <span class="st">"parent"</span>,</span>
<span id="cb22-652"><a href="#cb22-652" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 0 = no, 1 = yes</span></span>
<span id="cb22-653"><a href="#cb22-653" aria-hidden="true" tabindex="-1"></a>    <span class="st">"political_conservative"</span>,</span>
<span id="cb22-654"><a href="#cb22-654" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hours_exercise"</span>,</span>
<span id="cb22-655"><a href="#cb22-655" aria-hidden="true" tabindex="-1"></a>    <span class="st">"agreeableness"</span>,</span>
<span id="cb22-656"><a href="#cb22-656" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mini-IPIP6 Agreeableness (also modelled as empathy facet)</span></span>
<span id="cb22-657"><a href="#cb22-657" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sympathize with others' feelings.</span></span>
<span id="cb22-658"><a href="#cb22-658" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Am not interested in other people's problems.</span></span>
<span id="cb22-659"><a href="#cb22-659" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Feel others' emotions.</span></span>
<span id="cb22-660"><a href="#cb22-660" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Am not really interested in others.</span></span>
<span id="cb22-661"><a href="#cb22-661" aria-hidden="true" tabindex="-1"></a>    <span class="st">"conscientiousness"</span>,</span>
<span id="cb22-662"><a href="#cb22-662" aria-hidden="true" tabindex="-1"></a>    <span class="co"># see mini ipip6</span></span>
<span id="cb22-663"><a href="#cb22-663" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get chores done right away.</span></span>
<span id="cb22-664"><a href="#cb22-664" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Like order.</span></span>
<span id="cb22-665"><a href="#cb22-665" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make a mess of things.</span></span>
<span id="cb22-666"><a href="#cb22-666" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Often forget to put things back in their proper place.</span></span>
<span id="cb22-667"><a href="#cb22-667" aria-hidden="true" tabindex="-1"></a>    <span class="st">"extraversion"</span>,</span>
<span id="cb22-668"><a href="#cb22-668" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Mini-IPIP6 Extraversion</span></span>
<span id="cb22-669"><a href="#cb22-669" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Am the life of the party.</span></span>
<span id="cb22-670"><a href="#cb22-670" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Don't talk a lot.</span></span>
<span id="cb22-671"><a href="#cb22-671" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keep in the background.</span></span>
<span id="cb22-672"><a href="#cb22-672" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Talk to a lot of different people at parties.</span></span>
<span id="cb22-673"><a href="#cb22-673" aria-hidden="true" tabindex="-1"></a>    <span class="st">"honesty_humility"</span>,</span>
<span id="cb22-674"><a href="#cb22-674" aria-hidden="true" tabindex="-1"></a>    <span class="co"># see mini ipip6</span></span>
<span id="cb22-675"><a href="#cb22-675" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Would like to be seen driving around in a very expensive car.</span></span>
<span id="cb22-676"><a href="#cb22-676" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Would get a lot of pleasure from owning expensive luxury goods.</span></span>
<span id="cb22-677"><a href="#cb22-677" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Feel entitled to more of everything.</span></span>
<span id="cb22-678"><a href="#cb22-678" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Deserve more things in life.</span></span>
<span id="cb22-679"><a href="#cb22-679" aria-hidden="true" tabindex="-1"></a>    <span class="st">"openness"</span>,</span>
<span id="cb22-680"><a href="#cb22-680" aria-hidden="true" tabindex="-1"></a>    <span class="co"># see mini ipip6</span></span>
<span id="cb22-681"><a href="#cb22-681" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Have a vivid imagination.</span></span>
<span id="cb22-682"><a href="#cb22-682" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Have difficulty understanding abstract ideas.</span></span>
<span id="cb22-683"><a href="#cb22-683" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Do not have a good imagination.</span></span>
<span id="cb22-684"><a href="#cb22-684" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Am not interested in abstract ideas.</span></span>
<span id="cb22-685"><a href="#cb22-685" aria-hidden="true" tabindex="-1"></a>    <span class="st">"neuroticism"</span>,</span>
<span id="cb22-686"><a href="#cb22-686" aria-hidden="true" tabindex="-1"></a>    <span class="co"># see mini ipip6</span></span>
<span id="cb22-687"><a href="#cb22-687" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Have frequent mood swings.</span></span>
<span id="cb22-688"><a href="#cb22-688" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Am relaxed most of the time.</span></span>
<span id="cb22-689"><a href="#cb22-689" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get upset easily.</span></span>
<span id="cb22-690"><a href="#cb22-690" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Seldom feel blue.</span></span>
<span id="cb22-691"><a href="#cb22-691" aria-hidden="true" tabindex="-1"></a>    <span class="st">"modesty"</span>,</span>
<span id="cb22-692"><a href="#cb22-692" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # see mini ipip6</span></span>
<span id="cb22-693"><a href="#cb22-693" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # I want people to know that I am an important person of high status,</span></span>
<span id="cb22-694"><a href="#cb22-694" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # I am an ordinary person who is no better than others.</span></span>
<span id="cb22-695"><a href="#cb22-695" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # I wouldn’t want people to treat me as though I were superior to them.</span></span>
<span id="cb22-696"><a href="#cb22-696" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # I think that I am entitled to more respect than the average person is</span></span>
<span id="cb22-697"><a href="#cb22-697" aria-hidden="true" tabindex="-1"></a>    <span class="co">#"w_gend_age_ethnic",</span></span>
<span id="cb22-698"><a href="#cb22-698" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sample_weights"</span>,</span>
<span id="cb22-699"><a href="#cb22-699" aria-hidden="true" tabindex="-1"></a>    <span class="st">"neighbourhood_community"</span>,</span>
<span id="cb22-700"><a href="#cb22-700" aria-hidden="true" tabindex="-1"></a>    <span class="co"># #I feel a sense of community with others in my local neighbourhood.</span></span>
<span id="cb22-701"><a href="#cb22-701" aria-hidden="true" tabindex="-1"></a>    <span class="st">"belong"</span>,</span>
<span id="cb22-702"><a href="#cb22-702" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rural_gch_2018_l"</span>,</span>
<span id="cb22-703"><a href="#cb22-703" aria-hidden="true" tabindex="-1"></a>    <span class="st">"support"</span>,</span>
<span id="cb22-704"><a href="#cb22-704" aria-hidden="true" tabindex="-1"></a>    <span class="co"># "support_help",</span></span>
<span id="cb22-705"><a href="#cb22-705" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # 'There are people I can depend on to help me if I really need it.</span></span>
<span id="cb22-706"><a href="#cb22-706" aria-hidden="true" tabindex="-1"></a>    <span class="co"># "support_turnto",</span></span>
<span id="cb22-707"><a href="#cb22-707" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # There is no one I can turn to for guidance in times of stress.</span></span>
<span id="cb22-708"><a href="#cb22-708" aria-hidden="true" tabindex="-1"></a>    <span class="co"># "support_rnoguidance",</span></span>
<span id="cb22-709"><a href="#cb22-709" aria-hidden="true" tabindex="-1"></a>    <span class="co">#There is no one I can turn to for guidance in times of stress.</span></span>
<span id="cb22-710"><a href="#cb22-710" aria-hidden="true" tabindex="-1"></a>    <span class="st">"perfectionism"</span>,</span>
<span id="cb22-711"><a href="#cb22-711" aria-hidden="true" tabindex="-1"></a>    <span class="st">"kessler6_sum"</span></span>
<span id="cb22-712"><a href="#cb22-712" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb22-713"><a href="#cb22-713" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb22-714"><a href="#cb22-714" aria-hidden="true" tabindex="-1"></a>    <span class="co">#initialize 'censored'</span></span>
<span id="cb22-715"><a href="#cb22-715" aria-hidden="true" tabindex="-1"></a>    <span class="at">censored =</span> <span class="fu">ifelse</span>(<span class="fu">lead</span>(year_measured) <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb22-716"><a href="#cb22-716" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-717"><a href="#cb22-717" aria-hidden="true" tabindex="-1"></a>    <span class="co"># modify 'censored' based on the condition; no need to check for NA here as 'censored' is already defined in the previous step</span></span>
<span id="cb22-718"><a href="#cb22-718" aria-hidden="true" tabindex="-1"></a>    <span class="at">censored =</span>  <span class="fu">ifelse</span>(<span class="fu">is.na</span>(censored) <span class="sc">&amp;</span></span>
<span id="cb22-719"><a href="#cb22-719" aria-hidden="true" tabindex="-1"></a>                         year_measured <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span>, censored)</span>
<span id="cb22-720"><a href="#cb22-720" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-721"><a href="#cb22-721" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # Apply the case_when condition for setting 'censored' based on 'wave' and the dynamic column specified by 'nzavs_exposure'</span></span>
<span id="cb22-722"><a href="#cb22-722" aria-hidden="true" tabindex="-1"></a>    <span class="co"># censored = case_when(</span></span>
<span id="cb22-723"><a href="#cb22-723" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   # Add this condition to keep previous modifications unless the specific condition is met!is.na(censored) ~ censored,</span></span>
<span id="cb22-724"><a href="#cb22-724" aria-hidden="true" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb22-725"><a href="#cb22-725" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   # Then check if 'wave' is 2019 and the specified exposure is NA, adjusting the condition to reflect the accurate logic</span></span>
<span id="cb22-726"><a href="#cb22-726" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   wave == 2019 &amp; !is.na(!!sym(nzavs_exposure)) ~ 1,</span></span>
<span id="cb22-727"><a href="#cb22-727" aria-hidden="true" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb22-728"><a href="#cb22-728" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   # Default case if none of the above apply; might not be necessary if all possibilities are covered</span></span>
<span id="cb22-729"><a href="#cb22-729" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   TRUE ~ 0</span></span>
<span id="cb22-730"><a href="#cb22-730" aria-hidden="true" tabindex="-1"></a>    <span class="co"># )</span></span>
<span id="cb22-731"><a href="#cb22-731" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb22-732"><a href="#cb22-732" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>year_measured) <span class="sc">|&gt;</span></span>
<span id="cb22-733"><a href="#cb22-733" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb22-734"><a href="#cb22-734" aria-hidden="true" tabindex="-1"></a>    <span class="at">household_inc_log =</span> <span class="fu">log</span>(household_inc <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb22-735"><a href="#cb22-735" aria-hidden="true" tabindex="-1"></a>    <span class="at">hours_exercise_log =</span> <span class="fu">log</span>(hours_exercise <span class="sc">+</span> <span class="dv">1</span>)  ) <span class="sc">|&gt;</span></span>
<span id="cb22-736"><a href="#cb22-736" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb22-737"><a href="#cb22-737" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span><span class="fu">c</span>(</span>
<span id="cb22-738"><a href="#cb22-738" aria-hidden="true" tabindex="-1"></a>      household_inc,</span>
<span id="cb22-739"><a href="#cb22-739" aria-hidden="true" tabindex="-1"></a>      hours_exercise</span>
<span id="cb22-740"><a href="#cb22-740" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-741"><a href="#cb22-741" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb22-742"><a href="#cb22-742" aria-hidden="true" tabindex="-1"></a>  <span class="fu">droplevels</span>() <span class="sc">|&gt;</span></span>
<span id="cb22-743"><a href="#cb22-743" aria-hidden="true" tabindex="-1"></a>  <span class="co"># dplyr::rename(sample_weights = w_gend_age_ethnic,</span></span>
<span id="cb22-744"><a href="#cb22-744" aria-hidden="true" tabindex="-1"></a>  <span class="co">#               sample_origin =  sample_origin_names_combined) |&gt;</span></span>
<span id="cb22-745"><a href="#cb22-745" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id, wave) <span class="sc">|&gt;</span></span>
<span id="cb22-746"><a href="#cb22-746" aria-hidden="true" tabindex="-1"></a>  <span class="fu">droplevels</span>() <span class="sc">|&gt;</span></span>
<span id="cb22-747"><a href="#cb22-747" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb22-748"><a href="#cb22-748" aria-hidden="true" tabindex="-1"></a>  <span class="fu">droplevels</span>() <span class="sc">|&gt;</span></span>
<span id="cb22-749"><a href="#cb22-749" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id, wave) <span class="sc">|&gt;</span></span>
<span id="cb22-750"><a href="#cb22-750" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb22-751"><a href="#cb22-751" aria-hidden="true" tabindex="-1"></a>  <span class="at">rural_gch_2018_l =</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(rural_gch_2018_l)),</span>
<span id="cb22-752"><a href="#cb22-752" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   parent = as.numeric(as.character(parent)),</span></span>
<span id="cb22-753"><a href="#cb22-753" aria-hidden="true" tabindex="-1"></a>  <span class="at">partner =</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(partner)),</span>
<span id="cb22-754"><a href="#cb22-754" aria-hidden="true" tabindex="-1"></a>  <span class="at">born_nz =</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(born_nz)),</span>
<span id="cb22-755"><a href="#cb22-755" aria-hidden="true" tabindex="-1"></a>  <span class="at">censored =</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(censored)),</span>
<span id="cb22-756"><a href="#cb22-756" aria-hidden="true" tabindex="-1"></a>  <span class="at">employed =</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(employed))</span>
<span id="cb22-757"><a href="#cb22-757" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb22-758"><a href="#cb22-758" aria-hidden="true" tabindex="-1"></a>  <span class="fu">droplevels</span>() <span class="sc">|&gt;</span></span>
<span id="cb22-759"><a href="#cb22-759" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(id, wave) <span class="sc">|&gt;</span></span>
<span id="cb22-760"><a href="#cb22-760" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>()</span>
<span id="cb22-761"><a href="#cb22-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-762"><a href="#cb22-762" aria-hidden="true" tabindex="-1"></a><span class="co"># check n in this sample</span></span>
<span id="cb22-763"><a href="#cb22-763" aria-hidden="true" tabindex="-1"></a>skimr<span class="sc">::</span><span class="fu">n_unique</span>(dat_long<span class="sc">$</span>id)</span>
<span id="cb22-764"><a href="#cb22-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-765"><a href="#cb22-765" aria-hidden="true" tabindex="-1"></a><span class="co">#check</span></span>
<span id="cb22-766"><a href="#cb22-766" aria-hidden="true" tabindex="-1"></a><span class="co">#head(dat_long)</span></span>
<span id="cb22-767"><a href="#cb22-767" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-768"><a href="#cb22-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-769"><a href="#cb22-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-770"><a href="#cb22-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-771"><a href="#cb22-771" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Convert data from long to wide and impute baseline values</span></span>
<span id="cb22-772"><a href="#cb22-772" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-775"><a href="#cb22-775" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-776"><a href="#cb22-776" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: convert</span></span>
<span id="cb22-777"><a href="#cb22-777" aria-hidden="true" tabindex="-1"></a><span class="co"># baseline variables</span></span>
<span id="cb22-778"><a href="#cb22-778" aria-hidden="true" tabindex="-1"></a>baseline_vars <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"male"</span>, <span class="st">"edu"</span>, <span class="st">"partner"</span>, <span class="st">"employed"</span>)</span>
<span id="cb22-779"><a href="#cb22-779" aria-hidden="true" tabindex="-1"></a>exposure_var <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"perfectionism"</span>, <span class="st">"censored"</span>) <span class="co"># we will use the censored variable later</span></span>
<span id="cb22-780"><a href="#cb22-780" aria-hidden="true" tabindex="-1"></a>outcome_vars <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"kessler6_sum"</span>)</span>
<span id="cb22-781"><a href="#cb22-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-782"><a href="#cb22-782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-783"><a href="#cb22-783" aria-hidden="true" tabindex="-1"></a><span class="co"># function will add exposure and outcome to baseline</span></span>
<span id="cb22-784"><a href="#cb22-784" aria-hidden="true" tabindex="-1"></a>dat_long_wide <span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">margot_wide_impute_baseline</span>(dat_long, <span class="at">baseline_vars =</span> baseline_vars, <span class="at">exposure_var =</span> exposure_var, <span class="at">outcome_vars =</span>outcome_vars)</span>
<span id="cb22-785"><a href="#cb22-785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-786"><a href="#cb22-786" aria-hidden="true" tabindex="-1"></a><span class="co"># check</span></span>
<span id="cb22-787"><a href="#cb22-787" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dat_long_wide)</span>
<span id="cb22-788"><a href="#cb22-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-789"><a href="#cb22-789" aria-hidden="true" tabindex="-1"></a><span class="co"># standardise vars</span></span>
<span id="cb22-790"><a href="#cb22-790" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> dat_long_wide <span class="sc">|&gt;</span> </span>
<span id="cb22-791"><a href="#cb22-791" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb22-792"><a href="#cb22-792" aria-hidden="true" tabindex="-1"></a>    <span class="at">t0_age_z =</span> <span class="fu">scale</span>(t0_age),</span>
<span id="cb22-793"><a href="#cb22-793" aria-hidden="true" tabindex="-1"></a>    <span class="at">t0_edu_z =</span> <span class="fu">scale</span>(t0_edu),</span>
<span id="cb22-794"><a href="#cb22-794" aria-hidden="true" tabindex="-1"></a>    <span class="at">t0_kessler6_sum_z =</span>  <span class="fu">scale</span>(t0_kessler6_sum),</span>
<span id="cb22-795"><a href="#cb22-795" aria-hidden="true" tabindex="-1"></a>    <span class="at">t0_perfectionism_z =</span> <span class="fu">scale</span>(t0_perfectionism),</span>
<span id="cb22-796"><a href="#cb22-796" aria-hidden="true" tabindex="-1"></a>    <span class="at">t1_perfectionism_z =</span> <span class="fu">scale</span>(t1_perfectionism),</span>
<span id="cb22-797"><a href="#cb22-797" aria-hidden="true" tabindex="-1"></a>    <span class="at">t2_kessler6_sum_z =</span> <span class="fu">scale</span>(t2_kessler6_sum)) <span class="sc">|&gt;</span> </span>
<span id="cb22-798"><a href="#cb22-798" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>()</span>
<span id="cb22-799"><a href="#cb22-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-800"><a href="#cb22-800" aria-hidden="true" tabindex="-1"></a><span class="co"># we are not handling missing data well, and this will throw bugs down stream</span></span>
<span id="cb22-801"><a href="#cb22-801" aria-hidden="true" tabindex="-1"></a><span class="co"># to avoid this problem we remove attributes</span></span>
<span id="cb22-802"><a href="#cb22-802" aria-hidden="true" tabindex="-1"></a>dt<span class="ot">&lt;-</span> margot<span class="sc">::</span><span class="fu">remove_numeric_attributes</span>(dt)</span>
<span id="cb22-803"><a href="#cb22-803" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-804"><a href="#cb22-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-805"><a href="#cb22-805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-806"><a href="#cb22-806" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Use regression to obtain *conditional average treatment* effect</span></span>
<span id="cb22-807"><a href="#cb22-807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-808"><a href="#cb22-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-809"><a href="#cb22-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-812"><a href="#cb22-812" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-813"><a href="#cb22-813" aria-hidden="true" tabindex="-1"></a><span class="co"># note that we are not handling missing data appropriately here</span></span>
<span id="cb22-814"><a href="#cb22-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-815"><a href="#cb22-815" aria-hidden="true" tabindex="-1"></a><span class="co"># take interaction of treatment and baseline vars</span></span>
<span id="cb22-816"><a href="#cb22-816" aria-hidden="true" tabindex="-1"></a>fit_1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(t2_kessler6_sum_z  <span class="sc">~</span> t1_perfectionism_z <span class="sc">*</span> (t0_age_z <span class="sc">+</span>  t0_edu_z <span class="sc">+</span> t0_kessler6_sum_z <span class="sc">+</span> t0_perfectionism_z), <span class="at">data =</span> dt)</span>
<span id="cb22-817"><a href="#cb22-817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-818"><a href="#cb22-818" aria-hidden="true" tabindex="-1"></a><span class="co"># summarise</span></span>
<span id="cb22-819"><a href="#cb22-819" aria-hidden="true" tabindex="-1"></a>regression_table  <span class="ot">&lt;-</span> parameters<span class="sc">::</span><span class="fu">model_parameters</span>(fit_1)</span>
<span id="cb22-820"><a href="#cb22-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-821"><a href="#cb22-821" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-822"><a href="#cb22-822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-823"><a href="#cb22-823" aria-hidden="true" tabindex="-1"></a>This regression coefficient has a *causal* interpretation (it is the ate, at the value when all variables in the model are set to zero)</span>
<span id="cb22-824"><a href="#cb22-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-827"><a href="#cb22-827" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-828"><a href="#cb22-828" aria-hidden="true" tabindex="-1"></a>regression_table[<span class="dv">2</span>, ]</span>
<span id="cb22-829"><a href="#cb22-829" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-830"><a href="#cb22-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-831"><a href="#cb22-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-832"><a href="#cb22-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-833"><a href="#cb22-833" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Average Treatment Effect</span></span>
<span id="cb22-834"><a href="#cb22-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-835"><a href="#cb22-835" aria-hidden="true" tabindex="-1"></a>First we'll use the <span class="in">`stdReg`</span> package: </span>
<span id="cb22-836"><a href="#cb22-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-839"><a href="#cb22-839" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-840"><a href="#cb22-840" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: check-n</span></span>
<span id="cb22-841"><a href="#cb22-841" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb22-842"><a href="#cb22-842" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb22-843"><a href="#cb22-843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-844"><a href="#cb22-844" aria-hidden="true" tabindex="-1"></a><span class="co"># fit the ate</span></span>
<span id="cb22-845"><a href="#cb22-845" aria-hidden="true" tabindex="-1"></a>fit_ate <span class="ot">&lt;-</span> stdReg<span class="sc">::</span><span class="fu">stdGlm</span>(fit_1,<span class="at">data =</span> dt, <span class="at">X =</span> <span class="st">"t1_perfectionism_z"</span>, <span class="at">x=</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb22-846"><a href="#cb22-846" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">summary</span>(fit_ate))</span>
<span id="cb22-847"><a href="#cb22-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-848"><a href="#cb22-848" aria-hidden="true" tabindex="-1"></a><span class="co"># summarise the ate</span></span>
<span id="cb22-849"><a href="#cb22-849" aria-hidden="true" tabindex="-1"></a>ate_stdreg_method <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit_ate,  <span class="at">contrast =</span> <span class="st">"difference"</span>,  <span class="at">reference =</span> <span class="dv">0</span>)</span>
<span id="cb22-850"><a href="#cb22-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-851"><a href="#cb22-851" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>( ate_stdreg_method )</span>
<span id="cb22-852"><a href="#cb22-852" aria-hidden="true" tabindex="-1"></a><span class="co"># graph ate using stdReg method</span></span>
<span id="cb22-853"><a href="#cb22-853" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ate_stdreg_method)</span>
<span id="cb22-854"><a href="#cb22-854" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-855"><a href="#cb22-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-856"><a href="#cb22-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-857"><a href="#cb22-857" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Obtain ATE by hand using g-computation</span></span>
<span id="cb22-858"><a href="#cb22-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-859"><a href="#cb22-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-860"><a href="#cb22-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-863"><a href="#cb22-863" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-864"><a href="#cb22-864" aria-hidden="true" tabindex="-1"></a><span class="co"># recall our fit</span></span>
<span id="cb22-865"><a href="#cb22-865" aria-hidden="true" tabindex="-1"></a>fit_1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(t2_kessler6_sum_z <span class="sc">~</span> t1_perfectionism_z <span class="sc">+</span> t0_age_z <span class="sc">+</span> t0_edu_z <span class="sc">+</span> t0_kessler6_sum_z <span class="sc">+</span> t0_perfectionism_z, <span class="at">data =</span> dt, <span class="at">family =</span> <span class="fu">gaussian</span>())</span>
<span id="cb22-866"><a href="#cb22-866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-867"><a href="#cb22-867" aria-hidden="true" tabindex="-1"></a><span class="co"># step 2: create a new dataset where everyone receives the treatment</span></span>
<span id="cb22-868"><a href="#cb22-868" aria-hidden="true" tabindex="-1"></a>dt_treated <span class="ot">&lt;-</span> dt</span>
<span id="cb22-869"><a href="#cb22-869" aria-hidden="true" tabindex="-1"></a>dt_treated<span class="sc">$</span>t1_perfectionism_z <span class="ot">&lt;-</span> <span class="fu">mean</span>(dt<span class="sc">$</span>t1_perfectionism_z)  <span class="co"># setting treatment to the mean can be adjusted as needed</span></span>
<span id="cb22-870"><a href="#cb22-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-871"><a href="#cb22-871" aria-hidden="true" tabindex="-1"></a><span class="co"># step 3: predict outcomes under the treatment scenario</span></span>
<span id="cb22-872"><a href="#cb22-872" aria-hidden="true" tabindex="-1"></a>dt_treated<span class="sc">$</span>predicted_outcome <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_1, <span class="at">newdata =</span> dt_treated, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb22-873"><a href="#cb22-873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-874"><a href="#cb22-874" aria-hidden="true" tabindex="-1"></a><span class="co"># step 4: calculate the mean outcome under this treatment scenario</span></span>
<span id="cb22-875"><a href="#cb22-875" aria-hidden="true" tabindex="-1"></a>mean_outcome_treated <span class="ot">&lt;-</span> <span class="fu">mean</span>(dt_treated<span class="sc">$</span>predicted_outcome)</span>
<span id="cb22-876"><a href="#cb22-876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-877"><a href="#cb22-877" aria-hidden="true" tabindex="-1"></a><span class="co"># repeat Steps 2-4 for control or another treatment level</span></span>
<span id="cb22-878"><a href="#cb22-878" aria-hidden="true" tabindex="-1"></a>dt_control <span class="ot">&lt;-</span> dt</span>
<span id="cb22-879"><a href="#cb22-879" aria-hidden="true" tabindex="-1"></a>dt_control<span class="sc">$</span>t1_perfectionism_z <span class="ot">&lt;-</span> <span class="dv">1</span>  <span class="co"># one sd increase in perfectionism</span></span>
<span id="cb22-880"><a href="#cb22-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-881"><a href="#cb22-881" aria-hidden="true" tabindex="-1"></a>dt_control<span class="sc">$</span>predicted_outcome <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_1, <span class="at">newdata =</span> dt_control, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb22-882"><a href="#cb22-882" aria-hidden="true" tabindex="-1"></a>mean_outcome_control <span class="ot">&lt;-</span> <span class="fu">mean</span>(dt_control<span class="sc">$</span>predicted_outcome)</span>
<span id="cb22-883"><a href="#cb22-883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-884"><a href="#cb22-884" aria-hidden="true" tabindex="-1"></a><span class="co"># step 5: calculate the average treatment effect</span></span>
<span id="cb22-885"><a href="#cb22-885" aria-hidden="true" tabindex="-1"></a>ate_gcomp <span class="ot">&lt;-</span> <span class="fu">round</span>( mean_outcome_treated <span class="sc">-</span> mean_outcome_control, <span class="dv">2</span>)</span>
<span id="cb22-886"><a href="#cb22-886" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Average Treatment Effect (ATE) of t1_perfectionism_z using g-computation: "</span>, ate_gcomp))</span>
<span id="cb22-887"><a href="#cb22-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-888"><a href="#cb22-888" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-889"><a href="#cb22-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-890"><a href="#cb22-890" aria-hidden="true" tabindex="-1"></a><span class="fu">##### Next obtain the ATE and standard errors by simulation using `clarify` </span></span>
<span id="cb22-891"><a href="#cb22-891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-892"><a href="#cb22-892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-895"><a href="#cb22-895" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-896"><a href="#cb22-896" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"clarify"</span>)</span>
<span id="cb22-897"><a href="#cb22-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-898"><a href="#cb22-898" aria-hidden="true" tabindex="-1"></a><span class="co"># setup simulation with clarify to manipulate the treatment variable and predict outcomes</span></span>
<span id="cb22-899"><a href="#cb22-899" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb22-900"><a href="#cb22-900" aria-hidden="true" tabindex="-1"></a>sim_coefs <span class="ot">&lt;-</span> <span class="fu">sim</span>(fit_1)</span>
<span id="cb22-901"><a href="#cb22-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-902"><a href="#cb22-902" aria-hidden="true" tabindex="-1"></a><span class="co"># compute ate</span></span>
<span id="cb22-903"><a href="#cb22-903" aria-hidden="true" tabindex="-1"></a>sim_est <span class="ot">&lt;-</span> <span class="fu">sim_ame</span>(sim_coefs, <span class="at">contrast =</span> <span class="st">"diff"</span>, <span class="at">var =</span>  <span class="st">"t1_perfectionism_z"</span>)</span>
<span id="cb22-904"><a href="#cb22-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-905"><a href="#cb22-905" aria-hidden="true" tabindex="-1"></a><span class="co"># summarise</span></span>
<span id="cb22-906"><a href="#cb22-906" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(sim_est)</span>
<span id="cb22-907"><a href="#cb22-907" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb22-908"><a href="#cb22-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-909"><a href="#cb22-909" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-910"><a href="#cb22-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-911"><a href="#cb22-911" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-912"><a href="#cb22-912" aria-hidden="true" tabindex="-1"></a><span class="fu">## Appendix A</span></span>
<span id="cb22-913"><a href="#cb22-913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-914"><a href="#cb22-914" aria-hidden="true" tabindex="-1"></a>Consider that in the causal inference literature, we may write this contrast two potential outcomes under treatment as:</span>
<span id="cb22-915"><a href="#cb22-915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-916"><a href="#cb22-916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-917"><a href="#cb22-917" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-918"><a href="#cb22-918" aria-hidden="true" tabindex="-1"></a>\text{Causal Effect}_i = Y_i^{a=1} - Y_i^{a=0} </span>
<span id="cb22-919"><a href="#cb22-919" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-920"><a href="#cb22-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-921"><a href="#cb22-921" aria-hidden="true" tabindex="-1"></a>or</span>
<span id="cb22-922"><a href="#cb22-922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-923"><a href="#cb22-923" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-924"><a href="#cb22-924" aria-hidden="true" tabindex="-1"></a>\text{Causal Effect}_i = Y_i^{1} - Y_i^{0} </span>
<span id="cb22-925"><a href="#cb22-925" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-926"><a href="#cb22-926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-927"><a href="#cb22-927" aria-hidden="true" tabindex="-1"></a>or:</span>
<span id="cb22-928"><a href="#cb22-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-929"><a href="#cb22-929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-930"><a href="#cb22-930" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-931"><a href="#cb22-931" aria-hidden="true" tabindex="-1"></a>\text{Causal Effect}_i = Y_{1} - Y_0 </span>
<span id="cb22-932"><a href="#cb22-932" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb22-933"><a href="#cb22-933" aria-hidden="true" tabindex="-1"></a>Where subscripts are dropped.  You will soon encounter that many </span>
<span id="cb22-934"><a href="#cb22-934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-935"><a href="#cb22-935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-936"><a href="#cb22-936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-937"><a href="#cb22-937" aria-hidden="true" tabindex="-1"></a><span class="fu">### Packages</span></span>
<span id="cb22-938"><a href="#cb22-938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-941"><a href="#cb22-941" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb22-942"><a href="#cb22-942" aria-hidden="true" tabindex="-1"></a>report<span class="sc">::</span><span class="fu">cite_packages</span>()</span>
<span id="cb22-943"><a href="#cb22-943" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>